# 计划管理模块权限与审批机制说明

## 一、系统权限管理机制概述

### 1.1 权限架构

当前系统采用 **基于角色的访问控制（RBAC）** 机制，主要组件包括：

#### 核心模型
- **User（用户）**：系统用户
- **Role（角色）**：用户角色，如"系统管理员"、"项目经理"等
- **PermissionItem（业务权限点）**：细粒度的业务权限，格式为 `模块.操作`

#### 权限获取流程
```python
# 权限获取服务
from backend.apps.system_management.services import get_user_permission_codes

# 获取用户的所有权限代码
permission_codes = get_user_permission_codes(user)
# 返回格式：{'plan_management.view', 'plan_management.create', ...}
```

### 1.2 权限检查机制

#### 权限检查函数
```python
from backend.core.views import _permission_granted

# 检查用户是否有特定权限
can_access = _permission_granted('plan_management.view', permission_codes)
```

#### 权限代码格式
- **查看权限**：`plan_management.view`
- **创建权限**：`plan_management.create`
- **审批权限**：`plan_management.approve_plan`
- **目标管理权限**：`plan_management.manage_goal`

### 1.3 特殊权限

- **`__all__`**：超级权限，拥有所有权限
- **系统管理员角色**：`system_admin` 和 `general_manager` 自动拥有 `__all__` 权限
- **超级用户**：Django 的 `is_superuser` 自动拥有 `__all__` 权限

## 二、计划管理模块权限配置

### 2.1 计划管理权限点

计划管理模块的权限点定义在 `PermissionItem` 模型中，模块名称为 `'计划管理'`，常见权限包括：

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| `plan_management.view` | 查看计划 | 查看计划列表和详情 |
| `plan_management.create` | 创建计划 | 创建新计划 |
| `plan_management.edit` | 编辑计划 | 编辑已有计划 |
| `plan_management.approve_plan` | 审批计划 | 审批计划的启动/取消请求 |
| `plan_management.manage_goal` | 管理目标 | 创建和管理战略目标 |

### 2.2 权限使用示例

#### 在视图函数中检查权限
```python
from backend.apps.system_management.services import get_user_permission_codes
from backend.core.views import _permission_granted

def plan_list(request):
    permission_codes = get_user_permission_codes(request.user)
    
    # 检查查看权限
    if not _permission_granted('plan_management.view', permission_codes):
        messages.error(request, '您没有权限访问计划管理')
        return redirect('admin:index')
    
    # 检查创建权限
    can_create = _permission_granted('plan_management.create', permission_codes)
    
    # 在模板中使用
    context = {
        'can_create': can_create,
        # ...
    }
```

#### 在模板中控制显示
```django
{% if can_create %}
    <a href="{% url 'plan_pages:plan_create' %}">创建计划</a>
{% endif %}
```

## 三、审批流程机制

### 3.1 PlanDecision 模型

计划管理模块使用 `PlanDecision` 模型实现轻量级审批流程：

```python
class PlanDecision(models.Model):
    """计划决策记录（P1 轻量审批模型）"""
    
    REQUEST_TYPES = [
        ('start', '启动计划'),
        ('cancel', '取消计划'),
    ]
    
    DECISION_CHOICES = [
        ('approve', '通过'),
        ('reject', '驳回'),
    ]
    
    plan = models.ForeignKey(Plan, ...)  # 关联计划
    request_type = models.CharField(...)  # 请求类型：start/cancel
    decision = models.CharField(...)  # 决策结果：approve/reject/null（待处理）
    
    requested_by = models.ForeignKey(User, ...)  # 请求人
    requested_at = models.DateTimeField(...)  # 请求时间
    
    decided_by = models.ForeignKey(User, ...)  # 决策人
    decided_at = models.DateTimeField(...)  # 决策时间（null表示待处理）
    
    reason = models.TextField(...)  # 原因说明
```

### 3.2 审批流程

#### 流程步骤

1. **发起审批请求**
   - 用户发起"启动计划"或"取消计划"请求
   - 创建 `PlanDecision` 记录，`decision` 为 `null`，`decided_at` 为 `null`

2. **审批处理**
   - 具有 `plan_management.approve_plan` 权限的用户可以审批
   - 审批通过：设置 `decision='approve'`，`decided_at=now()`，`decided_by=审批人`
   - 审批驳回：设置 `decision='reject'`，`decided_at=now()`，`decided_by=审批人`

3. **状态更新**
   - 审批通过后，通过 `adjudicate_plan_status` 裁决器更新计划状态
   - 记录状态变更日志到 `PlanStatusLog`

#### 约束规则

- **唯一性约束**：同一计划的同一请求类型（start/cancel）同时只能存在 1 条待处理记录
- **状态判断**：通过 `decided_at is null` 判断是否为待处理状态

### 3.3 审批视图函数

#### 审批通过
```python
@login_required
def decision_approve(request, decision_id):
    """审批通过决策"""
    permission_set = get_user_permission_codes(request.user)
    decision = get_object_or_404(PlanDecision, id=decision_id, decided_at__isnull=True)
    
    # 权限检查
    can_approve = _permission_granted('plan_management.approve_plan', permission_set) 
                 or request.user.is_superuser
    if not can_approve:
        messages.error(request, '您没有权限审批')
        return redirect(...)
    
    # 更新决策记录
    decision.decision = 'approve'
    decision.decided_by = request.user
    decision.decided_at = timezone.now()
    decision.save()
    
    # 通过裁决器处理状态变更
    result = adjudicate_plan_status(plan, decision='approve', ...)
    # ...
```

#### 审批驳回
```python
@login_required
def decision_reject(request, decision_id):
    """审批驳回决策"""
    # 类似审批通过，但 decision='reject'
    # reject 不改状态，只记录日志
```

### 3.4 审批列表查询

```python
# 查询所有待审批请求
pending_decisions = PlanDecision.objects.filter(decided_at__isnull=True)

# 查询特定计划的待审批请求
pending_for_plan = PlanDecision.objects.filter(
    plan=plan, 
    decided_at__isnull=True
).order_by('-requested_at')

# 查询启动请求
start_requests = pending_decisions.filter(request_type='start')

# 查询取消请求
cancel_requests = pending_decisions.filter(request_type='cancel')
```

## 四、权限配置最佳实践

### 4.1 角色配置建议

建议为计划管理模块配置以下角色：

1. **计划管理员**
   - 权限：`plan_management.*`（所有计划管理权限）
   - 用途：全面管理计划和审批

2. **项目经理**
   - 权限：`plan_management.view`, `plan_management.create`, `plan_management.edit`
   - 用途：创建和管理自己的计划

3. **审批人**
   - 权限：`plan_management.view`, `plan_management.approve_plan`
   - 用途：审批计划的启动/取消请求

4. **普通用户**
   - 权限：`plan_management.view`
   - 用途：查看计划信息

### 4.2 权限检查最佳实践

#### ✅ 推荐做法

```python
# 1. 在视图函数开始处检查权限
def plan_create(request):
    permission_codes = get_user_permission_codes(request.user)
    if not _permission_granted('plan_management.create', permission_codes):
        messages.error(request, '您没有权限创建计划')
        return redirect('plan_pages:plan_list')

# 2. 在模板中根据权限显示/隐藏功能
{% if can_approve %}
    <button>审批</button>
{% endif %}

# 3. 使用装饰器（如果支持）
@permission_required('plan_management.approve_plan', raise_exception=True)
def decision_approve(request, decision_id):
    # ...
```

#### ❌ 避免的做法

```python
# 1. 不要跳过权限检查
def plan_create(request):
    # 缺少权限检查！
    plan = Plan.objects.create(...)

# 2. 不要硬编码权限判断
if user.username == 'admin':  # 错误！
    # ...

# 3. 不要在模板中直接访问用户对象判断权限
{% if user.is_superuser %}  # 应该使用权限代码
    # ...
{% endif %}
```

## 五、审批流程扩展建议

### 5.1 当前实现（P1阶段）

- ✅ 轻量级审批模型（PlanDecision）
- ✅ 启动/取消计划审批
- ✅ 审批记录和日志
- ✅ 权限控制

### 5.2 未来扩展（P2阶段）

可以考虑以下扩展：

1. **多级审批**
   - 支持一级、二级等多级审批流程
   - 配置审批流程模板

2. **审批人指定**
   - 支持指定特定审批人
   - 支持按部门/角色自动分配审批人

3. **审批通知**
   - 审批请求通知
   - 审批结果通知

4. **审批历史**
   - 完整的审批历史记录
   - 审批流程图展示

5. **自动审批规则**
   - 根据计划类型、金额等条件自动审批
   - 配置自动审批规则

## 六、常见问题解答

### Q1: 如何给用户分配权限？

**A:** 通过系统管理模块的权限矩阵页面：
1. 访问：`/system/permissions/matrix/`
2. 为角色分配相应的权限点
3. 将用户添加到对应角色

### Q2: 如何查看用户的权限？

**A:** 使用权限服务函数：
```python
from backend.apps.system_management.services import get_user_permission_codes

permission_codes = get_user_permission_codes(user)
print(permission_codes)  # 查看用户的所有权限代码
```

### Q3: 审批权限如何配置？

**A:** 确保角色拥有 `plan_management.approve_plan` 权限：
1. 在权限矩阵中为角色添加该权限
2. 或将用户设置为系统管理员（自动拥有所有权限）

### Q4: 如何查询待审批请求？

**A:** 使用 PlanDecision 模型查询：
```python
# 所有待审批请求
pending = PlanDecision.objects.filter(decided_at__isnull=True)

# 特定用户的待审批请求（需要关联查询）
# 注意：当前模型没有直接关联审批人，需要根据业务逻辑查询
```

### Q5: 审批后如何自动更新计划状态？

**A:** 通过 `adjudicate_plan_status` 裁决器：
```python
from backend.apps.plan_management.adjudicator import adjudicate_plan_status

result = adjudicate_plan_status(plan, decision='approve', system_facts=None)
if result.changed:
    plan.status = result.new_status
    plan.save()
```

## 七、相关文件位置

### 权限管理
- **权限服务**：`backend/apps/system_management/services.py`
- **权限模型**：`backend/apps/permission_management/models.py`
- **权限检查**：`backend/core/views.py` (`_permission_granted`)
- **权限矩阵**：`backend/apps/system_management/views_pages.py` (`permission_matrix`)

### 审批管理
- **审批模型**：`backend/apps/plan_management/models.py` (`PlanDecision`)
- **审批视图**：`backend/apps/plan_management/views_pages.py` (`decision_approve`, `decision_reject`)
- **状态裁决器**：`backend/apps/plan_management/adjudicator.py` (`adjudicate_plan_status`)

## 八、总结

当前系统已经实现了完整的权限管理和审批流程机制：

1. **权限管理**：基于角色的访问控制（RBAC），支持细粒度权限配置
2. **审批流程**：轻量级审批模型，支持启动/取消计划审批
3. **权限检查**：在视图层和模板层都有完善的权限检查机制
4. **扩展性**：架构设计支持未来扩展多级审批、自动审批等功能

在使用计划管理模块时，只需要：
- 配置好角色和权限
- 在视图函数中检查权限
- 在模板中根据权限显示/隐藏功能
- 使用 PlanDecision 模型处理审批流程

如有任何问题，请参考相关代码文件或联系开发团队。
