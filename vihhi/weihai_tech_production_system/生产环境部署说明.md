# 生产环境部署说明

## 📋 概述

本文档说明如何将威海科技生产系统部署到生产环境，包括域名配置、环境变量设置等关键步骤。

## 🌐 公网域名配置

### 当前配置的公网域名

1. **rasdmangrhdn.sealosbja.site** (Port 8001)
   - 状态：✅ 可访问
   - 用途：主要生产访问入口

2. **dbjhjowayeto.sealosbja.site** (Port 8000)
   - 状态：⏳ 准备中
   - 用途：备用访问入口

### 域名配置说明

所有公网域名已自动配置在 `settings.py` 中：
- ✅ `ALLOWED_HOSTS` - 允许访问的域名白名单
- ✅ `CSRF_TRUSTED_ORIGINS` - CSRF 保护的信任源
- ✅ `CORS_ALLOWED_ORIGINS` - 跨域资源共享允许的源

## 🔧 环境变量配置

### 必需的环境变量

在生产环境部署时，请确保设置以下环境变量：

#### 1. 调试模式（重要！）
```bash
DEBUG=False
```
⚠️ **生产环境必须设置为 `False`，否则会暴露敏感信息和调试页面**

#### 2. 密钥配置
```bash
SECRET_KEY=your-production-secret-key-here
```
⚠️ **必须使用强随机密钥，不要使用默认值**

#### 3. 域名配置（可选，已配置默认值）
```bash
# 如果使用默认域名，可以不设置
# 如果需要添加其他域名，用逗号分隔
ALLOWED_HOSTS=rasdmangrhdn.sealosbja.site,dbjhjowayeto.sealosbja.site

# CSRF 信任源（可选，已配置默认值）
CSRF_TRUSTED_ORIGINS=https://rasdmangrhdn.sealosbja.site,https://dbjhjowayeto.sealosbja.site
```

#### 4. 数据库配置（必需）
```bash
# 生产环境必须设置数据库连接
DATABASE_URL=postgresql://用户名:密码@主机:端口/数据库名
```

#### 5. Redis 配置（推荐）
```bash
# 如果使用 Redis 缓存，设置 Redis 连接地址
REDIS_URL=redis://host:port/db
```

#### 6. 邮件配置（如需要）
```bash
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.example.com
EMAIL_PORT=587
EMAIL_HOST_USER=your-email@example.com
EMAIL_HOST_PASSWORD=your-password
EMAIL_USE_TLS=True
DEFAULT_FROM_EMAIL=whkj@vihgroup.com.cn
```

## 🚀 部署步骤

### 1. 设置环境变量

在 Sealos DevBox 中，通过以下方式设置环境变量：

**方式一：通过 Sealos 控制台**
1. 进入应用管理页面
2. 找到"环境变量"或"Environment Variables"配置
3. 添加上述必需的环境变量

**方式二：通过 .env 文件（如果支持）**
在项目根目录创建或更新 `.env` 文件：
```bash
DEBUG=False
SECRET_KEY=your-production-secret-key
DATABASE_URL=postgresql://...
# ... 其他环境变量
```

### 2. 收集静态文件

```bash
python manage.py collectstatic --noinput
```

### 3. 运行数据库迁移

```bash
python manage.py migrate
```

### 4. 重启服务

在 Sealos DevBox 控制台点击"重启"按钮，或通过命令行：
```bash
# 如果使用 systemd
sudo systemctl restart your-django-service

# 如果使用 supervisor
supervisorctl restart django
```

## ✅ 部署后检查清单

- [ ] 确认 `DEBUG=False` 已设置
- [ ] 确认 `SECRET_KEY` 已更改为生产密钥
- [ ] 确认 `DATABASE_URL` 已正确配置
- [ ] 确认所有公网域名可以正常访问
- [ ] 确认静态文件可以正常加载
- [ ] 确认 HTTPS 访问正常（推荐使用 HTTPS）
- [ ] 确认 CSRF 保护正常工作
- [ ] 确认日志记录正常

## 🔒 安全建议

1. **使用 HTTPS**：生产环境应强制使用 HTTPS，避免 HTTP 访问
2. **强密钥**：`SECRET_KEY` 必须使用强随机字符串
3. **数据库安全**：使用强密码，限制数据库访问 IP
4. **定期备份**：定期备份数据库和重要文件
5. **监控日志**：定期检查应用日志，发现异常及时处理
6. **更新依赖**：定期更新 Django 和第三方库的安全补丁

## 📝 常见问题

### Q: 出现 "DisallowedHost" 错误怎么办？
A: 检查请求的域名是否在 `ALLOWED_HOSTS` 中，确保域名配置正确。

### Q: CSRF 验证失败怎么办？
A: 确保域名在 `CSRF_TRUSTED_ORIGINS` 中，并且使用正确的协议（http/https）。

### Q: 静态文件无法加载？
A: 运行 `python manage.py collectstatic` 收集静态文件，确保 `STATIC_ROOT` 配置正确。

### Q: 如何添加新的公网域名？
A: 更新 `settings.py` 中的 `DEFAULT_ALLOWED_HOSTS` 和 `DEFAULT_CSRF_ORIGINS`，或通过环境变量设置。

## 📞 技术支持

如有问题，请联系技术支持团队或查看项目文档。

---
**最后更新**: 2025-01-XX
**版本**: 1.0.0
