# P2-4ï¼šå¾…åŠ/é£é™©/ç³»ç»Ÿé€šçŸ¥ - å®Œæˆæ€»ç»“

> **å®Œæˆæ—¶é—´**ï¼š2025-01-XX  
> **é˜¶æ®µ**ï¼šP2-4  
> **çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

## ğŸ“‹ å®Œæˆå†…å®¹

### 1. å¾…åŠä¸­å¿ƒï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰âœ…

#### åŠŸèƒ½å®ç°ï¼š
- **ä¸å­˜è¡¨**ï¼šé€šè¿‡æŸ¥è¯¢å®ç°ï¼Œä¸æ–°å»º Task æ¨¡å‹
- **å¾…åŠæ¥æº**ï¼ˆå…¨è¦†ç›–ï¼‰ï¼š
  - å¾…æ¥æ”¶ç›®æ ‡ï¼ˆpublishedï¼Œowner=userï¼‰
  - å¾…æ¥æ”¶è®¡åˆ’ï¼ˆpublishedï¼Œowner=userï¼‰
  - å¾…æ‰§è¡Œç›®æ ‡ï¼ˆacceptedï¼Œowner=userï¼‰
  - å¾…æ‰§è¡Œè®¡åˆ’ï¼ˆacceptedï¼Œowner=userï¼‰
  - ä»Šæ—¥åº”æ‰§è¡Œè®¡åˆ’ï¼ˆin_progressï¼Œtodayåœ¨[start_time, end_time]ï¼‰
  - é£é™©è®¡åˆ’ï¼ˆé€¾æœŸï¼‰
  - é£é™©ç›®æ ‡ï¼ˆé€¾æœŸï¼‰

#### å®ç°ä½ç½®ï¼š
- `services/todo_service.py`ï¼š
  - `get_user_todos(user)` - è·å–ç”¨æˆ·å¾…åŠåˆ—è¡¨
  - `get_user_todo_summary(user)` - è·å–ç”¨æˆ·å¾…åŠæ±‡æ€»ç»Ÿè®¡

#### å¾…åŠç»“æ„ï¼š
```python
{
    'type': 'goal_accept' | 'plan_accept' | 'goal_execute' | 'plan_execute' | 'plan_today' | 'plan_risk' | 'goal_risk',
    'title': 'å¾…åŠæ ‡é¢˜',
    'description': 'å¾…åŠæè¿°',
    'priority': 'high' | 'medium' | 'low',
    'url': 'è·³è½¬é“¾æ¥',
    'object': StrategicGoal æˆ– Plan å¯¹è±¡,
    'created_at': datetime,
}
```

---

### 2. äº‹ä»¶å‹ç³»ç»Ÿé€šçŸ¥ï¼ˆå³æ—¶ï¼‰âœ…

#### åŠŸèƒ½å®ç°ï¼š
- **å·²è¦†ç›–çš„äº‹ä»¶**ï¼š
  - âœ… å…¬å¸ç›®æ ‡å‘å¸ƒ â†’ å…¨å‘˜ï¼ˆP2-2ï¼‰
  - âœ… ä¸ªäººç›®æ ‡å‘å¸ƒ â†’ ownerï¼ˆP2-2ï¼‰
  - âœ… ç›®æ ‡è¢«æ¥æ”¶ â†’ åˆ›å»ºäººï¼ˆP2-4 æ–°å¢ï¼‰
  - âœ… å…¬å¸è®¡åˆ’å‘å¸ƒ â†’ å…¨å‘˜ï¼ˆP2-3ï¼‰
  - âœ… ä¸ªäººè®¡åˆ’å‘å¸ƒ â†’ ownerï¼ˆP2-3ï¼‰
  - âœ… è®¡åˆ’è¢«æ¥æ”¶ â†’ åˆ›å»ºäººï¼ˆP2-4 æ–°å¢ï¼‰

#### å®ç°ä½ç½®ï¼š
- `notifications.py`ï¼š
  - `notify_goal_accepted()` - é€šçŸ¥ç›®æ ‡è¢«æ¥æ”¶
  - `notify_plan_accepted()` - é€šçŸ¥è®¡åˆ’è¢«æ¥æ”¶
- `views_pages.py`ï¼š
  - `strategic_goal_detail()` - æ¥æ”¶ç›®æ ‡æ—¶è§¦å‘é€šçŸ¥
  - `plan_detail()` - æ¥æ”¶è®¡åˆ’æ—¶è§¦å‘é€šçŸ¥

---

### 3. æ¯æ—¥ 9 ç‚¹å®šæ—¶ä»»åŠ¡ï¼ˆP2-4 æ ¸å¿ƒï¼‰âœ…

#### åŠŸèƒ½å®ç°ï¼š
- **å®šæ—¶è§„åˆ™**ï¼šæ¯å¤© 09:00 æ‰§è¡Œ
- **å®ç°æ–¹å¼**ï¼š
  - Django management commandï¼š`daily_todo_reminder`
  - Celery taskï¼š`daily_todo_reminder`ï¼ˆå¯é€‰ï¼‰

#### æ¯æ—¥æé†’å†…å®¹ï¼š
å¯¹æ¯ä¸ªç”¨æˆ·ï¼Œç”Ÿæˆæ±‡æ€»é€šçŸ¥ï¼š
- **ä»Šæ—¥å¾…åŠ**ï¼š
  - å¾…æ¥æ”¶ç›®æ ‡/è®¡åˆ’æ•°
  - å¾…æ‰§è¡Œç›®æ ‡/è®¡åˆ’æ•°
  - ä»Šæ—¥éœ€æ‰§è¡Œè®¡åˆ’æ•°
- **é£é™©æç¤º**ï¼š
  - é€¾æœŸ/é«˜é£é™©é¡¹æ•°

#### å®ç°ä½ç½®ï¼š
- `management/commands/daily_todo_reminder.py` - Django ç®¡ç†å‘½ä»¤
- `tasks.py` - Celery ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰

#### ä½¿ç”¨æ–¹å¼ï¼š
1. **Django-crontab**ï¼š
   ```python
   CRONJOBS = [
       ('0 9 * * *', 'plan_management.management.commands.daily_todo_reminder'),
   ]
   python manage.py crontab add
   ```

2. **Celery beat**ï¼š
   ```python
   app.conf.beat_schedule = {
       'daily-todo-reminder': {
           'task': 'plan_management.tasks.daily_todo_reminder',
           'schedule': crontab(hour=9, minute=0),
       },
   }
   ```

3. **æ‰‹åŠ¨æ‰§è¡Œï¼ˆæµ‹è¯•ï¼‰**ï¼š
   ```bash
   python manage.py daily_todo_reminder
   python manage.py daily_todo_reminder --dry-run  # ä»…ç»Ÿè®¡ï¼Œä¸å‘é€
   ```

---

### 4. é¦–é¡µé€‚é…ï¼ˆP2-4 å±‚ï¼‰âœ…

#### åŠŸèƒ½å®ç°ï¼š
- **æˆ‘çš„å¾…åŠåŒºå—**ï¼š
  - æ˜¾ç¤ºå‰ 5 æ¡å¾…åŠ
  - å¯è·³è½¬åˆ°è¯¦æƒ…é¡µ
  - æ˜¾ç¤ºå¾…åŠæ€»æ•°
- **é£é™©æé†’åŒºå—**ï¼š
  - æ˜¾ç¤ºå‰ 5 æ¡é£é™©é¡¹ï¼ˆé€¾æœŸç›®æ ‡/è®¡åˆ’ï¼‰
  - é«˜äº®æ˜¾ç¤º
  - æ˜¾ç¤ºé£é™©é¡¹æ€»æ•°

#### å®ç°ä½ç½®ï¼š
- `views_pages.py`ï¼š`plan_management_home()` - é¦–é¡µæ•°æ®å‡†å¤‡
- Context å˜é‡ï¼š
  - `user_todos` - ç”¨æˆ·å¾…åŠåˆ—è¡¨ï¼ˆå‰5æ¡ï¼‰
  - `user_todos_count` - å¾…åŠæ€»æ•°
  - `risk_todos` - é£é™©é¡¹åˆ—è¡¨ï¼ˆå‰5æ¡ï¼‰
  - `risk_todos_count` - é£é™©é¡¹æ€»æ•°

---

## âœ… P2-4 éªŒæ”¶æ ‡å‡†æ£€æŸ¥

| éªŒæ”¶ç‚¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| æœªæ¥æ”¶ç›®æ ‡/è®¡åˆ’èƒ½è¿›å…¥å¾…åŠ | âœ… | `get_user_todos()` å·²å®ç° |
| æ¥æ”¶åå¾…åŠæ¶ˆå¤± | âœ… | é€šè¿‡çŠ¶æ€æŸ¥è¯¢ï¼Œæ¥æ”¶åçŠ¶æ€æ”¹å˜ï¼Œå¾…åŠè‡ªåŠ¨æ¶ˆå¤± |
| é£é™©è®¡åˆ’è‡ªåŠ¨è¿›å…¥å¾…åŠ | âœ… | é€¾æœŸè®¡åˆ’/ç›®æ ‡è‡ªåŠ¨è¿›å…¥å¾…åŠ |
| äº‹ä»¶é€šçŸ¥èƒ½æ­£å¸¸å‘é€ | âœ… | æ‰€æœ‰äº‹ä»¶é€šçŸ¥å·²å®ç° |
| æ¯å¤© 9 ç‚¹èƒ½ç”Ÿæˆæ±‡æ€»æé†’ | âœ… | `daily_todo_reminder` å‘½ä»¤å·²å®ç° |
| é¦–é¡µèƒ½çœ‹åˆ°å¾…åŠä¸é£é™© | âœ… | é¦–é¡µ context å·²æ·»åŠ å¾…åŠå’Œé£é™©æ•°æ® |
| æ— æ–°å¢"é­”æ³•çŠ¶æ€" | âœ… | æ‰€æœ‰å¾…åŠé€šè¿‡çŠ¶æ€+è§„åˆ™è®¡ç®—ï¼Œä¸æ–°å¢çŠ¶æ€ |

---

## ğŸ”§ æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶ï¼š
1. **services/todo_service.py**ï¼š
   - `get_user_todos()` - è·å–ç”¨æˆ·å¾…åŠåˆ—è¡¨
   - `get_user_todo_summary()` - è·å–ç”¨æˆ·å¾…åŠæ±‡æ€»ç»Ÿè®¡

2. **management/commands/daily_todo_reminder.py**ï¼š
   - Django ç®¡ç†å‘½ä»¤ï¼Œæ¯æ—¥ 9 ç‚¹æ‰§è¡Œ

3. **tasks.py**ï¼š
   - Celery ä»»åŠ¡å®šä¹‰ï¼ˆå¯é€‰ï¼‰

### ä¿®æ”¹æ–‡ä»¶ï¼š
1. **notifications.py**ï¼š
   - æ–°å¢ `notify_goal_accepted()` - é€šçŸ¥ç›®æ ‡è¢«æ¥æ”¶
   - æ–°å¢ `notify_plan_accepted()` - é€šçŸ¥è®¡åˆ’è¢«æ¥æ”¶

2. **views_pages.py**ï¼š
   - `strategic_goal_detail()` - æ¥æ”¶ç›®æ ‡æ—¶è§¦å‘é€šçŸ¥
   - `plan_detail()` - æ¥æ”¶è®¡åˆ’æ—¶è§¦å‘é€šçŸ¥
   - `plan_management_home()` - æ·»åŠ å¾…åŠå’Œé£é™©æ•°æ®åˆ° context

---

## ğŸ“Š å¾…åŠæ¥æºè§„åˆ™

| å¾…åŠç±»å‹ | æŸ¥è¯¢è§„åˆ™ | ä¼˜å…ˆçº§ |
|---------|---------|--------|
| å¾…æ¥æ”¶ç›®æ ‡ | `level='personal' AND status='published' AND owner=user` | high |
| å¾…æ¥æ”¶è®¡åˆ’ | `level='personal' AND status='published' AND owner=user` | high |
| å¾…æ‰§è¡Œç›®æ ‡ | `level='personal' AND status='accepted' AND owner=user` | medium |
| å¾…æ‰§è¡Œè®¡åˆ’ | `level='personal' AND status='accepted' AND owner=user` | medium |
| ä»Šæ—¥åº”æ‰§è¡Œè®¡åˆ’ | `level='personal' AND status='in_progress' AND owner=user AND today âˆˆ [start_time, end_time]` | high |
| é£é™©è®¡åˆ’ | `level='personal' AND status IN ['draft','published','accepted','in_progress'] AND owner=user AND end_time < now` | high |
| é£é™©ç›®æ ‡ | `level='personal' AND status IN ['published','accepted','in_progress'] AND owner=user AND end_date < today` | high |

---

## ğŸ¯ å…³é”®åŠŸèƒ½ç‚¹

### 1. å¾…åŠä¸å­˜è¡¨
- **åŸåˆ™**ï¼šé€šè¿‡çŠ¶æ€+è§„åˆ™æŸ¥è¯¢å®ç°
- **ä¼˜åŠ¿**ï¼šæ•°æ®å®æ—¶ã€ä¸å†—ä½™ã€æ˜“ç»´æŠ¤

### 2. æ¥æ”¶åå¾…åŠæ¶ˆå¤±
- **æœºåˆ¶**ï¼šçŠ¶æ€æ”¹å˜åï¼ŒæŸ¥è¯¢æ¡ä»¶ä¸å†åŒ¹é…
- **ç¤ºä¾‹**ï¼š`status='published'` â†’ `status='accepted'`ï¼Œå¾…æ¥æ”¶å¾…åŠè‡ªåŠ¨æ¶ˆå¤±

### 3. æ¯æ—¥å®šæ—¶ä»»åŠ¡
- **æ—¶é—´**ï¼šæ¯å¤© 9:00
- **å†…å®¹**ï¼šæ±‡æ€»æ¯ä¸ªç”¨æˆ·çš„å¾…åŠå’Œé£é™©
- **å½¢å¼**ï¼šç«™å†…é€šçŸ¥

### 4. é¦–é¡µå¾…åŠ/é£é™©å±•ç¤º
- **å¾…åŠ**ï¼šå‰ 5 æ¡ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
- **é£é™©**ï¼šå‰ 5 æ¡é«˜é£é™©é¡¹
- **è·³è½¬**ï¼šæ‰€æœ‰å¾…åŠéƒ½å¯ä»¥ç‚¹å‡»è·³è½¬åˆ°è¯¦æƒ…é¡µ

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### è·å–ç”¨æˆ·å¾…åŠï¼š
```python
from backend.apps.plan_management.services.todo_service import get_user_todos, get_user_todo_summary

# è·å–å¾…åŠåˆ—è¡¨
todos = get_user_todos(user)
for todo in todos:
    print(f"{todo['title']} - {todo['priority']} - {todo['url']}")

# è·å–å¾…åŠæ±‡æ€»
summary = get_user_todo_summary(user)
print(f"æ€»å¾…åŠï¼š{summary['total']}")
print(f"å¾…æ¥æ”¶ï¼š{summary['pending_accept']}")
print(f"é£é™©é¡¹ï¼š{summary['risk_items']}")
```

### æ‰‹åŠ¨æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼š
```bash
# æµ‹è¯•æ¨¡å¼ï¼ˆä»…ç»Ÿè®¡ï¼Œä¸å‘é€ï¼‰
python manage.py daily_todo_reminder --dry-run

# å®é™…æ‰§è¡Œ
python manage.py daily_todo_reminder
```

---

## ğŸš€ ä¸‹ä¸€æ­¥ï¼šP2-5 é¦–é¡µæ•°æ®ä¸­å¿ƒå®šç‰ˆ

P2-4 å·²å®Œæˆï¼Œå¯ä»¥å¼€å§‹ P2-5ï¼š
- ç›®æ ‡æ°¸è¿œåœ¨ç¬¬ä¸€è¡Œ
- è®¡åˆ’åœ¨ç¬¬äºŒè¡Œ
- å¾…åŠå’Œé£é™©åœ¨ç¬¬ä¸‰è¡Œ
- æ•°æ®å±•ç¤ºä¼˜åŒ–

---

**å®Œæˆæ—¶é—´**ï¼š2025-01-XX  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œå¯è¿›å…¥ P2-5

