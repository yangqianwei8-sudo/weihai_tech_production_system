# 计划管理模块权限系统说明

## 问题描述

在后台权限管理界面中，会出现两套"查看计划"权限：
1. `plan_management.view_plan` - 计划管理 - 查看计划
2. `plan_management.plan.view` - 计划管理 - 查看计划

## 原因分析

### 1. Django 自动生成的权限：`plan_management.view_plan`

- **来源**：Django 为 `Plan` 模型自动生成的默认权限
- **格式**：`app_label.view_modelname`
- **存储位置**：`auth_permission` 表（Django 内置权限表）
- **用途**：Django Admin 后台使用
- **问题**：**实际代码中并未使用此权限**

### 2. 自定义业务权限：`plan_management.plan.view`

- **来源**：在 `seed_permissions.py` 中定义的自定义业务权限
- **格式**：`app_label.resource.action`
- **存储位置**：`system_permission_item` 表（业务权限表）
- **用途**：业务权限控制
- **状态**：作为兼容权限使用（在 `_permission_granted` 函数中）

### 3. 实际使用的权限：`plan_management.view`

- **来源**：在 `seed_permissions.py` 中定义
- **用途**：**菜单系统实际使用的权限**
- **代码位置**：`views_pages.py` 中所有菜单配置都使用 `plan_management.view`

## 权限使用情况

### 菜单系统使用的权限

```python
# views_pages.py 中的菜单配置
{
    'id': 'plan_management',
    'label': '计划管理',
    'permission': 'plan_management.view',  # 实际使用的权限
    ...
}
```

### 权限检查逻辑

```python
# core/views.py 中的 _permission_granted 函数
if required_code == 'plan_management.view':
    # 检查是否有任何计划管理相关权限（包括审批权限）
    plan_permissions = [
        'plan_management.view',
        'plan_management.approve',
        'plan_management.approve_plan',
        'plan_management.plan.view',  # 作为兼容权限
        'plan_management.goal.view',
    ]
```

## 解决方案

### 方案一：统一使用业务权限系统（推荐）

**优点**：
- 权限管理统一
- 避免混淆
- 符合业务需求

**步骤**：
1. 禁用 Django 自动生成的 `plan_management.view_plan` 权限（在 Django Admin 中禁用）
2. 统一使用 `plan_management.plan.view` 作为查看计划的权限
3. 更新菜单配置，使用 `plan_management.plan.view` 替代 `plan_management.view`

### 方案二：保留现状，添加说明

**优点**：
- 不需要修改代码
- 保持向后兼容

**步骤**：
1. 在权限管理界面添加说明，区分两套权限的用途
2. 建议用户只使用 `plan_management.plan.view`（业务权限）
3. 忽略 Django 自动生成的 `plan_management.view_plan` 权限

### 方案三：删除 Django 自动生成的权限

**优点**：
- 彻底解决重复问题
- 简化权限管理

**步骤**：
1. 在 Django Admin 中删除 `plan_management.view_plan` 权限
2. 或者通过数据库直接删除：
   ```sql
   DELETE FROM auth_permission 
   WHERE codename = 'view_plan' 
   AND content_type_id IN (
       SELECT id FROM django_content_type 
       WHERE app_label = 'plan_management' 
       AND model = 'plan'
   );
   ```

## 建议

**推荐使用方案二**，原因：
1. 不需要修改现有代码
2. 保持向后兼容
3. 风险最小

**如果选择方案一**，需要：
1. 更新所有菜单配置中的权限代码
2. 更新权限检查逻辑
3. 更新所有相关的管理命令
4. 进行充分测试

## 相关文件

- `backend/apps/system_management/management/commands/seed_permissions.py` - 权限定义
- `backend/apps/plan_management/views_pages.py` - 菜单配置
- `backend/core/views.py` - 权限检查逻辑
- `backend/apps/plan_management/management/commands/create_menu_permissions.py` - 菜单权限创建

## 总结

两套"查看计划"权限的存在是因为：
1. Django 自动生成的权限（`plan_management.view_plan`）- **实际未使用**
2. 自定义业务权限（`plan_management.plan.view`）- **作为兼容权限使用**
3. 实际菜单使用的权限（`plan_management.view`）- **主要权限**

建议在权限管理界面添加说明，或者统一使用一套权限系统。

