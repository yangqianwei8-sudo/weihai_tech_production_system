# P2-1 ä»£ç é€‚é…ä¿®å¤æ¸…å•

> **åˆ›å»ºæ—¶é—´**ï¼š2025-01-XX  
> **ç›®çš„**ï¼šè®°å½•æ‰€æœ‰éœ€è¦é€‚é…çš„ä»£ç ä½ç½®ï¼Œé¿å…é—æ¼

---

## ä¸€ã€å·²ä¿®å¤çš„æ–‡ä»¶

### âœ… views_dashboard.py
- **ä¿®å¤å†…å®¹**ï¼š
  - `status="overdue"` â†’ æ”¹ä¸ºè®¡ç®—é€¾æœŸï¼š`end_time__lt=now, status__in=['draft','published','accepted','in_progress']`
  - `status="pending_approval"` â†’ æ”¹ä¸ºåŸºäº `PlanDecision` æŸ¥è¯¢
- **çŠ¶æ€**ï¼šå·²å®Œæˆ

---

## äºŒã€éœ€è¦é€‚é…çš„æ–‡ä»¶ï¼ˆplan_type â†’ levelï¼‰

### 1. views_pages.py
**ä½ç½®**ï¼šå¤šå¤„ä½¿ç”¨ `plan_type` ç­›é€‰
- ç¬¬ 859 è¡Œï¼š`plan_type_filter = request.GET.get('plan_type', '').strip()`
- ç¬¬ 886-887 è¡Œï¼š`if plan_type_filter: plans = plans.filter(plan_type=plan_type_filter)`
- ç¬¬ 975 è¡Œï¼š`'plan_type_filter': plan_type_filter`
- ç¬¬ 1384 è¡Œï¼š`plan_type_filter = request.GET.get('plan_type', '')`
- ç¬¬ 1406-1407 è¡Œï¼š`if plan_type_filter: plans = plans.filter(plan_type=plan_type_filter)`
- ç¬¬ 1432 è¡Œï¼š`'plan_type_filter': plan_type_filter`
- ç¬¬ 2546 è¡Œï¼š`plan_type = request.GET.get('plan_type', '')`
- ç¬¬ 2559-2560 è¡Œï¼š`if plan_type: plans = plans.filter(plan_type=plan_type)`
- ç¬¬ 2579 è¡Œï¼š`type_stats = plans.values('plan_type').annotate(count=Count('id')).order_by('plan_type')`
- ç¬¬ 2615 è¡Œï¼š`'plan_type': plan_type`
- ç¬¬ 2744 è¡Œï¼š`plan_by_type = plans.values('plan_type').annotate(count=Count('id'))`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- æ”¹ä¸ºä½¿ç”¨ `level` å­—æ®µ
- å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœ `level` ä¸ºç©ºåˆ™å›é€€ `plan_type`ï¼ˆè¿‡æ¸¡æœŸï¼‰

### 2. forms.py
**ä½ç½®**ï¼š
- ç¬¬ 457 è¡Œï¼š`'plan_number', 'name', 'plan_type', 'plan_period'`
- ç¬¬ 484 è¡Œï¼š`'plan_type': forms.Select(attrs={'class': 'form-select'})`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- æ”¹ä¸ºä½¿ç”¨ `level` å­—æ®µ
- æ›´æ–°è¡¨å•å­—æ®µå®šä¹‰

### 3. views.py
**ä½ç½®**ï¼š
- ç¬¬ 709 è¡Œï¼š`filterset_fields = ['status', 'plan_type', 'plan_period']`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- æ”¹ä¸ºï¼š`filterset_fields = ['status', 'level', 'plan_period']`

### 4. æµ‹è¯•ä»£ç 
**ä½ç½®**ï¼š
- `tests/test_plan_decision_v2.py`ï¼šç¬¬ 49 è¡Œä½¿ç”¨ `plan_type="personal"`
- `management/commands/create_test_plans.py`ï¼šå¤šå¤„ä½¿ç”¨ `plan_type`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- æ”¹ä¸ºä½¿ç”¨ `level` å­—æ®µ

---

## ä¸‰ã€éœ€è¦æ¸…ç†çš„æ— æ•ˆçŠ¶æ€å¼•ç”¨

### 1. views.py
**ä½ç½®**ï¼šå¤šå¤„ä½¿ç”¨ `status__in=['pending', 'in_progress']`
- ç¬¬ 343 è¡Œï¼š`status__in=['pending', 'in_progress']`ï¼ˆè¿™æ˜¯ ApprovalInstance çš„çŠ¶æ€ï¼Œä¸æ˜¯ Plan çš„çŠ¶æ€ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
- ç¬¬ 445 è¡Œï¼šåŒä¸Š
- ç¬¬ 547 è¡Œï¼šåŒä¸Š
- ç¬¬ 643 è¡Œï¼šåŒä¸Š
- ç¬¬ 1192 è¡Œï¼šåŒä¸Š
- ç¬¬ 1309 è¡Œï¼šåŒä¸Š
- ç¬¬ 1407 è¡Œï¼šåŒä¸Š
- ç¬¬ 1509 è¡Œï¼šåŒä¸Š

**è¯´æ˜**ï¼šè¿™äº› `pending` æ˜¯ `ApprovalInstance` çš„çŠ¶æ€ï¼Œä¸æ˜¯ Plan çš„çŠ¶æ€ï¼Œ**æ— éœ€ä¿®æ”¹**ã€‚

### 2. views.py
**ä½ç½®**ï¼šä½¿ç”¨ `pending_approval` çŠ¶æ€
- ç¬¬ 71 è¡Œï¼š`elif obj.status == 'pending_approval':`ï¼ˆè¿™æ˜¯ StrategicGoal çš„æ—§çŠ¶æ€ï¼Œéœ€è¦æ£€æŸ¥ï¼‰
- ç¬¬ 77 è¡Œï¼š`new_status="pending_approval"`
- ç¬¬ 91 è¡Œï¼š`new_status="pending_approval"`
- ç¬¬ 328 è¡Œï¼š`goal.status = 'pending_approval'`ï¼ˆStrategicGoal çš„æ—§çŠ¶æ€ï¼‰
- ç¬¬ 372 è¡Œï¼š`new_status='pending_approval'`
- ç¬¬ 384 è¡Œï¼š`"status": {"from": old_status, "to": "pending_approval"}`
- ç¬¬ 419 è¡Œï¼š`if goal.status != 'pending_approval':`ï¼ˆStrategicGoalï¼‰
- ç¬¬ 521 è¡Œï¼š`if goal.status != 'pending_approval':`ï¼ˆStrategicGoalï¼‰
- ç¬¬ 623 è¡Œï¼š`if goal.status != 'pending_approval':`ï¼ˆStrategicGoalï¼‰
- ç¬¬ 1177 è¡Œï¼šæ³¨é‡Šæ‰çš„ä»£ç ï¼š`# plan.status = 'pending_approval'`
- ç¬¬ 1220 è¡Œï¼š`new_status='pending_approval'`ï¼ˆPlanStatusLogï¼‰
- ç¬¬ 1231 è¡Œï¼š`"status": {"from": old_status, "to": "pending_approval"}`

**è¯´æ˜**ï¼š
- StrategicGoal çš„ `pending_approval` çŠ¶æ€å·²è¿ç§»åˆ° `draft`ï¼ˆ0018ï¼‰
- Plan çš„ `pending_approval` çŠ¶æ€å·²è¿ç§»åˆ° `draft`ï¼ˆ0003ï¼‰
- è¿™äº›ä»£ç éœ€è¦æ›´æ–°ä¸ºä½¿ç”¨ `draft` æˆ–åŸºäº `PlanDecision` åˆ¤æ–­

---

## å››ã€ä¿®å¤ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
1. âœ… views_dashboard.pyï¼ˆå·²å®Œæˆï¼‰
2. views_pages.py ä¸­çš„ `plan_type` ç­›é€‰ï¼ˆå½±å“åˆ—è¡¨é¡µåŠŸèƒ½ï¼‰
3. forms.py ä¸­çš„ `plan_type` å­—æ®µï¼ˆå½±å“è¡¨å•ï¼‰

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰
1. views.py ä¸­çš„ `plan_type` filterset_fields
2. views.py ä¸­çš„ `pending_approval` çŠ¶æ€åˆ¤æ–­ï¼ˆStrategicGoalï¼‰

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯å»¶åï¼‰
1. æµ‹è¯•ä»£ç ä¸­çš„ `plan_type`
2. ç®¡ç†å‘½ä»¤ä¸­çš„ `plan_type`

---

## äº”ã€ä¿®å¤ç­–ç•¥

### plan_type â†’ level è¿ç§»ç­–ç•¥
1. **å…¼å®¹è¿‡æ¸¡æœŸ**ï¼š
   ```python
   # ä¼˜å…ˆä½¿ç”¨ levelï¼Œå¦‚æœä¸ºç©ºåˆ™å›é€€ plan_type
   qs = Plan.objects.all()
   if level_filter:
       qs = qs.filter(Q(level=level_filter) | Q(level__isnull=True, plan_type=level_filter))
   ```

2. **é€æ­¥è¿ç§»**ï¼š
   - å…ˆæ›´æ–°å…³é”®å…¥å£ï¼ˆåˆ—è¡¨é¡µã€è¡¨å•ï¼‰
   - å†æ›´æ–°ç»Ÿè®¡å’ŒæŠ¥è¡¨
   - æœ€åæ›´æ–°æµ‹è¯•ä»£ç 

### pending_approval çŠ¶æ€ä¿®å¤ç­–ç•¥
1. **StrategicGoal**ï¼š
   - `status == 'pending_approval'` â†’ `status == 'draft'`
   - æˆ–ä½¿ç”¨ `PlanDecision` åˆ¤æ–­æ˜¯å¦å¾…å®¡æ‰¹

2. **Plan**ï¼š
   - `status == 'pending_approval'` â†’ `status == 'draft'`
   - æˆ–ä½¿ç”¨ `PlanDecision(decided_at__isnull=True)` åˆ¤æ–­æ˜¯å¦å¾…å®¡æ‰¹

---

## å…­ã€ä¿®å¤è¿›åº¦

- [x] views_dashboard.py
- [ ] views_pages.pyï¼ˆplan_type â†’ levelï¼‰
- [ ] forms.pyï¼ˆplan_type â†’ levelï¼‰
- [ ] views.pyï¼ˆplan_type filterset_fieldsï¼‰
- [ ] views.pyï¼ˆpending_approval çŠ¶æ€åˆ¤æ–­ï¼‰
- [ ] æµ‹è¯•ä»£ç 
- [ ] ç®¡ç†å‘½ä»¤

---

## ä¸ƒã€P2-1 æ”¶å£çº¦æŸï¼ˆå¿…é¡»éµå®ˆï¼‰

### âŒ ç¦æ­¢äº‹é¡¹

1. **ç¦æ­¢åœ¨ P2 ä¹‹åæ–°å¢å¯¹ `plan_type` çš„ä½¿ç”¨**
   - æ‰€æœ‰æ–°ä»£ç å¿…é¡»ä½¿ç”¨ `level` å­—æ®µ
   - å¦‚æœå‘ç°é—ç•™ä»£ç ä½¿ç”¨ `plan_type`ï¼Œåº”é€æ­¥è¿ç§»åˆ° `level`

2. **ç¦æ­¢å¼•å…¥éæšä¸¾ status**
   - ç¦æ­¢ç¡¬ç¼–ç çŠ¶æ€å­—ç¬¦ä¸²ï¼ˆå¦‚ `'overdue'`, `'pending_approval'`ï¼‰
   - å¿…é¡»ä½¿ç”¨æ¨¡å‹å®šä¹‰çš„ `STATUS_CHOICES`
   - çŠ¶æ€åˆ¤æ–­å¿…é¡»é€šè¿‡ `transition_to()` æ–¹æ³•

3. **ç¦æ­¢ç»•è¿‡çŠ¶æ€æœºç›´æ¥ä¿®æ”¹ status**
   - å¿…é¡»ä½¿ç”¨ `transition_to()` æ–¹æ³•è¿›è¡ŒçŠ¶æ€è½¬æ¢
   - ç¦æ­¢ç›´æ¥ `plan.status = 'xxx'` æˆ– `goal.status = 'xxx'`

### âœ… æ¨èåšæ³•

1. **ä½¿ç”¨çŠ¶æ€æœºæ–¹æ³•**ï¼š
   ```python
   # âœ… æ­£ç¡®
   plan.transition_to('published', user=request.user)
   
   # âŒ é”™è¯¯
   plan.status = 'published'
   plan.save()
   ```

2. **ä½¿ç”¨ level å­—æ®µ**ï¼š
   ```python
   # âœ… æ­£ç¡®
   plans = Plan.objects.filter(level='company')
   
   # âŒ é”™è¯¯ï¼ˆé—ç•™ä»£ç ï¼Œéœ€è¿ç§»ï¼‰
   plans = Plan.objects.filter(plan_type='company')
   ```

3. **çŠ¶æ€åˆ¤æ–­ä½¿ç”¨æšä¸¾**ï¼š
   ```python
   # âœ… æ­£ç¡®
   if plan.status == Plan.STATUS_CHOICES[1][0]:  # 'published'
   
   # âœ… æ›´å¥½
   if plan.status == 'published':
       # ä½†ç¡®ä¿ 'published' åœ¨ STATUS_CHOICES ä¸­
   ```

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX  
**æ”¶å£çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

