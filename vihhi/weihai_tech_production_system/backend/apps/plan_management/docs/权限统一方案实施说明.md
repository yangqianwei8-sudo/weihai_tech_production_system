# 计划管理模块权限统一方案实施说明

## 问题背景

在后台权限管理界面中出现了两套"查看计划"权限：
1. `plan_management.view_plan` - Django 自动生成的权限
2. `plan_management.plan.view` - 自定义业务权限

实际菜单系统使用的是 `plan_management.view` 权限。

## 已完成的修改

### 1. 创建权限清理命令

**文件**：`backend/apps/plan_management/management/commands/cleanup_redundant_permissions.py`

**功能**：删除 Django 自动生成的冗余权限
- `plan_management.view_plan`
- `plan_management.view_strategicgoal`

**使用方法**：
```bash
# 预览模式（不实际删除）
python manage.py cleanup_redundant_permissions --dry-run

# 交互式删除（需要确认）
python manage.py cleanup_redundant_permissions

# 强制删除（跳过确认）
python manage.py cleanup_redundant_permissions --force
```

### 2. 更新视图权限检查

**文件**：`backend/apps/plan_management/views_dashboard.py`

**修改**：将 `plan_management.view_plan` 改为使用 `plan_management.view` 权限检查

**变更前**：
```python
require_perm(request.user, "plan_management.view_plan")
```

**变更后**：
```python
from backend.apps.system_management.services import get_user_permission_codes
permission_codes = get_user_permission_codes(request.user)
from backend.core.views import _permission_granted
if not _permission_granted('plan_management.view', permission_codes):
    raise PermissionDenied('您没有权限查看计划管理仪表板')
```

### 3. 更新权限分配命令

**文件**：`backend/apps/plan_management/management/commands/grant_plan_business_permissions.py`

**修改**：优先使用标准业务权限 `plan_management.view`，兼容旧权限代码

**变更**：
- 优先使用：`plan_management.view`、`plan_management.plan.view`、`plan_management.goal.view`
- 兼容旧权限：`plan_management.view_plan`、`plan_management.view_strategicgoal`

### 4. 更新菜单权限创建命令

**文件**：`backend/apps/plan_management/management/commands/create_menu_permissions.py`

**修改**：添加说明注释，明确菜单系统实际使用的权限

## 权限体系说明

### 标准权限（推荐使用）

1. **`plan_management.view`** - 计划管理模块查看权限（菜单系统使用）
2. **`plan_management.plan.view`** - 查看计划权限
3. **`plan_management.plan.create`** - 创建计划权限
4. **`plan_management.plan.manage`** - 管理计划权限
5. **`plan_management.goal.view`** - 查看目标权限
6. **`plan_management.goal.create`** - 创建目标权限
7. **`plan_management.manage_goal`** - 管理目标权限
8. **`plan_management.approve`** - 审批权限

### 兼容权限（逐步废弃）

1. **`plan_management.view_plan`** - Django 自动生成，建议删除
2. **`plan_management.view_strategicgoal`** - Django 自动生成，建议删除

## 实施步骤

### 步骤 1：清理冗余权限

运行清理命令删除 Django 自动生成的权限：

```bash
python manage.py cleanup_redundant_permissions
```

### 步骤 2：验证权限配置

确保所有角色都分配了正确的业务权限：

```bash
# 检查用户权限
python manage.py grant_plan_business_permissions --username <username>

# 验证权限
python manage.py verify_unified_permissions
```

### 步骤 3：测试系统功能

1. 测试菜单显示是否正常
2. 测试页面访问权限控制
3. 测试不同角色的权限差异

## 注意事项

1. **不要删除业务权限**：只删除 Django 自动生成的权限
2. **保留兼容性**：代码中已添加兼容逻辑，支持旧权限代码
3. **测试验证**：删除权限后务必测试系统功能
4. **备份数据**：建议在执行清理操作前备份数据库

## 后续工作建议

1. **统一权限检查**：逐步将所有视图函数的权限检查统一使用 `plan_management.view`
2. **更新文档**：更新开发文档，明确权限使用规范
3. **代码审查**：检查其他模块是否也存在类似的权限重复问题

## 相关文件

- `backend/apps/plan_management/management/commands/cleanup_redundant_permissions.py` - 权限清理命令
- `backend/apps/plan_management/views_dashboard.py` - 仪表板视图（已更新）
- `backend/apps/plan_management/management/commands/grant_plan_business_permissions.py` - 权限分配命令（已更新）
- `backend/apps/plan_management/docs/权限系统说明.md` - 权限系统详细说明

## 问题反馈

如果遇到权限相关问题，请检查：
1. 用户是否分配了正确的业务权限
2. 权限代码是否正确（使用 `plan_management.view` 而非 `plan_management.view_plan`）
3. 菜单配置中的权限代码是否正确

