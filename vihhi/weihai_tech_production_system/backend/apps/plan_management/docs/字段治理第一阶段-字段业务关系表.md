# 计划管理模块 - 字段治理第一阶段：字段—业务关系表

> **治理阶段**：第一阶段（只梳理、标记、定型，不重构）  
> **创建时间**：2025-01-XX  
> **适用范围**：Plan 模型及相关证据模型

---

## 一、治理目标

明确每个字段的：
1. **业务含义**：字段在业务中的实际作用
2. **参与判断**：字段在哪些业务逻辑中作为"裁决依据"
3. **是否可直接修改**：字段是否允许业务直接修改，还是必须通过特定流程

---

## 二、Plan 模型字段—业务关系表

| 字段 | 所属模型 | 业务含义 | 参与判断 | 是否可直接修改 | 备注 |
|------|---------|---------|---------|--------------|------|
| `plan_number` | Plan | 计划编号 | 唯一标识、列表筛选 | ❌（系统生成） | 格式：PLAN-{YYYYMMDD}-{序列号} |
| `name` | Plan | 计划名称 | 执行条件检查、列表展示 | ✅ | 必须填写，用于执行条件判断 |
| `plan_type` | Plan | 计划类型 | 列表筛选、统计分类 | ✅ | 创建时确定，后续不建议修改 |
| `plan_period` | Plan | 计划周期 | 列表筛选、统计分类 | ✅ | 创建时确定，后续不建议修改 |
| `status` | Plan | 生命周期状态 | **所有流程的核心裁决依据** | ❌（仅通过裁决器） | 必须通过 `adjudicator.py` 或 `plan_decisions.py` 变更 |
| `related_goal` | Plan | 关联战略目标 | 目标对齐度计算 | ⚠️（创建后不建议修改） | 外键，创建时确定 |
| `alignment_score` | Plan | 目标对齐度 | 目标对齐度评估 | ❌（系统计算） | 自动计算，0-100分 |
| `contribution_score` | Plan | 贡献度评估 | 贡献度评估 | ⚠️（手动评估） | 0-100分，可手动设置 |
| `content` | Plan | 计划内容 | 计划详情展示 | ✅ | 支持富文本 |
| `plan_objective` | Plan | 计划目标 | **责任界定、目标对齐** | ✅ | 用于明确计划目标，参与责任界定 |
| `acceptance_criteria` | Plan | 验收标准 | **完成判定、裁决依据** | ✅ | 提交审批前必填，用于判定计划是否完成 |
| `description` | Plan | 计划描述 | 计划详情展示 | ✅ | 补充说明 |
| `start_time` | Plan | 计划开始时间 | 执行条件检查、状态自动判断 | ⚠️（受控修改） | 用于判断计划是否应进入执行中状态 |
| `end_time` | Plan | 计划结束时间 | **逾期判断、不作为检测** | ⚠️（受控修改） | 用于逾期检测和不作为判断，修改需通过 PlanAdjustment |
| `duration_days` | Plan | 计划周期（天） | 统计展示 | ❌（系统计算） | 自动计算 |
| `responsible_person` | Plan | 计划负责人 | **责任界定、不作为检测** | ⚠️（创建后不建议修改） | 用于责任界定和不作为记录 |
| `participants` | Plan | 协作人员 | 协作计划展示 | ✅ | 多对多关系 |
| `collaboration_plan` | Plan | 协作计划 | 协作计划展示 | ✅ | 如果选择了协作人员，必须填写 |
| `responsible_department` | Plan | 负责部门 | 列表筛选、统计分类 | ⚠️（创建后不建议修改） | 外键 |
| `priority` | Plan | 计划优先级 | 列表排序、筛选 | ✅ | 高/中/低 |
| `budget` | Plan | 计划预算 | 预算统计 | ✅ | 单位：元 |
| `related_project` | Plan | 关联项目 | 项目关联展示 | ⚠️（创建后不建议修改） | 外键 |
| `parent_plan` | Plan | 父计划 | 计划分解展示 | ⚠️（创建后不建议修改） | 外键，用于计划分解 |
| `notes` | Plan | 备注 | 备注展示 | ✅ | 自由文本 |
| `progress` | Plan | 执行进度 | **完成判定、状态裁决** | ⚠️（通过 PlanProgressRecord） | 0-100%，达到100%时系统自动判定完成 |
| `created_by` | Plan | 创建人 | 创建记录 | ❌（系统记录） | 创建时自动记录 |
| `created_time` | Plan | 创建时间 | 创建记录、列表排序 | ❌（系统记录） | 创建时自动记录 |
| `updated_time` | Plan | 更新时间 | 更新记录 | ❌（系统自动更新） | 每次保存自动更新 |

---

## 三、证据模型字段—业务关系表

### 3.1 PlanStatusLog（计划状态转换日志）

| 字段 | 业务含义 | 参与判断 | 是否可直接修改 | 备注 |
|------|---------|---------|--------------|------|
| `plan` | 关联计划 | 日志查询 | ❌（创建时确定） | 外键 |
| `old_status` | 原状态 | 状态转换追溯 | ❌（系统记录） | 系统自动记录 |
| `new_status` | 新状态 | 状态转换追溯 | ❌（系统记录） | 系统自动记录 |
| `change_reason` | 变更原因 | 变更追溯 | ⚠️（创建时可设置） | 创建时可设置，后续不建议修改 |
| `changed_by` | 变更人 | 变更追溯 | ❌（系统记录） | 系统自动记录 |
| `changed_time` | 变更时间 | 变更追溯、不作为检测 | ❌（系统记录） | 系统自动记录，用于不作为检测 |
| `notes` | 备注 | 备注展示 | ⚠️（创建时可设置） | 创建时可设置，后续不建议修改 |

**证据属性**：✅ 证据字段，一旦写入即为事实记录，不可修改、不可删除

---

### 3.2 PlanProgressRecord（计划进度记录）

| 字段 | 业务含义 | 参与判断 | 是否可直接修改 | 备注 |
|------|---------|---------|--------------|------|
| `plan` | 关联计划 | 进度查询 | ❌（创建时确定） | 外键 |
| `progress` | 进度百分比 | 进度统计 | ⚠️（创建时可设置） | 创建时可设置，后续不建议修改 |
| `progress_description` | 进度说明 | 进度详情展示 | ⚠️（创建时可设置） | 创建时可设置，后续不建议修改 |
| `execution_result` | 执行结果 | 执行结果展示 | ⚠️（创建时可设置） | 创建时可设置，后续不建议修改 |
| `execution_issues` | 执行问题 | 问题展示 | ⚠️（创建时可设置） | 创建时可设置，后续不建议修改 |
| `recorded_by` | 记录人 | 记录追溯 | ❌（系统记录） | 系统自动记录 |
| `recorded_time` | 记录时间 | 记录追溯、不作为检测 | ❌（系统记录） | 系统自动记录，用于不作为检测 |
| `notes` | 备注 | 备注展示 | ⚠️（创建时可设置） | 创建时可设置，后续不建议修改 |

**证据属性**：✅ 证据字段，一旦写入即为事实记录，不建议修改、不建议删除

---

### 3.3 PlanAdjustment（计划调整申请）

| 字段 | 业务含义 | 参与判断 | 是否可直接修改 | 备注 |
|------|---------|---------|--------------|------|
| `plan` | 关联计划 | 调整申请查询 | ❌（创建时确定） | 外键 |
| `adjustment_reason` | 调整原因 | 调整原因展示 | ⚠️（创建时可设置） | 创建时可设置，审批后不建议修改 |
| `adjustment_content` | 调整内容 | 调整内容展示 | ⚠️（创建时可设置） | 创建时可设置，审批后不建议修改 |
| `status` | 审批状态 | 审批流程 | ⚠️（通过审批流程） | 待审批/已批准/已拒绝 |
| `original_end_time` | 原截止时间 | 调整对比 | ❌（系统记录） | 系统自动记录调整前的截止时间 |
| `new_end_time` | 新截止时间 | 调整生效 | ⚠️（创建时可设置） | 创建时可设置，审批后生效 |
| `approved_by` | 审批人 | 审批追溯 | ❌（系统记录） | 审批时自动记录 |
| `approved_time` | 审批时间 | 审批追溯 | ❌（系统记录） | 审批时自动记录 |
| `approval_notes` | 审批意见 | 审批意见展示 | ⚠️（审批时可设置） | 审批时可设置 |
| `created_by` | 申请人 | 申请追溯 | ❌（系统记录） | 系统自动记录 |
| `created_time` | 申请时间 | 申请追溯 | ❌（系统记录） | 系统自动记录 |
| `updated_time` | 更新时间 | 更新记录 | ❌（系统自动更新） | 每次保存自动更新 |

**证据属性**：✅ 证据字段，一旦写入即为事实记录，不建议修改、不建议删除

---

### 3.4 PlanInactivityLog（计划不作为记录）

| 字段 | 业务含义 | 参与判断 | 是否可直接修改 | 备注 |
|------|---------|---------|--------------|------|
| `plan` | 关联计划 | 不作为记录查询 | ❌（创建时确定） | 外键 |
| `detected_at` | 检测时间 | 检测时间追溯 | ❌（系统记录） | 系统自动记录 |
| `period_start` | 检测区间开始 | 不作为区间界定 | ❌（系统计算） | 系统自动计算 |
| `period_end` | 检测区间结束 | 不作为区间界定 | ❌（系统计算） | 系统自动计算 |
| `reason` | 触发原因 | 不作为原因分类 | ❌（系统记录） | 系统自动记录 |
| `reason_detail` | 原因详情 | 原因详情展示 | ❌（系统生成） | 系统自动生成 |
| `snapshot` | 状态快照 | **裁决证据** | ❌（系统生成） | JSON格式，记录检测时的计划状态，用于裁决证据 |
| `is_confirmed` | 系统确认 | 确认状态 | ❌（系统设置） | 是否为系统自动确认的不作为记录 |

**证据属性**：✅ **核心证据字段**，一旦写入即为事实记录，**不可修改、不可删除**（已在模型层强制限制）

---

### 3.5 PlanDecision（计划决策记录）

| 字段 | 业务含义 | 参与判断 | 是否可直接修改 | 备注 |
|------|---------|---------|--------------|------|
| `plan` | 关联计划 | 决策记录查询 | ❌（创建时确定） | 外键 |
| `request_type` | 请求类型 | 请求类型分类 | ❌（创建时确定） | 启动计划/取消计划 |
| `decision` | 决策结果 | **状态裁决依据** | ⚠️（通过裁决流程） | 通过/驳回，pending 时为空 |
| `requested_by` | 请求人 | 请求追溯 | ❌（系统记录） | 系统自动记录 |
| `requested_at` | 请求时间 | 请求时间追溯 | ❌（系统记录） | 系统自动记录 |
| `decided_by` | 决策人 | 决策追溯 | ❌（系统记录） | 裁决时自动记录 |
| `decided_at` | 决策时间 | 决策时间追溯、pending判定 | ❌（系统记录） | 裁决时自动记录，用于判定是否为pending |
| `reason` | 原因说明 | 原因展示 | ⚠️（创建/裁决时可设置） | 创建或裁决时可设置 |

**证据属性**：✅ 证据字段，一旦写入即为事实记录，不建议修改、不建议删除

---

## 四、字段分类总结

### 4.1 输入字段（用户可直接修改）

- `name`、`content`、`plan_objective`、`acceptance_criteria`、`description`
- `participants`、`collaboration_plan`、`priority`、`budget`、`notes`
- `contribution_score`（手动评估）

**特点**：用户可在表单中直接编辑，用于业务输入

---

### 4.2 管理字段（必须通过特定流程修改）

- `status`：**必须通过裁决器**（`adjudicator.py` 或 `plan_decisions.py`）
- `end_time`：建议通过 `PlanAdjustment` 申请调整
- `start_time`：受控修改，影响状态自动判断
- `progress`：建议通过 `PlanProgressRecord` 记录

**特点**：涉及业务规则，必须通过特定流程或服务层修改

---

### 4.3 系统字段（系统自动管理）

- `plan_number`、`duration_days`、`alignment_score`：系统自动生成/计算
- `created_by`、`created_time`、`updated_time`：系统自动记录

**特点**：完全由系统管理，用户不可直接修改

---

### 4.4 证据字段（一旦写入即为事实记录）

- `PlanInactivityLog`：**核心证据字段**，不可修改、不可删除
- `PlanStatusLog`：证据字段，不建议修改、不建议删除
- `PlanProgressRecord`：证据字段，不建议修改、不建议删除
- `PlanAdjustment`：证据字段，不建议修改、不建议删除
- `PlanDecision`：证据字段，不建议修改、不建议删除

**特点**：用于业务追溯和裁决，一旦写入即为事实记录

---

## 五、关键业务判断中的字段使用

### 5.1 逾期判断

**使用字段**：`end_time`

**判断逻辑**：
```python
# detect_plan_inactivity.py
overdue_plans = Plan.objects.filter(
    end_time__lt=now,
    status__in=['draft', 'in_progress'],
)
```

**业务含义**：当 `end_time < 当前时间` 且 `status != completed` 时，判定为逾期

---

### 5.2 不作为检测

**使用字段**：`end_time`、`status`、`PlanStatusLog.changed_time`、`PlanProgressRecord.recorded_time`、`PlanAdjustment.created_time`

**判断逻辑**：
1. 计划已逾期（`end_time < 当前时间`）
2. 计划未完成（`status != completed`）
3. 最近 N 天无任何操作（无状态变更、无进度记录、无延期申请）

**业务含义**：逾期且无操作，系统自动生成不作为记录

---

### 5.3 完成判定

**使用字段**：`progress`、`acceptance_criteria`

**判断逻辑**：
```python
# adjudicator.py
if float(progress) >= 100:
    return 'completed', '进度达到100%，系统自动完成'
```

**业务含义**：
- 进度达到 100% 时，系统自动判定完成
- `acceptance_criteria` 用于明确完成标准，提交审批前必填

---

### 5.4 状态裁决

**使用字段**：`status`、`decision`（来自 PlanDecision）、`system_facts`

**判断逻辑**：
- 所有状态变更必须通过 `adjudicator.py` 裁决
- 裁决依据：当前状态 + 决策事件 + 系统事实

**业务含义**：确保状态变更符合业务规则，可追溯

---

### 5.5 责任界定

**使用字段**：`plan_objective`、`responsible_person`

**判断逻辑**：
- `plan_objective` 明确计划目标，用于责任界定
- `responsible_person` 明确责任人，用于不作为记录和责任追溯

**业务含义**：明确计划目标和责任人，用于责任界定

---

## 六、字段修改约束总结

### 6.1 不可修改的字段

- `plan_number`：系统生成，不可修改
- `PlanInactivityLog` 所有字段：模型层强制限制，不可修改、不可删除
- `created_by`、`created_time`：系统记录，不可修改
- `updated_time`：系统自动更新，不可手动修改

---

### 6.2 必须通过特定流程修改的字段

- `status`：必须通过裁决器（`adjudicator.py` 或 `plan_decisions.py`）
- `end_time`：建议通过 `PlanAdjustment` 申请调整
- `progress`：建议通过 `PlanProgressRecord` 记录

---

### 6.3 创建后不建议修改的字段

- `related_goal`、`related_project`、`parent_plan`：关联关系，创建后不建议修改
- `responsible_person`、`responsible_department`：责任人信息，创建后不建议修改
- `plan_type`、`plan_period`：计划类型和周期，创建后不建议修改

---

## 七、下一步行动建议

### 7.1 第一阶段（当前阶段）✅

- ✅ 完成字段梳理（本文档）
- ✅ 明确字段业务含义
- ✅ 标记字段修改约束
- ✅ 定型字段—业务关系

---

### 7.2 第二阶段（P3 阶段，待规划）

- ⏳ 字段重构/清洗（如需要）
- ⏳ 字段重命名（如需要）
- ⏳ 字段合并/拆分（如需要）
- ⏳ 强制 NOT NULL（如需要）

---

## 八、维护说明

1. **本文档为第一阶段治理成果**，只做梳理、标记、定型，不做重构
2. **后续如有字段变更**，请及时更新本文档
3. **P3 阶段进行字段重构时**，可基于本文档进行规划
4. **新字段添加时**，请按照本文档格式补充字段—业务关系

---

**文档版本**：v1.0  
**最后更新**：2025-01-XX  
**维护人**：架构负责人
