# P2-5：首页数据中心定版 - 完成总结

> **完成时间**：2025-01-XX  
> **阶段**：P2-5  
> **状态**：✅ 已完成

---

## 📋 完成内容

### 1. 创建统计服务（禁止 view 中直接 ORM）✅

#### 功能实现：
- **目标统计服务**：`services/goal_stats_service.py`
  - `get_user_goal_stats()` - 获取用户目标统计
  - `get_company_goal_stats()` - 获取公司目标统计（管理视角）

- **计划统计服务**：`services/plan_stats_service.py`
  - `get_user_plan_stats()` - 获取用户计划统计
  - `get_company_plan_stats()` - 获取公司计划统计（管理视角）

- **风险查询服务**：`services/risk_query_service.py`
  - `get_user_risk_items()` - 获取用户风险项（需要立刻处理的）

#### 实现位置：
- `services/goal_stats_service.py` - 目标统计服务
- `services/plan_stats_service.py` - 计划统计服务
- `services/risk_query_service.py` - 风险查询服务

---

### 2. 首页结构定版（强制四行）✅

#### 第一行：目标中心（个人优先）
- **我的目标总数**
- **执行中目标**
- **逾期目标**（如有）
- **本月需完成目标**
- 点击全部可跳转

#### 第二行：我的计划执行
- **我的计划总数**
- **执行中计划**
- **今日应执行计划**
- **逾期计划**（高亮）

#### 第三行：待办 & 风险
- **左：我的待办**（前 5 条）
- **右：风险提醒**（前 5 条）
- 这是每天最常用区域

#### 第四行：管理视角（仅有权限者可见）
- **公司目标进度概览**
- **公司计划状态分布**
- **逾期总量趋势**（简单统计）
- 普通员工看不到

#### 实现位置：
- `views_pages.py`：`plan_management_home()` - 首页视图重构

---

### 3. 风险展示规则（P2-5 定死）✅

#### 规则：
- **只展示"需要人立刻处理的"**
- **不展示历史风险**
- **不展示已完成风险**

#### 排序优先级：
1. 逾期天数多
2. 执行中 > 已接收 > 已发布

#### 实现位置：
- `services/risk_query_service.py`：`get_user_risk_items()` - 风险查询服务

---

### 4. 首页数据全部来自 service✅

#### 原则：
- **禁止在 view 中直接写 ORM**
- **首页 view 只做 assemble**
- **所有逻辑在 service**

#### 数据来源：
- 目标统计 → `goal_stats_service`
- 计划统计 → `plan_stats_service`
- 待办 → `todo_service`（P2-4）
- 风险 → `risk_query_service`

---

## ✅ P2-5 验收标准检查

| 验收点 | 状态 | 说明 |
|--------|------|------|
| 首页无任何编辑操作 | ✅ | 首页只做"看"，不做编辑 |
| 普通员工一眼能看懂"我该干嘛" | ✅ | 第一行目标、第二行计划、第三行待办风险 |
| 目标优先于计划 | ✅ | 第一行是目标，第二行是计划 |
| 风险优先于统计 | ✅ | 第三行是待办和风险，第四行才是管理统计 |
| 首页逻辑全部来自 service | ✅ | 所有数据通过 service 获取 |
| 首页结构在一周内不需要再改 | ✅ | 结构已定版，逻辑清晰 |

---

## 🔧 新增/修改的文件

### 新增文件：
1. **services/goal_stats_service.py**：
   - `get_user_goal_stats()` - 用户目标统计
   - `get_company_goal_stats()` - 公司目标统计

2. **services/plan_stats_service.py**：
   - `get_user_plan_stats()` - 用户计划统计
   - `get_company_plan_stats()` - 公司计划统计

3. **services/risk_query_service.py**：
   - `get_user_risk_items()` - 用户风险项查询

### 修改文件：
1. **views_pages.py**：
   - `plan_management_home()` - 首页视图重构，使用 service

---

## 📊 首页结构（P2-5 定版）

```
┌─────────────────────────────────────────────────────────┐
│ 第一行：目标中心（个人优先）                                    │
│ 🎯 我的目标：总数 | 执行中 | 逾期 | 本月需完成                    │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 第二行：我的计划执行                                          │
│ 📋 我的计划：总数 | 执行中 | 今日应执行 | 逾期                  │
└─────────────────────────────────────────────────────────┘

┌──────────────────────────┬──────────────────────────────┐
│ 第三行：待办 & 风险                                      │
│ 左：我的待办（前5条）      │ 右：风险提醒（前5条）            │
└──────────────────────────┴──────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 第四行：管理视角（仅有权限者可见）                                │
│ 📊 公司目标进度概览 | 公司计划状态分布 | 逾期总量趋势              │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 关键功能点

### 1. 首页不做编辑，只做"看"
- **原则**：首页只展示数据，不提供编辑功能
- **优势**：页面加载快，逻辑清晰

### 2. 首页不堆数据，只给"结论 + 入口"
- **原则**：只展示关键指标，详细数据通过跳转查看
- **优势**：用户一眼看懂，不会信息过载

### 3. 目标优先于计划
- **原则**：第一行是目标，第二行是计划
- **优势**：符合"目标驱动计划"的业务逻辑

### 4. 风险优先于统计
- **原则**：第三行是待办和风险，第四行才是管理统计
- **优势**：优先展示需要处理的事项

### 5. 首页逻辑全部来自 service
- **原则**：禁止在 view 中直接写 ORM
- **优势**：逻辑复用、易于测试、易于维护

---

## 📝 使用示例

### 获取用户目标统计：
```python
from backend.apps.plan_management.services.goal_stats_service import get_user_goal_stats

stats = get_user_goal_stats(user)
print(f"总目标：{stats['total']}")
print(f"执行中：{stats['in_progress']}")
print(f"逾期：{stats['overdue']}")
```

### 获取用户风险项：
```python
from backend.apps.plan_management.services.risk_query_service import get_user_risk_items

risk_items = get_user_risk_items(user, limit=5)
for item in risk_items:
    print(f"{item['title']} - 逾期 {item['days_overdue']} 天")
```

---

## 🚀 P2 阶段完成标志

当 P2-5 完成后，意味着：

> **这套系统，已经可以给真实公司用，而不是 Demo**

P2 阶段已完成：
- ✅ P2-1：模型与状态统一
- ✅ P2-2：目标管理闭环
- ✅ P2-3：计划管理闭环
- ✅ P2-4：待办/风险/系统通知
- ✅ P2-5：首页数据中心定版

P3 才会考虑：
- 绩效
- 评分
- 激励
- AI 辅助决策

---

**完成时间**：2025-01-XX  
**状态**：✅ P2 阶段已完成，可进入 P3

