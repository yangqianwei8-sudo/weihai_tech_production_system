# P2-1 模型统一检查清单

> **检查时间**：2025-01-XX  
> **检查范围**：Plan 模型、StrategicGoal 模型  
> **检查目的**：基线检查，为模型统一做准备（只读，不改）

---

## 一、当前字段清单

### 1.1 StrategicGoal 模型当前字段

#### 基本信息：
- `goal_number`：目标编号（CharField，唯一）
- `name`：目标名称
- `goal_type`：目标类型（financial/market/operation/innovation/talent/other）
- `goal_period`：目标周期（annual/half_year/quarterly）
- `status`：目标状态（见状态枚举）

#### 目标指标：
- `indicator_name`：目标指标名称
- `indicator_type`：指标类型（numeric/percentage/boolean/text）
- `indicator_unit`：指标单位
- `target_value`：目标值
- `current_value`：当前值
- `completion_rate`：完成率（自动计算）

#### 责任人信息：
- `responsible_person`：目标负责人（User FK，必填）
- `participants`：参与人员（User M2M）
- `responsible_department`：负责部门（Department FK，可为空）
- **新增字段**：`owner`（User FK，可为空，个人目标必填）
- **新增字段**：`level`（company/personal）

#### 目标描述：
- `description`：目标描述
- `background`：目标背景
- `significance`：目标意义

#### 权重设置：
- `weight`：目标权重（0-100）
- `weight_description`：权重说明

#### 时间信息：
- `start_date`：开始日期
- `end_date`：结束日期
- `duration_days`：目标周期（天，自动计算）
- **新增字段**：`published_at`（发布时间戳）
- **新增字段**：`accepted_at`（接收时间戳）
- **新增字段**：`completed_at`（完成时间戳）

#### 关联信息：
- `parent_goal`：上级目标（Self FK，用于目标分解）
- `related_projects`：关联项目（M2M）
- `notes`：备注

#### 系统字段：
- `created_by`：创建人（User FK）
- `created_time`：创建时间
- `updated_time`：更新时间

---

### 1.2 Plan 模型当前字段

#### 基本信息：
- `plan_number`：计划编号（CharField，唯一）
- `name`：计划名称
- **旧字段**：`plan_type`：计划类型（personal/department/company/project）**→ 需迁移到 `level`**
- **新增字段**：`level`：计划层级（company/personal）
- `plan_period`：计划周期（daily/weekly/monthly/quarterly/yearly）
- `status`：计划状态（见状态枚举）

#### 关联战略目标：
- `related_goal`：关联战略目标（StrategicGoal FK，可为空）
- `alignment_score`：目标对齐度（0-100，自动计算）
- `contribution_score`：贡献度评估（0-100）

#### 计划内容：
- `content`：计划内容（支持富文本）
- `plan_objective`：计划目标
- `acceptance_criteria`：验收标准
- `description`：计划描述

#### 时间信息：
- `start_time`：计划开始时间（DateTime）
- `end_time`：计划结束时间（DateTime）
- `duration_days`：计划周期（天，自动计算）
- **新增字段**：`published_at`（发布时间戳）
- **新增字段**：`accepted_at`（接收时间戳）
- **新增字段**：`completed_at`（完成时间戳）

#### 责任人信息：
- `responsible_person`：计划负责人（User FK，必填）
- `participants`：协作人员（User M2M）
- `collaboration_plan`：协作计划
- `responsible_department`：负责部门（Department FK，可为空）
- **新增字段**：`owner`（User FK，可为空，个人计划必填）

#### 优先级和预算：
- `priority`：计划优先级（high/medium/low）
- `budget`：计划预算

#### 关联信息：
- `related_project`：关联项目（CharField，从商机管理获取）
- `parent_plan`：父计划（Self FK，用于计划分解）
- `notes`：备注

#### 公司和组织部门：
- `company`：公司（OurCompany FK，可为空）
- `org_department`：部门（Department FK，可为空）

#### 进度信息：
- `progress`：执行进度（0-100%）

#### 系统字段：
- `created_by`：创建人（User FK）
- `created_time`：创建时间
- `updated_time`：更新时间

---

## 二、当前状态枚举

### 2.1 StrategicGoal 当前状态（迁移前）

**原始状态（0002_initial.py）：**
- `draft`：制定中
- `published`：已发布
- `in_progress`：执行中
- `completed`：已完成
- `cancelled`：已取消

**历史状态（已迁移）：**
- `pending_approval`：待审批 → 已迁移到 `draft`（0018_fix_pending_approval_status.py）

**当前状态（P2-1 修改后）：**
- `draft`：制定中
- `published`：已发布
- **新增**：`accepted`：已接收
- `in_progress`：执行中
- `completed`：已完成
- `cancelled`：已取消

---

### 2.2 Plan 当前状态（迁移前）

**原始状态（0002_initial.py）：**
- `draft`：草稿
- `pending_approval`：待审批
- `approving`：审批中
- `approved`：已审批
- `in_progress`：执行中
- `completed`：已完成
- `cancelled`：已取消

**历史迁移（0003_alter_plan_status_delete_planapproval.py）：**
- `pending_approval` → `draft`
- `approving` → `in_progress`
- `approved` → `in_progress`

**当前状态（迁移后，0003 之后）：**
- `draft`：草稿
- `in_progress`：执行中
- `completed`：已完成
- `cancelled`：已取消

**当前状态（P2-1 修改后）：**
- `draft`：草稿
- **新增**：`published`：已发布
- **新增**：`accepted`：已接收
- `in_progress`：执行中
- `completed`：已完成
- `cancelled`：已取消

---

## 三、状态映射规则（数据迁移）

### 3.1 StrategicGoal 状态映射

| 旧状态 | 新状态 | 说明 |
|--------|--------|------|
| `draft` | `draft` | 保持不变 |
| `published` | `published` | 保持不变 |
| `in_progress` | `in_progress` | 保持不变 |
| `completed` | `completed` | 保持不变 |
| `cancelled` | `cancelled` | 保持不变 |
| `pending_approval` | `draft` | 已迁移（0018） |

**注意**：新增 `accepted` 状态，现有数据中不会有此状态，需要业务逻辑触发。

---

### 3.2 Plan 状态映射

| 旧状态 | 新状态 | 说明 |
|--------|--------|------|
| `draft` | `draft` | 保持不变 |
| `in_progress` | `in_progress` | 保持不变 |
| `completed` | `completed` | 保持不变 |
| `cancelled` | `cancelled` | 保持不变 |
| `pending_approval` | `draft` | 已迁移（0003） |
| `approving` | `in_progress` | 已迁移（0003） |
| `approved` | `in_progress` | 已迁移（0003） |

**新增状态**：
- `published`：已发布（审批通过后）
- `accepted`：已接收（员工确认）

**映射规则**：
- 现有 `in_progress` 状态：如果是从 `approved` 迁移来的，理论上应该已经是"已发布并接收"的状态，但无法区分。建议：
  - 保持 `in_progress` 不变
  - 或者根据业务规则判断：如果有 `parent_plan` 且 `parent_plan.status == 'published'`，则可能是已接收的个人计划
  - **建议**：保持现状，不强制迁移，由后续业务逻辑触发状态转换

---

### 3.3 plan_type → level 映射规则

| 旧 plan_type | 新 level | 说明 |
|--------------|----------|------|
| `company` | `company` | 公司计划 |
| `personal` | `personal` | 个人计划 |
| `department` | `company` | 部门计划归为公司计划 |
| `project` | `company` | 项目计划归为公司计划 |

---

## 四、受影响文件清单

### 4.1 模型文件
- `backend/apps/plan_management/models.py`
  - StrategicGoal 模型
  - Plan 模型
  - GoalStatusLog 模型
  - PlanStatusLog 模型

### 4.2 视图文件
- `backend/apps/plan_management/views.py`
  - StrategicGoalViewSet
  - PlanViewSet
  - 状态过滤逻辑（多处使用 `status__in=['pending', 'in_progress']`）

- `backend/apps/plan_management/views_pages.py`
  - `plan_management_home()`：统计卡片（使用 `status='draft'`, `status='in_progress'` 等）
  - `plan_list()`：列表页筛选（使用 `plan_type` 和 `status`）
  - `goal_list()`：目标列表页（使用 `status`）
  - `plan_detail()`：计划详情页（状态判断）
  - `goal_detail()`：目标详情页（状态判断）
  - 多处状态判断逻辑

- `backend/apps/plan_management/views_dashboard.py`
  - 使用 `status="overdue"`、`status="pending_approval"`（需要检查是否存在）

### 4.3 表单文件
- `backend/apps/plan_management/forms.py`
  - `PlanForm`：使用 `plan_type` 字段
  - `StrategicGoalForm`：状态字段

### 4.4 序列化器文件
- `backend/apps/plan_management/serializers.py`
  - `PlanSerializer`：字段序列化
  - `StrategicGoalSerializer`：字段序列化

### 4.5 服务层文件
- `backend/apps/plan_management/services/plan_decisions.py`
  - 状态转换逻辑（使用 `status` 判断）
  - 多处使用 `status__in=['pending', 'in_progress']`

### 4.6 过滤器文件
- `backend/apps/plan_management/filters.py`
  - 使用 `status__in=['draft', 'in_progress']`

### 4.7 管理命令
- `backend/apps/plan_management/management/commands/detect_plan_inactivity.py`
  - 使用 `status__in=['draft', 'in_progress']`

- `backend/apps/plan_management/management/commands/create_test_plans.py`
  - 使用 `plan_type` 字段

### 4.8 模板文件（需要检查）
- 模板文件路径未知，需要进一步检索

---

## 五、状态使用统计

### 5.1 代码中状态使用情况

#### StrategicGoal 状态使用：
- `draft`：多处使用（列表筛选、统计、详情页判断）
- `published`：多处使用（列表筛选、统计、详情页判断）
- `in_progress`：多处使用（列表筛选、统计、详情页判断）
- `completed`：多处使用（列表筛选、统计）
- `cancelled`：多处使用（列表筛选、统计）

#### Plan 状态使用：
- `draft`：多处使用（列表筛选、统计、详情页判断、审批逻辑）
- `in_progress`：**大量使用**（列表筛选、统计、详情页判断、进度更新、审批逻辑）
- `completed`：多处使用（列表筛选、统计）
- `cancelled`：多处使用（列表筛选、统计、审批逻辑）

#### 历史状态（已迁移，但代码中可能仍有引用）：
- `pending_approval`：views_dashboard.py 中仍有使用（需要检查）
- `pending`：views.py 中多处使用 `status__in=['pending', 'in_progress']`（需要确认是否为 Plan 状态）

---

## 六、字段冲突分析

### 6.1 无冲突字段（可直接使用）
- `parent_goal` / `parent_plan`：已存在，符合统一规范
- `responsible_person`：已存在，保留（与 `owner` 并存）

### 6.2 需要迁移的字段
- `plan_type` → `level`：需要数据迁移

### 6.3 需要新增的字段
- `owner`：StrategicGoal 和 Plan 都需要新增
- `level`：StrategicGoal 需要新增，Plan 需要从 `plan_type` 迁移
- `published_at`、`accepted_at`、`completed_at`：两个模型都需要新增

---

## 七、风险点识别

### 7.1 高风险点
1. **views_dashboard.py**：使用 `status="overdue"` 和 `status="pending_approval"`，**这些状态在 Plan 模型中不存在**（需要修复）
   - `status="overdue"`：Plan 模型中没有此状态，应该通过 `end_time < now` 和 `status != 'completed'` 来判断
   - `status="pending_approval"`：Plan 模型中没有此状态，已迁移到 `draft`（0003）
2. **views.py**：多处使用 `status__in=['pending', 'in_progress']`，`pending` 状态可能不存在于 Plan 模型（需要确认）
3. **plan_type 字段**：大量代码使用 `plan_type`，迁移到 `level` 需要全面更新

### 7.2 中风险点
1. **状态转换逻辑**：`services/plan_decisions.py` 中的状态转换逻辑需要适配新状态机
2. **统计卡片**：首页统计卡片需要适配新状态
3. **列表页筛选**：需要更新筛选逻辑

### 7.3 低风险点
1. **模板文件**：需要检查模板中的状态显示
2. **测试代码**：需要更新测试用例

---

## 八、异常数据清单

### 8.1 需要检查的数据
1. **Plan 模型**：
   - 是否存在 `status='pending'` 的记录？（views.py 中使用，需要确认）
   - **不存在** `status='overdue'` 的记录（views_dashboard.py 中错误使用，需要修复）
   - **不存在** `status='pending_approval'` 的记录（已迁移到 `draft`，views_dashboard.py 中错误使用）
   - `plan_type` 字段的值分布

2. **StrategicGoal 模型**：
   - 不存在 `status='pending_approval'` 的记录（已迁移到 `draft`，0018）

### 8.2 代码错误（需要修复）
1. **views_dashboard.py**：
   - 第 90 行：`status="overdue"` → 应改为：`end_time__lt=now, status__in=['draft', 'in_progress', 'published', 'accepted']`
   - 第 91 行：`status="pending_approval"` → 应改为：`status="draft"`（或使用 PlanDecision 判断）
   - 第 95 行：`status="overdue"` → 同上
   - 第 126 行：`status="pending_approval"` → 应改为：`status="draft"` 或使用 PlanDecision 判断

### 8.2 处理建议
1. 运行数据检查脚本，统计各状态数量
2. 对于异常状态，制定映射规则
3. 对于无法映射的状态，记录到异常清单，人工处理

---

## 九、下一步行动

1. ✅ **基线检查完成**（本文档）
2. ⏳ **模型改造**：新增字段，保留旧字段，兼容处理
3. ⏳ **数据迁移**：生成迁移文件，执行数据迁移
4. ⏳ **代码适配**：更新所有使用旧字段/旧状态的代码
5. ⏳ **回归测试**：验证列表页、统计卡片、创建、发布等功能

---

## 十、检查清单总结

| 检查项 | 状态 | 说明 |
|--------|------|------|
| StrategicGoal 字段清单 | ✅ | 已列出所有字段 |
| Plan 字段清单 | ✅ | 已列出所有字段 |
| 状态枚举清单 | ✅ | 已列出当前和历史状态 |
| 状态映射规则 | ✅ | 已制定映射规则 |
| 受影响文件清单 | ✅ | 已列出主要文件 |
| 字段冲突分析 | ✅ | 已识别冲突点 |
| 风险点识别 | ✅ | 已识别高/中/低风险 |
| 异常数据检查 | ⏳ | 需要运行数据检查脚本 |

---

**检查完成时间**：2025-01-XX  
**检查人**：AI Assistant  
**下一步**：等待确认后开始模型改造

