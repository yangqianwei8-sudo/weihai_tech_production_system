# 计划管理流程调整方案

## 一、目标管理

### （一）目标创建的系统动作
**需求：** 每个自然季度起始月的1日9点，系统自动生成一条目标创建的待办事项，并通知总经理，截止时间为10日9点。逾期未完成的，标为逾期。

**实现方案：**
1. 创建定时任务：`create_quarterly_goal_creation_todo`
   - 触发时间：每季度1日 09:00（1月1日、4月1日、7月1日、10月1日）
   - 创建待办事项（Todo），类型为 `goal_creation`
   - 通知对象：总经理（通过角色或权限识别）
   - 截止时间：当月10日 09:00
   - 逾期检查：每天检查，如果超过截止时间且状态未完成，标记为逾期

**技术实现：**
- 新增 Todo 模型，字段包括：type, title, description, assignee, deadline, status, is_overdue
- 新增 Celery 定时任务或 Django management command
- 新增通知函数：`notify_general_manager_goal_creation`

### （二）目标分解的系统动作
**需求：** 目标状态变更为发布后，系统自动通知员工，系统自动为每位员工生成一条目标分解的待办事项，截止时间为自然季度起始月10日9点。逾期未完成的，标为逾期。

**实现方案：**
1. 监听目标状态变更信号（post_save signal）
2. 当目标状态变为 `published` 时：
   - 通知所有员工（或根据业务规则筛选）
   - 为每位员工创建待办事项，类型为 `goal_decomposition`
   - 截止时间：当前季度起始月10日 09:00
   - 逾期检查：每天检查，如果超过截止时间且状态未完成，标记为逾期

**技术实现：**
- 使用 Django signals：`post_save` 监听 `StrategicGoal.status` 变更
- 新增通知函数：`notify_employees_goal_decomposition`
- 批量创建待办事项

### （三）目标跟踪的系统动作
**需求：**
1. 每周一上午10点，系统自动生成一条目标进度更新待办事项，并提醒员工，截止时间为下午五点。逾期未更新的，标为逾期。
2. 目标进度更新后，系统自动通知其上级查阅。

**实现方案：**
1. 创建定时任务：`create_weekly_goal_tracking_todo`
   - 触发时间：每周一 10:00
   - 为每个有进行中目标的员工创建待办事项，类型为 `goal_progress_update`
   - 截止时间：当天 17:00
   - 逾期检查：每天检查，如果超过截止时间且状态未完成，标记为逾期

2. 监听目标进度更新信号
   - 当 `GoalProgressRecord` 创建时，通知上级（responsible_person 的上级）

**技术实现：**
- 新增 Celery 定时任务：每周一 10:00
- 新增信号监听：`post_save` 监听 `GoalProgressRecord`
- 新增通知函数：`notify_supervisor_goal_progress_updated`

## 二、计划管理

### （一）计划创建的系统动作
**需求：**
1. 每月20日上午10点，系统自动生成一条月度公司计划创建的待办事项，并通知总经理。截止时间为每月23日下午5点，逾期标记为逾期。
2. 公司计划发布后，系统自动为每位员工生成一条月度个人计划创建的待办事项，并通知每个员工。截止日期为每月27日下午五点，逾期标记为逾期。
3. 计划创建提交审批，状态变更为已接收后，系统自动将本月计划出现在"本月待办"列表中。

**实现方案：**
1. 创建定时任务：`create_monthly_company_plan_creation_todo`
   - 触发时间：每月20日 10:00
   - 创建待办事项，类型为 `company_plan_creation`
   - 通知对象：总经理
   - 截止时间：当月23日 17:00

2. 监听计划状态变更信号
   - 当公司计划状态变为 `published` 时：
     - 通知所有员工
     - 为每位员工创建待办事项，类型为 `personal_plan_creation`
     - 截止时间：当月27日 17:00

3. 监听计划状态变更信号
   - 当计划状态变为 `accepted` 时：
     - 自动添加到"本月待办"列表（通过 todo_service 查询逻辑实现）

**技术实现：**
- 新增 Celery 定时任务：每月20日 10:00
- 使用 Django signals：`post_save` 监听 `Plan.status` 变更
- 扩展 `todo_service.py`，新增"本月待办"查询逻辑

### （二）计划分解的系统动作
**需求：**
1. 每周五上午9点，系统为每位员工生成一条计划分解（周计划）的待办事项，并通知员工。截止时间为每周五下午六点，逾期标记为逾期。
2. 员工将个人分解计划提交审批，状态变更为已接收后，系统自动将本周计划任务出现在"本周待办"列表中。
3. 每天下午五点，系统为每名员工生成一条计划分解（明日计划）的待办事项，并通知员工。截止时间为上午18点，逾期标记为逾期。
4. 系统自动将日计划工作作务出现在"今日待办"列表中。

**实现方案：**
1. 创建定时任务：`create_weekly_plan_decomposition_todo`
   - 触发时间：每周五 09:00
   - 为每位员工创建待办事项，类型为 `weekly_plan_decomposition`
   - 截止时间：当天 18:00

2. 监听计划状态变更信号
   - 当周计划状态变为 `accepted` 时：
     - 自动添加到"本周待办"列表

3. 创建定时任务：`create_daily_plan_decomposition_todo`
   - 触发时间：每天 17:00
   - 为每位员工创建待办事项，类型为 `daily_plan_decomposition`
   - 截止时间：次日 18:00（注意：需求中写的是"上午18点"，应该是次日18:00）

4. 自动添加到"今日待办"列表
   - 通过 `todo_service.py` 查询逻辑实现，筛选 `plan_period='daily'` 且状态为 `accepted` 或 `in_progress` 的计划

**技术实现：**
- 新增 Celery 定时任务：每周五 09:00、每天 17:00
- 扩展 `todo_service.py`，新增"本周待办"和"今日待办"查询逻辑

### （三）计划跟踪的系统动作
**需求：**
1. 系统每天下午5点，系统自动通知员工，更新计划进度，截止时间为下午6点，逾期标记为逾期。
2. 计划进度更新后，自动通知其上级查阅。

**实现方案：**
1. 创建定时任务：`create_daily_plan_tracking_todo`
   - 触发时间：每天 17:00
   - 为每个有进行中计划的员工创建待办事项，类型为 `plan_progress_update`
   - 截止时间：当天 18:00

2. 监听计划进度更新信号
   - 当 `PlanProgressRecord` 创建时，通知上级（responsible_person 的上级）

**技术实现：**
- 新增 Celery 定时任务：每天 17:00
- 新增信号监听：`post_save` 监听 `PlanProgressRecord`
- 新增通知函数：`notify_supervisor_plan_progress_updated`

## 三、计划状态流转

**需求：**
1. 员工提交计划，系统自动标记为草稿；
2. 审批完成后，系统自动通知员工，系统自动标记为已确认；
3. 员工启动任务或计划开始时间后，系统自动标记为执行中。若系统时间到达任务的"计划开始日期"的上午9点时，若任务仍处于"已确认"状态，则自动变更为"执行中"；
4. 员工结束任务后，自动标记为已完成；
5. 若任务在截止日未完成，自动延期并标记为"逾期"，同时自动通知员工及其上级。

**实现方案：**
1. 提交计划时，状态自动设置为 `draft`（已在模型中实现）

2. 审批完成后（通过 `PlanDecision` 审批通过）：
   - 状态自动变更为 `accepted`（已确认）
   - 通知员工

3. 自动变更为执行中：
   - 创建定时任务：`auto_start_plans`
   - 触发时间：每天 09:00
   - 检查所有状态为 `accepted` 且 `start_time` 已到的计划，自动变更为 `in_progress`

4. 员工结束任务：
   - 通过 API 或界面操作，状态变更为 `completed`

5. 自动标记逾期：
   - 创建定时任务：`check_overdue_plans`
   - 触发时间：每天 09:00
   - 检查所有状态为 `in_progress` 且 `end_time` 已过的计划：
     - 状态变更为 `overdue`（需要扩展状态选项）或保持 `in_progress` 但标记 `is_overdue=True`
     - 通知员工和上级

**技术实现：**
- 扩展 `Plan` 模型状态选项，或使用 `is_overdue` 字段标记
- 新增 Celery 定时任务：每天 09:00
- 使用 Django signals 监听审批完成事件

## 四、工作总结

**需求：**
1. 每周一上午9点：系统自动汇总员工上周目标更新进度、周计划任务完成情况，生成每周简报，一键发送给员工及其上级。
2. 每月1日上午9点：系统自动汇总员工上月目标更新进度、月度计划完成情况，生成每月简报，一键发送给员工及其上级。

**实现方案：**
1. 创建定时任务：`generate_weekly_summary`
   - 触发时间：每周一 09:00
   - 汇总逻辑：
     - 上周目标进度更新记录
     - 上周周计划完成情况
   - 生成简报（HTML 或文本格式）
   - 发送给员工及其上级

2. 创建定时任务：`generate_monthly_summary`
   - 触发时间：每月1日 09:00
   - 汇总逻辑：
     - 上月目标进度更新记录
     - 上月月度计划完成情况
   - 生成简报
   - 发送给员工及其上级

**技术实现：**
- 新增 Celery 定时任务：每周一 09:00、每月1日 09:00
- 新增服务函数：`generate_weekly_summary_report`、`generate_monthly_summary_report`
- 使用邮件或站内通知发送简报

## 五、每日通知（上午9点推送）

**需求：**
1. 昨日战报：自动列出昨天已完成的工作任务，以及提前多天完成，对员工的出色表现给予肯定。
2. 今日战场：列出所有截止到今天，状态未完成的任务。高亮显示已逾期任务。
3. 风险预警：
   - "您有[X]个目标进度已滞后，点击查看。"
   - "您有[Y]个任务即将在三天内到期。"
   - "您负责的[项目A]关键路径任务已被阻塞[Z]天，需立即关注。"
   - 上级关注："您的下属[张三]有[3]项任务已逾期，请跟进。"

**实现方案：**
1. 创建定时任务：`send_daily_notification`
   - 触发时间：每天 09:00
   - 为每位员工生成个性化通知

2. 昨日战报：
   - 查询昨天完成的任务（`Plan` 状态为 `completed` 且 `completed_at` 在昨天）
   - 查询提前完成的任务（`completed_at` < `end_time` 且提前天数 > 0）
   - 生成表扬文案

3. 今日战场：
   - 查询所有截止到今天且状态未完成的任务
   - 高亮显示已逾期任务（`is_overdue=True` 或 `end_time` < 今天）

4. 风险预警：
   - 目标进度滞后：查询目标进度更新记录，如果最近一次更新超过7天，标记为滞后
   - 即将到期任务：查询 `end_time` 在未来3天内的任务
   - 项目阻塞任务：需要关联项目管理系统（可选实现）
   - 下属逾期任务：查询下属的逾期任务（需要建立上下级关系）

**技术实现：**
- 新增 Celery 定时任务：每天 09:00
- 新增服务函数：`generate_daily_notification_content`
- 扩展通知系统，支持富文本通知

## 六、技术实现清单

### 6.1 数据模型
- [ ] 创建 `Todo` 模型（待办事项）
- [ ] 扩展 `Plan` 模型，添加 `is_overdue` 字段（如果不存在）
- [ ] 扩展 `StrategicGoal` 模型，添加 `is_overdue` 字段（如果不存在）

### 6.2 定时任务
- [ ] 季度目标创建待办：每季度1日 09:00
- [ ] 周目标跟踪待办：每周一 10:00
- [ ] 月度计划创建待办：每月20日 10:00
- [ ] 周计划分解待办：每周五 09:00
- [ ] 日计划分解待办：每天 17:00
- [ ] 计划跟踪待办：每天 17:00
- [ ] 自动启动计划：每天 09:00
- [ ] 检查逾期计划：每天 09:00
- [ ] 生成周报：每周一 09:00
- [ ] 生成月报：每月1日 09:00
- [ ] 每日通知：每天 09:00

### 6.3 信号监听
- [ ] 目标状态变更信号（目标发布后通知员工）
- [ ] 计划状态变更信号（计划发布后通知员工、计划接收后添加到待办列表）
- [ ] 目标进度更新信号（通知上级）
- [ ] 计划进度更新信号（通知上级）

### 6.4 服务函数
- [ ] `todo_service.py` 扩展：本月待办、本周待办、今日待办
- [ ] `notifications.py` 扩展：新增各种通知场景
- [ ] `summary_service.py` 新建：周报和月报生成
- [ ] `daily_notification_service.py` 新建：每日通知生成

### 6.5 配置
- [ ] 配置 Celery beat 定时任务
- [ ] 配置总经理角色识别逻辑
- [ ] 配置上下级关系查询逻辑

## 七、实施步骤

### 第一阶段：基础模型和待办系统
1. 创建 `Todo` 模型
2. 实现待办事项的 CRUD 操作
3. 扩展 `todo_service.py`，支持新的待办类型

### 第二阶段：定时任务系统
1. 配置 Celery beat
2. 实现所有定时任务
3. 测试定时任务触发

### 第三阶段：信号监听和自动流转
1. 实现所有信号监听
2. 实现状态自动流转逻辑
3. 测试状态流转

### 第四阶段：通知系统
1. 扩展通知系统
2. 实现所有通知场景
3. 测试通知发送

### 第五阶段：工作总结和每日通知
1. 实现周报和月报生成
2. 实现每日通知生成
3. 测试报告和通知内容

### 第六阶段：测试和优化
1. 端到端测试
2. 性能优化
3. 错误处理完善
