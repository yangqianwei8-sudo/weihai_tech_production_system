{% extends 'base.html' %}

{% block title %}生产统计分析{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root {
        --brand-primary: #142F5B;
        --brand-accent: #1F3E7C;
        --brand-light: #E7EEF8;
        --brand-soft: #F3F6FB;
        --brand-danger: #D62828;
    }

    .stats-shell {
        background: #fff;
        border-radius: 20px;
        padding: 28px 32px;
        box-shadow: 0 18px 40px rgba(20, 47, 91, 0.12);
    }

    .summary-card {
        background: var(--brand-soft);
        border-radius: 16px;
        padding: 18px 20px;
        border: 1px solid rgba(20, 47, 91, 0.08);
        height: 100%;
    }

    .summary-label {
        font-size: 13px;
        font-weight: 600;
        color: rgba(20, 47, 91, 0.65);
        text-transform: uppercase;
        margin-bottom: 6px;
    }

    .summary-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--brand-primary);
    }

    .chart-card {
        background: #fff;
        border-radius: 18px;
        padding: 20px 24px;
        border: 1px solid rgba(20, 47, 91, 0.08);
        box-shadow: 0 12px 28px rgba(20, 47, 91, 0.08);
        height: 100%;
    }

    .chart-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--brand-primary);
        margin-bottom: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="stats-shell">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
            <div>
                <div class="badge bg-primary-subtle text-primary fw-semibold px-3 py-1 mb-2">Production Insight</div>
                <h1 class="h4 mb-1" style="color:var(--brand-primary);">生产统计分析</h1>
                <p class="text-muted mb-0">聚焦意见审核效率与节省成果，追踪越期风险和响应表现。</p>
            </div>
            <form method="get" class="d-flex flex-column flex-md-row align-items-md-center gap-2">
                <div class="d-flex align-items-center gap-2">
                    <label for="projectSelect" class="text-muted small mb-0">选择视图</label>
                    <select id="projectSelect" name="project" class="form-select" onchange="this.form.submit()">
                        {% for option in project_options %}
                        <option value="{{ option.value }}" {% if option.value == selected_project_value %}selected{% endif %}>
                            {{ option.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="btn-group">
                    <button type="submit" name="export" value="csv" class="btn btn-outline-primary btn-sm">
                        导出 CSV
                    </button>
                    <button type="submit" name="export" value="json" class="btn btn-outline-secondary btn-sm">
                        导出 JSON
                    </button>
                </div>
            </form>
        </div>

        <div class="row g-3 mb-4">
            {% for card in summary_cards %}
            <div class="col-md-3">
                <div class="summary-card h-100">
                    <div class="summary-label">{{ card.label }}</div>
                    <div class="summary-value">{{ card.value }}</div>
                    <div class="text-muted small">{{ card.hint }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if not has_data %}
        <div class="alert alert-info">
            暂无统计快照数据，请先提交意见并执行 <code>python manage.py capture_opinion_stats</code> 生成快照。
        </div>
        {% else %}
        <div class="row g-3 mb-4">
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-title">待审核 / 超期趋势</div>
                    <canvas id="pendingTrendChart" height="210"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-title">累计节省金额趋势</div>
                    <canvas id="savingTrendChart" height="210"></canvas>
                </div>
            </div>
        </div>
        <div class="row g-3 mb-4">
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-title">平均结案耗时（小时）</div>
                    <canvas id="cycleTrendChart" height="210"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-title">平均首响耗时（小时）</div>
                    <canvas id="responseTrendChart" height="210"></canvas>
                </div>
            </div>
        </div>
        <div class="row g-3 mb-4">
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-title">质量提醒趋势</div>
                    <canvas id="reminderTrendChart" height="210"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-title">SLA 达成率</div>
                    <canvas id="slaComplianceChart" height="210"></canvas>
                </div>
            </div>
        </div>
        <div class="row g-3 mb-4">
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-light fw-semibold">
                        审核结果概览
                    </div>
                    <div class="card-body">
                        <p class="mb-1 text-muted small">统计维度：最新快照</p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>已审核总数</span>
                            <span class="fw-semibold">{{ review_summary.total }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-success">通过</span>
                            <span class="fw-semibold">{{ review_summary.approved }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-danger">驳回</span>
                            <span class="fw-semibold">{{ review_summary.rejected }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-warning">待处理</span>
                            <span class="fw-semibold">{{ review_summary.pending }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-light fw-semibold">
                        提醒闭环概览
                    </div>
                    <div class="card-body">
                        <p class="mb-1 text-muted small">统计维度：最近 7 天</p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>待处理提醒</span>
                            <span class="fw-semibold">{{ reminder_summary.pending_total }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>新发提醒</span>
                            <span class="fw-semibold">{{ reminder_summary.sent_last_7_days }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>已确认提醒</span>
                            <span class="fw-semibold">{{ reminder_summary.ack_last_7_days }}</span>
                        </div>
                        <div>
                            <div class="text-muted small mb-1">待处理分类</div>
                            {% if reminder_summary.pending_by_type %}
                                {% for key, value in reminder_summary.pending_by_type.items %}
                                <div class="d-flex justify-content-between align-items-center small">
                                    <span>{{ key|default:"未分类" }}</span>
                                    <span>{{ value }}</span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-muted small">暂无未读提醒。</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
                <span>近期快照</span>
                {% if latest_snapshot %}
                <span class="text-muted small">
                    最新快照日期：{{ latest_snapshot.snapshot_date|date:"Y-m-d" }}
                    {% if latest_snapshot.project %}
                    · 项目 {{ latest_snapshot.project.project_number }}
                    {% endif %}
                </span>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">日期</th>
                                <th scope="col">项目</th>
                                <th scope="col" class="text-end">待审核</th>
                                <th scope="col" class="text-end">超期</th>
                                <th scope="col" class="text-end">节省金额 (¥)</th>
                                <th scope="col" class="text-end">结案耗时 (h)</th>
                                <th scope="col" class="text-end">24h首响达成率</th>
                                <th scope="col" class="text-end">待提醒</th>
                                <th scope="col" class="text-end">审核通过率</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in table_rows %}
                            <tr>
                                <td>{{ row.date|date:"Y-m-d" }}</td>
                                <td>
                                    {% if row.project %}
                                        {{ row.project.project_number }} · {{ row.project.name }}
                                    {% else %}
                                        全局汇总
                                    {% endif %}
                                </td>
                                <td class="text-end">{{ row.pending }}</td>
                                <td class="text-end">{{ row.overdue }}</td>
                                <td class="text-end">{{ row.saving|floatformat:0 }}</td>
                                <td class="text-end">
                                    {% if row.cycle %}
                                        {{ row.cycle|floatformat:1 }}
                                    {% else %}
                                        --
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if row.response_rate is not None %}
                                        {{ row.response_rate|floatformat:1 }}%
                                    {% else %}
                                        --
                                    {% endif %}
                                </td>
                                <td class="text-end">{{ row.alerts }}</td>
                                <td class="text-end">
                                    {% if row.approval_rate is not None %}
                                        {{ row.approval_rate|floatformat:1 }}%
                                    {% else %}
                                        --
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">暂无快照数据。</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{{ chart_payload|json_script:"statistics-chart-data" }}
<script>
    (function() {
        const chartDataEl = document.getElementById('statistics-chart-data');
        if (!chartDataEl) return;
        const chartData = JSON.parse(chartDataEl.textContent || '{}');

        function buildLineChart(ctxId, datasets, options = {}) {
            const ctx = document.getElementById(ctxId);
            if (!ctx) return;
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels || [],
                    datasets,
                },
                options: Object.assign({
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 },
                        },
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#142F5B' },
                        },
                    },
                }, options),
            });
        }

        if ((chartData.pending || []).length) {
            buildLineChart('pendingTrendChart', [
                {
                    label: '待审核',
                    data: chartData.pending || [],
                    borderColor: '#3162B2',
                    backgroundColor: 'rgba(49, 98, 178, 0.12)',
                    tension: 0.35,
                    fill: true,
                },
                {
                    label: '超期',
                    data: chartData.overdue || [],
                    borderColor: '#D62828',
                    backgroundColor: 'rgba(214, 40, 40, 0.15)',
                    tension: 0.35,
                    fill: true,
                },
            ]);
        }

        if ((chartData.saving || []).length) {
            buildLineChart('savingTrendChart', [
                {
                    label: '累计节省金额',
                    data: chartData.saving || [],
                    borderColor: '#1F3E7C',
                    backgroundColor: 'rgba(31, 62, 124, 0.12)',
                    tension: 0.35,
                    fill: true,
                },
            ], {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback(value) {
                                if (value >= 1000000) {
                                    return (value / 10000).toFixed(0) + ' 万';
                                }
                                return value;
                            },
                            color: '#142F5B',
                        },
                    },
                },
            });
        }

        if ((chartData.cycle_hours || []).some((value) => value !== null)) {
            buildLineChart('cycleTrendChart', [
                {
                    label: '结案耗时',
                    data: chartData.cycle_hours || [],
                    borderColor: '#4A7ED1',
                    backgroundColor: 'rgba(74, 126, 209, 0.15)',
                    spanGaps: true,
                    tension: 0.3,
                    fill: true,
                },
            ]);
        }

        if ((chartData.response_hours || []).some((value) => value !== null)) {
            buildLineChart('responseTrendChart', [
                {
                    label: '首响耗时',
                    data: chartData.response_hours || [],
                    borderColor: '#6E9BE4',
                    backgroundColor: 'rgba(110, 155, 228, 0.18)',
                    spanGaps: true,
                    tension: 0.3,
                    fill: true,
                },
            ]);
        }

        if ((chartData.alerts_pending || []).some((value) => value !== null && value !== undefined)) {
            buildLineChart('reminderTrendChart', [
                {
                    label: '待处理提醒',
                    data: chartData.alerts_pending.map((item) => item ?? 0),
                    borderColor: '#F2994A',
                    backgroundColor: 'rgba(242, 153, 74, 0.18)',
                    spanGaps: true,
                    tension: 0.3,
                    fill: true,
                },
            ]);
        }

        if ((chartData.response_rate || []).some((value) => value !== null && value !== undefined)) {
            buildLineChart('slaComplianceChart', [
                {
                    label: '24h 首响达成率',
                    data: (chartData.response_rate || []).map((item) => item ?? null),
                    borderColor: '#27AE60',
                    backgroundColor: 'rgba(39, 174, 96, 0.18)',
                    spanGaps: true,
                    tension: 0.25,
                    fill: false,
                },
                {
                    label: '7天结案达成率',
                    data: (chartData.cycle_rate || []).map((item) => item ?? null),
                    borderColor: '#2F80ED',
                    backgroundColor: 'rgba(47, 128, 237, 0.12)',
                    spanGaps: true,
                    tension: 0.25,
                    fill: false,
                },
            ], {
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: 100,
                        ticks: {
                            callback(value) {
                                return value + '%';
                            },
                        },
                    },
                },
            });
        }
    })();
</script>
{% endblock %}

