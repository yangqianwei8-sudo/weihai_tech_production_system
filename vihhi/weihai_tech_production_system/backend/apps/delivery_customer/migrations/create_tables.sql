-- 收发管理模块数据库表创建脚本
-- 如果Django迁移无法运行，可以直接执行此SQL脚本创建表

BEGIN;

-- 创建交付记录表
CREATE TABLE IF NOT EXISTS "delivery_record" (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "delivery_number" varchar(50) NOT NULL UNIQUE,
    "title" varchar(200) NOT NULL,
    "description" text NOT NULL,
    "delivery_method" varchar(20) NOT NULL,
    "recipient_name" varchar(100) NOT NULL,
    "recipient_phone" varchar(20) NOT NULL,
    "recipient_email" varchar(255) NOT NULL,
    "recipient_address" text NOT NULL,
    "cc_emails" text NOT NULL,
    "bcc_emails" text NOT NULL,
    "email_subject" varchar(500) NOT NULL,
    "email_message" text NOT NULL,
    "use_template" boolean NOT NULL,
    "template_name" varchar(100) NOT NULL,
    "express_company" varchar(100) NOT NULL,
    "express_number" varchar(100) NOT NULL,
    "express_fee" numeric(10, 2) NULL,
    "delivery_notes" text NOT NULL,
    "status" varchar(20) NOT NULL,
    "priority" varchar(20) NOT NULL,
    "scheduled_delivery_time" timestamp with time zone NULL,
    "submitted_at" timestamp with time zone NULL,
    "sent_at" timestamp with time zone NULL,
    "delivered_at" timestamp with time zone NULL,
    "received_at" timestamp with time zone NULL,
    "confirmed_at" timestamp with time zone NULL,
    "archived_at" timestamp with time zone NULL,
    "deadline" timestamp with time zone NULL,
    "created_at" timestamp with time zone NOT NULL,
    "updated_at" timestamp with time zone NOT NULL,
    "error_message" text NOT NULL,
    "retry_count" integer NOT NULL,
    "max_retries" integer NOT NULL,
    "feedback_received" boolean NOT NULL,
    "feedback_content" text NOT NULL,
    "feedback_time" timestamp with time zone NULL,
    "feedback_by" varchar(100) NOT NULL,
    "auto_archive_enabled" boolean NOT NULL,
    "archive_condition" varchar(50) NOT NULL,
    "archive_days" integer NOT NULL,
    "is_overdue" boolean NOT NULL,
    "overdue_days" integer NOT NULL,
    "risk_level" varchar(20) NOT NULL,
    "warning_sent" boolean NOT NULL,
    "warning_times" integer NOT NULL,
    "file_count" integer NOT NULL,
    "total_file_size" bigint NOT NULL,
    "notes" text NOT NULL,
    "client_id" bigint NULL,
    "created_by_id" bigint NULL,
    "delivery_person_id" bigint NULL,
    "project_id" bigint NULL,
    "sent_by_id" bigint NULL
);

-- 创建交付文件表
CREATE TABLE IF NOT EXISTS "delivery_file" (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "file" varchar(500) NOT NULL,
    "file_name" varchar(255) NOT NULL,
    "file_type" varchar(20) NOT NULL,
    "file_size" bigint NOT NULL,
    "file_extension" varchar(20) NOT NULL,
    "mime_type" varchar(100) NOT NULL,
    "description" varchar(500) NOT NULL,
    "version" varchar(50) NOT NULL,
    "uploaded_at" timestamp with time zone NOT NULL,
    "is_deleted" boolean NOT NULL,
    "deleted_at" timestamp with time zone NULL,
    "delivery_record_id" bigint NOT NULL,
    "uploaded_by_id" bigint NULL
);

-- 创建交付反馈表
CREATE TABLE IF NOT EXISTS "delivery_feedback" (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "feedback_type" varchar(20) NOT NULL,
    "content" text NOT NULL,
    "feedback_by" varchar(100) NOT NULL,
    "feedback_email" varchar(254) NOT NULL,
    "feedback_phone" varchar(20) NOT NULL,
    "created_at" timestamp with time zone NOT NULL,
    "is_read" boolean NOT NULL,
    "read_at" timestamp with time zone NULL,
    "delivery_record_id" bigint NOT NULL,
    "read_by_id" bigint NULL
);

-- 创建交付跟踪表
CREATE TABLE IF NOT EXISTS "delivery_tracking" (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "event_type" varchar(20) NOT NULL,
    "event_description" varchar(500) NOT NULL,
    "location" varchar(200) NOT NULL,
    "event_time" timestamp with time zone NOT NULL,
    "notes" text NOT NULL,
    "delivery_record_id" bigint NOT NULL,
    "operator_id" bigint NULL
);

-- 创建索引
CREATE INDEX IF NOT EXISTS "delivery_record_delivery_number_idx" ON "delivery_record" ("delivery_number");
CREATE INDEX IF NOT EXISTS "delivery_record_status_idx" ON "delivery_record" ("status");
CREATE INDEX IF NOT EXISTS "delivery_record_deadline_idx" ON "delivery_record" ("deadline");
CREATE INDEX IF NOT EXISTS "delivery_record_created_at_idx" ON "delivery_record" ("created_at");
CREATE INDEX IF NOT EXISTS "delivery_record_is_overdue_idx" ON "delivery_record" ("is_overdue");
CREATE INDEX IF NOT EXISTS "delivery_record_express_number_idx" ON "delivery_record" ("express_number");
CREATE INDEX IF NOT EXISTS "delivery_re_status_idx" ON "delivery_record" ("status", "created_at" DESC);
CREATE INDEX IF NOT EXISTS "delivery_re_project_idx" ON "delivery_record" ("project_id", "created_at" DESC);
CREATE INDEX IF NOT EXISTS "delivery_re_client_idx" ON "delivery_record" ("client_id", "created_at" DESC);
CREATE INDEX IF NOT EXISTS "delivery_re_is_over_idx" ON "delivery_record" ("is_overdue", "risk_level");
CREATE INDEX IF NOT EXISTS "delivery_re_deliver_idx" ON "delivery_record" ("delivery_number");
CREATE INDEX IF NOT EXISTS "delivery_re_deadlin_idx" ON "delivery_record" ("deadline");

CREATE INDEX IF NOT EXISTS "delivery_file_delivery_record_idx" ON "delivery_file" ("delivery_record_id");
CREATE INDEX IF NOT EXISTS "delivery_file_uploaded_at_idx" ON "delivery_file" ("uploaded_at");
CREATE INDEX IF NOT EXISTS "delivery_fi_deliver_idx" ON "delivery_file" ("delivery_record_id", "uploaded_at");

CREATE INDEX IF NOT EXISTS "delivery_feedback_delivery_record_idx" ON "delivery_feedback" ("delivery_record_id");
CREATE INDEX IF NOT EXISTS "delivery_feedback_created_at_idx" ON "delivery_feedback" ("created_at");
CREATE INDEX IF NOT EXISTS "delivery_fe_deliver_idx" ON "delivery_feedback" ("delivery_record_id", "created_at" DESC);

CREATE INDEX IF NOT EXISTS "delivery_tracking_delivery_record_idx" ON "delivery_tracking" ("delivery_record_id");
CREATE INDEX IF NOT EXISTS "delivery_tracking_event_time_idx" ON "delivery_tracking" ("event_time");
CREATE INDEX IF NOT EXISTS "delivery_tr_deliver_idx" ON "delivery_tracking" ("delivery_record_id", "event_time" DESC);

-- 创建外键约束（如果关联表存在）
-- 注意：如果关联表不存在，这些外键约束会失败，可以注释掉或稍后添加

-- ALTER TABLE "delivery_record" ADD CONSTRAINT "delivery_record_client_id_fk" 
--     FOREIGN KEY ("client_id") REFERENCES "customer_client" ("id") DEFERRABLE INITIALLY DEFERRED;
-- ALTER TABLE "delivery_record" ADD CONSTRAINT "delivery_record_created_by_id_fk" 
--     FOREIGN KEY ("created_by_id") REFERENCES "system_user" ("id") DEFERRABLE INITIALLY DEFERRED;
-- ALTER TABLE "delivery_record" ADD CONSTRAINT "delivery_record_delivery_person_id_fk" 
--     FOREIGN KEY ("delivery_person_id") REFERENCES "system_user" ("id") DEFERRABLE INITIALLY DEFERRED;
-- ALTER TABLE "delivery_record" ADD CONSTRAINT "delivery_record_project_id_fk" 
--     FOREIGN KEY ("project_id") REFERENCES "project_center_project" ("id") DEFERRABLE INITIALLY DEFERRED;
-- ALTER TABLE "delivery_record" ADD CONSTRAINT "delivery_record_sent_by_id_fk" 
--     FOREIGN KEY ("sent_by_id") REFERENCES "system_user" ("id") DEFERRABLE INITIALLY DEFERRED;

-- ALTER TABLE "delivery_file" ADD CONSTRAINT "delivery_file_delivery_record_id_fk" 
--     FOREIGN KEY ("delivery_record_id") REFERENCES "delivery_record" ("id") DEFERRABLE INITIALLY DEFERRED;
-- ALTER TABLE "delivery_file" ADD CONSTRAINT "delivery_file_uploaded_by_id_fk" 
--     FOREIGN KEY ("uploaded_by_id") REFERENCES "system_user" ("id") DEFERRABLE INITIALLY DEFERRED;

-- ALTER TABLE "delivery_feedback" ADD CONSTRAINT "delivery_feedback_delivery_record_id_fk" 
--     FOREIGN KEY ("delivery_record_id") REFERENCES "delivery_record" ("id") DEFERRABLE INITIALLY DEFERRED;
-- ALTER TABLE "delivery_feedback" ADD CONSTRAINT "delivery_feedback_read_by_id_fk" 
--     FOREIGN KEY ("read_by_id") REFERENCES "system_user" ("id") DEFERRABLE INITIALLY DEFERRED;

-- ALTER TABLE "delivery_tracking" ADD CONSTRAINT "delivery_tracking_delivery_record_id_fk" 
--     FOREIGN KEY ("delivery_record_id") REFERENCES "delivery_record" ("id") DEFERRABLE INITIALLY DEFERRED;
-- ALTER TABLE "delivery_tracking" ADD CONSTRAINT "delivery_tracking_operator_id_fk" 
--     FOREIGN KEY ("operator_id") REFERENCES "system_user" ("id") DEFERRABLE INITIALLY DEFERRED;

COMMIT;

