-- 创建缺失的表：IncomingDocument, OutgoingDocument, ExpressCompany, DeliveryApproval
-- 这些表在迁移 0003 中定义，但可能没有运行

BEGIN;

-- 创建收文表 (IncomingDocument)
CREATE TABLE IF NOT EXISTS "incoming_document" (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "document_number" varchar(50) NOT NULL UNIQUE,
    "title" varchar(200) NOT NULL,
    "sender" varchar(200) NOT NULL,
    "sender_contact" varchar(100) NOT NULL DEFAULT '',
    "sender_phone" varchar(20) NOT NULL DEFAULT '',
    "document_date" date NULL,
    "receive_date" date NULL,
    "document_type" varchar(50) NOT NULL DEFAULT '',
    "content" text NOT NULL DEFAULT '',
    "summary" text NOT NULL DEFAULT '',
    "status" varchar(20) NOT NULL DEFAULT 'draft',
    "priority" varchar(20) NOT NULL DEFAULT 'normal',
    "handle_notes" text NOT NULL DEFAULT '',
    "completed_at" timestamp with time zone NULL,
    "attachment" varchar(100) NULL,
    "notes" text NOT NULL DEFAULT '',
    "created_at" timestamp with time zone NOT NULL,
    "updated_at" timestamp with time zone NOT NULL,
    "created_by_id" bigint NULL,
    "handler_id" bigint NULL
);

CREATE INDEX IF NOT EXISTS "incoming_do_status_bd66cf_idx" ON "incoming_document" ("status", "receive_date" DESC);
CREATE INDEX IF NOT EXISTS "incoming_do_handler_6dfeec_idx" ON "incoming_document" ("handler_id", "created_at" DESC);
CREATE INDEX IF NOT EXISTS "incoming_document_document_number_idx" ON "incoming_document" ("document_number");

-- 创建发文表 (OutgoingDocument)
CREATE TABLE IF NOT EXISTS "outgoing_document" (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "document_number" varchar(50) NOT NULL UNIQUE,
    "title" varchar(200) NOT NULL,
    "recipient" varchar(200) NOT NULL,
    "recipient_contact" varchar(100) NOT NULL DEFAULT '',
    "recipient_phone" varchar(20) NOT NULL DEFAULT '',
    "recipient_address" text NOT NULL DEFAULT '',
    "document_date" date NULL,
    "send_date" date NULL,
    "document_type" varchar(50) NOT NULL DEFAULT '',
    "content" text NOT NULL DEFAULT '',
    "summary" text NOT NULL DEFAULT '',
    "status" varchar(20) NOT NULL DEFAULT 'draft',
    "priority" varchar(20) NOT NULL DEFAULT 'normal',
    "review_notes" text NOT NULL DEFAULT '',
    "reviewed_at" timestamp with time zone NULL,
    "send_method" varchar(50) NOT NULL DEFAULT '',
    "sent_at" timestamp with time zone NULL,
    "attachment" varchar(100) NULL,
    "notes" text NOT NULL DEFAULT '',
    "created_at" timestamp with time zone NOT NULL,
    "updated_at" timestamp with time zone NOT NULL,
    "created_by_id" bigint NULL,
    "reviewer_id" bigint NULL,
    "sender_id" bigint NULL
);

CREATE INDEX IF NOT EXISTS "outgoing_do_status_eb633a_idx" ON "outgoing_document" ("status", "send_date" DESC);
CREATE INDEX IF NOT EXISTS "outgoing_do_reviewe_34eaba_idx" ON "outgoing_document" ("reviewer_id", "created_at" DESC);
CREATE INDEX IF NOT EXISTS "outgoing_document_document_number_idx" ON "outgoing_document" ("document_number");

-- 创建快递公司表 (ExpressCompany)
CREATE TABLE IF NOT EXISTS "express_company" (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "name" varchar(100) NOT NULL UNIQUE,
    "code" varchar(50) NOT NULL DEFAULT '',
    "alias" varchar(200) NOT NULL DEFAULT '',
    "contact_phone" varchar(20) NOT NULL DEFAULT '',
    "contact_email" varchar(255) NOT NULL DEFAULT '',
    "website" varchar(255) NOT NULL DEFAULT '',
    "is_active" boolean NOT NULL DEFAULT true,
    "is_default" boolean NOT NULL DEFAULT false,
    "sort_order" integer NOT NULL DEFAULT 0,
    "notes" text NOT NULL DEFAULT '',
    "created_at" timestamp with time zone NOT NULL,
    "updated_at" timestamp with time zone NOT NULL,
    "created_by_id" bigint NULL
);

CREATE INDEX IF NOT EXISTS "express_com_is_acti_bc9bb7_idx" ON "express_company" ("is_active", "sort_order");
CREATE INDEX IF NOT EXISTS "express_com_is_defa_b13d38_idx" ON "express_company" ("is_default", "created_at" DESC);
CREATE INDEX IF NOT EXISTS "express_company_name_idx" ON "express_company" ("name");

-- 创建交付审核表 (DeliveryApproval)
CREATE TABLE IF NOT EXISTS "delivery_approval" (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "approval_level" integer NOT NULL DEFAULT 1,
    "result" varchar(20) NOT NULL DEFAULT 'pending',
    "comment" text NOT NULL DEFAULT '',
    "approval_time" timestamp with time zone NULL,
    "created_at" timestamp with time zone NOT NULL,
    "approver_id" bigint NULL,
    "delivery_record_id" bigint NOT NULL,
    "transferred_from_id" bigint NULL,
    "transferred_to_id" bigint NULL
);

CREATE INDEX IF NOT EXISTS "delivery_ap_deliver_37615c_idx" ON "delivery_approval" ("delivery_record_id", "created_at" DESC);
CREATE INDEX IF NOT EXISTS "delivery_ap_approve_aedf41_idx" ON "delivery_approval" ("approver_id", "created_at" DESC);
CREATE INDEX IF NOT EXISTS "delivery_ap_result_2c3815_idx" ON "delivery_approval" ("result", "created_at" DESC);

COMMIT;

