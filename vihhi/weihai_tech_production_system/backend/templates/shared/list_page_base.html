{% extends "shared/module_base.html" %}
{% load static %}

{% comment %}
  åˆ—è¡¨é¡µé¢åŸºç¡€æ¨¡æ¿
  æä¾›ç»Ÿä¸€çš„åˆ—è¡¨é¡µé¢ç»“æ„ï¼ŒåŒ…æ‹¬ç»Ÿè®¡å¡ç‰‡ã€ç­›é€‰å™¨ã€è¡¨æ ¼ã€åˆ†é¡µç­‰æ¨¡å—
  ä½¿ç”¨ list-layout.css æ ·å¼ç³»ç»Ÿ
{% endcomment %}

{% block module_styles %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/layouts/list-layout.css' %}">
  <link rel="stylesheet" href="{% static 'css/components/list_page_base_v2.css' %}">
{% endblock module_styles %}

{% block module_scripts %}
  {{ block.super }}
  <script src="{% static 'js/list-checkbox.js' %}"></script>
  <script>
  // å¼ºåˆ¶åˆå§‹åŒ–å¤é€‰æ¡†åŠŸèƒ½ï¼ˆç¡®ä¿åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½èƒ½å·¥ä½œï¼‰
  (function() {
    // æ›´æ–°å…¨é€‰çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
    function updateSelectAllState() {
      const selectAll = document.getElementById('selectAll');
      const rowCheckboxes = document.querySelectorAll('.row-checkbox');
      
      if (!selectAll || rowCheckboxes.length === 0) {
        return;
      }

      const allChecked = rowCheckboxes.length > 0 && Array.from(rowCheckboxes).every(function(cb) {
        return cb.checked;
      });
      const someChecked = Array.from(rowCheckboxes).some(function(cb) {
        return cb.checked;
      });
      
      selectAll.checked = allChecked;
      selectAll.indeterminate = someChecked && !allChecked;
    }
    
    function forceInitCheckboxes() {
      const selectAll = document.getElementById('selectAll');
      const rowCheckboxes = document.querySelectorAll('.row-checkbox');
      
      if (!selectAll || rowCheckboxes.length === 0) {
        return;
      }
      
      // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡
      if (selectAll.dataset.initialized === 'true') {
        return;
      }
      
      // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
      selectAll.dataset.initialized = 'true';
      
      // ç»‘å®šå…¨é€‰äº‹ä»¶ - ä½¿ç”¨ change äº‹ä»¶ç¡®ä¿è·å–æ­£ç¡®çš„çŠ¶æ€
      selectAll.addEventListener('change', function(e) {
        e.stopPropagation();
        const checked = this.checked;
        console.log('[å¼ºåˆ¶åˆå§‹åŒ–] å…¨é€‰å¤é€‰æ¡†çŠ¶æ€æ”¹å˜:', checked);
        rowCheckboxes.forEach(function(cb) {
          cb.checked = checked;
        });
        updateSelectAllState();
        if (typeof window.updateSelectedCount === 'function') {
          window.updateSelectedCount();
        }
      });
      
      // ä¹Ÿç»‘å®š click äº‹ä»¶ä½œä¸ºå¤‡ç”¨
      selectAll.addEventListener('click', function(e) {
        e.stopPropagation();
        // æ³¨æ„ï¼šclick äº‹ä»¶è§¦å‘æ—¶ï¼Œchecked çŠ¶æ€è¿˜æ²¡æœ‰æ”¹å˜
        // æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ !this.checked æ¥è·å–æ–°çŠ¶æ€
        setTimeout(function() {
          const checked = selectAll.checked;
          console.log('[å¼ºåˆ¶åˆå§‹åŒ–] å…¨é€‰å¤é€‰æ¡†ç‚¹å‡»åçŠ¶æ€:', checked);
          rowCheckboxes.forEach(function(cb) {
            cb.checked = checked;
          });
          updateSelectAllState();
          if (typeof window.updateSelectedCount === 'function') {
            window.updateSelectedCount();
          }
        }, 0);
      });
      
      // ç»‘å®šè¡Œå¤é€‰æ¡†äº‹ä»¶
      rowCheckboxes.forEach(function(cb) {
        if (cb.dataset.initialized === 'true') {
          return;
        }
        cb.dataset.initialized = 'true';
        
        cb.addEventListener('change', function(e) {
          e.stopPropagation();
          console.log('[å¼ºåˆ¶åˆå§‹åŒ–] è¡Œå¤é€‰æ¡†çŠ¶æ€æ”¹å˜:', this.checked);
          updateSelectAllState();
          if (typeof window.updateSelectedCount === 'function') {
            window.updateSelectedCount();
          }
        });
        
        // ä¹Ÿç»‘å®š click äº‹ä»¶ä½œä¸ºå¤‡ç”¨
        cb.addEventListener('click', function(e) {
          e.stopPropagation();
          setTimeout(function() {
            updateSelectAllState();
            if (typeof window.updateSelectedCount === 'function') {
              window.updateSelectedCount();
            }
          }, 0);
        });
      });
      
      // å¯¼å‡º updateSelectAllState åˆ°å…¨å±€
      window.updateSelectAllState = updateSelectAllState;
    }
    
    // ç«‹å³æ‰§è¡Œ
    forceInitCheckboxes();
    
    // DOMContentLoadedæ—¶æ‰§è¡Œ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', forceInitCheckboxes);
    }
    
    // å»¶è¿Ÿæ‰§è¡Œï¼ˆç¡®ä¿DOMå®Œå…¨æ¸²æŸ“ï¼‰
    setTimeout(forceInitCheckboxes, 100);
    setTimeout(forceInitCheckboxes, 500);
  })();
  </script>
  
  {# æ‰¹é‡åˆ é™¤åŠŸèƒ½ - é»˜è®¤å¯ç”¨ï¼Œæ‰€æœ‰ç»§æ‰¿è¯¥æ¨¡æ¿çš„é¡µé¢éƒ½è‡ªåŠ¨å…·æœ‰ #}
  <script>
  (function() {
    'use strict';
    
    // è·å– CSRF tokenï¼ˆæ”¯æŒå¤šç§æ–¹å¼ï¼‰
    function getCsrfToken() {
      // æ–¹å¼1: ä»è¡¨å•ä¸­çš„éšè— input è·å–
      let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                  document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
      
      // æ–¹å¼2: ä» meta æ ‡ç­¾è·å–
      if (!token) {
        token = document.querySelector('meta[name=csrf-token]')?.content ||
                document.querySelector('meta[name="csrf-token"]')?.content;
      }
      
      // æ–¹å¼3: ä» Cookie è·å–ï¼ˆDjango é»˜è®¤æ–¹å¼ï¼‰
      if (!token) {
        // æ–¹æ³•1: ä½¿ç”¨ split æ–¹å¼
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
        token = getCookie('csrftoken');
      }
      
      // æ–¹å¼4: ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä» cookie ä¸­åŒ¹é…ï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰
      if (!token) {
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        if (match) {
          token = decodeURIComponent(match[1]);
        }
      }
      
      // æ–¹å¼5: ä½¿ç”¨å¦ä¸€ç§ cookie è§£ææ–¹å¼
      if (!token) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; csrftoken=`);
        if (parts.length === 2) {
          token = parts.pop().split(';').shift();
        }
      }
      
      if (!token) {
        console.warn('[æ‰¹é‡åˆ é™¤] æ— æ³•è·å– CSRF tokenï¼Œå°è¯•çš„æ–¹æ³•ï¼š', {
          hasFormInput: !!document.querySelector('[name=csrfmiddlewaretoken]'),
          hasMetaTag: !!document.querySelector('meta[name=csrf-token]'),
          hasCookie: document.cookie.includes('csrftoken')
        });
      }
      
      return token || '';
    }
    
    // æ˜¾ç¤ºæ¶ˆæ¯æç¤ºï¼ˆç®€å•å®ç°ï¼Œå¯ä»¥æ›¿æ¢ä¸ºé¡¹ç›®ä¸­çš„æ¶ˆæ¯æç¤ºç»„ä»¶ï¼‰
    function showMessage(message, type) {
      type = type || 'info';
      // ä½¿ç”¨ alert ä½œä¸ºç®€å•å®ç°ï¼Œå­æ¨¡æ¿å¯ä»¥è¦†ç›–æ­¤å‡½æ•°
      if (typeof window.showNotification === 'function') {
        window.showNotification(message, type);
      } else if (typeof window.showSuccess === 'function' && type === 'success') {
        window.showSuccess(message);
      } else if (typeof window.showError === 'function' && type === 'error') {
        window.showError(message);
      } else {
        alert(message);
      }
    }
    
    // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€ï¼ˆå…¨å±€å‡½æ•°ï¼Œä¾›å…¶ä»–è„šæœ¬è°ƒç”¨ï¼‰
    function updateBatchDeleteButton() {
      const batchDeleteBtn = document.getElementById('batchDeleteBtn');
      if (!batchDeleteBtn) {
        return;
      }
      
      const selectedIds = window.getSelectedIds ? window.getSelectedIds() : [];
      const count = selectedIds.length;
      
      if (count > 0) {
        batchDeleteBtn.style.display = 'inline-block';
        // æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºé€‰ä¸­æ•°é‡
        const icon = batchDeleteBtn.querySelector('i');
        const iconHtml = icon ? icon.outerHTML : '<i class="bi bi-trash"></i>';
        batchDeleteBtn.innerHTML = iconHtml + ' æ‰¹é‡åˆ é™¤ (' + count + ')';
      } else {
        batchDeleteBtn.style.display = 'none';
        batchDeleteBtn.innerHTML = '<i class="bi bi-trash"></i> æ‰¹é‡åˆ é™¤';
      }
    }
    
    // å°†æ›´æ–°å‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä¾›å…¶ä»–è„šæœ¬è°ƒç”¨
    window.updateBatchDeleteButton = updateBatchDeleteButton;
    
    // åˆå§‹åŒ–æ ‡è®°ï¼Œé˜²æ­¢é‡å¤åˆå§‹åŒ–
    let batchDeleteInitialized = false;
    
    // åˆå§‹åŒ–æ‰¹é‡åˆ é™¤åŠŸèƒ½
    function initBatchDelete() {
      const batchDeleteBtn = document.getElementById('batchDeleteBtn');
      if (!batchDeleteBtn) {
        console.warn('[æ‰¹é‡åˆ é™¤] æœªæ‰¾åˆ°æ‰¹é‡åˆ é™¤æŒ‰é’®');
        return;
      }
      
      // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡
      if (batchDeleteInitialized) {
        console.log('[æ‰¹é‡åˆ é™¤] å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
        return;
      }
      
      console.log('[æ‰¹é‡åˆ é™¤] å¼€å§‹åˆå§‹åŒ–æ‰¹é‡åˆ é™¤åŠŸèƒ½');
      batchDeleteInitialized = true;
      
      // å¤é€‰æ¡†é€‰æ‹©å˜åŒ–äº‹ä»¶å¤„ç†å™¨ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
      document.addEventListener('checkboxSelectionChanged', function(e) {
        console.log('[æ‰¹é‡åˆ é™¤] æ”¶åˆ°å¤é€‰æ¡†é€‰æ‹©å˜åŒ–äº‹ä»¶ï¼Œé€‰ä¸­æ•°é‡:', e.detail?.count || 0);
        updateBatchDeleteButton();
      }, true);
      
      // change äº‹ä»¶å¤„ç†å™¨ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
      document.addEventListener('change', function(e) {
        if (e.target && (e.target.classList.contains('row-checkbox') || e.target.id === 'selectAll')) {
          console.log('[æ‰¹é‡åˆ é™¤] æ£€æµ‹åˆ°å¤é€‰æ¡†å˜åŒ–ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€');
          setTimeout(updateBatchDeleteButton, 50);
        }
      }, true);
      
      // click äº‹ä»¶å¤„ç†å™¨ï¼ˆç”¨äºå¤é€‰æ¡†ç‚¹å‡»ï¼Œåªç»‘å®šä¸€æ¬¡ï¼‰
      document.addEventListener('click', function(e) {
        if (e.target && (e.target.classList.contains('row-checkbox') || e.target.id === 'selectAll' || e.target.closest('.row-checkbox') || e.target.closest('#selectAll'))) {
          setTimeout(updateBatchDeleteButton, 100);
        }
      }, true);
      
      // å®šæœŸæ£€æŸ¥é€‰ä¸­çŠ¶æ€ï¼ˆä½œä¸ºæœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼Œåªå¯åŠ¨ä¸€æ¬¡ï¼‰
      setInterval(function() {
        const selectedIds = window.getSelectedIds ? window.getSelectedIds() : [];
        const count = selectedIds.length;
        const btn = document.getElementById('batchDeleteBtn');
        if (btn) {
          const isVisible = btn.style.display !== 'none';
          if (count > 0 && !isVisible) {
            console.log('[æ‰¹é‡åˆ é™¤] å®šæœŸæ£€æŸ¥ï¼šå‘ç°é€‰ä¸­é¡¹ä½†æŒ‰é’®æœªæ˜¾ç¤ºï¼Œæ›´æ–°æŒ‰é’®');
            updateBatchDeleteButton();
          } else if (count === 0 && isVisible) {
            console.log('[æ‰¹é‡åˆ é™¤] å®šæœŸæ£€æŸ¥ï¼šæ— é€‰ä¸­é¡¹ä½†æŒ‰é’®æ˜¾ç¤ºï¼Œéšè—æŒ‰é’®');
            updateBatchDeleteButton();
          }
        }
      }, 1000);
      
      // åˆå§‹çŠ¶æ€æ£€æŸ¥ï¼ˆå¤šæ¬¡æ£€æŸ¥ï¼Œç¡®ä¿èƒ½è·å–åˆ°æ­£ç¡®çš„çŠ¶æ€ï¼‰
      setTimeout(updateBatchDeleteButton, 100);
      setTimeout(updateBatchDeleteButton, 300);
      setTimeout(updateBatchDeleteButton, 600);
      setTimeout(updateBatchDeleteButton, 1000);
      
      // æ‰¹é‡åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼Œé˜²æ­¢é‡å¤ç»‘å®šï¼‰
      // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å·²ç»æœ‰ data-batch-delete-initialized æ ‡è®°
      if (batchDeleteBtn.dataset.batchDeleteInitialized === 'true') {
        console.log('[æ‰¹é‡åˆ é™¤] æŒ‰é’®ç‚¹å‡»äº‹ä»¶å·²ç»‘å®šï¼Œè·³è¿‡');
        return;
      }
      
      // æ ‡è®°æŒ‰é’®å·²åˆå§‹åŒ–
      batchDeleteBtn.dataset.batchDeleteInitialized = 'true';
      
      batchDeleteBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // å¦‚æœæŒ‰é’®å·²è¢«ç¦ç”¨ï¼Œè¯´æ˜æ­£åœ¨å¤„ç†ä¸­ï¼Œç›´æ¥è¿”å›
        if (this.disabled) {
          console.log('[æ‰¹é‡åˆ é™¤] æŒ‰é’®å·²ç¦ç”¨ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
          return false;
        }
        
        // è·å–é€‰ä¸­çš„ID
        const selectedIds = window.getSelectedIds ? window.getSelectedIds() : [];
        
        if (selectedIds.length === 0) {
          showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®', 'warning');
          return false;
        }
        
        // ç¡®è®¤å¯¹è¯æ¡†
        const confirmMessageTemplate = '{% block batch_delete_confirm_message %}ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ {count} ä¸ªé¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼{% endblock %}';
        const confirmMessage = confirmMessageTemplate.replace('{count}', selectedIds.length);
        if (!confirm(confirmMessage)) {
          return false;
        }
        
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        const originalHtml = this.innerHTML;
        this.disabled = true;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> åˆ é™¤ä¸­...';
        
        // ä¿å­˜æŒ‰é’®å¼•ç”¨ï¼ˆç”¨äºåœ¨å›è°ƒä¸­ä½¿ç”¨ï¼‰
        const btn = this;
        
        // è·å–æ‰¹é‡åˆ é™¤URL
        // ä¼˜å…ˆä½¿ç”¨å­æ¨¡æ¿æä¾›çš„ batch_delete_url
        let deleteUrl = '{{ batch_delete_url|default:"" }}';
        
        // å¦‚æœæœªæä¾›URLï¼Œå°è¯•ä»å½“å‰è·¯å¾„è‡ªåŠ¨æ¨æ–­
        if (!deleteUrl || deleteUrl.trim() === '') {
          const currentPath = window.location.pathname;
          
          // å°è¯•å¤šç§å¸¸è§çš„æ‰¹é‡åˆ é™¤URLæ¨¡å¼
          const possibleUrls = [];
          
          // æ¨¡å¼1: å½“å‰è·¯å¾„ + batch-delete/
          if (currentPath.endsWith('/')) {
            possibleUrls.push(currentPath + 'batch-delete/');
          } else {
            possibleUrls.push(currentPath + '/batch-delete/');
          }
          
          // æ¨¡å¼2: ç§»é™¤æœ€åçš„è·¯å¾„æ®µï¼Œæ·»åŠ  batch-delete/
          const pathParts = currentPath.split('/').filter(p => p);
          if (pathParts.length > 0) {
            pathParts.pop(); // ç§»é™¤æœ€åä¸€ä¸ªè·¯å¾„æ®µ
            if (pathParts.length > 0) {
              possibleUrls.push('/' + pathParts.join('/') + '/batch-delete/');
            }
          }
          
          // æ¨¡å¼3: æ£€æŸ¥å…¨å±€é…ç½®
          if (typeof window.BATCH_DELETE_URL !== 'undefined' && window.BATCH_DELETE_URL) {
            possibleUrls.push(window.BATCH_DELETE_URL);
          }
          
        // ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯èƒ½çš„URLï¼ˆå­æ¨¡æ¿å¯ä»¥é€šè¿‡è®¾ç½® window.BATCH_DELETE_URL æ¥è¦†ç›–ï¼‰
        if (possibleUrls.length > 0) {
          deleteUrl = possibleUrls[0];
          console.log('[æ‰¹é‡åˆ é™¤] æ¨æ–­çš„æ‰¹é‡åˆ é™¤URL:', deleteUrl, 'å¯èƒ½çš„URLåˆ—è¡¨:', possibleUrls);
        }
      }
      
        // å¦‚æœä»ç„¶æ²¡æœ‰æœ‰æ•ˆçš„URLï¼Œæ˜¾ç¤ºé”™è¯¯
        if (!deleteUrl || deleteUrl.trim() === '' || deleteUrl === '/batch-delete/') {
          console.error('[æ‰¹é‡åˆ é™¤] æ— æ³•æ¨æ–­æ‰¹é‡åˆ é™¤URLï¼Œå½“å‰è·¯å¾„:', window.location.pathname);
          showMessage('æœªé…ç½®æ‰¹é‡åˆ é™¤URLã€‚è¯·åœ¨è§†å›¾å‡½æ•°ä¸­è®¾ç½® batch_delete_url å˜é‡ï¼Œæˆ–åœ¨é¡µé¢ä¸­è®¾ç½® window.BATCH_DELETE_URL', 'error');
          this.disabled = false;
          this.innerHTML = originalHtml;
          return;
        }
        
        console.log('[æ‰¹é‡åˆ é™¤] ä½¿ç”¨æ‰¹é‡åˆ é™¤URL:', deleteUrl);
        
        // è·å– CSRF token
        const csrfToken = getCsrfToken();
        if (!csrfToken) {
          showMessage('æ— æ³•è·å–CSRF tokenï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•', 'error');
          btn.disabled = false;
          btn.innerHTML = originalHtml;
          return;
        }
        
        // å‘é€æ‰¹é‡åˆ é™¤è¯·æ±‚
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        formData.append('ids', selectedIds.join(','));
        
        // å¦‚æœå­æ¨¡æ¿å®šä¹‰äº†è‡ªå®šä¹‰çš„æ‰¹é‡åˆ é™¤å¤„ç†å‡½æ•°ï¼Œä½¿ç”¨å®ƒ
        if (typeof window.handleBatchDelete === 'function') {
          window.handleBatchDelete(selectedIds, {
            url: deleteUrl,
            csrfToken: csrfToken,
            onSuccess: function(response) {
              showMessage('æ‰¹é‡åˆ é™¤æˆåŠŸ', 'success');
              if (typeof window.clearSelection === 'function') {
                window.clearSelection();
              }
              // åˆ·æ–°é¡µé¢
              setTimeout(function() {
                window.location.reload();
              }, 500);
            },
            onError: function(error) {
              showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
              btn.disabled = false;
              btn.innerHTML = originalHtml;
            }
          });
        } else {
          // é»˜è®¤çš„æ‰¹é‡åˆ é™¤å®ç°
          fetch(deleteUrl, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData,
            credentials: 'same-origin'
          })
          .then(function(response) {
            if (response.ok) {
              return response.json().catch(function() {
                // å¦‚æœå“åº”ä¸æ˜¯JSONï¼Œä¹Ÿè®¤ä¸ºæˆåŠŸ
                return { success: true };
              });
            } else {
              return response.json().then(function(data) {
                throw new Error(data.message || 'åˆ é™¤å¤±è´¥');
              }).catch(function() {
                throw new Error('åˆ é™¤å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š' + response.status);
              });
            }
          })
          .then(function(data) {
            if (data.success !== false) {
              const deletedCount = data.deleted_count || selectedIds.length;
              showMessage('æˆåŠŸåˆ é™¤ ' + deletedCount + ' ä¸ªé¡¹ç›®', 'success');
              if (typeof window.clearSelection === 'function') {
                window.clearSelection();
              }
              // åˆ·æ–°é¡µé¢
              setTimeout(function() {
                window.location.reload();
              }, 500);
            } else {
              throw new Error(data.message || 'åˆ é™¤å¤±è´¥');
            }
          })
          .catch(function(error) {
            console.error('æ‰¹é‡åˆ é™¤é”™è¯¯:', error);
            showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
          });
        }
      });
    }
    
    // ç­‰å¾…DOMå’Œå¤é€‰æ¡†åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ
    function tryInitBatchDelete() {
      try {
        initBatchDelete();
      } catch (e) {
        console.error('[æ‰¹é‡åˆ é™¤] åˆå§‹åŒ–å¤±è´¥:', e);
      }
    }
    
    // ç«‹å³å°è¯•åˆå§‹åŒ–ï¼ˆå¦‚æœDOMå·²å‡†å¤‡å¥½ï¼‰
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        tryInitBatchDelete();
      });
    } else {
      tryInitBatchDelete();
    }
    
    // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿å¤é€‰æ¡†åŠŸèƒ½å·²åŠ è½½ï¼ˆå¤šæ¬¡å°è¯•ï¼‰
    setTimeout(tryInitBatchDelete, 100);
    setTimeout(tryInitBatchDelete, 300);
    setTimeout(tryInitBatchDelete, 600);
    setTimeout(tryInitBatchDelete, 1000);
    setTimeout(tryInitBatchDelete, 2000);
  })();
  </script>
{% endblock module_scripts %}

{# ä¸»æ ‡é¢˜ - ç»§æ‰¿çˆ¶æ¨¡æ¿çš„ pm_title å— #}
{% block pm_title %}
  {% if page_title %}{{ page_title }}{% endif %}
{% endblock pm_title %}

{# å‰¯æ ‡é¢˜ - ç»§æ‰¿çˆ¶æ¨¡æ¿çš„ pm_subtitle å— #}
{% block pm_subtitle %}
  {% if description %}{{ description }}{% endif %}
{% endblock pm_subtitle %}

{# ä¸»æ ‡é¢˜å³ä¾§æ“ä½œæŒ‰é’® - ç»§æ‰¿çˆ¶æ¨¡æ¿çš„ pm_actions å— #}
{% block pm_actions %}
  {% block list_page_actions %}
    {# æ‰¹é‡åˆ é™¤æŒ‰é’® - é»˜è®¤æ˜¾ç¤ºï¼Œæ‰€æœ‰ç»§æ‰¿è¯¥æ¨¡æ¿çš„é¡µé¢éƒ½è‡ªåŠ¨å…·æœ‰ #}
    <button type="button" id="batchDeleteBtn" class="btn btn-danger" style="display: none;">
      <i class="bi bi-trash"></i> æ‰¹é‡åˆ é™¤
    </button>
    {# å­æ¨¡æ¿å¯ä»¥è¦†ç›–æ­¤å—æ·»åŠ å…¶ä»–æ“ä½œæŒ‰é’® #}
  {% endblock list_page_actions %}
{% endblock pm_actions %}

{% block pm_content %}
  {# éšè—çš„ CSRF token å­—æ®µï¼Œç¡®ä¿æ‰¹é‡åˆ é™¤åŠŸèƒ½å¯ä»¥è·å–åˆ° token #}
  {% csrf_token %}

  {# ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ - æ˜¾ç¤ºå…³é”®æŒ‡æ ‡ #}
  {% block list_stats_section %}
  <div class="list-stats-section">
    <div class="list-page-stats">
      {% block list_stats_content %}
        {# å­æ¨¡æ¿å¯ä»¥è¦†ç›–æ­¤å—æ·»åŠ ç»Ÿè®¡å¡ç‰‡ #}
      {% endblock list_stats_content %}
    </div>
  </div>
  {% endblock list_stats_section %}

  {# ç­›é€‰å™¨åŒºåŸŸ #}
  {% block list_filters_section %}
  <div class="list-page-filters">
    <div class="list-page-filter-row">
      <form id="filterForm" method="get" {% if filter_form_action %} action="{{ filter_form_action }}"{% endif %}>
        {% block list_filters_content %}
          {# å­æ¨¡æ¿å¯ä»¥è¦†ç›–æ­¤å—æ·»åŠ ç­›é€‰å™¨è¡¨å•å­—æ®µ #}
        {% endblock list_filters_content %}
      </form>
      {% block list_filter_actions %}
      <!-- ç­›é€‰å’Œé‡ç½®æŒ‰é’® - è‡ªåŠ¨æ·»åŠ åˆ°æ‰€æœ‰ç­›é€‰è¡¨å• -->
      <div class="list-page-filter-actions">
        <button type="submit" form="filterForm" class="btn btn-primary">
          <i class="bi bi-funnel"></i> ç­›é€‰
        </button>
        <button type="reset" form="filterForm" class="btn btn-secondary">
          <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®
        </button>
      </div>
      {% endblock list_filter_actions %}
    </div>
  </div>
  {% endblock list_filters_section %}

  {# è¡¨æ ¼åŒºåŸŸ #}
  {% block list_table_section %}
    {% block list_table_content %}
      {# å¦‚æœæä¾›äº† columns å’Œ dataï¼Œä½¿ç”¨ list_table.html æ¨¡æ¿ #}
      {% if columns and data %}
        {% include "shared/list_table.html" with 
          table_id=table_id|default:"dataTable"
          columns=columns 
          data=data 
          show_checkbox=show_checkbox|default:False
          show_actions=show_actions|default:True
          action_template=action_template|default:""
          empty_message=empty_message|default:"æš‚æ— æ•°æ®"
          show_pagination=False
          pagination_params=request.GET.dict
          table_class=table_class|default:""
          column_settings_btn=column_settings_btn|default:False
        %}
      {% else %}
        {# å¦åˆ™ä½¿ç”¨ä¼ ç»Ÿçš„ block æ–¹å¼ï¼ˆå‘åå…¼å®¹ï¼‰ #}
        <div class="list-table-container">
          <table class="list-table">
            <thead>
              <tr>
                {% block list_table_checkbox_header %}
                  {# å­æ¨¡æ¿å¯ä»¥è¦†ç›–æ­¤å—æ·»åŠ å¤é€‰æ¡†åˆ—è¡¨å¤´ #}
                  {# å¦‚æœéœ€è¦å¤é€‰æ¡†ï¼Œæ·»åŠ ï¼š<th style="width: 50px;"><input type="checkbox" id="selectAll" class="form-check-input" title="å…¨é€‰"></th> #}
                {% endblock list_table_checkbox_header %}
                {% block list_table_headers %}
                  {# å­æ¨¡æ¿éœ€è¦åœ¨æ­¤å®šä¹‰è¡¨å¤´ #}
                {% endblock list_table_headers %}
                {% block list_table_column_settings_header %}
                  {% if column_settings_btn|default:False %}
                  <th class="column-settings-header" style="width: auto; min-width: 32px; position: relative; text-align: center;">
                    <button type="button" class="btn btn-link btn-sm p-0" id="tableColumnSettingsBtn" title="è‡ªå®šä¹‰æ˜¾ç¤ºåˆ—" style="text-decoration: none; color: #FFC107 !important; border: none; background: none; padding: 0;">
                      <i class="bi bi-gear-fill" style="color: #FFC107 !important; font-size: 1.1rem;"></i>
                    </button>
                  </th>
                  {% endif %}
                {% endblock list_table_column_settings_header %}
              </tr>
            </thead>
            <tbody>
              {% block list_table_rows %}
                {# é»˜è®¤ç©ºçŠ¶æ€ #}
                <tr>
                  <td colspan="100%" class="list-empty">
                    <div class="list-empty-icon">ğŸ“‹</div>
                    <div class="list-empty-text">æš‚æ— æ•°æ®</div>
                    {% block list_empty_hint %}
                      {# å­æ¨¡æ¿å¯ä»¥æ·»åŠ ç©ºçŠ¶æ€æç¤ºæ–‡å­— #}
                    {% endblock list_empty_hint %}
                  </td>
                  {# å¦‚æœå¯ç”¨äº†åˆ—è®¾ç½®æŒ‰é’®ï¼Œéœ€è¦æ·»åŠ å¯¹åº”çš„ç©ºå•å…ƒæ ¼æ¥ä¿æŒåˆ—å¯¹é½ #}
                  {% block list_table_column_settings_cell %}
                    {% if column_settings_btn|default:False %}
                    <td></td>
                    {% endif %}
                  {% endblock list_table_column_settings_cell %}
                </tr>
              {% endblock list_table_rows %}
            </tbody>
          </table>
        </div>
      {% endif %}
    {% endblock list_table_content %}
  {% endblock list_table_section %}

  {# åˆ†é¡µåŒºåŸŸ #}
  {% block list_pagination_section %}
  <div class="list-pagination-section">
    <div class="list-pagination">
      <div class="list-pagination-info">
        {% if page_obj %}
          æ˜¾ç¤ºç¬¬ {{ page_obj.start_index }} - {{ page_obj.end_index }} æ¡ï¼Œå…± {{ page_obj.paginator.count }} æ¡
        {% else %}
          æš‚æ— æ•°æ®
        {% endif %}
      </div>
      <div class="list-pagination-controls">
        {% if page_obj and page_obj.paginator.num_pages > 1 %}
          <nav aria-label="åˆ†é¡µå¯¼èˆª">
            <ul class="pagination">
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">ä¸Šä¸€é¡µ</a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">ä¸Šä¸€é¡µ</span>
                </li>
              {% endif %}
              
              {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                  <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                  </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                  <li class="page-item">
                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                  </li>
                {% endif %}
              {% endfor %}
              
              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">ä¸‹ä¸€é¡µ</a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">ä¸‹ä¸€é¡µ</span>
                </li>
              {% endif %}
            </ul>
          </nav>
        {% else %}
          {# å³ä½¿åªæœ‰ä¸€é¡µä¹Ÿæ˜¾ç¤ºåˆ†é¡µä¿¡æ¯ #}
          <nav aria-label="åˆ†é¡µå¯¼èˆª">
            <ul class="pagination">
              <li class="page-item disabled">
                <span class="page-link">ä¸Šä¸€é¡µ</span>
              </li>
              <li class="page-item active">
                <span class="page-link">1</span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">ä¸‹ä¸€é¡µ</span>
              </li>
            </ul>
          </nav>
        {% endif %}
      </div>
    </div>
  </div>
  {% endblock list_pagination_section %}

{% endblock pm_content %}
