{% extends "shared/module_base.html" %}
{% load static %}

{% block module_styles %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/components/detail.css' %}">
{% endblock module_styles %}
{% block pm_title %}{% block detail_title %}详情页面{% endblock detail_title %}{% endblock pm_title %}
{% block pm_subtitle %}{% block detail_subtitle %}查看详细信息{% endblock detail_subtitle %}{% endblock pm_subtitle %}
{% block pm_actions %}{% block detail_header_actions %}{% endblock detail_header_actions %}{% endblock pm_actions %}
{% block pm_content %}
<div class="detail-page-container">
{% block detail_actions_card %}
<div class="detail-card-wrapper detail-card-wrapper-actions">
  <div class="detail-card detail-card-actions">
    <div class="detail-card-header">
      <h3 class="detail-card-title">
        <i class="fas fa-tools"></i>
        操作
      </h3>
    </div>
    <div class="detail-card-body">
      <div class="detail-actions-container">
        {% block detail_actions %}
        {# 编辑按钮：始终显示，根据权限设置禁用状态 #}
        {% if can_edit %}
        <a href="{% block detail_edit_url %}#{% endblock %}" class="btn btn-light">
          <i class="fas fa-edit"></i> 编辑
        </a>
        {% else %}
        <button type="button" class="btn btn-secondary" disabled title="您没有编辑权限">
          <i class="fas fa-edit"></i> 编辑
        </button>
        {% endif %}
        
        {# 删除按钮：始终显示，根据权限设置禁用状态 #}
        {% if can_delete %}
        <button type="button" class="btn btn-gray" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
          <i class="fas fa-trash"></i> 删除
        </button>
        {% else %}
        <button type="button" class="btn btn-secondary" disabled title="您没有删除权限">
          <i class="fas fa-trash"></i> 删除
        </button>
        {% endif %}
        
        {# 提交审批按钮：始终显示，根据权限设置禁用状态 #}
        {% block detail_submit_approval %}
        {% if can_submit_approval %}
        <form method="post" action="{% block detail_submit_approval_url %}#{% endblock %}" class="d-inline" id="submitApprovalForm">
          {% csrf_token %}
          <button type="submit" class="btn btn-success" id="submitApprovalBtn" title="直接提交审批，无需编辑">
            <i class="fas fa-paper-plane"></i> 提交审批
          </button>
        </form>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('submitApprovalForm');
            const btn = document.getElementById('submitApprovalBtn');
            if (form && btn) {
              form.addEventListener('submit', function(e) {
                if (!confirm('确定要提交审批吗？提交后需要等待审批通过才能启动计划。')) {
                  e.preventDefault();
                  return false;
                }
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
              });
            }
          });
        </script>
        {% else %}
        <button type="button" class="btn btn-secondary" disabled title="您没有提交审批权限">
          <i class="fas fa-paper-plane"></i> 提交审批
        </button>
        {% endif %}
        {% endblock detail_submit_approval %}
        
        {% block detail_other_actions_header %}{% endblock %}
        {% block detail_other_actions %}{% endblock %}
        {% endblock detail_actions %}
      </div>
    </div>
  </div>
</div>
{% endblock detail_actions_card %}

{% block detail_basic_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-basic-info">
  <div class="detail-card detail-card-basic-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-info-circle"></i>
      基本信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_basic_info_rows %}
    {# 固定字段：所属部门、负责人、表单编号（自动继承） #}
    <div class="row mb-3">
      {% block detail_basic_info_row1 %}
      {# 所属部门 #}
      <div class="col-md-4 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">所属部门</label>
          <div class="detail-field-value">
            {% if object.responsible_department %}{{ object.responsible_department.name }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      {# 负责人 #}
      <div class="col-md-4 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">负责人</label>
          <div class="detail-field-value">
            {% if object.responsible_person %}{{ object.responsible_person.get_full_name|default:object.responsible_person.username }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      {# 表单编号字段：自动检测 goal_number、plan_number、form_number、usage_number 等 #}
      {% if object.goal_number %}
      <div class="col-md-4 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">目标编号</label>
          <div class="detail-field-value">
            <code>{{ object.goal_number|default:object.id }}</code>
          </div>
        </div>
      </div>
      {% elif object.plan_number %}
      <div class="col-md-4 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划编号</label>
          <div class="detail-field-value">
            <code>{{ object.plan_number|default:object.id }}</code>
          </div>
        </div>
      </div>
      {% elif object.form_number %}
      <div class="col-md-4 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">表单编号</label>
          <div class="detail-field-value">
            <code>{{ object.form_number|default:object.id }}</code>
          </div>
        </div>
      </div>
      {% elif object.usage_number %}
      <div class="col-md-4 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">用印单号</label>
          <div class="detail-field-value">
            <code>{{ object.usage_number|default:object.id }}</code>
          </div>
        </div>
      </div>
      {% else %}
      <div class="col-md-4 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">编号</label>
          <div class="detail-field-value">
            <code>{{ object.id }}</code>
          </div>
        </div>
      </div>
      {% endif %}
      {% endblock detail_basic_info_row1 %}
    </div>
    {% endblock detail_basic_info_rows %}
  </div>
</div>
</div>
{% endblock detail_basic_info_card %}

{% block detail_detail_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-detail-info">
  <div class="detail-card detail-card-detail-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-list-alt"></i>
      详细信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_detail_info_rows %}
    {# 子模板需要覆盖此块来定义详细信息字段内容 #}
    {# 使用标准 Bootstrap 栅格系统组织字段布局： #}
    {# - 使用 row 和 col-md-X 类（X 可以是 3、4、6、12 等） #}
    {# - col-md-3: 一行4个字段 #}
    {# - col-md-4: 一行3个字段 #}
    {# - col-md-6: 一行2个字段 #}
    {# - col-md-12: 一行1个字段（用于多行文本字段） #}
    {# 可以使用以下块来组织字段布局： #}
    {# - detail_detail_info_row1: 第一排字段（使用 row 和 col-md-X） #}
    {# - detail_detail_info_row2: 第二排字段（使用 row 和 col-md-X） #}
    {# - detail_detail_info_row3: 第三排字段（使用 row 和 col-md-X） #}
    {# - detail_detail_info_content: 多行文本字段（使用 row 和 col-md-12） #}
    {# - detail_detail_info_description: 多行文本字段（使用 row 和 col-md-12） #}
    {# - detail_detail_info_notes: 多行文本字段（使用 row 和 col-md-12） #}
    {% endblock detail_detail_info_rows %}
  </div>
</div>
</div>
{% endblock detail_detail_info_card %}

{% block detail_status_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-status-info">
  <div class="detail-card detail-card-status-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-toggle-on"></i>
      状态信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_status_info %}
    <table class="detail-table">
      <tbody>
        {% block detail_status_timestamps %}
        {% block detail_status_timestamps_content %}
        {% endblock detail_status_timestamps_content %}
        {% endblock detail_status_timestamps %}
        
        {% block detail_status_history_separator %}
        {% endblock detail_status_history_separator %}
        
        {% block detail_status_history_header %}
        <tr class="detail-table-header-row">
          <th style="width: 60px;">序号</th>
          <th>状态变更</th>
          <th style="width: 120px;">变更人</th>
          <th style="width: 160px;">变更时间</th>
          <th>变更依据</th>
          <th>备注</th>
        </tr>
        {% endblock detail_status_history_header %}
        
        {% block detail_status_history %}
        {% block detail_status_history_content %}
        {% endblock detail_status_history_content %}
        {% endblock detail_status_history %}
      </tbody>
    </table>
    {% endblock detail_status_info %}
  </div>
</div>
</div>
{% endblock detail_status_info_card %}

{% block detail_related_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-related-info">
  <div class="detail-card detail-card-related-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-link"></i>
      关联信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_related_info %}
    <table class="detail-table">
      <thead>
        <tr>
          <th style="width: 60px;">序号</th>
          <th>类型/名称</th>
          <th>对象/地址</th>
          <th style="width: 160px;">时间</th>
          <th>说明/描述</th>
          <th>备注</th>
        </tr>
      </thead>
      <tbody>
        {# 子模板需要覆盖此块来定义具体的关联信息内容 #}
        {% block detail_related_info_content %}
        {% endblock detail_related_info_content %}
      </tbody>
    </table>
    {% endblock detail_related_info %}
  </div>
</div>
</div>
{% endblock detail_related_info_card %}

{% block detail_audit_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-audit-info">
  <div class="detail-card detail-card-audit-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-file-alt"></i>
      审计信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_audit_info %}
    <table class="detail-table">
      <thead>
        <tr>
          <th style="width: 60px;">序号</th>
          <th style="width: 160px;">时间</th>
          <th style="width: 120px;">操作人</th>
          <th>类型/字段</th>
          <th>内容/原值</th>
          <th>新值</th>
          <th>备注</th>
        </tr>
      </thead>
      <tbody>
        {# 子模板需要覆盖此块来定义具体的审计信息内容 #}
        {% block detail_audit_info_content %}
        {% endblock detail_audit_info_content %}
      </tbody>
    </table>
    {% endblock detail_audit_info %}
  </div>
</div>
</div>
{% endblock detail_audit_info_card %}

{% block detail_approval_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-approval-info">
  <div class="detail-card detail-card-approval-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-check-circle"></i>
      审批信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_approval_info %}
    <table class="detail-table">
      <thead>
        <tr>
          <th style="width: 60px;">序号</th>
          <th style="width: 120px;">审批单号</th>
          <th style="width: 100px;">流程名称</th>
          <th style="width: 100px;">审批状态</th>
          <th style="width: 120px;">申请人</th>
          <th style="width: 120px;">节点名称</th>
          <th style="width: 120px;">审批人</th>
          <th style="width: 100px;">审批结果</th>
          <th>申请说明/审批意见</th>
          <th style="width: 160px;">时间</th>
        </tr>
      </thead>
      <tbody>
        {% block detail_approval_info_content %}
        {% if approval_instances %}
          {% for instance in approval_instances %}
            {# 如果该实例有审批记录，显示每条记录 #}
            {% if instance.records_sorted %}
              {% for record in instance.records_sorted %}
              <tr>
                <td>{{ forloop.parentloop.counter }}-{{ forloop.counter }}</td>
                <td>
                  {% if forloop.first %}
                    <code>{{ instance.instance_number }}</code>
                  {% endif %}
                </td>
                <td>
                  {% if forloop.first %}
                    {{ instance.workflow.name }}
                  {% endif %}
                </td>
                <td>
                  {% if forloop.first %}
                    <span class="badge badge-status badge-{{ instance.status }}">
                      {{ instance.get_status_display }}
                    </span>
                  {% endif %}
                </td>
                <td>
                  {% if forloop.first %}
                    {% if instance.applicant %}
                      {{ instance.applicant.get_full_name|default:instance.applicant.username }}
                    {% else %}
                      -
                    {% endif %}
                  {% endif %}
                </td>
                <td>{{ record.node.name|default:"-" }}</td>
                <td>
                  {% if record.approver %}
                    {{ record.approver.get_full_name|default:record.approver.username }}
                  {% else %}
                    -
                  {% endif %}
                  {% if record.transferred_to %}
                    <br><small class="text-muted">转交给：{{ record.transferred_to.get_full_name|default:record.transferred_to.username }}</small>
                  {% endif %}
                </td>
                <td>
                  <span class="badge badge-status badge-{{ record.result }}">
                    {{ record.get_result_display }}
                  </span>
                </td>
                <td>
                  {% if forloop.first and instance.apply_comment %}
                    <strong>申请说明：</strong>{{ instance.apply_comment }}
                    {% if record.comment %}<br>{% endif %}
                  {% endif %}
                  {% if record.comment %}
                    <strong>审批意见：</strong>{{ record.comment }}
                  {% elif forloop.first and instance.final_comment %}
                    <strong>最终意见：</strong>{{ instance.final_comment }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if record.approval_time %}
                    {{ record.approval_time|date:"Y-m-d H:i:s" }}
                  {% elif forloop.first and instance.apply_time %}
                    {{ instance.apply_time|date:"Y-m-d H:i:s" }}
                  {% elif forloop.first %}
                    {{ instance.created_time|date:"Y-m-d H:i:s" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            {% else %}
              {# 如果没有审批记录，只显示实例信息 #}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td><code>{{ instance.instance_number }}</code></td>
                <td>{{ instance.workflow.name }}</td>
                <td>
                  <span class="badge badge-status badge-{{ instance.status }}">
                    {{ instance.get_status_display }}
                  </span>
                </td>
                <td>
                  {% if instance.applicant %}
                    {{ instance.applicant.get_full_name|default:instance.applicant.username }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>
                  {% if instance.apply_comment %}
                    <strong>申请说明：</strong>{{ instance.apply_comment }}
                  {% elif instance.final_comment %}
                    <strong>最终意见：</strong>{{ instance.final_comment }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if instance.apply_time %}
                    {{ instance.apply_time|date:"Y-m-d H:i:s" }}
                  {% else %}
                    {{ instance.created_time|date:"Y-m-d H:i:s" }}
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="10" class="text-center text-muted">暂无审批信息</td>
          </tr>
        {% endif %}
        {% endblock detail_approval_info_content %}
      </tbody>
    </table>
    {% endblock detail_approval_info %}
  </div>
</div>
</div>
{% endblock detail_approval_info_card %}

{% block detail_data_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-data-info">
  <div class="detail-card detail-card-data-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-tasks"></i>
      进度信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_data_info_content %}
    <table class="detail-table">
      <thead>
        <tr>
          <th style="width: 150px;">项目</th>
          <th>内容</th>
        </tr>
      </thead>
      <tbody>
        {% block detail_data_info_rows %}
        {% if progress_percentage %}
        <tr>
          <th>进度百分比</th>
          <td>
            <div class="detail-progress detail-progress-lg" style="max-width: 300px;">
              <div class="detail-progress-bar" role="progressbar" 
                   style="width: {{ progress_percentage }}%;" 
                   aria-valuenow="{{ progress_percentage }}" 
                   aria-valuemin="0" 
                   aria-valuemax="100">
                {{ progress_percentage }}%
              </div>
            </div>
          </td>
        </tr>
        {% endif %}
        {% block detail_data_info_custom_rows %}
        {% endblock detail_data_info_custom_rows %}
        {% block detail_charts %}
        {% block detail_charts_content %}{% endblock %}
        {% endblock detail_charts %}
        {% endblock detail_data_info_rows %}
      </tbody>
    </table>
    {% endblock detail_data_info_content %}
  </div>
</div>
</div>
{% endblock detail_data_info_card %}

{% block detail_statistics_card %}
<div class="detail-card-wrapper detail-card-wrapper-statistics">
  <div class="detail-card detail-card-statistics">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-chart-bar"></i>
      统计信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_statistics_content %}
    <table class="detail-table">
      <thead>
        <tr>
          <th style="width: 150px;">统计项</th>
          <th>数值</th>
        </tr>
      </thead>
      <tbody>
        {% block detail_statistics_rows %}
        {% block detail_statistics_rows_content %}{% endblock %}
        {% endblock detail_statistics_rows %}
      </tbody>
    </table>
    {% endblock detail_statistics_content %}
  </div>
</div>
</div>
{% endblock detail_statistics_card %}

{% block detail_attachments_card %}
<div class="detail-card-wrapper detail-card-wrapper-attachments">
  <div class="detail-card detail-card-attachments">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-paperclip"></i>
      附件与文件信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_attachments_content %}
    <div class="detail-attachments-list">
      {% if attachments %}
      <table class="detail-table attachment-table">
        <tbody>
          {% for attachment in attachments %}
          <tr>
            <th class="attachment-icon-cell">
              <div class="attachment-icon">
                {% if attachment.file_type == 'pdf' %}
                  <i class="fas fa-file-pdf"></i>
                {% elif attachment.file_type == 'image' %}
                  <i class="fas fa-file-image"></i>
                {% elif attachment.file_type == 'video' %}
                  <i class="fas fa-file-video"></i>
                {% elif attachment.file_type == 'word' %}
                  <i class="fas fa-file-word"></i>
                {% elif attachment.file_type == 'excel' %}
                  <i class="fas fa-file-excel"></i>
                {% else %}
                  <i class="fas fa-file"></i>
                {% endif %}
              </div>
            </th>
            <td class="attachment-name-cell">{{ attachment.name }}</td>
            <td class="attachment-meta-cell">
              <i class="fas fa-calendar"></i>
              {{ attachment.uploaded_at|date:"Y-m-d H:i" }}
            </td>
            <td class="attachment-actions-cell">
              <a href="{{ attachment.file.url }}" class="btn btn-sm btn-light" download>
                <i class="fas fa-download"></i>
                下载
              </a>
              {% if attachment.file_type == 'image' %}
              <button type="button" class="btn btn-sm btn-light" onclick="previewImage('{{ attachment.file.url }}')">
                <i class="fas fa-eye"></i>
                预览
              </button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <table class="detail-table">
        <tbody>
          <tr>
            <td colspan="4">
              <div class="detail-empty-state">暂无附件</div>
            </td>
          </tr>
        </tbody>
      </table>
      {% endif %}
    </div>
    {% endblock detail_attachments_content %}
  </div>
</div>
</div>
{% endblock detail_attachments_card %}

{% block detail_system_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-system-info">
  <div class="detail-card detail-card-system-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-cog"></i>
      系统信息
    </h3>
  </div>
  <div class="detail-card-body">
    <table class="detail-table">
      <tbody>
        {% block detail_system_info_table_rows %}
        <tr>
          <th>创建时间</th>
          <td>{% if object.created_time %}{{ object.created_time|date:"Y-m-d H:i:s" }}{% elif object.created_at %}{{ object.created_at|date:"Y-m-d H:i:s" }}{% else %}{% endif %}</td>
        </tr>
        <tr>
          <th>更新时间</th>
          <td>{% if object.updated_time %}{{ object.updated_time|date:"Y-m-d H:i:s" }}{% elif object.updated_at %}{{ object.updated_at|date:"Y-m-d H:i:s" }}{% else %}{% endif %}</td>
        </tr>
        {% if object.created_by %}
        <tr>
          <th>创建人</th>
          <td>{{ object.created_by.get_full_name|default:object.created_by.username }}</td>
        </tr>
        {% endif %}
        {% endblock detail_system_info_table_rows %}
      </tbody>
    </table>
  </div>
</div>
</div>
{% endblock detail_system_info_card %}
</div>
{% endblock pm_content %}

{% block module_extra_js %}
{{ block.super }}
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">确认删除</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>确定要删除此项吗？此操作不可恢复。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <form method="post" action="{% block detail_delete_url %}#{% endblock %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">确认删除</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function previewImage(imageUrl) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">图片预览</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <img src="${imageUrl}" class="img-fluid" alt="预览图片">
          </div>
          <div class="modal-footer">
            <a href="${imageUrl}" download class="btn btn-light">
              <i class="fas fa-download"></i> 下载图片
            </a>
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">关闭</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    modal.addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modal);
    });
  }
</script>
{% endblock module_extra_js %}