{% extends "shared/module_base.html" %}
{% load static %}

{% block module_styles %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/components/detail.css' %}">
{% endblock module_styles %}
{% block pm_title %}{% block detail_title %}详情页面{% endblock detail_title %}{% endblock pm_title %}
{% block pm_subtitle %}{% block detail_subtitle %}查看详细信息{% endblock detail_subtitle %}{% endblock pm_subtitle %}
{% block pm_actions %}{% block detail_header_actions %}{% endblock detail_header_actions %}{% endblock pm_actions %}
{% block pm_content %}
<div class="detail-page-container">
{% block detail_actions_card %}
<div class="detail-card-wrapper detail-card-wrapper-actions">
  <div class="detail-card detail-card-actions">
    <div class="detail-card-header">
      <h3 class="detail-card-title">
        <i class="fas fa-tools"></i>
        操作
      </h3>
    </div>
    <div class="detail-card-body">
      <div class="detail-actions-container">
        {% block detail_actions %}
        {% if can_edit %}
        <a href="{% block detail_edit_url %}#{% endblock %}" class="btn btn-light">
          <i class="fas fa-edit"></i> 编辑
        </a>
        {% endif %}
        {% if can_delete %}
        <button type="button" class="btn btn-gray" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
          <i class="fas fa-trash"></i> 删除
        </button>
        {% endif %}
        {% if can_submit_approval %}
        {% block detail_submit_approval %}
        <form method="post" action="{% block detail_submit_approval_url %}#{% endblock %}" class="d-inline" id="submitApprovalForm">
          {% csrf_token %}
          <button type="submit" class="btn btn-success" id="submitApprovalBtn">
            <i class="fas fa-paper-plane"></i> 提交审批
          </button>
        </form>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('submitApprovalForm');
            const btn = document.getElementById('submitApprovalBtn');
            if (form && btn) {
              form.addEventListener('submit', function(e) {
                if (!confirm('确定要提交审批吗？提交后需要等待审批通过才能启动。')) {
                  e.preventDefault();
                  return false;
                }
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
              });
            }
          });
        </script>
        {% endblock detail_submit_approval %}
        {% endif %}
        {% block detail_other_actions_header %}{% endblock %}
        {% block detail_other_actions %}{% endblock %}
        {% endblock detail_actions %}
      </div>
    </div>
  </div>
</div>
{% endblock detail_actions_card %}

{% block detail_basic_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-basic-info">
  <div class="detail-card detail-card-basic-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-info-circle"></i>
      表单信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_basic_info_rows %}
    {# 第一排：编号、名称、层级、周期（4个字段 + 1个空占位符 = 5个位置） #}
    <div class="form-row-5 mb-3">
      {% block detail_basic_info_row1 %}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划编号</label>
          <div class="detail-field-value">
            {% if object.plan_number %}{{ object.plan_number }}{% elif object.id %}{{ object.id }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划名称</label>
          <div class="detail-field-value">
            {% if object.name %}{{ object.name }}{% elif object.title %}{{ object.title }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划层级</label>
          <div class="detail-field-value">
            {% if object.level %}{{ object.get_level_display|default:object.level }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划周期</label>
          <div class="detail-field-value">
            {% if object.plan_period %}{{ object.get_plan_period_display|default:object.plan_period }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      <div class="col-5-fields detail-field-wrapper"></div>
      {% endblock detail_basic_info_row1 %}
    </div>

    {# 第二排：关联战略目标、父计划、关联项目（3个字段 + 2个空占位符 = 5个位置） #}
    <div class="form-row-5 mb-3">
      {% block detail_basic_info_row2 %}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">关联战略目标</label>
          <div class="detail-field-value">
            {% if object.related_goal %}{{ object.related_goal.name }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">父计划</label>
          <div class="detail-field-value">
            {% if object.parent_plan %}{{ object.parent_plan.name }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">关联项目</label>
          <div class="detail-field-value">
            {% if object.related_project %}{{ object.related_project }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      <div class="col-5-fields detail-field-wrapper"></div>
      <div class="col-5-fields detail-field-wrapper"></div>
      {% endblock detail_basic_info_row2 %}
    </div>

    {# 第三排：开始时间、结束时间（2个字段 + 3个空占位符 = 5个位置） #}
    <div class="form-row-5 mb-3">
      {% block detail_basic_info_row3 %}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划开始时间</label>
          <div class="detail-field-value">
            {% if object.start_time %}{{ object.start_time|date:"Y-m-d H:i" }}{% elif object.start_date %}{{ object.start_date|date:"Y-m-d" }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划结束时间</label>
          <div class="detail-field-value">
            {% if object.end_time %}{{ object.end_time|date:"Y-m-d H:i" }}{% elif object.end_date %}{{ object.end_date|date:"Y-m-d" }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      <div class="col-5-fields detail-field-wrapper"></div>
      <div class="col-5-fields detail-field-wrapper"></div>
      <div class="col-5-fields detail-field-wrapper"></div>
      {% endblock detail_basic_info_row3 %}
    </div>

    {# 多行文本字段：计划内容（整行，使用 col-12） #}
    <div class="row mb-3">
      {% block detail_basic_info_content %}
      <div class="col-12 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划内容</label>
          <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.6;">
            {% if object.content %}{{ object.content }}{% else %}暂无内容{% endif %}
          </div>
        </div>
      </div>
      {% endblock detail_basic_info_content %}
    </div>

    {# 多行文本字段：计划目标（整行，使用 col-12） #}
    <div class="row mb-3">
      {% block detail_basic_info_objective %}
      <div class="col-12 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划目标</label>
          <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.6;">
            {% if object.plan_objective %}{{ object.plan_objective }}{% else %}暂无目标{% endif %}
          </div>
        </div>
      </div>
      {% endblock detail_basic_info_objective %}
    </div>

    {# 多行文本字段：协作计划（整行，使用 col-12） #}
    <div class="row mb-3">
      {% block detail_basic_info_collaboration %}
      <div class="col-12 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">协作计划</label>
          <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.6;">
            {% if object.collaboration_plan %}{{ object.collaboration_plan }}{% else %}暂无协作计划{% endif %}
          </div>
        </div>
      </div>
      {% endblock detail_basic_info_collaboration %}
    </div>

    {# 多选字段：协作人员（整行，使用 col-12） #}
    <div class="row mb-3">
      {% block detail_basic_info_participants %}
      <div class="col-12 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">协作人员</label>
          <div class="detail-field-value">
            {% if object.participants.all %}
              {% for participant in object.participants.all %}
                <span class="badge badge-secondary">{{ participant.get_full_name|default:participant.username }}</span>
              {% endfor %}
            {% else %}
              暂无协作人员
            {% endif %}
          </div>
        </div>
      </div>
      {% endblock detail_basic_info_participants %}
    </div>
    {% endblock detail_basic_info_rows %}
  </div>
</div>
</div>
{% endblock detail_basic_info_card %}

{% block detail_status_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-status-info">
  <div class="detail-card detail-card-status-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-toggle-on"></i>
      状态信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_status_info %}
    <table class="detail-table">
      <tbody>
        {% block detail_status_timestamps %}
        {% block detail_status_timestamps_content %}
        {% endblock detail_status_timestamps_content %}
        {% endblock detail_status_timestamps %}
        
        {% block detail_status_history_separator %}
        {% endblock detail_status_history_separator %}
        
        {% block detail_status_history_header %}
        <tr class="detail-table-header-row">
          <th style="width: 60px;">序号</th>
          <th>状态变更</th>
          <th style="width: 120px;">变更人</th>
          <th style="width: 160px;">变更时间</th>
          <th>变更依据</th>
          <th>备注</th>
        </tr>
        {% endblock detail_status_history_header %}
        
        {% block detail_status_history %}
        {% block detail_status_history_content %}
        {% endblock detail_status_history_content %}
        {% endblock detail_status_history %}
      </tbody>
    </table>
    {% endblock detail_status_info %}
  </div>
</div>
</div>
{% endblock detail_status_info_card %}

{% block detail_related_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-related-info">
  <div class="detail-card detail-card-related-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-link"></i>
      关联信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_related_info %}
    <table class="detail-table">
      <thead>
        <tr>
          <th style="width: 60px;">序号</th>
          <th>类型/名称</th>
          <th>对象/地址</th>
          <th style="width: 160px;">时间</th>
          <th>说明/描述</th>
          <th>备注</th>
        </tr>
      </thead>
      <tbody>
        {% block detail_related_records_separator %}
        <tr class="detail-table-separator">
          <td colspan="6" style="padding: var(--spacing-md, 16px) 0; border-top: 2px solid var(--vh-border, #E0E0E0);">
            <strong style="font-size: var(--font-size-base, 16px); color: var(--vh-text, #000000);">关联记录</strong>
          </td>
        </tr>
        {% endblock detail_related_records_separator %}
        
        {% block detail_related_records %}
        {% block detail_related_records_content %}
        {% endblock detail_related_records_content %}
        {% endblock detail_related_records %}
        
        {% block detail_related_links_separator %}
        <tr class="detail-table-separator">
          <td colspan="6" style="padding: var(--spacing-md, 16px) 0; border-top: 2px solid var(--vh-border, #E0E0E0);">
            <strong style="font-size: var(--font-size-base, 16px); color: var(--vh-text, #000000);">相关链接</strong>
          </td>
        </tr>
        {% endblock detail_related_links_separator %}
        
        {% block detail_related_links %}
        {% block detail_related_links_content %}
        {% endblock detail_related_links_content %}
        {% endblock detail_related_links %}
      </tbody>
    </table>
    {% endblock detail_related_info %}
  </div>
</div>
</div>
{% endblock detail_related_info_card %}

{% block detail_audit_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-audit-info">
  <div class="detail-card detail-card-audit-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-file-alt"></i>
      审计信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_audit_info %}
    <table class="detail-table">
      <thead>
        <tr>
          <th style="width: 60px;">序号</th>
          <th style="width: 160px;">时间</th>
          <th style="width: 120px;">操作人</th>
          <th>类型/字段</th>
          <th>内容/原值</th>
          <th>新值</th>
          <th>备注</th>
        </tr>
      </thead>
      <tbody>
        {% block detail_audit_log_separator %}
        <tr class="detail-table-separator">
          <td colspan="7" style="padding: var(--spacing-md, 16px) 0; border-top: 2px solid var(--vh-border, #E0E0E0);">
            <strong style="font-size: var(--font-size-base, 16px); color: var(--vh-text, #000000);">审计日志</strong>
          </td>
        </tr>
        {% endblock detail_audit_log_separator %}
        
        {% block detail_audit_log %}
        {% block detail_audit_log_content %}
        {% endblock detail_audit_log_content %}
        {% endblock detail_audit_log %}
        
        {% block detail_modification_history_separator %}
        <tr class="detail-table-separator">
          <td colspan="7" style="padding: var(--spacing-md, 16px) 0; border-top: 2px solid var(--vh-border, #E0E0E0);">
            <strong style="font-size: var(--font-size-base, 16px); color: var(--vh-text, #000000);">修改记录</strong>
          </td>
        </tr>
        {% endblock detail_modification_history_separator %}
        
        {% block detail_modification_history %}
        {% block detail_modification_history_content %}
        {% endblock detail_modification_history_content %}
        {% endblock detail_modification_history %}
      </tbody>
    </table>
    {% endblock detail_audit_info %}
  </div>
</div>
</div>
{% endblock detail_audit_info_card %}

{% block detail_statistics_card %}
<div class="detail-card-wrapper detail-card-wrapper-statistics">
  <div class="detail-card detail-card-statistics">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-chart-bar"></i>
      数据与统计信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_statistics_content %}
    {% if progress_percentage %}
    <div class="mb-4">
      <h5 class="detail-subsection-title">进度</h5>
      <div class="detail-progress detail-progress-lg">
        <div class="detail-progress-bar" role="progressbar" 
             style="width: {{ progress_percentage }}%;" 
             aria-valuenow="{{ progress_percentage }}" 
             aria-valuemin="0" 
             aria-valuemax="100">
          {{ progress_percentage }}%
        </div>
      </div>
    </div>
    {% endif %}
    {% block detail_charts %}
    <div class="detail-charts">
      {% block detail_charts_content %}{% endblock %}
    </div>
    {% endblock detail_charts %}
    {% block detail_statistics_cards %}
    <div class="row">
      {% block detail_statistics_cards_content %}{% endblock %}
    </div>
    {% endblock detail_statistics_cards %}
    {% endblock detail_statistics_content %}
  </div>
</div>
</div>
{% endblock detail_statistics_card %}

{% block detail_attachments_card %}
<div class="detail-card-wrapper detail-card-wrapper-attachments">
  <div class="detail-card detail-card-attachments">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-paperclip"></i>
      附件与文件信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_attachments_content %}
    <div class="detail-attachments-list">
      {% if attachments %}
      <table class="detail-table attachment-table">
        <tbody>
          {% for attachment in attachments %}
          <tr>
            <th class="attachment-icon-cell">
              <div class="attachment-icon">
                {% if attachment.file_type == 'pdf' %}
                  <i class="fas fa-file-pdf"></i>
                {% elif attachment.file_type == 'image' %}
                  <i class="fas fa-file-image"></i>
                {% elif attachment.file_type == 'video' %}
                  <i class="fas fa-file-video"></i>
                {% elif attachment.file_type == 'word' %}
                  <i class="fas fa-file-word"></i>
                {% elif attachment.file_type == 'excel' %}
                  <i class="fas fa-file-excel"></i>
                {% else %}
                  <i class="fas fa-file"></i>
                {% endif %}
              </div>
            </th>
            <td class="attachment-name-cell">{{ attachment.name }}</td>
            <td class="attachment-meta-cell">
              <i class="fas fa-calendar"></i>
              {{ attachment.uploaded_at|date:"Y-m-d H:i" }}
            </td>
            <td class="attachment-actions-cell">
              <a href="{{ attachment.file.url }}" class="btn btn-sm btn-light" download>
                <i class="fas fa-download"></i>
                下载
              </a>
              {% if attachment.file_type == 'image' %}
              <button type="button" class="btn btn-sm btn-light" onclick="previewImage('{{ attachment.file.url }}')">
                <i class="fas fa-eye"></i>
                预览
              </button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <table class="detail-table">
        <tbody>
          <tr>
            <td colspan="4">
              <div class="detail-empty-state">暂无附件</div>
            </td>
          </tr>
        </tbody>
      </table>
      {% endif %}
    </div>
    {% endblock detail_attachments_content %}
  </div>
</div>
</div>
{% endblock detail_attachments_card %}

{% block detail_system_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-system-info">
  <div class="detail-card detail-card-system-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-cog"></i>
      系统信息
    </h3>
  </div>
  <div class="detail-card-body">
    <table class="detail-table">
      <tbody>
        {% block detail_system_info_table_rows %}
        <tr>
          <th>创建时间</th>
          <td>{% if object.created_time %}{{ object.created_time|date:"Y-m-d H:i:s" }}{% elif object.created_at %}{{ object.created_at|date:"Y-m-d H:i:s" }}{% else %}{% endif %}</td>
        </tr>
        <tr>
          <th>更新时间</th>
          <td>{% if object.updated_time %}{{ object.updated_time|date:"Y-m-d H:i:s" }}{% elif object.updated_at %}{{ object.updated_at|date:"Y-m-d H:i:s" }}{% else %}{% endif %}</td>
        </tr>
        {% if object.created_by %}
        <tr>
          <th>创建人</th>
          <td>{{ object.created_by.get_full_name|default:object.created_by.username }}</td>
        </tr>
        {% endif %}
        {% endblock detail_system_info_table_rows %}
      </tbody>
    </table>
  </div>
</div>
</div>
{% endblock detail_system_info_card %}
</div>
{% endblock pm_content %}

{% block module_extra_js %}
{{ block.super }}
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">确认删除</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>确定要删除此项吗？此操作不可恢复。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <form method="post" action="{% block detail_delete_url %}#{% endblock %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">确认删除</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function previewImage(imageUrl) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">图片预览</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <img src="${imageUrl}" class="img-fluid" alt="预览图片">
          </div>
          <div class="modal-footer">
            <a href="${imageUrl}" download class="btn btn-light">
              <i class="fas fa-download"></i> 下载图片
            </a>
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">关闭</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    modal.addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modal);
    });
  }
</script>
{% endblock module_extra_js %}