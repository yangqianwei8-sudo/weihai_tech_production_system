{% extends "shared/module_base.html" %}
{% load static %}
{# 
共享创建表单模板
继承 module_base.html，提供统一的创建表单结构

【重要布局规则 - 必须遵守】
============================================
1. 每排必须显示5个字段（使用 form-row-5 类和 col-5-fields 类）
   - 固定字段区域（强制要求）：responsible_department, responsible_person, plan_number/form_number/goal_number（共3个）
     * 这三个字段是所有继承此模板的表单的强制必需字段，必须显示在第一排的前三个位置
     * 如果表单类中没有这些字段，模板会报错，提示开发者必须添加
   - 第一排额外字段块（form_first_row_extra_fields）：最多添加2个字段，凑满5个字段
   - 其他字段行：使用 form-row-5 类时，每行必须包含5个 col-5-fields 字段
   - 如果字段不足5个，使用空的 <div class="col-5-fields form-field-wrapper"></div> 占位

2. 多行文本字段和多选字段占据整行
   - 多行文本字段（Textarea）使用 col-12，不使用 form-row-5
   - 多选字段（SelectMultiple）使用 col-12，不使用 form-row-5

3. 字段包装
   - 每个字段必须使用 form-field-wrapper 类包装
   - 格式：<div class="col-5-fields form-field-wrapper">...</div>

固定字段（强制要求，必须包含）：
1. 所属部门（responsible_department）- 默认值：当前用户所在部门（默认，不可修改）
2. 负责人（responsible_person）- 默认值：当前用户（默认，不可修改）
3. 表单编号（form_number/plan_number/goal_number 三者之一）- 根据业务模块自动生成

注意：所有继承此模板的表单必须包含以上三个固定字段，且这三个字段必须显示在第一排的前三个位置。
如果表单类中没有这些字段，模板会报错，提示开发者必须添加。

布局说明：
- 每行显示5个字段（使用 col-5-fields 自定义类）
- 多行文本字段（Textarea）占据整行（col-12）
- 多选字段（SelectMultiple）占据整行（col-12）
- 使用 form-field-wrapper 类包装每个字段

计划创建使用示例：
1. 在第一排添加额外字段：使用 form_first_row_extra_fields 块（最多2个字段，凑满5个）
2. 添加其他字段：使用 form_fields 块，每行使用 form-row-5 类时必须包含5个 col-5-fields 字段
3. 自定义按钮：使用 form_draft_actions 和 form_actions 块
4. 自定义操作按钮卡片：使用 form_header_actions_card 块（位于主副标题下方，可完全覆盖操作按钮卡片）
#}

{% block module_styles %}
  {{ block.super }}
{% endblock module_styles %}

{% block pm_title %}{% block form_title %}创建表单{% endblock form_title %}{% endblock pm_title %}
{% block pm_subtitle %}{% block form_subtitle %}请填写表单信息{% endblock form_subtitle %}{% endblock pm_subtitle %}
{% block pm_actions %}{% block form_header_actions %}
  {# 返回列表按钮：默认显示，可通过 list_url_name 或 cancel_url_name 配置列表URL #}
  {% if list_url %}
    <a href="{{ list_url }}" class="btn btn-secondary">
      返回列表
    </a>
  {% elif list_url_name %}
    <a href="{% url list_url_name %}" class="btn btn-secondary">
      返回列表
    </a>
  {% elif cancel_url_name %}
    <a href="{% url cancel_url_name %}" class="btn btn-secondary">
      返回列表
    </a>
  {% else %}
    {# 子模板可以覆盖此块来完全自定义，或提供默认列表URL #}
    <a href="{% url 'home' %}" class="btn btn-secondary">
      返回列表
    </a>
  {% endif %}
{% endblock form_header_actions %}{% endblock pm_actions %}




{% block pm_content %}
  {# ==================== 操作按钮卡片（主副标题下方） ==================== #}
  {% block form_header_actions_card %}
  <div class="form-card form-card-header-actions mb-3">
    <div class="form-card-body">
      <div class="form-actions d-flex justify-content-between align-items-center">
        {# 左侧：暂存草稿按钮 #}
        <div class="form-actions-left">
          {% block form_draft_actions %}
          <button type="button" class="btn btn-draft" id="headerDraftButton">暂存草稿</button>
          {% endblock %}
        </div>
        {# 右侧：创建和取消按钮 #}
        <div class="form-actions-right d-flex gap-2">
          {% block form_actions %}
          <button type="button" class="btn btn-primary" id="headerSubmitButton">创建</button>
          {% if list_url %}
            <a href="{{ list_url }}" class="btn btn-secondary">取消</a>
          {% elif list_url_name %}
            <a href="{% url list_url_name %}" class="btn btn-secondary">取消</a>
          {% elif cancel_url_name %}
            <a href="{% url cancel_url_name %}" class="btn btn-secondary">取消</a>
          {% else %}
            <a href="{% url 'home' %}" class="btn btn-secondary">取消</a>
          {% endif %}
          {% endblock %}
        </div>
      </div>
    </div>
  </div>
  {% endblock form_header_actions_card %}

<form method="post" class="create-form" id="createForm">
  {% csrf_token %}
  
  {# 隐藏的提交按钮（用于实际提交表单） #}
  <button type="submit" name="action" value="draft" class="d-none" id="hiddenDraftButton">暂存草稿</button>
  <button type="submit" class="d-none" id="hiddenSubmitButton">创建</button>
  
  {# 表单错误提示 #}
  {% if form.non_field_errors %}
  <div class="alert alert-danger">
    {{ form.non_field_errors }}
  </div>
  {% endif %}

  {# ==================== 卡片1：基本信息 ==================== #}
  {% block form_basic_info_card %}
  <div class="form-card form-card-basic-info">
    <div class="form-card-header">
      <h3 class="form-card-title">
        <i class="fas fa-info-circle"></i>
        基本信息
      </h3>
    </div>
    <div class="form-card-body">
      {# 第一排：固定字段区域 - 每排5个字段 - 这三个字段必须存在，否则模板会报错 #}
      <div class="row mb-3 form-row-5">
        {# 固定字段1：所属部门（默认，不可修改）- 必须字段 #}
        <div class="col-5-fields form-field-wrapper">
          <label for="{{ form.responsible_department.id_for_label }}" class="form-label">
            {% if form.responsible_department.label %}
              {% if "默认" in form.responsible_department.label or "不可修改" in form.responsible_department.label %}
                {{ form.responsible_department.label }}
              {% else %}
                {{ form.responsible_department.label }}（默认，不可修改）
              {% endif %}
            {% else %}
              所属部门（默认，不可修改）
            {% endif %}
            {% if form.responsible_department.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          {{ form.responsible_department }}
          {% if form.responsible_department.errors %}
          <div class="text-danger small">{{ form.responsible_department.errors }}</div>
          {% endif %}
          {% if form.responsible_department.help_text %}
          <div class="form-text">{{ form.responsible_department.help_text }}</div>
          {% endif %}
        </div>

        {# 固定字段2：负责人（默认，不可修改）- 必须字段 #}
        <div class="col-5-fields form-field-wrapper">
          <label for="{{ form.responsible_person.id_for_label }}" class="form-label">
            {% if form.responsible_person.label %}
              {% if "默认" in form.responsible_person.label or "不可修改" in form.responsible_person.label %}
                {{ form.responsible_person.label }}
              {% else %}
                {{ form.responsible_person.label }}（默认，不可修改）
              {% endif %}
            {% else %}
              负责人（默认，不可修改）
            {% endif %}
            {% if form.responsible_person.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          {{ form.responsible_person }}
          {% if form.responsible_person.errors %}
          <div class="text-danger small">{{ form.responsible_person.errors }}</div>
          {% endif %}
          {% if form.responsible_person.help_text %}
          <div class="form-text">{{ form.responsible_person.help_text }}</div>
          {% endif %}
        </div>

        {# 固定字段3：表单编号（支持多种字段名：form_number, plan_number, goal_number）- 必须字段 #}
        {% if form.form_number %}
        <div class="col-5-fields form-field-wrapper">
          <label for="{{ form.form_number.id_for_label }}" class="form-label">
            {{ form.form_number.label }}
            {% if form.form_number.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          {{ form.form_number }}
          {% if form.form_number.errors %}
          <div class="text-danger small">{{ form.form_number.errors }}</div>
          {% endif %}
          {% if form.form_number.help_text %}
          <div class="form-text">{{ form.form_number.help_text }}</div>
          {% endif %}
        </div>
        {% elif form.plan_number %}
        <div class="col-5-fields form-field-wrapper">
          <label for="{{ form.plan_number.id_for_label }}" class="form-label">
            {{ form.plan_number.label }}
            {% if form.plan_number.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          {{ form.plan_number }}
          {% if form.plan_number.errors %}
          <div class="text-danger small">{{ form.plan_number.errors }}</div>
          {% endif %}
          {% if form.plan_number.help_text %}
          <div class="form-text">{{ form.plan_number.help_text }}</div>
          {% endif %}
        </div>
        {% elif form.goal_number %}
        <div class="col-5-fields form-field-wrapper">
          <label for="{{ form.goal_number.id_for_label }}" class="form-label">
            {{ form.goal_number.label }}
            {% if form.goal_number.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          {{ form.goal_number }}
          {% if form.goal_number.errors %}
          <div class="text-danger small">{{ form.goal_number.errors }}</div>
          {% endif %}
          {% if form.goal_number.help_text %}
          <div class="form-text">{{ form.goal_number.help_text }}</div>
          {% endif %}
        </div>
        {% else %}
        {# 如果表单编号字段不存在，直接使用 form_number 会报错，提示开发者必须添加 form_number、plan_number 或 goal_number 字段之一 #}
        <div class="col-5-fields form-field-wrapper">
          {{ form.form_number }}
        </div>
        {% endif %}
        
        {# 第一排额外字段（最多2个，凑满5个字段） #}
        {% block form_first_row_extra_fields %}{% endblock %}
      </div>
      
      {# 第二排：基本信息其他字段（最多5个字段） #}
      {% block form_second_row_fields %}
      <div class="row mb-3 form-row-5">
        {% block form_second_row_extra_fields %}{% endblock %}
      </div>
      {% endblock form_second_row_fields %}
    </div>
  </div>
  {% endblock form_basic_info_card %}

  {# ==================== 卡片2：其他字段 ==================== #}
  {% block form_other_fields_card %}
  <div class="form-card form-card-other-fields">
    <div class="form-card-header">
      <h3 class="form-card-title">
        <i class="fas fa-list-alt"></i>
        详细信息
      </h3>
    </div>
    <div class="form-card-body">
      {# 其他表单字段 #}
      {% block form_fields %}{% endblock %}
    </div>
  </div>
  {% endblock form_other_fields_card %}

  {# ==================== 卡片3：审批流程配置（可选） ==================== #}
  {% block form_approval_workflow_card %}
  {% endblock form_approval_workflow_card %}

</form>
{% endblock pm_content %}

{% block module_extra_js %}
<script>
// 表单初始化处理
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('createForm');
  if (!form) return;
  
  // 处理禁用字段（如 responsible_department, responsible_person）
  const responsibleDeptField = form.querySelector('[name="responsible_department"]');
  if (responsibleDeptField && responsibleDeptField.hasAttribute('disabled')) {
    const hiddenDept = document.createElement('input');
    hiddenDept.type = 'hidden';
    hiddenDept.name = responsibleDeptField.name;
    hiddenDept.value = responsibleDeptField.value || '';
    form.appendChild(hiddenDept);
  }
  
  const responsiblePersonField = form.querySelector('[name="responsible_person"]');
  if (responsiblePersonField) {
    if (responsiblePersonField.hasAttribute('disabled')) {
      const hiddenPerson = document.createElement('input');
      hiddenPerson.type = 'hidden';
      hiddenPerson.name = responsiblePersonField.name;
      hiddenPerson.value = responsiblePersonField.value || '';
      form.appendChild(hiddenPerson);
    }
  }
  
  // 连接外部按钮和内部提交按钮
  const headerDraftButton = document.getElementById('headerDraftButton');
  const headerSubmitButton = document.getElementById('headerSubmitButton');
  const hiddenDraftButton = document.getElementById('hiddenDraftButton');
  const hiddenSubmitButton = document.getElementById('hiddenSubmitButton');
  
  if (headerDraftButton && hiddenDraftButton) {
    headerDraftButton.addEventListener('click', function() {
      hiddenDraftButton.click();
    });
  }
  
  if (headerSubmitButton && hiddenSubmitButton) {
    headerSubmitButton.addEventListener('click', function() {
      hiddenSubmitButton.click();
    });
  }
  
  // 表单验证
  form.addEventListener('submit', function(e) {
    // #region agent log
    fetch('http://localhost:7242/ingest/8da7066a-e0c2-4e09-9af7-37ab2ebaf22c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'create_form_base.html:262',message:'父模板表单提交事件触发',data:{submitterName:e.submitter?.name,submitterValue:e.submitter?.value,defaultPrevented:e.defaultPrevented,formAction:form.action,formMethod:form.method},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
    
    const clickedButton = e.submitter;
    const isDraft = clickedButton && clickedButton.name === 'action' && clickedButton.value === 'draft';
    
    // #region agent log
    fetch('http://localhost:7242/ingest/8da7066a-e0c2-4e09-9af7-37ab2ebaf22c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'create_form_base.html:267',message:'父模板判断是否为草稿',data:{isDraft:isDraft},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
    
    if (!isDraft) {
      const requiredFields = form.querySelectorAll('[required]');
      let hasError = false;
      
      // #region agent log
      fetch('http://localhost:7242/ingest/8da7066a-e0c2-4e09-9af7-37ab2ebaf22c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'create_form_base.html:272',message:'父模板检查必填字段',data:{requiredFieldsCount:requiredFields.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
      // #endregion
      
      requiredFields.forEach(function(field) {
        if (field.hasAttribute('disabled')) return;
        if (!field.value || field.value.trim() === '') {
          hasError = true;
          field.classList.add('is-invalid');
        } else {
          field.classList.remove('is-invalid');
        }
      });
      
      // #region agent log
      fetch('http://localhost:7242/ingest/8da7066a-e0c2-4e09-9af7-37ab2ebaf22c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'create_form_base.html:283',message:'父模板验证结果',data:{hasError:hasError},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
      // #endregion
      
      if (hasError) {
        // #region agent log
        fetch('http://localhost:7242/ingest/8da7066a-e0c2-4e09-9af7-37ab2ebaf22c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'create_form_base.html:286',message:'父模板阻止表单提交 - 必填字段验证失败',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
        // #endregion
        e.preventDefault();
        const firstError = form.querySelector('.is-invalid');
        if (firstError) {
          firstError.focus();
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return false;
      }
    }
    
    // #region agent log
    fetch('http://localhost:7242/ingest/8da7066a-e0c2-4e09-9af7-37ab2ebaf22c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'create_form_base.html:295',message:'父模板提交事件处理完成',data:{defaultPrevented:e.defaultPrevented,willSubmit:!e.defaultPrevented},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
    // #endregion
  });
});
</script>
{{ block.super }}
{% endblock module_extra_js %}
