{% comment %}
列设置JavaScript功能模板

使用方法：
在视图中定义 all_fields，然后在模板中引入：
{% include 'shared/_partials/column_settings_js.html' with 
    all_fields_json=all_fields_json
    storage_key='customer_list_columns'
%}

注意：all_fields_json 应该是 JSON 字符串格式
{% endcomment %}

<script>
// 字段定义配置
const ALL_FIELDS = {{ all_fields_json|safe|default:'[]' }};
const STORAGE_KEY = '{% if storage_key %}{{ storage_key }}{% else %}table_columns{% endif %}';
const REQUIRED_COLUMNS = {% if required_columns %}{{ required_columns|safe }}{% else %}['column-checkbox', 'column-actions']{% endif %};
const MODAL_ID = '{% if modal_id %}{{ modal_id }}{% else %}fieldsSettingsModal{% endif %}';

// 从localStorage加载列设置
function loadColumnSettings() {
    const saved = localStorage.getItem(STORAGE_KEY);
    const savedOrder = localStorage.getItem(STORAGE_KEY + '_order');
    
    if (saved) {
        try {
            const columns = JSON.parse(saved);
            Object.keys(columns).forEach(col => {
                const elements = document.querySelectorAll('.' + col);
                elements.forEach(el => {
                    if (el) {
                        el.style.display = columns[col] ? '' : 'none';
                    }
                });
            });
        } catch (e) {
            console.error('加载列设置失败:', e);
        }
    }
    
    // 应用列顺序
    if (savedOrder) {
        try {
            const order = JSON.parse(savedOrder);
            applyColumnOrder(order);
        } catch (e) {
            console.error('加载列顺序失败:', e);
        }
    }
}

// 保存列设置到localStorage
function saveColumnSettings() {
    const columns = {};
    REQUIRED_COLUMNS.forEach(col => {
        columns[col] = true;
    });
    
    document.querySelectorAll('[data-column]').forEach(checkbox => {
        const col = checkbox.dataset.column;
        if (col) {
            columns[col] = checkbox.checked;
        }
    });
    
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(columns));
        loadColumnSettings();
    } catch (e) {
        alert('保存设置失败，请检查浏览器是否支持本地存储');
    }
}

// 应用列顺序
function applyColumnOrder(order) {
    console.log('应用列顺序:', order);
}

// 初始化列设置模态框
function initColumnSettingsModal() {
    const saved = localStorage.getItem(STORAGE_KEY);
    const savedOrder = localStorage.getItem(STORAGE_KEY + '_order');
    
    let displayedColumns = [];
    if (saved && savedOrder) {
        try {
            const columns = JSON.parse(saved);
            const order = JSON.parse(savedOrder);
            displayedColumns = order.filter(col => columns[col] !== false);
        } catch (e) {
        }
    }
    
    if (displayedColumns.length === 0) {
        displayedColumns = ALL_FIELDS
            .filter(f => f.required || (saved && JSON.parse(saved)[f.column] !== false))
            .map(f => f.column);
    }
    
    REQUIRED_COLUMNS.forEach(col => {
        const index = displayedColumns.indexOf(col);
        if (index > -1) displayedColumns.splice(index, 1);
    });
    if (REQUIRED_COLUMNS.includes('column-checkbox')) {
        displayedColumns.unshift('column-checkbox');
    }
    if (REQUIRED_COLUMNS.includes('column-actions')) {
        displayedColumns.push('column-actions');
    }
    
    renderColumnSettings(displayedColumns);
    initDragAndDrop();
}

// 渲染列设置
function renderColumnSettings(displayedColumns) {
    const displayedFieldsContainer = document.getElementById('displayedFields');
    const availableFieldsContainer = document.getElementById('availableFields');
    
    if (!displayedFieldsContainer || !availableFieldsContainer) return;
    
    displayedFieldsContainer.textContent = '';
    availableFieldsContainer.textContent = '';
    
    const displayedSet = new Set(displayedColumns);
    
    displayedColumns.forEach(column => {
        const field = ALL_FIELDS.find(f => f.column === column);
        if (field) {
            const tag = createFieldTag(field, true);
            displayedFieldsContainer.appendChild(tag);
        }
    });
    
    ALL_FIELDS.forEach(field => {
        if (!displayedSet.has(field.column)) {
            const item = createFieldItem(field);
            availableFieldsContainer.appendChild(item);
        }
    });
}

// 创建字段标签
function createFieldTag(field, isDisplayed) {
    const tag = document.createElement('span');
    tag.className = 'badge bg-primary d-inline-flex align-items-center gap-1 me-2 mb-2';
    tag.style.cursor = isDisplayed && !field.required ? 'move' : 'default';
    tag.draggable = isDisplayed && !field.required;
    tag.dataset.column = field.column;
    tag.innerHTML = field.label + (field.required ? '' : '<button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.65em;" onclick="removeField(\'' + field.column + '\')"></button>');
    
    if (tag.draggable) {
        tag.addEventListener('dragstart', handleDragStart);
        tag.addEventListener('dragover', handleDragOver);
        tag.addEventListener('drop', handleDrop);
        tag.addEventListener('dragend', handleDragEnd);
    }
    
    return tag;
}

// 创建字段项
function createFieldItem(field) {
    const item = document.createElement('div');
    item.className = 'd-flex align-items-center justify-content-between p-2 border rounded mb-2';
    item.innerHTML = '<span>' + field.label + '</span><button type="button" class="btn btn-sm btn-link p-0" onclick="addField(\'' + field.column + '\')"><i class="bi bi-plus-circle"></i></button>';
    return item;
}

// 添加字段
function addField(column) {
    const saved = localStorage.getItem(STORAGE_KEY);
    const savedOrder = localStorage.getItem(STORAGE_KEY + '_order');
    
    let displayedColumns = [];
    if (savedOrder) {
        try {
            displayedColumns = JSON.parse(savedOrder);
            REQUIRED_COLUMNS.forEach(col => {
                const index = displayedColumns.indexOf(col);
                if (index > -1) displayedColumns.splice(index, 1);
            });
        } catch (e) {
        }
    }
    
    if (!displayedColumns.includes(column)) {
        displayedColumns.push(column);
        if (REQUIRED_COLUMNS.includes('column-checkbox')) {
            displayedColumns.unshift('column-checkbox');
        }
        if (REQUIRED_COLUMNS.includes('column-actions')) {
            displayedColumns.push('column-actions');
        }
        localStorage.setItem(STORAGE_KEY + '_order', JSON.stringify(displayedColumns));
        
        const columns = saved ? JSON.parse(saved) : {};
        columns[column] = true;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(columns));
        
        renderColumnSettings(displayedColumns);
        initDragAndDrop();
    }
}

// 移除字段
function removeField(column) {
    const field = ALL_FIELDS.find(f => f.column === column);
    if (field && field.required) return;
    
    const saved = localStorage.getItem(STORAGE_KEY);
    const savedOrder = localStorage.getItem(STORAGE_KEY + '_order');
    
    let displayedColumns = [];
    if (savedOrder) {
        try {
            displayedColumns = JSON.parse(savedOrder);
        } catch (e) {
        }
    }
    
    displayedColumns = displayedColumns.filter(col => col !== column);
    localStorage.setItem(STORAGE_KEY + '_order', JSON.stringify(displayedColumns));
    
    const columns = saved ? JSON.parse(saved) : {};
    columns[column] = false;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(columns));
    
    renderColumnSettings(displayedColumns);
    initDragAndDrop();
}

// 拖动相关
let draggedElement = null;

function initDragAndDrop() {
    // 已通过事件监听器绑定
}

function handleDragStart(e) {
    draggedElement = this;
    this.style.opacity = '0.5';
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    if (draggedElement !== this) {
        const container = this.parentNode;
        const allElements = Array.from(container.children);
        const draggedIndex = allElements.indexOf(draggedElement);
        const targetIndex = allElements.indexOf(this);
        
        if (draggedIndex < targetIndex) {
            container.insertBefore(draggedElement, this.nextSibling);
        } else {
            container.insertBefore(draggedElement, this);
        }
        
        const displayedColumns = Array.from(container.children).map(el => el.dataset.column);
        localStorage.setItem(STORAGE_KEY + '_order', JSON.stringify(displayedColumns));
    }
    
    return false;
}

function handleDragEnd(e) {
    this.style.opacity = '';
}

// 重置字段设置
function resetFieldsSettings() {
    if (confirm('确定要重置为默认设置吗？')) {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(STORAGE_KEY + '_order');
        initColumnSettingsModal();
        loadColumnSettings();
    }
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadColumnSettings();
    initColumnSettingsModal();
    
    document.getElementById('saveFieldsSettings')?.addEventListener('click', function() {
        saveColumnSettings();
        const modal = bootstrap.Modal.getInstance(document.getElementById(MODAL_ID));
        if (modal) modal.hide();
    });
    
    document.getElementById('resetFieldsSettings')?.addEventListener('click', resetFieldsSettings);
    
    const fieldsSettingsModal = document.getElementById(MODAL_ID);
    if (fieldsSettingsModal) {
        fieldsSettingsModal.addEventListener('shown.bs.modal', function() {
            initColumnSettingsModal();
        });
    }
});
</script>
