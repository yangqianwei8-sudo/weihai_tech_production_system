{% load static %}
{% comment %}
  侧边栏样式引入
  注意：sidebar_v2_fixed.css 依赖 --navbar-height 变量，需确保已引入 core/variables.css
  通常通过 common.css 或 two_column_layout_base.html 中的 base_styles 块引入
  样式按需加载，只在需要侧边栏的页面加载，避免在不需要侧边栏的页面也加载样式
{% endcomment %}
<link rel="stylesheet" href="{% static 'css/components/sidebar_v2_fixed.css' %}">

<aside class="vh-sb" aria-label="左侧栏（全屏固定）">
  <div class="vh-sb__top">
    <div class="vh-sb__topInner">
      <div class="vh-sb__titleWrap">
        {% if sidebar_title %}
          <div class="vh-sb__title">{{ sidebar_title }}</div>
        {% endif %}
        {% if sidebar_subtitle %}
          <div class="vh-sb__sub">{{ sidebar_subtitle }}</div>
        {% endif %}
      </div>

      {% block sidebar_top_extra %}{% endblock %}
    </div>
  </div>

  <nav class="vh-sb__nav">
    {% with menu_items=sidebar_nav|default:sidebar_menu|default:None %}
      {% if menu_items %}
        {% for item in menu_items %}
          {% if item.children %}
            <div class="vh-sb__parent" data-sb-parent data-sb-key="{{ forloop.counter }}-{{ item.label }}">
              <button type="button"
                      class="vh-sb__item vh-sb__item--parent {% if item.active %}is-active{% endif %}"
                      data-sb-toggle
                      aria-expanded="false">
                <span class="vh-sb__icon">
                  {% if item.icon and item.icon|slice:":3" == "fa-" %}
                    <i class="fas {{ item.icon }}"></i>
                  {% elif item.icon %}
                    {{ item.icon|default:"▢" }}
                  {% else %}
                    ▢
                  {% endif %}
                </span>
                <span class="vh-sb__label">{{ item.label }}</span>
                <span class="vh-sb__chev" aria-hidden="true">▸</span>
              </button>

              <div class="vh-sb__children" data-sb-children>
                {% for child in item.children %}
                  <a href="{{ child.url|default:'#' }}" class="vh-sb__child {% if child.active %}is-active{% endif %}">
                    <span class="vh-sb__icon">
                      {% if child.icon and child.icon|slice:":3" == "fa-" %}
                        <i class="fas {{ child.icon }}"></i>
                      {% elif child.icon %}
                        {{ child.icon|default:"·" }}
                      {% else %}
                        ·
                      {% endif %}
                    </span>
                    <span class="vh-sb__label">{{ child.label }}</span>
                  </a>
                {% endfor %}
              </div>
            </div>
          {% else %}
            <a href="{{ item.url|default:'#' }}" class="vh-sb__item {% if item.active %}is-active{% endif %}">
              <span class="vh-sb__icon">
                {% if item.icon and item.icon|slice:":3" == "fa-" %}
                  <i class="fas {{ item.icon }}"></i>
                {% elif item.icon %}
                  {{ item.icon|default:"▢" }}
                {% else %}
                  ▢
                {% endif %}
              </span>
              <span class="vh-sb__label">{{ item.label }}</span>
              {% if item.badge %}
                <span class="vh-sb__badge {% if item.badge == 'dot' %}vh-sb__badge--dot{% endif %}">
                  {{ item.badge }}
                </span>
              {% endif %}
            </a>
          {% endif %}
        {% endfor %}
      {% else %}
        <a href="/" class="vh-sb__item is-active">
          <span class="vh-sb__icon">▣</span>
          <span class="vh-sb__label">首页</span>
        </a>
      {% endif %}
    {% endwith %}

    {% block sidebar_nav_extra %}{% endblock %}
  </nav>

  <div class="vh-sb__bottom">
    <div class="vh-sb__mini">帮助</div>
    <div class="vh-sb__mini">设置</div>
    <div class="vh-sb__mini" onclick="(function() {
  try {
    const modal = document.getElementById('feedbackModal');
    if (!modal) {
      console.error('反馈模态框未找到，请检查页面是否包含反馈表单模板');
      alert('反馈功能暂时不可用，请刷新页面后重试');
      return;
    }
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
    } else if (typeof $ !== 'undefined' && $.fn.modal) {
      // jQuery Bootstrap 3 兼容
      $(modal).modal('show');
    } else {
      console.error('Bootstrap未加载，无法打开反馈弹窗');
      alert('页面资源加载异常，请刷新页面后重试');
    }
  } catch (e) {
    console.error('打开反馈弹窗时出错：', e);
    alert('打开反馈功能时出错，请刷新页面后重试');
  }
})();" style="cursor: pointer;">反馈</div>

    {% block sidebar_bottom_extra %}{% endblock %}
  </div>
</aside>
