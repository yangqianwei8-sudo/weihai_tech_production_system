{% comment %}
统一的顶部导航菜单组件
所有模块都应该使用这个组件来保持一致性
横向布局，固定在顶部
{% endcomment %}
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'home' %}">
            <i class="bi bi-building"></i> 维海科技
        </a>
        <div class="navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'home' %}">首页</a>
                </li>
                {% if full_top_nav %}
                {% for item in full_top_nav %}
                <li class="nav-item">
                    {% if item.url and item.url != '#' %}
                    <a class="nav-link {% if request.path == item.url or request.path|slice:':20' == item.url|slice:':20' %}active{% endif %}" href="{{ item.url }}">
                        {{ item.label }}
                    </a>
                    {% else %}
                    <span class="nav-link text-muted" style="cursor: not-allowed;" title="功能开发中">
                        {{ item.label }}
                    </span>
                    {% endif %}
                </li>
                {% endfor %}
                {% endif %}
            </ul>
            <ul class="navbar-nav">
                {% if user.is_authenticated %}
                <li class="nav-item">
                    <span class="nav-link">{{ user.get_full_name|default:user.username }}</span>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'logout' %}">退出</a>
                </li>
                {% else %}
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">
                        <i class="bi bi-box-arrow-in-right"></i> 登录
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

{% if not user.is_authenticated %}
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="loginModalLabel">
                    <i class="bi bi-box-arrow-in-right"></i> 系统登录
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="topNavLoginForm" method="post" action="{% url 'login' %}">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path|default:'/' }}">

                    <div class="mb-3">
                        <label for="topNavUsername" class="form-label">
                            <i class="bi bi-person"></i> 用户名
                        </label>
                        <input type="text" class="form-control" id="topNavUsername" name="username"
                               placeholder="请输入用户名" required autofocus>
                    </div>

                    <div class="mb-3">
                        <label for="topNavPassword" class="form-label">
                            <i class="bi bi-lock"></i> 密码
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="topNavPassword" name="password"
                                   placeholder="请输入密码" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleTopNavPassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="topNavRememberMe" name="remember_me">
                        <label class="form-check-label" for="topNavRememberMe">
                            记住我
                        </label>
                    </div>

                    <div id="topNavLoginError" class="alert alert-danger d-none" role="alert"></div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" id="topNavLoginBtn">
                            <i class="bi bi-box-arrow-in-right"></i> 登录
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <small class="text-muted">
                    <i class="bi bi-shield-check"></i> 安全登录 · 数据加密传输
                </small>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const loginForm = document.getElementById('topNavLoginForm');
    const loginBtn = document.getElementById('topNavLoginBtn');
    const passwordToggle = document.getElementById('toggleTopNavPassword');
    const passwordInput = document.getElementById('topNavPassword');
    const errorDiv = document.getElementById('topNavLoginError');

    // 密码显示/隐藏
    if (passwordToggle && passwordInput) {
        passwordToggle.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            const icon = this.querySelector('i');
            icon.classList.toggle('bi-eye');
            icon.classList.toggle('bi-eye-slash');
        });
    }

    // 表单提交
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const username = document.getElementById('topNavUsername').value.trim();
            const password = passwordInput.value;

            if (!username || !password) {
                showError('请输入用户名和密码');
                return;
            }

            // 显示加载状态
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>登录中...';
            errorDiv.classList.add('d-none');

            // 提交表单
            const formData = new FormData(loginForm);

            fetch(loginForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.redirected) {
                    // 登录成功，刷新页面
                    window.location.href = response.url;
                    return;
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    if (data.success) {
                        // 登录成功，关闭模态框并刷新页面
                        const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                        if (loginModal) {
                            loginModal.hide();
                        }
                        window.location.href = data.redirect || '/';
                    } else {
                        // 显示错误消息
                        showError(data.error || '登录失败，请检查用户名和密码');
                    }
                }
            })
            .catch(error => {
                console.error('Login error:', error);
                showError('登录失败，请稍后重试');
            })
            .finally(() => {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> 登录';
            });
        });
    }

    function showError(message) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('d-none');
    }

    // 模态框关闭时清除表单
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
        loginModal.addEventListener('hidden.bs.modal', function() {
            loginForm.reset();
            errorDiv.classList.add('d-none');
            passwordInput.setAttribute('type', 'password');
            const icon = passwordToggle.querySelector('i');
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        });
    }
})();
</script>
{% endif %}
        </div>
    </div>
</nav>
