{% load static %}
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>{% block title %}维海生产系统{% endblock title %}</title>
  <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">

  <!-- 只引入 common.css，它已经包含了所有必要的样式 -->
  <link rel="stylesheet" href="{% static 'css/common.css' %}">

  <!-- Bootstrap CDN 备用加载脚本（完全动态加载，修复 SSL 错误） -->
  <script>
    // Bootstrap CDN 备用加载脚本（完全动态加载，修复 SSL 错误）
    (function() {
      var bootstrapCDNs = {
        css: [
          '{% static "css/bootstrap.min.css" %}',
          'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css',
          'https://unpkg.com/bootstrap@5.3.0/dist/css/bootstrap.min.css',
          'https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css',
          'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css',
          'https://cdn.staticfile.org/bootstrap/5.3.0/css/bootstrap.min.css'
        ],
        icons: [
          '{% static "css/bootstrap-icons.min.css" %}',
          'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css',
          'https://unpkg.com/bootstrap-icons@1.11.0/font/bootstrap-icons.css',
          'https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.11.0/font/bootstrap-icons.min.css',
          'https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.0/font/bootstrap-icons.min.css',
          'https://cdn.staticfile.org/bootstrap-icons/1.11.0/font/bootstrap-icons.min.css'
        ],
        js: [
          '{% static "js/bootstrap.bundle.min.js" %}',
          'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js',
          'https://unpkg.com/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js',
          'https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js',
          'https://cdn.staticfile.org/bootstrap/5.3.0/js/bootstrap.bundle.min.js'
        ]
      };
      
      // 检测资源是否真正加载成功
      function checkResourceLoaded(url, type) {
        return new Promise(function(resolve, reject) {
          if (type === 'css' || type === 'icons') {
            // 对于 CSS，检查样式表是否已加载
            var sheets = document.styleSheets;
            for (var i = 0; i < sheets.length; i++) {
              try {
                if (sheets[i].href && (sheets[i].href.indexOf('bootstrap') !== -1 || sheets[i].href === url)) {
                  resolve(true);
                  return;
                }
              } catch (e) {
                // 跨域样式表可能无法访问
              }
            }
            // 尝试通过 fetch 检测（使用 no-cors 模式避免 CORS 问题）
            fetch(url, {method: 'HEAD', mode: 'no-cors'})
              .then(function() { resolve(true); })
              .catch(function() { 
                // 即使 fetch 失败，也可能是因为 CORS，所以检查样式表数量
                setTimeout(function() {
                  var newSheetsCount = document.styleSheets.length;
                  if (newSheetsCount > sheets.length) {
                    resolve(true);
                  } else {
                    reject(false);
                  }
                }, 1000);
              });
          } else {
            // 对于 JS，检查全局对象
            if (window.bootstrap) {
              resolve(true);
            } else {
              reject(false);
            }
          }
        });
      }
      
      function loadResource(type, urls, index) {
        index = index || 0;
        if (index >= urls.length) {
          console.error('Bootstrap ' + type + ' 加载失败：所有 CDN 均不可用。请检查网络连接或联系管理员。');
          return;
        }
        
        var url = urls[index];
        var element;
        
        if (type === 'css' || type === 'icons') {
          element = document.createElement('link');
          element.rel = 'stylesheet';
          element.href = url;
          
          element.onload = function() {
            // 验证资源是否真正可用
            setTimeout(function() {
              checkResourceLoaded(url, type).catch(function() {
                // 验证失败，但 onload 已触发，可能是误报
              });
            }, 100);
          };
          
          element.onerror = function() {
            if (this.parentNode) {
              this.parentNode.removeChild(this);
            }
            loadResource(type, urls, index + 1);
          };
          
          document.head.appendChild(element);
          
          // 主动检测：如果 5 秒后资源仍未加载，尝试备用 CDN
          setTimeout(function() {
            if (element.parentNode) {
              checkResourceLoaded(url, type)
                .then(function() {
                  // 资源已加载成功
                })
                .catch(function() {
                  // 资源未加载，切换到备用 CDN
                  if (element.parentNode) {
                    element.parentNode.removeChild(element);
                    loadResource(type, urls, index + 1);
                  }
                });
            }
          }, 5000);
          
        } else if (type === 'js') {
          element = document.createElement('script');
          element.src = url;
          
          element.onload = function() {
            // JS 加载成功
          };
          
          element.onerror = function() {
            if (this.parentNode) {
              this.parentNode.removeChild(this);
            }
            loadResource(type, urls, index + 1);
          };
          
          // JS 可以添加到 head 或 body，优先添加到 head（在 head 中执行时）
          // 如果 body 已存在且不在 head 中执行，添加到 body；否则添加到 head
          if (document.body && document.readyState !== 'loading') {
            document.body.appendChild(element);
          } else {
            document.head.appendChild(element);
          }
        }
      }
      
      // 立即加载 CSS、Icons 和 JS（不等待 window.load），确保资源尽早加载
      // 注意：如果 common.css 已包含 Bootstrap 样式，这些加载会被忽略或作为备用
      loadResource('css', bootstrapCDNs.css);
      loadResource('icons', bootstrapCDNs.icons);
      loadResource('js', bootstrapCDNs.js);
      
      // 监听全局错误事件，捕获 SSL 错误
      window.addEventListener('error', function(e) {
        if (e.filename && e.filename.indexOf('bootstrap') !== -1) {
          // SSL 错误或其他错误，备用 CDN 会自动处理
        }
      }, true);
      
      // 将 loadResource 函数暴露到全局，供底部脚本使用
      window.loadBootstrapResource = function(type, urls, index) {
        loadResource(type, urls, index);
      };
      window.bootstrapCDNs = bootstrapCDNs;
    })();
  </script>

  <!-- 自定义样式变量 -->
  <style>
    :root {
      --sidebar-width: {% block sidebar_width %}232px{% endblock sidebar_width %};
      --navbar-height: 62px; /* 顶部导航栏高度 */

      /* 主题变量 */
      --vh-bg-primary: #FFFFFF;
      --vh-bg-secondary: #F5F5F5;
      --vh-bg-tertiary: #E8E8E8;

      --vh-text-primary: #1A1A1A;
      --vh-text-secondary: #333333;
      --vh-text-tertiary: #666666;
      --vh-text-muted: #999999;

      --vh-border-primary: #000000;
      --vh-border-secondary: #E0E0E0;
      --vh-border-tertiary: #CCCCCC;

      --vh-hover-bg: #F5F5F5;
      --vh-active-bg: #E8E8E8;
      --vh-selected-bg: #E0E0E0;

      --vh-card-bg: #FFFFFF;
      --vh-card-border: #E0E0E0;
      --vh-card-shadow: rgba(0, 0, 0, 0.1);

      --vh-sidebar-bg: #F5F5F5;
      --vh-sidebar-border: #E0E0E0;

      --vh-divider: #E0E0E0;
      --vh-overlay: rgba(0, 0, 0, 0.5);
    }

    /* 主标题和副标题与左边栏的距离 */
    .two-col-content > .d-flex.align-items-end.justify-content-between {
      padding-left: 8px !important;
    }
    
    /* ===== 下划线样式 ===== */
    /* 已移除：下划线样式定义已删除 */

    /* 确保 body 在有两栏布局时不滚动 */
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    /* 两栏布局容器激活标志 */
    body.two-column-layout-active {
      overflow-y: hidden !important;
      height: 100% !important;
    }

    /* 统计卡片排版：无论几张卡片，一行排满全部卡片，平均分布 */
    /* 自动识别统计卡片容器，使用 flexbox 实现平均分布 */
    .two-col-content .row:has([class*="col"]:first-child) {
      display: flex !important;
      flex-wrap: nowrap !important;
      gap: 16px !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
      width: 100% !important;
    }

    .two-col-content .row:has([class*="col"]:first-child) > [class*="col"] {
      flex: 1 1 0 !important;
      min-width: 0 !important;
      max-width: 100% !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
      margin-bottom: 0 !important;
      width: auto !important;
    }

    /* 兼容性方案：使用类名 stats-cards-auto-layout */
    .row.stats-cards-auto-layout,
    .stats-cards-container.row {
      display: flex !important;
      flex-wrap: nowrap !important;
      gap: 16px !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
      width: 100% !important;
    }

    .row.stats-cards-auto-layout > *,
    .stats-cards-container.row > *,
    .row.stats-cards-auto-layout > [class*="col"],
    .stats-cards-container.row > [class*="col"] {
      flex: 1 1 0 !important;
      min-width: 0 !important;
      max-width: 100% !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
      margin-bottom: 0 !important;
      width: auto !important;
    }
  </style>

  {% block extra_head %}
    {% block extra_css %}{% endblock extra_css %}
  {% endblock extra_head %}
</head>

<body class="two-column-layout-active">
  <!-- 顶部导航栏 -->
  {% block top_nav %}
    {% include "shared/_top_nav.html" %}
  {% endblock top_nav %}

  <!-- 两栏布局容器 -->
  <div class="two-column-layout">
    <!-- 左边栏 -->
    {% block sidebar %}
      {% block sidebar_content %}
        {% include "shared/sidebar_v2_wireframe_fixed.html" %}
      {% endblock sidebar_content %}
    {% endblock sidebar %}

    <!-- 主内容区 -->
    <main class="two-col-main">
      {% block content %}
        <div class="two-col-content">
          {% block page_header %}
            <div class="d-flex align-items-end justify-content-between">
              <div style="flex: 1; min-width: 0;">
                <h1 class="h3">{% block page_title %}{% endblock page_title %}</h1>
                {% block page_subtitle %}{% endblock page_subtitle %}
              </div>
              <div class="d-flex gap-2">
                {% block page_actions %}{% endblock page_actions %}
              </div>
            </div>
          {% endblock page_header %}

          {% block content_inner %}{% endblock content_inner %}
        </div>
      {% endblock content %}
    </main>
  </div>

  <!-- JavaScript 资源 -->
  {% block base_scripts %}
    <!-- Bootstrap JS 动态加载脚本（使用完善的资源检测和备用 CDN） -->
    <script>
      (function() {
        // 如果 head 中的脚本已暴露函数，使用它；否则使用本地实现
        var loadResource = window.loadBootstrapResource;
        var bootstrapCDNs = window.bootstrapCDNs || {
          js: [
            '{% static "js/bootstrap.bundle.min.js" %}',
            'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js',
            'https://unpkg.com/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js',
            'https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js',
            'https://cdn.staticfile.org/bootstrap/5.3.0/js/bootstrap.bundle.min.js'
          ]
        };
        
        // 如果 head 中已暴露函数，直接使用
        if (loadResource) {
          // 延迟检测 Bootstrap JS 是否加载成功（给本地文件加载时间）
          // 先等待一段时间，如果仍未加载，再尝试备用 CDN
          setTimeout(function() {
            if (!window.bootstrap) {
              console.warn('检测到 Bootstrap JS 未加载，尝试加载备用 CDN...');
              loadResource('js', bootstrapCDNs.js);
            }
          }, 2000); // 等待 2 秒，给本地文件加载时间
          
          // 页面加载完成后再次检测（作为备用检查）
          window.addEventListener('load', function() {
            setTimeout(function() {
              if (!window.bootstrap) {
                console.warn('页面加载完成后检测到 Bootstrap JS 未加载，尝试加载备用 CDN...');
                loadResource('js', bootstrapCDNs.js);
              }
            }, 1000);
          });
        } else {
          // 备用实现（如果 head 脚本未执行）
          function loadBootstrapJS(urls, index) {
            index = index || 0;
            if (index >= urls.length) {
              console.error('Bootstrap JS 加载失败：所有 CDN 均不可用。请检查网络连接或联系管理员。');
              return;
            }
            
            var url = urls[index];
            var element = document.createElement('script');
            element.src = url;
            
            element.onload = function() {
              // JS 加载成功
            };
            
            element.onerror = function() {
              if (this.parentNode) {
                this.parentNode.removeChild(this);
              }
              loadBootstrapJS(urls, index + 1);
            };
            
            document.body.appendChild(element);
          }
          
          // 延迟检测 Bootstrap JS 是否加载成功（给本地文件加载时间）
          setTimeout(function() {
            if (!window.bootstrap) {
              console.warn('检测到 Bootstrap JS 未加载，尝试加载备用 CDN...');
              loadBootstrapJS(bootstrapCDNs.js);
            }
          }, 2000); // 等待 2 秒，给本地文件加载时间
          
          // 页面加载完成后再次检测（作为备用检查）
          window.addEventListener('load', function() {
            setTimeout(function() {
              if (!window.bootstrap) {
                console.warn('页面加载完成后检测到 Bootstrap JS 未加载，尝试加载备用 CDN...');
                loadBootstrapJS(bootstrapCDNs.js);
              }
            }, 1000);
          });
        }
      })();
    </script>
  {% endblock base_scripts %}

  {% block extra_js %}
    <!-- 左侧栏子菜单切换脚本 -->
    <script src="{% static 'js/components/sidebar_submenu_toggle.js' %}"></script>
  {% endblock extra_js %}

  {% if notification_widget_enabled %}
    <!-- 通知组件脚本 -->
    <script src="{% static 'js/notification_widget.js' %}"></script>
  {% endif %}

  {% block extra_scripts %}{% endblock extra_scripts %}
</body>
</html>

