{% extends "shared/module_base.html" %}
{% load static %}
{# 
共享详情页面模板
继承 module_base.html，提供统一的详情页面结构
使用说明：
1. 在子模板中覆盖相应的 block 来自定义内容
2. 通过 context 传递对象数据（object 或自定义变量名）
3. 使用 permission_codes 控制权限显示
主要块：
- detail_title: 页面标题
- detail_subtitle: 页面副标题
- detail_header_actions: 页面头部操作按钮
- detail_basic_info: 基本信息展示区域
- detail_properties: 对象属性展示区域
- detail_actions: 操作按钮区域
- detail_history: 历史记录区域
- detail_related: 相关对象区域
- detail_attachments: 附件展示区域
- detail_statistics: 数据和统计信息区域
#}
{% block module_styles %}
  {{ block.super }}
  {# detail_base.css 不存在，样式已内联在模板的 <style> 标签中 #}
  <style>
    /* 卡片包裹容器样式 */
    .detail-card-wrapper {
      margin-bottom: 24px;
    }
    
    @media (max-width: 768px) {
      .detail-card-wrapper {
        margin-bottom: 16px;
      }
    }
    
    /* 确保详情页面容器不会过宽，保持两栏布局的约束 */
    .detail-page-container {
      max-width: 100%;
      width: 100%;
    }
</style>
{% endblock module_styles %}
{% block pm_title %}{% block detail_title %}详情页面{% endblock detail_title %}{% endblock pm_title %}
{% block pm_subtitle %}{% block detail_subtitle %}查看详细信息{% endblock detail_subtitle %}{% endblock pm_subtitle %}
{% block pm_actions %}{% block detail_header_actions %}{% endblock detail_header_actions %}{% endblock pm_actions %}
{% block pm_content %}
<div class="detail-page-container">
  
    {# ==================== 操作按钮区域（位于标题栏下方）==================== #}
  <div class="detail-actions-bar mb-3">
    <div class="detail-actions-container">
      {% block detail_actions %}
      {# 编辑按钮 #}
      {% block detail_edit_button %}
      {% if can_edit %}
      <a href="{% block detail_edit_url %}#{% endblock %}" class="btn btn-primary">
        <i class="fas fa-edit"></i>
        编辑
      </a>
      {% endif %}
      {% endblock detail_edit_button %}
      {# 删除按钮 #}
      {% block detail_delete_button %}
      {% if can_delete %}
      <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
        <i class="fas fa-trash"></i>
        删除
      </button>
      {% endif %}
      {% endblock detail_delete_button %}
      {# 审批按钮 #}
      {% block detail_approval_button_header %}
      {% if can_approve %}
      <a href="{% block detail_approval_url %}#{% endblock %}" class="btn btn-warning">
        <i class="fas fa-check-circle"></i>
        审批
      </a>
      {% endif %}
      {% endblock detail_approval_button_header %}
      {# 其他动作按钮 #}
      {% block detail_other_actions_header %}{% endblock %}
      {% block detail_other_actions %}{% endblock %}
      {% endblock detail_actions %}
    </div>
  </div>


{# ==================== 卡片1：基本信息 ==================== #}
{% block detail_basic_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-basic-info">
  <div class="detail-card detail-card-basic-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-info-circle"></i>
      基本信息
    </h3>
  </div>
  <div class="detail-card-body">
    {# 第一排：计划编号、计划名称、计划层级、计划周期、计划状态（5个字段） #}
    <div class="row mb-3 form-row-5">
      {% block detail_basic_info_row1 %}
      {# 计划编号 #}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划编号</label>
          <div class="detail-field-value">
            {% if object.plan_number %}{{ object.plan_number }}{% elif object.id %}{{ object.id }}{% else %}N/A{% endif %}
          </div>
        </div>
      </div>
      {# 计划名称 #}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划名称</label>
          <div class="detail-field-value">
            {% if object.name %}{{ object.name }}{% elif object.title %}{{ object.title }}{% else %}N/A{% endif %}
          </div>
        </div>
      </div>
      {# 计划层级 #}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划层级</label>
          <div class="detail-field-value">
            {% if object.level %}{{ object.get_level_display|default:object.level }}{% else %}N/A{% endif %}
          </div>
        </div>
      </div>
      {# 计划周期 #}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划周期</label>
          <div class="detail-field-value">
            {% if object.plan_period %}{{ object.get_plan_period_display|default:object.plan_period }}{% else %}N/A{% endif %}
          </div>
        </div>
      </div>
      {# 计划状态 #}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划状态</label>
          <div class="detail-field-value">
            {% if object.status %}
              <span class="badge badge-status badge-{{ object.status }}">
                {{ object.get_status_display|default:object.status }}
              </span>
            {% else %}N/A{% endif %}
          </div>
        </div>
      </div>
      {% endblock detail_basic_info_row1 %}
    </div>
    
    {# 第二排：关联战略目标、父计划、关联项目（3个字段 + 2个空占位符 = 5个位置） #}
    <div class="row mb-3 form-row-5">
      {% block detail_basic_info_row2 %}
      {# 关联战略目标 #}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">关联战略目标</label>
          <div class="detail-field-value">
            {% if object.related_goal %}{{ object.related_goal.name }}{% else %}N/A{% endif %}
          </div>
        </div>
      </div>
      {# 父计划 #}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">父计划</label>
          <div class="detail-field-value">
            {% if object.parent_plan %}{{ object.parent_plan.name }}{% else %}N/A{% endif %}
          </div>
        </div>
      </div>
      {# 关联项目 #}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">关联项目</label>
          <div class="detail-field-value">
            {% if object.related_project %}{{ object.related_project }}{% else %}N/A{% endif %}
          </div>
        </div>
      </div>
      {# 空占位符，凑满5个字段 #}
      <div class="col-5-fields detail-field-wrapper"></div>
      <div class="col-5-fields detail-field-wrapper"></div>
      {% endblock detail_basic_info_row2 %}
    </div>
    
    {# 第三排：开始时间、结束时间（2个字段 + 3个空占位符 = 5个位置） #}
    <div class="row mb-3 form-row-5">
      {% block detail_basic_info_row3 %}
      {# 开始时间 #}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划开始时间</label>
          <div class="detail-field-value">
            {% if object.start_time %}{{ object.start_time|date:"Y-m-d H:i" }}{% elif object.start_date %}{{ object.start_date|date:"Y-m-d" }}{% else %}N/A{% endif %}
          </div>
        </div>
      </div>
      {# 结束时间 #}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划结束时间</label>
          <div class="detail-field-value">
            {% if object.end_time %}{{ object.end_time|date:"Y-m-d H:i" }}{% elif object.end_date %}{{ object.end_date|date:"Y-m-d" }}{% else %}N/A{% endif %}
          </div>
        </div>
      </div>
      {# 空占位符，凑满5个字段 #}
      <div class="col-5-fields detail-field-wrapper"></div>
      <div class="col-5-fields detail-field-wrapper"></div>
      <div class="col-5-fields detail-field-wrapper"></div>
      {% endblock detail_basic_info_row3 %}
    </div>
    
    {# 多行文本字段：计划内容（整行，使用 col-12） #}
    <div class="row mb-3">
      {% block detail_basic_info_content %}
      <div class="col-12 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划内容</label>
          <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.6;">
            {% if object.content %}{{ object.content }}{% else %}暂无内容{% endif %}
          </div>
        </div>
      </div>
      {% endblock detail_basic_info_content %}
    </div>
    
    {# 多行文本字段：计划目标（整行，使用 col-12） #}
    <div class="row mb-3">
      {% block detail_basic_info_objective %}
      <div class="col-12 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">计划目标</label>
          <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.6;">
            {% if object.plan_objective %}{{ object.plan_objective }}{% else %}暂无目标{% endif %}
          </div>
        </div>
      </div>
      {% endblock detail_basic_info_objective %}
    </div>
    
    {# 多行文本字段：协作计划（整行，使用 col-12） #}
    <div class="row mb-3">
      {% block detail_basic_info_collaboration %}
      <div class="col-12 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">协作计划</label>
          <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.6;">
            {% if object.collaboration_plan %}{{ object.collaboration_plan }}{% else %}暂无协作计划{% endif %}
          </div>
        </div>
      </div>
      {% endblock detail_basic_info_collaboration %}
    </div>
    
    {# 多选字段：协作人员（整行，使用 col-12） #}
    <div class="row mb-3">
      {% block detail_basic_info_participants %}
      <div class="col-12 detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">协作人员</label>
          <div class="detail-field-value">
            {% if object.participants.all %}
              {% for participant in object.participants.all %}
                <span class="badge badge-secondary">{{ participant.get_full_name|default:participant.username }}</span>
              {% endfor %}
            {% else %}
              暂无协作人员
            {% endif %}
          </div>
        </div>
      </div>
      {% endblock detail_basic_info_participants %}
    </div>
  </div>
</div>
</div>
{% endblock detail_basic_info_card %}

{# ==================== 卡片2：状态信息 ==================== #}
{% block detail_status_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-status-info">
  <div class="detail-card detail-card-status-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-toggle-on"></i>
      状态信息
    </h3>
  </div>
  <div class="detail-card-body">
    {# 当前状态 #}
    {% block detail_current_status %}
    <div class="mb-3">
      <label class="detail-field-label">当前状态</label>
      <div class="detail-field-value">
        {% if object.status %}
          <span class="badge badge-status badge-{{ object.status }}">
            {{ object.get_status_display|default:object.status }}
          </span>
        {% else %}N/A{% endif %}
      </div>
    </div>
    {% endblock detail_current_status %}
    
    {# 状态变更历史 #}
    {% block detail_status_history %}
    <div class="mb-4">
      <h5 class="detail-subsection-title">
        <i class="fas fa-exchange-alt"></i>
        状态变更记录
      </h5>
      <div class="detail-history-list">
        {% block detail_status_history_content %}
        <div class="text-muted">暂无状态变更记录</div>
        {% endblock detail_status_history_content %}
      </div>
    </div>
    {% endblock detail_status_history %}
    
    {# 状态时间戳 #}
    {% block detail_status_timestamps %}
    <div class="mb-4">
      <h5 class="detail-subsection-title">
        <i class="fas fa-clock"></i>
        状态时间戳
      </h5>
      <div class="row">
        {% block detail_status_timestamps_content %}
        {# 子模板可以在这里添加状态时间戳字段 #}
        {% endblock detail_status_timestamps_content %}
      </div>
    </div>
    {% endblock detail_status_timestamps %}
  </div>
</div>
</div>
{% endblock detail_status_info_card %}

{# ==================== 卡片3：关联信息 ==================== #}
{% block detail_related_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-related-info">
  <div class="detail-card detail-card-related-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-link"></i>
      关联信息
    </h3>
  </div>
  <div class="detail-card-body">
    {# 关联记录 #}
    {% block detail_related_records %}
    <div class="mb-4">
      <h5 class="detail-subsection-title">
        <i class="fas fa-database"></i>
        关联记录
      </h5>
      <div class="detail-related-list">
        {% block detail_related_records_content %}
        <div class="text-muted">暂无关联记录</div>
        {% endblock detail_related_records_content %}
      </div>
    </div>
    {% endblock detail_related_records %}
    
    {# 关联链接按钮 #}
    {% block detail_related_links %}
    <div class="mb-4">
      <h5 class="detail-subsection-title">
        <i class="fas fa-external-link-alt"></i>
        相关链接
      </h5>
      <div class="detail-related-links">
        {% block detail_related_links_content %}
        <div class="text-muted">暂无相关链接</div>
        {% endblock detail_related_links_content %}
      </div>
    </div>
    {% endblock detail_related_links %}
  </div>
</div>
</div>
{% endblock detail_related_info_card %}

{# ==================== 卡片4：审计信息 ==================== #}
{% block detail_audit_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-audit-info">
  <div class="detail-card detail-card-audit-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-file-alt"></i>
      审计信息
    </h3>
  </div>
  <div class="detail-card-body">
    {# 审计日志 #}
    {% block detail_audit_log %}
    <div class="mb-4">
      <h5 class="detail-subsection-title">
        <i class="fas fa-file-alt"></i>
        审计日志
      </h5>
      <div class="detail-history-list">
        {% block detail_audit_log_content %}
        <div class="text-muted">暂无审计日志</div>
        {% endblock detail_audit_log_content %}
      </div>
    </div>
    {% endblock detail_audit_log %}
    
    {# 修改记录 #}
    {% block detail_modification_history %}
    <div class="mb-4">
      <h5 class="detail-subsection-title">
        <i class="fas fa-edit"></i>
        修改记录
      </h5>
      <div class="detail-history-list">
        {% block detail_modification_history_content %}
        <div class="text-muted">暂无修改记录</div>
        {% endblock detail_modification_history_content %}
      </div>
    </div>
    {% endblock detail_modification_history %}
  </div>
</div>
</div>
{% endblock detail_audit_info_card %}

{# ==================== 卡片5：数据与统计信息 ==================== #}
{% block detail_statistics_card %}
<div class="detail-card-wrapper detail-card-wrapper-statistics">
  <div class="detail-card detail-card-statistics">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-chart-bar"></i>
      数据与统计信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_statistics_content %}
    {# 进度条示例 #}
    {% if progress_percentage %}
    <div class="mb-4">
      <h5 class="detail-subsection-title">进度</h5>
      <div class="progress" style="height: 25px;">
        <div class="progress-bar" role="progressbar" 
             style="width: {{ progress_percentage }}%;" 
             aria-valuenow="{{ progress_percentage }}" 
             aria-valuemin="0" 
             aria-valuemax="100">
          {{ progress_percentage }}%
        </div>
      </div>
    </div>
    {% endif %}
    {# 图表和报告区域 #}
    {% block detail_charts %}
    <div class="detail-charts">
      {# 子模板可以在这里添加图表 #}
      {% block detail_charts_content %}{% endblock %}
    </div>
    {% endblock detail_charts %}
    {# 统计信息卡片 #}
    {% block detail_statistics_cards %}
    <div class="row">
      {% block detail_statistics_cards_content %}{% endblock %}
    </div>
    {% endblock detail_statistics_cards %}
    {% endblock detail_statistics_content %}
  </div>
</div>
</div>
{% endblock detail_statistics_card %}

{# ==================== 卡片6：附件与文件信息 ==================== #}
{% block detail_attachments_card %}
<div class="detail-card-wrapper detail-card-wrapper-attachments">
  <div class="detail-card detail-card-attachments">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-paperclip"></i>
      附件与文件信息
    </h3>
  </div>
  <div class="detail-card-body">
    {% block detail_attachments_content %}
    <div class="detail-attachments-list">
      {# 附件列表 #}
      {% if attachments %}
      <div class="row">
        {% for attachment in attachments %}
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card attachment-card">
            <div class="card-body">
              <div class="attachment-icon">
                {% if attachment.file_type == 'pdf' %}
                  <i class="fas fa-file-pdf text-danger"></i>
                {% elif attachment.file_type == 'image' %}
                  <i class="fas fa-file-image text-primary"></i>
                {% elif attachment.file_type == 'video' %}
                  <i class="fas fa-file-video text-warning"></i>
                {% elif attachment.file_type == 'word' %}
                  <i class="fas fa-file-word text-info"></i>
                {% elif attachment.file_type == 'excel' %}
                  <i class="fas fa-file-excel text-success"></i>
                {% else %}
                  <i class="fas fa-file text-secondary"></i>
                {% endif %}
              </div>
              <h6 class="attachment-name">{{ attachment.name|truncatechars:20 }}</h6>
              <p class="attachment-meta text-muted small">
                <i class="fas fa-calendar"></i>
                {{ attachment.uploaded_at|date:"Y-m-d" }}
              </p>
              <div class="attachment-actions">
                <a href="{{ attachment.file.url }}" class="btn btn-sm btn-primary" download>
                  <i class="fas fa-download"></i>
                  下载
                </a>
                {% if attachment.file_type == 'image' %}
                <button type="button" class="btn btn-sm btn-secondary" onclick="previewImage('{{ attachment.file.url }}')">
                  <i class="fas fa-eye"></i>
                  预览
                </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-muted">暂无附件</div>
      {% endif %}
    </div>
    {% endblock detail_attachments_content %}
  </div>
</div>
</div>
{% endblock detail_attachments_card %}

{# ==================== 卡片7：系统信息 ==================== #}
{% block detail_system_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-system-info">
  <div class="detail-card detail-card-system-info">
  <div class="detail-card-header">
    <h3 class="detail-card-title">
      <i class="fas fa-cog"></i>
      系统信息
    </h3>
  </div>
  <div class="detail-card-body">
    <div class="row">
      {# 创建时间 #}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">创建时间</label>
          <div class="detail-field-value">
            {% if object.created_time %}{{ object.created_time|date:"Y-m-d H:i:s" }}{% elif object.created_at %}{{ object.created_at|date:"Y-m-d H:i:s" }}{% else %}N/A{% endif %}
          </div>
        </div>
      </div>
      {# 更新时间 #}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">更新时间</label>
          <div class="detail-field-value">
            {% if object.updated_time %}{{ object.updated_time|date:"Y-m-d H:i:s" }}{% elif object.updated_at %}{{ object.updated_at|date:"Y-m-d H:i:s" }}{% else %}N/A{% endif %}
          </div>
        </div>
      </div>
      {# 创建人 #}
      {% if object.created_by %}
      <div class="col-5-fields detail-field-wrapper">
        <div class="detail-field">
          <label class="detail-field-label">创建人</label>
          <div class="detail-field-value">
            {{ object.created_by.get_full_name|default:object.created_by.username }}
          </div>
        </div>
      </div>
      {% endif %}
      {# 空占位符 #}
      <div class="col-5-fields detail-field-wrapper"></div>
      <div class="col-5-fields detail-field-wrapper"></div>
    </div>
  </div>
</div>
</div>
{% endblock detail_system_info_card %}
</div>
{% endblock pm_content %}
{% block module_extra_js %}
{{ block.super }}
<script>
  // 图片预览功能
  function previewImage(imageUrl) {
    // 创建模态框显示图片
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">图片预览</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <img src="${imageUrl}" class="img-fluid" alt="预览图片">
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    modal.addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modal);
    });
  }
  
  // 页面加载完成后的初始化
  document.addEventListener('DOMContentLoaded', function() {
    // 可以在这里添加其他初始化逻辑
  });
</script>
{% endblock module_extra_js %}