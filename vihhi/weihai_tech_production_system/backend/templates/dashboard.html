{% extends "shared/two_column_layout_standalone.html" %}
{% load static %}

{% block title %}ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å° - é¦–é¡µ{% endblock %}

{% block content_inner %}
  <div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div>
        <h1 class="h3 mb-2">å·¥ä½œå°</h1>
        <p class="text-muted">æ¬¢è¿å›æ¥ï¼Œ{{ user.get_full_name|default:user.username }}</p>
      </div>
      <div class="d-flex gap-2">
        {% for action in top_actions %}
          <a href="{{ action.url }}" class="btn btn-primary">
            <i class="bi bi-{{ action.icon }}"></i> {{ action.label }}
          </a>
        {% endfor %}
      </div>
    </div>

    <!-- é£é™©é¢„è­¦å¡ç‰‡ -->
    {% if employee_risk_data %}
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0">âš ï¸ å‘˜å·¥é£é™©é¢„è­¦å¯¹æ¯”</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <!-- å›¾è¡¨åŒºåŸŸ -->
              <div class="col-lg-8">
                <canvas id="employeeRiskChart" height="400"></canvas>
              </div>
              <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
              <div class="col-lg-4">
                <h6 class="mb-3">è¯¦ç»†æ•°æ®</h6>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                  <table class="table table-sm table-hover">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th>å‘˜å·¥</th>
                        <th>é£é™©åˆ†</th>
                        <th>è¯¦æƒ…</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for emp in employee_risk_data %}
                      <tr>
                        <td>
                          <div class="fw-bold">{{ emp.user_name }}</div>
                          <small class="text-muted">{{ emp.department }}</small>
                        </td>
                        <td>
                          <span class="badge {% if emp.total_risk_score >= 20 %}bg-danger{% elif emp.total_risk_score >= 10 %}bg-warning{% else %}bg-info{% endif %}">
                            {{ emp.total_risk_score }}
                          </span>
                        </td>
                        <td>
                          <small>
                            <div>é£é™©ç›®æ ‡: {{ emp.goal_risk_count }}</div>
                            <div>é£é™©è®¡åˆ’: {{ emp.plan_risk_count }}</div>
                            <div>æ€»é£é™©: {{ emp.total_risk_count }}</div>
                            <div>å¹³å‡é€¾æœŸ: {{ emp.avg_days_overdue }}å¤©</div>
                          </small>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- ç»Ÿè®¡æ‘˜è¦ -->
            <div class="row mt-3">
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0 text-danger">{{ employee_risk_data|length }}</div>
                  <small class="text-muted">æ€»å‘˜å·¥æ•°</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0 text-warning" id="high-risk-count">0</div>
                  <small class="text-muted">é«˜é£é™©å‘˜å·¥</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0" id="total-risk-count">0</div>
                  <small class="text-muted">æ€»é£é™©é¡¹æ•°</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0" id="total-risk-score">0</div>
                  <small class="text-muted">æ€»é£é™©åˆ†</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- å‘˜å·¥å¾…åŠäº‹é¡¹å¯¹æ¯”å¡ç‰‡ -->
    {% if employee_todo_data %}
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">ğŸ“‹ å‘˜å·¥å¾…åŠäº‹é¡¹å¯¹æ¯”</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <!-- å›¾è¡¨åŒºåŸŸ -->
              <div class="col-lg-8">
                <canvas id="employeeTodoChart" height="400"></canvas>
              </div>
              <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
              <div class="col-lg-4">
                <h6 class="mb-3">è¯¦ç»†æ•°æ®</h6>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                  <table class="table table-sm table-hover">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th>å‘˜å·¥</th>
                        <th>å¾…åŠåˆ†</th>
                        <th>è¯¦æƒ…</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for emp in employee_todo_data %}
                      <tr>
                        <td>
                          <div class="fw-bold">{{ emp.user_name }}</div>
                          <small class="text-muted">{{ emp.department }}</small>
                        </td>
                        <td>
                          <span class="badge {% if emp.todo_score >= 100 %}bg-danger{% elif emp.todo_score >= 50 %}bg-warning{% else %}bg-info{% endif %}">
                            {{ emp.todo_score }}
                          </span>
                        </td>
                        <td>
                          <small>
                            <div>æ€»å¾…åŠ: {{ emp.total_todos }}</div>
                            <div>é«˜ä¼˜å…ˆçº§: {{ emp.high_priority_count }}</div>
                            <div>é€¾æœŸ: {{ emp.overdue_count }}</div>
                            <div>å¹³å‡é€¾æœŸ: {{ emp.avg_days_overdue }}å¤©</div>
                          </small>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- ç»Ÿè®¡æ‘˜è¦ -->
            <div class="row mt-3">
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0 text-primary">{{ employee_todo_data|length }}</div>
                  <small class="text-muted">æ€»å‘˜å·¥æ•°</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0 text-danger" id="high-todo-count">0</div>
                  <small class="text-muted">é«˜å¾…åŠå‘˜å·¥</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0" id="total-todo-count">0</div>
                  <small class="text-muted">æ€»å¾…åŠæ•°</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0 text-warning" id="total-overdue-count">0</div>
                  <small class="text-muted">æ€»é€¾æœŸæ•°</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- å‘˜å·¥å·¥ä½œè®¡åˆ’å¯¹æ¯”å¡ç‰‡ -->
    {% if employee_plan_data %}
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">ğŸ“… å‘˜å·¥å·¥ä½œè®¡åˆ’å¯¹æ¯”</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <!-- å›¾è¡¨åŒºåŸŸ -->
              <div class="col-lg-8">
                <canvas id="employeePlanChart" height="400"></canvas>
              </div>
              <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
              <div class="col-lg-4">
                <h6 class="mb-3">è¯¦ç»†æ•°æ®</h6>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                  <table class="table table-sm table-hover">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th>å‘˜å·¥</th>
                        <th>è®¡åˆ’åˆ†</th>
                        <th>è¯¦æƒ…</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for emp in employee_plan_data %}
                      <tr>
                        <td>
                          <div class="fw-bold">{{ emp.user_name }}</div>
                          <small class="text-muted">{{ emp.department }}</small>
                        </td>
                        <td>
                          <span class="badge {% if emp.plan_score >= 50 %}bg-danger{% elif emp.plan_score >= 20 %}bg-warning{% else %}bg-info{% endif %}">
                            {{ emp.plan_score }}
                          </span>
                        </td>
                        <td>
                          <small>
                            <div>æ€»è®¡åˆ’: {{ emp.total_plans }}</div>
                            <div>æ‰§è¡Œä¸­: {{ emp.in_progress_count }}</div>
                            <div>é€¾æœŸ: {{ emp.overdue_count }}</div>
                            <div>ä»Šæ—¥: {{ emp.today_count }}</div>
                            <div>å¹³å‡è¿›åº¦: {{ emp.avg_progress }}%</div>
                          </small>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- ç»Ÿè®¡æ‘˜è¦ -->
            <div class="row mt-3">
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0 text-success">{{ employee_plan_data|length }}</div>
                  <small class="text-muted">æ€»å‘˜å·¥æ•°</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0 text-primary" id="high-plan-count">0</div>
                  <small class="text-muted">é«˜è®¡åˆ’å‘˜å·¥</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0" id="total-plan-count">0</div>
                  <small class="text-muted">æ€»è®¡åˆ’æ•°</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0 text-warning" id="total-overdue-plan-count">0</div>
                  <small class="text-muted">æ€»é€¾æœŸæ•°</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- å‘˜å·¥æˆ˜ç•¥ç›®æ ‡å¯¹æ¯”å¡ç‰‡ -->
    {% if employee_goal_data %}
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">ğŸ¯ å‘˜å·¥æˆ˜ç•¥ç›®æ ‡å¯¹æ¯”</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <!-- å›¾è¡¨åŒºåŸŸ -->
              <div class="col-lg-8">
                <canvas id="employeeGoalChart" height="400"></canvas>
              </div>
              <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
              <div class="col-lg-4">
                <h6 class="mb-3">è¯¦ç»†æ•°æ®</h6>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                  <table class="table table-sm table-hover">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th>å‘˜å·¥</th>
                        <th>ç›®æ ‡åˆ†</th>
                        <th>è¯¦æƒ…</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for emp in employee_goal_data %}
                      <tr>
                        <td>
                          <div class="fw-bold">{{ emp.user_name }}</div>
                          <small class="text-muted">{{ emp.department }}</small>
                        </td>
                        <td>
                          <span class="badge {% if emp.goal_score >= 50 %}bg-danger{% elif emp.goal_score >= 20 %}bg-warning{% else %}bg-info{% endif %}">
                            {{ emp.goal_score }}
                          </span>
                        </td>
                        <td>
                          <small>
                            <div>æ€»ç›®æ ‡: {{ emp.total_goals }}</div>
                            <div>æ‰§è¡Œä¸­: {{ emp.in_progress_count }}</div>
                            <div>é€¾æœŸ: {{ emp.overdue_count }}</div>
                            <div>æœ¬æœˆéœ€å®Œæˆ: {{ emp.this_month_count }}</div>
                            <div>å¹³å‡å®Œæˆç‡: {{ emp.avg_completion }}%</div>
                          </small>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- ç»Ÿè®¡æ‘˜è¦ -->
            <div class="row mt-3">
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0 text-info">{{ employee_goal_data|length }}</div>
                  <small class="text-muted">æ€»å‘˜å·¥æ•°</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0 text-primary" id="high-goal-count">0</div>
                  <small class="text-muted">é«˜ç›®æ ‡å‘˜å·¥</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0" id="total-goal-count">0</div>
                  <small class="text-muted">æ€»ç›®æ ‡æ•°</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center p-2 bg-light rounded">
                  <div class="h5 mb-0 text-warning" id="total-overdue-goal-count">0</div>
                  <small class="text-muted">æ€»é€¾æœŸæ•°</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

  </div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'js/sidebar.js' %}"></script>
  <script src="{% static 'js/lib/chart.umd.min.js' %}"></script>
  {% if employee_risk_data %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('employeeRiskChart');
      if (!ctx) return;
      
      const employeeData = {{ employee_risk_data_json|safe }};
      
      // è®¡ç®—ç»Ÿè®¡æ‘˜è¦ï¼ˆæ¥æºäº plan/home çš„é£é™©é¢„è­¦ï¼‰
      let highRiskCount = 0;
      let totalRiskCount = 0;
      let totalRiskScore = 0;
      
      employeeData.forEach(emp => {
        if (emp.total_risk_score >= 20) {
          highRiskCount++;
        }
        totalRiskCount += (emp.total_risk_count || 0);
        totalRiskScore += (emp.total_risk_score || 0);
      });
      
      // æ›´æ–°ç»Ÿè®¡æ‘˜è¦æ˜¾ç¤º
      document.getElementById('high-risk-count').textContent = highRiskCount;
      document.getElementById('total-risk-count').textContent = totalRiskCount;
      document.getElementById('total-risk-score').textContent = Math.round(totalRiskScore);
      
      // å‡†å¤‡å›¾è¡¨æ•°æ®ï¼ˆæ¥æºäº plan/home çš„é£é™©é¢„è­¦ï¼‰
      const labels = employeeData.map(emp => emp.user_name);
      const goalRiskData = employeeData.map(emp => emp.goal_risk_count || 0);
      const planRiskData = employeeData.map(emp => emp.plan_risk_count || 0);
      const totalRiskData = employeeData.map(emp => emp.total_risk_count || 0);
      const riskScoreData = employeeData.map(emp => emp.total_risk_score || 0);
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'é£é™©ç›®æ ‡æ•°',
              data: goalRiskData,
              backgroundColor: 'rgba(220, 53, 69, 0.8)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            },
            {
              label: 'é£é™©è®¡åˆ’æ•°',
              data: planRiskData,
              backgroundColor: 'rgba(255, 193, 7, 0.8)',
              borderColor: 'rgba(255, 193, 7, 1)',
              borderWidth: 1
            },
            {
              label: 'æ€»é£é™©æ•°',
              data: totalRiskData,
              backgroundColor: 'rgba(255, 87, 34, 0.8)',
              borderColor: 'rgba(255, 87, 34, 1)',
              borderWidth: 1
            },
            {
              label: 'é£é™©åˆ†æ•°',
              data: riskScoreData,
              backgroundColor: 'rgba(156, 39, 176, 0.8)',
              borderColor: 'rgba(156, 39, 176, 1)',
              borderWidth: 2,
              type: 'line',
              tension: 0.4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'å‘˜å·¥é£é™©æŒ‡æ ‡å¯¹æ¯”å›¾',
              font: {
                size: 16,
                weight: 'bold'
              }
            },
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                afterLabel: function(context) {
                  const index = context.dataIndex;
                  const emp = employeeData[index];
                  return [
                    'éƒ¨é—¨: ' + emp.department,
                    'æ€»é£é™©: ' + (emp.total_risk_count || 0),
                    'å¹³å‡é€¾æœŸ: ' + (emp.avg_days_overdue || 0) + 'å¤©',
                    'å¹³å‡è¿›åº¦å·®è·: ' + (emp.avg_progress_gap || 0) + '%'
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              stacked: false,
              ticks: {
                maxRotation: 0,
                minRotation: 0
              }
            },
            y: {
              beginAtZero: true,
              position: 'left',
              title: {
                display: true,
                text: 'é£é™©æ•°é‡'
              }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              title: {
                display: true,
                text: 'é£é™©åˆ†æ•°'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          },
          interaction: {
            mode: 'index',
            intersect: false
          }
        }
      });
    });
  </script>
  {% endif %}
  
  {% if employee_todo_data %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('employeeTodoChart');
      if (!ctx) return;
      
      const employeeData = {{ employee_todo_data_json|safe }};
      
      // è®¡ç®—ç»Ÿè®¡æ‘˜è¦
      let highTodoCount = 0;
      let totalTodoCount = 0;
      let totalOverdueCount = 0;
      
      employeeData.forEach(emp => {
        if (emp.todo_score >= 100) {
          highTodoCount++;
        }
        totalTodoCount += (emp.total_todos || 0);
        totalOverdueCount += (emp.overdue_count || 0);
      });
      
      // æ›´æ–°ç»Ÿè®¡æ‘˜è¦æ˜¾ç¤º
      document.getElementById('high-todo-count').textContent = highTodoCount;
      document.getElementById('total-todo-count').textContent = totalTodoCount;
      document.getElementById('total-overdue-count').textContent = totalOverdueCount;
      
      // å‡†å¤‡å›¾è¡¨æ•°æ®
      const labels = employeeData.map(emp => emp.user_name);
      const totalTodosData = employeeData.map(emp => emp.total_todos || 0);
      const highPriorityData = employeeData.map(emp => emp.high_priority_count || 0);
      const overdueData = employeeData.map(emp => emp.overdue_count || 0);
      const todoScoreData = employeeData.map(emp => emp.todo_score || 0);
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'æ€»å¾…åŠæ•°',
              data: totalTodosData,
              backgroundColor: 'rgba(13, 110, 253, 0.8)',
              borderColor: 'rgba(13, 110, 253, 1)',
              borderWidth: 1
            },
            {
              label: 'é«˜ä¼˜å…ˆçº§',
              data: highPriorityData,
              backgroundColor: 'rgba(220, 53, 69, 0.8)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            },
            {
              label: 'é€¾æœŸæ•°',
              data: overdueData,
              backgroundColor: 'rgba(255, 193, 7, 0.8)',
              borderColor: 'rgba(255, 193, 7, 1)',
              borderWidth: 1
            },
            {
              label: 'å¾…åŠåˆ†æ•°',
              data: todoScoreData,
              backgroundColor: 'rgba(156, 39, 176, 0.8)',
              borderColor: 'rgba(156, 39, 176, 1)',
              borderWidth: 2,
              type: 'line',
              tension: 0.4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'å‘˜å·¥å¾…åŠäº‹é¡¹å¯¹æ¯”å›¾',
              font: {
                size: 16,
                weight: 'bold'
              }
            },
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                afterLabel: function(context) {
                  const index = context.dataIndex;
                  const emp = employeeData[index];
                  return [
                    'éƒ¨é—¨: ' + emp.department,
                    'æ€»å¾…åŠ: ' + (emp.total_todos || 0),
                    'é«˜ä¼˜å…ˆçº§: ' + (emp.high_priority_count || 0),
                    'ä¸­ä¼˜å…ˆçº§: ' + (emp.medium_priority_count || 0),
                    'ä½ä¼˜å…ˆçº§: ' + (emp.low_priority_count || 0),
                    'é€¾æœŸ: ' + (emp.overdue_count || 0),
                    'å¹³å‡é€¾æœŸ: ' + (emp.avg_days_overdue || 0) + 'å¤©'
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              stacked: false,
              ticks: {
                maxRotation: 0,
                minRotation: 0
              }
            },
            y: {
              beginAtZero: true,
              position: 'left',
              title: {
                display: true,
                text: 'å¾…åŠæ•°é‡'
              }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              title: {
                display: true,
                text: 'å¾…åŠåˆ†æ•°'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          },
          interaction: {
            mode: 'index',
            intersect: false
          }
        }
      });
    });
  </script>
  {% endif %}
  
  {% if employee_plan_data %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('employeePlanChart');
      if (!ctx) return;
      
      const employeeData = {{ employee_plan_data_json|safe }};
      
      // è®¡ç®—ç»Ÿè®¡æ‘˜è¦
      let highPlanCount = 0;
      let totalPlanCount = 0;
      let totalOverduePlanCount = 0;
      
      employeeData.forEach(emp => {
        if (emp.plan_score >= 50) {
          highPlanCount++;
        }
        totalPlanCount += (emp.total_plans || 0);
        totalOverduePlanCount += (emp.overdue_count || 0);
      });
      
      // æ›´æ–°ç»Ÿè®¡æ‘˜è¦æ˜¾ç¤º
      document.getElementById('high-plan-count').textContent = highPlanCount;
      document.getElementById('total-plan-count').textContent = totalPlanCount;
      document.getElementById('total-overdue-plan-count').textContent = totalOverduePlanCount;
      
      // å‡†å¤‡å›¾è¡¨æ•°æ®
      const labels = employeeData.map(emp => emp.user_name);
      const totalPlansData = employeeData.map(emp => emp.total_plans || 0);
      const inProgressData = employeeData.map(emp => emp.in_progress_count || 0);
      const overdueData = employeeData.map(emp => emp.overdue_count || 0);
      const todayData = employeeData.map(emp => emp.today_count || 0);
      const planScoreData = employeeData.map(emp => emp.plan_score || 0);
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'æ€»è®¡åˆ’æ•°',
              data: totalPlansData,
              backgroundColor: 'rgba(25, 135, 84, 0.8)',
              borderColor: 'rgba(25, 135, 84, 1)',
              borderWidth: 1
            },
            {
              label: 'æ‰§è¡Œä¸­',
              data: inProgressData,
              backgroundColor: 'rgba(13, 110, 253, 0.8)',
              borderColor: 'rgba(13, 110, 253, 1)',
              borderWidth: 1
            },
            {
              label: 'é€¾æœŸæ•°',
              data: overdueData,
              backgroundColor: 'rgba(255, 193, 7, 0.8)',
              borderColor: 'rgba(255, 193, 7, 1)',
              borderWidth: 1
            },
            {
              label: 'ä»Šæ—¥åº”æ‰§è¡Œ',
              data: todayData,
              backgroundColor: 'rgba(220, 53, 69, 0.8)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            },
            {
              label: 'è®¡åˆ’åˆ†æ•°',
              data: planScoreData,
              backgroundColor: 'rgba(156, 39, 176, 0.8)',
              borderColor: 'rgba(156, 39, 176, 1)',
              borderWidth: 2,
              type: 'line',
              tension: 0.4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'å‘˜å·¥å·¥ä½œè®¡åˆ’å¯¹æ¯”å›¾',
              font: {
                size: 16,
                weight: 'bold'
              }
            },
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                afterLabel: function(context) {
                  const index = context.dataIndex;
                  const emp = employeeData[index];
                  return [
                    'éƒ¨é—¨: ' + emp.department,
                    'æ€»è®¡åˆ’: ' + (emp.total_plans || 0),
                    'è‰ç¨¿: ' + (emp.draft_count || 0),
                    'å·²å‘å¸ƒ: ' + (emp.published_count || 0),
                    'å·²æ¥å—: ' + (emp.accepted_count || 0),
                    'æ‰§è¡Œä¸­: ' + (emp.in_progress_count || 0),
                    'å·²å®Œæˆ: ' + (emp.completed_count || 0),
                    'é€¾æœŸ: ' + (emp.overdue_count || 0),
                    'å¹³å‡é€¾æœŸ: ' + (emp.avg_days_overdue || 0) + 'å¤©',
                    'å¹³å‡è¿›åº¦: ' + (emp.avg_progress || 0) + '%'
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              stacked: false,
              ticks: {
                maxRotation: 0,
                minRotation: 0
              }
            },
            y: {
              beginAtZero: true,
              position: 'left',
              title: {
                display: true,
                text: 'è®¡åˆ’æ•°é‡'
              }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              title: {
                display: true,
                text: 'è®¡åˆ’åˆ†æ•°'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          },
          interaction: {
            mode: 'index',
            intersect: false
          }
        }
      });
    });
  </script>
  {% endif %}
  
  {% if employee_goal_data %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('employeeGoalChart');
      if (!ctx) return;
      
      const employeeData = {{ employee_goal_data_json|safe }};
      
      // è®¡ç®—ç»Ÿè®¡æ‘˜è¦
      let highGoalCount = 0;
      let totalGoalCount = 0;
      let totalOverdueGoalCount = 0;
      
      employeeData.forEach(emp => {
        if (emp.goal_score >= 50) {
          highGoalCount++;
        }
        totalGoalCount += (emp.total_goals || 0);
        totalOverdueGoalCount += (emp.overdue_count || 0);
      });
      
      // æ›´æ–°ç»Ÿè®¡æ‘˜è¦æ˜¾ç¤º
      document.getElementById('high-goal-count').textContent = highGoalCount;
      document.getElementById('total-goal-count').textContent = totalGoalCount;
      document.getElementById('total-overdue-goal-count').textContent = totalOverdueGoalCount;
      
      // å‡†å¤‡å›¾è¡¨æ•°æ®
      const labels = employeeData.map(emp => emp.user_name);
      const totalGoalsData = employeeData.map(emp => emp.total_goals || 0);
      const inProgressData = employeeData.map(emp => emp.in_progress_count || 0);
      const overdueData = employeeData.map(emp => emp.overdue_count || 0);
      const thisMonthData = employeeData.map(emp => emp.this_month_count || 0);
      const goalScoreData = employeeData.map(emp => emp.goal_score || 0);
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'æ€»ç›®æ ‡æ•°',
              data: totalGoalsData,
              backgroundColor: 'rgba(13, 202, 240, 0.8)',
              borderColor: 'rgba(13, 202, 240, 1)',
              borderWidth: 1
            },
            {
              label: 'æ‰§è¡Œä¸­',
              data: inProgressData,
              backgroundColor: 'rgba(13, 110, 253, 0.8)',
              borderColor: 'rgba(13, 110, 253, 1)',
              borderWidth: 1
            },
            {
              label: 'é€¾æœŸæ•°',
              data: overdueData,
              backgroundColor: 'rgba(255, 193, 7, 0.8)',
              borderColor: 'rgba(255, 193, 7, 1)',
              borderWidth: 1
            },
            {
              label: 'æœ¬æœˆéœ€å®Œæˆ',
              data: thisMonthData,
              backgroundColor: 'rgba(220, 53, 69, 0.8)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            },
            {
              label: 'ç›®æ ‡åˆ†æ•°',
              data: goalScoreData,
              backgroundColor: 'rgba(156, 39, 176, 0.8)',
              borderColor: 'rgba(156, 39, 176, 1)',
              borderWidth: 2,
              type: 'line',
              tension: 0.4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'å‘˜å·¥æˆ˜ç•¥ç›®æ ‡å¯¹æ¯”å›¾',
              font: {
                size: 16,
                weight: 'bold'
              }
            },
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                afterLabel: function(context) {
                  const index = context.dataIndex;
                  const emp = employeeData[index];
                  return [
                    'éƒ¨é—¨: ' + emp.department,
                    'æ€»ç›®æ ‡: ' + (emp.total_goals || 0),
                    'è‰ç¨¿: ' + (emp.draft_count || 0),
                    'å·²å‘å¸ƒ: ' + (emp.published_count || 0),
                    'å·²æ¥å—: ' + (emp.accepted_count || 0),
                    'æ‰§è¡Œä¸­: ' + (emp.in_progress_count || 0),
                    'å·²å®Œæˆ: ' + (emp.completed_count || 0),
                    'é€¾æœŸ: ' + (emp.overdue_count || 0),
                    'å¹³å‡é€¾æœŸ: ' + (emp.avg_days_overdue || 0) + 'å¤©',
                    'æœ¬æœˆéœ€å®Œæˆ: ' + (emp.this_month_count || 0),
                    'å¹³å‡å®Œæˆç‡: ' + (emp.avg_completion || 0) + '%'
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              stacked: false,
              ticks: {
                maxRotation: 0,
                minRotation: 0
              }
            },
            y: {
              beginAtZero: true,
              position: 'left',
              title: {
                display: true,
                text: 'ç›®æ ‡æ•°é‡'
              }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              title: {
                display: true,
                text: 'ç›®æ ‡åˆ†æ•°'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          },
          interaction: {
            mode: 'index',
            intersect: false
          }
        }
      });
    });
  </script>
  {% endif %}
{% endblock %}
