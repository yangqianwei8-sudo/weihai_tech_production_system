{% extends "project_center/base.html" %}
{% load static %}

{% block title %}任务工作台{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row g-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                    <div>
                        <div class="text-muted small">任务工作台</div>
                        <h3 class="mb-1">欢迎回来，{{ request.user.get_full_name|default:request.user.username }}</h3>
                        <p class="text-muted mb-0">当前共有 <strong>{{ task_counts.total }}</strong> 个待处理任务。</p>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge bg-light text-dark">甲方待办 {{ task_counts.client }}</span>
                        <span class="badge bg-light text-dark">设计方待办 {{ task_counts.design }}</span>
                        <span class="badge bg-light text-dark">内部待办 {{ task_counts.internal }}</span>
                    </div>
                </div>
            </div>
        </div>

        {% for section_key, tasks in task_sections.items %}
        <div class="col-12 col-xl-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        {% if section_key == 'client_side' %}
                            甲方任务
                        {% elif section_key == 'design_side' %}
                            设计方任务
                        {% else %}
                            内部任务
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if tasks %}
                        <div class="list-group list-group-flush">
                            {% for task in tasks %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-1">{{ task.title }}</h6>
                                    {% if task.due_time %}
                                    <span class="badge bg-warning-subtle text-warning">{{ task.due_time|date:"m-d H:i" }}</span>
                                    {% endif %}
                                </div>
                                <div class="text-muted small mb-2">
                                    {{ task.project_number }} {{ task.project_name }} · {{ task.assigned_role_label }}
                                </div>
                                <p class="small text-muted mb-2">{{ task.description|default:"任务说明待完善。" }}</p>
                                <div class="d-flex gap-2">
                                    <a href="{{ task.project_url }}" class="btn btn-sm btn-outline-primary">查看项目</a>
                                    <form method="post" action="{{ task.action_url }}">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="complete">
                                        <button type="submit" class="btn btn-sm btn-primary">标记完成</button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted small mb-0">暂无任务。</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">最近完成的任务</h5>
                </div>
                <div class="card-body">
                    {% if completed_tasks %}
                        <div class="table-responsive">
                            <table class="table table-sm table-borderless align-middle">
                                <thead>
                                    <tr class="text-muted small">
                                        <th>任务</th>
                                        <th>所属项目</th>
                                        <th>角色</th>
                                        <th>完成时间</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in completed_tasks %}
                                    <tr>
                                        <td>{{ task.title }}</td>
                                        <td>{{ task.project_number }} {{ task.project_name }}</td>
                                        <td>{{ task.assigned_role_label }}</td>
                                        <td>{{ task.completed_time|date:"Y-m-d H:i" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted small mb-0">近期暂无完成记录。</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
