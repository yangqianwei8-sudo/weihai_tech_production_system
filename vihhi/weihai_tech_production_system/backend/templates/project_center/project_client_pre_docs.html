{% extends "project_center/base.html" %}
{% load static %}

{% block title %}甲方上传优化前资料 - {{ project.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
        <div>
            <p class="text-muted mb-1">项目：{{ project.project_number }} · {{ project.name }}</p>
            <h2 class="mb-2">甲方上传优化前资料</h2>
            <p class="text-muted mb-0">手机号绑定的项目负责人/工程师可在此上传资料，系统将自动通知我方团队开启预审。</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'production_pages:project_detail' project.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回项目详情
            </a>
        </div>
    </div>

    <div class="alert alert-info border-0 shadow-sm mb-4">
        <i class="bi bi-info-circle-fill me-2"></i>
        提交成功后系统会自动生成“资料预审”任务。若被退回，请在此页面重新上传补充资料。
    </div>

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">上传资料</h5>
                    <span class="badge bg-primary-subtle text-primary">支持多文件</span>
                </div>
                <div class="card-body">
                    {% if can_submit %}
                    <form method="post" action="{{ upload_action_url }}" enctype="multipart/form-data" class="row g-3">
                        {% csrf_token %}
                        <div class="col-12">
                            <label class="form-label">提交标题 <span class="text-danger">*</span></label>
                            <input type="text" name="title" class="form-control" placeholder="例如：施工图（结构专业）优化前资料" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">版本号</label>
                            <input type="text" name="version" class="form-control" placeholder="如：V1.0 / 2025-01">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">预审截止</label>
                            <input type="datetime-local" name="review_deadline" class="form-control">
                        </div>
                        <div class="col-12">
                            <label class="form-label">资料说明</label>
                            <textarea name="description" rows="3" class="form-control" placeholder="补充项目范围、主要内容、重点关注项等信息"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">文件分类</label>
                            <select name="file_category" class="form-select">
                                {% for option in drawing_file_categories %}
                                <option value="{{ option.value }}">{{ option.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">提交人身份</label>
                            <input type="text" name="submitter_role" class="form-control" value="甲方项目负责人">
                        </div>
                        <div class="col-12">
                            <label class="form-label">上传文件 <span class="text-danger">*</span></label>
                            <input type="file" name="files" multiple class="form-control" required>
                            <div class="form-text">支持多选，单个文件不超过 200MB。</div>
                        </div>
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="bi bi-cloud-arrow-up"></i> 提交资料
                            </button>
                        </div>
                    </form>
                    {% else %}
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        当前账号没有上传权限，请使用绑定的甲方手机号登录或联系项目管理员开通权限。
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">当前任务进度</h5>
                </div>
                <div class="card-body">
                    {% if client_tasks %}
                    <ul class="list-group list-group-flush">
                        {% for task in client_tasks %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">{{ task.task_type_label }}</div>
                                    <div class="small text-muted">状态：{{ task.status_label }}</div>
                                </div>
                                <span class="badge bg-{% if task.status == 'completed' %}success{% elif task.status == 'pending' %}warning text-dark{% else %}primary{% endif %}">
                                    {{ task.status_label }}
                                </span>
                            </div>
                            {% if task.due_time %}
                            <div class="small text-muted mt-1"><i class="bi bi-clock"></i> 截止 {{ task.due_time|date:"m-d H:i" }}</div>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mb-0">暂无相关任务，提交资料后会自动生成任务提醒。</p>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">历史提交</h5>
                    <span class="text-muted small">最近 {{ submissions|length }} 条</span>
                </div>
                <div class="card-body">
                    {% if submissions %}
                    <div class="list-group list-group-flush">
                        {% for item in submissions %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">{{ item.title }}</div>
                                    <div class="small text-muted">{{ item.submitted_time|date:"Y-m-d H:i" }} · {{ item.submitter }}</div>
                                </div>
                                <span class="badge bg-{{ item.status_class }}">{{ item.status_label }}</span>
                            </div>
                            {% if item.latest_review %}
                            <div class="small mt-1">
                                <span class="badge bg-{{ item.latest_review.class }}">预审：{{ item.latest_review.label }}</span>
                                {% if item.latest_review.time %}
                                <span class="text-muted ms-2">{{ item.latest_review.time|date:"m-d H:i" }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if item.files %}
                            <div class="mt-2 small">
                                <span class="text-muted">附件：</span>
                                {% for file in item.files %}
                                <a href="{{ file.url }}" target="_blank" class="me-2">{{ file.name }}</a>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <hr class="my-2">
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">暂未上传过资料，提交后可在此查看历史记录。</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
