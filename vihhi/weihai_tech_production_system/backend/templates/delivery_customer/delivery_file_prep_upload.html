{% extends "delivery_customer/base.html" %}
{% load static %}

{% block title %}ä¸Šä¼ æ–‡ä»¶ - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'delivery_pages:report_delivery' %}">æ”¶å‘ç®¡ç†</a></li>
<li class="breadcrumb-item"><a href="{% url 'delivery_pages:delivery_file_prep_list' %}">æ–‡ä»¶å‡†å¤‡</a></li>
<li class="breadcrumb-item active">ä¸Šä¼ æ–‡ä»¶</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œæŒ‰é’® -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">ğŸ“ ä¸Šä¼ æ–‡ä»¶</h2>
            <p class="text-muted mb-0">å‡†å¤‡äº¤ä»˜æ–‡ä»¶ï¼Œæ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ </p>
        </div>
        <div>
            <a href="{% url 'delivery_pages:delivery_file_prep_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> è¿”å›åˆ—è¡¨
            </a>
        </div>
    </div>

    <!-- ä¸Šä¼ è¡¨å• - ä½¿ç”¨æ ·å¼æ¨¡æ¿ -->
    <form method="post" id="fileUploadForm" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- åŸºæœ¬ä¿¡æ¯ - ä½¿ç”¨æ ·å¼æ¨¡æ¿ -->
        <div class="info-card info-card-fade-in mb-4">
            <div class="info-card-header">
                <h5 class="info-card-title">å…³è”ä¿¡æ¯</h5>
            </div>
            <div class="info-card-body">
                <div class="info-grid info-grid-1">
                    <div class="info-item info-item-full-width">
                        <label class="info-label info-label-required">å…³è”äº¤ä»˜å•</label>
                        <select name="delivery_id" class="form-select" required id="delivery_select">
                            <option value="">è¯·é€‰æ‹©äº¤ä»˜å•</option>
                            {% for delivery in draft_deliveries %}
                            <option value="{{ delivery.id }}">
                                {{ delivery.delivery_number }} - {{ delivery.title }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">è¯·é€‰æ‹©è‰ç¨¿çŠ¶æ€çš„äº¤ä»˜å•ï¼Œæˆ–å…ˆåˆ›å»ºäº¤ä»˜å•</small>
                        <div class="mt-2">
                            <a href="{% url 'delivery_pages:delivery_create' %}" class="btn btn-sm btn-outline-primary" target="_blank">
                                <i class="bi bi-plus-circle"></i> åˆ›å»ºæ–°äº¤ä»˜å•
                            </a>
                        </div>
                    </div>
                    <div class="info-item info-item-full-width">
                        <label class="info-label">æ–‡ä»¶åˆ†ç±»</label>
                        <select name="file_category" class="form-select">
                            <option value="project">é¡¹ç›®æ–‡ä»¶</option>
                            <option value="non_project">éé¡¹ç›®æ–‡ä»¶</option>
                        </select>
                        <small class="form-text text-muted">é€‰æ‹©æ–‡ä»¶åˆ†ç±»ï¼Œç”¨äºæ–‡ä»¶ç®¡ç†</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼  - ä½¿ç”¨æ ·å¼æ¨¡æ¿ -->
        <div class="info-card mb-4">
            <div class="info-card-header">
                <h5 class="info-card-title">æ–‡ä»¶ä¸Šä¼ </h5>
            </div>
            <div class="info-card-body">
                <div class="info-grid info-grid-1">
                    <div class="info-item info-item-full-width">
                        <label class="info-label info-label-required">é€‰æ‹©æ–‡ä»¶</label>
                        <input type="file" name="files" class="form-control" multiple required 
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.dwg,.dgn,.jpg,.jpeg,.png,.zip,.rar,.7z">
                        <small class="form-text text-muted">
                            æ”¯æŒæ ¼å¼ï¼šPDFã€Wordã€Excelã€PowerPointã€CADå›¾çº¸ã€å›¾ç‰‡ã€å‹ç¼©åŒ…ç­‰
                            <br>æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§100MB
                        </small>
                    </div>
                </div>
                
                <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
                <div class="mt-4">
                    <div id="dropZone" class="border border-dashed rounded p-5 text-center" 
                         style="border-color: #dee2e6; background-color: #f8f9fa; cursor: pointer;">
                        <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #6c757d;"></i>
                        <p class="mt-3 mb-0 text-muted">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                        <small class="text-muted">æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="d-flex justify-content-end gap-2 mb-4">
            <a href="{% url 'delivery_pages:delivery_file_prep_list' %}" class="btn btn-outline-secondary">å–æ¶ˆ</a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-upload"></i> ä¸Šä¼ æ–‡ä»¶
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.querySelector('input[type="file"]');
    const form = document.getElementById('fileUploadForm');
    
    // ç‚¹å‡»æ‹–æ‹½åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
    dropZone.addEventListener('click', function() {
        fileInput.click();
    });
    
    // æ–‡ä»¶é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°æ˜¾ç¤º
    fileInput.addEventListener('change', function() {
        updateFileDisplay();
    });
    
    // æ‹–æ‹½äº‹ä»¶
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#007bff';
        dropZone.style.backgroundColor = '#e7f3ff';
    });
    
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#dee2e6';
        dropZone.style.backgroundColor = '#f8f9fa';
    });
    
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#dee2e6';
        dropZone.style.backgroundColor = '#f8f9fa';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            // åˆ›å»ºæ–°çš„FileList
            const dataTransfer = new DataTransfer();
            for (let file of files) {
                dataTransfer.items.add(file);
            }
            fileInput.files = dataTransfer.files;
            updateFileDisplay();
        }
    });
    
    function updateFileDisplay() {
        const files = fileInput.files;
        if (files.length > 0) {
            let fileList = '<div class="mt-3"><strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong><ul class="list-unstyled mt-2">';
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                fileList += `<li><i class="bi bi-file-earmark"></i> ${file.name} <small class="text-muted">(${fileSize} MB)</small></li>`;
            }
            fileList += '</ul></div>';
            dropZone.innerHTML = '<i class="bi bi-cloud-upload" style="font-size: 3rem; color: #6c757d;"></i>' + 
                                '<p class="mt-3 mb-0 text-muted">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>' +
                                '<small class="text-muted">æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ </small>' + fileList;
        }
    }
    
    // è¡¨å•éªŒè¯
    form.addEventListener('submit', function(e) {
        const deliveryId = document.getElementById('delivery_select').value;
        const files = fileInput.files;
        
        if (!deliveryId) {
            e.preventDefault();
            alert('è¯·é€‰æ‹©å…³è”äº¤ä»˜å•');
            return false;
        }
        
        if (files.length === 0) {
            e.preventDefault();
            alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
            return false;
        }
        
        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ100MBé™åˆ¶ï¼‰
        for (let i = 0; i < files.length; i++) {
            if (files[i].size > 100 * 1024 * 1024) {
                e.preventDefault();
                alert(`æ–‡ä»¶ "${files[i].name}" è¶…è¿‡100MBé™åˆ¶`);
                return false;
            }
        }
    });
});
</script>
{% endblock %}

