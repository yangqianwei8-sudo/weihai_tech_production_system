{% extends "delivery_customer/base.html" %}
{% load static %}

{% block title %}åˆ›å»ºæ¯å‘¨å¿«æŠ¥ - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'delivery_pages:report_delivery' %}">æ”¶å‘ç®¡ç†</a></li>
<li class="breadcrumb-item"><a href="{% url 'delivery_pages:delivery_weekly_report_list' %}">æ¯å‘¨å¿«æŠ¥</a></li>
<li class="breadcrumb-item active" aria-current="page">åˆ›å»ºæ¯å‘¨å¿«æŠ¥</li>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">ğŸ“° åˆ›å»ºæ¯å‘¨å¿«æŠ¥</h2>
            <p class="text-muted mb-0">ä¸ºå…¨è¿‡ç¨‹è®¾è®¡å’¨è¯¢é¡¹ç›®åˆ›å»ºæ¯å‘¨å¿«æŠ¥</p>
        </div>
        <div>
            <a href="{% url 'delivery_pages:delivery_weekly_report_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> è¿”å›åˆ—è¡¨
            </a>
        </div>
    </div>

    <form method="post" id="weeklyReportForm" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="info-card info-card-fade-in mb-4">
            <div class="info-card-header">
                <h5 class="info-card-title">åŸºæœ¬ä¿¡æ¯</h5>
            </div>
            <div class="info-card-body">
                <div class="info-grid info-grid-2">
                    <div class="info-item">
                        <label class="info-label info-label-required">å…³è”é¡¹ç›®</label>
                        <select name="project_id" class="form-select" required id="project_select">
                            <option value="">è¯·é€‰æ‹©é¡¹ç›®</option>
                            {% for project in full_process_projects %}
                            <option value="{{ project.id }}">
                                {{ project.project_number }} - {{ project.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">ä»…æ˜¾ç¤ºå…¨è¿‡ç¨‹è®¾è®¡å’¨è¯¢é¡¹ç›®</small>
                    </div>
                    <div class="info-item">
                        <label class="info-label info-label-required">å¿«æŠ¥å‘¨æœŸ</label>
                        <input type="text" name="week_number" class="form-control" required
                               placeholder="å¦‚ï¼š1ã€2ã€3..." pattern="[0-9]+" title="è¯·è¾“å…¥æ•°å­—">
                        <small class="form-text text-muted">è¯·è¾“å…¥ç¬¬Xå‘¨ï¼ˆæ•°å­—ï¼‰</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-card mb-4">
            <div class="info-card-header">
                <h5 class="info-card-title">å¿«æŠ¥å†…å®¹</h5>
            </div>
            <div class="info-card-body">
                <div class="info-grid info-grid-1">
                    <div class="info-item info-item-full-width">
                        <label class="info-label">æœ¬å‘¨è®¾è®¡è¿›åº¦å¯¹æ ‡</label>
                        <textarea name="design_progress" class="form-control" rows="4"
                                  placeholder="è¯·æè¿°æœ¬å‘¨è®¾è®¡è¿›åº¦å¯¹æ ‡æƒ…å†µ"></textarea>
                    </div>
                    <div class="info-item info-item-full-width">
                        <label class="info-label">æœ¬å‘¨ä¸»è¦ä¼˜åŒ–å»ºè®®</label>
                        <textarea name="optimization_suggestions" class="form-control" rows="4"
                                  placeholder="è¯·æè¿°æœ¬å‘¨ä¸»è¦ä¼˜åŒ–å»ºè®®"></textarea>
                    </div>
                    <div class="info-item info-item-full-width">
                        <label class="info-label">é¢„ä¼°èŠ‚çœé‡‘é¢</label>
                        <textarea name="estimated_savings" class="form-control" rows="3"
                                  placeholder="è¯·æè¿°é¢„ä¼°èŠ‚çœé‡‘é¢"></textarea>
                    </div>
                    <div class="info-item info-item-full-width">
                        <label class="info-label">æœ¬å‘¨å‘ç°çš„å›¾çº¸é—®é¢˜åŠé‡è¦æ€§åˆ†çº§</label>
                        <textarea name="drawing_issues" class="form-control" rows="4"
                                  placeholder="è¯·æè¿°æœ¬å‘¨å‘ç°çš„å›¾çº¸é—®é¢˜åŠé‡è¦æ€§åˆ†çº§"></textarea>
                    </div>
                    <div class="info-item info-item-full-width">
                        <label class="info-label">ç´¯è®¡æˆæœ¬æŒ‡æ ‡å˜åŠ¨è¶‹åŠ¿</label>
                        <textarea name="cost_trends" class="form-control" rows="3"
                                  placeholder="è¯·æè¿°ç´¯è®¡æˆæœ¬æŒ‡æ ‡å˜åŠ¨è¶‹åŠ¿"></textarea>
                    </div>
                    <div class="info-item info-item-full-width">
                        <label class="info-label">å¾…å†³ç­–äº‹é¡¹</label>
                        <textarea name="pending_decisions" class="form-control" rows="3"
                                  placeholder="è¯·æè¿°å¾…å†³ç­–äº‹é¡¹"></textarea>
                    </div>
                    <div class="info-item info-item-full-width">
                        <label class="info-label">é£é™©æç¤º</label>
                        <textarea name="risk_alerts" class="form-control" rows="3"
                                  placeholder="è¯·æè¿°é£é™©æç¤º"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mb-4">
            <a href="{% url 'delivery_pages:delivery_weekly_report_list' %}" class="btn btn-outline-secondary">å–æ¶ˆ</a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle"></i> åˆ›å»ºå¿«æŠ¥
            </button>
        </div>
    </form>
</div>

<script>
// è¡¨å•éªŒè¯
document.getElementById('weeklyReportForm').addEventListener('submit', function(e) {
    const projectId = document.getElementById('project_select').value;
    const weekNumber = document.querySelector('input[name="week_number"]').value;

    if (!projectId) {
        e.preventDefault();
        alert('è¯·é€‰æ‹©å…³è”é¡¹ç›®');
        return false;
    }

    if (!weekNumber || !/^\d+$/.test(weekNumber)) {
        e.preventDefault();
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å¿«æŠ¥å‘¨æœŸï¼ˆæ•°å­—ï¼‰');
        return false;
    }
});
</script>
{% endblock %}
