{% extends "delivery_customer/base.html" %}
{% load static %}

{% block title %}äº¤ä»˜è¯¦æƒ… - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'delivery_pages:report_delivery' %}">æ”¶å‘ç®¡ç†</a></li>
<li class="breadcrumb-item"><a href="{% url 'delivery_pages:delivery_list' %}">äº¤ä»˜è®°å½•</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ delivery.delivery_number }}</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">ğŸ“‹ äº¤ä»˜è¯¦æƒ…</h2>
            <p class="text-muted mb-0">äº¤ä»˜å•å·ï¼š{{ delivery.delivery_number }}</p>
        </div>
        <div>
            <a href="{% url 'delivery_pages:delivery_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> è¿”å›åˆ—è¡¨
            </a>
            {% if can_edit and delivery.status == 'draft' %}
            <a href="{% url 'delivery_pages:delivery_edit' delivery.id %}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> ç¼–è¾‘
            </a>
            <button type="button" class="btn btn-danger" onclick="confirmDelete({{ delivery.id }})">
                <i class="bi bi-trash"></i> åˆ é™¤
            </button>
            {% endif %}
            {% if can_submit %}
            <form method="post" action="{% url 'delivery_pages:delivery_submit' delivery.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-success" onclick="return confirm('ç¡®å®šè¦æäº¤æ­¤äº¤ä»˜è®°å½•è¿›è¡Œå®¡æ ¸å—ï¼Ÿæäº¤åå°†æ— æ³•ç¼–è¾‘ã€‚');">
                    <i class="bi bi-send"></i> æäº¤å®¡æ ¸
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">åŸºæœ¬ä¿¡æ¯</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                <div class="info-item">
                    <span class="info-label">äº¤ä»˜å•å·</span>
                    <span class="info-value info-value-bold">{{ delivery.delivery_number }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">äº¤ä»˜æ ‡é¢˜</span>
                    <span class="info-value">{{ delivery.title }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">äº¤ä»˜æ–¹å¼</span>
                    <span class="info-value">
                        {% if delivery.delivery_method == 'email' %}
                            <i class="bi bi-envelope"></i> é‚®ä»¶
                        {% elif delivery.delivery_method == 'express' %}
                            <i class="bi bi-box-seam"></i> å¿«é€’
                        {% elif delivery.delivery_method == 'hand_delivery' %}
                            <i class="bi bi-person-walking"></i> é€è¾¾
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">äº¤ä»˜çŠ¶æ€</span>
                    <span class="info-value">
                        <span class="status-badge {{ delivery.status }}">
                                    {{ delivery.get_status_display }}
                                </span>
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">ä¼˜å…ˆçº§</span>
                    <span class="info-value">
                        {% if delivery.priority == 'urgent' %}
                            <span class="badge bg-danger">ç´§æ€¥</span>
                        {% elif delivery.priority == 'high' %}
                            <span class="badge bg-warning">é«˜</span>
                        {% elif delivery.priority == 'normal' %}
                            <span class="badge bg-info">æ™®é€š</span>
                        {% else %}
                            <span class="badge bg-secondary">ä½</span>
                        {% endif %}
                    </span>
                </div>
                {% if delivery.deadline %}
                <div class="info-item">
                    <span class="info-label">äº¤ä»˜æœŸé™</span>
                    <span class="info-value {% if delivery.is_overdue %}text-danger{% endif %}">
                        {{ delivery.deadline|date:"Y-m-d H:i" }}
                        {% if delivery.is_overdue %}
                            <span class="badge bg-danger ms-2">é€¾æœŸ {{ delivery.overdue_days }} å¤©</span>
                        {% endif %}
                    </span>
                </div>
                {% endif %}
                {% if delivery.scheduled_delivery_time %}
                <div class="info-item">
                    <span class="info-label">è®¡åˆ’äº¤ä»˜æ—¶é—´</span>
                    <span class="info-value">{{ delivery.scheduled_delivery_time|date:"Y-m-d H:i" }}</span>
                </div>
                {% endif %}
                {% if delivery.description %}
                <div class="info-item info-item-full-width">
                    <span class="info-label">äº¤ä»˜è¯´æ˜</span>
                    <span class="info-value">{{ delivery.description|linebreaks }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">å…³è”ä¿¡æ¯</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                {% if delivery.project %}
                <div class="info-item">
                    <span class="info-label">å…³è”é¡¹ç›®</span>
                    <span class="info-value">
                        <a href="#" class="info-value-link">
                            {{ delivery.project.project_number }} - {{ delivery.project.name }}
                        </a>
                    </span>
                </div>
                {% endif %}
                {% if delivery.client %}
                <div class="info-item">
                    <span class="info-label">å…³è”å®¢æˆ·</span>
                    <span class="info-value">
                        <a href="#" class="info-value-link">{{ delivery.client.name }}</a>
                    </span>
                </div>
                {% endif %}
                {% if delivery.created_by %}
                <div class="info-item">
                    <span class="info-label">åˆ›å»ºäºº</span>
                    <span class="info-value">{{ delivery.created_by.get_full_name|default:delivery.created_by.username }}</span>
                </div>
                {% endif %}
                <div class="info-item">
                    <span class="info-label">åˆ›å»ºæ—¶é—´</span>
                    <span class="info-value">{{ delivery.created_at|date:"Y-m-d H:i" }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">æ”¶ä»¶äººä¿¡æ¯</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                <div class="info-item">
                    <span class="info-label">æ”¶ä»¶äººå§“å</span>
                    <span class="info-value">{{ delivery.recipient_name }}</span>
                </div>
                        {% if delivery.recipient_phone %}
                <div class="info-item">
                    <span class="info-label">è”ç³»ç”µè¯</span>
                    <span class="info-value">
                        <a href="tel:{{ delivery.recipient_phone }}" class="info-value-link">
                            <i class="bi bi-telephone"></i> {{ delivery.recipient_phone }}
                        </a>
                    </span>
                </div>
                        {% endif %}
                        {% if delivery.recipient_email %}
                <div class="info-item">
                    <span class="info-label">é‚®ç®±åœ°å€</span>
                    <span class="info-value">
                        <a href="mailto:{{ delivery.recipient_email }}" class="info-value-link">
                            <i class="bi bi-envelope"></i> {{ delivery.recipient_email }}
                        </a>
                    </span>
                </div>
                        {% endif %}
                        {% if delivery.recipient_address %}
                <div class="info-item info-item-full-width">
                    <span class="info-label">æ”¶ä»¶åœ°å€</span>
                    <span class="info-value">{{ delivery.recipient_address }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if delivery.delivery_method == 'email' %}
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">é‚®ä»¶ä¿¡æ¯</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                {% if delivery.email_subject %}
                <div class="info-item info-item-full-width">
                    <span class="info-label">é‚®ä»¶ä¸»é¢˜</span>
                    <span class="info-value">{{ delivery.email_subject }}</span>
                </div>
                {% endif %}
                {% if delivery.cc_emails %}
                <div class="info-item">
                    <span class="info-label">æŠ„é€é‚®ç®±</span>
                    <span class="info-value">{{ delivery.cc_emails }}</span>
                </div>
                {% endif %}
                {% if delivery.bcc_emails %}
                <div class="info-item">
                    <span class="info-label">å¯†é€é‚®ç®±</span>
                    <span class="info-value">{{ delivery.bcc_emails }}</span>
                </div>
                {% endif %}
                {% if delivery.email_message %}
                <div class="info-item info-item-full-width">
                    <span class="info-label">é‚®ä»¶æ­£æ–‡</span>
                    <div class="info-value">{{ delivery.email_message|safe }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if delivery.delivery_method == 'express' %}
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">å¿«é€’ä¿¡æ¯</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                {% if delivery.express_company %}
                <div class="info-item">
                    <span class="info-label">å¿«é€’å…¬å¸</span>
                    <span class="info-value">{{ delivery.express_company }}</span>
                </div>
                {% endif %}
                {% if delivery.express_number %}
                <div class="info-item">
                    <span class="info-label">å¿«é€’å•å·</span>
                    <span class="info-value">
                        <a href="#" class="info-value-link" target="_blank">
                            {{ delivery.express_number }}
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </span>
                </div>
                {% endif %}
                {% if delivery.express_fee %}
                <div class="info-item">
                    <span class="info-label">å¿«é€’è´¹ç”¨</span>
                    <span class="info-value info-value-numeric">Â¥{{ delivery.express_fee }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if delivery.delivery_method == 'hand_delivery' %}
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">é€è¾¾ä¿¡æ¯</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                {% if delivery.delivery_person %}
                <div class="info-item">
                    <span class="info-label">é€è¾¾äºº</span>
                    <span class="info-value">{{ delivery.delivery_person.get_full_name|default:delivery.delivery_person.username }}</span>
                </div>
                        {% endif %}
                {% if delivery.delivery_notes %}
                <div class="info-item info-item-full-width">
                    <span class="info-label">é€è¾¾å¤‡æ³¨</span>
                    <span class="info-value">{{ delivery.delivery_notes|linebreaks }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
            
            {% if delivery.files.exists %}
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">äº¤ä»˜æ–‡ä»¶</h5>
            <div class="info-card-actions">
                <span class="badge bg-secondary">{{ delivery.files.count }} ä¸ªæ–‡ä»¶</span>
            </div>
        </div>
        <div class="info-card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>æ–‡ä»¶å</th>
                            <th>ç±»å‹</th>
                            <th>å¤§å°</th>
                            <th>ä¸Šä¼ æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in delivery.files.all %}
                        <tr>
                            <td>
                                <i class="bi bi-file-earmark"></i>
                                {{ file.file_name }}
                            </td>
                            <td>
                                <span class="badge bg-info">{{ file.get_file_type_display }}</span>
                            </td>
                            <td>{{ file.get_file_size_display }}</td>
                            <td>{{ file.uploaded_at|date:"Y-m-d H:i" }}</td>
                            <td>
                                <a href="{{ file.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="bi bi-download"></i> ä¸‹è½½
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
            </div>
            {% endif %}
            
            {% if delivery.tracking_records.exists %}
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">è·Ÿè¸ªè®°å½•</h5>
        </div>
        <div class="info-card-body">
                <div class="timeline">
                    {% for tracking in delivery.tracking_records.all %}
                    <div class="timeline-item">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ tracking.get_event_type_display }}</h6>
                                <p class="mb-1">{{ tracking.event_description }}</p>
                                {% if tracking.location %}
                                <p class="text-muted small mb-0">
                                    <i class="bi bi-geo-alt"></i> {{ tracking.location }}
                                </p>
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ tracking.event_time|date:"Y-m-d H:i" }}</small>
                        </div>
                        {% if tracking.operator %}
                        <p class="text-muted small mt-1 mb-0">
                            <i class="bi bi-person"></i> {{ tracking.operator.get_full_name|default:tracking.operator.username }}
                        </p>
                        {% endif %}
                        </div>
                    </div>
                    {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if delivery.feedbacks.exists %}
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">å®¢æˆ·åé¦ˆ</h5>
        </div>
        <div class="info-card-body">
            {% for feedback in delivery.feedbacks.all %}
            <div class="info-card info-card-flat mb-3">
                <div class="info-card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="status-badge {{ feedback.feedback_type }}">
                                {{ feedback.get_feedback_type_display }}
                            </span>
                            <span class="ms-2 text-muted">
                                <i class="bi bi-person"></i> {{ feedback.feedback_by }}
                            </span>
                        </div>
                        <small class="text-muted">{{ feedback.created_at|date:"Y-m-d H:i" }}</small>
                    </div>
                    <div class="info-value">{{ feedback.content|linebreaks }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">æ—¶é—´çº¿</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                <div class="info-item">
                    <span class="info-label">åˆ›å»ºæ—¶é—´</span>
                    <span class="info-value">{{ delivery.created_at|date:"Y-m-d H:i:s" }}</span>
                </div>
                {% if delivery.submitted_at %}
                <div class="info-item">
                    <span class="info-label">æŠ¥é€æ—¶é—´</span>
                    <span class="info-value">{{ delivery.submitted_at|date:"Y-m-d H:i:s" }}</span>
                </div>
                {% endif %}
                {% if delivery.sent_at %}
                <div class="info-item">
                    <span class="info-label">å‘é€æ—¶é—´</span>
                    <span class="info-value">{{ delivery.sent_at|date:"Y-m-d H:i:s" }}</span>
                </div>
                {% endif %}
                {% if delivery.delivered_at %}
                <div class="info-item">
                    <span class="info-label">é€è¾¾æ—¶é—´</span>
                    <span class="info-value">{{ delivery.delivered_at|date:"Y-m-d H:i:s" }}</span>
                </div>
                {% endif %}
                {% if delivery.received_at %}
                <div class="info-item">
                    <span class="info-label">æ¥æ”¶æ—¶é—´</span>
                    <span class="info-value">{{ delivery.received_at|date:"Y-m-d H:i:s" }}</span>
                </div>
                {% endif %}
                {% if delivery.confirmed_at %}
                <div class="info-item">
                    <span class="info-label">ç¡®è®¤æ—¶é—´</span>
                    <span class="info-value">{{ delivery.confirmed_at|date:"Y-m-d H:i:s" }}</span>
                </div>
                {% endif %}
                {% if delivery.archived_at %}
                <div class="info-item">
                    <span class="info-label">å½’æ¡£æ—¶é—´</span>
                    <span class="info-value">{{ delivery.archived_at|date:"Y-m-d H:i:s" }}</span>
            </div>
            {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
/* æ—¶é—´çº¿æ ·å¼ */
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    padding-bottom: 20px;
}

.timeline-item:last-child {
    padding-bottom: 0;
}

.timeline-marker {
    position: absolute;
    left: -30px;
    top: 4px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--vh-primary);
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px var(--vh-primary);
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -25px;
    top: 16px;
    width: 2px;
    height: calc(100% - 4px);
    background: var(--vh-border);
}

.timeline-content {
    background: var(--vh-surface);
    padding: 12px;
    border-radius: var(--radius-md);
    border-left: 3px solid var(--vh-primary);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function confirmDelete(deliveryId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤äº¤ä»˜è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        window.location.href = "{% url 'delivery_pages:delivery_delete' delivery.id %}";
    }
}
</script>
{% endblock %}
