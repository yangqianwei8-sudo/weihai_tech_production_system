{% extends "delivery_customer/base.html" %}
{% load static %}

{% block title %}ç‰©æµè·Ÿè¸ª - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'delivery_pages:report_delivery' %}">æ”¶å‘ç®¡ç†</a></li>
<li class="breadcrumb-item"><a href="{% url 'delivery_pages:delivery_logistics_list' %}">ç‰©æµè·Ÿè¸ª</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ delivery.delivery_number }}</li>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">ğŸšš ç‰©æµè·Ÿè¸ª</h2>
            <p class="text-muted mb-0">äº¤ä»˜å•å·ï¼š{{ delivery.delivery_number }}</p>
        </div>
        <div>
            <a href="{% url 'delivery_pages:delivery_logistics_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> è¿”å›åˆ—è¡¨
            </a>
            <a href="{% url 'delivery_pages:delivery_detail' delivery.id %}" class="btn btn-outline-primary">
                <i class="bi bi-eye"></i> æŸ¥çœ‹è¯¦æƒ…
            </a>
        </div>
    </div>

    <div class="info-card info-card-fade-in mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">å¿«é€’ä¿¡æ¯</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                <div class="info-item">
                    <span class="info-label">äº¤ä»˜å•å·</span>
                    <span class="info-value info-value-bold">{{ delivery.delivery_number }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">äº¤ä»˜æ ‡é¢˜</span>
                    <span class="info-value">{{ delivery.title }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å¿«é€’å…¬å¸</span>
                    <span class="info-value">
                        {% if delivery.express_company %}
                            {{ delivery.express_company }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">å¿«é€’å•å·</span>
                    <span class="info-value">
                        {% if delivery.express_number %}
                            <code>{{ delivery.express_number }}</code>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">ç‰©æµçŠ¶æ€</span>
                    <span class="info-value">
                        {% if delivery.status == 'in_transit' %}
                            <span class="status-badge in_transit">è¿è¾“ä¸­</span>
                        {% elif delivery.status == 'delivered' %}
                            <span class="status-badge delivered">å·²é€è¾¾</span>
                        {% elif delivery.status == 'failed' %}
                            <span class="status-badge failed">å¤±è´¥</span>
                        {% else %}
                            <span class="status-badge {{ delivery.status }}">{{ delivery.get_status_display }}</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">å¿«é€’è´¹ç”¨</span>
                    <span class="info-value">
                        {% if delivery.express_fee %}
                            Â¥{{ delivery.express_fee }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ”¶ä»¶äºº</span>
                    <span class="info-value">{{ delivery.recipient_name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ”¶ä»¶åœ°å€</span>
                    <span class="info-value">{{ delivery.recipient_address|default:"-" }}</span>
                </div>
            </div>
        </div>
    </div>

    {% if delivery.express_number %}
    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">ç‰©æµæ“ä½œ</h5>
            <div class="info-card-actions">
                {% if delivery.status == 'in_transit' %}
                <button type="button" class="btn btn-sm btn-outline-info" onclick="autoRefresh()" id="autoRefreshBtn">
                    <i class="bi bi-arrow-clockwise"></i> è‡ªåŠ¨åˆ·æ–°
                </button>
                {% endif %}
            </div>
        </div>
        <div class="info-card-body">
            <div class="row">
                <div class="col-md-6">
                    <form method="post" id="queryLogisticsForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="query_logistics">
                        <button type="submit" class="btn btn-primary w-100" id="queryBtn">
                            <i class="bi bi-search"></i> å®æ—¶æŸ¥è¯¢ç‰©æµä¿¡æ¯
                        </button>
                        <small class="text-muted d-block mt-2">è°ƒç”¨å¿«é€’APIå®æ—¶æŸ¥è¯¢ç‰©æµçŠ¶æ€</small>
                    </form>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#updateTrackingModal">
                        <i class="bi bi-pencil"></i> æ‰‹åŠ¨æ›´æ–°ç‰©æµçŠ¶æ€
                    </button>
                    <small class="text-muted d-block mt-2">æ‰‹åŠ¨æ›´æ–°ç‰©æµçŠ¶æ€å’Œä½ç½®ä¿¡æ¯</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">ç‰©æµè½¨è¿¹</h5>
        </div>
        <div class="info-card-body">
            {% if logistics_timeline %}
            <div class="timeline">
                {% for item in logistics_timeline %}
                <div class="timeline-item">
                    <div class="timeline-marker">
                        <i class="bi bi-circle-fill"></i>
                    </div>
                    <div class="timeline-content">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">{{ item.event }}</h6>
                                <p class="mb-1 text-muted">{{ item.description }}</p>
                                {% if item.location %}
                                <small class="text-muted">
                                    <i class="bi bi-geo-alt"></i> {{ item.location }}
                                </small>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                <small class="text-muted">{{ item.time|date:"Y-m-d H:i:s" }}</small>
                                <br>
                                <small class="text-muted">{{ item.operator }}</small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-3">æš‚æ— ç‰©æµè½¨è¿¹è®°å½•</p>
                {% if delivery.express_number %}
                <button type="button" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#updateTrackingModal">
                    <i class="bi bi-plus-circle"></i> æ·»åŠ ç‰©æµè®°å½•
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    {% if delivery.project %}
    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">å…³è”é¡¹ç›®</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                <div class="info-item">
                    <span class="info-label">é¡¹ç›®ç¼–å·</span>
                    <span class="info-value">
                        <a href="#" class="text-decoration-none">
                            {{ delivery.project.project_number }}
                        </a>
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¡¹ç›®åç§°</span>
                    <span class="info-value">{{ delivery.project.name }}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="updateTrackingModal" tabindex="-1" aria-labelledby="updateTrackingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" id="updateTrackingForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_tracking">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateTrackingModalLabel">æ‰‹åŠ¨æ›´æ–°ç‰©æµçŠ¶æ€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ç‰©æµçŠ¶æ€ <span class="text-danger">*</span></label>
                        <select name="tracking_status" class="form-select" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="submitted">å·²æŠ¥é€</option>
                            <option value="sent">å·²å‘é€/å·²å¯„å‡º</option>
                            <option value="in_transit">è¿è¾“ä¸­</option>
                            <option value="out_for_delivery">æ´¾é€ä¸­</option>
                            <option value="delivered">å·²é€è¾¾</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä½ç½®ä¿¡æ¯</label>
                        <input type="text" name="tracking_location" class="form-control"
                               placeholder="è¯·è¾“å…¥ä½ç½®ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æè¿°ä¿¡æ¯</label>
                        <textarea name="tracking_description" class="form-control" rows="3"
                                  placeholder="è¯·è¾“å…¥æè¿°ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    padding-bottom: 30px;
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -25px;
    top: 20px;
    width: 2px;
    height: calc(100% - 10px);
    background-color: #e0e0e0;
}

.timeline-marker {
    position: absolute;
    left: -30px;
    top: 0;
    width: 20px;
    height: 20px;
    background-color: #fff;
    border: 2px solid #007bff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.timeline-marker i {
    font-size: 8px;
    color: #007bff;
}

.timeline-content {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #007bff;
}

#queryBtn.loading {
    pointer-events: none;
    opacity: 0.6;
}

#queryBtn.loading::after {
    content: ' æŸ¥è¯¢ä¸­...';
}
</style>

<script>
let autoRefreshInterval = null;

function autoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    const form = document.getElementById('queryLogisticsForm');

    if (autoRefreshInterval) {
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> è‡ªåŠ¨åˆ·æ–°';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-info');
    } else {
        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        autoRefreshInterval = setInterval(function() {
            form.submit();
        }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡

        btn.innerHTML = '<i class="bi bi-pause-circle"></i> åœæ­¢åˆ·æ–°';
        btn.classList.remove('btn-outline-info');
        btn.classList.add('btn-success');
    }
}

// æŸ¥è¯¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
document.getElementById('queryLogisticsForm').addEventListener('submit', function(e) {
    const btn = document.getElementById('queryBtn');
    btn.classList.add('loading');
    btn.disabled = true;

    // å¦‚æœ30ç§’åæŒ‰é’®è¿˜æ˜¯loadingçŠ¶æ€ï¼Œæ¢å¤æŒ‰é’®
    setTimeout(function() {
        btn.classList.remove('loading');
        btn.disabled = false;
    }, 30000);
});
</script>
{% endblock %}
