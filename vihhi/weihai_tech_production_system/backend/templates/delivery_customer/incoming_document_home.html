{% extends "shared/module_home_base.html" %}
{% load static %}

{% block module_styles %}
<style>
  .pm-home-wrap { padding: 0; }
  .pm-top-actions { display: flex; gap: 12px; margin-bottom: 24px; padding: 16px; background: #FFFFFF; border: 1px solid #E0E0E0; }
  .pm-top-action-btn { padding: 8px 16px; background: #333333; color: #FFFFFF; border: none; border-radius: 4px; text-decoration: none; font-size: 14px; cursor: pointer; transition: background 0.2s; }
  .pm-top-action-btn:hover { background: #1A1A1A; color: #FFFFFF; text-decoration: none; }
  .pm-core-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
  @media (max-width: 1200px) { .pm-core-cards { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 768px) { .pm-core-cards { grid-template-columns: 1fr; } }
  .pm-core-card { background: #FFFFFF; border: 1px solid #E0E0E0; border-radius: 4px; padding: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); transition: box-shadow 0.2s ease; text-decoration: none; color: inherit; display: block; }
  .pm-core-card:hover { box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); text-decoration: none; color: inherit; }
  .pm-core-card-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: #F5F5F5; border: 1px solid #E0E0E0; border-radius: 4px; font-size: 24px; margin-bottom: 12px; }
  .pm-core-card-label { font-size: 14px; color: #666666; font-weight: 400; margin-bottom: 8px; }
  .pm-core-card-value { font-size: 32px; font-weight: 600; color: #1A1A1A; margin-bottom: 8px; line-height: 1.2; }
  .pm-core-card-subvalue { font-size: 12px; color: #666666; line-height: 1.5; }
  .pm-stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
  @media (max-width: 768px) { .pm-stats-row { grid-template-columns: 1fr; } }
  .pm-warning-card, .pm-todo-card { background: #FFFFFF; border: 1px solid #E0E0E0; border-radius: 4px; padding: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
  .pm-card-title { font-size: 16px; font-weight: 600; color: #1A1A1A; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #E0E0E0; }
  .pm-warning-list, .pm-todo-list { list-style: none; padding: 0; margin: 0; }
  .pm-warning-item, .pm-todo-item { padding: 12px; margin-bottom: 8px; border-left: 3px solid #666666; background: #F5F5F5; border-radius: 4px; }
  .pm-item-title { font-size: 14px; font-weight: 500; color: #1A1A1A; margin-bottom: 4px; }
  .pm-item-meta { font-size: 12px; color: #666666; }
  .pm-item-link { color: #333333; text-decoration: none; }
  .pm-item-link:hover { text-decoration: underline; }
  .pm-my-work-card, .pm-activities-card { background: #FFFFFF; border: 1px solid #E0E0E0; border-radius: 4px; padding: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
  .pm-work-section { margin-bottom: 24px; }
  .pm-work-section:last-child { margin-bottom: 0; }
  .pm-work-section-title { font-size: 14px; font-weight: 600; color: #1A1A1A; margin-bottom: 12px; }
  .pm-work-list { list-style: none; padding: 0; margin: 0; }
  .pm-work-item { padding: 10px; margin-bottom: 8px; background: #F5F5F5; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
  .pm-work-item-title { font-size: 14px; color: #1A1A1A; flex: 1; }
  .pm-work-item-meta { font-size: 12px; color: #666666; margin-left: 12px; }
  .pm-activity-list { list-style: none; padding: 0; margin: 0; }
  .pm-activity-item { padding: 12px 0; border-bottom: 1px solid #E5E5E5; }
  .pm-activity-item:last-child { border-bottom: none; }
  .pm-activity-title { font-size: 14px; color: #1A1A1A; margin-bottom: 4px; }
  .pm-activity-meta { font-size: 12px; color: #666666; }
  .pm-empty { padding: 40px 20px; text-align: center; color: #999999; font-size: 14px; background: #FAFAFA; border: 1px dashed #E0E0E0; border-radius: 4px; }
</style>
{% endblock %}

{% block module_extra_js %}
<script src="{% static 'js/lib/chart.umd.min.js' %}"></script>
{% endblock %}

{% block module_home_custom_content %}
<div class="pm-home-wrap">
  {% if top_actions %}
  <div class="pm-top-actions">
    {% for action in top_actions %}
    <a href="{{ action.url }}" class="pm-top-action-btn">{{ action.icon }} {{ action.label }}</a>
    {% endfor %}
  </div>
  {% endif %}

  {% if core_cards %}
  <div class="pm-core-cards">
    {% for card in core_cards %}
    <a href="{{ card.url }}" class="pm-core-card">
      <div class="pm-core-card-icon">{{ card.icon }}</div>
      <div class="pm-core-card-label">{{ card.label }}</div>
      <div class="pm-core-card-value">{{ card.value }}</div>
      {% if card.subvalue %}<div class="pm-core-card-subvalue">{{ card.subvalue }}</div>{% endif %}
    </a>
    {% endfor %}
  </div>
  {% endif %}

  <div class="pm-stats-row">
    <div class="pm-warning-card">
      <div class="pm-card-title">é£é™©é¢„è­¦{% if stale_documents_count %}<span style="font-size: 12px; color: #333333; margin-left: 8px;">(æœªæ›´æ–° {{ stale_documents_count|default:0 }})</span>{% endif %}</div>
      {% if risk_warnings %}
      <ul class="pm-warning-list">
        {% for warning in risk_warnings %}
        <li class="pm-warning-item">
          <div class="pm-item-title"><a href="{{ warning.url }}" class="pm-item-link">{{ warning.title }}</a></div>
          <div class="pm-item-meta">è´Ÿè´£äººï¼š{{ warning.responsible }} | {{ warning.days }} å¤©æœªæ›´æ–°</div>
        </li>
        {% endfor %}
      </ul>
      {% else %}<div class="pm-empty">æš‚æ— é£é™©é¢„è­¦</div>{% endif %}
    </div>
    <div class="pm-todo-card">
      <div class="pm-card-title">å¾…åŠäº‹é¡¹{% if pending_approval_count %}<span style="font-size: 12px; color: #333333; margin-left: 8px;">(å¾…å¤„ç† {{ pending_approval_count|default:0 }})</span>{% endif %}</div>
      {% if todo_items %}
      <ul class="pm-todo-list">
        {% for item in todo_items %}
        <li class="pm-todo-item">
          <div class="pm-item-title"><a href="{{ item.url }}" class="pm-item-link">{{ item.title }}</a>{% if item.document_number %}<span style="font-size: 11px; color: #999; margin-left: 8px;">({{ item.document_number }})</span>{% endif %}</div>
          <div class="pm-item-meta">{% if item.type == 'register' %}<strong>å¾…ç™»è®°</strong> | åˆ›å»ºäººï¼š{{ item.responsible }}{% elif item.type == 'process' %}<strong>å¾…å¤„ç†</strong> | å¤„ç†äººï¼š{{ item.responsible }}{% endif %}</div>
        </li>
        {% endfor %}
      </ul>
      {% else %}<div class="pm-empty">æš‚æ— å¾…åŠäº‹é¡¹</div>{% endif %}
    </div>
  </div>

  <div class="pm-stats-row">
    <div class="pm-my-work-card">
      <div class="pm-card-title">{% if my_work.summary_url %}<a href="{{ my_work.summary_url }}" style="color: inherit; text-decoration: none;">æˆ‘çš„å·¥ä½œ</a>{% else %}æˆ‘çš„å·¥ä½œ{% endif %}</div>
      {% if my_work %}
      <div class="pm-work-section">
        <div class="pm-work-section-title">æˆ‘åˆ›å»ºçš„æ”¶æ–‡ ({{ my_work.my_documents_count|default:0 }})</div>
        {% if my_work.my_documents %}<ul class="pm-work-list">{% for doc in my_work.my_documents %}<li class="pm-work-item"><a href="{{ doc.url }}" class="pm-work-item-title">{{ doc.title }}</a><span class="pm-work-item-meta">{{ doc.status }}</span></li>{% endfor %}</ul>{% else %}<div class="pm-empty" style="padding: 20px;">æš‚æ— æ•°æ®</div>{% endif %}
      </div>
      <div class="pm-work-section">
        <div class="pm-work-section-title">æˆ‘å¤„ç†çš„æ”¶æ–‡ ({{ my_work.handled_documents_count|default:0 }})</div>
        {% if my_work.handled_documents %}<ul class="pm-work-list">{% for doc in my_work.handled_documents %}<li class="pm-work-item"><a href="{{ doc.url }}" class="pm-work-item-title">{{ doc.title }}</a><span class="pm-work-item-meta">{{ doc.status }}</span></li>{% endfor %}</ul>{% else %}<div class="pm-empty" style="padding: 20px;">æš‚æ— æ•°æ®</div>{% endif %}
      </div>
      {% else %}<div class="pm-empty">æš‚æ— æ•°æ®</div>{% endif %}
    </div>
    <div class="pm-activities-card">
      <div class="pm-card-title">æœ€è¿‘æ´»åŠ¨</div>
      {% if recent_activities %}<ul class="pm-activity-list">{% for doc in recent_activities.recent_documents %}<li class="pm-activity-item"><div class="pm-activity-title"><a href="{{ doc.url }}" class="pm-item-link">ğŸ“¥ {{ doc.title }}</a></div><div class="pm-activity-meta">{{ doc.creator }} åˆ›å»ºäº {{ doc.time|date:"Y-m-d H:i" }}</div></li>{% endfor %}{% for doc in recent_activities.recent_updates %}<li class="pm-activity-item"><div class="pm-activity-title"><a href="{{ doc.url }}" class="pm-item-link">ğŸ”„ {{ doc.title }}</a></div><div class="pm-activity-meta">{{ doc.updater }} æ›´æ–°äº {{ doc.time|date:"Y-m-d H:i" }}</div></li>{% endfor %}</ul>{% else %}<div class="pm-empty">æš‚æ— æ´»åŠ¨è®°å½•</div>{% endif %}
    </div>
  </div>
</div>
{% endblock %}
