<div class="list-filters">
  <form method="get" class="list-filters-form">
    <div class="list-filter-group">
      <label class="list-filter-label">搜索</label>
      <input type="text" name="search" class="list-filter-input"
             value="{{ search|default:search_query }}" placeholder="收文编号、标题、发文单位、联系人">
    </div>
    <div class="list-filter-group">
      <label class="list-filter-label">状态</label>
      <select name="status" class="list-filter-input">
        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>全部状态</option>
        {% for value, label in status_choices %}
        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="list-filter-group">
      <label class="list-filter-label">优先级</label>
      <select name="priority" class="list-filter-input">
        <option value="all" {% if priority_filter == 'all' %}selected{% endif %}>全部优先级</option>
        {% for value, label in priority_choices %}
        <option value="{{ value }}" {% if priority_filter == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="list-filter-group">
      <label class="list-filter-label">阶段</label>
      <select name="stage" class="list-filter-input" id="stage_filter" onchange="updateCategoryOptions()">
        <option value="all" {% if stage_filter == 'all' %}selected{% endif %}>全部阶段</option>
        {% for value, label in stage_choices %}
        <option value="{{ value }}" {% if stage_filter == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="list-filter-group">
      <label class="list-filter-label">文件分类</label>
      <select name="category" class="list-filter-input" id="category_filter">
        <option value="all" {% if category_filter == 'all' %}selected{% endif %}>全部分类</option>
        {% for category in categories %}
        <option value="{{ category.id }}" data-stage="{{ category.stage }}"
                {% if category_filter == category.id|stringformat:"s" %}selected{% endif %}
                style="{% if stage_filter != 'all' and category.stage != stage_filter %}display: none;{% endif %}">
          {{ category.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="list-filter-actions">
      <button type="submit" class="list-btn list-btn-primary">筛选</button>
      <a href="{% url 'delivery_pages:incoming_document_list' %}" class="list-btn">重置</a>
    </div>
  </form>
</div>

<script>
// 更新文件分类选项（根据选择的阶段）
function updateCategoryOptions() {
    const stageSelect = document.getElementById('stage_filter');
    const categorySelect = document.getElementById('category_filter');
    const selectedStage = stageSelect.value;

    // 显示/隐藏分类选项
    const options = categorySelect.querySelectorAll('option[data-stage]');
    options.forEach(option => {
        if (selectedStage === 'all' || option.getAttribute('data-stage') === selectedStage) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
            // 如果当前选中的分类不在当前阶段，重置为"全部"
            if (option.selected && option.getAttribute('data-stage') !== selectedStage) {
                categorySelect.value = 'all';
            }
        }
    });
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    updateCategoryOptions();
});
</script>
