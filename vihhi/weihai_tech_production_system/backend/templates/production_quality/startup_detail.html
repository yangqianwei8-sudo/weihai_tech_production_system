{% extends "production_quality/base.html" %}
{% load static %}

{% block title %}ç”Ÿäº§å¯åŠ¨è¯¦æƒ… - {{ project.name }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'production_quality_pages:production_startup_list' %}">ç”Ÿäº§å¯åŠ¨</a></li>
<li class="breadcrumb-item active">{{ project.name }}</li>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="center-hero">
        <h1 class="hero-title">ç”Ÿäº§å¯åŠ¨è¯¦æƒ…</h1>
        <p class="hero-subtitle">{{ project.name }}ï¼ˆ{{ project.project_number }}ï¼‰</p>
    </div>

    <!-- çŠ¶æ€å¡ç‰‡ -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">å¯åŠ¨çŠ¶æ€</h5>
            <span class="badge bg-{% if startup.status == 'approved' %}success{% elif startup.status == 'rejected' %}danger{% elif startup.status == 'waiting_approval' %}warning{% else %}info{% endif %}">
                {{ startup.get_status_display }}
            </span>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="info-box">
                        <strong>é¡¹ç›®æ¥æ”¶ï¼š</strong>
                        {% if startup.received_time %}
                            <span class="text-success">âœ“ å·²å®Œæˆ</span><br>
                            <small class="text-muted">{{ startup.received_time|date:"Y-m-d H:i" }}</small>
                        {% else %}
                            <span class="text-muted">å¾…æ¥æ”¶</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-box">
                        <strong>å›¾çº¸è½½å…¥ï¼š</strong>
                        {% if startup.drawings_uploaded %}
                            <span class="text-success">âœ“ å·²å®Œæˆ</span><br>
                            <small class="text-muted">{{ startup.drawings_upload_time|date:"Y-m-d H:i" }}</small>
                        {% else %}
                            <span class="text-muted">å¾…ä¸Šä¼ </span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-box">
                        <strong>å›¢é˜Ÿé…ç½®ï¼š</strong>
                        {% if startup.team_configured %}
                            <span class="text-success">âœ“ å·²å®Œæˆ</span><br>
                            <small class="text-muted">{{ startup.team_configured_time|date:"Y-m-d H:i" }}</small>
                        {% else %}
                            <span class="text-muted">å¾…é…ç½®</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="info-box">
                        <strong>ä»»åŠ¡æ¸…å•ï¼š</strong>
                        {% if startup.tasks_created %}
                            <span class="text-success">âœ“ å·²å®Œæˆ</span><br>
                            <small class="text-muted">{{ startup.tasks_created_time|date:"Y-m-d H:i" }}</small>
                        {% else %}
                            <span class="text-muted">å¾…åˆ›å»º</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex gap-2 flex-wrap">
                {% if can_upload_drawings %}
                <a href="{% url 'production_quality_pages:production_startup_upload_drawings' startup.id %}" class="btn btn-primary">
                    ğŸ“ ä¸Šä¼ å›¾çº¸
                </a>
                {% endif %}
                {% if can_configure_team %}
                <a href="{% url 'production_quality_pages:production_startup_configure_team' startup.id %}" class="btn btn-primary">
                    ğŸ‘¥ é…ç½®å›¢é˜Ÿ
                </a>
                {% endif %}
                {% if can_create_tasks %}
                <a href="{% url 'production_quality_pages:production_startup_create_tasks' startup.id %}" class="btn btn-primary">
                    ğŸ“‹ åˆ›å»ºä»»åŠ¡æ¸…å•
                </a>
                {% endif %}
                {% if can_submit %}
                <form method="post" action="{% url 'production_quality_pages:production_startup_submit' startup.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success" onclick="return confirm('ç¡®è®¤æäº¤å®¡æ‰¹ï¼Ÿ')">
                        âœ… æäº¤å®¡æ‰¹
                    </button>
                </form>
                {% endif %}
                {% if can_approve %}
                <a href="{% url 'production_quality_pages:production_startup_approve' startup.id %}" class="btn btn-warning">
                    ğŸ” å®¡æ‰¹
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- é¡¹ç›®ä¿¡æ¯ -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">é¡¹ç›®ä¿¡æ¯</h5>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <span class="info-label">é¡¹ç›®ç¼–å·ï¼š</span>
                        <span class="info-value">{{ project.project_number }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é¡¹ç›®åç§°ï¼š</span>
                        <span class="info-value">{{ project.name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é¡¹ç›®ç»ç†ï¼š</span>
                        <span class="info-value">
                            {% if startup.project_manager_assigned %}
                                {{ startup.project_manager_assigned.get_full_name|default:startup.project_manager_assigned.username }}
                            {% else %}
                                <span class="text-muted">æœªåˆ†é…</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">åˆåŒé‡‘é¢ï¼š</span>
                        <span class="info-value">Â¥{{ project.contract_amount|default:"0"|floatformat:2 }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é¢„è®¡èŠ‚çœï¼š</span>
                        <span class="info-value">Â¥{{ project.estimated_savings|default:"0"|floatformat:2 }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">ä»»åŠ¡ç»Ÿè®¡</h5>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <span class="info-label">ä»»åŠ¡æ€»æ•°ï¼š</span>
                        <span class="info-value">{{ startup.total_tasks }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">åˆåŒèŠ‚çœç›®æ ‡ï¼š</span>
                        <span class="info-value">Â¥{{ contract_saving_target|floatformat:2 }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ä»»åŠ¡èŠ‚çœç›®æ ‡æ€»é¢ï¼š</span>
                        <span class="info-value">Â¥{{ total_saving_target|floatformat:2 }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ç›®æ ‡å€æ•°ï¼š</span>
                        <span class="info-value">
                            {% if contract_saving_target > 0 %}
                                {% widthratio total_saving_target contract_saving_target 1 as ratio %}
                                {{ ratio|floatformat:2 }}å€
                            {% else %}
                                --
                            {% endif %}
                        </span>
                    </div>
                    {% if startup.total_saving_target and contract_saving_target %}
                        {% widthratio startup.total_saving_target contract_saving_target 1 as ratio %}
                        {% if ratio < 1.5 %}
                    <div class="alert alert-warning mt-3">
                        <small>âš ï¸ ä»»åŠ¡èŠ‚çœç›®æ ‡æ€»é¢ä½äºåˆåŒç›®æ ‡çš„1.5å€ï¼Œè¯·é‡æ–°åˆ†è§£ä»»åŠ¡</small>
                    </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾çº¸æ–‡ä»¶ -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">å›¾çº¸æ–‡ä»¶ï¼ˆ{{ drawing_files.count }}ï¼‰</h5>
        </div>
        <div class="card-body">
            {% if drawing_files %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>æ–‡ä»¶å</th>
                            <th>ç›®å½•</th>
                            <th>ç±»å‹</th>
                            <th>å¤§å°</th>
                            <th>ä¸Šä¼ æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in drawing_files %}
                        <tr>
                            <td>{{ file.file_name }}</td>
                            <td>{{ file.directory.path|default:"æ ¹ç›®å½•" }}</td>
                            <td>{{ file.get_file_type_display }}</td>
                            <td>{{ file.file_size|filesizeformat }}</td>
                            <td>{{ file.uploaded_time|date:"Y-m-d H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center mb-0">æš‚æ— å›¾çº¸æ–‡ä»¶</p>
            {% endif %}
        </div>
    </div>

    <!-- ä»»åŠ¡æ¸…å• -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ä»»åŠ¡æ¸…å•ï¼ˆ{{ task_breakdowns.count }}ï¼‰</h5>
        </div>
        <div class="card-body">
            {% if task_breakdowns %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ä»»åŠ¡ç¼–ç </th>
                            <th>ä»»åŠ¡åç§°</th>
                            <th>ä¸“ä¸š</th>
                            <th>åˆ†é…äººå‘˜</th>
                            <th>å»ºç­‘é¢ç§¯</th>
                            <th>èŠ‚çœç›®æ ‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in task_breakdowns %}
                        <tr>
                            <td>{{ task.task_code }}</td>
                            <td>{{ task.task_name }}</td>
                            <td>{{ task.profession.name }}</td>
                            <td>
                                {% if task.assigned_to %}
                                    {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                                {% else %}
                                    <span class="text-muted">æœªåˆ†é…</span>
                                {% endif %}
                            </td>
                            <td>{{ task.building_area|default:"--" }} ã¡</td>
                            <td>Â¥{{ task.saving_target|default:"0"|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center mb-0">æš‚æ— ä»»åŠ¡æ¸…å•</p>
            {% endif %}
        </div>
    </div>

    <!-- å®¡æ‰¹è®°å½• -->
    {% if approvals %}
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">å®¡æ‰¹è®°å½•</h5>
        </div>
        <div class="card-body">
            {% for approval in approvals %}
            <div class="border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>{{ approval.approver.get_full_name|default:approval.approver.username|default:"å¾…å®¡æ‰¹" }}</strong>
                        <span class="badge bg-{% if approval.decision == 'approved' %}success{% elif approval.decision == 'rejected' %}danger{% else %}warning{% endif %} ms-2">
                            {{ approval.get_decision_display }}
                        </span>
                    </div>
                    <small class="text-muted">{{ approval.approval_time|date:"Y-m-d H:i"|default:"å¾…å®¡æ‰¹" }}</small>
                </div>
                {% if approval.comment %}
                <p class="mt-2 mb-0">{{ approval.comment }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

