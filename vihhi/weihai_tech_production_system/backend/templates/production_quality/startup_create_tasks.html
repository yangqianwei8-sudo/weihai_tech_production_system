{% extends "production_quality/base.html" %}
{% load static %}

{% block title %}任务清单 - {{ project.name }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'production_quality_pages:production_startup_list' %}">生产启动</a></li>
<li class="breadcrumb-item"><a href="{% url 'production_quality_pages:production_startup_detail' startup.id %}">详情</a></li>
<li class="breadcrumb-item active">任务清单</li>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="center-hero">
        <h1 class="hero-title">任务清单</h1>
        <p class="hero-subtitle">{{ project.name }}（{{ project.project_number }}）</p>
    </div>

    <div class="alert alert-info">
        <strong>提示：</strong>
        <ul class="mb-0">
            <li>任务节省目标总额必须大于等于合同目标的1.5倍</li>
            <li>合同目标：¥{{ contract_saving_target|floatformat:2 }}</li>
            <li>最低要求：¥{{ required_saving_target|floatformat:2 }}</li>
        </ul>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">任务分解</h5>
        </div>
        <div class="card-body">
            <form method="post" id="tasksForm">
                {% csrf_token %}
                <div id="tasksContainer">
                    {% for task in task_breakdowns %}
                    <div class="task-item mb-3 p-3 border rounded">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label required">任务名称</label>
                                <input type="text" name="task_name" class="form-control" value="{{ task.task_name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required">所属专业</label>
                                <select name="profession_id" class="form-select" required>
                                    <option value="">-- 请选择 --</option>
                                    {% for profession in service_professions %}
                                    <option value="{{ profession.id }}" {% if task.profession_id == profession.id %}selected{% endif %}>
                                        {{ profession.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">分配人员</label>
                                <select name="assigned_to_id" class="form-select">
                                    <option value="">-- 请选择 --</option>
                                    {% for member in team_members %}
                                    <option value="{{ member.user.id }}" {% if task.assigned_to_id == member.user.id %}selected{% endif %}>
                                        {{ member.user.get_full_name|default:member.user.username }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">建筑面积（㎡）</label>
                                <input type="number" name="building_area" class="form-control" step="0.01" value="{{ task.building_area|default:'' }}">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">每平方米节省金额（元/㎡）</label>
                                <input type="number" name="saving_target_per_sqm" class="form-control" step="0.01" value="{{ task.saving_target_per_sqm|default:'' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">任务内容</label>
                                <textarea name="task_content" class="form-control" rows="2">{{ task.task_content }}</textarea>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeTask(this)">删除任务</button>
                    </div>
                    {% empty %}
                    <div class="task-item mb-3 p-3 border rounded">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label required">任务名称</label>
                                <input type="text" name="task_name" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required">所属专业</label>
                                <select name="profession_id" class="form-select" required>
                                    <option value="">-- 请选择 --</option>
                                    {% for profession in service_professions %}
                                    <option value="{{ profession.id }}">{{ profession.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">分配人员</label>
                                <select name="assigned_to_id" class="form-select">
                                    <option value="">-- 请选择 --</option>
                                    {% for member in team_members %}
                                    <option value="{{ member.user.id }}">{{ member.user.get_full_name|default:member.user.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">建筑面积（㎡）</label>
                                <input type="number" name="building_area" class="form-control" step="0.01">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label class="form-label">每平方米节省金额（元/㎡）</label>
                                <input type="number" name="saving_target_per_sqm" class="form-control" step="0.01">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">任务内容</label>
                                <textarea name="task_content" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeTask(this)">删除任务</button>
                    </div>
                    {% endfor %}
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button type="button" class="btn btn-outline-primary" onclick="addTask()">+ 添加任务</button>
                    <button type="submit" class="btn btn-primary">保存任务清单</button>
                    <a href="{% url 'production_quality_pages:production_startup_detail' startup.id %}" class="btn btn-secondary">返回</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function addTask() {
    const container = document.getElementById('tasksContainer');
    const template = container.querySelector('.task-item').cloneNode(true);
    
    // 重置所有输入
    template.querySelectorAll('input, select, textarea').forEach(input => {
        if (input.type === 'text' || input.type === 'number') {
            input.value = '';
        } else if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        } else if (input.tagName === 'TEXTAREA') {
            input.value = '';
        }
    });
    
    container.appendChild(template);
}

function removeTask(btn) {
    const container = document.getElementById('tasksContainer');
    if (container.children.length > 1) {
        btn.closest('.task-item').remove();
    } else {
        alert('至少需要保留一个任务');
    }
}

document.getElementById('tasksForm').addEventListener('submit', function(e) {
    const tasks = document.querySelectorAll('.task-item');
    const tasksData = [];
    
    tasks.forEach(task => {
        const taskName = task.querySelector('input[name="task_name"]').value;
        const professionId = task.querySelector('select[name="profession_id"]').value;
        
        if (taskName && professionId) {
            tasksData.push({
                task_name: taskName,
                profession_id: professionId,
                assigned_to_id: task.querySelector('select[name="assigned_to_id"]').value,
                building_area: task.querySelector('input[name="building_area"]').value,
                saving_target_per_sqm: task.querySelector('input[name="saving_target_per_sqm"]').value,
                task_content: task.querySelector('textarea[name="task_content"]').value,
                scope: []
            });
        }
    });
    
    if (tasksData.length === 0) {
        e.preventDefault();
        alert('请至少创建一个任务');
        return;
    }
    
    // 创建隐藏字段提交数据
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'tasks_data';
    hiddenInput.value = JSON.stringify(tasksData);
    this.appendChild(hiddenInput);
});
</script>
{% endblock %}

