{% extends "shared/_partials/_shared_form_wrapper_customer.html" %}

{% block pm_title %}{{ page_title|default:"创建拜访计划" }}{% endblock %}
{% block pm_subtitle %}<span class="pm-subtitle">{{ form_page_subtitle_text|default:"请填写拜访计划信息并准备沟通清单" }}</span>{% endblock %}
{% block pm_actions %}
<a href="{% url cancel_url_name|default:'business_pages:customer_visit' %}" class="form-btn form-btn-secondary">
  返回列表
</a>
{% endblock %}

{% load static %}
{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
{% endblock %}

{% block pm_content %}
<div class="form-container">

    {% if form.errors %}
    <div class="form-alert form-alert-danger">
        <div class="form-alert-title">提交失败：请完善必填项</div>
        <ul class="form-alert-list">
            {% for field in form %}
                {% if field.errors %}
                    <li><strong>{{ field.label }}</strong>：{{ field.errors|striptags }}</li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if visit_plan %}
    <div class="alert alert-info mb-3">
        <strong>客户：</strong>{{ visit_plan.client.name }}
    </div>
    {% endif %}

    <form method="post" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="form-alert form-alert-danger">
            <div class="form-alert-title">提交失败</div>
            <div class="form-alert-list">{{ form.non_field_errors }}</div>
        </div>
        {% endif %}

        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="{{ form.department.id_for_label }}">
                    {{ form.department.label }}
                </label>
                {{ form.department }}
            </div>
            <div class="form-group">
                <label class="form-label" for="{{ form.responsible_user.id_for_label }}">
                    {{ form.responsible_user.label }}
                </label>
                {{ form.responsible_user }}
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label required" for="{{ form.client.id_for_label }}">
                    {{ form.client.label }}
                </label>
                {{ form.client }}
                {% if form.client.errors %}
                <div class="form-error">{{ form.client.errors }}</div>
                {% endif %}
            </div>
            <div class="form-group">
                <label class="form-label required" for="{{ form.plan_date.id_for_label }}">
                    {{ form.plan_date.label }}
                </label>
                {{ form.plan_date }}
                {% if form.plan_date.errors %}
                <div class="form-error">{{ form.plan_date.errors }}</div>
                {% endif %}
            </div>
            <div class="form-group form-row-full">
                <label class="form-label" for="{{ form.location.id_for_label }}">
                    {{ form.location.label }}
                </label>
                {{ form.location }}
                <small class="text-muted">将根据客户办公地址自动填充</small>
            </div>
            <div class="form-group form-row-full">
                <label class="form-label" for="{{ form.related_opportunity.id_for_label }}">
                    {{ form.related_opportunity.label }}
                </label>
                {{ form.related_opportunity }}
            </div>
        </div>

<div class="form-row">
                        {% if questions_by_part %}

                        {% for part, questions in questions_by_part.items %}
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    {% if part == 'part1' %}第一部分：客户与项目背景信息
                                    {% elif part == 'part2' %}第二部分：沟通目标与内容准备
                                    {% elif part == 'part3' %}第三部分：沟通策略与风险预案
                                    {% elif part == 'part4' %}第四部分：后勤与状态
                                    {% else %}{{ part }}{% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                {% for question in questions %}
                                <div class="mb-3 pb-3 border-bottom">
                                    <div class="d-flex align-items-start mb-2">
                                        <span class="badge bg-secondary me-2">{{ forloop.counter }}</span>
                                        <label class="form-label mb-0 flex-grow-1">{{ question.question_text }}</label>
                                    </div>
                                    <div class="ms-4">
                                        {% with answer_data=existing_answers|dictsort:question.id|first %}
                                        {% if answer_data %}{% with current_answer=answer_data.answer|default:'unknown' %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="question_{{ question.id }}_yes" value="yes" {% if current_answer == 'yes' %}checked{% endif %}>
                                            <label class="form-check-label" for="question_{{ question.id }}_yes">是</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="question_{{ question.id }}_no" value="no" {% if current_answer == 'no' %}checked{% endif %}>
                                            <label class="form-check-label" for="question_{{ question.id }}_no">否</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="question_{{ question.id }}_unknown" value="unknown" {% if current_answer == 'unknown' or not answer_data %}checked{% endif %}>
                                            <label class="form-check-label" for="question_{{ question.id }}_unknown">不清楚</label>
                                        </div>
                                        {% endwith %}
                                    {% else %}
                                        {% with current_answer='unknown' %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="question_{{ question.id }}_yes" value="yes">
                                            <label class="form-check-label" for="question_{{ question.id }}_yes">是</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="question_{{ question.id }}_no" value="no">
                                            <label class="form-check-label" for="question_{{ question.id }}_no">否</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="question_{{ question.id }}_unknown" value="unknown" checked>
                                            <label class="form-check-label" for="question_{{ question.id }}_unknown">不清楚</label>
                                        </div>
                                        {% endwith %}
                                        {% endif %}
                                        {% endwith %}
                                    </div>
                                    <div class="mt-2 ms-4">
                                        <label class="form-label small">沟通前说明：</label>
                                        {% with answer_data=existing_answers|dictsort:question.id|first %}
                                        <textarea class="form-control form-control-sm" name="note_before_{{ question.id }}" rows="2" placeholder="请输入沟通前的准备说明（可选）">{% if answer_data %}{{ answer_data.note_before|default:'' }}{% endif %}</textarea>
                                        {% endwith %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}

                        <div class="mt-3">
                            <label class="form-label required">{{ form.communication_checklist.label }}</label>
                            {{ form.communication_checklist }}
                            {% if form.communication_checklist.errors %}
                            <div class="form-error">{{ form.communication_checklist.errors }}</div>
                            {% endif %}
                            <small class="text-muted">请总结沟通清单的关键要点和注意事项</small>
                        </div>
                        {% else %}

                        <div class="form-group form-row-full">
                            <label class="form-label required">{{ form.communication_checklist.label }}</label>
                            {{ form.communication_checklist }}
                            {% if form.communication_checklist.errors %}
                            <div class="form-error">{{ form.communication_checklist.errors }}</div>
                            {% endif %}
                            <small class="text-muted">请详细列出拜访前需要准备的沟通要点、资料和注意事项</small>
                        </div>
                        {% endif %}
                    </div>

        <div class="form-actions">
            <div class="form-actions-left">
                <a href="{% url cancel_url_name|default:'business_pages:customer_visit' %}" class="form-btn form-btn-secondary">取消</a>
                <button type="submit" class="form-btn form-btn-primary">提交</button>
            </div>
        </div>
    </form>
</div>

<script>
// 安全的HTML设置函数
    function setSafeHTML(element, html) {
        if (!element) return;
        // 如果内容不包含HTML标签，使用textContent
        if (!/<[^>]+>/.test(html)) {
            element.textContent = html;
        } else {
            // 对于包含HTML的内容，使用innerHTML（假设内容已清理）
            // 在生产环境中，应该使用DOMPurify等库清理HTML
            element.innerHTML = html;
        }
    }

    // 安全的文本设置函数（推荐使用）
    function setSafeText(element, text) {
        if (element) {
            element.textContent = text;
        }
    }

    // 根据客户选择自动填充拜访地点和更新商机选项
    (function() {
        const clientSelect = document.getElementById('id_client');
        const locationInput = document.getElementById('id_location');
        const opportunitySelect = document.getElementById('id_related_opportunity');
        const clientsWithAddress = {{ clients_with_address_json|safe|default:"{}" }};
        const clientsOpportunities = {{ clients_opportunities_json|safe|default:"{}" }};

        function updateLocation() {
            if (clientSelect && locationInput) {
                const clientId = clientSelect.value;
                if (clientId && clientsWithAddress[clientId]) {
                    locationInput.value = clientsWithAddress[clientId];
                } else {
                    locationInput.value = '';
                }
            }
        }

        function updateOpportunities() {
            if (clientSelect && opportunitySelect) {
                const clientId = clientSelect.value;

                // 清空当前选项
                opportunitySelect.textContent = '';

                // 添加默认选项
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- 选择关联商机（可选） --';
                opportunitySelect.appendChild(defaultOption);

                // 如果选择了客户，显示该客户的商机
                if (clientId && clientsOpportunities[clientId]) {
                    const opportunities = clientsOpportunities[clientId];
                    opportunities.forEach(function(opp) {
                        const option = document.createElement('option');
                        option.value = opp.id;
                        option.textContent = opp.name;
                        opportunitySelect.appendChild(option);
                    });
                } else if (clientId) {
                    // 如果选择了客户但没有商机，显示提示
                    const noOption = document.createElement('option');
                    noOption.value = '';
                    noOption.textContent = '-- 该客户暂无可用商机 --';
                    noOption.disabled = true;
                    opportunitySelect.appendChild(noOption);
                }
            }
        }

        if (clientSelect) {
            // 监听客户选择变化
            clientSelect.addEventListener('change', function() {
                updateLocation();
                updateOpportunities();
            });

            // 初始化
            updateLocation();
            updateOpportunities();
        }
    })();
</script>
{% endblock %}
