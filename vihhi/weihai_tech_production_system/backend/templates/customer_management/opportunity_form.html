{% extends "customer_management/_base.html" %}
{% load static %}

{% block pm_title %}{{ page_title|default:"创建商机" }}{% endblock %}
{% block pm_subtitle %}<span class="pm-subtitle">请填写商机基本信息</span>{% endblock %}

{% block pm_actions %}
<a href="{% if opportunity %}{% url 'opportunity_pages:opportunity_detail' opportunity.id %}{% else %}{% url 'opportunity_pages:opportunity_management' %}{% endif %}" class="list-btn">
  返回列表
</a>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/list_layout.css' %}">
<script src="{% static 'js/amap-district-selector.js' %}"></script>
<style>
  .form-container {
    background: #FFFFFF;
    border: 1px solid #E0E0E0;
    border-radius: 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 24px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    font-size: 12px;
    color: #666666;
    margin-bottom: 6px;
    display: block;
    font-weight: 500;
  }

  .form-label.required::after {
    content: ' *';
    color: #999999;
  }

  .form-control,
  .form-select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #E0E0E0;
    border-radius: 0;
    font-size: 14px;
    color: #333333;
    background: #FFFFFF;
  }

  .form-control:focus,
  .form-select:focus {
    outline: none;
    border-color: #999999;
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
  }

  .form-control[readonly],
  .form-control[disabled] {
    background: #F5F5F5;
    color: #666666;
  }

  .form-text {
    font-size: 12px;
    color: #999999;
    margin-top: 4px;
  }

  .form-error {
    font-size: 12px;
    color: #999999;
    margin-top: 4px;
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid #E0E0E0;
  }

  .form-alert {
    background: #F5F5F5;
    border: 1px solid #E0E0E0;
    border-radius: 0;
    padding: 12px 16px;
    margin-bottom: 20px;
  }

  .form-alert-danger {
    background: #FAFAFA;
    border-color: #E0E0E0;
    color: #666666;
  }

  .form-alert-title {
    font-size: 14px;
    font-weight: 600;
    color: #1A1A1A;
    margin-bottom: 8px;
  }

  .form-alert-list {
    margin: 0;
    padding-left: 20px;
    font-size: 12px;
    color: #666666;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }

  .form-row-full {
    grid-column: 1 / -1;
  }

  .form-section {
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid #E0E0E0;
  }

  .form-section:last-child {
    border-bottom: none;
  }

  .form-section-title {
    font-size: 14px;
    font-weight: 600;
    color: #1A1A1A;
    margin-bottom: 16px;
  }

  .form-check {
    margin-bottom: 8px;
  }

  .form-check-input {
    margin-right: 6px;
  }

  .form-check-label {
    font-size: 12px;
    color: #666666;
    cursor: pointer;
  }

  .input-group {
    display: flex;
    gap: 8px;
  }

  .input-group .form-select {
    flex: 1;
  }

  @media (max-width: 768px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block pm_content %}
<div class="form-container">
  {% include "customer_management/_partials/_form_errors.html" %}

  <form method="post" id="opportunityForm" novalidate>
    {% csrf_token %}

    {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
      <div class="form-alert form-alert-danger">
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}

<form method="post" id="opportunityForm" novalidate>
        {% csrf_token %}

        <div class="form-section">
            <div class="form-section-title">基本信息</div>
                <div class="form-row" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="form-group">
                        <label class="form-label">商机编号</label>
                        <input type="text" id="opportunity_number_preview" class="form-control"
                               value="{% if opportunity %}{{ opportunity.opportunity_number|default:'' }}{% else %}{{ preview_opportunity_number|default:'' }}{% endif %}"
                               readonly
                               disabled
                               style="background-color: #f8f9fa; color: #6c757d; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">关联客户</label>
                        <div class="mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="filter_my_clients"
                                       style="cursor: pointer;">
                                <label class="form-check-label" for="filter_my_clients" style="cursor: pointer;">
                                    仅显示本人负责的客户
                                </label>
                            </div>
                        </div>
                        <div class="input-group">
                            <select name="client_id" class="form-select" required id="client_select">
                                <option value="">请选择客户</option>
                                {% for client in clients %}
                                <option value="{{ client.id }}"
                                        {% if opportunity.client_id == client.id %}selected{% endif %}
                                        data-responsible-user-id="{% if client.responsible_user %}{{ client.responsible_user.id }}{% else %}{% endif %}">
                                    {{ client.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <a href="{% url 'business_pages:customer_create' %}" target="_blank" class="list-btn" title="新建客户">
                                <i class="bi bi-plus-circle"></i> 新建
                            </a>
                        </div>
                        {% if not clients %}
                        <small class="text-warning">
                            <i class="bi bi-exclamation-triangle"></i> 暂无客户数据，请先
                            <a href="{% url 'business_pages:customer_create' %}" target="_blank">创建客户</a>
                        </small>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="form-label">商机类型</label>
                        <select name="opportunity_type" class="form-select">
                            <option value="">请选择</option>
                            <option value="project_cooperation" {% if opportunity.opportunity_type == 'project_cooperation' %}selected{% endif %}>项目合作</option>
                            <option value="centralized_procurement" {% if opportunity.opportunity_type == 'centralized_procurement' %}selected{% endif %}>集中采购</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">服务类型</label>
                        <select name="service_type_id" class="form-select">
                            <option value="">请选择服务类型</option>
                            {% for service_type in service_types %}
                            <option value="{{ service_type.id }}" {% if opportunity.service_type_id == service_type.id %}selected{% endif %}>{{ service_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
          </div>

        <div class="form-section">
            <div class="form-section-title">项目信息</div>
                <div class="info-section">
                    <h6 class="info-section-title">基本信息</h6>
                    <div class="form-row" style="grid-template-columns: repeat(2, 1fr);">
                        <div class="form-group">
                            <label class="form-label">项目名称</label>
                        <input type="text" name="project_name" class="form-control"
                               value="{{ opportunity.project_name|default:'' }}"
                               maxlength="200"
                               placeholder="请输入项目名称">
                    </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">项目地址</label>
                            <input type="hidden" name="project_address" id="projectAddressField" value="{{ opportunity.project_address|default:'' }}">
                            <div class="row g-2 mb-2">
                                <div class="col-md-4">
                                    <select id="provinceSelect" class="form-select">
                                        <option value="">选择省份</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select id="citySelect" class="form-select">
                                        <option value="">选择城市</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select id="districtSelect" class="form-select">
                                        <option value="">选择区县</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <input type="text" id="addressDetailInput" class="form-control"
                                           placeholder="街道、楼栋、门牌等详细地址"
                                           value="">
                                    <small class="text-muted">完整地址会在保存前自动组合</small>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">项目业态</label>
                            <select name="project_type" class="form-select">
                                <option value="">请选择项目业态</option>
                                {% for value, label in business_types %}
                                <option value="{{ value }}" {% if opportunity.project_type|default:'' == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">建筑面积（平方米）</label>
                        <input type="number" name="building_area" class="form-control"
                               value="{% if opportunity.building_area %}{{ opportunity.building_area }}{% endif %}"
                               step="0.01" min="0"
                               placeholder="0.00">
                    </div>
                        <div class="form-group">
                            <label class="form-label">图纸阶段</label>
                            <select name="drawing_stage" class="form-select">
                                <option value="">请选择</option>
                                {% for stage in design_stages %}
                                <option value="{{ stage.id }}" {% if opportunity.drawing_stage_id == stage.id %}selected{% endif %}>
                                    {{ stage.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
          </div>
        </div>

        <div class="form-section">
            <div class="form-section-title">金额信息</div>
                <div class="form-row" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="form-group">
                        <label class="form-label required">预计金额（元）</label>
                        <input type="number" name="estimated_amount" id="estimated_amount" class="form-control"
                               value="{% if opportunity.estimated_amount %}{{ opportunity.estimated_amount }}{% else %}0{% endif %}"
                               step="0.01" min="0" required
                               placeholder="0.00">
                        <div class="invalid-feedback">请输入有效的预计金额</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">成功概率（%）</label>
                        <select name="success_probability" id="success_probability" class="form-select" required>
                            <option value="10" {% if opportunity.success_probability == 10 or not opportunity %}selected{% endif %}>10%</option>
                            <option value="30" {% if opportunity.success_probability == 30 %}selected{% endif %}>30%</option>
                            <option value="50" {% if opportunity.success_probability == 50 %}selected{% endif %}>50%</option>
                            <option value="70" {% if opportunity.success_probability == 70 %}selected{% endif %}>70%</option>
                            <option value="90" {% if opportunity.success_probability == 90 %}selected{% endif %}>90%</option>
                        </select>
                        <small class="text-muted">根据商机当前阶段选择对应的成功概率</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">加权金额（元）</label>
                        <input type="text" id="weighted_amount_display" class="form-control"
                               value="{% if opportunity.weighted_amount %}{{ opportunity.weighted_amount|floatformat:2 }}{% else %}0.00{% endif %}"
                               readonly
                               style="background-color: #f8f9fa; color: #6c757d;">
                        <small class="text-muted">自动计算：预计金额 × 成功概率</small>
                    </div>
          </div>

        <div class="form-section">
            <div class="form-section-title">时间信息</div>
                <div class="form-row" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="form-group">
                        <label class="form-label">预计签约时间</label>
                        <input type="date" name="expected_sign_date" class="form-control"
                               value="{{ opportunity.expected_sign_date|default:''|date:'Y-m-d' }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">紧急程度</label>
                        <select name="urgency" class="form-select">
                            {% for value, label in urgency_choices %}
                            <option value="{{ value }}" {% if opportunity.urgency == value or not opportunity and value == 'normal' %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
          </div>

        <div class="form-section">
            <div class="form-section-title">商机描述</div>
                <div class="form-row" style="grid-template-columns: repeat(1, 1fr);">
                    <div class="form-group">
                        <label class="form-label">描述</label>
                        <textarea name="description" class="form-control" rows="4"
                                  placeholder="请输入商机描述">{{ opportunity.description|default:'' }}</textarea>
                    </div>
          </div>

        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #E0E0E0;">
            <a href="{% if opportunity %}{% url 'opportunity_pages:opportunity_detail' opportunity.id %}{% else %}{% url 'opportunity_pages:opportunity_management' %}{% endif %}"
               class="list-btn">
                取消
            </a>
            <button type="submit" class="list-btn list-btn-primary">
                <i class="bi bi-check-circle"></i> {% if opportunity %}保存修改{% else %}创建商机{% endif %}
            </button>
        </div>
    </form>
<script>
// 加权金额自动计算
document.addEventListener('DOMContentLoaded', function() {
    const estimatedAmountInput = document.getElementById('estimated_amount');
    const successProbabilitySelect = document.getElementById('success_probability');
    const weightedAmountDisplay = document.getElementById('weighted_amount_display');

    function calculateWeightedAmount() {
        const estimatedAmount = parseFloat(estimatedAmountInput.value) || 0;
        const successProbability = parseFloat(successProbabilitySelect.value) || 0;
        const weightedAmount = (estimatedAmount * successProbability / 100).toFixed(2);
        weightedAmountDisplay.value = weightedAmount;
    }

    if (estimatedAmountInput && successProbabilitySelect && weightedAmountDisplay) {
        estimatedAmountInput.addEventListener('input', calculateWeightedAmount);
        successProbabilitySelect.addEventListener('change', calculateWeightedAmount);
        // 初始计算
        calculateWeightedAmount();
    }

    // 高德地图行政区划选择器（使用可复用组件）
    const districtSelector = new AmapDistrictSelector({
        provinceSelectId: 'provinceSelect',
        citySelectId: 'citySelect',
        districtSelectId: 'districtSelect',
        addressFieldId: 'projectAddressField',
        detailInputId: 'addressDetailInput',
        apiBaseUrl: '/api/customer/districts/',
        autoUpdateAddress: true,
        enableLogging: false  // 设置为true可启用调试日志
    });
    districtSelector.init();

    // 表单验证
    const form = document.getElementById('opportunityForm');
    if (form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    }

    // 客户过滤功能：仅显示本人负责的客户
    const filterMyClientsCheckbox = document.getElementById('filter_my_clients');
    const clientSelect = document.getElementById('client_select');
    {% if request.user.is_authenticated %}
    const currentUserId = {{ request.user.id }};
    {% else %}
    const currentUserId = null;
    {% endif %}

    if (filterMyClientsCheckbox && clientSelect && currentUserId !== null && currentUserId !== undefined) {
        // 保存所有客户选项的克隆（用于恢复显示）
        const allClientOptions = [];
        Array.from(clientSelect.options).forEach(function(option) {
            if (option.value !== '') {
                // 克隆选项，包括所有属性和文本
                const clonedOption = option.cloneNode(true);
                allClientOptions.push(clonedOption);
            }
        });

        function filterClients() {
            const showOnlyMyClients = filterMyClientsCheckbox.checked;
            const selectedValue = clientSelect.value; // 保存当前选中的值

            // 清空下拉框（保留第一个"请选择客户"选项）
            // TODO: 使用DOMPurify清理HTML
            clientSelect.innerHTML = '<option value="">请选择客户</option>';

            // 根据过滤条件添加选项
            allClientOptions.forEach(function(option) {
                const responsibleUserId = option.getAttribute('data-responsible-user-id');
                const isMyClient = responsibleUserId && parseInt(responsibleUserId) === currentUserId;

                // 如果未勾选过滤，显示所有客户；如果勾选了，只显示本人负责的客户
                if (!showOnlyMyClients || isMyClient) {
                    clientSelect.appendChild(option.cloneNode(true));
                }
            });

            // 恢复之前选中的值（如果该选项仍然可见）
            if (selectedValue) {
                const optionExists = Array.from(clientSelect.options).some(opt => opt.value === selectedValue);
                if (optionExists) {
                    clientSelect.value = selectedValue;
                } else {
                    // 如果之前选中的客户被过滤掉了，清空选择
                    clientSelect.value = '';
                }
            }
        }

        // 监听复选框变化
        filterMyClientsCheckbox.addEventListener('change', filterClients);
    }
});
</script>
{% endblock %}