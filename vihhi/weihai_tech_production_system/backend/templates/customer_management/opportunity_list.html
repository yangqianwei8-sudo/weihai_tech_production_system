{% extends "shared/list_page_base.html" %}
{% load static %}

{% comment %}
å•†æœºåˆ—è¡¨é¡µé¢æ¨¡æ¿ (Opportunity List Template)

åŠŸèƒ½è¯´æ˜ï¼š
- å±•ç¤ºå•†æœºè®°å½•çš„åˆ—è¡¨é¡µé¢
- æ”¯æŒæŒ‰çŠ¶æ€ã€ç´§æ€¥ç¨‹åº¦ã€å®¢æˆ·ã€è´Ÿè´£å•†åŠ¡ç­‰å¤šç»´åº¦ç­›é€‰
- æ”¯æŒå•†æœºçš„æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤æ“ä½œ
{% endcomment %}

{# ä¸»æ ‡é¢˜å’Œå‰¯æ ‡é¢˜ #}
{% block pm_title %}{{ page_title|default:"å•†æœºåˆ—è¡¨" }}{% endblock pm_title %}
{% block pm_subtitle %}{{ description|default:"æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰å•†æœº" }}{% endblock pm_subtitle %}

{# ç»Ÿè®¡å¡ç‰‡ #}
{% block list_stats_content %}
  <div class="list-stat-card">
    <div class="list-stat-label">å•†æœºæ€»æ•°</div>
    <div class="list-stat-value">{{ total_opportunities|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">æ´»è·ƒå•†æœº</div>
    <div class="list-stat-value">{{ active_opportunities|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">é¢„è®¡é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</div>
    <div class="list-stat-value">{{ total_estimated|floatformat:2|default:"0.00" }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">åŠ æƒé‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</div>
    <div class="list-stat-value">{{ total_weighted_amount|floatformat:2|default:"0.00" }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">æœ¬æœˆæ–°å¢</div>
    <div class="list-stat-value">{{ monthly_new|default:0 }}</div>
  </div>
{% endblock list_stats_content %}

{# ç­›é€‰å™¨åŒºåŸŸ #}
{% block list_filters_content %}
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">å•†æœºçŠ¶æ€</label>
    <select name="status" class="form-select">
      <option value="">å…¨éƒ¨çŠ¶æ€</option>
      {% for value, label in status_choices %}
      <option value="{{ value }}" {% if status == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">ç´§æ€¥ç¨‹åº¦</label>
    <select name="urgency" class="form-select">
      <option value="">å…¨éƒ¨</option>
      {% for value, label in urgency_choices %}
      <option value="{{ value }}" {% if urgency == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">å…³è”å®¢æˆ·</label>
    <select name="client_id" class="form-select">
      <option value="">å…¨éƒ¨å®¢æˆ·</option>
      {% for client in clients %}
      <option value="{{ client.id }}" {% if client_id == client.id|stringformat:"s" %}selected{% endif %}>{{ client.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">è´Ÿè´£å•†åŠ¡</label>
    <select name="business_manager_id" class="form-select">
      <option value="">å…¨éƒ¨</option>
      {% for manager in business_managers %}
      <option value="{{ manager.id }}" {% if business_manager_id == manager.id|stringformat:"s" %}selected{% endif %}>{{ manager.get_full_name|default:manager.username }}</option>
      {% endfor %}
    </select>
  </div>
{% endblock list_filters_content %}

{# è¡¨æ ¼å¤´éƒ¨ #}
{% block list_table_headers %}
  <th>å•†æœºç¼–å·</th>
  <th>å•†æœºåç§°</th>
  <th>å…³è”å®¢æˆ·</th>
  <th>è´Ÿè´£å•†åŠ¡</th>
  <th>å•†æœºçŠ¶æ€</th>
  <th>é¢„è®¡é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</th>
  <th>æˆåŠŸæ¦‚ç‡</th>
  <th>åŠ æƒé‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</th>
  <th>ç´§æ€¥ç¨‹åº¦</th>
  <th>é¢„è®¡ç­¾çº¦æ—¶é—´</th>
  <th>åˆ›å»ºæ—¶é—´</th>
  <th>æ“ä½œ</th>
{% endblock list_table_headers %}

{# è¡¨æ ¼è¡Œ #}
{% block list_table_rows %}
  {% if page_obj %}
    {% for opportunity in page_obj %}
    <tr>
      <td><code>{{ opportunity.opportunity_number|default:'æœªç¼–å·' }}</code></td>
      <td>
        <a href="{% url 'opportunity_pages:opportunity_detail' opportunity.id %}" class="text-dark text-decoration-none fw-medium">
          {{ opportunity.name }}
        </a>
      </td>
      <td>
        {% if opportunity.client %}
        <a href="{% url 'business_pages:customer_detail' opportunity.client.id %}" class="text-dark text-decoration-none">
          {{ opportunity.client.name }}
        </a>
        {% else %}
        <span class="text-muted">-</span>
        {% endif %}
      </td>
      <td>{{ opportunity.business_manager.get_full_name|default:opportunity.business_manager.username }}</td>
      <td>
        {% with s=opportunity.status %}
        <span class="badge {% if s == 'won' %}bg-success{% elif s == 'lost' %}bg-danger{% elif s == 'cancelled' %}bg-secondary{% else %}bg-primary{% endif %}">
          {{ opportunity.get_status_display|default:opportunity.status }}
        </span>
        {% endwith %}
      </td>
      <td style="text-align: right;">{{ opportunity.estimated_amount|floatformat:2 }}</td>
      <td style="text-align: center;">{{ opportunity.success_probability }}%</td>
      <td style="text-align: right; font-weight: 600;">{{ opportunity.weighted_amount|floatformat:2 }}</td>
      <td>
        {% if opportunity.urgency == 'very_urgent' %}
        <span class="badge bg-danger">ç´§æ€¥</span>
        {% elif opportunity.urgency == 'urgent' %}
        <span class="badge bg-warning text-dark">è¾ƒæ€¥</span>
        {% else %}
        <span class="badge bg-secondary">ä¸€èˆ¬</span>
        {% endif %}
      </td>
      <td>{{ opportunity.expected_sign_date|date:'Y-m-d'|default:'æœªè®¾ç½®' }}</td>
      <td>{{ opportunity.created_time|date:'Y-m-d H:i' }}</td>
      <td>
        <div class="list-page-table-actions">
          <a href="{% url 'opportunity_pages:opportunity_detail' opportunity.id %}" class="action-view" title="æŸ¥çœ‹è¯¦æƒ…">
            <i class="bi bi-eye"></i>
          </a>
          {% if can_create or opportunity.business_manager == user %}
          <span class="action-separator">|</span>
          <a href="{% url 'opportunity_pages:opportunity_edit' opportunity.id %}" class="action-edit" title="ç¼–è¾‘">
            <i class="bi bi-pencil"></i>
          </a>
          <span class="action-separator">|</span>
          <a href="{% url 'opportunity_pages:opportunity_delete' opportunity.id %}" class="action-delete" title="åˆ é™¤" onclick="return confirm('ç¡®å®šè¦åˆ é™¤æ­¤å•†æœºå—ï¼Ÿ');">
            <i class="bi bi-trash"></i>
          </a>
          {% endif %}
        </div>
      </td>
      {# åˆ—è®¾ç½®å•å…ƒæ ¼ - ä¿æŒåˆ—å¯¹é½ #}
      {% if column_settings_btn|default:False %}<td></td>{% endif %}
    </tr>
    {% empty %}
    <tr>
      <td colspan="{% if column_settings_btn|default:False %}13{% else %}12{% endif %}" class="list-empty">
        <div class="list-empty-icon">ğŸ’¼</div>
        <div class="list-empty-text">æš‚æ— å•†æœºæ•°æ®</div>
        {% block list_empty_hint %}
        <div class="list-empty-hint">è¯·åˆ›å»ºç¬¬ä¸€ä¸ªå•†æœºå¼€å§‹ä½¿ç”¨</div>
        {% endblock list_empty_hint %}
      </td>
    </tr>
    {% endfor %}
  {% else %}
    <tr>
      <td colspan="{% if column_settings_btn|default:False %}13{% else %}12{% endif %}" class="list-empty">
        <div class="list-empty-icon">ğŸ’¼</div>
        <div class="list-empty-text">æš‚æ— æ•°æ®</div>
      </td>
    </tr>
  {% endif %}
{% endblock list_table_rows %}
