{% extends "shared/list_page_base.html" %}
{% load static %}

{% block pm_title %}{{ page_title|default:"åˆåŒç®¡ç†" }}{% endblock pm_title %}
{% block pm_subtitle %}æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰åˆåŒ{% endblock pm_subtitle %}

{% block pm_actions %}
{% if can_create %}
<a href="{% url 'contract_pages:contract_create' %}" class="list-btn list-btn-primary">æ–°å¢åˆåŒ</a>
{% endif %}
{% endblock pm_actions %}

{% block list_table_rows %}
{% for contract in page_obj %}
      <tr>
        <td><code>{{ contract.project_number|default:contract.contract_number|default:"æœªç¼–å·" }}</code></td>
        <td>{{ contract.contract_name|default:contract.contract_number }}</td>
        <td>{{ contract.client.name|default:"æœªæŒ‡å®š" }}</td>
        <td>
          {% if contract.project %}
          {{ contract.project.project_number|default:contract.project.name }}
          {% else %}
          <span class="text-muted">æœªå…³è”</span>
          {% endif %}
        </td>
        <td>{{ contract.get_contract_type_display }}</td>
        <td>
          <span class="badge bg-secondary">{{ contract.get_status_display }}</span>
        </td>
        <td style="text-align: right;">{% if contract.contract_amount %}Â¥{{ contract.contract_amount|floatformat:2 }}{% else %}--{% endif %}</td>
        <td style="text-align: right;">{% if contract.payment_amount %}Â¥{{ contract.payment_amount|floatformat:2 }}{% else %}Â¥0.00{% endif %}</td>
        <td style="text-align: right;">{% if contract.unpaid_amount %}Â¥{{ contract.unpaid_amount|floatformat:2 }}{% else %}--{% endif %}</td>
        <td>{{ contract.contract_date|date:"Y-m-d"|default:"æœªè®¾ç½®" }}</td>
        <td>{{ contract.created_by.get_full_name|default:contract.created_by.username }}</td>
        <td>
          <div class="list-page-table-actions">
            <a href="{% url 'contract_pages:contract_detail' contract.id %}" class="action-view" title="æŸ¥çœ‹">
              <i class="bi bi-eye"></i>
            </a>
            {% if contract.can_edit %}
            <span class="action-separator">|</span>
            <a href="{% url 'contract_pages:contract_edit' contract.id %}" class="action-edit" title="ç¼–è¾‘">
              <i class="bi bi-pencil"></i>
            </a>
            {% if contract.can_delete %}
            <span class="action-separator">|</span>
            <button type="button" class="action-delete btn-delete-contract" data-contract-id="{{ contract.id }}" title="åˆ é™¤">
              <i class="bi bi-trash"></i>
            </button>
            {% endif %}
            {% endif %}
          </div>
        </td>
        {% if column_settings_btn|default:False %}<td></td>{% endif %}
      </tr>
      {% empty %}
      <tr>
        <td colspan="{% if column_settings_btn|default:False %}13{% else %}12{% endif %}" class="list-empty">
          <div class="list-empty-icon">ğŸ“‹</div>
          <div class="list-empty-text">æš‚æ— åˆåŒæ•°æ®</div>
          {% block list_empty_hint %}
          <p class="text-muted" style="font-size: 0.9rem; margin-top: 8px;">è¯·åˆ›å»ºç¬¬ä¸€ä¸ªåˆåŒå¼€å§‹ä½¿ç”¨</p>
          {% endblock list_empty_hint %}
        </td>
      </tr>
      {% endfor %}
{% endblock list_table_rows %}

{% block list_table_headers %}
<th>åˆåŒç¼–å·</th>
<th>åˆåŒåç§°</th>
<th>å®¢æˆ·</th>
<th>å…³è”é¡¹ç›®</th>
<th>åˆåŒç±»å‹</th>
<th>çŠ¶æ€</th>
<th>åˆåŒé‡‘é¢</th>
<th>å·²å›æ¬¾</th>
<th>æœªå›æ¬¾</th>
<th>ç­¾è®¢æ—¥æœŸ</th>
<th>åˆ›å»ºäºº</th>
<th>æ“ä½œ</th>
{% endblock list_table_headers %}



{% block module_extra_js %}
<div class="modal fade" id="deleteContractModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ç¡®è®¤åˆ é™¤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>ç¡®å®šè¦åˆ é™¤æ­¤åˆåŒå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <form id="deleteContractForm" method="post" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">ç¡®è®¤åˆ é™¤</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const deleteButtons = document.querySelectorAll('.btn-delete-contract');
  deleteButtons.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const contractId = this.dataset.contractId;
      const form = document.getElementById('deleteContractForm');
      form.action = '/contracts/' + contractId + '/delete/';
      const modal = new bootstrap.Modal(document.getElementById('deleteContractModal'));
      modal.show();
    });
  });
});
</script>
{% endblock module_extra_js %}
