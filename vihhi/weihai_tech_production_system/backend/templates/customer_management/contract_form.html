{% extends "shared/module_base.html" %}
{% load static %}

{% block title %}{{ page_title }} - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
    .form-group {
        margin-bottom: 20px;
    }
    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: block;
    }
    .required-field::after {
        content: " *";
        color: #ef4444;
    }
    .party-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .party-item-header {

        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'contract_pages:contract_management_list' %}">åˆåŒç®¡ç†</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ page_title }}</li>
{% endblock %}

{% block content %}<div class="container-fluid py-4">
    <div class="form-page-title">
            <h1>{{ page_title }}</h1>
            {% if page_description %}
            <p>{{ page_description }}</p>
            {% endif %}
        </div>

    <form method="post" enctype="multipart/form-data" id="contract-form" class="form-card">
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="alert alert-danger">
        {% endif %}
            {{ form.non_field_errors }}
        </div>

        <div class="form-section">
            <div class="form-section-header">
                <h5>ğŸ¤– AIåˆåŒè¯†åˆ«</h5>
                <button type="button" id="recognize-contract-btn" class="btn btn-primary">
                    <i class="bi bi-magic"></i> å¼€å§‹è¯†åˆ«
                </button>
            </div>
            <div class="alert alert-info" style="margin-bottom: 16px; font-size: 13px;">
                <i class="bi bi-info-circle"></i> ä¸Šä¼ åˆåŒæ–‡ä»¶ï¼ˆPDFã€å›¾ç‰‡ï¼‰ï¼ŒAIå°†è‡ªåŠ¨è¯†åˆ«å¹¶å¡«å……è¡¨å•ä¿¡æ¯
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label class="form-label">ä¸Šä¼ åˆåŒæ–‡ä»¶</label>
                        <input type="file" id="contract-file-input" class="form-control"
                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                               style="padding: 8px;">
                        <small class="form-text text-muted">æ”¯æŒæ ¼å¼ï¼šPDFã€JPGã€PNGã€DOCã€DOCXï¼Œæœ€å¤§10MB</small>
                    </div>
                </div>
            </div>
            <div id="recognition-status" style="display: none; margin-top: 12px;">
                <div class="alert alert-warning">
                    <i class="bi bi-hourglass-split"></i> <span id="recognition-message">æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</span>
                </div>
            </div>
            <div id="recognition-result" style="display: none; margin-top: 12px;">
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> è¯†åˆ«å®Œæˆï¼å·²è‡ªåŠ¨å¡«å……è¡¨å•ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥å¹¶ç¡®è®¤ã€‚
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="form-section-header">
                <h5>åŸºç¡€ä¿¡æ¯</h5>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">å®¡æ‰¹å•å·</label>
                        <input type="text" id="approval_number" name="approval_number" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ">
                        <small class="form-text text-muted">ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">æäº¤éƒ¨é—¨</label>
                        <input type="text" id="submit_department" name="submit_department" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value="{% if request.user.department %}{{ request.user.department.name }}{% else %}æœªè®¾ç½®éƒ¨é—¨{% endif %}">
                        <small class="form-text text-muted">ç³»ç»Ÿé»˜è®¤</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">æäº¤äºº</label>
                        <input type="text" id="submitter" name="submitter" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value="{{ request.user.get_full_name|default:request.user.username }}">
                        <small class="form-text text-muted">ç³»ç»Ÿé»˜è®¤</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">å•†åŠ¡è´Ÿè´£äºº</label>
                        <select id="business_manager" name="business_manager" class="form-select">
                            <option value="">-- è¯·é€‰æ‹©å•†åŠ¡è´Ÿè´£äºº --</option>
                            {% for manager in business_managers %}
                            <option value="{{ manager.id }}" {% if manager.id == user.id %}selected{% endif %}>{{ manager.get_full_name|default:manager.username }}</option>
                            {% endfor %}</select>
                        <small class="form-text text-muted">é€‰æ‹©ï¼Œé»˜è®¤</small>
                    </div>
                </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field">é¡¹ç›®ç¼–å·</label>
                        {{ form.project_number }}
                        {% if form.project_number.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.project_number.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">YYYYMMDD-0000ï¼Œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œå¯æ‰‹åŠ¨ä¿®æ”¹ï¼Œé¡»ä¿æŒå”¯ä¸€æ€§</small>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">åˆåŒç¼–å·</label>
                        {{ form.contract_number }}
                        {% if form.contract_number.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_number.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">HT-é¡¹ç›®ç¼–å·ï¼Œè‡ªåŠ¨ç”Ÿæˆï¼Œå¯æ‰‹åŠ¨ä¿®æ”¹</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field">å…³è”å•†æœº</label>
                        {{ form.opportunity }}
                        {% if form.opportunity.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.opportunity.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field">å…³è”å®¢æˆ·</label>
                        {{ form.client }}
                        {% if form.client.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.client.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">ä»å…³è”å•†æœºä¸­è‡ªåŠ¨å¸¦å‡º</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">é¡¹ç›®ä¸šæ€</label>
                        <input type="text" id="project_business_type" name="project_business_type" class="form-control" readonly placeholder="è¯·å…ˆé€‰æ‹©å…³è”å•†æœº">
                        <small class="form-text text-muted">ä»å…³è”å•†æœºä¸­è‡ªåŠ¨å¸¦å‡º</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">åˆåŒæš‚å®šä»·æ¬¾</label>
                        <input type="number" id="provisional_price" name="provisional_price" class="form-control" step="0.01" placeholder="0.00">
                        <small class="form-text text-muted">å•ä½ï¼šå…ƒ</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">çº¦å®šç®¡è¾–</label>
                        <select id="governing_law" name="governing_law" class="form-select">
                            <option value="">-- è¯·é€‰æ‹©çº¦å®šç®¡è¾– --</option>
                            {% for value, label in governing_law_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                </div>
            </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">æˆ‘æ–¹ç­¾çº¦ä¸»ä½“</label>
                        <select id="our_signing_party" name="our_signing_party" class="form-select">
                            <option value="">-- è¯·é€‰æ‹©æˆ‘æ–¹ç­¾çº¦ä¸»ä½“ --</option>
                            {% for company in our_companies %}
                            <option value="{{ company.company_name }}">{{ company.company_name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">é€‰æ‹©ï¼Œåå°å¼•å…¥</small>
                    </div>
                </div>
        </div>

        <div class="form-section">
            <div class="form-section-header">
                <h5>å®¢æˆ·è”ç³»æ–¹å¼</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="parties-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">åºå·</th>
                            <th style="width: 180px;">å•ä½åç§° <span class="text-danger">*</span></th>
                            <th style="width: 150px;">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </th>
                            <th style="width: 120px;">æ³•å®šä»£è¡¨äºº</th>
                            <th style="width: 120px;">é¡¹ç›®è´Ÿè´£äºº</th>
                            <th style="width: 120px;">è”ç³»ç”µè¯</th>
                            <th style="width: 150px;">è”ç³»é‚®ç®±</th>
                            <th style="width: 200px;">åŠå…¬åœ°å€</th>
                            <th style="width: 80px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="parties-container">

                    </tbody>
                </table>
            </div>
            <div style="margin-top: 16px; text-align: left;">
                <button type="button" class="btn btn-sm btn-primary" id="add-party-btn">
                    <i class="bi bi-plus-circle"></i> æ·»åŠ ç­¾çº¦ä¸»ä½“
                </button>
            </div>
        </div>

        <div class="form-section">
            <div class="form-section-header">
                <h5>æœåŠ¡ä¿¡æ¯</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="service-contents-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">åºå·</th>
                            <th style="width: 200px;">æœåŠ¡ç±»å‹</th>
                            <th style="width: 150px;">å›¾çº¸é˜¶æ®µ</th>
                            <th style="width: 150px;">å»ºç­‘é¢ç§¯ï¼ˆã¡ï¼‰</th>
                            <th style="width: 150px;">é¡¹ç›®ä¸šæ€</th>
                            <th style="width: 280px;">æœåŠ¡ä¸“ä¸š</th>
                            <th style="width: 80px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="service-contents-container">

                    </tbody>
                </table>
            </div>
            <div style="margin-top: 16px; text-align: left;">
                <button type="button" class="btn btn-sm btn-primary" id="add-service-content-btn">
                    <i class="bi bi-plus-circle"></i> æ·»åŠ æœåŠ¡ä¿¡æ¯
                </button>
            </div>
        </div>

        <div class="form-section">
            <div class="form-section-header">
                <h5>ä»·æ¬¾ä¿¡æ¯</h5>
            </div>

            <div class="row" style="margin-bottom: 20px;">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ç»“ç®—æ–¹å¼</label>
                        <select id="settlement_method" name="settlement_method" class="form-select">
                            <option value="">-- è¯·é€‰æ‹©ç»“ç®—æ–¹å¼ --</option>
                            {% for method in settlement_methods %}
                            <option value="{{ method.code }}" data-name="{{ method.name }}">{{ method.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">åå°å¼•å…¥ï¼Œæœªé€‰æ‹©æ—¶éšè—åˆ—è¡¨</small>
                    </div>
                </div>

            <div class="row" style="margin-bottom: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field" for="{{ form.contract_amount.id_for_label }}">åˆåŒé‡‘é¢ï¼ˆå«ç¨ï¼‰</label>
                        <input type="number" id="{{ form.contract_amount.id_for_label }}" name="contract_amount" class="form-control" step="0.01" placeholder="0.00" value="{% if form.instance and form.instance.contract_amount %}{{ form.instance.contract_amount }}{% elif form.contract_amount.value %}{{ form.contract_amount.value }}{% endif %}">
                        {% if form.contract_amount.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_amount.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">å•ä½ï¼šå…ƒ</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field" for="{{ form.tax_rate.id_for_label }}">ç¨ç‡</label>
                        <input type="number" id="{{ form.tax_rate.id_for_label }}" name="tax_rate" class="form-control" step="0.01" placeholder="6.00" value="{% if form.instance and form.instance.tax_rate %}{{ form.instance.tax_rate }}{% elif form.tax_rate.value %}{{ form.tax_rate.value }}{% else %}6.00{% endif %}">
                        {% if form.tax_rate.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.tax_rate.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">é»˜è®¤6%</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">ä¸å«ç¨é‡‘é¢</label>
                        <input type="number" id="contract_amount_excl_tax_display" class="form-control" step="0.01" placeholder="0.00" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value="{% if form.instance and form.instance.contract_amount_excl_tax %}{{ form.instance.contract_amount_excl_tax }}{% endif %}">
                        <small class="form-text text-muted">è‡ªåŠ¨è®¡ç®—</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">ç¨é¢</label>
                        <input type="number" id="contract_amount_tax_display" class="form-control" step="0.01" placeholder="0.00" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value="{% if form.instance and form.instance.contract_amount_tax %}{{ form.instance.contract_amount_tax }}{% endif %}">
                        <small class="form-text text-muted">è‡ªåŠ¨è®¡ç®—</small>
                    </div>
                </div>
            </div>
            <div class="row" style="margin-bottom: 20px;">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">å·²å›æ¬¾é‡‘é¢</label>
                        <input type="number" id="payment_amount_display" class="form-control" step="0.01" placeholder="0.00" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value="{% if form.instance and form.instance.payment_amount %}{{ form.instance.payment_amount }}{% else %}0.00{% endif %}">
                        <small class="form-text text-muted">åªè¯»ï¼Œä»å›æ¬¾ç®¡ç†æ¨¡å—åŒæ­¥</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">æœªå›æ¬¾é‡‘é¢</label>
                        <input type="number" id="unpaid_amount_display" class="form-control" step="0.01" placeholder="0.00" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value="{% if form.instance and form.instance.unpaid_amount %}{{ form.instance.unpaid_amount }}{% else %}0.00{% endif %}">
                        <small class="form-text text-muted">è‡ªåŠ¨è®¡ç®—ï¼šåˆåŒé‡‘é¢ - å·²å›æ¬¾é‡‘é¢</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">å·²ç»“ç®—é‡‘é¢</label>
                        <input type="number" id="settlement_amount_display" class="form-control" step="0.01" placeholder="0.00" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value="{% if form.instance and form.instance.settlement_amount %}{{ form.instance.settlement_amount }}{% else %}0.00{% endif %}">
                        <small class="form-text text-muted">åªè¯»ï¼Œä»ç»“ç®—ç®¡ç†æ¨¡å—åŒæ­¥</small>
                    </div>
                </div>
            </div>

            </div>

            <div id="fixed-total-list" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;">åºå·</th>
                                <th style="width: 150px;">é¢ç§¯è§„æ¨¡</th>
                                <th style="width: 120px;">é¢ç§¯ç±»å‹</th>
                                <th style="width: 150px;">æœåŠ¡è´¹</th>
                            </tr>
                        </thead>
                        <tbody id="fixed-total-container">

                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 16px; text-align: left;">
                    <button type="button" class="btn btn-sm btn-primary" id="add-fixed-total-btn">
                        <i class="bi bi-plus-circle"></i> å¢åŠ è¡Œ
                    </button>
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="form-section-header">
                <h5>å›æ¬¾ä¿¡æ¯</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="payment-info-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">åºå·</th>
                            <th style="width: 120px;">æ¬¾é¡¹åç§°</th>
                            <th style="width: 150px;">è§¦å‘èŠ‚ç‚¹ <span class="text-danger">*</span></th>
                            <th style="width: 150px;">ä»˜æ¬¾æ–¹å¼ <span class="text-danger">*</span></th>
                            <th style="width: 150px;">å›æ¬¾é‡‘é¢ï¼ˆå…ƒï¼‰</th>
                            <th style="width: 200px;">ä»˜æ¬¾æ¡ä»¶</th>
                            <th style="width: 80px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="payment-info-container">

                    </tbody>
                </table>
            </div>
            <div style="margin-top: 16px; text-align: left;">
                <button type="button" class="btn btn-sm btn-primary" id="add-payment-info-btn">
                    <i class="bi bi-plus-circle"></i> æ·»åŠ å›æ¬¾ä¿¡æ¯
                </button>
            </div>
        </div>

        <div class="form-section">
            <div class="form-section-header">
                <h5>åˆåŒä¿¡æ¯</h5>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field" for="{{ form.contract_name.id_for_label }}">{{ form.contract_name.label }}</label>
                        {{ form.contract_name }}
                        {% if form.contract_name.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_name.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.contract_type.id_for_label }}">{{ form.contract_type.label }}</label>
                        {{ form.contract_type }}
                        {% if form.contract_type.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_type.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.structure_type.id_for_label }}">{{ form.structure_type.label }}</label>
                        {{ form.structure_type }}
                        {% if form.structure_type.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.structure_type.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.design_unit_category.id_for_label }}">{{ form.design_unit_category.label }}</label>
                        {{ form.design_unit_category }}
                        {% if form.design_unit_category.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.design_unit_category.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.contract_amount.id_for_label }}">{{ form.contract_amount.label }}</label>
                        {{ form.contract_amount }}
                        {% if form.contract_amount.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_amount.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">å•ä½ï¼šå…ƒ</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.tax_rate.id_for_label }}">{{ form.tax_rate.label }}</label>
                        {{ form.tax_rate }}
                        {% if form.tax_rate.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.tax_rate.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">é»˜è®¤6%</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div><script>
    const contractFileInput = document.getElementById('contract-file-input');
    const recognizeBtn = document.getElementById('recognize-contract-btn');
    const recognitionStatus = document.getElementById('recognition-status');
    const recognitionResult = document.getElementById('recognition-result');
    const recognitionMessage = document.getElementById('recognition-message');

    if (recognizeBtn && contractFileInput) {
        recognizeBtn.addEventListener('click', async function() {
            const file = contractFileInput.files[0];
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©åˆåŒæ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 10 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                return;
            }

            // æ˜¾ç¤ºè¯†åˆ«çŠ¶æ€
            recognitionStatus.style.display = 'block';
            recognitionResult.style.display = 'none';
            recognitionMessage.textContent = 'æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...';
            recognizeBtn.disabled = true;

            // åˆ›å»ºFormData
            const formData = new FormData();
            formData.append('file', file);

            try {
                // è°ƒç”¨è¯†åˆ«API
                const response = await fetch('/api/customer/contracts/recognize/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // è¯†åˆ«æˆåŠŸï¼Œå¡«å……è¡¨å•
                    fillFormWithRecognitionResult(result.data);
                    recognitionMessage.textContent = 'è¯†åˆ«å®Œæˆï¼';
                    recognitionStatus.style.display = 'none';
                    recognitionResult.style.display = 'block';
                } else {
                    // è¯†åˆ«å¤±è´¥
                    recognitionMessage.textContent = 'è¯†åˆ«å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯');
                    recognitionStatus.querySelector('.alert').className = 'alert alert-danger';
                }
            } catch (error) {
                recognitionMessage.textContent = 'è¯†åˆ«å¤±è´¥ï¼š' + error.message;
                recognitionStatus.querySelector('.alert').className = 'alert alert-danger';
            } finally {
                recognizeBtn.disabled = false;
            }
        });
    }

    // å¡«å……è¡¨å•æ•°æ®
    function fillFormWithRecognitionResult(data) {
        // åˆåŒåç§°
        if (data.contract_name) {
            const contractNameField = document.querySelector('[name=]"contract_name"]');
            if (contractNameField && !contractNameField.value) {
                contractNameField.value = data.contract_name;
            }

        // é¡¹ç›®ç¼–å·ï¼ˆåˆåŒç¼–å·ï¼‰
        if (data.contract_number) {
            const contractNumberField = document.querySelector('[name="project_number"]');
            if (contractNumberField && !contractNumberField.value) {
                contractNumberField.value = data.contract_number;
            }

        // åˆåŒç±»å‹
        if (data.contract_type) {
            const contractTypeField = document.querySelector('[name="contract_type"]');
            if (contractTypeField) {
                // å°è¯•åŒ¹é…åˆåŒç±»å‹
                const options = contractTypeField.querySelectorAll('option');
                for (let opt of options) {
                    if (opt.textContent.includes(data.contract_type) || data.contract_type.includes(opt.textContent)) {
                        contractTypeField.value = opt.value;
                        break;
                    }
                }
            }

        // åˆåŒæè¿°
        if (data.description) {
            const descField = document.querySelector('[name="description"]');
            if (descField && !descField.value) {
                descField.value = data.description;
            }

        if (data.party_a && data.party_a.name) {
            if (partyRows.length > 0) {
                const firstRow = partyRows[0];
                const partyNameInput = firstRow.querySelector('input[name*="[party_name]"]');
                if (partyNameInput && !partyNameInput.value) {
                    partyNameInput.value = data.party_a.name;
                }
                if (data.party_a.contact) {
                    const contactInput = firstRow.querySelector('input[name*="[party_contact]"]');
                    if (contactInput && !contactInput.value) {
                        contactInput.value = data.party_a.contact;
                    }
                }
                if (data.party_a.phone) {
                    const phoneInput = firstRow.querySelector('input[name*="[contact_phone]"]');
                    if (phoneInput && !phoneInput.value) {
                        phoneInput.value = data.party_a.phone;
                    }
                }
                if (data.party_a.email) {
                    const emailInput = firstRow.querySelector('input[name*="[contact_email]"]');
                    if (emailInput && !emailInput.value) {
                        emailInput.value = data.party_a.email;
                    }
                }
                if (data.party_a.address) {
                    const addressInput = firstRow.querySelector('input[name*="[address]"]');
                    if (addressInput && !addressInput.value) {
                        addressInput.value = data.party_a.address;
                    }
                }
                if (data.party_a.credit_code) {
                    const creditCodeInput = firstRow.querySelector('input[name*="[credit_code]"]');
                    if (creditCodeInput && !creditCodeInput.value) {
                        creditCodeInput.value = data.party_a.credit_code;
                    }
                }
                if (data.party_a.legal_representative) {
                    const legalRepInput = firstRow.querySelector('input[name*="[legal_representative]"]');
                    if (legalRepInput && !legalRepInput.value) {
                        legalRepInput.value = data.party_a.legal_representative;
                    }
                }
            }
        }

        if (data.party_b && data.party_b.name) {
            let secondRow = null;
            if (partyRows.length > 1) {
                secondRow = partyRows[1];
            } else {
                // å¦‚æœæ²¡æœ‰ç¬¬äºŒè¡Œï¼Œå°è¯•åˆ›å»º
                setTimeout(function() {
                    const newRows = document.querySelectorAll('.party-row');
                    if (newRows.length > 1) {
                        secondRow = newRows[1];
                    }
                }, 300);
            }

            if (secondRow) {
                const partyNameInput = secondRow.querySelector('input[name*="[party_name]"]');
                if (partyNameInput && !partyNameInput.value) {
                    partyNameInput.value = data.party_b.name;
                }
                if (data.party_b.contact) {
                    const contactInput = secondRow.querySelector('input[name*="[party_contact]"]');
                    if (contactInput && !contactInput.value) {
                        contactInput.value = data.party_b.contact;
                    }
                }
                if (data.party_b.phone) {
                    const phoneInput = secondRow.querySelector('input[name*="[contact_phone]"]');
                    if (phoneInput && !phoneInput.value) {
                        phoneInput.value = data.party_b.phone;
                    }
                }
                if (data.party_b.email) {
                    const emailInput = secondRow.querySelector('input[name*="[contact_email]"]');
                    if (emailInput && !emailInput.value) {
                        emailInput.value = data.party_b.email;
                    }
                }
                if (data.party_b.address) {
                    const addressInput = secondRow.querySelector('input[name*="[address]"]');
                    if (addressInput && !addressInput.value) {
                        addressInput.value = data.party_b.address;
                    }
                }
                if (data.party_b.credit_code) {
                    const creditCodeInput = secondRow.querySelector('input[name*="[credit_code]"]');
                    if (creditCodeInput && !creditCodeInput.value) {
                        creditCodeInput.value = data.party_b.credit_code;
                    }
                }
                if (data.party_b.legal_representative) {
                    const legalRepInput = secondRow.querySelector('input[name*="[legal_representative]"]');
                    if (legalRepInput && !legalRepInput.value) {
                        legalRepInput.value = data.party_b.legal_representative;
                    }
                }
            }
        }

        // å¦‚æœæœ‰åˆåŒé‡‘é¢ï¼Œå¯ä»¥å°è¯•å¡«å……åˆ°ç»“ç®—æ–¹å¼ä¸­ï¼ˆå›ºå®šæ€»ä»·ï¼‰
    }

// ========== ç»“ç®—æ–¹å¼ç®¡ç†ï¼ˆè¡¨æ ¼å½¢å¼ï¼‰ ==========

    // ç»“ç®—æ–¹å¼é€‰é¡¹ï¼ˆä»æ¨¡æ¿ä¸­è·å–ï¼‰
    const settlementMethodOptions = [
        {% for method in settlement_methods %}
        { value: "{{ method.id }}", label: "{{ method.name }}" },
        {% endfor %}
    ];

    // å°é¡¶ç±»å‹é€‰é¡¹

    const serviceTypeOptions = [
        {% for st in service_types %}
        { value: '{{ st.id }}', label: '{{ st.name }}' },
        {% endfor %}
    ];

    // æ·»åŠ ç»“ç®—æ–¹å¼å¡ç‰‡

        // æ›´æ–°ç»“ç®—æ–¹å¼ç›¸å…³å­—æ®µçš„æ˜¾ç¤º
    // æ·»åŠ åˆ†æ®µå–è´¹è¡Œ
    function addSegmentedRate(cardIndex, rateData = null) {
        const rate = rateData || {};
        if (!container) return;

        const row = document.createElement('tr');
        row.setAttribute('data-rate-index', rateIndex);

        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            row.innerHTML = `
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.greater_than || ''}" placeholder="0.00">
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.less_than || ''}" placeholder="0.00">
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.rate || ''}" placeholder="0.00" required>
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.service_fee || ''}" placeholder="0.00">
            </td>
            <td style="text-align: center;">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;

        container.appendChild(row);

        // ç»‘å®šæœåŠ¡è´¹è¾“å…¥æ¡†çš„changeäº‹ä»¶ï¼Œè‡ªåŠ¨è®¡ç®—å°è®¡
        const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
        if (serviceFeeInput) {
            serviceFeeInput.addEventListener('input', function() {
                calculateFixedTotalSum(cardIndex);
            });
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                row.remove();
                updateSegmentedRateNumbers(cardIndex);
            });
    }

    // æ›´æ–°åˆ†æ®µåºå·
    // æ·»åŠ æ€»ä»·åŒ…å¹²æ¡ç›®
    function addFixedTotalItem(cardIndex, itemData = null) {
        const item = itemData || {};
        if (!container) return;

        const row = document.createElement('tr');
        row.setAttribute('data-item-index', itemIndex);

        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            row.innerHTML = `
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${item.area_scale || ''}" placeholder="0.00" required>
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${item.service_fee || ''}" placeholder="0.00" required>
            </td>
            <td>
                    <i class="bi bi-trash"></i> åˆ é™¤
                </button>
            </td>
        `;

        container.appendChild(row);

        // ç»‘å®šæœåŠ¡è´¹è¾“å…¥æ¡†çš„changeäº‹ä»¶ï¼Œè‡ªåŠ¨è®¡ç®—å°è®¡
        const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
        if (serviceFeeInput) {
            serviceFeeInput.addEventListener('input', function() {
                calculateFixedTotalSum(cardIndex);
            });

        // è®¡ç®—å°è®¡
        calculateFixedTotalSum(cardIndex);

        // æ›´æ–°åºå·
        updateFixedTotalNumbers(cardIndex);

    }

    // æ›´æ–°æ€»ä»·åŒ…å¹²æ¡ç›®åºå·

    function updateFixedTotalNumbers(cardIndex) {
        if (!container) return;

        rows.forEach(function(row, index) {
            row.setAttribute('data-item-index', index);
            // æ›´æ–°nameå±æ€§ä¸­çš„ç´¢å¼•
            const inputs = row.querySelectorAll('input');
            inputs.forEach(function(input) {
                const name = input.getAttribute('name');
                if (name) {
                    // æ›¿æ¢ç´¢å¼•éƒ¨åˆ†
                    const newName = name.replace(/\[fixed_total_items\]\[\d+\]/, '[fixed_total_items][' + index + ']');
                    input.setAttribute('name', newName);
                }
            });
            // æ›´æ–°åˆ é™¤æŒ‰é’®çš„data-item-index
            if (removeBtn) {
                removeBtn.setAttribute('data-item-index', index);
            }
        });
    }

    // è®¡ç®—æ€»ä»·åŒ…å¹²æœåŠ¡è´¹å°è®¡
    function calculateFixedTotalSum(cardIndex) {
        if (!container || !sumElement) return;

        let total = 0;

        rows.forEach(function(row) {
            const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
            if (serviceFeeInput && serviceFeeInput.value) {
                const value = parseFloat(serviceFeeInput.value) || 0;
                total += value;
            }
        });

        // æ›´æ–°å°è®¡æ˜¾ç¤ºï¼Œä¿ç•™ä¸¤ä½å°æ•°
        sumElement.textContent = total.toFixed(2);
        // console.log(...) // å·²ç§»é™¤}`);
    function updateSegmentedRateNumbers(cardIndex) {
        if (!container) return;

        rows.forEach((row, idx) => {
            row.setAttribute('data-rate-index', idx);
            // æ›´æ–°æ‰€æœ‰è¾“å…¥æ¡†çš„nameå±æ€§
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name) {
                    const newName = name.replace(/\[segmented_rates\]\[\d+\]/, '[segmented_rates][' + idx + ']');
                    input.setAttribute('name', newName);
                }
            });
        });
    }

    // æ›´æ–°å¡ç‰‡åºå·
    function updateSettlementMethodNumbers() {
        cards.forEach((card, idx) => {
            const titleElement = card.querySelector('.card-title');
            if (titleElement) {
                titleElement.textContent = `ç»“ç®—æ–¹å¼ #${idx + 1}`;
            }
            // æ›´æ–°data-index
            card.setAttribute('data-index', idx);
            // æ›´æ–°æ‰€æœ‰è¾“å…¥æ¡†çš„nameå±æ€§ä¸­çš„index
            const inputs = card.querySelectorAll('input, select');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name && name.includes('[')) {
                    const newName = name.replace(/\[(\d+)\]/, '[' + idx + ']');
                    input.setAttribute('name', newName);
                }
            });
        });
    }

    // æ·»åŠ æŒ‰é’®äº‹ä»¶

        // å¦‚æœæ˜¯æ€»ä»·åŒ…å¹²ï¼ŒåŠ è½½æ€»ä»·åŒ…å¹²æ¡ç›®åˆ—è¡¨
        cards.forEach(function(card) {
            const indexAttr = card.getAttribute('data-index');
            if (indexAttr !== null) {
                const index = parseInt(indexAttr);
            }
        });
    });

    }

                // ç´¯è®¡ææˆï¼šéœ€è¦èŠ‚çœé‡‘é¢ï¼Œæš‚æ—¶æ— æ³•è®¡ç®—
                hasUncalculableMethod = true;
                    const unitPrice = parseFloat(fixedUnitPrice.value) || 0;
                    const totalArea = getTotalBuildingArea();
                    rowPrice += unitPrice * totalArea;
                }
                // æŒ‰å®ç»“ç®—éƒ¨åˆ†æš‚æ—¶æ— æ³•è®¡ç®—
                hasUncalculableMethod = true;
            } else {
                // å…¶ä»–ç»“ç®—æ–¹å¼ï¼ˆåˆ†æ®µé€’å¢ææˆã€è·³ç‚¹ææˆç­‰ï¼‰éœ€è¦èŠ‚çœé‡‘é¢ï¼Œæš‚æ—¶æ— æ³•è®¡ç®—
                hasUncalculableMethod = true;
            }

            totalPrice += rowPrice;
        });

        if (hasUncalculableMethod && totalPrice === 0) {
            contractPriceInput.value = 'éœ€æŒ‰å®ç»“ç®—';
        } else if (hasUncalculableMethod) {
            contractPriceInput.value = totalPrice.toFixed(2) + 'ï¼ˆéƒ¨åˆ†éœ€æŒ‰å®ç»“ç®—ï¼‰';
        } else if (totalPrice > 0) {
            contractPriceInput.value = totalPrice.toFixed(2);
        } else {
            contractPriceInput.value = '';
    }

    function getTotalBuildingArea() {
        let totalArea = 0;

            const areaInput = card.querySelector('input[name*="[area_scale]"]');
            if (areaInput && areaInput.value) {
                totalArea += parseFloat(areaInput.value) || 0;
            }
        });

        return totalArea;
    }

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç›‘å¬æ‰€æœ‰ç»“ç®—æ–¹å¼ç›¸å…³å­—æ®µçš„å˜åŒ–

        // ç›‘å¬ç»“ç®—æ–¹å¼è¡¨æ ¼ä¸­é¢ç§¯è§„æ¨¡çš„å˜åŒ–

        // é¡µé¢åŠ è½½æ—¶è®¡ç®—ä¸€æ¬¡

        // ========== ç»‘å®šæ‰€æœ‰ç¼ºå¤±çš„æ·»åŠ è¡ŒæŒ‰é’® ==========
        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°è¡Œåºå·
        function updateRowNumbers(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const rows = container.querySelectorAll('tr');
            rows.forEach(function(row, index) {
                const numCell = row.querySelector('td:first-child strong');
                if (numCell) {
                    numCell.textContent = index + 1;
                }
            });

        // ç»‘å®šæ€»ä»·åŒ…å¹²æ·»åŠ æŒ‰é’®
        const addFixedTotalBtn = document.getElementById('add-fixed-total-btn');
        if (addFixedTotalBtn) {
            addFixedTotalBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('fixed-total-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="fixed_total_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="fixed_total_items[${index}][area_scale]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="fixed_total_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('fixed-total-container');
                        calculateFixedTotalSubtotal();
                    });
                const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
                if (serviceFeeInput) {
                    serviceFeeInput.addEventListener('input', calculateFixedTotalSubtotal);
                }
                updateRowNumbers('fixed-total-container');
                calculateFixedTotalSubtotal();
            });

        // ç»‘å®šåŒ…å¹²å•ä»·æ·»åŠ æŒ‰é’®
        const addFixedUnitBtn = document.getElementById('add-fixed-unit-btn');
        if (addFixedUnitBtn) {
            addFixedUnitBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('fixed-unit-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="fixed_unit_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="fixed_unit_items[${index}][area_size]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td>
                        <select name="fixed_unit_items[${index}][area_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="fixed_unit_items[${index}][unit_price]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="fixed_unit_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('fixed-unit-container');
                        calculateFixedUnitSubtotal();
                    });
                const inputs = row.querySelectorAll('input[name*="[area_size]"], input[name*="[unit_price]"], input[name*="[service_fee]"]');
                inputs.forEach(function(input) {
                    input.addEventListener('input', function() {
                        const areaInput = row.querySelector('input[name*="[area_size]"]');
                        const unitPriceInput = row.querySelector('input[name*="[unit_price]"]');
                        const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
                        if (areaInput && unitPriceInput && serviceFeeInput) {
                            const area = parseFloat(areaInput.value) || 0;
                            const unitPrice = parseFloat(unitPriceInput.value) || 0;
                            serviceFeeInput.value = (area * unitPrice).toFixed(2);
                        }
                        calculateFixedUnitSubtotal();
                    });
                });
                updateRowNumbers('fixed-unit-container');
                calculateFixedUnitSubtotal();

        // ç»‘å®šç´¯è®¡ææˆæ·»åŠ æŒ‰é’®
        const addCumulativeCommissionBtn = document.getElementById('add-cumulative-commission-btn');
        if (addCumulativeCommissionBtn) {
            addCumulativeCommissionBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('cumulative-commission-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="cumulative_commission_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="cumulative_commission_items[${index}][area_scale]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td>
                        <select name="cumulative_commission_items[${index}][area_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="cumulative_commission_items[${index}][commission_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="cumulative_commission_items[${index}][adjustment_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00"></td>
                    <td><input type="number" name="cumulative_commission_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('cumulative-commission-container');
                    });
                }
                updateRowNumbers('cumulative-commission-container');
            });

        // ç»‘å®šåˆ†æ®µææˆæ·»åŠ æŒ‰é’®
        const addSegmentedCommissionBtn = document.getElementById('add-segmented-commission-btn');
        if (addSegmentedCommissionBtn) {
            addSegmentedCommissionBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('segmented-commission-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="segmented_commission_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="segmented_commission_items[${index}][area_scale]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td>
                        <select name="segmented_commission_items[${index}][area_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="segmented_commission_items[${index}][amount_range]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="segmented_commission_items[${index}][commission_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="segmented_commission_items[${index}][adjustment_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00"></td>
                    <td><input type="number" name="segmented_commission_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('segmented-commission-container');
                    });
                }
                updateRowNumbers('segmented-commission-container');
            });

        // ç»‘å®šè·³ç‚¹ææˆæ·»åŠ æŒ‰é’®
        const addJumpPointCommissionBtn = document.getElementById('add-jump-point-commission-btn');
        if (addJumpPointCommissionBtn) {
            addJumpPointCommissionBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('jump-point-commission-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="jump_point_commission_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="jump_point_commission_items[${index}][area_scale]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td>
                        <select name="jump_point_commission_items[${index}][area_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="jump_point_commission_items[${index}][jump_point_amount]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="jump_point_commission_items[${index}][commission_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="jump_point_commission_items[${index}][adjustment_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00"></td>
                    <td><input type="number" name="jump_point_commission_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('jump-point-commission-container');
                    });
                }
                updateRowNumbers('jump-point-commission-container');
            });

        (function() {
            const ourUnits = {{ our_units|safe|default:"[]" }};
            const select = document.getElementById('our_signing_party');
            if (select && Array.isArray(ourUnits)) {
                ourUnits.forEach(function(unit) {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    select.appendChild(option);
                });
            }
        })();
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/dynamic-table.js' %}"></script>
<script>
    // ========== é‡‘é¢è‡ªåŠ¨è®¡ç®—åŠŸèƒ½ ==========
    (function() {
        function calculateAmountFields() {
            // è·å–è¾“å…¥å­—æ®µ
            const contractAmountInput = document.querySelector('input[name="contract_amount"]');
            const taxRateInput = document.querySelector('input[name="tax_rate"]');
            const exclTaxDisplay = document.getElementById('contract_amount_excl_tax_display');
            const taxDisplay = document.getElementById('contract_amount_tax_display');
            const paymentAmountDisplay = document.getElementById('payment_amount_display');
            const unpaidAmountDisplay = document.getElementById('unpaid_amount_display');

            if (!contractAmountInput || !taxRateInput || !exclTaxDisplay || !taxDisplay || !unpaidAmountDisplay) {
                return;
            }

            // è·å–å€¼
            const contractAmount = parseFloat(contractAmountInput.value) || 0;
            const taxRate = parseFloat(taxRateInput.value) || 0;
            const paymentAmount = parseFloat(paymentAmountDisplay ? paymentAmountDisplay.value : 0) || 0;

            // è®¡ç®—ä¸å«ç¨é‡‘é¢å’Œç¨é¢
            if (contractAmount > 0 && taxRate >= 0) {
                const taxRateDecimal = taxRate / 100;
                if (taxRateDecimal > 0) {
                    const exclTax = contractAmount / (1 + taxRateDecimal);
                    const tax = contractAmount - exclTax;
                    exclTaxDisplay.value = exclTax.toFixed(2);
                    taxDisplay.value = tax.toFixed(2);
                } else {
                    exclTaxDisplay.value = contractAmount.toFixed(2);
                    taxDisplay.value = '0.00';
                }
            } else {
                exclTaxDisplay.value = '0.00';
                taxDisplay.value = '0.00';
            }

            // è®¡ç®—æœªå›æ¬¾é‡‘é¢
            const unpaidAmount = contractAmount - paymentAmount;
            unpaidAmountDisplay.value = Math.max(0, unpaidAmount).toFixed(2);
        }

        // ç­‰å¾…DOMåŠ è½½
        function initAmountCalculation() {
            const contractAmountInput = document.querySelector('input[name="contract_amount"]');
            const taxRateInput = document.querySelector('input[name="tax_rate"]');

            if (contractAmountInput && taxRateInput) {
                // ç»‘å®šäº‹ä»¶ç›‘å¬
                contractAmountInput.addEventListener('input', calculateAmountFields);
                contractAmountInput.addEventListener('change', calculateAmountFields);
                taxRateInput.addEventListener('input', calculateAmountFields);
                taxRateInput.addEventListener('change', calculateAmountFields);

                // åˆå§‹åŒ–è®¡ç®—
                calculateAmountFields();
            }
        }

        // åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAmountCalculation);
        } else {
            initAmountCalculation();
        }
    })();

    // ========== å…³è”å®¢æˆ·æ ¹æ®å…³è”å•†æœºè‡ªåŠ¨å¡«å…… ==========
    (function() {
        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initOpportunityClientFilter);
        } else {
            initOpportunityClientFilter();
        }

        function initOpportunityClientFilter() {
            const clientSelect = document.querySelector('[name="client"]');
            const opportunitySelect = document.querySelector('[name="opportunity"]');

            if (!clientSelect || !opportunitySelect) {
                return;
            }

            // ========== å…³è”å•†æœºchangeäº‹ä»¶ï¼šè‡ªåŠ¨å¡«å……å…³è”å®¢æˆ·å’Œé¡¹ç›®ä¸šæ€ ==========
            opportunitySelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const projectBusinessTypeInput = document.getElementById('project_business_type');
                const opportunityId = this.value;

                if (opportunityId) {
                    // ä»é€‰é¡¹çš„dataå±æ€§ä¸­è·å–å®¢æˆ·ä¿¡æ¯å’Œé¡¹ç›®ä¸šæ€
                    const clientId = selectedOption.getAttribute('data-client-id');
                    const clientName = selectedOption.getAttribute('data-client-name');
                    const projectType = selectedOption.getAttribute('data-project-type');

                    if (clientId && clientSelect) {
                        // å¡«å……å…³è”å®¢æˆ·
                        clientSelect.value = clientId;
                    }

                    if (projectType && projectBusinessTypeInput) {
                        // å¡«å……é¡¹ç›®ä¸šæ€
                        projectBusinessTypeInput.value = projectType;
                    }

                    // å¦‚æœé€‰é¡¹ä¸­æ²¡æœ‰dataå±æ€§ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹ä»Djangoæ¨¡æ¿æ¸²æŸ“çš„é€‰é¡¹ï¼‰ï¼Œä»APIè·å–
                    if (!clientId || !projectType) {
                        fetch(`/api/customer/authorization-letters/opportunities/?opportunity_id=${opportunityId}`, {
                            method: 'GET',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            }
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success && data.opportunity) {
                                const opp = data.opportunity;
                                // å¡«å……å…³è”å®¢æˆ·
                                if (opp.client && opp.client.id && clientSelect) {
                                    clientSelect.value = opp.client.id;
                                }
                                // å¡«å……é¡¹ç›®ä¸šæ€
                                if (opp.project_type && projectBusinessTypeInput) {
                                    projectBusinessTypeInput.value = opp.project_type;
                                }
                            }
                        })
                        .catch(error => {
                            console.error('è·å–å•†æœºè¯¦æƒ…å¤±è´¥:', error);
                        });
                    }
                } else {
                    // æœªé€‰æ‹©å•†æœºï¼Œæ¸…ç©ºå…³è”å®¢æˆ·å’Œé¡¹ç›®ä¸šæ€
                    if (clientSelect) {
                        clientSelect.value = '';
                    }
                    if (projectBusinessTypeInput) {
                        projectBusinessTypeInput.value = '';
                    }
                }
            });

            // é¡µé¢åŠ è½½æ—¶ï¼Œåˆå§‹åŒ–æ‰€æœ‰å•†æœºé€‰é¡¹çš„dataå±æ€§
            function initOpportunityOptions() {
                const options = opportunitySelect.options;
                const opportunityIds = [];

                // æ”¶é›†æ‰€æœ‰éœ€è¦åˆå§‹åŒ–çš„å•†æœºID
                for (let i = 0; i < options.length; i++) {
                    const option = options[i];
                    if (option.value && !option.getAttribute('data-client-id')) {
                        opportunityIds.push(option.value);
                    }
                }

                // å¦‚æœæœ‰éœ€è¦åˆå§‹åŒ–çš„å•†æœºï¼Œæ‰¹é‡è·å–è¯¦æƒ…
                if (opportunityIds.length > 0) {
                    // ä¸ºæ¯ä¸ªå•†æœºè·å–è¯¦æƒ…
                    opportunityIds.forEach(function(oppId) {
                        fetch(`/api/customer/authorization-letters/opportunities/?opportunity_id=${oppId}`, {
                            method: 'GET',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.opportunity) {
                                const opp = data.opportunity;
                                const option = opportunitySelect.querySelector(`option[value="${oppId}"]`);
                                if (option) {
                                    // è®¾ç½®dataå±æ€§
                                    if (opp.client && opp.client.id) {
                                        option.setAttribute('data-client-id', opp.client.id);
                                        option.setAttribute('data-client-name', opp.client.name || '');
                                    }
                                    if (opp.project_type) {
                                        option.setAttribute('data-project-type', opp.project_type);
                                    }
                                }
                            }
                        })
                        .catch(error => {
                            console.error(`è·å–å•†æœº ${oppId} è¯¦æƒ…å¤±è´¥:`, error);
                        });
                    });
                }
            }

            // é¡µé¢åŠ è½½æ—¶ï¼Œåˆå§‹åŒ–å•†æœºé€‰é¡¹
            initOpportunityOptions();

            // é¡µé¢åŠ è½½æ—¶ï¼Œå¦‚æœå·²é€‰æ‹©å…³è”å•†æœºï¼Œè‡ªåŠ¨å¡«å……å…³è”å®¢æˆ·å’Œé¡¹ç›®ä¸šæ€
            if (opportunitySelect.value) {
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿é€‰é¡¹å·²ç»åŠ è½½å®Œæˆ
                setTimeout(function() {
                    opportunitySelect.dispatchEvent(new Event('change'));
                }, 300);
            }
        }
    })();

    // ========== é¡¹ç›®ç¼–å·changeäº‹ä»¶ï¼šè‡ªåŠ¨ç”ŸæˆåˆåŒç¼–å· ==========
    (function() {
        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initContractNumberAutoGen);
        } else {
            initContractNumberAutoGen();
        }

        function initContractNumberAutoGen() {
            const projectNumberInput = document.querySelector('[name="project_number"]');
            const contractNumberInput = document.querySelector('[name="contract_number"]');

            if (!projectNumberInput || !contractNumberInput) {
                return;
            }

            // ä¿å­˜åˆåŒç¼–å·çš„åŸå§‹å€¼ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦è¢«æ‰‹åŠ¨ä¿®æ”¹è¿‡ï¼‰
            let contractNumberManuallyModified = false;
            let originalContractNumber = contractNumberInput.value;

            // ç›‘å¬åˆåŒç¼–å·çš„æ‰‹åŠ¨ä¿®æ”¹
            contractNumberInput.addEventListener('input', function() {
                // å¦‚æœç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹äº†åˆåŒç¼–å·ï¼Œæ ‡è®°ä¸ºå·²æ‰‹åŠ¨ä¿®æ”¹
                const currentValue = this.value;
                const autoGeneratedValue = projectNumberInput.value ? `HT-${projectNumberInput.value}` : '';

                // å¦‚æœå½“å‰å€¼ä¸ç­‰äºè‡ªåŠ¨ç”Ÿæˆçš„å€¼ï¼Œè¯´æ˜ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹äº†
                if (currentValue !== autoGeneratedValue && currentValue !== originalContractNumber) {
                    contractNumberManuallyModified = true;
                }
            });

            // ç›‘å¬é¡¹ç›®ç¼–å·å˜åŒ–
            projectNumberInput.addEventListener('change', function() {
                const projectNumber = this.value;

                // åªæœ‰åœ¨ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨ä¿®æ”¹åˆåŒç¼–å·çš„æƒ…å†µä¸‹ï¼Œæ‰è‡ªåŠ¨æ›´æ–°
                if (!contractNumberManuallyModified) {
                    if (projectNumber) {
                        contractNumberInput.value = `HT-${projectNumber}`;
                    } else {
                        contractNumberInput.value = '';
                    }
                }
            });

            // é¡µé¢åŠ è½½æ—¶ï¼Œå¦‚æœé¡¹ç›®ç¼–å·å­˜åœ¨ä½†åˆåŒç¼–å·ä¸ºç©ºï¼Œè‡ªåŠ¨ç”Ÿæˆ
            if (projectNumberInput.value && !contractNumberInput.value) {
                contractNumberInput.value = `HT-${projectNumberInput.value}`;
            }
        }
    })();

        // ä»APIè·å–è”ç³»äººåˆ—è¡¨
        fetch(`/api/customer-management/get-contacts-by-client-id/?client_id=${clientId}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('è”ç³»äººAPIå“åº”:', data);
            if (data.success && data.contacts) {
                if (callback) callback(data.contacts);
            } else {
                console.warn('è”ç³»äººAPIè¿”å›å¤±è´¥æˆ–ç©ºæ•°æ®:', data);
                if (callback) callback([]);
            }
        })
        .catch(error => {
            console.error('è·å–è”ç³»äººåˆ—è¡¨å¤±è´¥:', error);
            if (callback) callback([]);
        });
    }

    // æ›´æ–°æ‰€æœ‰è¡Œçš„è”ç³»äººä¸‹æ‹‰æ¡† - å…¨å±€ä½œç”¨åŸŸ
        function updateAllContactSelects(contacts) {
        selects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è”ç³»äºº</option>';

            contacts.forEach(contact => {
                const option = document.createElement('option');
                option.value = party.party_name;  // ä½¿ç”¨å•ä½åç§°ä½œä¸ºå€¼
                option.textContent = party.party_name;
                option.setAttribute('data-contact-id', contact.id);
                option.setAttribute('data-contact-phone', contact.phone || '');
                option.setAttribute('data-contact-email', contact.email || '');
                option.setAttribute('data-contact-address', contact.office_address || '');
                select.appendChild(option);
            });

            // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼
            if (currentValue) {
                select.value = currentValue;
            }
        });
    }

    // ç›‘å¬å…³è”å®¢æˆ·çš„å˜åŒ– - å…¨å±€ä½œç”¨åŸŸ
    let clientContactListenerAttached = false;
    function );
            clientContactListenerAttached = true;
        }
    }

    // ========== ç­¾çº¦ä¸»ä½“è¡¨æ ¼ç®¡ç†ï¼ˆä½¿ç”¨DynamicTableManagerï¼‰ ==========
    (function() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPartiesTable);
        } else {
            initPartiesTable();
        }

            // åŠ è½½ç°æœ‰æ•°æ®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
            {% if form.instance and form.instance.pk %}
                const existingParties = [
                    {% for party in form.instance.parties.all %}
                    {
                        party_type: '{{ party.party_type|escapejs }}',
                        party_name: '{{ party.party_name|escapejs }}',
                        credit_code: '{{ party.credit_code|escapejs }}',
                        legal_representative: '{{ party.legal_representative|escapejs }}',
                        project_manager: '{{ party.project_manager|escapejs }}',
                        contact_phone: '{{ party.contact_phone|escapejs }}',
                        contact_email: '{{ party.contact_email|escapejs }}',
                        address: '{{ party.address|escapejs }}'
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ];

                // æ¸…ç©ºå®¹å™¨ï¼ˆå¦‚æœæœ‰é»˜è®¤è¡Œï¼‰
                const container = document.getElementById('parties-container');
                if (container) {
                    container.innerHTML = '';
                }

                // æ·»åŠ ç°æœ‰æ•°æ®è¡Œ
                existingParties.forEach(function(partyData) {
                    partiesTableManager.addRow(partyData);
                });
                // å¦‚æœæ²¡æœ‰ç°æœ‰æ•°æ®ï¼Œè‡³å°‘æ·»åŠ ä¸€è¡Œç©ºè¡Œ
                if (existingParties.length === 0) {
                    partiesTableManager.addRow();
                }
                // æ›´æ–°ç´¢å¼•è®¡æ•°å™¨
                partiesTableManager.updateIndexCounter();
            {% else %}
                // åˆ›å»ºæ¨¡å¼ï¼šæ·»åŠ ä¸€è¡Œé»˜è®¤ç©ºè¡Œ
                partiesTableManager.addRow();
            {% endif %}
        // ç­‰å¾…DOMåŠ è½½å®Œæˆ

        // è”ç³»äººåˆ—è¡¨ç¼“å­˜ï¼ˆæŒ‰å®¢æˆ·IDï¼‰- æå‡åˆ°å…¨å±€ä½œç”¨åŸŸ
        const contactCache = {};
        // åŠ è½½è”ç³»äººåˆ—è¡¨çš„å‡½æ•° - æå‡åˆ°å…¨å±€ä½œç”¨åŸŸ
        function loadContactsByClientId(clientId, callback) {

            // å¦‚æœç¼“å­˜ä¸­æœ‰ï¼Œç›´æ¥ä½¿ç”¨
                return;
            }

            // ä»APIè·å–è”ç³»äººåˆ—è¡¨
            fetch(`/api/customer-management/get-contacts-by-client-id/?client_id=${clientId}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('è”ç³»äººAPIå“åº”:', data);
                if (data.success && data.contacts) {
                    if (callback) callback(data.contacts);
                } else {
                    console.warn('è”ç³»äººAPIè¿”å›å¤±è´¥æˆ–ç©ºæ•°æ®:', data);
                    if (callback) callback([]);
                }
            })
            .catch(error => {
                console.error('è·å–è”ç³»äººåˆ—è¡¨å¤±è´¥:', error);
                if (callback) callback([]);
            });

        // æ›´æ–°æ‰€æœ‰è¡Œçš„è”ç³»äººä¸‹æ‹‰æ¡† - æå‡åˆ°å…¨å±€ä½œç”¨åŸŸ
        function updateAllContactSelects(contacts) {
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">è¯·é€‰æ‹©è”ç³»äºº</option>';

                contacts.forEach(contact => {
                    const option = document.createElement('option');
                    option.value = party.party_name;  // ä½¿ç”¨å•ä½åç§°ä½œä¸ºå€¼
                    option.textContent = party.party_name;
                    option.setAttribute('data-contact-id', contact.id);
                    option.setAttribute('data-contact-phone', contact.phone || '');
                    option.setAttribute('data-contact-email', contact.email || '');
                    option.setAttribute('data-contact-address', contact.office_address || '');
                    select.appendChild(option);
                });

                // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        // ç›‘å¬å…³è”å®¢æˆ·çš„å˜åŒ– - æå‡åˆ°å…¨å±€ä½œç”¨åŸŸ
        let clientContactListenerAttached = false;
        function attachClientContactListener() {
                        // æ¸…ç©ºæ‰€æœ‰è”ç³»äººä¸‹æ‹‰æ¡†

                });
                clientContactListenerAttached = true;

        function initPartiesTable() {
            // æ£€æŸ¥DynamicTableManageræ˜¯å¦å·²åŠ è½½
            if (typeof DynamicTableManager === 'undefined') {
                console.error('DynamicTableManager æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ dynamic-table.js æ–‡ä»¶');
                return;
            }

            // è¡Œæ¨¡æ¿å‡½æ•°
            function partyRowTemplate(index, data) {
                const party = data || {};
                return `
                    <td style="text-align: center;">
                        <strong>${index + 1}</strong>
                    </td>
                    <td>
                        <input type="text" name="parties[${index}][party_name]" class="form-control form-control-sm"
                               value="${party.party_name || ''}" placeholder="è¯·è¾“å…¥å•ä½åç§°" required>
                    </td>
                    <td>
                        <input type="text" name="parties[${index}][credit_code]" class="form-control form-control-sm"
                               value="${party.credit_code || ''}" placeholder="è¯·è¾“å…¥ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ">
                    </td>
                    <td>
                        <input type="text" name="parties[${index}][legal_representative]" class="form-control form-control-sm"
                               value="${party.legal_representative || ''}" placeholder="è¯·è¾“å…¥æ³•å®šä»£è¡¨äºº">
                    </td>
                    <td>
                        <input type="text" name="parties[${index}][project_manager]" class="form-control form-control-sm"
                               value="${party.project_manager || ''}" placeholder="è¯·è¾“å…¥é¡¹ç›®è´Ÿè´£äºº">
                    </td>
                    <td>
                        <input type="text" name="parties[${index}][contact_phone]" class="form-control form-control-sm"
                               value="${party.contact_phone || ''}" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯">
                    </td>
                    <td>
                        <input type="email" name="parties[${index}][contact_email]" class="form-control form-control-sm"
                               value="${party.contact_email || ''}" placeholder="è¯·è¾“å…¥è”ç³»é‚®ç®±">
                    </td>
                    <td>
                        <input type="text" name="parties[${index}][address]" class="form-control form-control-sm"
                               value="${party.address || ''}" placeholder="è¯·è¾“å…¥åŠå…¬åœ°å€">
                    </td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-party-btn">
                            <i class="bi bi-trash"></i> åˆ é™¤
                        </button>
                    </td>
                `;
            }

            // åˆå§‹åŒ–DynamicTableManager
            const partiesTableManager = new DynamicTableManager({
                containerId: 'parties-container',
                rowClass: 'party-row',
                addButtonId: 'add-party-btn',
                removeButtonClass: 'remove-party-btn',
                minRows: 1,
                rowTemplate: partyRowTemplate,
                autoUpdateNumbers: true,
                numberCellSelector: 'td:first-child',
                onAdd: function(row, index) {
                    // æ·»åŠ è¡Œåçš„å›è°ƒï¼šåŠ è½½è”ç³»äººåˆ—è¡¨
                    const clientSelect = document.querySelector('[name="client"]');
                    if (clientSelect && clientSelect.value) {
                        const clientId = clientSelect.value;
                        console.log('æ·»åŠ æ–°è¡Œï¼Œå®¢æˆ·ID:', clientId);

                        loadContactsByClientId(clientId, function(contacts) {
                            updateAllContactSelects(contacts);
                        });
                    } else {
                        console.warn('æ·»åŠ æ–°è¡Œæ—¶ï¼Œæœªé€‰æ‹©å®¢æˆ·');
                    }
                    console.log('æ·»åŠ äº†ç­¾çº¦ä¸»ä½“è¡Œï¼Œç´¢å¼•:', index);
                },
                onRemove: function(row, index) {
                    // åˆ é™¤è¡Œå‰çš„å›è°ƒï¼ˆå¦‚æœéœ€è¦ï¼‰
                    console.log('åˆ é™¤äº†ç­¾çº¦ä¸»ä½“è¡Œï¼Œç´¢å¼•:', index);
                    return true; // è¿”å›trueå…è®¸åˆ é™¤
                }
            });

            // ç›‘å¬è”ç³»äººé€‰æ‹©å˜åŒ–ï¼Œè‡ªåŠ¨å¡«å……è”ç³»æ–¹å¼
            document.addEventListener('change', function(e) {
                    const select = e.target;
                    const selectedOption = select.options[select.selectedIndex];
                    const row = select.closest('tr');

                    if (selectedOption && selectedOption.value) {
                        // è‡ªåŠ¨å¡«å……è”ç³»ç”µè¯
                        const phoneInput = row.querySelector('input[name*="[contact_phone]"]');
                        if (phoneInput && selectedOption.getAttribute('data-contact-phone')) {
                            phoneInput.value = selectedOption.getAttribute('data-contact-phone');
                        }

                        // è‡ªåŠ¨å¡«å……è”ç³»é‚®ç®±
                        const emailInput = row.querySelector('input[name*="[contact_email]"]');
                        if (emailInput && selectedOption.getAttribute('data-contact-email')) {
                            emailInput.value = selectedOption.getAttribute('data-contact-email');
                        }

                        // è‡ªåŠ¨å¡«å……åŠå…¬åœ°å€
                        const addressInput = row.querySelector('input[name*="[address]"]');
                        if (addressInput && selectedOption.getAttribute('data-contact-address')) {
                            addressInput.value = selectedOption.getAttribute('data-contact-address');
                        }
                    }
                }
            });
    })();
// ========== æœåŠ¡ä¿¡æ¯è¡¨æ ¼ç®¡ç†ï¼ˆä½¿ç”¨DynamicTableManagerï¼‰ ==========
        (function() {
            function initServiceContentsTable() {
                // æ£€æŸ¥DynamicTableManageræ˜¯å¦å·²åŠ è½½
                if (typeof DynamicTableManager === 'undefined') {
                    console.error('DynamicTableManager æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ dynamic-table.js æ–‡ä»¶');
                    return;
                }

                // æœåŠ¡ä¿¡æ¯æ•°æ®ï¼ˆä»åç«¯ä¼ å…¥ï¼‰
                const serviceTypesData = [
                    {% for st in service_types %}
                    { id: {{ st.id }}, name: "{{ st.name|escapejs }}" }{% if not forloop.last %},{% endif %}
                    {% empty %}
                    // æ— æœåŠ¡ç±»å‹æ•°æ®
                    {% endfor %}
                ];

                const designStagesData = [
                    {% for ds in design_stages %}
                    { id: {{ ds.id }}, name: "{{ ds.name|escapejs }}" }{% if not forloop.last %},{% endif %}
                    {% empty %}
                    // æ— å›¾çº¸é˜¶æ®µæ•°æ®
                    {% endfor %}
                ];

                const businessTypesData = [
                    {% for bt in business_types %}
                    { id: {{ bt.id }}, name: "{{ bt.name|escapejs }}" }{% if not forloop.last %},{% endif %}
                    {% empty %}
                    // æ— é¡¹ç›®ä¸šæ€æ•°æ®
                    {% endfor %}
                ];

                const serviceProfessionsData = [
                    {% for sp in service_professions %}
                    { id: {{ sp.id }}, name: "{{ sp.name|escapejs }}", service_type_id: {{ sp.service_type_id|default:"null" }} }{% if not forloop.last %},{% endif %}
                    {% empty %}
                    // æ— æœåŠ¡ä¸“ä¸šæ•°æ®
                    {% endfor %}
                ];
            // å¡«å……ä¸‹æ‹‰é€‰é¡¹çš„å‡½æ•°
            function populateSelectOptions(row, serviceTypeId, designStageId, businessTypeId, professionIds) {
                if (!row) return;

                // å¡«å……æœåŠ¡ç±»å‹ä¸‹æ‹‰é€‰é¡¹
                const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                if (serviceTypeSelect && Array.isArray(serviceTypesData)) {
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ª"è¯·é€‰æ‹©"é€‰é¡¹ï¼‰
                    serviceTypeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    serviceTypesData.forEach(function(st) {
                        const option = document.createElement('option');
                        option.value = st.id;
                        option.textContent = st.name;
                        if (serviceTypeId && String(st.id) === String(serviceTypeId)) {
                            option.selected = true;
                        }
                        serviceTypeSelect.appendChild(option);
                    });
                }

                // å¡«å……è®¾è®¡é˜¶æ®µä¸‹æ‹‰é€‰é¡¹
                const designStageSelect = row.querySelector('select[name*="[design_stage]"]');
                if (designStageSelect && Array.isArray(designStagesData)) {
                    designStageSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    designStagesData.forEach(function(ds) {
                        const option = document.createElement('option');
                        option.value = ds.id;
                        option.textContent = ds.name;
                        if (designStageId && String(ds.id) === String(designStageId)) {
                            option.selected = true;
                        }
                        designStageSelect.appendChild(option);
                    });
                }

                // å¡«å……é¡¹ç›®ä¸šæ€ä¸‹æ‹‰é€‰é¡¹
                const businessTypeSelect = row.querySelector('select[name*="[business_type]"]');
                if (businessTypeSelect && Array.isArray(businessTypesData)) {
                    businessTypeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    businessTypesData.forEach(function(bt) {
                        const option = document.createElement('option');
                        option.value = bt.id;
                        option.textContent = bt.name;
                        if (businessTypeId && String(bt.id) === String(businessTypeId)) {
                            option.selected = true;
                        }
                        businessTypeSelect.appendChild(option);
                    });
                }

                // å¡«å……æœåŠ¡ä¸“ä¸šä¸‹æ‹‰é€‰é¡¹ï¼ˆæ ¹æ®æœåŠ¡ç±»å‹è¿‡æ»¤ï¼‰
                const professionSelect = row.querySelector('select[name*="[service_professions]"]');
                if (professionSelect && Array.isArray(serviceProfessionsData)) {
                    professionSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    const selectedServiceTypeId = serviceTypeId || (serviceTypeSelect ? serviceTypeSelect.value : null);
                    serviceProfessionsData.forEach(function(sp) {
                        // å¦‚æœæŒ‡å®šäº†æœåŠ¡ç±»å‹ï¼Œåªæ˜¾ç¤ºåŒ¹é…çš„ä¸“ä¸š
                        if (selectedServiceTypeId && sp.service_type_id && String(sp.service_type_id) !== String(selectedServiceTypeId)) {
                            return;
                        const option = document.createElement('option');
                        option.value = sp.id;
                        option.textContent = sp.name;
                        if (Array.isArray(professionIds) && professionIds.includes(sp.id)) {
                            option.selected = true;
                        }
                        professionSelect.appendChild(option);
                    });
                }

                // ç›‘å¬æœåŠ¡ç±»å‹å˜åŒ–ï¼Œæ›´æ–°æœåŠ¡ä¸“ä¸šé€‰é¡¹
                if (serviceTypeSelect) {
                    serviceTypeSelect.addEventListener('change', function() {
                        const selectedServiceTypeId = this.value;
                        if (professionSelect) {
                            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……æœåŠ¡ä¸“ä¸šé€‰é¡¹
                            professionSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                            serviceProfessionsData.forEach(function(sp) {
                                if (!selectedServiceTypeId || !sp.service_type_id || String(sp.service_type_id) === String(selectedServiceTypeId)) {
                                    const option = document.createElement('option');
                                    option.value = sp.id;
                                    option.textContent = sp.name;
                                    professionSelect.appendChild(option);
                                }
                            });
                        }
                    });
                }
            }
            // ç­‰å¾…DOMåŠ è½½å®Œæˆ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initServiceContentsTable);
            } else {
                initServiceContentsTable();
            }

// è¡Œæ¨¡æ¿å‡½æ•°
            function serviceContentRowTemplate(index, data) {
                const service = data || {};
                const serviceTypeId = service.service_type_id || service.service_type || '';
                const designStageId = service.design_stage_id || service.design_stage || '';
                const businessTypeId = service.business_type_id || service.business_type || '';
                const buildingArea = service.building_area || '';
                const professionIds = service.service_profession_ids || service.service_professions || [];

                return `                    <td style="text-align: center;">
                        <strong>${index + 1}</strong>
                    </td>
                    <td>
                        <select name="service_contents[${index}][service_type]" class="form-select form-select-sm service-type-select">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                        </select>
                    </td>
                    <td>
                        <select name="service_contents[${index}][design_stage]" class="form-select form-select-sm">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" name="service_contents[${index}][building_area]" class="form-control form-control-sm"
                               step="0.01" placeholder="0.00" value="${buildingArea}">
                    </td>
                    <td>
                        <select name="service_contents[${index}][business_type]" class="form-select form-select-sm">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                        </select>
                    </td>
                    <td>
                        <select name="service_contents[${index}][service_professions]" class="form-select form-select-sm" multiple style="min-height: 60px; max-height: 80px;">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                        </select>
                        <small class="form-text text-muted" style="font-size: 10px;">å¯å¤šé€‰</small>
                    </td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-service-content-btn">
                            <i class="bi bi-trash"></i> åˆ é™¤
                        </button>
                    </td>
                `;
            }

            // åˆå§‹åŒ–DynamicTableManager
            const serviceContentsTableManager = new DynamicTableManager({
                containerId: 'service-contents-container',
                rowClass: 'service-content-row',
                addButtonId: 'add-service-content-btn',
                removeButtonClass: 'remove-service-content-btn',
                minRows: 1,
                rowTemplate: serviceContentRowTemplate,
                autoUpdateNumbers: true,
                numberCellSelector: 'td:first-child',
                onAdd: function(row, index) {
                    // æ·»åŠ è¡Œåå¡«å……ä¸‹æ‹‰é€‰é¡¹
                    populateSelectOptions(row, null, null, null, []);
                    console.log('æ·»åŠ äº†æœåŠ¡ä¿¡æ¯è¡Œï¼Œç´¢å¼•:', index);
                },
                onRemove: function(row, index) {
                    // åˆ é™¤è¡Œå‰çš„å›è°ƒ
                    console.log('åˆ é™¤äº†æœåŠ¡ä¿¡æ¯è¡Œï¼Œç´¢å¼•:', index);
                    return true; // è¿”å›trueå…è®¸åˆ é™¤
                }
            });

            // ç›‘å¬è”ç³»äººé€‰æ‹©å˜åŒ–ï¼Œè‡ªåŠ¨å¡«å……è”ç³»æ–¹å¼
            document.addEventListener('change', function(e) {
                    const select = e.target;
                    const selectedOption = select.options[select.selectedIndex];
                    const row = select.closest('tr');

                    if (selectedOption && selectedOption.value) {
                        // è‡ªåŠ¨å¡«å……è”ç³»ç”µè¯
                        const phoneInput = row.querySelector('input[name*="[contact_phone]"]');
                        if (phoneInput && selectedOption.getAttribute('data-contact-phone')) {
                            phoneInput.value = selectedOption.getAttribute('data-contact-phone');
                        }

                        // è‡ªåŠ¨å¡«å……è”ç³»é‚®ç®±
                        const emailInput = row.querySelector('input[name*="[contact_email]"]');
                        if (emailInput && selectedOption.getAttribute('data-contact-email')) {
                            emailInput.value = selectedOption.getAttribute('data-contact-email');
                        }

                        // è‡ªåŠ¨å¡«å……åŠå…¬åœ°å€
                        const addressInput = row.querySelector('input[name*="[address]"]');
                        if (addressInput && selectedOption.getAttribute('data-contact-address')) {
                            addressInput.value = selectedOption.getAttribute('data-contact-address');
                        }
                    }
                }
            });

            // åŠ è½½ç°æœ‰æ•°æ®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
            {% if form.instance and form.instance.pk %}
                const existingServiceContents = [
                    {% for service in form.instance.service_contents.all %}
                    {
                        service_type_id: {{ service.service_type_id|default:"null" }},
                        design_stage_id: {{ service.design_stage_id|default:"null" }},
                        business_type_id: {{ service.business_type_id|default:"null" }},
                        building_area: {{ service.building_area|default:"0" }},
                        service_profession_ids: [{% for sp in service.service_professions.all %}{{ sp.id }}{% if not forloop.last %}, {% endif %}{% empty %}{% endfor %}]
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ];

                // æ¸…ç©ºå®¹å™¨ï¼ˆå¦‚æœæœ‰é»˜è®¤è¡Œï¼‰
                const container = document.getElementById('service-contents-container');
                if (container) {
                    container.innerHTML = '';
                }

                // æ·»åŠ ç°æœ‰æ•°æ®è¡Œ
                existingServiceContents.forEach(function(serviceData) {
                    const row = serviceContentsTableManager.addRow(serviceData);
                    if (row) {
                        populateSelectOptions(
                            row,
                            serviceData.service_type_id,
                            serviceData.design_stage_id,
                            serviceData.business_type_id,
                            serviceData.service_profession_ids || []
                        );
                    }
                });
                // å¦‚æœæ²¡æœ‰ç°æœ‰æ•°æ®ï¼Œè‡³å°‘æ·»åŠ ä¸€è¡Œç©ºè¡Œ
                if (existingServiceContents.length === 0) {
                    const defaultRow = serviceContentsTableManager.addRow();
                    if (defaultRow) {
                        populateSelectOptions(defaultRow, null, null, null, []);
                    }
                }
                // æ›´æ–°ç´¢å¼•è®¡æ•°å™¨
                serviceContentsTableManager.updateIndexCounter();
            {% else %}
                // åˆ›å»ºæ¨¡å¼ï¼šæ·»åŠ ä¸€è¡Œé»˜è®¤ç©ºè¡Œ
                const defaultRow = serviceContentsTableManager.addRow();
                if (defaultRow) {
                    populateSelectOptions(defaultRow, null, null, null, []);
                }
            {% endif %}
        }
    })();

    // ========== å›æ¬¾ä¿¡æ¯è¡¨æ ¼ç®¡ç†ï¼ˆä½¿ç”¨DynamicTableManagerï¼‰ ==========
    (function() {
            initPaymentInfoTable();
        }

            // åŠ è½½ç°æœ‰æ•°æ®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
            {% if form.instance and form.instance.pk %}
                const existingPaymentPlans = [
                    {% for plan in form.instance.payment_plans.all %}
                    {
                        phase_name: '{{ plan.phase_name|escapejs }}',
                        trigger_condition: '{{ plan.trigger_condition|escapejs }}',
                        payment_method: '{{ plan.payment_method|escapejs }}',
                        planned_amount: '{{ plan.planned_amount|default:"" }}',
                        condition_detail: '{{ plan.condition_detail|escapejs }}'
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ];

                // æ¸…ç©ºå®¹å™¨ï¼ˆå¦‚æœæœ‰é»˜è®¤è¡Œï¼‰
                const container = document.getElementById('payment-info-container');
                if (container) {
                    container.innerHTML = '';
                }

                // æ·»åŠ ç°æœ‰æ•°æ®è¡Œ
                existingPaymentPlans.forEach(function(paymentData) {
                    paymentInfoTableManager.addRow(paymentData);
                });
                // å¦‚æœæ²¡æœ‰ç°æœ‰æ•°æ®ï¼Œè‡³å°‘æ·»åŠ ä¸€è¡Œç©ºè¡Œ
                if (existingPaymentPlans.length === 0) {
                    paymentInfoTableManager.addRow();
                }
                // æ›´æ–°ç´¢å¼•è®¡æ•°å™¨
                paymentInfoTableManager.updateIndexCounter();
            {% else %}
                // åˆ›å»ºæ¨¡å¼ï¼šæ·»åŠ ä¸€è¡Œé»˜è®¤ç©ºè¡Œ
                paymentInfoTableManager.addRow();
            {% endif %}
        }
        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPaymentInfoTable);
        } else {

    })();

    // é¡µé¢åŠ è½½å®Œæˆåæµ‹è¯•å‡½æ•°æ˜¯å¦å¯ç”¨
    (function() {
        function testContactFunctions() {
            console.log('

            // å°è¯•æŸ¥æ‰¾è”ç³»äººä¸‹æ‹‰æ¡†
            const contactSelects = document.querySelectorAll('

        // åœ¨DOMåŠ è½½å®Œæˆåæ‰§è¡Œæµ‹è¯•
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(testContactFunctions, 1000);
            });
        } else {
            setTimeout(testContactFunctions, 1000);
        }
        function initPaymentInfoTable() {
            // æ£€æŸ¥DynamicTableManageræ˜¯å¦å·²åŠ è½½
            if (typeof DynamicTableManager === 'undefined') {
                console.error('DynamicTableManager æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ dynamic-table.js æ–‡ä»¶');
                return;
            }

            // å›æ¬¾ä¿¡æ¯è¡Œæ¨¡æ¿å‡½æ•°
            function paymentInfoRowTemplate(index, data) {
                const payment = data || {};
                return `
                    <td style="text-align: center;">
                        <strong>${index + 1}</strong>
                    </td>
                    <td>
                        <input type="text" name="payment_plans[${index}][phase_name]" class="form-control form-control-sm"
                               value="${payment.phase_name || ''}" placeholder="è¯·è¾“å…¥é˜¶æ®µåç§°" required>
                    </td>
                    <td>
                        <input type="text" name="payment_plans[${index}][trigger_condition]" class="form-control form-control-sm"
                               value="${payment.trigger_condition || ''}" placeholder="è¯·è¾“å…¥è§¦å‘æ¡ä»¶">
                    </td>
                    <td>
                        <input type="text" name="payment_plans[${index}][payment_method]" class="form-control form-control-sm"
                               value="${payment.payment_method || ''}" placeholder="è¯·è¾“å…¥ä»˜æ¬¾æ–¹å¼">
                    </td>
                    <td>
                        <input type="number" name="payment_plans[${index}][planned_amount]" class="form-control form-control-sm"
                               step="0.01" value="${payment.planned_amount || ''}" placeholder="0.00">
                    </td>
                    <td>
                        <textarea name="payment_plans[${index}][condition_detail]" class="form-control form-control-sm"
                                  rows="2" placeholder="è¯·è¾“å…¥æ¡ä»¶è¯¦æƒ…">${payment.condition_detail || ''}</textarea>
                    </td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-payment-info-btn">
                            <i class="bi bi-trash"></i> åˆ é™¤
                        </button>
                    </td>
                `;
            }

            const paymentInfoTableManager = new DynamicTableManager({
                containerId: 'payment-info-container',
                rowClass: 'payment-info-row',
                addButtonId: 'add-payment-info-btn',
                removeButtonClass: 'remove-payment-info-btn',
                minRows: 1,
                rowTemplate: paymentInfoRowTemplate,
                autoUpdateNumbers: true,
                numberCellSelector: 'td:first-child',
                onAdd: function(row, index) {
                    // æ·»åŠ è¡Œåçš„å›è°ƒï¼ˆå¦‚æœéœ€è¦ï¼‰
                    console.log('æ·»åŠ äº†å›æ¬¾ä¿¡æ¯è¡Œï¼Œç´¢å¼•:', index);
                },
                onRemove: function(row, index) {
                    // åˆ é™¤è¡Œå‰çš„å›è°ƒï¼ˆå¦‚æœéœ€è¦ï¼‰
                    console.log('åˆ é™¤äº†å›æ¬¾ä¿¡æ¯è¡Œï¼Œç´¢å¼•:', index);
                    return true; // è¿”å›trueå…è®¸åˆ é™¤
                }
            });

            // ç›‘å¬è”ç³»äººé€‰æ‹©å˜åŒ–ï¼Œè‡ªåŠ¨å¡«å……è”ç³»æ–¹å¼
            document.addEventListener('change', function(e) {
                    const select = e.target;
                    const selectedOption = select.options[select.selectedIndex];
                    const row = select.closest('tr');

                    if (selectedOption && selectedOption.value) {
                        // è‡ªåŠ¨å¡«å……è”ç³»ç”µè¯
                        const phoneInput = row.querySelector('input[name*="[contact_phone]"]');
                        if (phoneInput && selectedOption.getAttribute('data-contact-phone')) {
                            phoneInput.value = selectedOption.getAttribute('data-contact-phone');
                        }

                        // è‡ªåŠ¨å¡«å……è”ç³»é‚®ç®±
                        const emailInput = row.querySelector('input[name*="[contact_email]"]');
                        if (emailInput && selectedOption.getAttribute('data-contact-email')) {
                            emailInput.value = selectedOption.getAttribute('data-contact-email');
                        }

                        // è‡ªåŠ¨å¡«å……åŠå…¬åœ°å€
                        const addressInput = row.querySelector('input[name*="[address]"]');
                        if (addressInput && selectedOption.getAttribute('data-contact-address')) {
                            addressInput.value = selectedOption.getAttribute('data-contact-address');
                        }
                    }
                }
            });
    })();

</script>
{% endblock %}
