{% extends "shared/_partials/_shared_form_wrapper_customer.html" %}
{% load static %}

{% block pm_title %}{{ page_title|default:"创建拜访打卡" }}{% endblock %}
{% block pm_subtitle %}<span class="pm-subtitle">{{ form_page_subtitle_text|default:"请填写打卡信息" }}</span>{% endblock %}
{% block pm_actions %}
{% if visit_plan %}
<a href="{% url 'business_pages:visit_plan_detail' visit_plan.id %}" class="list-btn">
  返回详情
</a>
{% else %}
<a href="{% url 'business_pages:customer_visit' %}" class="list-btn">
  返回列表
</a>
{% endif %}
{% endblock %}

{% block pm_content %}
<div class="form-container">

  {% if form.errors %}
  <div class="form-alert form-alert-danger">
    <div class="form-alert-title">提交失败：请完善必填项</div>
    <ul class="form-alert-list">
      {% for field in form %}
        {% if field.errors %}
          <li><strong>{{ field.label }}</strong>：{{ field.errors|striptags }}</li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <form method="post" novalidate>

    {{ form.checkin_time }}
    {{ form.checkin_location }}
    {% csrf_token %}

    {% if form.non_field_errors %}
    <div class="form-alert form-alert-danger">
      <div class="form-alert-title">提交失败</div>
      <div class="form-alert-list">{{ form.non_field_errors }}</div>
    </div>
    {% endif %}

    <div class="form-row">
      <div class="form-group d-none d-md-block">
        <label class="form-label" for="{{ form.latitude.id_for_label }}">
          {{ form.latitude.label }}
        </label>
        {{ form.latitude }}
        {% if form.latitude.errors %}
        <div class="form-error">{{ form.latitude.errors }}</div>
        {% endif %}
      </div>

      <div class="form-group d-none d-md-block">
        <label class="form-label" for="{{ form.longitude.id_for_label }}">
          {{ form.longitude.label }}
        </label>
        {{ form.longitude }}
        {% if form.longitude.errors %}
        <div class="form-error">{{ form.longitude.errors }}</div>
        {% endif %}
      </div>
    </div>

    <div class="form-group form-row-full" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #E0E0E0;">
      <label class="form-label">位置定位</label>
      <div style="margin-bottom: 12px;">
        <button type="button" class="form-btn form-btn-secondary" data-click="handle_onclick_0" style="margin-right: 12px;">
          <i class="bi bi-geo-alt-fill"></i> 获取当前位置
        </button>
      </div>
      <div id="locationDisplay" class="p-3 bg-light rounded" style="background: #F5F5F5; border: 1px solid #E0E0E0; border-radius: 0;"></div>
    </div>

    <div class="form-actions">
      <div class="form-actions-left">
        {% if visit_plan %}
          <a href="{% url 'business_pages:visit_plan_detail' visit_plan.id %}" class="form-btn form-btn-secondary">取消</a>
        {% else %}
          <a href="{% url 'business_pages:customer_visit' %}" class="form-btn form-btn-secondary">取消</a>
        {% endif %}
        <button type="submit" class="form-btn form-btn-primary">{{ submit_text|default:"提交打卡" }}</button>
      </div>
      <div class="form-actions-right">
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 定位功能（打卡页面）
    const hiddenLatitude = document.getElementById('id_latitude');
    const hiddenLongitude = document.getElementById('id_longitude');
    const hiddenLocationAddress = document.getElementById('id_checkin_location');
    const locationDisplay = document.getElementById('locationDisplay');

    function updateLocationDisplay(latitude, longitude, address) {
        if (!locationDisplay) return;

        if (latitude && longitude) {
            const lat = parseFloat(latitude).toFixed(7);
            const lon = parseFloat(longitude).toFixed(7);

            let displayHtml = `
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="bi bi-check-circle-fill text-success"></i>
                    <span class="fw-bold text-success">定位成功</span>
                </div>
            `;

            if (address) {
                displayHtml += `
                    <div class="mb-2">
                        <div class="text-muted small">地址：</div>
                        <div class="fw-semibold">${address}</div>
                    </div>
                `;
            }

            displayHtml += `
                <div>
                    <div class="text-muted small">坐标：</div>
                    <div class="font-monospace small">纬度 ${lat}，经度 ${lon}</div>
                </div>
            `;

            locationDisplay.innerHTML = displayHtml;
        }
    }

    async function getAddressFromCoordinates(latitude, longitude) {
        try {
            const response = await fetch(`/api/customer/regeocode/?latitude=${latitude}&longitude=${longitude}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                credentials: 'same-origin'
            });

            const data = await response.json();

            if (data.success && data.formatted_address) {
                if (hiddenLocationAddress) {
                    hiddenLocationAddress.value = data.formatted_address;}
                updateLocationDisplay(latitude, longitude, data.formatted_address);
                return true;
            } else {
                updateLocationDisplay(latitude, longitude, null);
                return false;
            }
        } catch (error) {
            updateLocationDisplay(latitude, longitude, null);
            return false;
        }
    }

    function getLocation() {
        if (!navigator.geolocation) {
            alert('浏览器不支持GPS定位');
            return;
        }

        if (locationDisplay) {
            locationDisplay.innerHTML = '<div class="text-muted"><i class="bi bi-hourglass-split"></i> 正在获取位置信息...</div>';
        }

        navigator.geolocation.getCurrentPosition(
            async function(position) {
                const lat = position.coords.latitude.toFixed(7);
                const lon = position.coords.longitude.toFixed(7);

                if (hiddenLatitude) hiddenLatitude.value = lat;
                if (hiddenLongitude) hiddenLongitude.value = lon;

                await getAddressFromCoordinates(lat, lon);
            },
            function(error) {
                if (locationDisplay) {
                    locationDisplay.innerHTML = '<div class="text-danger"><i class="bi bi-exclamation-circle"></i> 定位失败：' + error.message + '</div>';
                }
            },
            {
                enableHighAccuracy: true,
                timeout: 30000,
                maximumAge: 60000
            }
        );
    }

    // 检查是否已有位置信息
    if (hiddenLatitude && hiddenLatitude.value && hiddenLongitude && hiddenLongitude.value) {
        updateLocationDisplay(hiddenLatitude.value, hiddenLongitude.value, hiddenLocationAddress ? hiddenLocationAddress.value : '');
    }

    // 事件处理器: handle_onclick_0
    document.addEventListener('DOMContentLoaded', function() {
        const element = document.querySelector('[data-click="handle_onclick_0"]');
        if (element) {
            element.addEventListener('click', function(e) {
                getLocation();
            });
        }

        // 移动端自动获取位置
        if (/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)) {
            // 移动端自动获取位置
            if (!hiddenLatitude || !hiddenLatitude.value || !hiddenLongitude || !hiddenLongitude.value) {
                setTimeout(function() { getLocation(); }, 500);
            }
        }
    });
</script>
{% endblock %}
