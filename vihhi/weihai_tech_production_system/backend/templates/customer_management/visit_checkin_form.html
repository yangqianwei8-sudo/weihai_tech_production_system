{% extends "customer_management/_base.html" %}
{% load static %}

{% block title %}{{ page_title }} - 维海科技信息化管理平台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'business_pages:customer_list' %}">客户管理</a></li>
<li class="breadcrumb-item"><a href="{% url 'business_pages:visit_checkin' %}">拜访签到</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ page_title }}</li>
{% endblock %}

{% block content %}
<div class="info-card info-card-compact">
    <div class="info-card-header">
        <h5 class="info-card-title">{{ page_title }}</h5>
    </div>
    <div class="info-card-body">
        <form method="post" id="checkinForm">
            {% csrf_token %}
            
            <div class="info-section">
                <h6 class="info-section-title">基本信息</h6>
                <div class="info-grid">
                    <div class="info-item">
                        <label class="info-label info-label-required">客户</label>
                        <select name="client_id" id="clientSelect" class="form-select" required>
                            <option value="">请选择客户</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}" {% if client_id == client.id|stringformat:"s" %}selected{% endif %}>{{ client.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="info-item">
                        <label class="info-label">关联拜访计划</label>
                        <select name="visit_plan_id" id="visitPlanSelect" class="form-select">
                            <option value="">无</option>
                            {% for plan in visit_plans %}
                            <option value="{{ plan.id }}" {% if selected_plan and selected_plan.id == plan.id %}selected{% endif %} data-client-id="{{ plan.client_id }}">
                                {{ plan.client.name }} - {{ plan.plan_title }} ({{ plan.plan_date|date:"Y-m-d H:i" }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="info-item">
                        <label class="info-label info-label-required">签到地点</label>
                        <input type="text" name="checkin_location" class="form-control" required>
                    </div>
                    <div class="info-item">
                        <label class="info-label">备注</label>
                        <textarea name="notes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h6 class="info-section-title">位置信息（可选）</h6>
                <div class="info-grid">
                    <div class="info-item">
                        <label class="info-label">纬度</label>
                        <input type="number" name="latitude" class="form-control" step="any" placeholder="自动获取">
                    </div>
                    <div class="info-item">
                        <label class="info-label">经度</label>
                        <input type="number" name="longitude" class="form-control" step="any" placeholder="自动获取">
                    </div>
                </div>
                <div class="alert alert-info mt-2">
                    <i class="bi bi-info-circle"></i> 位置信息可通过浏览器定位功能自动获取
                </div>
            </div>
            
            <div class="d-flex justify-content-end gap-2 mt-4">
                <a href="{% url 'business_pages:visit_checkin' %}" class="btn btn-outline-secondary">取消</a>
                <button type="submit" class="btn btn-primary">保存签到</button>
            </div>
        </form>
    </div>
</div>

<script>
    // 自动获取位置信息
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            document.querySelector('input[name="latitude"]').value = position.coords.latitude.toFixed(7);
            document.querySelector('input[name="longitude"]').value = position.coords.longitude.toFixed(7);
        }, function(error) {
        });
    }
    
    // 当选择拜访计划时，自动填充客户
    document.getElementById('visitPlanSelect')?.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value && selectedOption.dataset.clientId) {
            document.getElementById('clientSelect').value = selectedOption.dataset.clientId;
        }
    });
    
    // 当选择客户时，过滤拜访计划
    document.getElementById('clientSelect')?.addEventListener('change', function() {
        const clientId = this.value;
        const planSelect = document.getElementById('visitPlanSelect');
        if (planSelect) {
            Array.from(planSelect.options).forEach(option => {
                if (option.value === '') {
                    option.style.display = '';
                } else if (option.dataset.clientId === clientId) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
        }
    });
</script>
{% endblock %}
