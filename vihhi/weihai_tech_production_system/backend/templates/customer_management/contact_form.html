{% extends "customer_management/base.html" %}

{% block title %}{{ page_title }} - 维海科技信息化管理平台{% endblock %}

{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<link rel="stylesheet" href="{% static 'css/qixinbao-autofill.css' %}">
<style>
    .career-form-item {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
        position: relative; /* 确保下拉框定位正确 */
        overflow: visible; /* 允许下拉框溢出显示 */
    }
    .career-form-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .career-form-item.deleted {
        opacity: 0.5;
        background-color: #e9ecef;
    }
    
    .info-section {
        margin-bottom: 2rem;
        overflow: visible; /* 允许下拉框溢出显示 */
    }
    
    .info-section-title {
        color: #2c3e50;
        font-weight: 600;
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #3498db;
    }
    
    .info-label {
        font-weight: 500;
        color: #34495e;
        margin-bottom: 0.5rem;
    }
    
    .info-label-required::after {
        content: ' *';
        color: #e74c3c;
    }
    
    .form-control:focus,
    .form-select:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }
    
    .btn-outline-primary {
        border-color: #3498db;
        color: #3498db;
    }
    
    .btn-outline-primary:hover {
        background-color: #3498db;
        border-color: #3498db;
        color: white;
    }
    
    .btn-outline-danger {
        border-color: #e74c3c;
        color: #e74c3c;
    }
    
    .btn-outline-danger:hover {
        background-color: #e74c3c;
        border-color: #e74c3c;
        color: white;
    }
    
    .form-check {
        padding-left: 1.5em;
    }
    
    .form-check-input {
        cursor: pointer;
    }
    
    .form-check-label {
        cursor: pointer;
        user-select: none;
    }
    
    .text-danger {
        font-size: 0.875rem;
    }
    
    small.text-muted {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .alert {
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    
    .info-card {
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }
    
    /* 学校搜索下拉框样式 */
    .school-search-input {
        margin-bottom: 0.5rem;
    }
    
    .school-search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        width: 100%;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        max-height: 300px;
        overflow-y: auto;
        z-index: 9999 !important; /* 提高z-index到最高，确保显示在最上层 */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-top: 2px;
        display: none; /* 默认隐藏 */
        min-width: 200px; /* 确保最小宽度 */
    }
    
    .school-search-dropdown.show,
    .school-search-dropdown[style*="display: block"] {
        display: block !important; /* 显示时强制显示 */
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* 确保父容器不会裁剪下拉框 */
    .position-relative {
        position: relative !important;
        overflow: visible !important;
    }
    
    .school-search-dropdown .school-group {
        padding: 0.5rem 0.75rem;
        font-weight: 600;
        background-color: #f8f9fa;
        color: #495057;
        border-bottom: 1px solid #dee2e6;
        font-size: 0.875rem;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .school-search-dropdown .school-item {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }
    
    .school-search-dropdown .school-item:hover,
    .school-search-dropdown .school-item.selected {
        background-color: #e7f3ff;
    }
    
    .school-search-dropdown .school-item .school-name {
        font-weight: 500;
        color: #212529;
    }
    
    /* 已移除985/211标签显示 */
    /* .school-search-dropdown .school-item .school-tags {
        font-size: 0.75rem;
        color: #6c757d;
        margin-left: 0.5rem;
    } */
    
    .school-select {
        display: none; /* 隐藏原始select，使用搜索框代替 */
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'business_pages:contact_list' %}">创建联系人信息</a></li>
<li class="breadcrumb-item active" aria-current="page">{% if contact %}编辑{% else %}创建{% endif %}</li>
{% endblock %}

{% block content %}
<div class="workspace-content">
    <div class="container-fluid py-4">
        <div class="info-card info-card-compact">
            <div class="info-card-header">
                <h5 class="info-card-title">{{ page_title }}</h5>
            </div>
            <div class="info-card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <strong>表单验证失败，请检查以下错误：</strong>
                        <ul class="mb-0">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                <li>{{ field }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <div class="info-section">
                        <h6 class="info-section-title">基本信息</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="info-label info-label-required">{{ form.client.label }}</label>
                                {{ form.client }}
                                {% if form.client.errors %}
                                <div class="text-danger small mt-1">{{ form.client.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="info-label info-label-required">{{ form.name.label }}</label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                <div class="text-danger small mt-1">{{ form.name.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="info-label info-label-required">{{ form.gender.label }}</label>
                                {{ form.gender }}
                                {% if form.gender.errors %}
                                <div class="text-danger small mt-1">{{ form.gender.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="info-grid info-grid-2">
                            <div class="info-item" style="grid-column: span 2;">
                                <label class="info-label info-label-required">{{ form.birthplace.label }}</label>
                                <input type="hidden" name="birthplace" id="birthplaceField" value="{% if contact %}{{ contact.birthplace|default:'' }}{% elif form.birthplace.value %}{{ form.birthplace.value }}{% else %}{% endif %}">
                                <div class="row g-2 mb-2">
                                    <div class="col-md-4">
                                        <select id="birthplaceProvinceSelect" class="form-select">
                                            <option value="">选择省份</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select id="birthplaceCitySelect" class="form-select">
                                            <option value="">选择城市</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select id="birthplaceDistrictSelect" class="form-select">
                                            <option value="">选择区县</option>
                                        </select>
                                    </div>
                                </div>
                                {% if form.birthplace.errors %}
                                <div class="text-danger small mt-1">{{ form.birthplace.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <div class="d-flex justify-content-between align-items-center info-section-title">
                            <h6 class="mb-0">职业信息</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="add-career-btn">
                                <i class="bi bi-plus-circle"></i> 添加职业信息
                            </button>
                        </div>
                        <div id="career-formset-container">
                            {{ career_formset.management_form }}
                            {% for form in career_formset %}
                            <div class="career-form-item border rounded p-3 mb-3" data-form-index="{{ forloop.counter0 }}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">职业信息 #{{ forloop.counter }}</h6>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-career-btn">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </div>
                                {% if form.DELETE %}
                                <div class="d-none">
                                    {{ form.DELETE }}
                                </div>
                                {% endif %}
                                <div class="info-grid info-grid-2">
                                    <div class="info-item">
                                        <label class="info-label info-label-required">{{ form.company.label }}</label>
                                        <div class="position-relative">
                                            {{ form.company }}
                                            <div id="companyDropdown_career_{{ forloop.counter0 }}" class="autocomplete-dropdown" style="display: none;"></div>
                                        </div>
                                        <small class="text-muted d-block mt-1">输入企业名称（至少2个字符）后自动搜索启信宝，选择匹配的企业将自动填充信息</small>
                                        {% if form.company.errors %}
                                        <div class="text-danger small mt-1">{{ form.company.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="info-item">
                                        <label class="info-label">{{ form.unified_credit_code.label }}</label>
                                        {{ form.unified_credit_code }}
                                        {% if form.unified_credit_code.errors %}
                                        <div class="text-danger small mt-1">{{ form.unified_credit_code.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="info-item">
                                        <label class="info-label info-label-required">{{ form.department.label }}</label>
                                        {{ form.department }}
                                        {% if form.department.errors %}
                                        <div class="text-danger small mt-1">{{ form.department.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="info-item">
                                        <label class="info-label info-label-required">{{ form.position.label }}</label>
                                        {{ form.position }}
                                        {% if form.position.errors %}
                                        <div class="text-danger small mt-1">{{ form.position.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="info-item">
                                        <label class="info-label info-label-required">{{ form.join_date.label }}</label>
                                        {{ form.join_date }}
                                        {% if form.join_date.errors %}
                                        <div class="text-danger small mt-1">{{ form.join_date.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="info-item">
                                        <label class="info-label">{{ form.leave_date.label }}</label>
                                        {{ form.leave_date }}
                                        {% if form.leave_date.errors %}
                                        <div class="text-danger small mt-1">{{ form.leave_date.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mt-3 pt-3 border-top">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0 small text-muted">同事关系人员</h6>
                                        <button type="button" class="btn btn-sm btn-outline-secondary add-colleague-btn" data-career-index="{{ forloop.counter0 }}">
                                            <i class="bi bi-plus-circle"></i> 添加同事
                                        </button>
                                    </div>
                                    <div class="colleague-formset-container" data-career-index="{{ forloop.counter0 }}">
                                        {% if form.instance.pk %}
                                            {% for colleague in form.instance.colleagues.all %}
                                            <div class="colleague-form-item border rounded p-2 mb-2" data-colleague-index="{{ forloop.counter0 }}">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <span class="small text-muted">同事 #{{ forloop.counter }}</span>
                                                    <button type="button" class="btn btn-sm btn-outline-danger btn-sm delete-colleague-btn">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                                <input type="hidden" name="careers-{{ forloop.parentloop.counter0 }}-colleagues-{{ forloop.counter0 }}-DELETE" class="colleague-delete-input">
                                                <div class="row g-2">
                                                    <div class="col-md-3">
                                                        <input type="text" name="careers-{{ forloop.parentloop.counter0 }}-colleagues-{{ forloop.counter0 }}-department" 
                                                               class="form-control form-control-sm" placeholder="部门" value="{{ colleague.department }}">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <input type="text" name="careers-{{ forloop.parentloop.counter0 }}-colleagues-{{ forloop.counter0 }}-name" 
                                                               class="form-control form-control-sm" placeholder="姓名 *" value="{{ colleague.name }}" required>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <input type="text" name="careers-{{ forloop.parentloop.counter0 }}-colleagues-{{ forloop.counter0 }}-position" 
                                                               class="form-control form-control-sm" placeholder="职位" value="{{ colleague.position }}">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <input type="text" name="careers-{{ forloop.parentloop.counter0 }}-colleagues-{{ forloop.counter0 }}-phone" 
                                                               class="form-control form-control-sm" placeholder="电话" value="{{ colleague.phone }}">
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <div class="d-flex justify-content-between align-items-center info-section-title">
                            <h6 class="mb-0">教育信息</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="add-education-btn">
                                <i class="bi bi-plus-circle"></i> 添加教育信息
                            </button>
                        </div>
                        <div id="education-formset-container">
                            {{ education_formset.management_form }}
                            {% for form in education_formset %}
                            <div class="career-form-item border rounded p-3 mb-3" data-form-index="{{ forloop.counter0 }}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">教育信息 #{{ forloop.counter }}</h6>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-education-btn">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </div>
                                {% if form.DELETE %}
                                <div class="d-none">
                                    {{ form.DELETE }}
                                </div>
                                {% endif %}
                                <div class="info-grid info-grid-3">
                                    <div class="info-item">
                                        <label class="info-label info-label-required">{{ form.degree.label }}</label>
                                        {{ form.degree }}
                                        {% if form.degree.errors %}
                                        <div class="text-danger small mt-1">{{ form.degree.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="info-item">
                                        <label class="info-label info-label-required">{{ form.school.label }}</label>
                                        <div class="position-relative">
                                            <input type="text" 
                                                   class="form-control school-search-input" 
                                                   id="school_search_{{ forloop.counter0 }}"
                                                   placeholder="输入毕业学校名称搜索..."
                                                   autocomplete="off"
                                                   data-form-index="{{ forloop.counter0 }}">
                                            <div class="school-search-dropdown" id="school_search_dropdown_{{ forloop.counter0 }}" style="display: none;"></div>
                                        </div>
                                        <div style="display: none;">
                                            {{ form.school }}
                                        </div>
                                        <div id="custom_school_input_{{ forloop.counter0 }}" style="display: none;" class="mt-2">
                                            {{ form.school_name }}
                                        </div>
                                        {% if form.school.errors %}
                                        <div class="text-danger small mt-1">{{ form.school.errors }}</div>
                                        {% endif %}
                                        {% if form.school_name.errors %}
                                        <div class="text-danger small mt-1">{{ form.school_name.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="info-item d-flex align-items-end">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="use_custom_school_{{ forloop.counter0 }}"data-change="handle_onchange_0">
                                            <label class="form-check-label" for="use_custom_school_{{ forloop.counter0 }}">
                                                毕业学校不在列表中，手动输入
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="info-grid info-grid-2 mt-3">
                                    <div class="info-item">
                                        <label class="info-label info-label-required">{{ form.enrollment_date.label }}</label>
                                        {{ form.enrollment_date }}
                                        {% if form.enrollment_date.errors %}
                                        <div class="text-danger small mt-1">{{ form.enrollment_date.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="info-item">
                                        <label class="info-label info-label-required">{{ form.graduation_date.label }}</label>
                                        {{ form.graduation_date }}
                                        {% if form.graduation_date.errors %}
                                        <div class="text-danger small mt-1">{{ form.graduation_date.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h6 class="info-section-title">联系方式</h6>
                        <div class="info-grid info-grid-2">
                            <div class="info-item">
                                <label class="info-label">{{ form.phone.label }}</label>
                                {{ form.phone }}
                                {% if form.phone.errors %}
                                <div class="text-danger small mt-1">{{ form.phone.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.email.label }}</label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                <div class="text-danger small mt-1">{{ form.email.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.wechat.label }}</label>
                                {{ form.wechat }}
                                <small class="text-muted d-block">可输入多个微信号，用逗号分隔</small>
                                {% if form.wechat.errors %}
                                <div class="text-danger small mt-1">{{ form.wechat.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="info-item" style="grid-column: span 2;">
                                <label class="info-label">{{ form.office_address.label }}</label>
                                <input type="hidden" name="office_address" id="officeAddressField" value="{% if contact %}{{ contact.office_address|default:'' }}{% elif form.office_address.value %}{{ form.office_address.value }}{% else %}{% endif %}">
                                <div class="row g-2 mb-2">
                                    <div class="col-md-4">
                                        <select id="officeProvinceSelect" class="form-select">
                                            <option value="">选择省份</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select id="officeCitySelect" class="form-select">
                                            <option value="">选择城市</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select id="officeDistrictSelect" class="form-select">
                                            <option value="">选择区县</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <input type="text" id="officeAddressDetailInput" class="form-control" 
                                               placeholder="街道、楼栋、门牌等详细地址" 
                                               value="">
                                        <small class="text-muted">完整地址会在保存前自动组合，选择客户后将自动填充</small>
                                    </div>
                                </div>
                                {% if form.office_address.errors %}
                                <div class="text-danger small mt-1">{{ form.office_address.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h6 class="info-section-title">角色与关系</h6>
                        <div class="info-grid info-grid-2">
                            <div class="info-item">
                                <label class="info-label info-label-required">{{ form.role.label }}</label>
                                {{ form.role }}
                                {% if form.role.errors %}
                                <div class="text-danger small mt-1">{{ form.role.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="info-item">
                                <label class="info-label info-label-required">{{ form.relationship_level.label }}</label>
                                {{ form.relationship_level }}
                                {% if form.relationship_level.errors %}
                                <div class="text-danger small mt-1">{{ form.relationship_level.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="info-item">
                                <label class="info-label info-label-required">{{ form.decision_influence.label }}</label>
                                {{ form.decision_influence }}
                                {% if form.decision_influence.errors %}
                                <div class="text-danger small mt-1">{{ form.decision_influence.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.is_primary.label }}</label>
                                <div class="form-check">
                                    {{ form.is_primary }}
                                    <label class="form-check-label" for="{{ form.is_primary.id_for_label }}">
                                        设为主要联系人
                                    </label>
                                </div>
                                {% if form.is_primary.errors %}
                                <div class="text-danger small mt-1">{{ form.is_primary.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h6 class="info-section-title">简历信息（可选）</h6>
                        <p class="text-muted small mb-3">上传简历可用于验证联系人信息的客观性，非必须项</p>
                        <div class="info-grid info-grid-2">
                            <div class="info-item">
                                <label class="info-label">{{ form.resume_file.label }}</label>
                                {{ form.resume_file }}
                                <small class="text-muted d-block mt-1">支持格式：PDF、Word、图片；大小限制：10MB</small>
                                {% if form.resume_file.errors %}
                                <div class="text-danger small mt-1">{{ form.resume_file.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.resume_source.label }}</label>
                                {{ form.resume_source }}
                                {% if form.resume_source.errors %}
                                <div class="text-danger small mt-1">{{ form.resume_source.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="submit" name="action" value="save_draft" class="btn btn-outline-secondary">保存草稿</button>
                        <button type="submit" name="action" value="submit" class="btn btn-primary">提交申请</button>
                        <a href="{% if contact %}{% url 'business_pages:contact_detail' contact.id %}{% else %}{% url 'business_pages:contact_list' %}{% endif %}" class="btn btn-secondary">取消</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/amap-district-selector.js' %}">
    // 安全的HTML设置函数
    function setSafeHTML(element, html) {
        if (!element) return;
        // 如果内容不包含HTML标签，使用textContent
        if (!/<[^>]+>/.test(html)) {
            element.textContent = html;
        } else {
            // 对于包含HTML的内容，使用innerHTML（假设内容已清理）
            // 在生产环境中，应该使用DOMPurify等库清理HTML
            element.innerHTML = html;
        }
    }
    
    // 安全的文本设置函数（推荐使用）
    function setSafeText(element, text) {
        if (element) {
            element.textContent = text;
        }
    }
</script>
<script src="{% static 'js/qixinbao-autofill.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 学校搜索API地址
    const SCHOOL_SEARCH_API = '/api/customer/schools/search/';
    
    // 从API搜索学校
    async function searchSchoolsFromAPI(keyword = '') {
        try {
            const url = SCHOOL_SEARCH_API + (keyword ? `?keyword=${encodeURIComponent(keyword)}&limit=100` : '?limit=100');
            
            // GET请求不需要CSRF token，但需要认证
            const response = await fetch(url, {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                }
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`搜索失败: ${response.status} ${errorText}`);
            }
            
            const data = await response.json();
            // console.log(...) // 已移除 // 调试用
            
            if (data.success && data.schools) {
                return data.schools.map(school => ({
                    id: school.id.toString(),
                    name: school.name,
                    region: school.region_display,
                    // 移除tags字段，不再使用985/211标签
                    fullText: school.name
                }));
            }
            
            return [];
        } catch (error) {
            // 显示错误提示
            return [];
        }
    }
    
    // 为单个表单初始化学校搜索功能
    async function initSchoolSearchForForm(formIndex) {
        const searchInput = document.querySelector(`.school-search-input[data-form-index="${formIndex}"]`);
        if (!searchInput) {
            return;
        }
        
        // 如果已经初始化过，跳过
        if (searchInput.dataset.initialized === 'true') {
            return;
        }
        
        const dropdown = document.getElementById('school_search_dropdown_' + formIndex);
        const select = document.querySelector(`[name="educations-${formIndex}-school"]`);
        
        if (!dropdown) {
            return;
        }
        if (!select) {
            return;
        }
        
        // 标记为已初始化
        searchInput.dataset.initialized = 'true';
        
        let selectedIndex = -1;
        let allSchools = [];
        let filteredSchools = [];
        
        // 渲染下拉列表
        function renderDropdown(schools) {
            console.log('下拉框当前样式:', {
                display: dropdown.style.display,
                visibility: dropdown.style.visibility,
                opacity: dropdown.style.opacity,
                zIndex: dropdown.style.zIndex
            });
            
            if (schools.length === 0) {
                // TODO: 使用DOMPurify清理HTML
            dropdown.innerHTML = '<div class="school-item" style="padding: 0.5rem 0.75rem; color: #6c757d;">未找到匹配的学校</div>';
                dropdown.style.display = 'block';
                dropdown.classList.add('show');
                return;
            }
            
            // 按地区分组
            const schoolsByRegion = {};
            schools.forEach(school => {
                const region = school.region || '其他';
                if (!schoolsByRegion[region]) {
                    schoolsByRegion[region] = [];
                }
                schoolsByRegion[region].push(school);
            });
            
            let html = '';
            Object.keys(schoolsByRegion).sort().forEach(region => {
                html += `<div class="school-group">${region}</div>`;
                schoolsByRegion[region].forEach(school => {
                    // 移除985、211标签显示
                    html += `<div class="school-item" data-school-id="${school.id}" data-school-name="${school.name}">
                        <span class="school-name">${school.name}</span>
                    </div>`;
                });
            });
            
            dropdown.innerHTML = html;
            
            // 使用fixed定位，避免被父容器裁剪
            const inputRect = searchInput.getBoundingClientRect();
            dropdown.style.position = 'fixed';
            dropdown.style.top = (inputRect.bottom + window.scrollY + 2) + 'px';
            dropdown.style.left = inputRect.left + 'px';
            dropdown.style.width = inputRect.width + 'px';
            dropdown.style.display = 'block';
            dropdown.style.visibility = 'visible';
            dropdown.style.opacity = '1';
            dropdown.style.zIndex = '9999';
            dropdown.classList.add('show'); // 添加show类确保显示
            console.log('下拉框位置信息:', {
                display: window.getComputedStyle(dropdown).display,
                visibility: window.getComputedStyle(dropdown).visibility,
                opacity: window.getComputedStyle(dropdown).opacity,
                zIndex: window.getComputedStyle(dropdown).zIndex,
                position: window.getComputedStyle(dropdown).position,
                rect: dropdown.getBoundingClientRect(),
                inputRect: inputRect
            });
            selectedIndex = -1;
            
            // 绑定点击事件
            dropdown.querySelectorAll('.school-item').forEach((item, index) => {
                item.addEventListener('click', function() {
                    const schoolId = this.getAttribute('data-school-id');
                    const schoolName = this.getAttribute('data-school-name');
                    select.value = schoolId;
                    searchInput.value = schoolName;
                    dropdown.style.display = 'none';
                    dropdown.classList.remove('show');
                    // 触发change事件
                    select.dispatchEvent(new Event('change'));
                });
                
                item.addEventListener('mouseenter', function() {
                    dropdown.querySelectorAll('.school-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedIndex = index;
                });
            });
        }
        
        // 从API搜索学校
        async function searchSchools(keyword = '') {
            // 显示加载状态
            // TODO: 使用DOMPurify清理HTML
            dropdown.innerHTML = '<div class="school-item" style="padding: 0.5rem 0.75rem; color: #6c757d;">搜索中...</div>';
            
            // 使用fixed定位，避免被父容器裁剪
            const inputRect = searchInput.getBoundingClientRect();
            dropdown.style.position = 'fixed';
            dropdown.style.top = (inputRect.bottom + window.scrollY + 2) + 'px';
            dropdown.style.left = inputRect.left + 'px';
            dropdown.style.width = inputRect.width + 'px';
            dropdown.style.display = 'block';
            dropdown.style.visibility = 'visible';
            dropdown.style.opacity = '1';
            dropdown.style.zIndex = '9999';
            dropdown.classList.add('show');
            // console.log(...) // 已移除);
            
            try {
                const schools = await searchSchoolsFromAPI(keyword);
                filteredSchools = schools;
                renderDropdown(schools);
            } catch (error) {
                // TODO: 使用DOMPurify清理HTML
            dropdown.innerHTML = '<div class="school-item" style="padding: 0.5rem 0.75rem; color: #e74c3c;">搜索失败，请稍后重试</div>';
                
                // 使用fixed定位
                const inputRect = searchInput.getBoundingClientRect();
                dropdown.style.position = 'fixed';
                dropdown.style.top = (inputRect.bottom + window.scrollY + 2) + 'px';
                dropdown.style.left = inputRect.left + 'px';
                dropdown.style.width = inputRect.width + 'px';
                dropdown.style.display = 'block';
                dropdown.style.visibility = 'visible';
                dropdown.style.opacity = '1';
                dropdown.style.zIndex = '9999';
                dropdown.classList.add('show');
            }
        }
        
        // 输入事件 - 使用更可靠的事件绑定
        let searchTimeout;
        const inputHandler = function(e) {
            clearTimeout(searchTimeout);
            const keyword = this.value.trim();
            
            if (keyword.length === 0) {
                // 如果清空了输入，隐藏下拉框
                dropdown.style.display = 'none';
                dropdown.classList.remove('show');
                return;
            }
            
            searchTimeout = setTimeout(() => {
                searchSchools(keyword);
            }, 300); // 增加延迟，减少API调用
        };
        
        // 移除旧的事件监听器（如果存在）
        searchInput.removeEventListener('input', inputHandler);
        // 添加新的事件监听器
        searchInput.addEventListener('input', inputHandler);
        
        // 聚焦事件
        searchInput.addEventListener('focus', async function() {
            const keyword = this.value.trim();
            if (keyword === '') {
                // 如果没有输入，加载所有学校（限制数量）
                await searchSchools('');
            } else {
                // 如果有输入，重新搜索
                await searchSchools(keyword);
            }
        });
        
        // 键盘导航
        searchInput.addEventListener('keydown', function(e) {
            const items = dropdown.querySelectorAll('.school-item:not([style*="display: none"])');
            if (items.length === 0) return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % items.length;
                items[selectedIndex].scrollIntoView({ block: 'nearest' });
                items.forEach((item, idx) => {
                    item.classList.toggle('selected', idx === selectedIndex);
                });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
                items[selectedIndex].scrollIntoView({ block: 'nearest' });
                items.forEach((item, idx) => {
                    item.classList.toggle('selected', idx === selectedIndex);
                });
            } else if (e.key === 'Enter' && selectedIndex >= 0 && items[selectedIndex]) {
                e.preventDefault();
                items[selectedIndex].click();
            } else if (e.key === 'Escape') {
                dropdown.style.display = 'none';
            }
        });
        
        // 点击外部关闭（使用事件委托，避免重复添加）
        const clickHandler = function(e) {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
                dropdown.style.visibility = 'hidden';
                dropdown.classList.remove('show');
            }
        };
        // 使用 once 选项，或者通过检查是否已绑定来避免重复
        if (!searchInput.dataset.clickHandlerBound) {
            document.addEventListener('click', clickHandler);
            searchInput.dataset.clickHandlerBound = 'true';
        }
        
        // 监听窗口滚动和大小变化，更新下拉框位置
        const updateDropdownPosition = function() {
            if (dropdown.style.display === 'block' || dropdown.classList.contains('show')) {
                const inputRect = searchInput.getBoundingClientRect();
                dropdown.style.position = 'fixed';
                dropdown.style.top = (inputRect.bottom + window.scrollY + 2) + 'px';
                dropdown.style.left = inputRect.left + 'px';
                dropdown.style.width = inputRect.width + 'px';
            }
        };
        
        window.addEventListener('scroll', updateDropdownPosition, true);
        window.addEventListener('resize', updateDropdownPosition);
        
        // 初始化：如果有选中的学校，从API获取学校名称
        if (select.value) {
            searchSchoolsFromAPI().then(schools => {
                const selectedSchool = schools.find(s => s.id === select.value);
                if (selectedSchool) {
                    searchInput.value = selectedSchool.name;
                }
            });
        }
    }
    
    // 初始化所有学校搜索功能
    async function initSchoolSearch() {
        // 为每个学校搜索框初始化
        const searchInputs = document.querySelectorAll('.school-search-input');
        
        if (searchInputs.length === 0) {
            // 延迟重试
            setTimeout(() => {
                initSchoolSearch();
            }, 500);
            return;
        }
        
        for (const searchInput of searchInputs) {
            const formIndex = searchInput.getAttribute('data-form-index');
            await initSchoolSearchForForm(formIndex);
        }
    }
    
    // 初始化学校搜索功能 - 已经在DOMContentLoaded中，直接调用
    // 使用setTimeout确保DOM完全渲染
    setTimeout(function() {
        initSchoolSearch();
    }, 100);
    
    // 初始化籍贯省市区选择器
    const birthplaceSelector = new AmapDistrictSelector({
        provinceSelectId: 'birthplaceProvinceSelect',
        citySelectId: 'birthplaceCitySelect',
        districtSelectId: 'birthplaceDistrictSelect',
        addressFieldId: 'birthplaceField',
        detailInputId: null,  // 不使用详细地址输入框
        apiBaseUrl: '/api/customer/districts/',
        autoUpdateAddress: true,
        enableLogging: false
    });
    birthplaceSelector.init();
    
    // 如果已有籍贯数据，尝试解析并填充到选择器
    const birthplaceField = document.getElementById('birthplaceField');
    if (birthplaceField && birthplaceField.value) {
        // 解析已有地址（格式：省 市 区/县 详细地址）
        const address = birthplaceField.value.trim();
        if (address) {
            // 简单的地址解析逻辑（可以根据实际情况调整）
            // 这里假设地址格式为：省 市 区/县 详细地址
            const parts = address.split(/\s+/);
            if (parts.length >= 3) {
                // 尝试匹配省份
                const provinceSelect = document.getElementById('birthplaceProvinceSelect');
                if (provinceSelect) {
                    // 等待省份列表加载完成后再设置
                    setTimeout(() => {
                        const provinceName = parts[0];
                        for (let i = 0; i < provinceSelect.options.length; i++) {
                            if (provinceSelect.options[i].textContent.includes(provinceName) || 
                                provinceSelect.options[i].dataset.name === provinceName) {
                                provinceSelect.value = provinceSelect.options[i].value;
                                provinceSelect.dispatchEvent(new Event('change'));
                                break;
                            }
                        }
                    }, 500);
                }
            }
        }
    }
    
    // 职业信息表单集管理
    const formsetContainer = document.getElementById('career-formset-container');
    const addBtn = document.getElementById('add-career-btn');
    
    if (!formsetContainer || !addBtn) {
        return; // 如果元素不存在，直接返回
    }
    
    const managementForm = formsetContainer.querySelector('[name$="-TOTAL_FORMS"]');
    if (!managementForm) {
        return; // 如果管理表单不存在，直接返回
    }
    
    let formCount = parseInt(managementForm.value) || 0;
    
    // 表单验证提示
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // 获取点击的按钮，判断是保存草稿还是提交
            const clickedButton = e.submitter || document.activeElement;
            const action = clickedButton ? clickedButton.value : 'submit';
            const isDraft = (action === 'save_draft');
            
            // 只有提交时才验证必填字段，保存草稿时不验证
            if (!isDraft) {
                // 检查必填字段
                const clientSelect = document.querySelector('[name="client"]');
                const nameInput = document.querySelector('[name="name"]');
                
                if (clientSelect && !clientSelect.value) {
                    e.preventDefault();
                    alert('请选择客户');
                    clientSelect.focus();
                    return false;
                }
                
                if (nameInput && !nameInput.value.trim()) {
                    e.preventDefault();
                    alert('请输入联系人姓名');
                    nameInput.focus();
                    return false;
                }
            }
            
            // 显示提交中提示
            if (clickedButton) {
                clickedButton.disabled = true;
                if (isDraft) {
                    // TODO: 使用DOMPurify清理HTML
            clickedButton.innerHTML = '<i class="bi bi-hourglass-split"></i> 保存中...';
                } else {
                    // TODO: 使用DOMPurify清理HTML
            clickedButton.innerHTML = '<i class="bi bi-hourglass-split"></i> 提交中...';
                }
            }
        });
    }
    
    // 文件上传提示
    const resumeFileInput = document.querySelector('input[name="resume_file"]');
    if (resumeFileInput) {
        resumeFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileSize = file.size / 1024 / 1024; // MB
                if (fileSize > 10) {
                    alert('文件大小不能超过10MB');
                    e.target.value = '';
                    return;
                }
                
                // 显示文件信息
                const fileInfo = document.createElement('small');
                fileInfo.className = 'text-success d-block mt-1';
                fileInfo.textContent = `已选择: ${file.name} (${fileSize.toFixed(2)} MB)`;
                
                // 删除之前的提示
                const oldInfo = e.target.parentElement.querySelector('.text-success');
                if (oldInfo) {
                    oldInfo.remove();
                }
                
                e.target.parentElement.appendChild(fileInfo);
            }
        });
    }
    
    // 添加新表单
    addBtn.addEventListener('click', function() {
        // 寻找一个可见的表单作为模板，如果没有则使用最后一个
        let template = null;
        const allForms = formsetContainer.querySelectorAll('.career-form-item');
        
        // 优先使用可见的表单作为模板
        for (let i = 0; i < allForms.length; i++) {
            if (allForms[i].style.display !== 'none') {
                template = allForms[i];
                break;
            }
        }
        
        // 如果所有表单都被隐藏，使用最后一个
        if (!template && allForms.length > 0) {
            template = allForms[allForms.length - 1];
        }
        
        if (!template) return;
        
        const newForm = template.cloneNode(true);
        const formIndex = formCount;
        const prefix = 'careers-';
        
        // 确保新表单是可见的
        newForm.style.display = 'block';
        newForm.classList.remove('deleted');
        
        // 更新表单索引 - 使用更精确的替换
        newForm.querySelectorAll('input, select, textarea').forEach(function(input) {
            if (input.name) {
                // 替换前缀后的数字，例如 careers-0-position -> careers-1-position
                input.name = input.name.replace(new RegExp('^' + prefix + '\\d+'), prefix + formIndex);
                if (input.id) {
                    input.id = input.id.replace(new RegExp('^id_' + prefix + '\\d+'), 'id_' + prefix + formIndex);
                }
            }
        });
        newForm.querySelectorAll('label').forEach(function(label) {
            const forAttr = label.getAttribute('for');
            if (forAttr) {
                label.setAttribute('for', forAttr.replace(new RegExp('^id_' + prefix + '\\d+'), 'id_' + prefix + formIndex));
            }
        });
        // 更新下拉框ID
        newForm.querySelectorAll('[id^="companyDropdown_career_"]').forEach(function(dropdown) {
            dropdown.id = `companyDropdown_career_${formIndex}`;
        });
        
        // 清空值
        newForm.querySelectorAll('input[type="text"], input[type="date"], input[type="number"], textarea, select').forEach(function(input) {
            if (input.type !== 'checkbox' && input.type !== 'hidden' && !input.name.includes('-DELETE')) {
                input.value = '';
            }
        });
        newForm.querySelectorAll('input[type="checkbox"]').forEach(function(input) {
            if (!input.name.includes('-DELETE')) {
                input.checked = false;
            }
        });
        
        // 移除删除标记
        const deleteCheckbox = newForm.querySelector('input[name$="-DELETE"]');
        if (deleteCheckbox) {
            deleteCheckbox.checked = false;
        }
        
        // 启用所有字段
        newForm.querySelectorAll('input, select, textarea').forEach(function(input) {
            input.disabled = false;
        });
        
        // 更新标题
        const title = newForm.querySelector('h6');
        if (title) {
            title.textContent = `职业信息 #${formCount + 1}`;
        }
        
        // 更新data-form-index
        newForm.setAttribute('data-form-index', formIndex);
        
        // 更新同事关系人员部分的索引
        const colleagueContainer = newForm.querySelector('.colleague-formset-container');
        if (colleagueContainer) {
            colleagueContainer.setAttribute('data-career-index', formIndex);
            const addColleagueBtn = newForm.querySelector('.add-colleague-btn');
            if (addColleagueBtn) {
                addColleagueBtn.setAttribute('data-career-index', formIndex);
            }
            // 清空同事关系人员列表（新表单不应该有同事）
            colleagueContainer.textContent = '';
        }
        
        formsetContainer.appendChild(newForm);
        formCount++;
        managementForm.value = formCount;
        
        // 为新添加的职业信息表单初始化启信宝自动填充
        setTimeout(function() {
            initCareerQixinbaoAutofill(formIndex);
        }, 100);
    });
    
    // 同事关系人员管理
    document.addEventListener('click', function(e) {
        // 添加同事关系人员
        if (e.target.closest('.add-colleague-btn')) {
            e.preventDefault();
            const addBtn = e.target.closest('.add-colleague-btn');
            const careerIndex = addBtn.getAttribute('data-career-index');
            const container = addBtn.closest('.career-form-item').querySelector('.colleague-formset-container');
            
            if (!container) return;
            
            // 获取当前同事数量
            const existingColleagues = container.querySelectorAll('.colleague-form-item');
            const colleagueIndex = existingColleagues.length;
            
            // 创建新的同事表单
            const colleagueForm = document.createElement('div');
            colleagueForm.className = 'colleague-form-item border rounded p-2 mb-2';
            colleagueForm.setAttribute('data-colleague-index', colleagueIndex);
            // TODO: 使用DOMPurify清理HTML
            colleagueForm.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="small text-muted">同事 #${colleagueIndex + 1}</span>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-sm delete-colleague-btn">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <input type="hidden" name="careers-${careerIndex}-colleagues-${colleagueIndex}-DELETE" class="colleague-delete-input">
                <div class="row g-2">
                    <div class="col-md-3">
                        <input type="text" name="careers-${careerIndex}-colleagues-${colleagueIndex}-department" 
                               class="form-control form-control-sm" placeholder="部门">
                    </div>
                    <div class="col-md-3">
                        <input type="text" name="careers-${careerIndex}-colleagues-${colleagueIndex}-name" 
                               class="form-control form-control-sm" placeholder="姓名 *" required>
                    </div>
                    <div class="col-md-3">
                        <input type="text" name="careers-${careerIndex}-colleagues-${colleagueIndex}-position" 
                               class="form-control form-control-sm" placeholder="职位">
                    </div>
                    <div class="col-md-3">
                        <input type="text" name="careers-${careerIndex}-colleagues-${colleagueIndex}-phone" 
                               class="form-control form-control-sm" placeholder="电话">
                    </div>
                </div>
            `;
            
            container.appendChild(colleagueForm);
        }
        
        // 删除同事关系人员
        if (e.target.closest('.delete-colleague-btn')) {
            e.preventDefault();
            const deleteBtn = e.target.closest('.delete-colleague-btn');
            const colleagueItem = deleteBtn.closest('.colleague-form-item');
            
            if (!colleagueItem) return;
            
            // 确认删除
            if (!confirm('确定要删除这个同事关系人员吗？')) {
                return;
            }
            
            // 标记为删除
            const deleteInput = colleagueItem.querySelector('.colleague-delete-input');
            if (deleteInput) {
                deleteInput.value = 'on';
            }
            
            // 隐藏表单项
            colleagueItem.style.display = 'none';
        }
    });
    
    // 处理删除按钮
    formsetContainer.addEventListener('click', function(e) {
        if (e.target.closest('.delete-career-btn')) {
            e.preventDefault();
            const deleteBtn = e.target.closest('.delete-career-btn');
            const formItem = deleteBtn.closest('.career-form-item');
            if (!formItem) return;
            
            // 检查是否至少保留一项（统计未删除的表单数量）
            const allCareerForms = formsetContainer.querySelectorAll('.career-form-item');
            let visibleCount = 0;
            allCareerForms.forEach(function(form) {
                const deleteCheckbox = form.querySelector('input[name$="-DELETE"]');
                if (form.style.display !== 'none' && (!deleteCheckbox || !deleteCheckbox.checked)) {
                    visibleCount++;
                }
            });
            
            // 如果只剩一项，不允许删除
            if (visibleCount <= 1) {
                alert('职业信息至少需要保留一项，不能全部删除！');
                return;
            }
            
            // 确认删除
            if (!confirm('确定要删除这条职业信息吗？')) {
                return;
            }
            
            // 查找隐藏的DELETE复选框并勾选
            const deleteCheckbox = formItem.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
            }
            
            // 隐藏卡片
            formItem.style.display = 'none';
        }
    });
    
    // 教育信息表单集管理
    const educationFormsetContainer = document.getElementById('education-formset-container');
    const addEducationBtn = document.getElementById('add-education-btn');
    
    if (educationFormsetContainer && addEducationBtn) {
        const educationManagementForm = educationFormsetContainer.querySelector('[name$="-TOTAL_FORMS"]');
        if (educationManagementForm) {
            let educationFormCount = parseInt(educationManagementForm.value) || 0;
            
            // 添加新教育信息表单
            addEducationBtn.addEventListener('click', function() {
                let template = null;
                const allEducationForms = educationFormsetContainer.querySelectorAll('.career-form-item[data-form-index]');
                
                // 优先使用可见的表单作为模板
                for (let i = 0; i < allEducationForms.length; i++) {
                    if (allEducationForms[i].style.display !== 'none') {
                        template = allEducationForms[i];
                        break;
                    }
                }
                
                if (!template && allEducationForms.length > 0) {
                    template = allEducationForms[allEducationForms.length - 1];
                }
                
                if (!template) return;
                
                const newForm = template.cloneNode(true);
                const formIndex = educationFormCount;
                const prefix = 'educations-';
                
                // 确保新表单是可见的
                newForm.style.display = 'block';
                newForm.classList.remove('deleted');
                
                // 更新表单索引
                newForm.querySelectorAll('input, select, textarea').forEach(function(input) {
                    if (input.name) {
                        input.name = input.name.replace(new RegExp('^' + prefix + '\\d+'), prefix + formIndex);
                        if (input.id) {
                            input.id = input.id.replace(new RegExp('^id_' + prefix + '\\d+'), 'id_' + prefix + formIndex);
                        }
                    }
                });
                newForm.querySelectorAll('label').forEach(function(label) {
                    const forAttr = label.getAttribute('for');
                    if (forAttr) {
                        label.setAttribute('for', forAttr.replace(new RegExp('^id_' + prefix + '\\d+'), 'id_' + prefix + formIndex));
                    }
                });
                
                // 清空值
                newForm.querySelectorAll('input[type="text"], input[type="date"], input[type="number"], textarea, select').forEach(function(input) {
                    if (input.type !== 'checkbox' && input.type !== 'hidden' && !input.name.includes('-DELETE')) {
                        input.value = '';
                    }
                });
                newForm.querySelectorAll('input[type="checkbox"]').forEach(function(input) {
                    if (!input.name.includes('-DELETE')) {
                        input.checked = false;
                    }
                });
                
                // 移除删除标记
                const deleteCheckbox = newForm.querySelector('input[name$="-DELETE"]');
                if (deleteCheckbox) {
                    deleteCheckbox.checked = false;
                }
                
                // 启用所有字段
                newForm.querySelectorAll('input, select, textarea').forEach(function(input) {
                    input.disabled = false;
                });
                
                // 更新标题
                const title = newForm.querySelector('h6');
                if (title) {
                    title.textContent = `教育信息 #${educationFormCount + 1}`;
                }
                
                // 更新data-form-index
                newForm.setAttribute('data-form-index', formIndex);
                
                // 更新搜索输入框的 data-form-index 和 id
                const searchInput = newForm.querySelector('.school-search-input');
                if (searchInput) {
                    searchInput.setAttribute('data-form-index', formIndex);
                    searchInput.id = 'school_search_' + formIndex;
                    // 清除初始化标记，允许重新初始化
                    searchInput.removeAttribute('data-initialized');
                    searchInput.removeAttribute('data-click-handler-bound');
                }
                
                // 更新下拉框的 id
                const dropdown = newForm.querySelector('.school-search-dropdown');
                if (dropdown) {
                    dropdown.id = 'school_search_dropdown_' + formIndex;
                }
                
                // 更新手动输入相关的 id
                const customCheckbox = newForm.querySelector('#use_custom_school_' + template.getAttribute('data-form-index'));
                if (customCheckbox) {
                    const oldIndex = template.getAttribute('data-form-index');
                    customCheckbox.id = 'use_custom_school_' + formIndex;
                    customCheckbox.setAttribute('onchange', `toggleCustomSchool(${formIndex}, this.checked)`);
                    const label = newForm.querySelector(`label[for="use_custom_school_${oldIndex}"]`);
                    if (label) {
                        label.setAttribute('for', 'use_custom_school_' + formIndex);
                    }
                }
                
                const customInputDiv = newForm.querySelector(`#custom_school_input_${template.getAttribute('data-form-index')}`);
                if (customInputDiv) {
                    customInputDiv.id = 'custom_school_input_' + formIndex;
                }
                
                educationFormsetContainer.appendChild(newForm);
                educationFormCount++;
                educationManagementForm.value = educationFormCount;
                
                // 重新初始化学校搜索功能（只针对新添加的表单）
                initSchoolSearchForForm(formIndex);
            });
            
            // 处理删除按钮
            educationFormsetContainer.addEventListener('click', function(e) {
                if (e.target.closest('.delete-education-btn')) {
                    e.preventDefault();
                    const deleteBtn = e.target.closest('.delete-education-btn');
                    const formItem = deleteBtn.closest('.career-form-item');
                    if (!formItem) return;
                    
                    // 检查是否至少保留一项（统计未删除的表单数量）
                    const allEducationForms = educationFormsetContainer.querySelectorAll('.career-form-item');
                    let visibleCount = 0;
                    allEducationForms.forEach(function(form) {
                        const deleteCheckbox = form.querySelector('input[name$="-DELETE"]');
                        if (form.style.display !== 'none' && (!deleteCheckbox || !deleteCheckbox.checked)) {
                            visibleCount++;
                        }
                    });
                    
                    // 如果只剩一项，不允许删除
                    if (visibleCount <= 1) {
                        alert('教育信息至少需要保留一项，不能全部删除！');
                        return;
                    }
                    
                    // 确认删除
                    if (!confirm('确定要删除这条教育信息吗？')) {
                        return;
                    }
                    
                    // 查找隐藏的DELETE复选框并勾选
                    const deleteCheckbox = formItem.querySelector('input[name$="-DELETE"]');
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                    }
                    
                    // 隐藏卡片
                    formItem.style.display = 'none';
                }
            });
        }
    }
    
    // 切换自定义学校输入框
    window.toggleCustomSchool = function(formIndex, show) {
        const customInput = document.getElementById('custom_school_input_' + formIndex);
        const schoolSelect = document.querySelector(`[name="educations-${formIndex}-school"]`);
        
        if (customInput && schoolSelect) {
            if (show) {
                customInput.style.display = 'block';
                schoolSelect.value = '';  // 清空选择
                schoolSelect.disabled = true;
                schoolSelect.style.opacity = '0.5';
                // 显示手动输入框并聚焦
                const customSchoolInput = customInput.querySelector('input[name*="-school_name"]');
                if (customSchoolInput) {
                    customSchoolInput.style.display = 'block';
                    setTimeout(() => customSchoolInput.focus(), 100);
                }
            } else {
                customInput.style.display = 'none';
                schoolSelect.disabled = false;
                schoolSelect.style.opacity = '1';
                const customSchoolInput = customInput.querySelector('input[name*="-school_name"]');
                if (customSchoolInput) {
                    customSchoolInput.value = '';
                    customSchoolInput.style.display = 'none';
                }
            }
        }
    }
    
    // 初始化：如果已有手动输入的学校名称，显示输入框
    document.querySelectorAll('[name*="-school_name"]').forEach(function(input) {
        if (input.value && input.value.trim()) {
            const nameMatch = input.name.match(/educations-(\d+)-school_name/);
            if (nameMatch) {
                const formIndex = nameMatch[1];
                const checkbox = document.getElementById('use_custom_school_' + formIndex);
                if (checkbox) {
                    checkbox.checked = true;
                    toggleCustomSchool(formIndex, true);
                }
            }
        }
    });
    
    // 如果选择了学校，自动取消手动输入模式
    document.querySelectorAll('[name*="-school"]').forEach(function(select) {
        if (select.tagName === 'SELECT') {
            select.addEventListener('change', function() {
                if (this.value) {
                    const nameMatch = this.name.match(/educations-(\d+)-school/);
                    if (nameMatch) {
                        const formIndex = nameMatch[1];
                        const checkbox = document.getElementById('use_custom_school_' + formIndex);
                        if (checkbox && checkbox.checked) {
                            checkbox.checked = false;
                            toggleCustomSchool(formIndex, false);
                        }
                    }
                }
            });
        }
    });
    
    // 初始化办公地址选择器
    const officeAddressSelector = new AmapDistrictSelector({
        provinceSelectId: 'officeProvinceSelect',
        citySelectId: 'officeCitySelect',
        districtSelectId: 'officeDistrictSelect',
        addressFieldId: 'officeAddressField',
        detailInputId: 'officeAddressDetailInput',
        apiBaseUrl: '/api/customer/districts/',
        autoUpdateAddress: true,
        enableLogging: false
    });
    officeAddressSelector.init();
    
    // 自动导入客户信息（就职公司、统一信用代码、办公地址）
    function autoFillClientInfo(clientId) {
        if (!clientId) {
            return;
        }
        
        // 使用URLSearchParams确保参数正确编码
        const params = new URLSearchParams();
        params.append('client_id', clientId);
        // 确保使用完整的API路径，避免路径被截断
        // 使用字符串拼接而不是模板字符串，避免可能的截断问题
        const apiUrl = '/api/customer/clients/info/?' + params.toString();
        // console.log(...) // 已移除);
        
        // 获取客户完整信息
        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            },
            credentials: 'same-origin'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.data) {
                    const clientInfo = data.data;
                    
                    // 延迟一下，确保表单已经渲染完成
                    setTimeout(function() {
                        // 1. 填充职业信息1的就职公司
                        const careerCompanyInput = document.querySelector('[name="careers-0-company"]');
                        
                        if (careerCompanyInput) {
                            const currentValue = careerCompanyInput.value || '';
                            // console.log(...) // 已移除);
                            
                            if (!currentValue.trim() && clientInfo.name) {
                                careerCompanyInput.value = clientInfo.name;
                                // 触发input和change事件，以便启信宝组件能识别
                                careerCompanyInput.dispatchEvent(new Event('input', { bubbles: true }));
                                careerCompanyInput.dispatchEvent(new Event('change', { bubbles: true }));
                                // 也触发focus和blur事件
                                careerCompanyInput.focus();
                                careerCompanyInput.blur();
                            } else {
                            }
                        } else {
                            // 尝试查找所有职业信息字段
                            const allCompanyInputs = document.querySelectorAll('[name*="careers-"][name*="-company"]');
                        }
                        
                        // 2. 填充职业信息1的社会统一信用代码
                        const careerCreditCodeInput = document.querySelector('[name="careers-0-unified_credit_code"]');
                        
                        if (careerCreditCodeInput) {
                            const currentValue = careerCreditCodeInput.value || '';
                            // console.log(...) // 已移除);
                            
                            if (!currentValue.trim() && clientInfo.unified_credit_code) {
                                careerCreditCodeInput.value = clientInfo.unified_credit_code;
                                careerCreditCodeInput.dispatchEvent(new Event('input', { bubbles: true }));
                                careerCreditCodeInput.dispatchEvent(new Event('change', { bubbles: true }));
                            } else {
                            }
                        } else {
                        }
                        
                        // 3. 填充联系方式中的办公地址（只有当办公地址为空时才自动填充）
                        const officeAddressField = document.getElementById('officeAddressField');
                        
                        if (officeAddressField) {
                            const currentValue = officeAddressField.value || '';
                            // console.log(...) // 已移除);
                            
                            if (!currentValue.trim() && clientInfo.address) {
                                // 使用地址选择器的setAddress方法，会自动解析地址
                                if (typeof officeAddressSelector !== 'undefined' && officeAddressSelector) {
                                    officeAddressSelector.setAddress(clientInfo.address);
                                } else {
                                    // 如果地址选择器还未初始化，直接设置隐藏字段的值
                                    officeAddressField.value = clientInfo.address;
                                }
                            } else {
                            }
                        } else {
                        }
                    }, 100); // 延迟100ms，确保表单已渲染
                } else {
                }
            })
            .catch(error => {
            });
    }
    
    // 绑定客户选择事件
    const clientSelect = document.querySelector('[name="client"]');
    
    if (clientSelect) {
        clientSelect.addEventListener('change', function() {
            const clientId = this.value;
            autoFillClientInfo(clientId);
        });
        
        // 如果页面加载时已经有选中的客户，也自动填充
        if (clientSelect.value) {
            setTimeout(function() {
                autoFillClientInfo(clientSelect.value);
            }, 500); // 延迟500ms，确保所有组件都已初始化
        }
    } else {
    }
    
    // 初始化职业信息的启信宝自动填充功能
    function initCareerQixinbaoAutofill(formIndex) {
        const companyInput = document.querySelector(`[name="careers-${formIndex}-company"]`);
        const creditCodeInput = document.querySelector(`[name="careers-${formIndex}-unified_credit_code"]`);
        const dropdown = document.getElementById(`companyDropdown_career_${formIndex}`);
        
        if (!companyInput || !creditCodeInput || !dropdown) {
            return null;
        }
        
        // 检查是否加载了QixinbaoAutofill类
        if (typeof QixinbaoAutofill === 'undefined') {
            return null;
        }
        
        // 初始化启信宝自动填充组件（只填充公司名称和统一信用代码）
        const qixinbaoAutofill = new QixinbaoAutofill({
            // 输入框选择器
            nameInputSelector: `[name="careers-${formIndex}-company"]`,
            creditCodeInputSelector: `[name="careers-${formIndex}-unified_credit_code"]`,
            
            // 下拉框ID
            dropdownId: `companyDropdown_career_${formIndex}`,
            
            // API端点
            searchApiUrl: '/api/customer/search-company/',
            detailApiUrl: '/api/customer/get-company-detail/',
            
            // 其他字段选择器（不填充，只填充公司名称和统一信用代码）
            fieldSelectors: {},
            
            // 功能开关
            autoFillDetails: false,  // 不自动填充详细信息
            autoQueryExecution: false,  // 不查询被执行信息
            showSuccessAlert: false,  // 不显示成功提示
            
            // 调试模式
            debug: false
        });
        
        // 初始化组件
        if (qixinbaoAutofill.init()) {
            return qixinbaoAutofill;
        } else {
            return null;
        }
    }
    
    // 为所有现有的职业信息表单初始化启信宝自动填充
    document.querySelectorAll('.career-form-item').forEach(function(formItem) {
        const formIndex = formItem.getAttribute('data-form-index');
        if (formIndex !== null && formItem.style.display !== 'none') {
            initCareerQixinbaoAutofill(parseInt(formIndex));
        }
    });
});

    // 事件处理器: handle_onchange_0
    document.addEventListener('DOMContentLoaded', function() {
        const element = document.querySelector('#use_custom_school_{{ forloop.counter0 }}');
        if (element) {
            element.addEventListener('change', function(e) {
                toggleCustomSchool({{ forloop.counter0 }}, this.checked)
            });
        }
    });

</script>
{% endblock %}
