{% extends "shared/module_base.html" %}

{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
{% endblock %}

{% block pm_title %}图纸评估{% endblock %}

{% block pm_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="bi bi-clipboard-check me-2"></i>图纸评估
        </h2>
    </div>

    <form method="post" id="drawingEvaluationForm">
        {% csrf_token %}

        <div class="info-card info-card-fade-in">
        <div class="info-card-header">
                <h5 class="info-card-title">基本信息</h5>
            </div>
            <div class="info-card-body">
                <div class="info-grid info-grid-2">
                    <div class="info-item">
                        <label class="info-label info-label-required">关联商机</label>
                        <select name="opportunity_id" class="form-select" required>
                            <option value="">请选择商机</option>
                            {% for opp in opportunities %}
                            <option value="{{ opp.id }}">{{ opp.name }} ({{ opp.opportunity_number|default:'未编号' }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="info-item">
                        <label class="info-label info-label-required">评估日期</label>
                        <input type="date" name="evaluation_date" class="form-control" required>
                    </div>
                    <div class="info-item">
                        <label class="info-label info-label-required">评估人</label>
                        <input type="text" name="evaluator" class="form-control"
                               value="{{ user.get_full_name|default:user.username }}" required maxlength="50">
                    </div>
                    <div class="info-item">
                        <label class="info-label">图纸版本</label>
                        <input type="text" name="drawing_version" class="form-control"
                               placeholder="如：V1.0、方案版等" maxlength="50">
                    </div>
                </div>
            </div>
        </div>

        <div class="info-card info-card-fade-in">
            <div class="info-card-header">
                <h5 class="info-card-title">各专业成本节省评估</h5>
        </div>
        <div class="info-card-body">
                <div class="info-grid info-grid-2">
                    {% for profession in service_professions %}
                    <div class="info-item">
                        <label class="info-label">{{ profession.name }}专业节省金额（元）</label>
                        <input type="number" name="saving_{{ profession.code }}"
                               class="form-control saving-amount"
                               step="0.01" min="0" placeholder="0.00"
                               data-profession-code="{{ profession.code }}"
                               data-profession-name="{{ profession.name }}">
                    </div>
                    {% empty %}
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 暂无服务专业数据，请先在后台配置服务专业。
                        </div>
                    </div>
                    {% endfor %}
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <label class="info-label">总节省金额（元）</label>
                        <input type="text" id="total_saving" class="form-control"
                               value="0.00" readonly
                               style="background-color: #f8f9fa; color: #6c757d; font-weight: bold; font-size: 1.1em;">
                        <small class="text-muted">自动计算：各专业节省金额之和</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-card info-card-fade-in">
            <div class="info-card-header">
                <h5 class="info-card-title">评估说明</h5>
            </div>
            <div class="info-card-body">
                <div class="info-grid info-grid-1">
                    <div class="info-item">
                        <label class="info-label">节省成本说明</label>
                        <textarea name="saving_explanation" class="form-control" rows="4"
                                  placeholder="请说明各专业节省成本的具体原因和依据（可选）"></textarea>
                    </div>
                    <div class="info-item">
                        <label class="info-label">备注</label>
                        <textarea name="notes" class="form-control" rows="3"
                                  placeholder="其他备注信息（可选）"></textarea>
            </div>
        </div>
    </div>
</div>

        <script>
        // 自动计算总节省金额
        document.addEventListener('DOMContentLoaded', function() {
            const savingInputs = document.querySelectorAll('.saving-amount');
            const totalSavingInput = document.getElementById('total_saving');

            function calculateTotal() {
                let total = 0;
                savingInputs.forEach(input => {
                    const value = parseFloat(input.value) || 0;
                    total += value;
                });
                totalSavingInput.value = total.toFixed(2);
            }

            savingInputs.forEach(input => {
                input.addEventListener('input', calculateTotal);
            });

            // 初始计算
            calculateTotal();
        });
        </script>

        <div class="d-flex justify-content-end gap-2 mt-4">
            <a href="{% url 'opportunity_pages:opportunity_management' %}" class="btn btn-outline-secondary">取消</a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle"></i> 提交评估
            </button>
        </div>
    </form>

    <style>
        .form-control,
        .form-select,
        textarea.form-control {
            color: #16A34A;
        }
        .form-control:focus,
        .form-select:focus,
        textarea.form-control:focus {
            border-color: #16A34A;
            box-shadow: 0 0 0 0.2rem rgba(22, 163, 74, 0.25);
        }
    </style>
{% endblock %}
