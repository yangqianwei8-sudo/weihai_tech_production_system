{% extends "customer_management/base.html" %}
{% load static %}

{% block title %}{{ page_title }} - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
    .form-section {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
    }
    .form-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f3f4f6;
    }
    .form-section-header h5 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: block;
    }
    .required-field::after {
        content: " *";
        color: #ef4444;
    }
    .party-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .party-item-header {
    

        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block contract_content %}
<div class="container-fluid py-4">
    <div class="center-hero mb-4">
        <div style="position: relative; z-index: 1;">
            <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 8px 0;">{{ page_title }}</h1>
            <p style="font-size: 14px; opacity: 0.9; margin: 0;">{{ page_description }}</p>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="contract-form">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
        <div class="alert alert-danger">
        {% endif %}
            {{ form.non_field_errors }}
        </div>
        
        <!-- åˆåŒè¯†åˆ«åŠŸèƒ½ -->
        <div class="form-section" style="background: #f0f9ff; border: 1px solid #0ea5e9; margin-bottom: 24px;">
            <div class="form-section-header">
                <h5>ğŸ¤– AIåˆåŒè¯†åˆ«</h5>
            </div>
            <div class="alert alert-info" style="margin-bottom: 16px; font-size: 13px;">
                <i class="bi bi-info-circle"></i> ä¸Šä¼ åˆåŒæ–‡ä»¶ï¼ˆPDFã€å›¾ç‰‡ï¼‰ï¼ŒAIå°†è‡ªåŠ¨è¯†åˆ«å¹¶å¡«å……è¡¨å•ä¿¡æ¯
            </div>
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label class="form-label">ä¸Šä¼ åˆåŒæ–‡ä»¶</label>
                        <input type="file" id="contract-file-input" class="form-control"
                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                               style="padding: 8px;">
                        <small class="form-text text-muted">æ”¯æŒæ ¼å¼ï¼šPDFã€JPGã€PNGã€DOCã€DOCXï¼Œæœ€å¤§10MB</small>
                    </div>
                </div>
                <div class="col-md-4" style="display: flex; align-items: flex-end;">
                    <button type="button" id="recognize-contract-btn" class="btn btn-primary" style="width: 100%;">
                        <i class="bi bi-magic"></i> å¼€å§‹è¯†åˆ«
                    </button>
                </div>
            </div>
            <div id="recognition-status" style="display: none; margin-top: 12px;">
                <div class="alert alert-warning">
                    <i class="bi bi-hourglass-split"></i> <span id="recognition-message">æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</span>
                </div>
            </div>
            <div id="recognition-result" style="display: none; margin-top: 12px;">
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> è¯†åˆ«å®Œæˆï¼å·²è‡ªåŠ¨å¡«å……è¡¨å•ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥å¹¶ç¡®è®¤ã€‚
                </div>
            </div>
        </div>
        
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ğŸ“„ åŸºæœ¬ä¿¡æ¯</h5>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label required-field" for="{{ form.project_number.id_for_label }}">{{ form.project_number.label }}</label>
                        {{ form.project_number }}
                        {% if form.project_number.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.project_number.errors }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label required-field" for="{{ form.project_name.id_for_label }}">{{ form.project_name.label }}</label>
                        {{ form.project_name }}
                        {% if form.project_name.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.project_name.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.responsible_department.id_for_label }}">{{ form.responsible_department.label }}</label>
                        {{ form.responsible_department }}
                        {% if form.responsible_department.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.responsible_department.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.responsible_person.id_for_label }}">{{ form.responsible_person.label }}</label>
                        {{ form.responsible_person }}
                        {% if form.responsible_person.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.responsible_person.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åˆåŒä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ğŸ“‹ åˆåŒä¿¡æ¯</h5>
            </div>
            <!-- å®¢æˆ· -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label required-field" for="{{ form.client.id_for_label }}">{{ form.client.label }}</label>
                        {{ form.client }}
                        {% if form.client.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.client.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <!-- å…³è”å•†æœº -->
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label required-field" for="{{ form.opportunity.id_for_label }}">{{ form.opportunity.label }}</label>
                        {{ form.opportunity }}
                        {% if form.opportunity.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.opportunity.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- åˆåŒåç§° -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label required-field" for="{{ form.contract_name.id_for_label }}">{{ form.contract_name.label }}</label>
                        {{ form.contract_name }}
                        {% if form.contract_name.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_name.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <!-- åˆåŒç±»å‹ -->
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.contract_type.id_for_label }}">{{ form.contract_type.label }}</label>
                        {{ form.contract_type }}
                        {% if form.contract_type.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_type.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- ä¸»åˆåŒï¼ˆæ¡ä»¶æ˜¾ç¤ºï¼šåªæœ‰é€‰æ‹©è¡¥å……åè®®ã€å˜æ›´åè®®æˆ–ç»ˆæ­¢åè®®æ—¶æ‰æ˜¾ç¤ºï¼‰ -->
            <div class="row" id="parent-contract-row" style="display: none;">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.parent_contract.id_for_label }}">{{ form.parent_contract.label }}</label>
                        {{ form.parent_contract }}
                        {% if form.parent_contract.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.parent_contract.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- åˆåŒæè¿° -->
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <input type="text" id="contract_price" name="contract_price" class="form-control"
                               value="" readonly style="background-color: #f5f5f5; cursor: not-allowed;"
                               placeholder="æ ¹æ®ç»“ç®—æ–¹å¼è‡ªåŠ¨è®¡ç®—">
                        <small class="form-text text-muted">æ ¹æ®ç»“ç®—æ–¹å¼è‡ªåŠ¨è®¡ç®—ï¼Œä¸å¯æ‰‹åŠ¨ä¿®æ”¹</small>
                    </div>
                </div>
            </div>
            <!-- åˆåŒçŠ¶æ€ï¼ˆéšè—å­—æ®µï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨åˆ¤æ–­ï¼‰ -->
            {{ form.status }}
        </div>
        
        <!-- ç­¾çº¦ä¸»ä½“ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ğŸ‘¥ ç­¾çº¦ä¸»ä½“</h5>
            </div>
            <div class="table-responsive" style="margin-top: 16px;">
                <table class="table table-bordered table-hover" id="parties-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">åºå·</th>
                            <th style="width: 100px;">å•ä½ç±»å‹ <span class="text-danger">*</span></th>
                            <th style="width: 180px;">å•ä½åç§° <span class="text-danger">*</span></th>
                            <th style="width: 150px;">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </th>
                            <th style="width: 120px;">æ³•å®šä»£è¡¨äºº</th>
                            <th style="width: 120px;">é¡¹ç›®è´Ÿè´£äºº</th>
                            <th style="width: 120px;">è”ç³»ç”µè¯</th>
                            <th style="width: 150px;">è”ç³»é‚®ç®±</th>
                            <th style="width: 200px;">åŠå…¬åœ°å€</th>
                            <th style="width: 80px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="parties-container">
                        <!-- ç­¾çº¦ä¸»ä½“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </tbody>
                </table>
            </div>
        </div>

        </div>

        <!-- æœåŠ¡å†…å®¹ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ğŸ”§ æœåŠ¡å†…å®¹</h5>
            </div>
            <div class="table-responsive" style="margin-top: 16px;">
                <table class="table table-bordered table-hover" id="service-contents-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px;">åºå·</th>
                            <th style="width: 150px;">æœåŠ¡ç±»å‹ <span class="text-danger">*</span></th>
                            <th style="width: 120px;">å›¾çº¸é˜¶æ®µ</th>
                            <th style="width: 120px;">é¡¹ç›®ä¸šæ€</th>
                            <th style="width: 200px;">æœåŠ¡ä¸“ä¸š</th>
                            <th style="width: 80px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="service-contents-container">
                        <!-- æœåŠ¡å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </tbody>
                </table>
                            
                <div style="margin-top: 16px; text-align: left;">
                </div>
            </div>
        </div>


        <!-- å›æ¬¾ä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ğŸ’µ å›æ¬¾ä¿¡æ¯</h5>
            </div>
            <div class="table-responsive" style="margin-top: 16px;">
                <table class="table table-bordered table-hover" id="payment-info-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">åºå·</th>
                            <th style="width: 150px;">è§¦å‘èŠ‚ç‚¹ <span class="text-danger">*</span></th>
                            <th style="width: 150px;">è®¡ç®—åŸºç¡€ <span class="text-danger">*</span></th>
                            <th style="width: 120px;">å›æ¬¾æ¯”ä¾‹ï¼ˆ%ï¼‰</th>
                            <th style="width: 150px;">å›æ¬¾é‡‘é¢ï¼ˆå…ƒï¼‰</th>
                            <th style="width: 80px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="payment-info-container">
                        <!-- å›æ¬¾ä¿¡æ¯åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </tbody>
                </table>
                <div style="margin-top: 16px; text-align: left;">
                    <button type="button" class="btn btn-sm btn-primary" id="add-payment-info-btn">
                        <i class="bi bi-plus-circle"></i> æ·»åŠ å›æ¬¾ä¿¡æ¯
                    </button>
                </div>
            </div>
        </div>
        <!-- æäº¤æŒ‰é’® -->
        <div class="form-group" style="margin-top: 32px;">
            <button type="submit" class="btn btn-primary">ä¿å­˜åˆåŒ</button>
            <a href="{% url 'business_pages:contract_management_list' %}" class="btn btn-secondary">å–æ¶ˆ</a>
        </div>
    </form>

<script>
document.addEventListener('DOMContentLoaded', function() {
        // ========== ç­¾çº¦ä¸»ä½“åˆ—è¡¨ç®¡ç† ==========
    let partyIndex = 0;
        // æ·»åŠ ç­¾çº¦ä¸»ä½“è¡Œ
    function addPartyRow(partyData = null) {
        // ç¡®ä¿å®¹å™¨å­˜åœ¨
        const container = document.getElementById('parties-container');
        if (!container) {
            console.error('parties-container æœªæ‰¾åˆ°ï¼Œæ— æ³•æ·»åŠ è¡Œ');
            return;
        }
        
        const index = partyIndex++;
        const party = partyData || {};
        
        const row = document.createElement('tr');
        row.className = 'party-row';
        row.setAttribute('data-party-index', index);
        
        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            row.innerHTML = `
            <td style="vertical-align: middle; text-align: center;">
                <strong>0</strong>
            </td>
            <td>
                <select name="parties[${index}][party_type]" class="form-select form-select-sm" required>
                    <option value="party_a" ${party.party_type === 'party_a' ? 'selected' : ''}>ç”²æ–¹</option>
                    <option value="party_b" ${party.party_type === 'party_b' ? 'selected' : ''}>ä¹™æ–¹</option>
                    <option value="party_c" ${party.party_type === 'party_c' ? 'selected' : ''}>ä¸™æ–¹</option>
                    <option value="other" ${party.party_type === 'other' ? 'selected' : ''}>å…¶ä»–</option>
                </select>
            </td>
            <td>
                <input type="text" name="parties[${index}][party_name]" class="form-control form-control-sm"
                       value="${(party.party_name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥å•ä½åç§°" required>
            </td>
            <td>
                <input type="text" name="parties[${index}][credit_code]" class="form-control form-control-sm"
                       value="${(party.credit_code || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ">
            </td>
            <td>
                <input type="text" name="parties[${index}][legal_representative]" class="form-control form-control-sm"
                       value="${(party.legal_representative || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥æ³•å®šä»£è¡¨äºº">
            </td>
            <td>
                <input type="text" name="parties[${index}][project_manager]" class="form-control form-control-sm"
                       value="${(party.project_manager || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥é¡¹ç›®è´Ÿè´£äºº">
            </td>
            <td>
                <input type="text" name="parties[${index}][contact_phone]" class="form-control form-control-sm"
                       value="${(party.contact_phone || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯">
            </td>
            <td>
                <input type="email" name="parties[${index}][contact_email]" class="form-control form-control-sm"
                       value="${(party.contact_email || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥è”ç³»é‚®ç®±">
            </td>
            <td>
                <input type="text" name="parties[${index}][address]" class="form-control form-control-sm"
                       value="${(party.address || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥åŠå…¬åœ°å€">
            </td>
            <td style="vertical-align: middle; text-align: center;">
                <button type="button" class="btn btn-sm btn-danger remove-party-btn" data-index="${index}" title="åˆ é™¤">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        container.appendChild(row);
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        const removeBtn = row.querySelector('.remove-party-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                const currentRows = container.querySelectorAll('tr.party-row');
                if (currentRows.length <= 2) {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸¤è¡Œç­¾çº¦ä¸»ä½“ï¼ˆç”²æ–¹å’Œä¹™æ–¹ï¼‰');
                    return;
                }
                row.remove();
                updatePartyRowNumbers();
            });
        }
        
        // æ›´æ–°è¡Œç¼–å·
        updatePartyRowNumbers();
    }
    
    // æ›´æ–°ç­¾çº¦ä¸»ä½“è¡Œç¼–å·
    function updatePartyRowNumbers() {
        const rows = document.getElementById('parties-container').querySelectorAll('tr.party-row');
        rows.forEach((row, index) => {
            const numberCell = row.querySelector('td:first-child strong');
            if (numberCell) {
                numberCell.textContent = index + 1;
            }
        });
    }
    
    
    // åˆå§‹åŒ–ï¼šç¡®ä¿è‡³å°‘æœ‰ä¸¤è¡Œç­¾çº¦ä¸»ä½“ï¼ˆç”²æ–¹å’Œä¹™æ–¹ï¼‰
    function ensureMinTwoParties() {
        // è·å–å®¹å™¨
        const container = document.getElementById('parties-container');
        if (!container) {
            return;
        }
        
        const currentRows = container.querySelectorAll('tr.party-row');
        const currentCount = currentRows.length;
        
        if (currentCount < 2) {
            const needed = 2 - currentCount;
            
            // ç¬¬ä¸€è¡Œé»˜è®¤ä¸ºç”²æ–¹ï¼Œç¬¬äºŒè¡Œé»˜è®¤ä¸ºä¹™æ–¹
            for (let i = 0; i < needed; i++) {
                const partyType = i === 0 ? 'party_a' : 'party_b';
                addPartyRow({ party_type: partyType });
            }
            
            // æ·»åŠ å®Œæˆåï¼Œå†æ¬¡æ›´æ–°è¡Œç¼–å·
            setTimeout(function() {
                updatePartyRowNumbers();
            }, 50);
        } else {
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ï¼ˆå¤šæ¬¡å°è¯•ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½ï¼‰
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    ensureMinTwoParties();
    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½åŠ è½½å®Œæˆ
    setTimeout(ensureMinTwoParties, 100);
    setTimeout(ensureMinTwoParties, 300);
    setTimeout(ensureMinTwoParties, 500);


    // ========== å›æ¬¾ä¿¡æ¯åˆ—è¡¨ç®¡ç† ==========
    let paymentInfoIndex = 0;
    
    // æ·»åŠ å›æ¬¾ä¿¡æ¯è¡Œ
    function addPaymentInfoRow(paymentData = null) {
        const container = document.getElementById('payment-info-container');
        if (!container) {
            console.error('payment-info-container æœªæ‰¾åˆ°ï¼Œæ— æ³•æ·»åŠ è¡Œ');
            return;
        }
        
        const index = paymentInfoIndex++;
        const payment = paymentData || {};
        
        const row = document.createElement('tr');
        row.className = 'payment-info-row';
        row.setAttribute('data-payment-index', index);
        
        row.innerHTML = `
            <td style="vertical-align: middle; text-align: center;">
                <strong>0</strong>
            </td>
            <td>
                <select name="payment_info[${index}][trigger_node]" class="form-select form-select-sm" required>
                    <option value="">è¯·é€‰æ‹©è§¦å‘èŠ‚ç‚¹</option>
                    <option value="contract_signed" ${payment.trigger_node === 'contract_signed' ? 'selected' : ''}>åˆåŒç­¾è®¢</option>
                    <option value="project_start" ${payment.trigger_node === 'project_start' ? 'selected' : ''}>é¡¹ç›®å¯åŠ¨</option>
                    <option value="milestone_1" ${payment.trigger_node === 'milestone_1' ? 'selected' : ''}>é‡Œç¨‹ç¢‘1</option>
                    <option value="milestone_2" ${payment.trigger_node === 'milestone_2' ? 'selected' : ''}>é‡Œç¨‹ç¢‘2</option>
                    <option value="project_complete" ${payment.trigger_node === 'project_complete' ? 'selected' : ''}>é¡¹ç›®å®Œæˆ</option>
                    <option value="acceptance" ${payment.trigger_node === 'acceptance' ? 'selected' : ''}>éªŒæ”¶é€šè¿‡</option>
                    <option value="final_settlement" ${payment.trigger_node === 'final_settlement' ? 'selected' : ''}>æœ€ç»ˆç»“ç®—</option>
                </select>
            </td>
            <td>
                <select name="payment_info[${index}][calculation_basis]" class="form-select form-select-sm" required>
                    <option value="">è¯·é€‰æ‹©è®¡ç®—åŸºç¡€</option>
                    <option value="contract_amount" ${payment.calculation_basis === 'contract_amount' ? 'selected' : ''}>åˆåŒé‡‘é¢</option>
                    <option value="tax_free_amount" ${payment.calculation_basis === 'tax_free_amount' ? 'selected' : ''}>ä¸å«ç¨é‡‘é¢</option>
                    <option value="service_fee" ${payment.calculation_basis === 'service_fee' ? 'selected' : ''}>æœåŠ¡è´¹</option>
                    <option value="fixed_amount" ${payment.calculation_basis === 'fixed_amount' ? 'selected' : ''}>å›ºå®šé‡‘é¢</option>
                </select>
            </td>
            <td>
                <input type="number" name="payment_info[${index}][payment_ratio]" class="form-control form-control-sm payment-ratio"
                       value="${payment.payment_ratio || ''}" 
                       placeholder="0.00" step="0.01" min="0" max="100">
            </td>
            <td>
                <input type="number" name="payment_info[${index}][payment_amount]" class="form-control form-control-sm payment-amount"
                       value="${payment.payment_amount || ''}" 
                       placeholder="0.00" step="0.01" min="0" readonly>
            </td>
            <td style="vertical-align: middle; text-align: center;">
                <button type="button" class="btn btn-sm btn-danger remove-payment-info-btn">
                    <i class="bi bi-trash"></i> åˆ é™¤
                </button>
            </td>
        `;
        
        container.appendChild(row);
        updatePaymentInfoRowNumbers();
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        const removeBtn = row.querySelector('.remove-payment-info-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                const currentRows = container.querySelectorAll('tr.payment-info-row');
                if (currentRows.length <= 1) {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡Œå›æ¬¾ä¿¡æ¯');
                    return;
                }
                row.remove();
                updatePaymentInfoRowNumbers();
            });
        }
        
        // ç»‘å®šå›æ¬¾æ¯”ä¾‹å˜åŒ–äº‹ä»¶ï¼Œè‡ªåŠ¨è®¡ç®—å›æ¬¾é‡‘é¢
        const ratioInput = row.querySelector('.payment-ratio');
        if (ratioInput) {
            ratioInput.addEventListener('input', function() {
                calculatePaymentAmount(index);
            });
        }
        
        return index;
    }
    
    // æ›´æ–°å›æ¬¾ä¿¡æ¯è¡Œåºå·
    function updatePaymentInfoRowNumbers() {
        const rows = document.getElementById('payment-info-container').querySelectorAll('tr.payment-info-row');
        rows.forEach(function(row, index) {
            const numberCell = row.querySelector('td:first-child strong');
            if (numberCell) {
                numberCell.textContent = index + 1;
            }
        });
    }
    
    // è®¡ç®—å›æ¬¾é‡‘é¢
    function calculatePaymentAmount(index) {
        const row = document.querySelector(`tr[data-payment-index="${index}"]`);
        if (!row) return;
        
        const ratioInput = row.querySelector('.payment-ratio');
        const amountInput = row.querySelector('.payment-amount');
        const basisSelect = row.querySelector('select[name*="[calculation_basis]"]');
        
        if (!ratioInput || !amountInput || !basisSelect) return;
        
        const ratio = parseFloat(ratioInput.value) || 0;
        const basis = basisSelect.value;
        
        // è·å–è®¡ç®—åŸºç¡€çš„å€¼
        let basisValue = 0;
        if (basis === 'contract_amount') {
            const contractAmountInput = document.getElementById('id_contract_amount');
            basisValue = parseFloat(contractAmountInput?.value) || 0;
        } else if (basis === 'tax_free_amount') {
            // è®¡ç®—ä¸å«ç¨é‡‘é¢
            const contractAmountInput = document.getElementById('id_contract_amount');
            const taxRateInput = document.getElementById('id_tax_rate');
            const contractAmount = parseFloat(contractAmountInput?.value) || 0;
            const taxRate = parseFloat(taxRateInput?.value) || 0;
            basisValue = contractAmount / (1 + taxRate / 100);
        } else if (basis === 'service_fee') {
            // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè·å–æœåŠ¡è´¹
            basisValue = 0; // æš‚æ—¶è®¾ä¸º0ï¼Œåç»­å¯ä»¥æ ¹æ®éœ€è¦å®ç°
        } else if (basis === 'fixed_amount') {
            // å›ºå®šé‡‘é¢ï¼Œç›´æ¥ä½¿ç”¨æ¯”ä¾‹ä½œä¸ºé‡‘é¢
            amountInput.value = ratio.toFixed(2);
            return;
        }
        
        // è®¡ç®—å›æ¬¾é‡‘é¢
        const amount = (basisValue * ratio / 100).toFixed(2);
        amountInput.value = amount;
    }
    
    // åˆå§‹åŒ–å›æ¬¾ä¿¡æ¯åˆ—è¡¨ï¼ˆè‡³å°‘ä¸€è¡Œï¼‰
    function ensureMinOnePaymentInfo() {
        const container = document.getElementById('payment-info-container');
        if (!container) return;
        
        const rows = container.querySelectorAll('tr.payment-info-row');
        if (rows.length === 0) {
            addPaymentInfoRow();
        }
    }
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    ensureMinOnePaymentInfo();
    setTimeout(ensureMinOnePaymentInfo, 100);
    // ç»‘å®š"æ·»åŠ å›æ¬¾ä¿¡æ¯"æŒ‰é’®äº‹ä»¶
    const addPaymentInfoBtn = document.getElementById('add-payment-info-btn');
    if (addPaymentInfoBtn) {
        addPaymentInfoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            addPaymentInfoRow();
        });
    }
    
    setTimeout(ensureMinOnePaymentInfo, 300);
    
    
        // ç¼“å­˜å¸¸ç”¨DOMå…ƒç´ 
        const cachedElements = {
            contractForm: null,
                        
serviceContentsContainer: null,
        };
        
        // åˆå§‹åŒ–ç¼“å­˜
        cachedElements.contractForm = document.getElementById('contract-form');
cachedElements.serviceContentsContainer = document.getElementById('service-contents-container');
    // ä¸»åˆåŒå­—æ®µæ¡ä»¶æ˜¾ç¤ºæ§åˆ¶
    const contractTypeField = document.getElementById('id_contract_type');
    const parentContractRow = document.getElementById('parent-contract-row');
    
    function toggleParentContractField() {
        if (contractTypeField && parentContractRow) {
            const contractType = contractTypeField.value;
            // åªæœ‰é€‰æ‹©è¡¥å……åè®®ã€å˜æ›´åè®®æˆ–ç»ˆæ­¢åè®®æ—¶æ‰æ˜¾ç¤ºä¸»åˆåŒå­—æ®µ
            if (contractType === 'supplement' || contractType === 'change' || contractType === 'termination') {
                parentContractRow.style.display = '';
            } else {
                parentContractRow.style.display = 'none';
                // æ¸…ç©ºä¸»åˆåŒé€‰æ‹©ï¼ˆå¦‚æœéšè—ï¼‰
                const parentContractField = document.getElementById('id_parent_contract');
                if (parentContractField) {
                    parentContractField.value = '';
                }
            }
        }
    }
    
    // åˆå§‹åŒ–æ—¶æ£€æŸ¥
    toggleParentContractField();
    
    // ç›‘å¬åˆåŒç±»å‹å˜åŒ–
    if (contractTypeField) {
        contractTypeField.addEventListener('change', toggleParentContractField);
    }
    
    // æ›´æ–°è¡¨æ ¼è¡Œåºå·
        rows.forEach((row, idx) => {
            const numberCell = row.querySelector('td:first-child');
            if (numberCell) {
                // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            numberCell.innerHTML = `<strong>${idx + 1}</strong>`;
            }
        });
    }
    
    
    

    
    let partyIndex = 0;
    
        rows.forEach(function(row, index) {
            const numberCell = row.querySelector('td:first-child');
            if (numberCell) {
                // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            numberCell.innerHTML = `<strong>0</strong>`;
            }
    
    // æ›´æ–°æ‰€æœ‰åˆ é™¤æŒ‰é’®çš„ç¦ç”¨çŠ¶æ€ï¼ˆå½“åªæœ‰ä¸¤è¡Œæ—¶ç¦ç”¨ï¼‰
        const rowCount = rows.length;
        rows.forEach(function(row) {
            if (removeBtn) {
                if (rowCount <= 2) {
                    removeBtn.disabled = true;
                    removeBtn.classList.add('disabled');
                    removeBtn.style.opacity = '0.5';
                    removeBtn.style.cursor = 'not-allowed';
                } else {
                    removeBtn.disabled = false;
                    removeBtn.classList.remove('disabled');
                    removeBtn.style.opacity = '1';
                    removeBtn.style.cursor = 'pointer';
                }
            }
        });
    }
    
            // æ›´æ–°æ‰€æœ‰inputå’Œselectçš„nameå±æ€§ä¸­çš„ç´¢å¼•
            const inputs = row.querySelectorAll('input, select');
            inputs.forEach(function(input) {
                const name = input.getAttribute('name');
                if (name) {
                    input.setAttribute('name', newName);
                }
            });
            // æ›´æ–°åˆ é™¤æŒ‰é’®çš„data-index
            if (removeBtn) {
                removeBtn.setAttribute('data-index', index);
            }
        });
    }
    
        const index = partyIndex++;
        const party = partyData || {};
        
        const row = document.createElement('tr');
        row.setAttribute('data-index', index);
        
        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            row.innerHTML = `
            <td style="vertical-align: middle; text-align: center;">
                <strong>0</strong>
            </td>
            <td>
                    <option value="party_a" ${party.party_type === 'party_a' ? 'selected' : ''}>ç”²æ–¹</option>
                    <option value="party_b" ${party.party_type === 'party_b' ? 'selected' : ''}>ä¹™æ–¹</option>
                    <option value="party_c" ${party.party_type === 'party_c' ? 'selected' : ''}>ä¸™æ–¹</option>
                    <option value="other" ${party.party_type === 'other' ? 'selected' : ''}>å…¶ä»–</option>
                </select>
            </td>
            <td>
                       value="${(party.party_name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" required>
            </td>
            <td>
                       value="${(party.credit_code || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
            </td>
            <td>
                       value="${(party.legal_representative || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
            </td>
            <td>
                       value="${(party.party_contact || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
            </td>
            <td>
                       value="${(party.contact_phone || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
            </td>
            <td>
                       value="${(party.contact_email || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
            </td>
            <td>
                       value="${(party.address || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
            </td>
            <td style="vertical-align: middle; text-align: center;">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        container.appendChild(row);
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                if (currentRows.length <= 2) {
                    return;
                }
                row.remove();
                // æ›´æ–°åˆ é™¤æŒ‰é’®çŠ¶æ€
            });
        }
        
        // æ›´æ–°åºå·
        // æ›´æ–°åˆ é™¤æŒ‰é’®çŠ¶æ€
    }
    
    
    (function initParties() {
        function checkAndAdd() {
            if (container) {
                const currentCount = currentRows.length;
                if (currentCount < 2) {
                        const needed = 2 - currentCount;
                        for (let i = 0; i < needed; i++) {
                        }
                        return true;
                    } else {
                        return false;
                    }
                } else {
                    return true;
                }
            } else {
                return false;
            }
        }
        
        // ç«‹å³å°è¯•
        if (!checkAndAdd()) {
            // å¦‚æœå¤±è´¥ï¼Œå»¶è¿Ÿé‡è¯•
            setTimeout(function() {
                if (!checkAndAdd()) {
                    setTimeout(function() {
                        checkAndAdd();
                    }, 200);
                }
            }, 50);
        }
    })();
    
    
    (function() {
        if (container) {
                const needed = 2 - rows.length;
                for (let i = 0; i < needed; i++) {
                }
            } else {
            }
        } else {
        }
    })();
    
    // å»¶è¿Ÿæ‰§è¡Œï¼ˆç¡®ä¿DOMå®Œå…¨åŠ è½½ï¼‰
    setTimeout(function() {
        if (container) {
                const needed = 2 - rows.length;
                for (let i = 0; i < needed; i++) {
                }
            }
        }
    }, 100);
    
        }
        });
    }
    
    

            // åŠ è½½å®Œæˆåï¼Œç«‹å³æ£€æŸ¥æ˜¯å¦éœ€è¦è¡¥å……åˆ°ä¸¤è¡Œ
            setTimeout(function() {
                const container = document.getElementById('parties-container');
                if (container) {
                    if (currentRows.length < 2) {
                        const needed = 2 - currentRows.length;
                        for (let i = 0; i < needed; i++) {
                    ensureMinTwoParties();
                        }
                               // æ›´æ–°åˆ é™¤æŒ‰é’®çŠ¶æ€
         }
                }
            }, 100);
    

    // ä½¿ç”¨å¤šé‡æ£€æŸ¥ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
         }
        }
    }
    
    // å¤šæ¬¡å°è¯•ï¼Œç¡®ä¿æ‰§è¡Œ
    // ç¡®ä¿åˆ é™¤æŒ‰é’®çŠ¶æ€æ­£ç¡®
    
    
    
    
        }
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        const removeBtn = row.querySelector('.remove-service-content-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                // æ£€æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€è¡Œï¼Œå¦‚æœåªæœ‰ä¸€è¡Œåˆ™ä¸åˆ é™¤
                const currentRows = serviceContentsContainer.querySelectorAll('tr.service-content-row');
                if (currentRows.length <= 1) {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡ŒæœåŠ¡å†…å®¹');
                    return;
                }
                row.remove();
                // æ›´æ–°åºå·
                updateServiceContentRowNumbers();
            });
        }
    }
    
    // æ›´æ–°è¡¨æ ¼è¡Œåºå·
    function updateServiceContentRowNumbers() {
        const rows = serviceContentsContainer.querySelectorAll('tr.service-content-row');
        rows.forEach((row, idx) => {
            const numberCell = row.querySelector('td:first-child');
            if (numberCell) {
                // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            numberCell.innerHTML = `<strong>${idx + 1}</strong>`;
            }
        });

    }
    
    
    // åŠ è½½å·²æœ‰çš„æœåŠ¡å†…å®¹ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
    {% if existing_service_contents %}
    const existingServiceContents = [
        {% for sc in existing_service_contents %}
        {
            service_type: {{ sc.service_type_id|default:"null" }},
            design_stage: {{ sc.design_stage_id|default:"null" }},
            business_type: {{ sc.business_type_id|default:"null" }},
            description: {{ sc.description|default:"''"|escapejs }},
    ];
        {% endfor %}

    existingServiceContents.forEach(function(content) {
    {% endif %}
        addServiceContent(content);
    });
    
    // ç¡®ä¿è‡³å°‘æœ‰ä¸€è¡ŒæœåŠ¡å†…å®¹
    if (serviceContentsContainer && serviceContentsContainer.querySelectorAll('tr.service-content-row').length === 0) {
        addServiceContent();
    }
    
    
    // ========== åˆåŒè¯†åˆ«åŠŸèƒ½ ==========
    const contractFileInput = document.getElementById('contract-file-input');
    const recognizeBtn = document.getElementById('recognize-contract-btn');
    const recognitionStatus = document.getElementById('recognition-status');
    const recognitionResult = document.getElementById('recognition-result');
    const recognitionMessage = document.getElementById('recognition-message');
    
    if (recognizeBtn && contractFileInput) {
        recognizeBtn.addEventListener('click', async function() {
            const file = contractFileInput.files[0];
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©åˆåŒæ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 10 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                return;
            }
            
            // æ˜¾ç¤ºè¯†åˆ«çŠ¶æ€
            recognitionStatus.style.display = 'block';
            recognitionResult.style.display = 'none';
            recognitionMessage.textContent = 'æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...';
            recognizeBtn.disabled = true;
            
            // åˆ›å»ºFormData
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // è°ƒç”¨è¯†åˆ«API
                const response = await fetch('/api/customer/contracts/recognize/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // è¯†åˆ«æˆåŠŸï¼Œå¡«å……è¡¨å•
                    fillFormWithRecognitionResult(result.data);
                    recognitionMessage.textContent = 'è¯†åˆ«å®Œæˆï¼';
                    recognitionStatus.style.display = 'none';
                    recognitionResult.style.display = 'block';
                } else {
                    // è¯†åˆ«å¤±è´¥
                    recognitionMessage.textContent = 'è¯†åˆ«å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯');
                    recognitionStatus.querySelector('.alert').className = 'alert alert-danger';
                }
            } catch (error) {
                recognitionMessage.textContent = 'è¯†åˆ«å¤±è´¥ï¼š' + error.message;
                recognitionStatus.querySelector('.alert').className = 'alert alert-danger';
            } finally {
                recognizeBtn.disabled = false;
            }
        });
    }
    
    // å¡«å……è¡¨å•æ•°æ®
    function fillFormWithRecognitionResult(data) {
        // åˆåŒåç§°
        if (data.contract_name) {
            const contractNameField = document.querySelector('[name=]"contract_name"]');
            if (contractNameField && !contractNameField.value) {
                contractNameField.value = data.contract_name;
            }
        }
        
        // é¡¹ç›®ç¼–å·ï¼ˆåˆåŒç¼–å·ï¼‰
        if (data.contract_number) {
            const contractNumberField = document.querySelector('[name="project_number"]');
            if (contractNumberField && !contractNumberField.value) {
                contractNumberField.value = data.contract_number;
            }
        }
        
        // åˆåŒç±»å‹
        if (data.contract_type) {
            const contractTypeField = document.querySelector('[name="contract_type"]');
            if (contractTypeField) {
                // å°è¯•åŒ¹é…åˆåŒç±»å‹
                const options = contractTypeField.querySelectorAll('option');
                for (let opt of options) {
                    if (opt.textContent.includes(data.contract_type) || data.contract_type.includes(opt.textContent)) {
                        contractTypeField.value = opt.value;
                        break;
                    }
                }
            }
        }
        
        // åˆåŒæè¿°
        if (data.description) {
            const descField = document.querySelector('[name="description"]');
            if (descField && !descField.value) {
                descField.value = data.description;
            }
        }
        
        if (data.party_a && data.party_a.name) {
            if (partyRows.length > 0) {
                const firstRow = partyRows[0];
                const partyNameInput = firstCard.querySelector('input[name*="[party_name]"]');
                if (partyNameInput && !partyNameInput.value) {
                    partyNameInput.value = data.party_a.name;
                }
                if (data.party_a.contact) {
                    const contactInput = firstCard.querySelector('input[name*="[party_contact]"]');
                if (data.party_a.phone) {
                    const phoneInput = firstCard.querySelector('input[name*="[contact_phone]"]');
                if (data.party_a.email) {
                    const emailInput = firstCard.querySelector('input[name*="[contact_email]"]');
                if (data.party_a.address) {
                    const addressInput = firstCard.querySelector('input[name*="[address]"]');
                if (data.party_a.credit_code) {
                    const creditCodeInput = firstCard.querySelector('input[name*="[credit_code]"]');
                if (data.party_a.legal_representative) {
                    const legalRepInput = firstCard.querySelector('input[name*="[legal_representative]"]');
            }
        }
        
        if (data.party_b && data.party_b.name) {
            let secondRow = null;
            if (partyRows.length > 1) {
                secondRow = partyRows[1];
                setTimeout(function() {
                    if (newRows.length > 1) {
                        secondRow = newRows[1];
                    }
                }, 300);
            }
            
            if (secondRow) {
                const partyNameInput = secondRow.querySelector('input[name*="[party_name]"]');
                if (partyNameInput && !partyNameInput.value) {
                    partyNameInput.value = data.party_b.name;
                }
                if (data.party_b.contact) {
                    const contactInput = secondRow.querySelector('input[name*="[party_contact]"]');
                if (data.party_b.phone) {
                    const phoneInput = secondRow.querySelector('input[name*="[contact_phone]"]');
                if (data.party_b.email) {
                    const emailInput = secondRow.querySelector('input[name*="[contact_email]"]');
                if (data.party_b.address) {
                    const addressInput = secondRow.querySelector('input[name*="[address]"]');
                if (data.party_b.credit_code) {
                    const creditCodeInput = secondRow.querySelector('input[name*="[credit_code]"]');
                if (data.party_b.legal_representative) {
                    const legalRepInput = secondRow.querySelector('input[name*="[legal_representative]"]');
            }
        }
        
        // å¦‚æœæœ‰åˆåŒé‡‘é¢ï¼Œå¯ä»¥å°è¯•å¡«å……åˆ°ç»“ç®—æ–¹å¼ä¸­ï¼ˆå›ºå®šæ€»ä»·ï¼‰
    }
    
// ========== ç»“ç®—æ–¹å¼ç®¡ç†ï¼ˆè¡¨æ ¼å½¢å¼ï¼‰ ==========
    
    
    
    // ç»“ç®—æ–¹å¼é€‰é¡¹ï¼ˆä»æ¨¡æ¿ä¸­è·å–ï¼‰
        { value: '{{ value }}', label: '{{ label }}' },
    ];

    // é¢ç§¯ç±»å‹é€‰é¡¹

    // å°é¡¶ç±»å‹é€‰é¡¹

    // æœåŠ¡ç±»å‹é€‰é¡¹ï¼ˆä»æ¨¡æ¿ä¸­è·å–ï¼‰
    const serviceTypeOptions = [
        {% for st in service_types %}
        { value: '{{ st.id }}', label: '{{ st.name }}' },
        {% endfor %}
    ];

    // æ·»åŠ ç»“ç®—æ–¹å¼å¡ç‰‡
    
        // æ›´æ–°ç»“ç®—æ–¹å¼ç›¸å…³å­—æ®µçš„æ˜¾ç¤º
    // æ·»åŠ åˆ†æ®µå–è´¹è¡Œ
    function addSegmentedRate(cardIndex, rateData = null) {
        const rate = rateData || {};
        if (!container) return;
        
        const row = document.createElement('tr');
        row.setAttribute('data-rate-index', rateIndex);
        
        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            row.innerHTML = `
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.greater_than || ''}" placeholder="0.00">
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.less_than || ''}" placeholder="0.00">
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.rate || ''}" placeholder="0.00" required>
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.service_fee || ''}" placeholder="0.00">
            </td>
            <td style="text-align: center;">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        container.appendChild(row);

        // ç»‘å®šæœåŠ¡è´¹è¾“å…¥æ¡†çš„changeäº‹ä»¶ï¼Œè‡ªåŠ¨è®¡ç®—å°è®¡
        const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
        if (serviceFeeInput) {
            serviceFeeInput.addEventListener('input', function() {
                calculateFixedTotalSum(cardIndex);
            });
        }
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                row.remove();
                updateSegmentedRateNumbers(cardIndex);
            });
        }
    }
    
    // æ›´æ–°åˆ†æ®µåºå·
    // æ·»åŠ æ€»ä»·åŒ…å¹²æ¡ç›®
    function addFixedTotalItem(cardIndex, itemData = null) {
        const item = itemData || {};
        if (!container) return;
        
        const row = document.createElement('tr');
        row.setAttribute('data-item-index', itemIndex);
        
        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            row.innerHTML = `
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${item.area_scale || ''}" placeholder="0.00" required>
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${item.service_fee || ''}" placeholder="0.00" required>
            </td>
            <td>
                    <i class="bi bi-trash"></i> åˆ é™¤
                </button>
            </td>
        `;
        
        container.appendChild(row);
        
        // ç»‘å®šæœåŠ¡è´¹è¾“å…¥æ¡†çš„changeäº‹ä»¶ï¼Œè‡ªåŠ¨è®¡ç®—å°è®¡
        const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
        if (serviceFeeInput) {
            serviceFeeInput.addEventListener('input', function() {
                calculateFixedTotalSum(cardIndex);
            });
        }
        
        // è®¡ç®—å°è®¡
        calculateFixedTotalSum(cardIndex);
        
        // æ›´æ–°åºå·
        updateFixedTotalNumbers(cardIndex);
        
    }
    
    // æ›´æ–°æ€»ä»·åŒ…å¹²æ¡ç›®åºå·
    
    
    
    function updateFixedTotalNumbers(cardIndex) {
        if (!container) return;
        
        rows.forEach(function(row, index) {
            row.setAttribute('data-item-index', index);
            // æ›´æ–°nameå±æ€§ä¸­çš„ç´¢å¼•
            const inputs = row.querySelectorAll('input');
            inputs.forEach(function(input) {
                const name = input.getAttribute('name');
                if (name) {
                    // æ›¿æ¢ç´¢å¼•éƒ¨åˆ†
                    const newName = name.replace(/\[fixed_total_items\]\[\d+\]/, '[fixed_total_items][' + index + ']');
                    input.setAttribute('name', newName);
                }
            });
            // æ›´æ–°åˆ é™¤æŒ‰é’®çš„data-item-index
            if (removeBtn) {
                removeBtn.setAttribute('data-item-index', index);
            }
        });
    }

    
    // è®¡ç®—æ€»ä»·åŒ…å¹²æœåŠ¡è´¹å°è®¡
    function calculateFixedTotalSum(cardIndex) {
        if (!container || !sumElement) return;
        
        let total = 0;
        
        rows.forEach(function(row) {
            const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
            if (serviceFeeInput && serviceFeeInput.value) {
                const value = parseFloat(serviceFeeInput.value) || 0;
                total += value;
            }
        });
        
        // æ›´æ–°å°è®¡æ˜¾ç¤ºï¼Œä¿ç•™ä¸¤ä½å°æ•°
        sumElement.textContent = total.toFixed(2);
        // console.log(...) // å·²ç§»é™¤}`);
    }
    function updateSegmentedRateNumbers(cardIndex) {
        if (!container) return;
        
        rows.forEach((row, idx) => {
            row.setAttribute('data-rate-index', idx);
            // æ›´æ–°æ‰€æœ‰è¾“å…¥æ¡†çš„nameå±æ€§
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name) {
                    const newName = name.replace(/\[segmented_rates\]\[\d+\]/, '[segmented_rates][' + idx + ']');
                    input.setAttribute('name', newName);
                }
            });
        });
    }

    
    
    // æ›´æ–°å¡ç‰‡åºå·
    function updateSettlementMethodNumbers() {
        cards.forEach((card, idx) => {
            const titleElement = card.querySelector('.card-title');
            if (titleElement) {
                titleElement.textContent = `ç»“ç®—æ–¹å¼ #${idx + 1}`;
            }
            // æ›´æ–°data-index
            card.setAttribute('data-index', idx);
            // æ›´æ–°æ‰€æœ‰è¾“å…¥æ¡†çš„nameå±æ€§ä¸­çš„index
            const inputs = card.querySelectorAll('input, select');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name && name.includes('[')) {
                    const newName = name.replace(/\[(\d+)\]/, '[' + idx + ']');
                    input.setAttribute('name', newName);
                }
            });
        });
    }
    
    // æ·»åŠ æŒ‰é’®äº‹ä»¶
    

        // å¦‚æœæ˜¯æ€»ä»·åŒ…å¹²ï¼ŒåŠ è½½æ€»ä»·åŒ…å¹²æ¡ç›®åˆ—è¡¨
        }
    });
    
    // åˆå§‹åŒ–æ‰€æœ‰è¡Œçš„å­—æ®µæ˜¾ç¤ºçŠ¶æ€
    setTimeout(function() {
        cards.forEach(function(card) {
            const indexAttr = card.getAttribute('data-index');
            if (indexAttr !== null) {
                const index = parseInt(indexAttr);
            }
        });
    }, 300);
    
    }
    
    
                // ç´¯è®¡ææˆï¼šéœ€è¦èŠ‚çœé‡‘é¢ï¼Œæš‚æ—¶æ— æ³•è®¡ç®—
                hasUncalculableMethod = true;
                    const unitPrice = parseFloat(fixedUnitPrice.value) || 0;
                    const totalArea = getTotalBuildingArea();
                    rowPrice += unitPrice * totalArea;
                }
                // æŒ‰å®ç»“ç®—éƒ¨åˆ†æš‚æ—¶æ— æ³•è®¡ç®—
                hasUncalculableMethod = true;
            } else {
                // å…¶ä»–ç»“ç®—æ–¹å¼ï¼ˆåˆ†æ®µé€’å¢ææˆã€è·³ç‚¹ææˆç­‰ï¼‰éœ€è¦èŠ‚çœé‡‘é¢ï¼Œæš‚æ—¶æ— æ³•è®¡ç®—
                hasUncalculableMethod = true;
            }
            
            totalPrice += rowPrice;
        });
        
        if (hasUncalculableMethod && totalPrice === 0) {
            contractPriceInput.value = 'éœ€æŒ‰å®ç»“ç®—';
        } else if (hasUncalculableMethod) {
            contractPriceInput.value = totalPrice.toFixed(2) + 'ï¼ˆéƒ¨åˆ†éœ€æŒ‰å®ç»“ç®—ï¼‰';
        } else if (totalPrice > 0) {
            contractPriceInput.value = totalPrice.toFixed(2);
        } else {
            contractPriceInput.value = '';
        }
    }
    
    // ä»æœåŠ¡å†…å®¹ä¸­è·å–æ€»å»ºç­‘é¢ç§¯
    function getTotalBuildingArea() {
        let totalArea = 0;
        
            const areaInput = card.querySelector('input[name*="[area_scale]"]');
            if (areaInput && areaInput.value) {
                totalArea += parseFloat(areaInput.value) || 0;
            }
        });
        
        return totalArea;
    }
    
        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç›‘å¬æ‰€æœ‰ç»“ç®—æ–¹å¼ç›¸å…³å­—æ®µçš„å˜åŒ–
        
        // ç›‘å¬ç»“ç®—æ–¹å¼è¡¨æ ¼ä¸­é¢ç§¯è§„æ¨¡çš„å˜åŒ–
        
        
        // é¡µé¢åŠ è½½æ—¶è®¡ç®—ä¸€æ¬¡
});
</script>
    {% endif %}
{% endblock %}
