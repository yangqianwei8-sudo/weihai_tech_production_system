{% extends "shared/module_base.html" %}

{% block title %}{{ page_title }} - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% block extra_css %}
<style>
    .form-card {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
    }
    .form-section {
        margin-bottom: 32px;
    }
    .form-section h5 {
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--vh-primary);
        font-weight: 600;
        color: #1f2937;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-label {
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
        font-size: 14px;
    }
    .required-field::after {
        content: " *";
        color: #dc2626;
    }
    .error-list {
        list-style: none;
        padding: 0;
        margin: 4px 0 0 0;
        color: #dc2626;
        font-size: 13px;
    }
    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }
    .form-check {
        margin-bottom: 8px;
    }
</style>
{% endblock %}

{% block authorization_letter_content %}
<div class="container-fluid py-4">
    <div class="center-hero mb-4">
        <div style="position: relative; z-index: 1;">
            <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 8px 0;">{{ page_title }}</h1>
            <p style="font-size: 14px; opacity: 0.9; margin: 0;">{{ description }}</p>
        </div>
    </div>

    <form method="post" class="form-card">
        {% csrf_token %}

        <div class="form-section">
            <h5>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">é¡¹ç›®ç¼–å·</label>
                        {{ form.project_number }}
                        {% if form.project_number.errors %}
                            <ul class="error-list">
                                {% for error in form.project_number.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                        <small class="form-text text-muted">ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼ˆæ ¼å¼ï¼šHT-YYYY-NNNNï¼‰ï¼Œä¸å¯ä¿®æ”¹</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label required-field">å§”æ‰˜æ—¥æœŸ</label>
                        {{ form.letter_date }}
                        {% if form.letter_date.errors %}
                            <ul class="error-list">
                                {% for error in form.letter_date.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label required-field">å•†åŠ¡ç»ç†</label>
                        {{ form.business_manager }}
                        {% if form.business_manager.errors %}
                            <ul class="error-list">
                                {% for error in form.business_manager.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h5>ğŸ‘¥ å§”æ‰˜å•ä½ä¿¡æ¯</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label required-field">å…³è”å®¢æˆ·</label>
                        {{ form.client }}
                        {% if form.client.errors %}
                            <ul class="error-list">
                                {% for error in form.client.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                        {{ form.client_name }}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">å•ä½ä»£è¡¨ï¼ˆè”ç³»äººï¼‰</label>
                        {{ form.client_contact }}
                        {% if form.client_contact.errors %}
                            <ul class="error-list">
                                {% for error in form.client_contact.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                        {{ form.client_representative }}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">è”ç³»ç”µè¯</label>
                        {{ form.client_phone }}
                        {% if form.client_phone.errors %}
                            <ul class="error-list">
                                {% for error in form.client_phone.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">ç”µå­é‚®ç®±</label>
                        {{ form.client_email }}
                        {% if form.client_email.errors %}
                            <ul class="error-list">
                                {% for error in form.client_email.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">æ”¶ä»¶åœ°å€</label>
                        {{ form.client_address }}
                        {% if form.client_address.errors %}
                            <ul class="error-list">
                                {% for error in form.client_address.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h5>ğŸ¢ æœåŠ¡å•ä½ä¿¡æ¯</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label required-field">æœåŠ¡å•ä½</label>
                        {{ form.trustee_name }}
                        {% if form.trustee_name.errors %}
                            <ul class="error-list">
                                {% for error in form.trustee_name.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">å•ä½ä»£è¡¨</label>
                        {{ form.trustee_representative }}
                        {% if form.trustee_representative.errors %}
                            <ul class="error-list">
                                {% for error in form.trustee_representative.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">è”ç³»ç”µè¯</label>
                        {{ form.trustee_phone }}
                        {% if form.trustee_phone.errors %}
                            <ul class="error-list">
                                {% for error in form.trustee_phone.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">ç”µå­é‚®ç®±</label>
                        {{ form.trustee_email }}
                        {% if form.trustee_email.errors %}
                            <ul class="error-list">
                                {% for error in form.trustee_email.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">æ”¶ä»¶åœ°å€</label>
                        {{ form.trustee_address }}
                        {% if form.trustee_address.errors %}
                            <ul class="error-list">
                                {% for error in form.trustee_address.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h5>ğŸ’° æœåŠ¡è´¹ç¡®å®šåŸåˆ™</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ç»“æœä¼˜åŒ–è´¹ç‡ï¼ˆ%ï¼‰</label>
                        {{ form.result_optimization_rate }}
                        {% if form.result_optimization_rate.errors %}
                            <ul class="error-list">
                                {% for error in form.result_optimization_rate.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                        <small class="form-text text-muted">10-15%</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">è¿‡ç¨‹ä¼˜åŒ–è´¹ç‡ï¼ˆ%ï¼‰</label>
                        {{ form.process_optimization_rate }}
                        {% if form.process_optimization_rate.errors %}
                            <ul class="error-list">
                                {% for error in form.process_optimization_rate.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                        <small class="form-text text-muted">10-15%</small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ç²¾ç»†åŒ–å®¡å›¾å•ä»·ä¸‹é™ï¼ˆå…ƒ/å¹³æ–¹ç±³ï¼‰</label>
                        {{ form.detailed_review_unit_price_min }}
                        {% if form.detailed_review_unit_price_min.errors %}
                            <ul class="error-list">
                                {% for error in form.detailed_review_unit_price_min.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                        <small class="form-text text-muted">ä¾‹å¦‚ï¼š1.5</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ç²¾ç»†åŒ–å®¡å›¾å•ä»·ä¸Šé™ï¼ˆå…ƒ/å¹³æ–¹ç±³ï¼‰</label>
                        {{ form.detailed_review_unit_price_max }}
                        {% if form.detailed_review_unit_price_max.errors %}
                            <ul class="error-list">
                                {% for error in form.detailed_review_unit_price_max.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                        <small class="form-text text-muted">ä¾‹å¦‚ï¼š3.0</small>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">æœåŠ¡è´¹ç¡®å®šåŸåˆ™è¯´æ˜</label>
                {{ form.fee_determination_principle }}
                {% if form.fee_determination_principle.errors %}
                    <ul class="error-list">
                        {% for error in form.fee_determination_principle.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>

        <div class="form-section">
            <h5>ğŸ’³ ç»“ç®—ä¸æ”¯ä»˜</h5>
            <div class="form-group">
                <label class="form-label">ç»“ç®—å®¡æ ¸æµç¨‹è¯´æ˜</label>
                {{ form.settlement_review_process }}
                {% if form.settlement_review_process.errors %}
                    <ul class="error-list">
                        {% for error in form.settlement_review_process.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
                <small class="form-text text-muted">è¯´æ˜ç»“ç®—ç”³è¯·ã€ç»“ç®—å®¡æ ¸ã€ä»˜æ¬¾æ–¹å¼ç­‰æµç¨‹</small>
            </div>
            <div class="form-group">
                <label class="form-label">ä»˜æ¬¾è®¡åˆ’</label>
                <div id="payment-schedule-editor" class="payment-schedule-editor">
                    <div class="payment-stage mb-2">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" class="form-control payment-stage-name" placeholder="é˜¶æ®µåç§°ï¼ˆå¦‚ï¼šé¦–ä»˜æ¬¾ï¼‰" value="">
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control payment-stage-amount" placeholder="ä»˜æ¬¾æ¯”ä¾‹ï¼ˆå¦‚ï¼š20%ï¼‰" value="">
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-sm btn-danger remove-payment-stage">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-secondary mt-2" id="add-payment-stage">+ æ·»åŠ ä»˜æ¬¾é˜¶æ®µ</button>
                {{ form.payment_schedule }}
                <small class="form-text text-muted">ä¾‹å¦‚ï¼šä¸‰é˜¶æ®µä»˜æ¬¾ï¼š20%ã€30%ã€100%</small>
            </div>
        </div>

        <div class="form-section">
            <h5>ğŸ“„ è¡¥å……çº¦å®š</h5>
            <div class="form-group">
                <label class="form-label">è¡¥å……çº¦å®š</label>
                {{ form.supplementary_agreement }}
                {% if form.supplementary_agreement.errors %}
                    <ul class="error-list">
                        {% for error in form.supplementary_agreement.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>

        <div class="form-section">
            <h5>ğŸ“… å§”æ‰˜æœŸé™</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
                        {{ form.start_date }}
                        {% if form.start_date.errors %}
                            <ul class="error-list">
                                {% for error in form.start_date.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ç»“æŸæ—¥æœŸ</label>
                        {{ form.end_date }}
                        {% if form.end_date.errors %}
                            <ul class="error-list">
                                {% for error in form.end_date.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h5>ğŸ”— å…³è”ä¿¡æ¯</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">å…³è”å•†æœº</label>
                        {{ form.opportunity }}
                        {% if form.opportunity.errors %}
                            <ul class="error-list">
                                {% for error in form.opportunity.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">å…³è”é¡¹ç›®</label>
                        {{ form.project }}
                        {% if form.project.errors %}
                            <ul class="error-list">
                                {% for error in form.project.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">å¤‡æ³¨</label>
                {{ form.notes }}
                {% if form.notes.errors %}
                    <ul class="error-list">
                        {% for error in form.notes.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            <a href="{% if is_create %}{% url 'business_pages:authorization_letter_list' %}{% else %}{% url 'business_pages:authorization_letter_detail' letter.id %}{% endif %}" class="btn btn-secondary">å–æ¶ˆ</a>
        </div>
    </form>
</div>

<script>
    // å®‰å…¨çš„HTMLè®¾ç½®å‡½æ•°
    function setSafeHTML(element, html) {
        if (!element) return;
        // å¦‚æœå†…å®¹ä¸åŒ…å«HTMLæ ‡ç­¾ï¼Œä½¿ç”¨textContent
        if (!/<[^>]+>/.test(html)) {
            element.textContent = html;
        } else {
            // å¯¹äºåŒ…å«HTMLçš„å†…å®¹ï¼Œä½¿ç”¨innerHTMLï¼ˆå‡è®¾å†…å®¹å·²æ¸…ç†ï¼‰
            // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”è¯¥ä½¿ç”¨DOMPurifyç­‰åº“æ¸…ç†HTML
            element.innerHTML = html;
        }
    }

    // å®‰å…¨çš„æ–‡æœ¬è®¾ç½®å‡½æ•°ï¼ˆæ¨èä½¿ç”¨ï¼‰
    function setSafeText(element, text) {
        if (element) {
            element.textContent = text;
        }
    }

document.addEventListener('DOMContentLoaded', function() {
    const clientSelect = document.getElementById('id_client');
    const clientNameInput = document.getElementById('id_client_name');
    const opportunitySelect = document.getElementById('id_opportunity');

    // å¦‚æœä½¿ç”¨å®¢æˆ·ä¸‹æ‹‰é€‰æ‹©ï¼ˆæ–°å­—æ®µï¼‰
    if (clientSelect && opportunitySelect) {
        // ä¿å­˜å½“å‰é€‰ä¸­çš„å•†æœºIDï¼ˆç”¨äºç¼–è¾‘æ¨¡å¼ï¼‰
        const selectedOpportunityId = opportunitySelect.value;

        // æ›´æ–°å•†æœºåˆ—è¡¨
        function updateOpportunities() {
            const clientId = clientSelect.value;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            opportunitySelect.disabled = true;

            // æ„å»ºAPI URL
            let apiUrl = '{% url "customer:get_opportunities_by_client_name" %}';
            if (clientId) {
                // è·å–å®¢æˆ·åç§°
                const selectedOption = clientSelect.options[clientSelect.selectedIndex];
                const clientName = selectedOption.text;
                apiUrl += `?client_name=${encodeURIComponent(clientName)}`;
            }

            // è·å–å•†æœºåˆ—è¡¨
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ¸…ç©ºå½“å‰é€‰é¡¹
                        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            opportunitySelect.innerHTML = '<option value="">-- é€‰æ‹©å•†æœºï¼ˆå¯é€‰ï¼‰ --</option>';

                        // æ·»åŠ å•†æœºé€‰é¡¹
                        if (data.opportunities.length === 0) {
                            const noOption = document.createElement('option');
                            noOption.value = '';
                            noOption.textContent = clientId ? '-- è¯¥å®¢æˆ·æš‚æ— å¯ç”¨å•†æœº --' : '-- è¯·å…ˆé€‰æ‹©å®¢æˆ· --';
                            noOption.disabled = true;
                            opportunitySelect.appendChild(noOption);
                        } else {
                            data.opportunities.forEach(opp => {
                                const option = document.createElement('option');
                                option.value = opp.id;
                                option.textContent = `${opp.opportunity_number || ''} - ${opp.name}`.trim();
                                // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ä¸”å½“å‰é€‰ä¸­çš„å•†æœºï¼Œè®¾ç½®ä¸ºé€‰ä¸­
                                if (selectedOpportunityId && opp.id == selectedOpportunityId) {
                                    option.selected = true;
                                }
                                opportunitySelect.appendChild(option);
                            });
                        }
                    } else {
                    }
                })
                .catch(error => {
                })
                .finally(() => {
                    opportunitySelect.disabled = false;
                });
        }

        // ç›‘å¬å®¢æˆ·é€‰æ‹©å˜åŒ–
        clientSelect.addEventListener('change', updateOpportunities);

        // å¦‚æœå®¢æˆ·å·²æœ‰å€¼ï¼Œåˆå§‹åŒ–æ—¶ä¹Ÿæ›´æ–°ä¸€æ¬¡
        if (clientSelect.value) {
            updateOpportunities();
        }
    }

    // å¦‚æœä½¿ç”¨å®¢æˆ·åç§°è¾“å…¥ï¼ˆæ—§å­—æ®µï¼Œå‘åå…¼å®¹ï¼‰
    if (clientNameInput && opportunitySelect && !clientSelect) {
        // ä¿å­˜å½“å‰é€‰ä¸­çš„å•†æœºIDï¼ˆç”¨äºç¼–è¾‘æ¨¡å¼ï¼‰
        const selectedOpportunityId = opportunitySelect.value;

        // é˜²æŠ–å‡½æ•°
        let debounceTimer;
        function debounce(func, wait) {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // æ›´æ–°å•†æœºåˆ—è¡¨
        function updateOpportunities() {
            const clientName = clientNameInput.value.trim();

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            opportunitySelect.disabled = true;

            // æ„å»ºAPI URL
            let apiUrl = '{% url "customer:get_opportunities_by_client_name" %}';
            if (clientName) {
                apiUrl += `?client_name=${encodeURIComponent(clientName)}`;
            }

            // è·å–å•†æœºåˆ—è¡¨
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ¸…ç©ºå½“å‰é€‰é¡¹
                        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            opportunitySelect.innerHTML = '<option value="">-- é€‰æ‹©å•†æœºï¼ˆå¯é€‰ï¼‰ --</option>';

                        // æ·»åŠ å•†æœºé€‰é¡¹
                        if (data.opportunities.length === 0) {
                            const noOption = document.createElement('option');
                            noOption.value = '';
                            noOption.textContent = clientName ? '-- è¯¥å®¢æˆ·æš‚æ— å¯ç”¨å•†æœº --' : '-- æš‚æ— å¯ç”¨å•†æœº --';
                            noOption.disabled = true;
                            opportunitySelect.appendChild(noOption);
                        } else {
                            data.opportunities.forEach(opp => {
                                const option = document.createElement('option');
                                option.value = opp.id;
                                option.textContent = `${opp.opportunity_number || ''} - ${opp.name}`.trim();
                                // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ä¸”å½“å‰é€‰ä¸­çš„å•†æœºï¼Œè®¾ç½®ä¸ºé€‰ä¸­
                                if (selectedOpportunityId && opp.id == selectedOpportunityId) {
                                    option.selected = true;
                                }
                                opportunitySelect.appendChild(option);
                            });
                        }
                    } else {
                    }
                })
                .catch(error => {
                })
                .finally(() => {
                    opportunitySelect.disabled = false;
                });
        }

        // ç›‘å¬å®¢æˆ·åç§°è¾“å…¥å˜åŒ–ï¼ˆ500msé˜²æŠ–ï¼‰
        clientNameInput.addEventListener('input', debounce(updateOpportunities, 500));

        // ç›‘å¬å®¢æˆ·åç§°å¤±å»ç„¦ç‚¹ï¼ˆå¤„ç†ç²˜è´´ç­‰æƒ…å†µï¼‰
        clientNameInput.addEventListener('blur', updateOpportunities);

        // å¦‚æœå®¢æˆ·åç§°å·²æœ‰å€¼ï¼Œåˆå§‹åŒ–æ—¶ä¹Ÿæ›´æ–°ä¸€æ¬¡
        if (clientNameInput.value.trim()) {
            updateOpportunities();
        }
    }

    // ä»˜æ¬¾è®¡åˆ’ç¼–è¾‘å™¨
    (function() {
        const paymentScheduleEditor = document.getElementById('payment-schedule-editor');
        const paymentScheduleInput = document.getElementById('id_payment_schedule');
        const addPaymentStageBtn = document.getElementById('add-payment-stage');

        if (!paymentScheduleEditor || !paymentScheduleInput || !addPaymentStageBtn) {
            return;
        }

        // åˆ›å»ºä»˜æ¬¾é˜¶æ®µHTML
        function createPaymentStageHTML(name = '', amount = '') {
            return `
                <div class="payment-stage mb-2">
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" class="form-control payment-stage-name" placeholder="é˜¶æ®µåç§°ï¼ˆå¦‚ï¼šé¦–ä»˜æ¬¾ï¼‰" value="${name}">
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control payment-stage-amount" placeholder="ä»˜æ¬¾æ¯”ä¾‹ï¼ˆå¦‚ï¼š20%ï¼‰" value="${amount}">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-danger remove-payment-stage">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ›´æ–°éšè—å­—æ®µçš„å€¼
        function updatePaymentSchedule() {
            const stages = {};
            paymentScheduleEditor.querySelectorAll('.payment-stage').forEach(stage => {
                const name = stage.querySelector('.payment-stage-name').value.trim();
                const amount = stage.querySelector('.payment-stage-amount').value.trim();
                if (name && amount) {
                    stages[name] = amount;
                }
            });
            paymentScheduleInput.value = JSON.stringify(stages);
        }

        // æ·»åŠ ä»˜æ¬¾é˜¶æ®µ
        addPaymentStageBtn.addEventListener('click', function() {
            const stageHTML = createPaymentStageHTML();
            paymentScheduleEditor.insertAdjacentHTML('beforeend', stageHTML);

            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            const newStage = paymentScheduleEditor.lastElementChild;
            newStage.querySelector('.remove-payment-stage').addEventListener('click', function() {
                newStage.remove();
                updatePaymentSchedule();
            });

            // ç»‘å®šè¾“å…¥äº‹ä»¶
            newStage.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updatePaymentSchedule);
            });
        });

        // åˆ é™¤ä»˜æ¬¾é˜¶æ®µ
        paymentScheduleEditor.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-payment-stage')) {
                e.target.closest('.payment-stage').remove();
                updatePaymentSchedule();
            }
        });

        // ç›‘å¬è¾“å…¥å˜åŒ–
        paymentScheduleEditor.addEventListener('input', function(e) {
            if (e.target.classList.contains('payment-stage-name') || e.target.classList.contains('payment-stage-amount')) {
                updatePaymentSchedule();
            }
        });

        // åˆå§‹åŒ–ï¼šå¦‚æœæœ‰ç°æœ‰æ•°æ®ï¼ŒåŠ è½½å®ƒ
        if (paymentScheduleInput.value) {
            try {
                const existingSchedule = JSON.parse(paymentScheduleInput.value);
                paymentScheduleEditor.textContent = '';
                for (const [name, amount] of Object.entries(existingSchedule)) {
                    const stageHTML = createPaymentStageHTML(name, amount);
                    paymentScheduleEditor.insertAdjacentHTML('beforeend', stageHTML);
                }
            } catch (e) {
            }
        }

        // å¦‚æœæ²¡æœ‰é˜¶æ®µï¼Œè‡³å°‘æ·»åŠ ä¸€ä¸ªç©ºé˜¶æ®µ
        if (paymentScheduleEditor.querySelectorAll('.payment-stage').length === 0) {
            addPaymentStageBtn.click();
        }
    })();

    // å§”æ‰˜å•ä½ä¿¡æ¯ï¼šå…³è”å®¢æˆ·å’Œè”ç³»äººå¤„ç†
    (function() {
        const clientSelect = document.getElementById('id_client');
        const clientNameInput = document.getElementById('id_client_name');
        const clientContactSelect = document.getElementById('id_client_contact');
        const clientRepresentativeInput = document.getElementById('id_client_representative');
        const clientPhoneInput = document.getElementById('id_client_phone');
        const clientEmailInput = document.getElementById('id_client_email');
        const clientAddressInput = document.getElementById('id_client_address');

        if (!clientSelect || !clientContactSelect) {
            return;
        }

        // æ›´æ–°è”ç³»äººåˆ—è¡¨
        function updateContacts() {
            const clientId = clientSelect.value;

            if (!clientId) {
                // æ¸…ç©ºè”ç³»äººåˆ—è¡¨
                // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            clientContactSelect.innerHTML = '<option value="">-- é€‰æ‹©è”ç³»äºº --</option>';
                clientContactSelect.disabled = true;
                // æ¸…ç©ºå®¢æˆ·åç§°
                if (clientNameInput) {
                    clientNameInput.value = '';
                }
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            clientContactSelect.disabled = true;
            // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            clientContactSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

            // è·å–å®¢æˆ·åç§°
            const selectedOption = clientSelect.options[clientSelect.selectedIndex];
            const clientName = selectedOption.text;
            if (clientNameInput) {
                clientNameInput.value = clientName;
            }

            // æ„å»ºAPI URL
            const apiUrl = '{% url "customer:get_contacts_by_client_id" %}?client_id=' + encodeURIComponent(clientId);

            // è·å–è”ç³»äººåˆ—è¡¨
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ¸…ç©ºå½“å‰é€‰é¡¹
                        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            clientContactSelect.innerHTML = '<option value="">-- é€‰æ‹©è”ç³»äºº --</option>';

                        // æ·»åŠ è”ç³»äººé€‰é¡¹
                        if (data.contacts.length === 0) {
                            const noOption = document.createElement('option');
                            noOption.value = '';
                            noOption.textContent = '-- è¯¥å®¢æˆ·æš‚æ— è”ç³»äºº --';
                            noOption.disabled = true;
                            clientContactSelect.appendChild(noOption);
                        } else {
                            data.contacts.forEach(contact => {
                                const option = document.createElement('option');
                                option.value = contact.id;
                                option.textContent = contact.name;
                                clientContactSelect.appendChild(option);
                            });
                        }
                    } else {
                        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            clientContactSelect.innerHTML = '<option value="">-- è·å–è”ç³»äººå¤±è´¥ --</option>';
                    }
                })
                .catch(error => {
                    // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            clientContactSelect.innerHTML = '<option value="">-- è·å–è”ç³»äººå¤±è´¥ --</option>';
                })
                .finally(() => {
                    clientContactSelect.disabled = false;
                });
        }

        // æ›´æ–°è”ç³»äººä¿¡æ¯
        function updateContactInfo() {
            const contactId = clientContactSelect.value;

            if (!contactId) {
                // æ¸…ç©ºè”ç³»äººç›¸å…³ä¿¡æ¯
                if (clientRepresentativeInput) {
                    clientRepresentativeInput.value = '';
                }
                if (clientPhoneInput) {
                    clientPhoneInput.value = '';
                }
                if (clientEmailInput) {
                    clientEmailInput.value = '';
                }
                if (clientAddressInput) {
                    clientAddressInput.value = '';
                }
                return;
            }

            // è·å–é€‰ä¸­çš„è”ç³»äººä¿¡æ¯
            const selectedOption = clientContactSelect.options[clientContactSelect.selectedIndex];
            const contactName = selectedOption.text;

            // ä»APIè·å–è”ç³»äººè¯¦ç»†ä¿¡æ¯
            const clientId = clientSelect.value;
            const apiUrl = '{% url "customer:get_contacts_by_client_id" %}?client_id=' + encodeURIComponent(clientId);

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const contact = data.contacts.find(c => c.id == contactId);
                        if (contact) {
                            // å¡«å……è”ç³»äººä¿¡æ¯
                            if (clientRepresentativeInput) {
                                clientRepresentativeInput.value = contact.name;
                            }
                            if (clientPhoneInput) {
                                clientPhoneInput.value = contact.phone || '';
                            }
                            if (clientEmailInput) {
                                clientEmailInput.value = contact.email || '';
                            }
                            if (clientAddressInput) {
                                clientAddressInput.value = contact.office_address || '';
                            }
                        }
                    }
                })
                .catch(error => {
                });
        }

        // ç›‘å¬å®¢æˆ·é€‰æ‹©å˜åŒ–
        clientSelect.addEventListener('change', function() {
            updateContacts();
            // æ¸…ç©ºè”ç³»äººç›¸å…³ä¿¡æ¯
            if (clientContactSelect) {
                clientContactSelect.value = '';
            }
            updateContactInfo();
        });

        // ç›‘å¬è”ç³»äººé€‰æ‹©å˜åŒ–
        clientContactSelect.addEventListener('change', updateContactInfo);

        // å¦‚æœå®¢æˆ·å·²æœ‰å€¼ï¼Œåˆå§‹åŒ–æ—¶ä¹Ÿæ›´æ–°ä¸€æ¬¡
        if (clientSelect.value) {
            updateContacts();
            // å¦‚æœè”ç³»äººå·²æœ‰å€¼ï¼Œä¹Ÿæ›´æ–°ä¸€æ¬¡
            if (clientContactSelect.value) {
                updateContactInfo();
            }
        }
    })();

});
</script>
{% endblock %}
