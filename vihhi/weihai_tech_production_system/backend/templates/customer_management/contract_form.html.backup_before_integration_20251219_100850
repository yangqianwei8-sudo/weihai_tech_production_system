{% extends "customer_management/base.html" %}
{% load static %}

{% block title %}{{ page_title }} - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
    .form-group {
        margin-bottom: 20px;
    }
    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: block;
    }
    .required-field::after {
        content: " *";
        color: #ef4444;
    }
    .party-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .party-item-header {
    

        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'business_pages:contract_management_list' %}">åˆåŒç®¡ç†</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ page_title }}</li>
{% endblock %}

{% block content %}<div class="container-fluid py-4">
    <div class="form-page-title">
            <h1>{{ page_title }}</h1>
            {% if page_description %}
            <p>{{ page_description }}</p>
            {% endif %}
        </div>

    <form method="post" enctype="multipart/form-data" id="contract-form" class="form-card">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
        <div class="alert alert-danger">
        {% endif %}
            {{ form.non_field_errors }}
        </div>
        
        <!-- åˆåŒè¯†åˆ«åŠŸèƒ½ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ğŸ¤– AIåˆåŒè¯†åˆ«</h5>
                <button type="button" id="recognize-contract-btn" class="btn btn-primary">
                    <i class="bi bi-magic"></i> å¼€å§‹è¯†åˆ«
                </button>
            </div>
            <div class="alert alert-info" style="margin-bottom: 16px; font-size: 13px;">
                <i class="bi bi-info-circle"></i> ä¸Šä¼ åˆåŒæ–‡ä»¶ï¼ˆPDFã€å›¾ç‰‡ï¼‰ï¼ŒAIå°†è‡ªåŠ¨è¯†åˆ«å¹¶å¡«å……è¡¨å•ä¿¡æ¯
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label class="form-label">ä¸Šä¼ åˆåŒæ–‡ä»¶</label>
                        <input type="file" id="contract-file-input" class="form-control"
                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                               style="padding: 8px;">
                        <small class="form-text text-muted">æ”¯æŒæ ¼å¼ï¼šPDFã€JPGã€PNGã€DOCã€DOCXï¼Œæœ€å¤§10MB</small>
                    </div>
                </div>
            </div>
            <div id="recognition-status" style="display: none; margin-top: 12px;">
                <div class="alert alert-warning">
                    <i class="bi bi-hourglass-split"></i> <span id="recognition-message">æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</span>
                </div>
            </div>
            <div id="recognition-result" style="display: none; margin-top: 12px;">
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> è¯†åˆ«å®Œæˆï¼å·²è‡ªåŠ¨å¡«å……è¡¨å•ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥å¹¶ç¡®è®¤ã€‚
                </div>
            </div>
        </div>
        
        <!-- ä¸€ã€åŸºç¡€ä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>åŸºç¡€ä¿¡æ¯</h5>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">å®¡æ‰¹å•å·</label>
                        <input type="text" id="approval_number" name="approval_number" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ">
                        <small class="form-text text-muted">ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">æäº¤éƒ¨é—¨</label>
                        <input type="text" id="submit_department" name="submit_department" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value="{% if request.user.department %}{{ request.user.department.name }}{% else %}æœªè®¾ç½®éƒ¨é—¨{% endif %}">
                        <small class="form-text text-muted">ç³»ç»Ÿé»˜è®¤</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">æäº¤äºº</label>
                        <input type="text" id="submitter" name="submitter" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value="{{ request.user.get_full_name|default:request.user.username }}">
                        <small class="form-text text-muted">ç³»ç»Ÿé»˜è®¤</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">æäº¤æ—¥æœŸ</label>
                        <input type="date" id="submit_date" name="submit_date" class="form-control" value="{% now 'Y-m-d' %}" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                        <small class="form-text text-muted">å½“å¤©</small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field">é¡¹ç›®ç¼–å·</label>
                        {{ form.project_number }}
                        {% if form.project_number.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.project_number.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">YYYY-ç³»ç»Ÿè‡ªåŠ¨å››ä½è¿æ¥ç¼–å·ï¼Œä¸å¾—é‡å¤</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field">é¡¹ç›®åç§°</label>
                        {{ form.project_name }}
                        {% if form.project_name.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.project_name.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">é¡¹ç›®ä¸šæ€</label>
                        <select id="project_business_type" name="project_business_type" class="form-select">
                            <option value="">-- è¯·é€‰æ‹©é¡¹ç›®ä¸šæ€ --</option>
                            {% for business_type in business_types %}
                            <option value="{{ business_type.id }}">{{ business_type.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">åå°å¼•å…¥</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">åˆåŒæš‚å®šä»·æ¬¾</label>
                        <input type="number" id="provisional_price" name="provisional_price" class="form-control" step="0.01" placeholder="0.00">
                        <small class="form-text text-muted">å•ä½ï¼šå…ƒ</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- äºŒã€ä¸»ä½“ä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ä¸»ä½“ä¿¡æ¯</h5>
            </div>
            
            <!-- å®¢æˆ·æ–¹ä¿¡æ¯ -->
            <div style="margin-bottom: 24px;">
                <h6 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1f2937;">å®¢æˆ·æ–¹ä¿¡æ¯</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label required-field">å®¢æˆ·å…¬å¸</label>
                            {{ form.client }}
                            {% if form.client.errors %}
                            <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.client.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">æ ¹æ®å®¢æˆ·ç®¡ç†</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </label>
                            <input type="text" id="client_credit_code" name="client_credit_code" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="è‡ªåŠ¨å¸¦å…¥">
                            <small class="form-text text-muted">è‡ªåŠ¨å¸¦å…¥ï¼Œå®¢æˆ·ç®¡ç†</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">æ³•å®šä»£è¡¨äºº</label>
                            <input type="text" id="client_legal_representative" name="client_legal_representative" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="è‡ªåŠ¨å¸¦å…¥">
                            <small class="form-text text-muted">è‡ªåŠ¨å¸¦å…¥ï¼Œå®¢æˆ·ç®¡ç†</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®ä»£è¡¨</label>
                            <select id="client_project_representative" name="client_project_representative" class="form-select">
                                <option value="">-- è¯·é€‰æ‹©é¡¹ç›®ä»£è¡¨ --</option>
                            </select>
                            <small class="form-text text-muted">é€‰æ‹©ï¼Œå®¢æˆ·ç®¡ç†</small>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">è”ç³»æ–¹å¼</label>
                            <input type="text" id="client_contact" name="client_contact" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="è‡ªåŠ¨å¸¦å…¥">
                            <small class="form-text text-muted">è‡ªåŠ¨å¸¦å…¥ï¼Œå®¢æˆ·ç®¡ç†</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æˆ‘æ–¹ä¿¡æ¯ -->
            <div>
                <h6 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1f2937;">æˆ‘æ–¹ä¿¡æ¯</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">æˆ‘æ–¹ç­¾çº¦ä¸»ä½“</label>
                            <select id="our_signing_party" name="our_signing_party" class="form-select">
                                                                                        <option value="">-- è¯·é€‰æ‹©æˆ‘æ–¹ç­¾çº¦ä¸»ä½“ --</option></select>
                            <small class="form-text text-muted">é€‰æ‹©ï¼Œåå°å¼•å…¥</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®è´Ÿè´£äºº</label>
                            <select id="project_manager" name="project_manager" class="form-select">
                                                            <option value="">-- è¯·é€‰æ‹©é¡¹ç›®è´Ÿè´£äºº --</option>
                            {% for manager in project_managers %}
                            <option value="{{ manager.id }}">{{ manager.get_full_name|default:manager.username }}</option>
                            {% endfor %}</select>
                            <small class="form-text text-muted">é€‰æ‹©</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">å•†åŠ¡è´Ÿè´£äºº</label>
                            <select id="business_manager" name="business_manager" class="form-select">
                                                            <option value="">-- è¯·é€‰æ‹©å•†åŠ¡è´Ÿè´£äºº --</option>
                            {% for manager in business_managers %}
                            <option value="{{ manager.id }}" {% if manager.id == user.id %}selected{% endif %}>{{ manager.get_full_name|default:manager.username }}</option>
                            {% endfor %}</select>
                            <small class="form-text text-muted">é€‰æ‹©ï¼Œé»˜è®¤</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¸‰ã€åˆåŒä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>åˆåŒä¿¡æ¯</h5>
            </div>
            <!-- åˆåŒåç§° -->
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field" for="{{ form.contract_name.id_for_label }}">{{ form.contract_name.label }}</label>
                        {{ form.contract_name }}
                        {% if form.contract_name.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_name.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <!-- åˆåŒç¼–å· -->
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">åˆåŒç¼–å·</label>
                        <input type="text" id="contract_number_display" name="contract_number_display" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="HT+é¡¹ç›®ç¼–å·">
                        <small class="form-text text-muted">HT+é¡¹ç›®ç¼–å·ï¼Œè‡ªåŠ¨ç”Ÿæˆ</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.contract_type.id_for_label }}">{{ form.contract_type.label }}</label>
                        {{ form.contract_type }}
                        {% if form.contract_type.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_type.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">åå°ç®¡ç†å¼•å…¥</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">çº¦å®šç®¡è¾–</label>
                        <select id="governing_law" name="governing_law" class="form-select">
                            <option value="">-- è¯·é€‰æ‹©çº¦å®šç®¡è¾– --</option>
                            {% for value, label in governing_law_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <!-- å…³è”å•†æœºï¼ˆä¿ç•™ï¼Œä½†ç§»åˆ°åˆåŒä¿¡æ¯éƒ¨åˆ†ï¼‰ -->
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field" for="{{ form.opportunity.id_for_label }}">{{ form.opportunity.label }}</label>
                        {{ form.opportunity }}
                        {% if form.opportunity.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.opportunity.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3" id="parent-contract-row-wrapper" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.parent_contract.id_for_label }}">{{ form.parent_contract.label }}</label>
                        {{ form.parent_contract }}
                        {% if form.parent_contract.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.parent_contract.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">åˆåŒä»·æ ¼</label>
                        <input type="text" id="contract_price" name="contract_price" class="form-control" value="" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="æ ¹æ®ç»“ç®—æ–¹å¼è‡ªåŠ¨è®¡ç®—">
                        <small class="form-text text-muted">æ ¹æ®ç»“ç®—æ–¹å¼è‡ªåŠ¨è®¡ç®—ï¼Œä¸å¯æ‰‹åŠ¨ä¿®æ”¹</small>
                    </div>
                </div>
                </div>
            </div>
            <!-- åˆåŒçŠ¶æ€ï¼ˆéšè—å­—æ®µï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨åˆ¤æ–­ï¼‰ -->
            {{ form.status }}
        </div>
        
        <!-- ç­¾çº¦ä¸»ä½“ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ğŸ‘¥ ç­¾çº¦ä¸»ä½“</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="parties-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">åºå·</th>
                            <th style="width: 100px;">å•ä½ç±»å‹ <span class="text-danger">*</span></th>
                            <th style="width: 180px;">å•ä½åç§° <span class="text-danger">*</span></th>
                            <th style="width: 150px;">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </th>
                            <th style="width: 120px;">æ³•å®šä»£è¡¨äºº</th>
                            <th style="width: 120px;">é¡¹ç›®è´Ÿè´£äºº</th>
                            <th style="width: 120px;">è”ç³»ç”µè¯</th>
                            <th style="width: 150px;">è”ç³»é‚®ç®±</th>
                            <th style="width: 200px;">åŠå…¬åœ°å€</th>
                            <th style="width: 80px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="parties-container">
                        <!-- ç­¾çº¦ä¸»ä½“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 16px; text-align: left;">
                <button type="button" class="btn btn-sm btn-primary" id="add-party-btn">
                    <i class="bi bi-plus-circle"></i> æ·»åŠ ç­¾çº¦ä¸»ä½“
                </button>
            </div>
        </div>

        </div>

        <!-- å››ã€æœåŠ¡ä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>æœåŠ¡ä¿¡æ¯</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="service-contents-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px;">åºå·</th>
                            <th style="width: 150px;">æœåŠ¡ç±»å‹ <span class="text-danger">*</span></th>
                            <th style="width: 120px;">æœåŠ¡ä¸“ä¸š <span class="text-danger">*</span></th>
                            <th style="width: 200px;">æˆæœæ¸…å•</th>
                            <th style="width: 80px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="service-contents-container">
                        <!-- æœåŠ¡ä¿¡æ¯åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 16px; text-align: left;">
                <button type="button" class="btn btn-sm btn-primary" id="add-service-content-btn">
                    <i class="bi bi-plus-circle"></i> æ·»åŠ æœåŠ¡ä¿¡æ¯
                </button>
            </div>
        </div>


        <!-- äº”ã€ä»·æ¬¾ä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ä»·æ¬¾ä¿¡æ¯</h5>
            </div>
            
            <!-- ç»“ç®—æ–¹å¼é€‰æ‹© -->
            <div class="row" style="margin-bottom: 20px;">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ç»“ç®—æ–¹å¼</label>
                        <select id="settlement_method" name="settlement_method" class="form-select">
                            <option value="">-- è¯·é€‰æ‹©ç»“ç®—æ–¹å¼ --</option>
                            {% for method in settlement_methods %}
                            <option value="{{ method.code }}" data-name="{{ method.name }}">{{ method.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">åå°å¼•å…¥ï¼Œæœªé€‰æ‹©æ—¶éšè—åˆ—è¡¨</small>
                    </div>
                </div>
            </div>
            
            <!-- æ ¹æ®ç»“ç®—æ–¹å¼æ˜¾ç¤ºä¸åŒçš„åˆ—è¡¨ -->
            <!-- åŒ…å¹²æ€»ä»·åˆ—è¡¨ -->
            <div id="fixed-total-list" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;">åºå·</th>
                                <th style="width: 150px;">é¢ç§¯è§„æ¨¡</th>
                                <th style="width: 120px;">é¢ç§¯ç±»å‹</th>
                                <th style="width: 150px;">æœåŠ¡è´¹</th>
                            </tr>
                        </thead>
                        <tbody id="fixed-total-container">
                            <!-- åŒ…å¹²æ€»ä»·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 16px; text-align: left;">
                    <button type="button" class="btn btn-sm btn-primary" id="add-fixed-total-btn">
                        <i class="bi bi-plus-circle"></i> å¢åŠ è¡Œ
                    </button>
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <strong>å°è®¡ï¼š<span id="fixed-total-subtotal">0.00</span> å…ƒ</strong>
                </div>
            </div>
            
            <!-- åŒ…å¹²å•ä»·åˆ—è¡¨ -->
            <div id="fixed-unit-list" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;">åºå·</th>
                                <th style="width: 150px;">æœåŠ¡ç±»å‹</th>
                                <th style="width: 120px;">é¢ç§¯è§„æ¨¡</th>
                                <th style="width: 120px;">é¢ç§¯ç±»å‹</th>
                                <th style="width: 120px;">åŒ…å¹²å•ä»·</th>
                                <th style="width: 150px;">æœåŠ¡è´¹</th>
                                <th style="width: 80px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="fixed-unit-container">
                            <!-- åŒ…å¹²å•ä»·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 16px; text-align: left;">
                    <button type="button" class="btn btn-sm btn-primary" id="add-fixed-unit-btn">
                        <i class="bi bi-plus-circle"></i> å¢åŠ è¡Œ
                    </button>
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <strong>å°è®¡ï¼š<span id="fixed-unit-subtotal">0.00</span> å…ƒ</strong>
                </div>
            </div>
            
            <!-- ç´¯è®¡ææˆåˆ—è¡¨ -->
            <div id="cumulative-commission-list" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;">åºå·</th>
                                <th style="width: 150px;">æœåŠ¡ç±»å‹</th>
                                <th style="width: 120px;">é¢ç§¯è§„æ¨¡</th>
                                <th style="width: 120px;">é¢ç§¯ç±»å‹</th>
                                <th style="width: 120px;">ç´¯è®¡ææˆç³»æ•°</th>
                                <th style="width: 120px;">ç»¼åˆè°ƒæ•´ç³»æ•°</th>
                                <th style="width: 150px;">æœåŠ¡è´¹</th>
                                <th style="width: 80px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="cumulative-commission-container">
                            <!-- ç´¯è®¡ææˆåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 16px; text-align: left;">
                    <button type="button" class="btn btn-sm btn-primary" id="add-cumulative-commission-btn">
                        <i class="bi bi-plus-circle"></i> å¢åŠ è¡Œ
                    </button>
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <strong>å°è®¡ï¼š<span id="cumulative-commission-subtotal">0.00</span> å…ƒ</strong>
                </div>
            </div>
            
            <!-- åˆ†æ®µææˆåˆ—è¡¨ -->
            <div id="segmented-commission-list" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;">åºå·</th>
                                <th style="width: 150px;">æœåŠ¡ç±»å‹</th>
                                <th style="width: 120px;">é¢ç§¯è§„æ¨¡</th>
                                <th style="width: 120px;">é¢ç§¯ç±»å‹</th>
                                <th style="width: 120px;">åŒºé—´é‡‘é¢</th>
                                <th style="width: 120px;">åŒºé—´ææˆç³»æ•°</th>
                                <th style="width: 120px;">ç»¼åˆè°ƒæ•´ç³»æ•°</th>
                                <th style="width: 150px;">æœåŠ¡è´¹</th>
                                <th style="width: 80px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="segmented-commission-container">
                            <!-- åˆ†æ®µææˆåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 16px; text-align: left;">
                    <button type="button" class="btn btn-sm btn-primary" id="add-segmented-commission-btn">
                        <i class="bi bi-plus-circle"></i> å¢åŠ è¡Œ
                    </button>
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <strong>å°è®¡ï¼š<span id="segmented-commission-subtotal">0.00</span> å…ƒ</strong>
                </div>
            </div>
            
            <!-- è·³ç‚¹ææˆåˆ—è¡¨ -->
            <div id="jump-point-commission-list" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;">åºå·</th>
                                <th style="width: 150px;">æœåŠ¡ç±»å‹</th>
                                <th style="width: 120px;">é¢ç§¯è§„æ¨¡</th>
                                <th style="width: 120px;">é¢ç§¯ç±»å‹</th>
                                <th style="width: 120px;">è·³ç‚¹é‡‘é¢</th>
                                <th style="width: 120px;">è·³ç‚¹ææˆç³»æ•°</th>
                                <th style="width: 120px;">ç»¼åˆè°ƒæ•´ç³»æ•°</th>
                                <th style="width: 150px;">æœåŠ¡è´¹</th>
                                <th style="width: 80px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="jump-point-commission-container">
                            <!-- è·³ç‚¹ææˆåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 16px; text-align: left;">
                    <button type="button" class="btn btn-sm btn-primary" id="add-jump-point-commission-btn">
                        <i class="bi bi-plus-circle"></i> å¢åŠ è¡Œ
                    </button>
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <strong>å°è®¡ï¼š<span id="jump-point-commission-subtotal">0.00</span> å…ƒ</strong>
                </div>
            </div>
            
            <!-- æ€»è®¡å’Œå°é¡¶è´¹ -->
            <div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #e5e7eb;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">å°é¡¶è´¹</label>
                            <select id="cap_fee_type" name="cap_fee_type" class="form-select" style="margin-bottom: 8px;">
                                <option value="no_cap">æ— </option>
                                <option value="amount">é‡‘é¢</option>
                            </select>
                            <input type="number" id="cap_fee_amount" name="cap_fee_amount" class="form-control" step="0.01" placeholder="0.00" style="display: none;">
                            <small class="form-text text-muted">å•ä½ï¼šå…ƒ</small>
                        </div>
                    </div>
                    <div class="col-md-6" style="text-align: right; padding-top: 32px;">
                        <div>
                            <strong style="font-size: 18px;">æ€»è®¡ï¼š<span id="price-total">0.00</span> å…ƒ</strong>
                        </div>
                        <div style="margin-top: 8px;">
                            <strong style="font-size: 18px; color: #ef4444;">åˆåŒä»·æ¬¾ï¼š<span id="contract-price-final">0.00</span> å…ƒ</strong>
                        </div>
                        <small class="form-text text-muted">åˆåŒä»·æ¬¾ = max(æ€»è®¡ï¼Œå°é¡¶è´¹)</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¸ƒã€å›æ¬¾ä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>å›æ¬¾ä¿¡æ¯</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="payment-info-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">åºå·</th>
                            <th style="width: 120px;">æ¬¾é¡¹åç§°</th>
                            <th style="width: 150px;">è§¦å‘èŠ‚ç‚¹ <span class="text-danger">*</span></th>
                            <th style="width: 150px;">ä»˜æ¬¾æ–¹å¼ <span class="text-danger">*</span></th>
                            <th style="width: 150px;">å›æ¬¾é‡‘é¢ï¼ˆå…ƒï¼‰</th>
                            <th style="width: 200px;">ä»˜æ¬¾æ¡ä»¶</th>
                            <th style="width: 80px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="payment-info-container">
                        <!-- å›æ¬¾ä¿¡æ¯åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 16px; text-align: left;">
                <button type="button" class="btn btn-sm btn-primary" id="add-payment-info-btn">
                    <i class="bi bi-plus-circle"></i> æ·»åŠ å›æ¬¾ä¿¡æ¯
                </button>
            </div>
        </div>
        <!-- æäº¤æŒ‰é’® -->
        <div class="form-group" style="margin-top: 32px;">
            <button type="submit" class="btn btn-primary">ä¿å­˜åˆåŒ</button>
            <a href="{% url 'business_pages:contract_management_list' %}" class="btn btn-secondary">å–æ¶ˆ</a>
        </div>
    </form>

<script>
    // ========== æœåŠ¡ä¿¡æ¯æ•°æ®å®šä¹‰ ==========
    // æœåŠ¡ä¸“ä¸šæ•°æ®ï¼ˆä»åç«¯ä¼ é€’ï¼‰
    const serviceProfessionsData = [
        {% for sp in service_professions %}
        {id: {{ sp.id }}, name: {{ sp.name|escapejs }}, service_type_id: {{ sp.service_type_id|default:"null" }}},
        {% endfor %}
    ];
    
    // æˆæœæ¸…å•æ•°æ®ï¼ˆä»åç«¯ä¼ é€’ï¼‰
    const resultFileTypesData = [
        {% for rft in result_file_types %}
        {id: {{ rft.id }}, name: {{ rft.name|escapejs }}},
        {% endfor %}
    ];
    
document.addEventListener('DOMContentLoaded', function() {
        // ========== ç­¾çº¦ä¸»ä½“åˆ—è¡¨ç®¡ç† ==========
    let partyIndex = 0;
        // æ·»åŠ ç­¾çº¦ä¸»ä½“è¡Œ
    function addPartyRow(partyData = null) {
        // ç¡®ä¿å®¹å™¨å­˜åœ¨
        const container = document.getElementById('parties-container');
        if (!container) {
            console.error('parties-container æœªæ‰¾åˆ°ï¼Œæ— æ³•æ·»åŠ è¡Œ');
            return;
        }
        
        const index = partyIndex++;
        const party = partyData || {};
        
        const row = document.createElement('tr');
        row.className = 'party-row';
        row.setAttribute('data-party-index', index);
        
        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            row.innerHTML = `
            <td style="vertical-align: middle; text-align: center;">
                <strong>0</strong>
            </td>
            <td>
                <select name="parties[${index}][party_type]" class="form-select form-select-sm" required>
                    <option value="party_a" ${party.party_type === 'party_a' ? 'selected' : ''}>ç”²æ–¹</option>
                    <option value="party_b" ${party.party_type === 'party_b' ? 'selected' : ''}>ä¹™æ–¹</option>
                    <option value="party_c" ${party.party_type === 'party_c' ? 'selected' : ''}>ä¸™æ–¹</option>
                    <option value="other" ${party.party_type === 'other' ? 'selected' : ''}>å…¶ä»–</option>
                </select>
            </td>
            <td>
                <input type="text" name="parties[${index}][party_name]" class="form-control form-control-sm"
                       value="${(party.party_name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥å•ä½åç§°" required>
            </td>
            <td>
                <input type="text" name="parties[${index}][credit_code]" class="form-control form-control-sm"
                       value="${(party.credit_code || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ">
            </td>
            <td>
                <input type="text" name="parties[${index}][legal_representative]" class="form-control form-control-sm"
                       value="${(party.legal_representative || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥æ³•å®šä»£è¡¨äºº">
            </td>
            <td>
                <input type="text" name="parties[${index}][project_manager]" class="form-control form-control-sm"
                       value="${(party.project_manager || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥é¡¹ç›®è´Ÿè´£äºº">
            </td>
            <td>
                <input type="text" name="parties[${index}][contact_phone]" class="form-control form-control-sm"
                       value="${(party.contact_phone || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯">
            </td>
            <td>
                <input type="email" name="parties[${index}][contact_email]" class="form-control form-control-sm"
                       value="${(party.contact_email || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥è”ç³»é‚®ç®±">
            </td>
            <td>
                <input type="text" name="parties[${index}][address]" class="form-control form-control-sm"
                       value="${(party.address || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" 
                       placeholder="è¯·è¾“å…¥åŠå…¬åœ°å€">
            </td>
            <td style="vertical-align: middle; text-align: center;">
                <button type="button" class="btn btn-sm btn-danger remove-party-btn" data-index="${index}" title="åˆ é™¤">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        container.appendChild(row);
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        const removeBtn = row.querySelector('.remove-party-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                const currentRows = container.querySelectorAll('tr.party-row');
                if (currentRows.length <= 2) {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸¤è¡Œç­¾çº¦ä¸»ä½“ï¼ˆç”²æ–¹å’Œä¹™æ–¹ï¼‰');
                    return;
                }
                row.remove();
                updatePartyRowNumbers();
            });
        }
        
        // æ›´æ–°è¡Œç¼–å·
        updatePartyRowNumbers();
    }
    
    // æ›´æ–°ç­¾çº¦ä¸»ä½“è¡Œç¼–å·
    function updatePartyRowNumbers() {
        const rows = document.getElementById('parties-container').querySelectorAll('tr.party-row');
        rows.forEach((row, index) => {
            const numberCell = row.querySelector('td:first-child strong');
            if (numberCell) {
                numberCell.textContent = index + 1;
            }
        });
    }
    
    
    // åˆå§‹åŒ–ï¼šç¡®ä¿è‡³å°‘æœ‰ä¸¤è¡Œç­¾çº¦ä¸»ä½“ï¼ˆç”²æ–¹å’Œä¹™æ–¹ï¼‰
    function ensureMinTwoParties() {
        // è·å–å®¹å™¨
        const container = document.getElementById('parties-container');
        if (!container) {
            console.warn('parties-container å…ƒç´ æœªæ‰¾åˆ°ï¼Œç¨åé‡è¯•');
            return;
        }
        
        const currentRows = container.querySelectorAll('tr.party-row');
        const currentCount = currentRows.length;
        
        // ç¡®ä¿è‡³å°‘æœ‰ä¸¤è¡Œ
        if (currentCount === 0) {
            // å¦‚æœæ²¡æœ‰è¡Œï¼Œæ·»åŠ ä¸¤è¡Œï¼šç¬¬ä¸€è¡Œä¸ºç”²æ–¹ï¼Œç¬¬äºŒè¡Œä¸ºä¹™æ–¹
            try {
                addPartyRow({ party_type: 'party_a' });
                addPartyRow({ party_type: 'party_b' });
                // æ·»åŠ å®Œæˆåï¼Œæ›´æ–°è¡Œç¼–å·
                setTimeout(function() {
                    updatePartyRowNumbers();
                }, 50);
            } catch (e) {
                console.error('æ·»åŠ ç­¾çº¦ä¸»ä½“è¡Œå¤±è´¥:', e);
            }
        } else if (currentCount === 1) {
            // å¦‚æœåªæœ‰ä¸€è¡Œï¼Œå†æ·»åŠ ä¸€è¡Œï¼ˆé»˜è®¤ä¹™æ–¹ï¼‰
            try {
                addPartyRow({ party_type: 'party_b' });
                setTimeout(function() {
                    updatePartyRowNumbers();
                }, 50);
            } catch (e) {
                console.error('æ·»åŠ ç­¾çº¦ä¸»ä½“è¡Œå¤±è´¥:', e);
            }
        }
        // å¦‚æœå·²æœ‰ä¸¤è¡Œæˆ–æ›´å¤šï¼Œä¸éœ€è¦æ·»åŠ 
    }
    
        // ç»‘å®š"æ·»åŠ ç­¾çº¦ä¸»ä½“"æŒ‰é’®äº‹ä»¶
    const addPartyBtn = document.getElementById('add-party-btn');
    if (addPartyBtn) {
        addPartyBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            addPartyRow();
        });
    }
    
    // ========== å®¢æˆ·é€‰æ‹©åè‡ªåŠ¨å¡«å……å®¢æˆ·æ–¹ä¿¡æ¯ ==========
    const clientSelect = document.getElementById('id_client');
    const clientCreditCodeField = document.getElementById('client_credit_code');
    const clientLegalRepField = document.getElementById('client_legal_representative');
    const clientProjectRepField = document.getElementById('client_project_representative');
    const clientContactField = document.getElementById('client_contact');
    
    if (clientSelect) {
        // è·å–å®¢æˆ·æ•°æ®ï¼ˆä»åç«¯ä¼ é€’ï¼‰
        const clientDataMap = {};
        {% if clients %}
        {% for client in clients %}
        clientDataMap[{{ client.id }}] = {
            credit_code: {{ client.unified_credit_code|default:"''"|escapejs }},
            legal_representative: {{ client.legal_representative|default:"''"|escapejs }},
            contact: {{ client.company_phone|default:"''"|escapejs }},
            contacts: [
                {% for contact in client.contacts.all %}
                {id: {{ contact.id }}, name: {{ contact.name|default:"''"|escapejs }}, role: {{ contact.role|default:"''"|escapejs }}},
                {% endfor %}
            ]
        };
        {% endfor %}
        {% endif %}
        
        clientSelect.addEventListener('change', function() {
            const clientId = this.value;
            const clientData = clientDataMap[clientId];
            
            if (clientData) {
                // å¡«å……ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç 
                if (clientCreditCodeField) {
                    clientCreditCodeField.value = clientData.credit_code || '';
                }
                
                // å¡«å……æ³•å®šä»£è¡¨äºº
                if (clientLegalRepField) {
                    clientLegalRepField.value = clientData.legal_representative || '';
                }
                
                // å¡«å……è”ç³»æ–¹å¼
                if (clientContactField) {
                    clientContactField.value = clientData.contact || '';
                }
                
                // å¡«å……é¡¹ç›®ä»£è¡¨ä¸‹æ‹‰é€‰é¡¹
                if (clientProjectRepField) {
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªç©ºé€‰é¡¹ï¼‰
                    clientProjectRepField.innerHTML = '<option value="">-- è¯·é€‰æ‹©é¡¹ç›®ä»£è¡¨ --</option>';
                    
                    // æ·»åŠ å®¢æˆ·è”ç³»äººä½œä¸ºé¡¹ç›®ä»£è¡¨é€‰é¡¹
                    if (clientData.contacts && clientData.contacts.length > 0) {
                        clientData.contacts.forEach(function(contact) {
                            const option = document.createElement('option');
                            option.value = contact.id;
                            option.textContent = contact.name + (contact.role ? ' (' + contact.role + ')' : '');
                            clientProjectRepField.appendChild(option);
                        });
                    }
                }
            } else {
                // æ¸…ç©ºæ‰€æœ‰å­—æ®µ
                if (clientCreditCodeField) clientCreditCodeField.value = '';
                if (clientLegalRepField) clientLegalRepField.value = '';
                if (clientContactField) clientContactField.value = '';
                if (clientProjectRepField) {
                    clientProjectRepField.innerHTML = '<option value="">-- è¯·é€‰æ‹©é¡¹ç›®ä»£è¡¨ --</option>';
                }
            }
        });
    }
    
    // ========== åˆåŒç¼–å·è‡ªåŠ¨ç”Ÿæˆï¼ˆHT+é¡¹ç›®ç¼–å·ï¼‰ ==========
    const projectNumberField = document.getElementById('id_project_number');
    const contractNumberDisplayField = document.getElementById('contract_number_display');
    
    function updateContractNumber() {
        if (projectNumberField && contractNumberDisplayField) {
            const projectNumber = projectNumberField.value;
            if (projectNumber) {
                contractNumberDisplayField.value = 'HT' + projectNumber;
            } else {
                contractNumberDisplayField.value = '';
            }
        }
    }
    
    if (projectNumberField) {
        projectNumberField.addEventListener('input', updateContractNumber);
        projectNumberField.addEventListener('change', updateContractNumber);
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡
        setTimeout(updateContractNumber, 100);
    }
    
    // ========== ç»“ç®—æ–¹å¼é€‰æ‹©åæ˜¾ç¤º/éšè—ä¸åŒåˆ—è¡¨ ==========
    const settlementMethodSelect = document.getElementById('settlement_method');
    const fixedTotalList = document.getElementById('fixed-total-list');
    const fixedUnitList = document.getElementById('fixed-unit-list');
    const cumulativeCommissionList = document.getElementById('cumulative-commission-list');
    const segmentedCommissionList = document.getElementById('segmented-commission-list');
    const jumpPointCommissionList = document.getElementById('jump-point-commission-list');
    
    function showSettlementMethodList(methodCode) {
        // éšè—æ‰€æœ‰åˆ—è¡¨
        if (fixedTotalList) fixedTotalList.style.display = 'none';
        if (fixedUnitList) fixedUnitList.style.display = 'none';
        if (cumulativeCommissionList) cumulativeCommissionList.style.display = 'none';
        if (segmentedCommissionList) segmentedCommissionList.style.display = 'none';
        if (jumpPointCommissionList) jumpPointCommissionList.style.display = 'none';
        
        // æ ¹æ®ç»“ç®—æ–¹å¼æ˜¾ç¤ºå¯¹åº”åˆ—è¡¨
        if (methodCode) {
            // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„ç»“ç®—æ–¹å¼ä»£ç æ¥åŒ¹é…
            // å‡è®¾ï¼šfixed_total=åŒ…å¹²æ€»ä»·, fixed_unit=åŒ…å¹²å•ä»·, cumulative=ç´¯è®¡ææˆ, segmented=åˆ†æ®µææˆ, jump_point=è·³ç‚¹ææˆ
            if (methodCode.includes('åŒ…å¹²æ€»ä»·') || methodCode.includes('fixed_total')) {
                if (fixedTotalList) fixedTotalList.style.display = 'block';
            } else if (methodCode.includes('åŒ…å¹²å•ä»·') || methodCode.includes('fixed_unit')) {
                if (fixedUnitList) fixedUnitList.style.display = 'block';
            } else if (methodCode.includes('ç´¯è®¡ææˆ') || methodCode.includes('cumulative')) {
                if (cumulativeCommissionList) cumulativeCommissionList.style.display = 'block';
            } else if (methodCode.includes('åˆ†æ®µææˆ') || methodCode.includes('segmented')) {
                if (segmentedCommissionList) segmentedCommissionList.style.display = 'block';
            } else if (methodCode.includes('è·³ç‚¹ææˆ') || methodCode.includes('jump_point')) {
                if (jumpPointCommissionList) jumpPointCommissionList.style.display = 'block';
            }
        }
    }
    
    if (settlementMethodSelect) {
        settlementMethodSelect.addEventListener('change', function() {
            const methodCode = this.value;
            const selectedOption = this.options[this.selectedIndex];
            const methodName = selectedOption ? selectedOption.textContent : '';
            showSettlementMethodList(methodCode || methodName);
        });
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡
        setTimeout(function() {
            if (settlementMethodSelect.value) {
                showSettlementMethodList(settlementMethodSelect.value);
            }
        }, 100);
    }
    
    // ========== ä»·æ¬¾ä¿¡æ¯è®¡ç®—é€»è¾‘ ==========
    
    // è®¡ç®—åŒ…å¹²æ€»ä»·å°è®¡
    function calculateFixedTotalSubtotal() {
        const container = document.getElementById('fixed-total-container');
        if (!container) return 0;
        
        const rows = container.querySelectorAll('tr');
        let subtotal = 0;
        rows.forEach(function(row) {
            const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
            if (serviceFeeInput) {
                subtotal += parseFloat(serviceFeeInput.value) || 0;
            }
        });
        
        const subtotalElement = document.getElementById('fixed-total-subtotal');
        if (subtotalElement) {
            subtotalElement.textContent = subtotal.toFixed(2);
        }
        
        return subtotal;
    }
    
    // è®¡ç®—åŒ…å¹²å•ä»·å°è®¡
    function calculateFixedUnitSubtotal() {
        const container = document.getElementById('fixed-unit-container');
        if (!container) return 0;
        
        const rows = container.querySelectorAll('tr');
        let subtotal = 0;
        rows.forEach(function(row) {
            const areaInput = row.querySelector('input[name*="[area_size]"]');
            const unitPriceInput = row.querySelector('input[name*="[unit_price]"]');
            const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
            
            if (areaInput && unitPriceInput && serviceFeeInput) {
                const area = parseFloat(areaInput.value) || 0;
                const unitPrice = parseFloat(unitPriceInput.value) || 0;
                const serviceFee = area * unitPrice;
                serviceFeeInput.value = serviceFee.toFixed(2);
                subtotal += serviceFee;
            }
        });
        
        const subtotalElement = document.getElementById('fixed-unit-subtotal');
        if (subtotalElement) {
            subtotalElement.textContent = subtotal.toFixed(2);
        }
        
        return subtotal;
    }
    
    // è®¡ç®—ç´¯è®¡ææˆå°è®¡
    function calculateCumulativeCommissionSubtotal() {
        const container = document.getElementById('cumulative-commission-container');
        if (!container) return 0;
        
        const rows = container.querySelectorAll('tr');
        let subtotal = 0;
        rows.forEach(function(row) {
            const areaInput = row.querySelector('input[name*="[area_size]"]');
            const coefficientInput = row.querySelector('input[name*="[commission_coefficient]"]');
            const adjustmentInput = row.querySelector('input[name*="[adjustment_coefficient]"]');
            const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
            
            if (areaInput && coefficientInput && adjustmentInput && serviceFeeInput) {
                const area = parseFloat(areaInput.value) || 0;
                const coefficient = parseFloat(coefficientInput.value) || 0;
                const adjustment = parseFloat(adjustmentInput.value) || 0;
                // æœåŠ¡è´¹ = é¢ç§¯è§„æ¨¡ * 25å…ƒ/å¹³æ–¹ç±³ * ç´¯è®¡ææˆç³»æ•° * ç»¼åˆè°ƒæ•´ç³»æ•°
                const serviceFee = area * 25 * coefficient * adjustment;
                serviceFeeInput.value = serviceFee.toFixed(2);
                subtotal += serviceFee;
            }
        });
        
        const subtotalElement = document.getElementById('cumulative-commission-subtotal');
        if (subtotalElement) {
            subtotalElement.textContent = subtotal.toFixed(2);
        }
        
        return subtotal;
    }
    
    // è®¡ç®—åˆ†æ®µææˆå°è®¡
    function calculateSegmentedCommissionSubtotal() {
        const container = document.getElementById('segmented-commission-container');
        if (!container) return 0;
        
        const rows = container.querySelectorAll('tr');
        let subtotal = 0;
        rows.forEach(function(row) {
            const intervalAmountInput = row.querySelector('input[name*="[interval_amount]"]');
            const coefficientInput = row.querySelector('input[name*="[commission_coefficient]"]');
            const adjustmentInput = row.querySelector('input[name*="[adjustment_coefficient]"]');
            const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
            
            if (intervalAmountInput && coefficientInput && adjustmentInput && serviceFeeInput) {
                const intervalAmount = parseFloat(intervalAmountInput.value) || 0;
                const coefficient = parseFloat(coefficientInput.value) || 0;
                const adjustment = parseFloat(adjustmentInput.value) || 0;
                // æœåŠ¡è´¹ = åŒºé—´é‡‘é¢ * åŒºé—´ææˆç³»æ•° * ç»¼åˆè°ƒæ•´ç³»æ•°
                const serviceFee = intervalAmount * coefficient * adjustment;
                serviceFeeInput.value = serviceFee.toFixed(2);
                subtotal += serviceFee;
            }
        });
        
        const subtotalElement = document.getElementById('segmented-commission-subtotal');
        if (subtotalElement) {
            subtotalElement.textContent = subtotal.toFixed(2);
        }
        
        return subtotal;
    }
    
    // è®¡ç®—è·³ç‚¹ææˆå°è®¡
    function calculateJumpPointCommissionSubtotal() {
        const container = document.getElementById('jump-point-commission-container');
        if (!container) return 0;
        
        const rows = container.querySelectorAll('tr');
        let subtotal = 0;
        rows.forEach(function(row) {
            const areaInput = row.querySelector('input[name*="[area_size]"]');
            const coefficientInput = row.querySelector('input[name*="[commission_coefficient]"]');
            const adjustmentInput = row.querySelector('input[name*="[adjustment_coefficient]"]');
            const jumpAmountInput = row.querySelector('input[name*="[jump_amount]"]');
            const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
            
            if (areaInput && coefficientInput && adjustmentInput && serviceFeeInput) {
                const area = parseFloat(areaInput.value) || 0;
                // è·³ç‚¹é‡‘é¢ = é¢ç§¯è§„æ¨¡ * 25å…ƒ/å¹³æ–¹ç±³ï¼ˆç³»ç»Ÿè‡ªåŠ¨è®¡ç®—ï¼‰
                const jumpAmount = area * 25;
                if (jumpAmountInput) {
                    jumpAmountInput.value = jumpAmount.toFixed(2);
                }
                
                const coefficient = parseFloat(coefficientInput.value) || 0;
                const adjustment = parseFloat(adjustmentInput.value) || 0;
                // æœåŠ¡è´¹ = è·³ç‚¹é‡‘é¢ * è·³ç‚¹ææˆç³»æ•° * ç»¼åˆè°ƒæ•´ç³»æ•°
                const serviceFee = jumpAmount * coefficient * adjustment;
                serviceFeeInput.value = serviceFee.toFixed(2);
                subtotal += serviceFee;
            }
        });
        
        const subtotalElement = document.getElementById('jump-point-commission-subtotal');
        if (subtotalElement) {
            subtotalElement.textContent = subtotal.toFixed(2);
        }
        
        return subtotal;
    }
    
    // è®¡ç®—æ€»è®¡å’ŒåˆåŒä»·æ¬¾
    function calculatePriceTotal() {
        const settlementMethod = document.getElementById('settlement_method');
        if (!settlementMethod || !settlementMethod.value) {
            document.getElementById('price-total').textContent = '0.00';
            document.getElementById('contract-price-final').textContent = '0.00';
            return;
        }
        
        const methodValue = settlementMethod.value;
        let total = 0;
        
        // æ ¹æ®ç»“ç®—æ–¹å¼è®¡ç®—æ€»è®¡
        if (methodValue.includes('åŒ…å¹²æ€»ä»·') || methodValue.includes('fixed_total')) {
            total = calculateFixedTotalSubtotal();
        } else if (methodValue.includes('åŒ…å¹²å•ä»·') || methodValue.includes('fixed_unit')) {
            total = calculateFixedUnitSubtotal();
        } else if (methodValue.includes('ç´¯è®¡ææˆ') || methodValue.includes('cumulative')) {
            total = calculateCumulativeCommissionSubtotal();
        } else if (methodValue.includes('åˆ†æ®µææˆ') || methodValue.includes('segmented')) {
            total = calculateSegmentedCommissionSubtotal();
        } else if (methodValue.includes('è·³ç‚¹ææˆ') || methodValue.includes('jump_point')) {
            total = calculateJumpPointCommissionSubtotal();
        }
        
        // æ›´æ–°æ€»è®¡
        const totalElement = document.getElementById('price-total');
        if (totalElement) {
            totalElement.textContent = total.toFixed(2);
        }
        
        // è®¡ç®—å°é¡¶è´¹
        const capFeeType = document.getElementById('cap_fee_type');
        const capFeeAmount = document.getElementById('cap_fee_amount');
        let capFee = 0;
        if (capFeeType && capFeeType.value === 'amount' && capFeeAmount) {
            capFee = parseFloat(capFeeAmount.value) || 0;
        }
        
        // åˆåŒä»·æ¬¾ = max(æ€»è®¡ï¼Œå°é¡¶è´¹)
        const contractPrice = Math.max(total, capFee);
        const contractPriceElement = document.getElementById('contract-price-final');
        if (contractPriceElement) {
            contractPriceElement.textContent = contractPrice.toFixed(2);
        }
        
        // æ›´æ–°éšè—çš„åˆåŒä»·æ¬¾å­—æ®µ
        const contractPriceInput = document.getElementById('contract_price');
        if (contractPriceInput) {
            contractPriceInput.value = contractPrice.toFixed(2);
        }
    }
    
    // ç»‘å®šå°é¡¶è´¹å˜åŒ–äº‹ä»¶
    const capFeeTypeSelect = document.getElementById('cap_fee_type');
    const capFeeAmountInput = document.getElementById('cap_fee_amount');
    
    if (capFeeTypeSelect) {
        capFeeTypeSelect.addEventListener('change', function() {
            if (this.value === 'amount' && capFeeAmountInput) {
                capFeeAmountInput.style.display = 'block';
            } else if (capFeeAmountInput) {
                capFeeAmountInput.style.display = 'none';
                capFeeAmountInput.value = '';
            }
            calculatePriceTotal();
        });
    }
    
    if (capFeeAmountInput) {
        capFeeAmountInput.addEventListener('input', function() {
            calculatePriceTotal();
        });
    }
    
    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡è®¡ç®—
    setTimeout(calculatePriceTotal, 300);
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ï¼ˆå¤šæ¬¡å°è¯•ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½ï¼‰
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡    // ========== å›æ¬¾ä¿¡æ¯åˆ—è¡¨ç®¡ç† ==========
    let paymentInfoIndex = 0;
    
    // æ·»åŠ å›æ¬¾ä¿¡æ¯è¡Œ
        function addPaymentInfoRow(paymentData = null) {
        const container = document.getElementById('payment-info-container');
        if (!container) {
            console.error('payment-info-container æœªæ‰¾åˆ°ï¼Œæ— æ³•æ·»åŠ è¡Œ');
            return;
        }
        
        const index = paymentInfoIndex++;
        const payment = paymentData || {};
        
        const row = document.createElement('tr');
        row.className = 'payment-info-row';
        row.setAttribute('data-payment-index', index);
        
        row.innerHTML = `
            <td style="vertical-align: middle; text-align: center;">
                <strong>0</strong>
            </td>
            <td>
                <select name="payment_info[${index}][payment_name]" class="form-select form-select-sm">
                    <option value="">-- è¯·é€‰æ‹©æ¬¾é¡¹åç§° --</option>
                    <option value="é¦–ä»˜æ¬¾" ${payment.payment_name === 'é¦–ä»˜æ¬¾' ? 'selected' : ''}>é¦–ä»˜æ¬¾</option>
                    <option value="è¿›åº¦æ¬¾" ${payment.payment_name === 'è¿›åº¦æ¬¾' ? 'selected' : ''}>è¿›åº¦æ¬¾</option>
                    <option value="åˆå®¡æ¬¾" ${payment.payment_name === 'åˆå®¡æ¬¾' ? 'selected' : ''}>åˆå®¡æ¬¾</option>
                    <option value="ç»“ç®—æ¬¾" ${payment.payment_name === 'ç»“ç®—æ¬¾' ? 'selected' : ''}>ç»“ç®—æ¬¾</option>
                    <option value="å°¾æ¬¾" ${payment.payment_name === 'å°¾æ¬¾' ? 'selected' : ''}>å°¾æ¬¾</option>
                </select>
            </td>
            <td>
                <input type="text" name="payment_info[${index}][trigger_node]" class="form-control form-control-sm" 
                       value="${payment.trigger_node || ''}" 
                       placeholder="è§¦å‘èŠ‚ç‚¹" required>
            </td>
            <td>
                <select name="payment_info[${index}][payment_method]" class="form-select form-select-sm payment-method" required>
                    <option value="">-- è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼ --</option>
                    <option value="fixed_amount" ${payment.payment_method === 'fixed_amount' ? 'selected' : ''}>å›ºå®šé‡‘é¢</option>
                    <option value="ratio_payment" ${payment.payment_method === 'ratio_payment' ? 'selected' : ''}>æŒ‰æ¯”ä¾‹æ”¯ä»˜</option>
                    <option value="actual_payment" ${payment.payment_method === 'actual_payment' ? 'selected' : ''}>æŒ‰å®æ”¯ä»˜</option>
                </select>
            </td>
            <td>
                <input type="number" name="payment_info[${index}][payment_amount]" class="form-control form-control-sm payment-amount"
                       value="${payment.payment_amount || ''}" 
                       placeholder="0.00" step="0.01" min="0" readonly>
                <input type="number" name="payment_info[${index}][fixed_amount]" class="form-control form-control-sm fixed-amount-input" 
                       style="display: none; margin-top: 4px;"
                       placeholder="å›ºå®šé‡‘é¢" step="0.01" min="0">
                <input type="number" name="payment_info[${index}][payment_ratio]" class="form-control form-control-sm payment-ratio-input" 
                       style="display: none; margin-top: 4px;"
                       placeholder="æ¯”ä¾‹ï¼ˆ%ï¼‰" step="0.01" min="0" max="100">
            </td>
            <td>
                <textarea name="payment_info[${index}][payment_condition]" class="form-control form-control-sm" 
                          rows="2" placeholder="ä»˜æ¬¾æ¡ä»¶">${payment.payment_condition || ''}</textarea>
            </td>
            <td style="vertical-align: middle; text-align: center;">
                <button type="button" class="btn btn-sm btn-danger remove-payment-info-btn">
                    <i class="bi bi-trash"></i> åˆ é™¤
                </button>
            </td>
        `;
        
        container.appendChild(row);
        updatePaymentInfoRowNumbers();
        
        // ç»‘å®šä»˜æ¬¾æ–¹å¼å˜åŒ–äº‹ä»¶
        const paymentMethodSelect = row.querySelector('.payment-method');
        const paymentAmountField = row.querySelector('.payment-amount');
        const fixedAmountInput = row.querySelector('.fixed-amount-input');
        const paymentRatioInput = row.querySelector('.payment-ratio-input');
        
        if (paymentMethodSelect) {
            paymentMethodSelect.addEventListener('change', function() {
                const method = this.value;
                if (method === 'fixed_amount') {
                    if (fixedAmountInput) fixedAmountInput.style.display = 'block';
                    if (paymentRatioInput) paymentRatioInput.style.display = 'none';
                    calculatePaymentAmountForRow(row);
                } else if (method === 'ratio_payment') {
                    if (fixedAmountInput) fixedAmountInput.style.display = 'none';
                    if (paymentRatioInput) paymentRatioInput.style.display = 'block';
                    calculatePaymentAmountForRow(row);
                } else if (method === 'actual_payment') {
                    if (fixedAmountInput) fixedAmountInput.style.display = 'none';
                    if (paymentRatioInput) paymentRatioInput.style.display = 'none';
                    if (paymentAmountField) {
                        paymentAmountField.readOnly = false;
                        paymentAmountField.placeholder = 'æ‰‹å¡«é‡‘é¢';
                    }
                }
            });
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            if (paymentMethodSelect.value) {
                paymentMethodSelect.dispatchEvent(new Event('change'));
            }
        }
        
        // ç»‘å®šé‡‘é¢è¾“å…¥å˜åŒ–äº‹ä»¶
        if (fixedAmountInput) {
            fixedAmountInput.addEventListener('input', function() {
                calculatePaymentAmountForRow(row);
            });
        }
        if (paymentRatioInput) {
            paymentRatioInput.addEventListener('input', function() {
                calculatePaymentAmountForRow(row);
            });
        }
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        const removeBtn = row.querySelector('.remove-payment-info-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const currentRows = container.querySelectorAll('tr.payment-info-row');
                if (currentRows.length <= 1) {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡Œå›æ¬¾ä¿¡æ¯');
                    return;
                }
                row.remove();
                updatePaymentInfoRowNumbers();
            });
        }
    }
    
    // è®¡ç®—å•è¡Œå›æ¬¾é‡‘é¢
    function calculatePaymentAmountForRow(row) {
        const paymentMethodSelect = row.querySelector('.payment-method');
        const paymentAmountField = row.querySelector('.payment-amount');
        const fixedAmountInput = row.querySelector('.fixed-amount-input');
        const paymentRatioInput = row.querySelector('.payment-ratio-input');
        const provisionalPriceField = document.getElementById('provisional_price');
        
        if (!paymentMethodSelect || !paymentAmountField) return;
        
        const method = paymentMethodSelect.value;
        let amount = 0;
        
        if (method === 'fixed_amount' && fixedAmountInput) {
            amount = parseFloat(fixedAmountInput.value) || 0;
        } else if (method === 'ratio_payment' && paymentRatioInput && provisionalPriceField) {
            const ratio = parseFloat(paymentRatioInput.value) || 0;
            const provisionalPrice = parseFloat(provisionalPriceField.value) || 0;
            amount = provisionalPrice * (ratio / 100);
        }
        
        paymentAmountField.value = amount.toFixed(2);
    }
    

    function updatePaymentInfoRowNumbers() {
        const rows = document.getElementById('payment-info-container').querySelectorAll('tr.payment-info-row');
        rows.forEach(function(row, index) {
            const numberCell = row.querySelector('td:first-child strong');
            if (numberCell) {
                numberCell.textContent = index + 1;
            }
        });
    }
    
    // è®¡ç®—å›æ¬¾é‡‘é¢
    function calculatePaymentAmount(index) {
        const row = document.querySelector(`tr[data-payment-index="${index}"]`);
        if (!row) return;
        
        const ratioInput = row.querySelector('.payment-ratio');
        const amountInput = row.querySelector('.payment-amount');
        const basisSelect = row.querySelector('select[name*="[calculation_basis]"]');
        
        if (!ratioInput || !amountInput || !basisSelect) return;
        
        const ratio = parseFloat(ratioInput.value) || 0;
        const basis = basisSelect.value;
        
        // è·å–è®¡ç®—åŸºç¡€çš„å€¼
        let basisValue = 0;
        if (basis === 'contract_amount') {
            const contractAmountInput = document.getElementById('id_contract_amount');
            basisValue = parseFloat(contractAmountInput?.value) || 0;
        } else if (basis === 'tax_free_amount') {
            // è®¡ç®—ä¸å«ç¨é‡‘é¢
            const contractAmountInput = document.getElementById('id_contract_amount');
            const taxRateInput = document.getElementById('id_tax_rate');
            const contractAmount = parseFloat(contractAmountInput?.value) || 0;
            const taxRate = parseFloat(taxRateInput?.value) || 0;
            basisValue = contractAmount / (1 + taxRate / 100);
        } else if (basis === 'service_fee') {
            // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè·å–æœåŠ¡è´¹
            basisValue = 0; // æš‚æ—¶è®¾ä¸º0ï¼Œåç»­å¯ä»¥æ ¹æ®éœ€è¦å®ç°
        } else if (basis === 'fixed_amount') {
            // å›ºå®šé‡‘é¢ï¼Œç›´æ¥ä½¿ç”¨æ¯”ä¾‹ä½œä¸ºé‡‘é¢
            amountInput.value = ratio.toFixed(2);
            return;
        }
        
        // è®¡ç®—å›æ¬¾é‡‘é¢
        const amount = (basisValue * ratio / 100).toFixed(2);
        amountInput.value = amount;
    }
    
    // åˆå§‹åŒ–å›æ¬¾ä¿¡æ¯åˆ—è¡¨ï¼ˆè‡³å°‘ä¸€è¡Œï¼‰
    function ensureMinOnePaymentInfo() {
        const container = document.getElementById('payment-info-container');
        if (!container) return;
        
        const rows = container.querySelectorAll('tr.payment-info-row');
        if (rows.length === 0) {
            addPaymentInfoRow();
        }
    }
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    ensureMinOnePaymentInfo();
    setTimeout(ensureMinOnePaymentInfo, 100);
    // ç»‘å®š"æ·»åŠ å›æ¬¾ä¿¡æ¯"æŒ‰é’®äº‹ä»¶
    const addPaymentInfoBtn = document.getElementById('add-payment-info-btn');
    if (addPaymentInfoBtn) {
        addPaymentInfoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            addPaymentInfoRow();
        });
    }
    
    setTimeout(ensureMinOnePaymentInfo, 300);
    
    
        // ç¼“å­˜å¸¸ç”¨DOMå…ƒç´ 
    
    // ========== ç­¾çº¦ä¸»ä½“åˆå§‹åŒ– ==========
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç­¾çº¦ä¸»ä½“ï¼ˆå¤šæ¬¡å°è¯•ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½ï¼‰
    ensureMinTwoParties();
    setTimeout(ensureMinTwoParties, 100);
    setTimeout(ensureMinTwoParties, 300);
    setTimeout(ensureMinTwoParties, 500);
        const cachedElements = {
            contractForm: null,
                        
serviceContentsContainer: null,
        };
        
        // åˆå§‹åŒ–ç¼“å­˜
        cachedElements.contractForm = document.getElementById('contract-form');
cachedElements.serviceContentsContainer = document.getElementById('service-contents-container');
    // ä¸»åˆåŒå­—æ®µæ¡ä»¶æ˜¾ç¤ºæ§åˆ¶
    const contractTypeField = document.getElementById('id_contract_type');
    const parentContractRow = document.getElementById('parent-contract-row');
    
    function toggleParentContractField() {
        if (contractTypeField && parentContractRow) {
            const contractType = contractTypeField.value;
            // åªæœ‰é€‰æ‹©è¡¥å……åè®®ã€å˜æ›´åè®®æˆ–ç»ˆæ­¢åè®®æ—¶æ‰æ˜¾ç¤ºä¸»åˆåŒå­—æ®µ
            if (contractType === 'supplement' || contractType === 'change' || contractType === 'termination') {
                parentContractRow.style.display = '';
            } else {
                parentContractRow.style.display = 'none';
                // æ¸…ç©ºä¸»åˆåŒé€‰æ‹©ï¼ˆå¦‚æœéšè—ï¼‰
                const parentContractField = document.getElementById('id_parent_contract');
                if (parentContractField) {
                    parentContractField.value = '';
                }
            }
        }
    }
    
    // åˆå§‹åŒ–æ—¶æ£€æŸ¥
    toggleParentContractField();
    
    // ç›‘å¬åˆåŒç±»å‹å˜åŒ–
    if (contractTypeField) {
        contractTypeField.addEventListener('change', toggleParentContractField);
    }
    
    // æ›´æ–°è¡¨æ ¼è¡Œåºå·
        rows.forEach((row, idx) => {
            const numberCell = row.querySelector('td:first-child');
            if (numberCell) {
                // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            numberCell.innerHTML = `<strong>${idx + 1}</strong>`;
            }
        });
    }
    
    
    

    
    let partyIndex = 0;
    
        rows.forEach(function(row, index) {
            const numberCell = row.querySelector('td:first-child');
            if (numberCell) {
                // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            numberCell.innerHTML = `<strong>0</strong>`;
            }
    
    // æ›´æ–°æ‰€æœ‰åˆ é™¤æŒ‰é’®çš„ç¦ç”¨çŠ¶æ€ï¼ˆå½“åªæœ‰ä¸¤è¡Œæ—¶ç¦ç”¨ï¼‰
        const rowCount = rows.length;
        rows.forEach(function(row) {
            if (removeBtn) {
                if (rowCount <= 2) {
                    removeBtn.disabled = true;
                    removeBtn.classList.add('disabled');
                    removeBtn.style.opacity = '0.5';
                    removeBtn.style.cursor = 'not-allowed';
                } else {
                    removeBtn.disabled = false;
                    removeBtn.classList.remove('disabled');
                    removeBtn.style.opacity = '1';
                    removeBtn.style.cursor = 'pointer';
                }
            }
        });
    }
    
            // æ›´æ–°æ‰€æœ‰inputå’Œselectçš„nameå±æ€§ä¸­çš„ç´¢å¼•
            const inputs = row.querySelectorAll('input, select');
            inputs.forEach(function(input) {
                const name = input.getAttribute('name');
                if (name) {
                    input.setAttribute('name', newName);
                }
            });
            // æ›´æ–°åˆ é™¤æŒ‰é’®çš„data-index
            if (removeBtn) {
                removeBtn.setAttribute('data-index', index);
            }
    }
    
        const index = partyIndex++;
        const party = partyData || {};
        
        const row = document.createElement('tr');
        row.setAttribute('data-index', index);
        
        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            row.innerHTML = `
            <td style="vertical-align: middle; text-align: center;">
                <strong>0</strong>
            </td>
            <td>
                    <option value="party_a" ${party.party_type === 'party_a' ? 'selected' : ''}>ç”²æ–¹</option>
                    <option value="party_b" ${party.party_type === 'party_b' ? 'selected' : ''}>ä¹™æ–¹</option>
                    <option value="party_c" ${party.party_type === 'party_c' ? 'selected' : ''}>ä¸™æ–¹</option>
                    <option value="other" ${party.party_type === 'other' ? 'selected' : ''}>å…¶ä»–</option>
                </select>
            </td>
            <td>
                       value="${(party.party_name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" required>
            </td>
            <td>
                       value="${(party.credit_code || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
            </td>
            <td>
                       value="${(party.legal_representative || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
            </td>
            <td>
                       value="${(party.party_contact || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
            </td>
            <td>
                       value="${(party.contact_phone || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
            </td>
            <td>
                       value="${(party.contact_email || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
            </td>
            <td>
                       value="${(party.address || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
            </td>
            <td style="vertical-align: middle; text-align: center;">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        container.appendChild(row);
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                if (currentRows.length <= 2) {
                    return;
                }
                row.remove();
                // æ›´æ–°åˆ é™¤æŒ‰é’®çŠ¶æ€
            });
        }
        
        // æ›´æ–°åºå·
        // æ›´æ–°åˆ é™¤æŒ‰é’®çŠ¶æ€
    }
    
    
    (function initParties() {
        function checkAndAdd() {
            if (container) {
                const currentCount = currentRows.length;
                if (currentCount < 2) {
                        const needed = 2 - currentCount;
                        for (let i = 0; i < needed; i++) {
                        }
                        return true;
                    } else {
                        return false;
                    }
                } else {
                    return true;
                }
            } else {
                return false;
            }
        }
        
        // ç«‹å³å°è¯•
        if (!checkAndAdd()) {
            // å¦‚æœå¤±è´¥ï¼Œå»¶è¿Ÿé‡è¯•
            setTimeout(function() {
                if (!checkAndAdd()) {
                    setTimeout(function() {
                        checkAndAdd();
                    }, 200);
                }
            }, 50);
        }
    })();
    
    
    (function() {
        if (container) {
                const needed = 2 - rows.length;
                for (let i = 0; i < needed; i++) {
                }
            } else {
            }
        } else {
        }
    })();
    
    // å»¶è¿Ÿæ‰§è¡Œï¼ˆç¡®ä¿DOMå®Œå…¨åŠ è½½ï¼‰
    setTimeout(function() {
        if (container) {
                const needed = 2 - rows.length;
                for (let i = 0; i < needed; i++) {
                }
            }
        }
    }, 100);
    
    }
    
    

            // åŠ è½½å®Œæˆåï¼Œç«‹å³æ£€æŸ¥æ˜¯å¦éœ€è¦è¡¥å……åˆ°ä¸¤è¡Œ
            setTimeout(function() {
                const container = document.getElementById('parties-container');
                if (container) {
                    if (currentRows.length < 2) {
                        const needed = 2 - currentRows.length;
                        for (let i = 0; i < needed; i++) {
                    ensureMinTwoParties();
                        }
                               // æ›´æ–°åˆ é™¤æŒ‰é’®çŠ¶æ€
         }
                }
            }, 100);
    

    // ä½¿ç”¨å¤šé‡æ£€æŸ¥ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
        }
    }
    
    // å¤šæ¬¡å°è¯•ï¼Œç¡®ä¿æ‰§è¡Œ
    // ç¡®ä¿åˆ é™¤æŒ‰é’®çŠ¶æ€æ­£ç¡®
    
    
    
    
        }
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        const removeBtn = row.querySelector('.remove-service-content-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                // æ£€æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€è¡Œï¼Œå¦‚æœåªæœ‰ä¸€è¡Œåˆ™ä¸åˆ é™¤
                const currentRows = serviceContentsContainer.querySelectorAll('tr.service-content-row');
                if (currentRows.length <= 1) {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡ŒæœåŠ¡å†…å®¹');
                    return;
                }
                row.remove();
                // æ›´æ–°åºå·
                updateServiceContentRowNumbers();
            });
        }
    }
    
    // æ›´æ–°è¡¨æ ¼è¡Œåºå·
    function updateServiceContentRowNumbers() {
        const rows = serviceContentsContainer.querySelectorAll('tr.service-content-row');
        rows.forEach((row, idx) => {
            const numberCell = row.querySelector('td:first-child');
            if (numberCell) {
                // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            numberCell.innerHTML = `<strong>${idx + 1}</strong>`;
            }
        });

    }
    
    
    
    // æ·»åŠ æœåŠ¡ä¿¡æ¯è¡Œ
    let serviceContentIndex = 0;
    function addServiceContent(serviceData = null) {
        const container = document.getElementById('service-contents-container');
        if (!container) {
            console.error('service-contents-container æœªæ‰¾åˆ°ï¼Œæ— æ³•æ·»åŠ è¡Œ');
            return;
        }
        
        const index = serviceContentIndex++;
        const service = serviceData || {};
        
        const row = document.createElement('tr');
        row.className = 'service-content-row';
        row.setAttribute('data-service-index', index);
        
        // æ„å»ºæœåŠ¡ä¸“ä¸šé€‰é¡¹HTMLï¼ˆä½¿ç”¨JavaScriptæ•°æ®ï¼‰
        let serviceProfessionOptions = '';
        serviceProfessionsData.forEach(function(sp) {
            serviceProfessionOptions += '<option value="' + sp.id + '" data-service-type="' + (sp.service_type_id || '') + '">' + sp.name + '</option>';
        });
        
        // æ„å»ºæˆæœæ¸…å•é€‰é¡¹HTMLï¼ˆä½¿ç”¨JavaScriptæ•°æ®ï¼‰
        let resultListOptions = '';
        resultFileTypesData.forEach(function(rft) {
            resultListOptions += '<option value="' + rft.id + '">' + rft.name + '</option>';
        });
        
        row.innerHTML = `
            <td style="vertical-align: middle; text-align: center;">
                <strong>0</strong>
            </td>
            <td>
                <select name="service_contents[${index}][service_type]" class="form-select form-select-sm service-type-select" required>
                    <option value="">-- è¯·é€‰æ‹©æœåŠ¡ç±»å‹ --</option>
                    {% for st in service_types %}
                    <option value="{{ st.id }}">{{ st.name }}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <select name="service_contents[${index}][service_profession]" class="form-select form-select-sm service-profession-select" required>
                    <option value="">-- è¯·é€‰æ‹©æœåŠ¡ä¸“ä¸š --</option>
                    ${serviceProfessionOptions}
                </select>
            </td>
            <td>
                <select name="service_contents[${index}][result_list]" class="form-select form-select-sm" multiple style="min-height: 60px;">
                    ${resultListOptions}
                </select>
                <small class="form-text text-muted">å¯å¤šé€‰ï¼ŒæŒ‰ä½Ctrl/Cmdé”®é€‰æ‹©å¤šä¸ª</small>
            </td>
            <td style="vertical-align: middle; text-align: center;">
                <button type="button" class="btn btn-sm btn-danger remove-service-content-btn">
                    <i class="bi bi-trash"></i> åˆ é™¤
                </button>
            </td>
        `;
        
        container.appendChild(row);
        updateServiceContentRowNumbers();
        
        // ç»‘å®šæœåŠ¡ç±»å‹å˜åŒ–äº‹ä»¶ï¼Œè¿‡æ»¤æœåŠ¡ä¸“ä¸š
        const serviceTypeSelect = row.querySelector('.service-type-select');
        const serviceProfessionSelect = row.querySelector('.service-profession-select');
        
        if (serviceTypeSelect && serviceProfessionSelect) {
            // åˆå§‹è¿‡æ»¤
            function filterServiceProfessions() {
                const selectedServiceType = serviceTypeSelect.value;
                const options = serviceProfessionSelect.querySelectorAll('option');
                options.forEach(function(opt) {
                    if (opt.value === '') {
                        opt.style.display = '';
                    } else {
                        const serviceType = opt.getAttribute('data-service-type');
                        opt.style.display = (serviceType === selectedServiceType) ? '' : 'none';
                    }
                });
                // å¦‚æœå½“å‰é€‰æ‹©çš„æœåŠ¡ä¸“ä¸šä¸åŒ¹é…ï¼Œæ¸…ç©ºé€‰æ‹©
                const currentValue = serviceProfessionSelect.value;
                if (currentValue) {
                    const currentOption = serviceProfessionSelect.querySelector(`option[value="${currentValue}"]`);
                    if (currentOption && currentOption.style.display === 'none') {
                        serviceProfessionSelect.value = '';
                    }
                }
            }
            
            // åˆå§‹æ‰§è¡Œä¸€æ¬¡
            filterServiceProfessions();
            
            // ç›‘å¬æœåŠ¡ç±»å‹å˜åŒ–
            serviceTypeSelect.addEventListener('change', filterServiceProfessions);
        }
        
        // å¦‚æœæœ‰ä¼ å…¥æ•°æ®ï¼Œè®¾ç½®é€‰ä¸­å€¼
        if (service.service_profession) {
            serviceProfessionSelect.value = service.service_profession;
        }
        if (service.result_list && Array.isArray(service.result_list)) {
            service.result_list.forEach(function(resultId) {
                const option = row.querySelector(`select[name="service_contents[${index}][result_list]"] option[value="${resultId}"]`);
                if (option) {
                    option.selected = true;
                }
            });
        }
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        const removeBtn = row.querySelector('.remove-service-content-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const currentRows = container.querySelectorAll('tr.service-content-row');
                if (currentRows.length <= 1) {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡ŒæœåŠ¡ä¿¡æ¯');
                    return;
                }
                row.remove();
                updateServiceContentRowNumbers();
            });
        }
    }
    
    // åŠ è½½å·²æœ‰çš„æœåŠ¡å†…å®¹ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
    {% if existing_service_contents %}
    const existingServiceContents = [
        {% for sc in existing_service_contents %}
        {
            service_type: {{ sc.service_type_id|default:"null" }},
            design_stage: {{ sc.design_stage_id|default:"null" }},
            business_type: {{ sc.business_type_id|default:"null" }},
            description: {{ sc.description|default:"''"|escapejs }},
    ];
        {% endfor %}

    existingServiceContents.forEach(function(content) {
    {% endif %}
        addServiceContent(content);
    });
    
    // ç¡®ä¿è‡³å°‘æœ‰ä¸€è¡ŒæœåŠ¡å†…å®¹
    if (serviceContentsContainer && serviceContentsContainer.querySelectorAll('tr.service-content-row').length === 0) {
        addServiceContent();
    }
    
    
    // ========== åˆåŒè¯†åˆ«åŠŸèƒ½ ==========
    const contractFileInput = document.getElementById('contract-file-input');
    const recognizeBtn = document.getElementById('recognize-contract-btn');
    const recognitionStatus = document.getElementById('recognition-status');
    const recognitionResult = document.getElementById('recognition-result');
    const recognitionMessage = document.getElementById('recognition-message');
    
    if (recognizeBtn && contractFileInput) {
        recognizeBtn.addEventListener('click', async function() {
            const file = contractFileInput.files[0];
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©åˆåŒæ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 10 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                return;
            }
            
            // æ˜¾ç¤ºè¯†åˆ«çŠ¶æ€
            recognitionStatus.style.display = 'block';
            recognitionResult.style.display = 'none';
            recognitionMessage.textContent = 'æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...';
            recognizeBtn.disabled = true;
            
            // åˆ›å»ºFormData
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // è°ƒç”¨è¯†åˆ«API
                const response = await fetch('/api/customer/contracts/recognize/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // è¯†åˆ«æˆåŠŸï¼Œå¡«å……è¡¨å•
                    fillFormWithRecognitionResult(result.data);
                    recognitionMessage.textContent = 'è¯†åˆ«å®Œæˆï¼';
                    recognitionStatus.style.display = 'none';
                    recognitionResult.style.display = 'block';
                } else {
                    // è¯†åˆ«å¤±è´¥
                    recognitionMessage.textContent = 'è¯†åˆ«å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯');
                    recognitionStatus.querySelector('.alert').className = 'alert alert-danger';
                }
            } catch (error) {
                recognitionMessage.textContent = 'è¯†åˆ«å¤±è´¥ï¼š' + error.message;
                recognitionStatus.querySelector('.alert').className = 'alert alert-danger';
            } finally {
                recognizeBtn.disabled = false;
            }
        });
    }
    
    // å¡«å……è¡¨å•æ•°æ®
    function fillFormWithRecognitionResult(data) {
        // åˆåŒåç§°
        if (data.contract_name) {
            const contractNameField = document.querySelector('[name=]"contract_name"]');
            if (contractNameField && !contractNameField.value) {
                contractNameField.value = data.contract_name;
            }
        }
        
        // é¡¹ç›®ç¼–å·ï¼ˆåˆåŒç¼–å·ï¼‰
        if (data.contract_number) {
            const contractNumberField = document.querySelector('[name="project_number"]');
            if (contractNumberField && !contractNumberField.value) {
                contractNumberField.value = data.contract_number;
            }
        }
        
        // åˆåŒç±»å‹
        if (data.contract_type) {
            const contractTypeField = document.querySelector('[name="contract_type"]');
            if (contractTypeField) {
                // å°è¯•åŒ¹é…åˆåŒç±»å‹
                const options = contractTypeField.querySelectorAll('option');
                for (let opt of options) {
                    if (opt.textContent.includes(data.contract_type) || data.contract_type.includes(opt.textContent)) {
                        contractTypeField.value = opt.value;
                        break;
                    }
                }
            }
        }
        
        // åˆåŒæè¿°
        if (data.description) {
            const descField = document.querySelector('[name="description"]');
            if (descField && !descField.value) {
                descField.value = data.description;
            }
        }
        
        if (data.party_a && data.party_a.name) {
            if (partyRows.length > 0) {
                const firstRow = partyRows[0];
                const partyNameInput = firstCard.querySelector('input[name*="[party_name]"]');
                if (partyNameInput && !partyNameInput.value) {
                    partyNameInput.value = data.party_a.name;
                }
                if (data.party_a.contact) {
                    const contactInput = firstCard.querySelector('input[name*="[party_contact]"]');
                if (data.party_a.phone) {
                    const phoneInput = firstCard.querySelector('input[name*="[contact_phone]"]');
                if (data.party_a.email) {
                    const emailInput = firstCard.querySelector('input[name*="[contact_email]"]');
                if (data.party_a.address) {
                    const addressInput = firstCard.querySelector('input[name*="[address]"]');
                if (data.party_a.credit_code) {
                    const creditCodeInput = firstCard.querySelector('input[name*="[credit_code]"]');
                if (data.party_a.legal_representative) {
                    const legalRepInput = firstCard.querySelector('input[name*="[legal_representative]"]');
            }
        }
        
        if (data.party_b && data.party_b.name) {
            let secondRow = null;
            if (partyRows.length > 1) {
                secondRow = partyRows[1];
                setTimeout(function() {
                    if (newRows.length > 1) {
                        secondRow = newRows[1];
                    }
                }, 300);
            }
            
            if (secondRow) {
                const partyNameInput = secondRow.querySelector('input[name*="[party_name]"]');
                if (partyNameInput && !partyNameInput.value) {
                    partyNameInput.value = data.party_b.name;
                }
                if (data.party_b.contact) {
                    const contactInput = secondRow.querySelector('input[name*="[party_contact]"]');
                if (data.party_b.phone) {
                    const phoneInput = secondRow.querySelector('input[name*="[contact_phone]"]');
                if (data.party_b.email) {
                    const emailInput = secondRow.querySelector('input[name*="[contact_email]"]');
                if (data.party_b.address) {
                    const addressInput = secondRow.querySelector('input[name*="[address]"]');
                if (data.party_b.credit_code) {
                    const creditCodeInput = secondRow.querySelector('input[name*="[credit_code]"]');
                if (data.party_b.legal_representative) {
                    const legalRepInput = secondRow.querySelector('input[name*="[legal_representative]"]');
            }
        }
        
        // å¦‚æœæœ‰åˆåŒé‡‘é¢ï¼Œå¯ä»¥å°è¯•å¡«å……åˆ°ç»“ç®—æ–¹å¼ä¸­ï¼ˆå›ºå®šæ€»ä»·ï¼‰
    }
    
// ========== ç»“ç®—æ–¹å¼ç®¡ç†ï¼ˆè¡¨æ ¼å½¢å¼ï¼‰ ==========
    
    
    
    // ç»“ç®—æ–¹å¼é€‰é¡¹ï¼ˆä»æ¨¡æ¿ä¸­è·å–ï¼‰
        { value: '{{ value }}', label: '{{ label }}' },
    ];

    // é¢ç§¯ç±»å‹é€‰é¡¹

    // å°é¡¶ç±»å‹é€‰é¡¹

    // æœåŠ¡ç±»å‹é€‰é¡¹ï¼ˆä»æ¨¡æ¿ä¸­è·å–ï¼‰
    const serviceTypeOptions = [
        {% for st in service_types %}
        { value: '{{ st.id }}', label: '{{ st.name }}' },
        {% endfor %}
    ];

    // æ·»åŠ ç»“ç®—æ–¹å¼å¡ç‰‡
    
        // æ›´æ–°ç»“ç®—æ–¹å¼ç›¸å…³å­—æ®µçš„æ˜¾ç¤º
    // æ·»åŠ åˆ†æ®µå–è´¹è¡Œ
    function addSegmentedRate(cardIndex, rateData = null) {
        const rate = rateData || {};
        if (!container) return;
        
        const row = document.createElement('tr');
        row.setAttribute('data-rate-index', rateIndex);
        
        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            row.innerHTML = `
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.greater_than || ''}" placeholder="0.00">
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.less_than || ''}" placeholder="0.00">
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.rate || ''}" placeholder="0.00" required>
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.service_fee || ''}" placeholder="0.00">
            </td>
            <td style="text-align: center;">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        container.appendChild(row);

        // ç»‘å®šæœåŠ¡è´¹è¾“å…¥æ¡†çš„changeäº‹ä»¶ï¼Œè‡ªåŠ¨è®¡ç®—å°è®¡
        const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
        if (serviceFeeInput) {
            serviceFeeInput.addEventListener('input', function() {
                calculateFixedTotalSum(cardIndex);
            });
        }
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                row.remove();
                updateSegmentedRateNumbers(cardIndex);
            });
        }
    }
    
    // æ›´æ–°åˆ†æ®µåºå·
    // æ·»åŠ æ€»ä»·åŒ…å¹²æ¡ç›®
    function addFixedTotalItem(cardIndex, itemData = null) {
        const item = itemData || {};
        if (!container) return;
        
        const row = document.createElement('tr');
        row.setAttribute('data-item-index', itemIndex);
        
        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            row.innerHTML = `
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${item.area_scale || ''}" placeholder="0.00" required>
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${item.service_fee || ''}" placeholder="0.00" required>
            </td>
            <td>
                    <i class="bi bi-trash"></i> åˆ é™¤
                </button>
            </td>
        `;
        
        container.appendChild(row);
        
        // ç»‘å®šæœåŠ¡è´¹è¾“å…¥æ¡†çš„changeäº‹ä»¶ï¼Œè‡ªåŠ¨è®¡ç®—å°è®¡
        const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
        if (serviceFeeInput) {
            serviceFeeInput.addEventListener('input', function() {
                calculateFixedTotalSum(cardIndex);
            });
        }
        
        // è®¡ç®—å°è®¡
        calculateFixedTotalSum(cardIndex);
        
        // æ›´æ–°åºå·
        updateFixedTotalNumbers(cardIndex);
        
    }
    
    // æ›´æ–°æ€»ä»·åŒ…å¹²æ¡ç›®åºå·
    
    
    
    function updateFixedTotalNumbers(cardIndex) {
        if (!container) return;
        
        rows.forEach(function(row, index) {
            row.setAttribute('data-item-index', index);
            // æ›´æ–°nameå±æ€§ä¸­çš„ç´¢å¼•
            const inputs = row.querySelectorAll('input');
            inputs.forEach(function(input) {
                const name = input.getAttribute('name');
                if (name) {
                    // æ›¿æ¢ç´¢å¼•éƒ¨åˆ†
                    const newName = name.replace(/\[fixed_total_items\]\[\d+\]/, '[fixed_total_items][' + index + ']');
                    input.setAttribute('name', newName);
                }
            });
            // æ›´æ–°åˆ é™¤æŒ‰é’®çš„data-item-index
            if (removeBtn) {
                removeBtn.setAttribute('data-item-index', index);
            }
        });
    }

    
    // è®¡ç®—æ€»ä»·åŒ…å¹²æœåŠ¡è´¹å°è®¡
    function calculateFixedTotalSum(cardIndex) {
        if (!container || !sumElement) return;
        
        let total = 0;
        
        rows.forEach(function(row) {
            const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
            if (serviceFeeInput && serviceFeeInput.value) {
                const value = parseFloat(serviceFeeInput.value) || 0;
                total += value;
            }
        });
        
        // æ›´æ–°å°è®¡æ˜¾ç¤ºï¼Œä¿ç•™ä¸¤ä½å°æ•°
        sumElement.textContent = total.toFixed(2);
        // console.log(...) // å·²ç§»é™¤}`);
    }
    function updateSegmentedRateNumbers(cardIndex) {
        if (!container) return;
        
        rows.forEach((row, idx) => {
            row.setAttribute('data-rate-index', idx);
            // æ›´æ–°æ‰€æœ‰è¾“å…¥æ¡†çš„nameå±æ€§
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name) {
                    const newName = name.replace(/\[segmented_rates\]\[\d+\]/, '[segmented_rates][' + idx + ']');
                    input.setAttribute('name', newName);
                }
            });
        });
    }

    
    
    // æ›´æ–°å¡ç‰‡åºå·
    function updateSettlementMethodNumbers() {
        cards.forEach((card, idx) => {
            const titleElement = card.querySelector('.card-title');
            if (titleElement) {
                titleElement.textContent = `ç»“ç®—æ–¹å¼ #${idx + 1}`;
            }
            // æ›´æ–°data-index
            card.setAttribute('data-index', idx);
            // æ›´æ–°æ‰€æœ‰è¾“å…¥æ¡†çš„nameå±æ€§ä¸­çš„index
            const inputs = card.querySelectorAll('input, select');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name && name.includes('[')) {
                    const newName = name.replace(/\[(\d+)\]/, '[' + idx + ']');
                    input.setAttribute('name', newName);
                }
            });
        });
    }
    
    // æ·»åŠ æŒ‰é’®äº‹ä»¶
    

        // å¦‚æœæ˜¯æ€»ä»·åŒ…å¹²ï¼ŒåŠ è½½æ€»ä»·åŒ…å¹²æ¡ç›®åˆ—è¡¨
        }
    });
    
    // åˆå§‹åŒ–æ‰€æœ‰è¡Œçš„å­—æ®µæ˜¾ç¤ºçŠ¶æ€
    setTimeout(function() {
        cards.forEach(function(card) {
            const indexAttr = card.getAttribute('data-index');
            if (indexAttr !== null) {
                const index = parseInt(indexAttr);
            }
        });
    }, 300);
    
    }
    
    
                // ç´¯è®¡ææˆï¼šéœ€è¦èŠ‚çœé‡‘é¢ï¼Œæš‚æ—¶æ— æ³•è®¡ç®—
                hasUncalculableMethod = true;
                    const unitPrice = parseFloat(fixedUnitPrice.value) || 0;
                    const totalArea = getTotalBuildingArea();
                    rowPrice += unitPrice * totalArea;
                }
                // æŒ‰å®ç»“ç®—éƒ¨åˆ†æš‚æ—¶æ— æ³•è®¡ç®—
                hasUncalculableMethod = true;
            } else {
                // å…¶ä»–ç»“ç®—æ–¹å¼ï¼ˆåˆ†æ®µé€’å¢ææˆã€è·³ç‚¹ææˆç­‰ï¼‰éœ€è¦èŠ‚çœé‡‘é¢ï¼Œæš‚æ—¶æ— æ³•è®¡ç®—
                hasUncalculableMethod = true;
            }
            
            totalPrice += rowPrice;
        });
        
        if (hasUncalculableMethod && totalPrice === 0) {
            contractPriceInput.value = 'éœ€æŒ‰å®ç»“ç®—';
        } else if (hasUncalculableMethod) {
            contractPriceInput.value = totalPrice.toFixed(2) + 'ï¼ˆéƒ¨åˆ†éœ€æŒ‰å®ç»“ç®—ï¼‰';
        } else if (totalPrice > 0) {
            contractPriceInput.value = totalPrice.toFixed(2);
        } else {
            contractPriceInput.value = '';
        }
    }
    
    // ä»æœåŠ¡å†…å®¹ä¸­è·å–æ€»å»ºç­‘é¢ç§¯
    function getTotalBuildingArea() {
        let totalArea = 0;
        
            const areaInput = card.querySelector('input[name*="[area_scale]"]');
            if (areaInput && areaInput.value) {
                totalArea += parseFloat(areaInput.value) || 0;
            }
        });
        
        return totalArea;
    }
    
        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç›‘å¬æ‰€æœ‰ç»“ç®—æ–¹å¼ç›¸å…³å­—æ®µçš„å˜åŒ–
        
        // ç›‘å¬ç»“ç®—æ–¹å¼è¡¨æ ¼ä¸­é¢ç§¯è§„æ¨¡çš„å˜åŒ–
        
        
        // é¡µé¢åŠ è½½æ—¶è®¡ç®—ä¸€æ¬¡

        // ========== ç»‘å®šæ‰€æœ‰ç¼ºå¤±çš„æ·»åŠ è¡ŒæŒ‰é’® ==========
        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°è¡Œåºå·
        function updateRowNumbers(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const rows = container.querySelectorAll('tr');
            rows.forEach(function(row, index) {
                const numCell = row.querySelector('td:first-child strong');
                if (numCell) {
                    numCell.textContent = index + 1;
                }
            });
        }

        // ç»‘å®šæ€»ä»·åŒ…å¹²æ·»åŠ æŒ‰é’®
        const addFixedTotalBtn = document.getElementById('add-fixed-total-btn');
        if (addFixedTotalBtn) {
            addFixedTotalBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('fixed-total-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="fixed_total_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="fixed_total_items[${index}][area_scale]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="fixed_total_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                    }
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('fixed-total-container');
                        calculateFixedTotalSubtotal();
                    });
                }
                const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
                if (serviceFeeInput) {
                    serviceFeeInput.addEventListener('input', calculateFixedTotalSubtotal);
                }
                updateRowNumbers('fixed-total-container');
                calculateFixedTotalSubtotal();
            });
        }

        // ç»‘å®šåŒ…å¹²å•ä»·æ·»åŠ æŒ‰é’®
        const addFixedUnitBtn = document.getElementById('add-fixed-unit-btn');
        if (addFixedUnitBtn) {
            addFixedUnitBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('fixed-unit-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="fixed_unit_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="fixed_unit_items[${index}][area_size]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td>
                        <select name="fixed_unit_items[${index}][area_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="fixed_unit_items[${index}][unit_price]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="fixed_unit_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                    }
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('fixed-unit-container');
                        calculateFixedUnitSubtotal();
                    });
                }
                const inputs = row.querySelectorAll('input[name*="[area_size]"], input[name*="[unit_price]"], input[name*="[service_fee]"]');
                inputs.forEach(function(input) {
                    input.addEventListener('input', function() {
                        const areaInput = row.querySelector('input[name*="[area_size]"]');
                        const unitPriceInput = row.querySelector('input[name*="[unit_price]"]');
                        const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
                        if (areaInput && unitPriceInput && serviceFeeInput) {
                            const area = parseFloat(areaInput.value) || 0;
                            const unitPrice = parseFloat(unitPriceInput.value) || 0;
                            serviceFeeInput.value = (area * unitPrice).toFixed(2);
                        }
                        calculateFixedUnitSubtotal();
                    });
                });
                updateRowNumbers('fixed-unit-container');
                calculateFixedUnitSubtotal();

        }

        // ç»‘å®šç´¯è®¡ææˆæ·»åŠ æŒ‰é’®
        const addCumulativeCommissionBtn = document.getElementById('add-cumulative-commission-btn');
        if (addCumulativeCommissionBtn) {
            addCumulativeCommissionBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('cumulative-commission-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="cumulative_commission_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="cumulative_commission_items[${index}][area_scale]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td>
                        <select name="cumulative_commission_items[${index}][area_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="cumulative_commission_items[${index}][commission_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="cumulative_commission_items[${index}][adjustment_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00"></td>
                    <td><input type="number" name="cumulative_commission_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                    }
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('cumulative-commission-container');
                    });
                }
                updateRowNumbers('cumulative-commission-container');
            });
        }

        // ç»‘å®šåˆ†æ®µææˆæ·»åŠ æŒ‰é’®
        const addSegmentedCommissionBtn = document.getElementById('add-segmented-commission-btn');
        if (addSegmentedCommissionBtn) {
            addSegmentedCommissionBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('segmented-commission-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="segmented_commission_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="segmented_commission_items[${index}][area_scale]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td>
                        <select name="segmented_commission_items[${index}][area_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="segmented_commission_items[${index}][amount_range]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="segmented_commission_items[${index}][commission_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="segmented_commission_items[${index}][adjustment_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00"></td>
                    <td><input type="number" name="segmented_commission_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                    }
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('segmented-commission-container');
                    });
                }
                updateRowNumbers('segmented-commission-container');
            });
        }

        // ç»‘å®šè·³ç‚¹ææˆæ·»åŠ æŒ‰é’®
        const addJumpPointCommissionBtn = document.getElementById('add-jump-point-commission-btn');
        if (addJumpPointCommissionBtn) {
            addJumpPointCommissionBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('jump-point-commission-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="jump_point_commission_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="jump_point_commission_items[${index}][area_scale]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td>
                        <select name="jump_point_commission_items[${index}][area_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="jump_point_commission_items[${index}][jump_point_amount]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="jump_point_commission_items[${index}][commission_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="jump_point_commission_items[${index}][adjustment_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00"></td>
                    <td><input type="number" name="jump_point_commission_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                    }
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('jump-point-commission-container');
                    });
                }
                updateRowNumbers('jump-point-commission-container');
            });
        }
            });
        }

        // ç»‘å®šæ·»åŠ æœåŠ¡å†…å®¹æŒ‰é’®äº‹ä»¶
        const addServiceContentBtn = document.getElementById('add-service-content-btn');
        if (addServiceContentBtn) {
            addServiceContentBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                addServiceContent();
            });
        }
        
        // ç¡®ä¿è‡³å°‘æœ‰ä¸€è¡ŒæœåŠ¡å†…å®¹
        setTimeout(function() {
            const container = document.getElementById('service-contents-container');
            if (container && container.querySelectorAll('tr.service-content-row').length === 0) {
                addServiceContent();
            }
        }, 200);

        // åˆå§‹åŒ–æˆ‘æ–¹ç­¾çº¦ä¸»ä½“é€‰é¡¹
        (function() {
            const ourUnits = {{ our_units|safe|default:"[]" }};
            const select = document.getElementById('our_signing_party');
            if (select && Array.isArray(ourUnits)) {
                ourUnits.forEach(function(unit) {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    select.appendChild(option);
                });
            }
        })();


</script>
{% endblock %}
