{% extends "customer_management/base.html" %}

{% block title %}{{ page_title }} - 维海科技信息化管理平台{% endblock %}

{% block authorization_letter_content %}
<div class="container-fluid py-4">
    <div class="center-hero mb-4">
        <div style="position: relative; z-index: 1;">
            <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 8px 0;">{{ page_title }}</h1>
            <p style="font-size: 14px; opacity: 0.9; margin: 0;">{{ description }}</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">基本信息</h5>
            <div>
                {% if can_edit %}
                <a href="{% url 'business_pages:authorization_letter_edit' letter.id %}" class="btn btn-sm btn-primary">编辑</a>
                {% endif %}
                {% if can_delete %}
                <a href="{% url 'business_pages:authorization_letter_delete' letter.id %}" class="btn btn-sm btn-danger">删除</a>
                {% endif %}
                <a href="{% url 'business_pages:authorization_letter_list' %}" class="btn btn-sm btn-outline-secondary">返回列表</a>
            </div>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-3"><strong>委托书编号：</strong></div>
                <div class="col-md-9">{{ letter.letter_number|default:"未编号" }}</div>
            </div>
            <div class="row mb-3">
                <div class="col-md-3"><strong>委托书名称：</strong></div>
                <div class="col-md-9">{{ letter.project_name }}</div>
            </div>
            <div class="row mb-3">
                <div class="col-md-3"><strong>委托日期：</strong></div>
                <div class="col-md-9">{{ letter.letter_date|date:"Y-m-d" }}</div>
            </div>
            <div class="row mb-3">
                <div class="col-md-3"><strong>状态：</strong></div>
                <div class="col-md-9">
                    <span class="badge bg-{% if letter.status == 'draft' %}secondary{% elif letter.status == 'submitted' %}info{% elif letter.status == 'confirmed' %}success{% else %}danger{% endif %}">
                        {{ letter.get_status_display }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0">委托方信息</h5></div>
                <div class="card-body">
                    <p><strong>单位名称：</strong>{{ letter.client_name }}</p>
                    {% if letter.client_representative %}<p><strong>单位代表：</strong>{{ letter.client_representative }}</p>{% endif %}
                    {% if letter.client_phone %}<p><strong>联系电话：</strong>{{ letter.client_phone }}</p>{% endif %}
                    {% if letter.client_email %}<p><strong>电子邮箱：</strong>{{ letter.client_email }}</p>{% endif %}
                    {% if letter.client_address %}<p><strong>收件地址：</strong>{{ letter.client_address }}</p>{% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0">服务单位信息</h5></div>
                <div class="card-body">
                    <p><strong>服务单位：</strong>{{ letter.trustee_name }}</p>
                    {% if letter.trustee_representative %}<p><strong>单位代表：</strong>{{ letter.trustee_representative }}</p>{% endif %}
                    {% if letter.trustee_phone %}<p><strong>联系电话：</strong>{{ letter.trustee_phone }}</p>{% endif %}
                    {% if letter.trustee_email %}<p><strong>电子邮箱：</strong>{{ letter.trustee_email }}</p>{% endif %}
                    {% if letter.trustee_address %}<p><strong>收件地址：</strong>{{ letter.trustee_address }}</p>{% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">服务内容</h5></div>
        <div class="card-body">
            {% if letter.design_stages %}
            <p><strong>设计阶段：</strong></p>
            <ul>
                {% for stage in letter.get_design_stages_display %}
                <li>{{ stage }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            
            {% if letter.result_optimization_scopes %}
            <p><strong>结果优化范围：</strong></p>
            <ul>
                {% for scope in letter.get_result_optimization_scopes_display %}
                <li>{{ scope }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            
            {% if letter.process_optimization_scopes %}
            <p><strong>过程优化范围：</strong></p>
            <ul>
                {% for scope in letter.get_process_optimization_scopes_display %}
                <li>{{ scope }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            
            {% if letter.detailed_review_scopes %}
            <p><strong>精细化审图范围：</strong></p>
            <ul>
                {% for scope in letter.get_detailed_review_scopes_display %}
                <li>{{ scope }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">服务费确定原则</h5></div>
        <div class="card-body">
            {% if letter.result_optimization_rate %}
            <p><strong>结果优化费率：</strong>{{ letter.result_optimization_rate }}%</p>
            {% endif %}
            {% if letter.process_optimization_rate %}
            <p><strong>过程优化费率：</strong>{{ letter.process_optimization_rate }}%</p>
            {% endif %}
            {% if letter.detailed_review_unit_price_min or letter.detailed_review_unit_price_max %}
            <p><strong>精细化审图单价：</strong>
                {% if letter.detailed_review_unit_price_min %}{{ letter.detailed_review_unit_price_min }}{% endif %}
                {% if letter.detailed_review_unit_price_min and letter.detailed_review_unit_price_max %}-{% endif %}
                {% if letter.detailed_review_unit_price_max %}{{ letter.detailed_review_unit_price_max }}{% endif %}
                元/平方米
            </p>
            {% endif %}
            {% if letter.fee_determination_principle %}
            <p><strong>服务费确定原则说明：</strong></p>
            <p>{{ letter.fee_determination_principle|linebreaks }}</p>
            {% endif %}
        </div>
    </div>

    {% if letter.settlement_review_process or letter.payment_schedule %}
    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">结算与支付</h5></div>
        <div class="card-body">
            {% if letter.settlement_review_process %}
            <p><strong>结算审核流程说明：</strong></p>
            <p>{{ letter.settlement_review_process|linebreaks }}</p>
            {% endif %}
            {% if letter.payment_schedule %}
            <p><strong>付款计划：</strong></p>
            {% if letter.payment_schedule.items %}
            <ul>
                {% for key, value in letter.payment_schedule.items %}
                <li><strong>{{ key }}：</strong>{{ value }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <pre>{{ letter.payment_schedule|safe }}</pre>
            {% endif %}
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if letter.supplementary_agreement %}
    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">补充约定</h5></div>
        <div class="card-body">
            <p>{{ letter.supplementary_agreement|linebreaks }}</p>
        </div>
    </div>
    {% endif %}

    {% if letter.start_date or letter.end_date %}
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0">委托期限</h5></div>
                <div class="card-body">
                    {% if letter.start_date %}<p><strong>开始日期：</strong>{{ letter.start_date|date:"Y-m-d" }}</p>{% endif %}
                    {% if letter.end_date %}<p><strong>结束日期：</strong>{{ letter.end_date|date:"Y-m-d" }}</p>{% endif %}
                    {% if letter.duration_days %}<p><strong>委托期限：</strong>{{ letter.duration_days }} 天</p>{% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">关联信息</h5></div>
        <div class="card-body">
            {% if letter.opportunity %}
            <p><strong>关联商机：</strong><a href="{% url 'business_pages:opportunity_detail' letter.opportunity.id %}">{{ letter.opportunity.name }}</a></p>
            {% endif %}
            {% if letter.project %}
            <p><strong>关联项目：</strong>{{ letter.project.name }}</p>
            {% endif %}
            {% if letter.notes %}
            <p><strong>备注：</strong>{{ letter.notes|linebreaks }}</p>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">操作</h5></div>
        <div class="card-body">
            <form method="post" action="{% url 'business_pages:authorization_letter_status_transition' letter.id %}" class="d-inline">
                {% csrf_token %}
                {% if letter.status == 'draft' %}
                <button type="submit" name="action" value="submit" class="btn btn-primary">提交</button>
                {% elif letter.status == 'submitted' %}
                <button type="submit" name="action" value="confirm" class="btn btn-success">确认</button>
                <button type="submit" name="action" value="cancel" class="btn btn-warning">作废</button>
                {% endif %}
            </form>
            {% if can_convert %}
            <a href="{% url 'business_pages:contract_create' %}?authorization_letter={{ letter.id }}" class="btn btn-success">转换为合同</a>
            {% endif %}
            {% if can_delete %}
            <a href="{% url 'business_pages:authorization_letter_delete' letter.id %}" class="btn btn-danger">删除</a>
            {% endif %}
            {% if can_edit %}
            <a href="{% url 'business_pages:authorization_letter_edit' letter.id %}" class="btn btn-outline-primary">编辑</a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
