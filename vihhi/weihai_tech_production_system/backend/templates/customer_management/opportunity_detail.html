{% extends "customer_management/base.html" %}

{% block title %}{{ page_title }} - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'business_pages:opportunity_management' %}">å•†æœºç®¡ç†</a></li>
<li class="breadcrumb-item active" aria-current="page">å•†æœºè¯¦æƒ…</li>
{% endblock %}

{% block opportunity_content %}
<div class="workspace-content">
    <!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œæŒ‰é’® -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <a href="{% url 'business_pages:opportunity_management' %}" class="text-decoration-none">
                    <i class="bi bi-arrow-left"></i>
            </a>
                å•†æœºè¯¦æƒ…
            </h2>
            <p class="text-muted mb-0">å•†æœºç¼–å·ï¼š{{ opportunity.opportunity_number|default:'æœªç¼–å·' }}</p>
        </div>
        <div class="btn-group">
            {% if can_edit %}
            <a href="{% url 'business_pages:opportunity_edit' opportunity.id %}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> ç¼–è¾‘
            </a>
            {% endif %}
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" 
                    data-bs-toggle="dropdown" aria-expanded="false">
                æ›´å¤šæ“ä½œ
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" href="{% url 'business_pages:opportunity_followup_create' opportunity.id %}">
                        <i class="bi bi-plus-circle"></i> è®°å½•è·Ÿè¿›
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="{% url 'business_pages:opportunity_status_transition' opportunity.id %}">
                <i class="bi bi-arrow-repeat"></i> çŠ¶æ€æµè½¬
            </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item text-danger" href="{% url 'business_pages:opportunity_delete' opportunity.id %}">
                        <i class="bi bi-trash"></i> åˆ é™¤
            </a>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ï¼ˆæ ¹æ®å•†æœºç®¡ç†ä¸“é¡¹è®¾è®¡æ–¹æ¡ˆï¼‰ -->
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">åŸºæœ¬ä¿¡æ¯</h5>
            <div class="info-card-actions">
                {% if can_edit %}
                <a href="{% url 'business_pages:opportunity_edit' opportunity.id %}" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a>
                {% endif %}
            </div>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                <div class="info-item">
                    <span class="info-label">å•†æœºç¼–å·</span>
                    <span class="info-value">{{ opportunity.opportunity_number|default:'æœªç¼–å·' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å•†æœºåç§°</span>
                    <span class="info-value info-value-bold">{{ opportunity.name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å…³è”å®¢æˆ·</span>
                    <span class="info-value">
                        <a href="{% url 'business_pages:customer_detail' opportunity.client.id %}" class="info-value-link">
                            {{ opportunity.client.name }}
                        </a>
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">è´Ÿè´£å•†åŠ¡</span>
                    <span class="info-value">{{ opportunity.business_manager.get_full_name|default:opportunity.business_manager.username }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å•†æœºç±»å‹</span>
                    <span class="info-value">{{ opportunity.get_opportunity_type_display|default:'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æœåŠ¡ç±»å‹</span>
                    <span class="info-value">{{ opportunity.service_type.name|default:'æœªè®¾ç½®' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å•†æœºçŠ¶æ€</span>
                    <span class="info-value">
                        <span class="badge bg-primary">{{ opportunity.get_status_display }}</span>
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">ç´§æ€¥ç¨‹åº¦</span>
                    <span class="info-value">
                        <span class="badge bg-warning">{{ opportunity.get_urgency_display }}</span>
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆ›å»ºæ—¶é—´</span>
                    <span class="info-value">{{ opportunity.created_time|date:'Y-m-d H:i' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆ›å»ºäºº</span>
                    <span class="info-value">{{ opportunity.created_by.get_full_name|default:opportunity.created_by.username }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é¡¹ç›®ä¿¡æ¯å¡ç‰‡ -->
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">é¡¹ç›®ä¿¡æ¯</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                <div class="info-item">
                    <span class="info-label">é¡¹ç›®åç§°</span>
                    <span class="info-value {% if not opportunity.project_name %}info-value-empty{% endif %}">
                        {{ opportunity.project_name|default:'æœªå¡«å†™' }}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¡¹ç›®åœ°å€</span>
                    <span class="info-value {% if not opportunity.project_address %}info-value-empty{% endif %}">
                        {{ opportunity.project_address|default:'æœªå¡«å†™' }}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¡¹ç›®ä¸šæ€</span>
                    <span class="info-value {% if not opportunity.project_type %}info-value-empty{% endif %}">
                        {{ opportunity.project_type|default:'æœªå¡«å†™' }}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">å»ºç­‘é¢ç§¯ï¼ˆå¹³æ–¹ç±³ï¼‰</span>
                    <span class="info-value {% if not opportunity.building_area %}info-value-empty{% endif %}">
                        {% if opportunity.building_area %}{{ opportunity.building_area|floatformat:2 }}{% else %}æœªå¡«å†™{% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">å›¾çº¸é˜¶æ®µ</span>
                    <span class="info-value {% if not opportunity.drawing_stage %}info-value-empty{% endif %}">
                        {{ opportunity.drawing_stage.name|default:'æœªå¡«å†™' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é‡‘é¢å’Œæ¦‚ç‡å¡ç‰‡ -->
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">é‡‘é¢å’Œæ¦‚ç‡</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                <div class="info-item">
                    <span class="info-label">é¢„è®¡é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</span>
                    <span class="info-value info-value-numeric info-value-bold">
                        {{ opportunity.estimated_amount|floatformat:2 }}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">æˆåŠŸæ¦‚ç‡</span>
                    <span class="info-value info-value-bold">
                        {{ opportunity.success_probability }}%
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">åŠ æƒé‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</span>
                    <span class="info-value info-value-numeric info-value-bold">
                        {{ opportunity.weighted_amount|floatformat:2 }}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¢„è®¡ç­¾çº¦æ—¶é—´</span>
                    <span class="info-value {% if not opportunity.expected_sign_date %}info-value-empty{% endif %}">
                        {{ opportunity.expected_sign_date|date:'Y-m-d'|default:'æœªè®¾ç½®' }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å•†æœºæè¿° -->
    {% if opportunity.description %}
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">å•†æœºæè¿°</h5>
        </div>
        <div class="info-card-body">
            <div class="info-item">
                <span class="info-value">{{ opportunity.description|linebreaks }}</span>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- å®¡æ‰¹æµç¨‹å¡ç‰‡ -->
    {% if approval_instance %}
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">å®¡æ‰¹æµç¨‹</h5>
            <div class="info-card-actions">
                <span class="badge bg-{% if approval_instance.status == 'approved' %}success{% elif approval_instance.status == 'rejected' %}danger{% elif approval_instance.status == 'pending' %}warning{% else %}secondary{% endif %}">
                    {{ approval_instance.get_status_display }}
                </span>
            </div>
        </div>
        <div class="info-card-body">
            <div class="approval-timeline">
                {% for record in approval_records %}
                <div class="approval-timeline-item">
                    <div class="approval-timeline-marker 
                                {% if record.approval_result == 'approved' %}approved
                                {% elif record.approval_result == 'rejected' %}rejected
                                {% else %}pending{% endif %}">
                    </div>
                    <div class="approval-timeline-content">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>{{ record.node.name }}</strong>
                                <span class="badge bg-{% if record.approval_result == 'approved' %}success{% elif record.approval_result == 'rejected' %}danger{% else %}secondary{% endif %} ms-2">
                                    {{ record.get_approval_result_display|default:'å¾…å®¡æ‰¹' }}
                    </span>
                </div>
                            <small class="text-muted">
                                {% if record.approval_time %}
                                    {{ record.approval_time|date:"Y-m-d H:i" }}
                                {% else %}
                                    å¾…å®¡æ‰¹
                                {% endif %}
                            </small>
                        </div>
                        {% if record.approver %}
                        <div class="mb-2">
                            <span class="text-muted small">å®¡æ‰¹äººï¼š</span>
                            {{ record.approver.get_full_name|default:record.approver.username }}
                </div>
                {% endif %}
                        {% if record.approval_comment %}
                        <p class="mb-0 text-muted small">{{ record.approval_comment }}</p>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-3">
                    <p class="mb-0">æš‚æ— å®¡æ‰¹è®°å½•</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% elif can_submit_approval %}
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">å®¡æ‰¹æµç¨‹</h5>
        </div>
        <div class="info-card-body">
            <div class="text-center py-3">
                <p class="text-muted mb-3">æš‚æ— å®¡æ‰¹æµç¨‹</p>
                <a href="#" class="btn btn-primary"data-click="handle_onclick_0"æäº¤å®¡æ‰¹åŠŸèƒ½å¾…å®ç°'); return false;">
                    <i class="bi bi-send"></i> æäº¤å®¡æ‰¹
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- å®¡æ‰¹æµç¨‹æ—¶é—´è½´æ ·å¼CSS -->
    <style>
        .approval-timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .approval-timeline-item {
            position: relative;
            padding-bottom: 20px;
            padding-left: 20px;
        }
        
        .approval-timeline-item:last-child {
            padding-bottom: 0;
        }
        
        .approval-timeline-marker {
            position: absolute;
            left: -8px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--vh-card-bg);
            z-index: 2;
        }
        
        .approval-timeline-marker.approved {
            background: var(--vh-success);
        }
        
        .approval-timeline-marker.rejected {
            background: var(--vh-error);
        }
        
        .approval-timeline-marker.pending {
            background: var(--vh-warning);
        }
        
        .approval-timeline-item::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 17px;
            bottom: -5px;
            width: 2px;
            background: var(--vh-border);
        }
        
        .approval-timeline-item:last-child::before {
            display: none;
        }
        
        .approval-timeline-content {
            background: var(--vh-surface);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border-left: 3px solid var(--vh-primary);
        }
    </style>
    
    <!-- èµ¢å•/è¾“å•ä¿¡æ¯å¡ç‰‡ï¼ˆæ ¹æ®æ€»ä½“è®¾è®¡æ–¹æ¡ˆï¼‰ -->
    {% if opportunity.status == 'won' or opportunity.status == 'lost' %}
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">{% if opportunity.status == 'won' %}èµ¢å•ä¿¡æ¯{% else %}è¾“å•ä¿¡æ¯{% endif %}</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                {% if opportunity.status == 'won' %}
                <div class="info-item">
                    <span class="info-label">å®é™…ç­¾çº¦é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</span>
                    <span class="info-value info-value-numeric {% if not opportunity.actual_amount %}info-value-empty{% endif %}">
                        {% if opportunity.actual_amount %}{{ opportunity.actual_amount|floatformat:2 }}{% else %}æœªå¡«å†™{% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆåŒç¼–å·</span>
                    <span class="info-value {% if not opportunity.contract_number %}info-value-empty{% endif %}">
                        {{ opportunity.contract_number|default:'æœªå¡«å†™' }}
                    </span>
                </div>
                {% if opportunity.actual_sign_date %}
                <div class="info-item">
                    <span class="info-label">å®é™…ç­¾çº¦æ—¥æœŸ</span>
                    <span class="info-value">{{ opportunity.actual_sign_date|date:'Y-m-d' }}</span>
                </div>
                {% endif %}
                {% if opportunity.win_reason %}
                <div class="info-item" style="grid-column: 1 / -1;">
                    <span class="info-label">èµ¢å•åŸå› </span>
                    <span class="info-value">{{ opportunity.win_reason|linebreaks }}</span>
                </div>
                {% endif %}
                {% else %}
                {% if opportunity.loss_reason %}
                <div class="info-item" style="grid-column: 1 / -1;">
                    <span class="info-label">è¾“å•åŸå› </span>
                    <span class="info-value">{{ opportunity.loss_reason|linebreaks }}</span>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- å¥åº·åº¦è¯„åˆ†å¡ç‰‡ï¼ˆæ ¹æ®æ€»ä½“è®¾è®¡æ–¹æ¡ˆï¼ŒAPIå·²å®ç°ï¼‰ -->
    {% if opportunity.health_score and opportunity.health_score > 0 %}
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">å¥åº·åº¦è¯„åˆ†</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                <div class="info-item">
                    <span class="info-label">å¥åº·åº¦è¯„åˆ†</span>
                    <span class="info-value">
                        <span class="badge {% if opportunity.health_score >= 80 %}bg-success{% elif opportunity.health_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ opportunity.health_score }}åˆ†
                        </span>
                        {% if opportunity.health_score >= 80 %}
                        <span class="ms-2">ğŸŸ¢ å¥åº·</span>
                        {% elif opportunity.health_score >= 60 %}
                        <span class="ms-2">ğŸŸ¡ ä¸€èˆ¬</span>
                        {% else %}
                        <span class="ms-2">ğŸ”´ é«˜é£é™©</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- è·Ÿè¿›è®°å½•å¡ç‰‡ -->
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">è·Ÿè¿›è®°å½•</h5>
            <div class="info-card-actions">
                <a href="{% url 'business_pages:opportunity_followup_create' opportunity.id %}" 
                   class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-circle"></i> æ–°å¢è·Ÿè¿›
                </a>
            </div>
        </div>
        <div class="info-card-body">
            {% if followups %}
            <!-- æ—¶é—´è½´æ ·å¼å±•ç¤ºè·Ÿè¿›è®°å½• -->
            <div class="timeline">
                {% for followup in followups %}
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>{{ followup.follow_date|date:"Y-m-d" }}</strong>
                                <span class="badge bg-secondary ms-2">
                                    {{ followup.get_follow_type_display }}
                                </span>
                                {% if followup.next_follow_date %}
                                <span class="badge bg-info ms-2">
                                    é¢„è®¡ä¸‹æ¬¡ï¼š{{ followup.next_follow_date|date:"Y-m-d" }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="btn-group btn-group-sm">
                                {% if followup.created_by == user or can_edit %}
                                <a href="{% url 'business_pages:opportunity_followup_edit' opportunity.id followup.id %}" 
                                   class="btn btn-outline-secondary btn-sm" title="ç¼–è¾‘">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{% url 'business_pages:opportunity_followup_delete' opportunity.id followup.id %}" 
                                   class="btn btn-outline-danger btn-sm" title="åˆ é™¤">
                                    <i class="bi bi-trash"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% if followup.participants %}
                        <div class="mb-2">
                            <span class="text-muted small">å‚ä¸äººå‘˜ï¼š</span>
                            {{ followup.participants }}
                        </div>
                        {% endif %}
                        <div class="mb-2">
                            <span class="text-muted small">è·Ÿè¿›å†…å®¹ï¼š</span>
                            <p class="mb-0">{{ followup.content|linebreaks }}</p>
                        </div>
                        {% if followup.customer_feedback %}
                        <div class="mb-2">
                            <span class="text-muted small">å®¢æˆ·åé¦ˆï¼š</span>
                            <p class="mb-0 text-success">{{ followup.customer_feedback|linebreaks }}</p>
                        </div>
                        {% endif %}
                        {% if followup.next_plan %}
                        <div class="mb-2">
                            <span class="text-muted small">ä¸‹ä¸€æ­¥è®¡åˆ’ï¼š</span>
                            <p class="mb-0">{{ followup.next_plan|linebreaks }}</p>
                        </div>
                        {% endif %}
                        <div class="text-muted small">
                            <i class="bi bi-person"></i> {{ followup.created_by.get_full_name|default:followup.created_by.username }}
                            <span class="ms-2">
                                <i class="bi bi-clock"></i> {{ followup.created_time|date:"Y-m-d H:i" }}
                            </span>
                        </div>
                    </div>
                </div>
                        {% endfor %}
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">æš‚æ— è·Ÿè¿›è®°å½•</p>
                <a href="{% url 'business_pages:opportunity_followup_create' opportunity.id %}" 
                   class="btn btn-primary mt-2">
                    <i class="bi bi-plus-circle"></i> åˆ›å»ºç¬¬ä¸€æ¡è·Ÿè¿›è®°å½•
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- æ—¶é—´è½´æ ·å¼CSS -->
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 30px;
            padding-left: 20px;
        }
        
        .timeline-item:last-child {
            padding-bottom: 0;
        }
        
        .timeline-marker {
            position: absolute;
            left: -8px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--vh-primary);
            border: 2px solid var(--vh-card-bg);
            z-index: 2;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 17px;
            bottom: -15px;
            width: 2px;
            background: var(--vh-border);
        }
        
        .timeline-item:last-child::before {
            display: none;
        }
        
        .timeline-content {
            background: var(--vh-surface);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border-left: 3px solid var(--vh-primary);
        }
    </style>
    
    <!-- æŠ¥ä»·è®°å½• -->
    <div class="info-card info-card-fade-in">
        <div class="info-card-header">
            <h5 class="info-card-title">æŠ¥ä»·è®°å½•</h5>
            <div class="info-card-actions">
                {% if quotations %}
                <span class="badge bg-secondary">{{ quotations|length }} ä¸ªç‰ˆæœ¬</span>
                {% endif %}
                {% if can_edit %}
                <a href="{% url 'business_pages:opportunity_bidding_quotation' %}?opportunity_id={{ opportunity.id }}" 
                   class="btn btn-sm btn-primary" title="åˆ›å»ºæŠ¥ä»·">
                    <i class="bi bi-plus-circle"></i> æ–°å»ºæŠ¥ä»·
                </a>
                {% endif %}
            </div>
        </div>
        <div class="info-card-body">
            {% if quotations %}
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th style="width: 100px;">ç‰ˆæœ¬å·</th>
                            <th style="width: 100px;">ç‰ˆæœ¬ç±»å‹</th>
                            <th style="width: 120px; text-align: right;">æŠ¥ä»·é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</th>
                            <th style="width: 100px;">æŠ¥ä»·æ¨¡å¼</th>
                            <th style="width: 150px;">åˆ›å»ºäºº</th>
                            <th style="width: 150px;">åˆ›å»ºæ—¶é—´</th>
                            <th style="width: 120px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for quotation in quotations %}
                        <tr>
                            <td>V{{ quotation.version_number }}</td>
                            <td>
                                <span class="badge {% if quotation.version_type == 'final' %}bg-success{% elif quotation.version_type == 'customer' %}bg-primary{% else %}bg-secondary{% endif %}">
                                    {{ quotation.get_version_type_display }}
                                </span>
                            </td>
                            <td style="text-align: right;" class="info-value-numeric">
                                {% if quotation.final_quotation %}
                                    {{ quotation.final_quotation|floatformat:2 }}
                                {% elif quotation.service_fee %}
                                    {{ quotation.service_fee|floatformat:2 }}
                                {% else %}
                                    {{ quotation.total_amount|floatformat:2|default:'0.00' }}
                                {% endif %}
                            </td>
                            <td>
                                {% if quotation.quotation_mode %}
                                    <span class="badge bg-info">{{ quotation.get_quotation_mode_display }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ quotation.created_by.get_full_name|default:quotation.created_by.username }}</td>
                            <td>{{ quotation.created_time|date:'Y-m-d H:i' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'business_pages:opportunity_bidding_quotation' %}?quotation_id={{ quotation.id }}" 
                                       class="btn btn-outline-primary" title="æŸ¥çœ‹è¯¦æƒ…">
                                    <i class="bi bi-eye"></i>
                                </a>
                                    {% if can_edit %}
                                    <a href="{% url 'business_pages:opportunity_bidding_quotation' %}?quotation_id={{ quotation.id }}&edit=1" 
                                       class="btn btn-outline-secondary" title="ç¼–è¾‘">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">æš‚æ— æŠ¥ä»·è®°å½•</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if quotations|length > 10 %}
            <div class="text-center mt-3">
                <small class="text-muted">ä»…æ˜¾ç¤ºæœ€è¿‘10æ¡è®°å½•ï¼Œå…±{{ quotations|length }}æ¡</small>
            </div>
            {% endif %}
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">æš‚æ— æŠ¥ä»·è®°å½•</p>
                {% if can_edit %}
                <a href="{% url 'business_pages:opportunity_bidding_quotation' %}?opportunity_id={{ opportunity.id }}" 
                   class="btn btn-primary mt-2">
                    <i class="bi bi-plus-circle"></i> åˆ›å»ºç¬¬ä¸€ä¸ªæŠ¥ä»·
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

