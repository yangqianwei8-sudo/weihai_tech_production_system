{% extends "customer_management/base.html" %}

{% block title %}{{ page_title }} - 维海科技信息化管理平台{% endblock %}

{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
    .form-card {
        max-width: 1000px;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'business_pages:opportunity_management' %}">商机管理</a></li>
<li class="breadcrumb-item"><a href="{% url 'business_pages:opportunity_business_negotiation' %}">商务洽谈登记</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ page_title }}</li>
{% endblock %}

{% block content %}
<div class="workspace-content">
    {% if opportunity %}
    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">关联商机信息</h5>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-2">
                <div class="info-item">
                    <span class="info-label">商机名称</span>
                    <span class="info-value">{{ opportunity.name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">商机编号</span>
                    <span class="info-value">{{ opportunity.opportunity_number|default:'未编号' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">关联客户</span>
                    <span class="info-value">{{ opportunity.client.name|default:'未关联' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">当前状态</span>
                    <span class="info-value">
                        <span class="badge bg-primary">{{ opportunity.get_status_display }}</span>
                    </span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <form method="post" class="form-card" id="negotiationForm" novalidate>
        {% csrf_token %}
        
        <div class="form-section">
            <h5>基本信息</h5>
            <div class="form-group">
                <label for="opportunity_id" class="form-label">关联商机 <span class="text-danger">*</span></label>
                <select name="opportunity_id" id="opportunity_id" class="form-control" required>
                    <option value="">请选择商机</option>
                    {% for opp in opportunities %}
                    <option value="{{ opp.id }}" {% if opportunity and opportunity.id == opp.id %}selected{% endif %}>
                        {{ opp.name }} ({{ opp.opportunity_number|default:'未编号' }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="negotiation_date" class="form-label">洽谈日期 <span class="text-danger">*</span></label>
                <input type="date" name="negotiation_date" id="negotiation_date" class="form-control" 
                       value="{% now 'Y-m-d' %}" required>
            </div>
            <div class="form-group">
                <label for="negotiation_type" class="form-label">洽谈类型 <span class="text-danger">*</span></label>
                <select name="negotiation_type" id="negotiation_type" class="form-control" required>
                    <option value="">请选择洽谈类型</option>
                    <option value="phone">电话沟通</option>
                    <option value="meeting">会议洽谈</option>
                    <option value="visit">上门拜访</option>
                    <option value="email">邮件沟通</option>
                    <option value="online">线上会议</option>
                    <option value="other">其他</option>
                </select>
            </div>
            <div class="form-group">
                <label for="participants" class="form-label">参与人员</label>
                <input type="text" name="participants" id="participants" class="form-control" 
                       placeholder="请输入参与人员（可选）">
            </div>
        </div>
        
        <div class="form-section">
            <h5>洽谈内容</h5>
            <div class="form-group">
                <label for="content" class="form-label">洽谈内容 <span class="text-danger">*</span></label>
                <textarea name="content" id="content" class="form-control" rows="6" 
                          placeholder="请输入本次洽谈的具体内容" required></textarea>
            </div>
            <div class="form-group">
                <label for="client_feedback" class="form-label">客户反馈</label>
                <textarea name="client_feedback" id="client_feedback" class="form-control" rows="4" 
                          placeholder="请输入客户的反馈意见（可选）"></textarea>
            </div>
            <div class="form-group">
                <label for="next_plan" class="form-label">下一步计划</label>
                <textarea name="next_plan" id="next_plan" class="form-control" rows="4" 
                          placeholder="请输入下一步的工作计划（可选）"></textarea>
            </div>
        </div>
        
        <div class="form-section">
            <h5>商务条款</h5>
            <div class="form-group">
                <label for="discussed_amount" class="form-label">讨论金额（万元）</label>
                <input type="number" name="discussed_amount" id="discussed_amount" class="form-control" 
                       step="0.01" min="0" placeholder="请输入讨论的金额">
            </div>
            <div class="form-group">
                <label for="payment_terms" class="form-label">付款条件</label>
                <textarea name="payment_terms" id="payment_terms" class="form-control" rows="3" 
                          placeholder="请输入付款条件（可选）"></textarea>
            </div>
            <div class="form-group">
                <label for="contract_terms" class="form-label">合同条款</label>
                <textarea name="contract_terms" id="contract_terms" class="form-control" rows="3" 
                          placeholder="请输入合同条款（可选）"></textarea>
            </div>
        </div>
        
        <!-- 提交按钮 -->
        <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="submit" class="btn btn-primary">保存商务洽谈登记</button>
            <a href="{% url 'business_pages:opportunity_business_negotiation' %}" class="btn btn-secondary">取消</a>
        </div>
    </form>
</div>
{% endblock %}

