{% extends "customer_management/base.html" %}
{% load static %}

{% block title %}{{ page_title }} - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
    .form-group {
        margin-bottom: 20px;
    }
    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: block;
    }
    .required-field::after {
        content: " *";
        color: #ef4444;
    }
    .party-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .party-item-header {
    

        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'business_pages:contract_management_list' %}">åˆåŒç®¡ç†</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ page_title }}</li>
{% endblock %}

{% block content %}<div class="container-fluid py-4">
    <div class="form-page-title">
            <h1>{{ page_title }}</h1>
            {% if page_description %}
            <p>{{ page_description }}</p>
            {% endif %}
        </div>

    <form method="post" enctype="multipart/form-data" id="contract-form" class="form-card">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
        <div class="alert alert-danger">
        {% endif %}
            {{ form.non_field_errors }}
        </div>
        
        <!-- åˆåŒè¯†åˆ«åŠŸèƒ½ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ğŸ¤– AIåˆåŒè¯†åˆ«</h5>
                <button type="button" id="recognize-contract-btn" class="btn btn-primary">
                    <i class="bi bi-magic"></i> å¼€å§‹è¯†åˆ«
                </button>
            </div>
            <div class="alert alert-info" style="margin-bottom: 16px; font-size: 13px;">
                <i class="bi bi-info-circle"></i> ä¸Šä¼ åˆåŒæ–‡ä»¶ï¼ˆPDFã€å›¾ç‰‡ï¼‰ï¼ŒAIå°†è‡ªåŠ¨è¯†åˆ«å¹¶å¡«å……è¡¨å•ä¿¡æ¯
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label class="form-label">ä¸Šä¼ åˆåŒæ–‡ä»¶</label>
                        <input type="file" id="contract-file-input" class="form-control"
                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                               style="padding: 8px;">
                        <small class="form-text text-muted">æ”¯æŒæ ¼å¼ï¼šPDFã€JPGã€PNGã€DOCã€DOCXï¼Œæœ€å¤§10MB</small>
                    </div>
                </div>
            </div>
            <div id="recognition-status" style="display: none; margin-top: 12px;">
                <div class="alert alert-warning">
                    <i class="bi bi-hourglass-split"></i> <span id="recognition-message">æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</span>
                </div>
            </div>
            <div id="recognition-result" style="display: none; margin-top: 12px;">
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> è¯†åˆ«å®Œæˆï¼å·²è‡ªåŠ¨å¡«å……è¡¨å•ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥å¹¶ç¡®è®¤ã€‚
                </div>
            </div>
        </div>
        
        <!-- ä¸€ã€åŸºç¡€ä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>åŸºç¡€ä¿¡æ¯</h5>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">å®¡æ‰¹å•å·</label>
                        <input type="text" id="approval_number" name="approval_number" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ">
                        <small class="form-text text-muted">ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">æäº¤éƒ¨é—¨</label>
                        <input type="text" id="submit_department" name="submit_department" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value="{% if request.user.department %}{{ request.user.department.name }}{% else %}æœªè®¾ç½®éƒ¨é—¨{% endif %}">
                        <small class="form-text text-muted">ç³»ç»Ÿé»˜è®¤</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">æäº¤äºº</label>
                        <input type="text" id="submitter" name="submitter" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" value="{{ request.user.get_full_name|default:request.user.username }}">
                        <small class="form-text text-muted">ç³»ç»Ÿé»˜è®¤</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">æäº¤æ—¥æœŸ</label>
                        <input type="date" id="submit_date" name="submit_date" class="form-control" value="{% now 'Y-m-d' %}" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                        <small class="form-text text-muted">å½“å¤©</small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field">é¡¹ç›®ç¼–å·</label>
                        {{ form.project_number }}
                        {% if form.project_number.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.project_number.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">YYYY-ç³»ç»Ÿè‡ªåŠ¨å››ä½è¿æ¥ç¼–å·ï¼Œä¸å¾—é‡å¤</small>
                    </div>
                </div>
                <!-- åˆåŒç¼–å· -->
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">åˆåŒç¼–å·</label>
                        <input type="text" id="contract_number_display" name="contract_number_display" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="HT+é¡¹ç›®ç¼–å·">
                        <small class="form-text text-muted">HT+é¡¹ç›®ç¼–å·ï¼Œè‡ªåŠ¨ç”Ÿæˆ</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field">é¡¹ç›®åç§°</label>
                        {{ form.project_name }}
                        {% if form.project_name.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.project_name.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">é¡¹ç›®ä¸šæ€</label>
                        <select id="project_business_type" name="project_business_type" class="form-select">
                            <option value="">-- è¯·é€‰æ‹©é¡¹ç›®ä¸šæ€ --</option>
                            {% for business_type in business_types %}
                            <option value="{{ business_type.id }}">{{ business_type.name }}</option>
        }
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">åå°å¼•å…¥</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">åˆåŒæš‚å®šä»·æ¬¾</label>
                        <input type="number" id="provisional_price" name="provisional_price" class="form-control" step="0.01" placeholder="0.00">
                        <small class="form-text text-muted">å•ä½ï¼šå…ƒ</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">çº¦å®šç®¡è¾–</label>
                        <select id="governing_law" name="governing_law" class="form-select">
                            <option value="">-- è¯·é€‰æ‹©çº¦å®šç®¡è¾– --</option>
                            {% for value, label in governing_law_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                </div>
            </div>
        </div>
        <!-- äºŒã€ä¸»ä½“ä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ä¸»ä½“ä¿¡æ¯</h5>
            </div>
            <!-- å®¢æˆ·æ–¹ä¿¡æ¯ -->
            <div style="margin-bottom: 24px;">
                <h6 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1f2937;">å®¢æˆ·æ–¹ä¿¡æ¯</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label required-field">å®¢æˆ·å…¬å¸</label>
                            {{ form.client }}
                            {% if form.client.errors %}
                            <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.client.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">æ ¹æ®å®¢æˆ·ç®¡ç†</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </label>
                            <input type="text" id="client_credit_code" name="client_credit_code" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="è‡ªåŠ¨å¸¦å…¥">
                            <small class="form-text text-muted">è‡ªåŠ¨å¸¦å…¥ï¼Œå®¢æˆ·ç®¡ç†</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">æ³•å®šä»£è¡¨äºº</label>
                            <input type="text" id="client_legal_representative" name="client_legal_representative" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="è‡ªåŠ¨å¸¦å…¥">
                            <small class="form-text text-muted">è‡ªåŠ¨å¸¦å…¥ï¼Œå®¢æˆ·ç®¡ç†</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®ä»£è¡¨</label>
                            <select id="client_project_representative" name="client_project_representative" class="form-select">
                                <option value="">-- è¯·é€‰æ‹©é¡¹ç›®ä»£è¡¨ --</option>
                            </select>
                            <small class="form-text text-muted">é€‰æ‹©ï¼Œå®¢æˆ·ç®¡ç†</small>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">è”ç³»æ–¹å¼</label>
                            <input type="text" id="client_contact" name="client_contact" class="form-control" readonly style="background-color: #f5f5f5; cursor: not-allowed;" placeholder="è‡ªåŠ¨å¸¦å…¥">
                            <small class="form-text text-muted">è‡ªåŠ¨å¸¦å…¥ï¼Œå®¢æˆ·ç®¡ç†</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æˆ‘æ–¹ä¿¡æ¯ -->
            <div>
                <h6 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1f2937;">æˆ‘æ–¹ä¿¡æ¯</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">æˆ‘æ–¹ç­¾çº¦ä¸»ä½“</label>
                            <select id="our_signing_party" name="our_signing_party" class="form-select">
                                                                                        <option value="">-- è¯·é€‰æ‹©æˆ‘æ–¹ç­¾çº¦ä¸»ä½“ --</option></select>
                            <small class="form-text text-muted">é€‰æ‹©ï¼Œåå°å¼•å…¥</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">é¡¹ç›®è´Ÿè´£äºº</label>
                            <select id="project_manager" name="project_manager" class="form-select">
                                                            <option value="">-- è¯·é€‰æ‹©é¡¹ç›®è´Ÿè´£äºº --</option>
                            {% for manager in project_managers %}
                            <option value="{{ manager.id }}">{{ manager.get_full_name|default:manager.username }}</option>
        }
                            {% endfor %}</select>
                            <small class="form-text text-muted">é€‰æ‹©</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">å•†åŠ¡è´Ÿè´£äºº</label>
                            <select id="business_manager" name="business_manager" class="form-select">
                                                            <option value="">-- è¯·é€‰æ‹©å•†åŠ¡è´Ÿè´£äºº --</option>
                            {% for manager in business_managers %}
                            <option value="{{ manager.id }}" {% if manager.id == user.id %}selected{% endif %}>{{ manager.get_full_name|default:manager.username }}</option>
        }
                            {% endfor %}</select>
                            <small class="form-text text-muted">é€‰æ‹©ï¼Œé»˜è®¤</small>
        </div>
                        </div>
                    </div>
                </div>
            </div>
        <!-- ç­¾çº¦ä¸»ä½“ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ğŸ‘¥ ç­¾çº¦ä¸»ä½“</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="parties-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">åºå·</th>
                            <th style="width: 100px;">å•ä½ç±»å‹ <span class="text-danger">*</span></th>
                            <th style="width: 180px;">å•ä½åç§° <span class="text-danger">*</span></th>
                            <th style="width: 150px;">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </th>
                            <th style="width: 120px;">æ³•å®šä»£è¡¨äºº</th>
                            <th style="width: 120px;">é¡¹ç›®è´Ÿè´£äºº</th>
                            <th style="width: 120px;">è”ç³»ç”µè¯</th>
                            <th style="width: 150px;">è”ç³»é‚®ç®±</th>
                            <th style="width: 200px;">åŠå…¬åœ°å€</th>
                            <th style="width: 80px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="parties-container">
                        <!-- ç­¾çº¦ä¸»ä½“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 16px; text-align: left;">
                <button type="button" class="btn btn-sm btn-primary" id="add-party-btn">
                    <i class="bi bi-plus-circle"></i> æ·»åŠ ç­¾çº¦ä¸»ä½“
                </button>
            </div>
        </div>

        <!-- å››ã€æœåŠ¡ä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>æœåŠ¡ä¿¡æ¯</h5>
                <button type="button" class="btn btn-sm btn-primary" id="add-service-content-btn">
                    <i class="bi bi-plus-circle"></i> æ·»åŠ æœåŠ¡ä¿¡æ¯
                </button>
            </div>
            <div id="service-contents-container">
                <!-- æœåŠ¡ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>
        </div>

                <!-- äº”ã€ä»·æ¬¾ä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>ä»·æ¬¾ä¿¡æ¯</h5>
            </div>
            
            <!-- ç»“ç®—æ–¹å¼é€‰æ‹© -->
            <div class="row" style="margin-bottom: 20px;">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ç»“ç®—æ–¹å¼</label>
                        <select id="settlement_method" name="settlement_method" class="form-select">
                            <option value="">-- è¯·é€‰æ‹©ç»“ç®—æ–¹å¼ --</option>
                            {% for method in settlement_methods %}
                            <option value="{{ method.code }}" data-name="{{ method.name }}">{{ method.name }}</option>
        }
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">åå°å¼•å…¥ï¼Œæœªé€‰æ‹©æ—¶éšè—åˆ—è¡¨</small>
                    </div>
                </div>
            </div>
            
            <!-- æ ¹æ®ç»“ç®—æ–¹å¼æ˜¾ç¤ºä¸åŒçš„åˆ—è¡¨ -->
            <!-- åŒ…å¹²æ€»ä»·åˆ—è¡¨ -->
            <div id="fixed-total-list" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;">åºå·</th>
                                <th style="width: 150px;">é¢ç§¯è§„æ¨¡</th>
                                <th style="width: 120px;">é¢ç§¯ç±»å‹</th>
                                <th style="width: 150px;">æœåŠ¡è´¹</th>
                            </tr>
                        </thead>
                        <tbody id="fixed-total-container">
                            <!-- åŒ…å¹²æ€»ä»·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 16px; text-align: left;">
                    <button type="button" class="btn btn-sm btn-primary" id="add-fixed-total-btn">
                        <i class="bi bi-plus-circle"></i> å¢åŠ è¡Œ
                    </button>
                </div>
            </div>
        </div>
        <!-- ä¸ƒã€å›æ¬¾ä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>å›æ¬¾ä¿¡æ¯</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="payment-info-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">åºå·</th>
                            <th style="width: 120px;">æ¬¾é¡¹åç§°</th>
                            <th style="width: 150px;">è§¦å‘èŠ‚ç‚¹ <span class="text-danger">*</span></th>
                            <th style="width: 150px;">ä»˜æ¬¾æ–¹å¼ <span class="text-danger">*</span></th>
                            <th style="width: 150px;">å›æ¬¾é‡‘é¢ï¼ˆå…ƒï¼‰</th>
                            <th style="width: 200px;">ä»˜æ¬¾æ¡ä»¶</th>
                            <th style="width: 80px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="payment-info-container">
                        <!-- å›æ¬¾ä¿¡æ¯åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 16px; text-align: left;">
                <button type="button" class="btn btn-sm btn-primary" id="add-payment-info-btn">
                    <i class="bi bi-plus-circle"></i> æ·»åŠ å›æ¬¾ä¿¡æ¯
                </button>
            </div>
        </div>
        <!-- ä¸‰ã€åˆåŒä¿¡æ¯ -->
        <div class="form-section">
            <div class="form-section-header">
                <h5>åˆåŒä¿¡æ¯</h5>

            </div>
            <!-- åˆåŒåç§° -->
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label required-field" for="{{ form.contract_name.id_for_label }}">{{ form.contract_name.label }}</label>
                        {{ form.contract_name }}
                        {% if form.contract_name.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_name.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <!-- åˆåŒç±»å‹ -->
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.contract_type.id_for_label }}">{{ form.contract_type.label }}</label>
                        {{ form.contract_type }}
                        {% if form.contract_type.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_type.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <!-- ç»“æ„å½¢å¼ -->
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.structure_type.id_for_label }}">{{ form.structure_type.label }}</label>
                        {{ form.structure_type }}
                        {% if form.structure_type.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.structure_type.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <!-- è®¾è®¡å•ä½åˆ†ç±» -->
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.design_unit_category.id_for_label }}">{{ form.design_unit_category.label }}</label>
                        {{ form.design_unit_category }}
                        {% if form.design_unit_category.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.design_unit_category.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- é‡‘é¢ä¿¡æ¯ -->
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.contract_amount.id_for_label }}">{{ form.contract_amount.label }}</label>
                        {{ form.contract_amount }}
                        {% if form.contract_amount.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_amount.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">å•ä½ï¼šå…ƒ</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.tax_rate.id_for_label }}">{{ form.tax_rate.label }}</label>
                        {{ form.tax_rate }}
                        {% if form.tax_rate.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.tax_rate.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">é»˜è®¤6%</small>
                    </div>
                </div>
            </div>
            <!-- æ—¶é—´ä¿¡æ¯ -->
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.contract_date.id_for_label }}">{{ form.contract_date.label }}</label>
                        {{ form.contract_date }}
                        {% if form.contract_date.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.contract_date.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.effective_date.id_for_label }}">{{ form.effective_date.label }}</label>
                        {{ form.effective_date }}
                        {% if form.effective_date.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.effective_date.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.start_date.id_for_label }}">{{ form.start_date.label }}</label>
                        {{ form.start_date }}
                        {% if form.start_date.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.start_date.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.end_date.id_for_label }}">{{ form.end_date.label }}</label>
                        {{ form.end_date }}
                        {% if form.end_date.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.end_date.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- å…¶ä»–ä¿¡æ¯ -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                        <label class="form-label" for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.notes.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
<script>
    const contractFileInput = document.getElementById('contract-file-input');
    const recognizeBtn = document.getElementById('recognize-contract-btn');
    const recognitionStatus = document.getElementById('recognition-status');
    const recognitionResult = document.getElementById('recognition-result');
    const recognitionMessage = document.getElementById('recognition-message');
    
    if (recognizeBtn && contractFileInput) {
        recognizeBtn.addEventListener('click', async function() {
            const file = contractFileInput.files[0];
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©åˆåŒæ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 10 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                return;
            }
            
            // æ˜¾ç¤ºè¯†åˆ«çŠ¶æ€
            recognitionStatus.style.display = 'block';
            recognitionResult.style.display = 'none';
            recognitionMessage.textContent = 'æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...';
            recognizeBtn.disabled = true;
            
            // åˆ›å»ºFormData
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // è°ƒç”¨è¯†åˆ«API
                const response = await fetch('/api/customer/contracts/recognize/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // è¯†åˆ«æˆåŠŸï¼Œå¡«å……è¡¨å•
                    fillFormWithRecognitionResult(result.data);
                    recognitionMessage.textContent = 'è¯†åˆ«å®Œæˆï¼';
                    recognitionStatus.style.display = 'none';
                    recognitionResult.style.display = 'block';
                } else {
                    // è¯†åˆ«å¤±è´¥
                    recognitionMessage.textContent = 'è¯†åˆ«å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯');
                    recognitionStatus.querySelector('.alert').className = 'alert alert-danger';
                }
            } catch (error) {
                recognitionMessage.textContent = 'è¯†åˆ«å¤±è´¥ï¼š' + error.message;
                recognitionStatus.querySelector('.alert').className = 'alert alert-danger';
            } finally {
                recognizeBtn.disabled = false;
            }
        });
    }
    
    // å¡«å……è¡¨å•æ•°æ®
    function fillFormWithRecognitionResult(data) {
        // åˆåŒåç§°
        if (data.contract_name) {
            const contractNameField = document.querySelector('[name=]"contract_name"]');
            if (contractNameField && !contractNameField.value) {
                contractNameField.value = data.contract_name;
            }
        
        // é¡¹ç›®ç¼–å·ï¼ˆåˆåŒç¼–å·ï¼‰
        if (data.contract_number) {
            const contractNumberField = document.querySelector('[name="project_number"]');
            if (contractNumberField && !contractNumberField.value) {
                contractNumberField.value = data.contract_number;
            }
        
        // åˆåŒç±»å‹
        if (data.contract_type) {
            const contractTypeField = document.querySelector('[name="contract_type"]');
            if (contractTypeField) {
                // å°è¯•åŒ¹é…åˆåŒç±»å‹
                const options = contractTypeField.querySelectorAll('option');
                for (let opt of options) {
                    if (opt.textContent.includes(data.contract_type) || data.contract_type.includes(opt.textContent)) {
                        contractTypeField.value = opt.value;
                        break;
                    }
                }
            }
        
        // åˆåŒæè¿°
        if (data.description) {
            const descField = document.querySelector('[name="description"]');
            if (descField && !descField.value) {
                descField.value = data.description;
            }
        
        if (data.party_a && data.party_a.name) {
            if (partyRows.length > 0) {
                const firstRow = partyRows[0];
                const partyNameInput = firstCard.querySelector('input[name*="[party_name]"]');
                if (partyNameInput && !partyNameInput.value) {
                    partyNameInput.value = data.party_a.name;
                }
                if (data.party_a.contact) {
                    const contactInput = firstCard.querySelector('input[name*="[party_contact]"]');
                if (data.party_a.phone) {
                    const phoneInput = firstCard.querySelector('input[name*="[contact_phone]"]');
                if (data.party_a.email) {
                    const emailInput = firstCard.querySelector('input[name*="[contact_email]"]');
                if (data.party_a.address) {
                    const addressInput = firstCard.querySelector('input[name*="[address]"]');
                if (data.party_a.credit_code) {
                    const creditCodeInput = firstCard.querySelector('input[name*="[credit_code]"]');
                if (data.party_a.legal_representative) {
                    const legalRepInput = firstCard.querySelector('input[name*="[legal_representative]"]');
            }
        
        if (data.party_b && data.party_b.name) {
            let secondRow = null;
            if (partyRows.length > 1) {
                secondRow = partyRows[1];
                    if (newRows.length > 1) {
                        secondRow = newRows[1];
                    }
                }, 300);
            }
            
            if (secondRow) {
                const partyNameInput = secondRow.querySelector('input[name*="[party_name]"]');
                if (partyNameInput && !partyNameInput.value) {
                    partyNameInput.value = data.party_b.name;
                }
                if (data.party_b.contact) {
                    const contactInput = secondRow.querySelector('input[name*="[party_contact]"]');
                if (data.party_b.phone) {
                    const phoneInput = secondRow.querySelector('input[name*="[contact_phone]"]');
                if (data.party_b.email) {
                    const emailInput = secondRow.querySelector('input[name*="[contact_email]"]');
                if (data.party_b.address) {
                    const addressInput = secondRow.querySelector('input[name*="[address]"]');
                if (data.party_b.credit_code) {
                    const creditCodeInput = secondRow.querySelector('input[name*="[credit_code]"]');
                if (data.party_b.legal_representative) {
                    const legalRepInput = secondRow.querySelector('input[name*="[legal_representative]"]');
            }
        
        // å¦‚æœæœ‰åˆåŒé‡‘é¢ï¼Œå¯ä»¥å°è¯•å¡«å……åˆ°ç»“ç®—æ–¹å¼ä¸­ï¼ˆå›ºå®šæ€»ä»·ï¼‰
    }
    
// ========== ç»“ç®—æ–¹å¼ç®¡ç†ï¼ˆè¡¨æ ¼å½¢å¼ï¼‰ ==========
    
    
    
    // ç»“ç®—æ–¹å¼é€‰é¡¹ï¼ˆä»æ¨¡æ¿ä¸­è·å–ï¼‰
    const settlementMethodOptions = [
        {% for method in settlement_methods %}
        { value: "{{ method.id }}", label: "{{ method.name }}" },
        {% endfor %}
    ];

    // å°é¡¶ç±»å‹é€‰é¡¹

    const serviceTypeOptions = [
        {% for st in service_types %}
        { value: '{{ st.id }}', label: '{{ st.name }}' },
        {% endfor %}
    ];

    // æ·»åŠ ç»“ç®—æ–¹å¼å¡ç‰‡
    
        // æ›´æ–°ç»“ç®—æ–¹å¼ç›¸å…³å­—æ®µçš„æ˜¾ç¤º
    // æ·»åŠ åˆ†æ®µå–è´¹è¡Œ
    function addSegmentedRate(cardIndex, rateData = null) {
        const rate = rateData || {};
        if (!container) return;
        
        const row = document.createElement('tr');
        row.setAttribute('data-rate-index', rateIndex);
        
        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            row.innerHTML = `
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.greater_than || ''}" placeholder="0.00">
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.less_than || ''}" placeholder="0.00">
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.rate || ''}" placeholder="0.00" required>
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${rate.service_fee || ''}" placeholder="0.00">
            </td>
            <td style="text-align: center;">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        container.appendChild(row);

        // ç»‘å®šæœåŠ¡è´¹è¾“å…¥æ¡†çš„changeäº‹ä»¶ï¼Œè‡ªåŠ¨è®¡ç®—å°è®¡
        const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
        if (serviceFeeInput) {
            serviceFeeInput.addEventListener('input', function() {
                calculateFixedTotalSum(cardIndex);
            });
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                row.remove();
                updateSegmentedRateNumbers(cardIndex);
            });
    }
    
    // æ›´æ–°åˆ†æ®µåºå·
    // æ·»åŠ æ€»ä»·åŒ…å¹²æ¡ç›®
    function addFixedTotalItem(cardIndex, itemData = null) {
        const item = itemData || {};
        if (!container) return;
        
        const row = document.createElement('tr');
        row.setAttribute('data-item-index', itemIndex);
        
        // TODO: ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            row.innerHTML = `
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${item.area_scale || ''}" placeholder="0.00" required>
            </td>
            <td>
                       class="form-control form-control-sm" step="0.01"
                       value="${item.service_fee || ''}" placeholder="0.00" required>
            </td>
            <td>
                    <i class="bi bi-trash"></i> åˆ é™¤
                </button>
            </td>
        `;
        
        container.appendChild(row);
        
        // ç»‘å®šæœåŠ¡è´¹è¾“å…¥æ¡†çš„changeäº‹ä»¶ï¼Œè‡ªåŠ¨è®¡ç®—å°è®¡
        const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
        if (serviceFeeInput) {
            serviceFeeInput.addEventListener('input', function() {
                calculateFixedTotalSum(cardIndex);
            });
        
        // è®¡ç®—å°è®¡
        calculateFixedTotalSum(cardIndex);
        
        // æ›´æ–°åºå·
        updateFixedTotalNumbers(cardIndex);
        
    }
    
    // æ›´æ–°æ€»ä»·åŒ…å¹²æ¡ç›®åºå·
    
    
    
    function updateFixedTotalNumbers(cardIndex) {
        if (!container) return;
        
        rows.forEach(function(row, index) {
            row.setAttribute('data-item-index', index);
            // æ›´æ–°nameå±æ€§ä¸­çš„ç´¢å¼•
            const inputs = row.querySelectorAll('input');
            inputs.forEach(function(input) {
                const name = input.getAttribute('name');
                if (name) {
                    // æ›¿æ¢ç´¢å¼•éƒ¨åˆ†
                    const newName = name.replace(/\[fixed_total_items\]\[\d+\]/, '[fixed_total_items][' + index + ']');
                    input.setAttribute('name', newName);
                }
            });
            // æ›´æ–°åˆ é™¤æŒ‰é’®çš„data-item-index
            if (removeBtn) {
                removeBtn.setAttribute('data-item-index', index);
            }
        });
    }

    
    // è®¡ç®—æ€»ä»·åŒ…å¹²æœåŠ¡è´¹å°è®¡
    function calculateFixedTotalSum(cardIndex) {
        if (!container || !sumElement) return;
        
        let total = 0;
        
        rows.forEach(function(row) {
            const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
            if (serviceFeeInput && serviceFeeInput.value) {
                const value = parseFloat(serviceFeeInput.value) || 0;
                total += value;
            }
        });
        
        // æ›´æ–°å°è®¡æ˜¾ç¤ºï¼Œä¿ç•™ä¸¤ä½å°æ•°
        sumElement.textContent = total.toFixed(2);
        // console.log(...) // å·²ç§»é™¤}`);
    }
    function updateSegmentedRateNumbers(cardIndex) {
        if (!container) return;
        
        rows.forEach((row, idx) => {
            row.setAttribute('data-rate-index', idx);
            // æ›´æ–°æ‰€æœ‰è¾“å…¥æ¡†çš„nameå±æ€§
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name) {
                    const newName = name.replace(/\[segmented_rates\]\[\d+\]/, '[segmented_rates][' + idx + ']');
                    input.setAttribute('name', newName);
                }
            });
        });
    }

    
    
    // æ›´æ–°å¡ç‰‡åºå·
    function updateSettlementMethodNumbers() {
        cards.forEach((card, idx) => {
            const titleElement = card.querySelector('.card-title');
            if (titleElement) {
                titleElement.textContent = `ç»“ç®—æ–¹å¼ #${idx + 1}`;
            }
            // æ›´æ–°data-index
            card.setAttribute('data-index', idx);
            // æ›´æ–°æ‰€æœ‰è¾“å…¥æ¡†çš„nameå±æ€§ä¸­çš„index
            const inputs = card.querySelectorAll('input, select');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name && name.includes('[')) {
                    const newName = name.replace(/\[(\d+)\]/, '[' + idx + ']');
                    input.setAttribute('name', newName);
                }
            });
        });
    }
    
    // æ·»åŠ æŒ‰é’®äº‹ä»¶
    

        // å¦‚æœæ˜¯æ€»ä»·åŒ…å¹²ï¼ŒåŠ è½½æ€»ä»·åŒ…å¹²æ¡ç›®åˆ—è¡¨
    });
        cards.forEach(function(card) {
            const indexAttr = card.getAttribute('data-index');
            if (indexAttr !== null) {
                const index = parseInt(indexAttr);
            }
        });
    }, 300);
    
    }
    
    
                // ç´¯è®¡ææˆï¼šéœ€è¦èŠ‚çœé‡‘é¢ï¼Œæš‚æ—¶æ— æ³•è®¡ç®—
                hasUncalculableMethod = true;
                    const unitPrice = parseFloat(fixedUnitPrice.value) || 0;
                    const totalArea = getTotalBuildingArea();
                    rowPrice += unitPrice * totalArea;
                }
                // æŒ‰å®ç»“ç®—éƒ¨åˆ†æš‚æ—¶æ— æ³•è®¡ç®—
                hasUncalculableMethod = true;
            } else {
                // å…¶ä»–ç»“ç®—æ–¹å¼ï¼ˆåˆ†æ®µé€’å¢ææˆã€è·³ç‚¹ææˆç­‰ï¼‰éœ€è¦èŠ‚çœé‡‘é¢ï¼Œæš‚æ—¶æ— æ³•è®¡ç®—
                hasUncalculableMethod = true;
            }
            
            totalPrice += rowPrice;
        });
        
        if (hasUncalculableMethod && totalPrice === 0) {
            contractPriceInput.value = 'éœ€æŒ‰å®ç»“ç®—';
        } else if (hasUncalculableMethod) {
            contractPriceInput.value = totalPrice.toFixed(2) + 'ï¼ˆéƒ¨åˆ†éœ€æŒ‰å®ç»“ç®—ï¼‰';
        } else if (totalPrice > 0) {
            contractPriceInput.value = totalPrice.toFixed(2);
        } else {
            contractPriceInput.value = '';
    }
    
    function getTotalBuildingArea() {
        let totalArea = 0;
        
            const areaInput = card.querySelector('input[name*="[area_scale]"]');
            if (areaInput && areaInput.value) {
                totalArea += parseFloat(areaInput.value) || 0;
            }
        });
        
        return totalArea;
    }
    
        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç›‘å¬æ‰€æœ‰ç»“ç®—æ–¹å¼ç›¸å…³å­—æ®µçš„å˜åŒ–
        
        // ç›‘å¬ç»“ç®—æ–¹å¼è¡¨æ ¼ä¸­é¢ç§¯è§„æ¨¡çš„å˜åŒ–
        
        
        // é¡µé¢åŠ è½½æ—¶è®¡ç®—ä¸€æ¬¡

        // ========== ç»‘å®šæ‰€æœ‰ç¼ºå¤±çš„æ·»åŠ è¡ŒæŒ‰é’® ==========
        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°è¡Œåºå·
        function updateRowNumbers(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const rows = container.querySelectorAll('tr');
            rows.forEach(function(row, index) {
                const numCell = row.querySelector('td:first-child strong');
                if (numCell) {
                    numCell.textContent = index + 1;
                }
            });

        // ç»‘å®šæ€»ä»·åŒ…å¹²æ·»åŠ æŒ‰é’®
        const addFixedTotalBtn = document.getElementById('add-fixed-total-btn');
        if (addFixedTotalBtn) {
            addFixedTotalBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('fixed-total-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="fixed_total_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="fixed_total_items[${index}][area_scale]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="fixed_total_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                    }
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('fixed-total-container');
                        calculateFixedTotalSubtotal();
                    });
                }
                const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
                if (serviceFeeInput) {
                    serviceFeeInput.addEventListener('input', calculateFixedTotalSubtotal);
                }
                updateRowNumbers('fixed-total-container');
                calculateFixedTotalSubtotal();
            });

        // ç»‘å®šåŒ…å¹²å•ä»·æ·»åŠ æŒ‰é’®
        const addFixedUnitBtn = document.getElementById('add-fixed-unit-btn');
        if (addFixedUnitBtn) {
            addFixedUnitBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('fixed-unit-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="fixed_unit_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="fixed_unit_items[${index}][area_size]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td>
                        <select name="fixed_unit_items[${index}][area_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="fixed_unit_items[${index}][unit_price]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="fixed_unit_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                    }
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('fixed-unit-container');
                        calculateFixedUnitSubtotal();
                    });
                }
                const inputs = row.querySelectorAll('input[name*="[area_size]"], input[name*="[unit_price]"], input[name*="[service_fee]"]');
                inputs.forEach(function(input) {
                    input.addEventListener('input', function() {
                        const areaInput = row.querySelector('input[name*="[area_size]"]');
                        const unitPriceInput = row.querySelector('input[name*="[unit_price]"]');
                        const serviceFeeInput = row.querySelector('input[name*="[service_fee]"]');
                        if (areaInput && unitPriceInput && serviceFeeInput) {
                            const area = parseFloat(areaInput.value) || 0;
                            const unitPrice = parseFloat(unitPriceInput.value) || 0;
                            serviceFeeInput.value = (area * unitPrice).toFixed(2);
                        }
                        calculateFixedUnitSubtotal();
                    });
                });
                updateRowNumbers('fixed-unit-container');
                calculateFixedUnitSubtotal();

        // ç»‘å®šç´¯è®¡ææˆæ·»åŠ æŒ‰é’®
        const addCumulativeCommissionBtn = document.getElementById('add-cumulative-commission-btn');
        if (addCumulativeCommissionBtn) {
            addCumulativeCommissionBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('cumulative-commission-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="cumulative_commission_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="cumulative_commission_items[${index}][area_scale]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td>
                        <select name="cumulative_commission_items[${index}][area_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="cumulative_commission_items[${index}][commission_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="cumulative_commission_items[${index}][adjustment_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00"></td>
                    <td><input type="number" name="cumulative_commission_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                    }
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('cumulative-commission-container');
                    });
                }
                updateRowNumbers('cumulative-commission-container');
            });

        // ç»‘å®šåˆ†æ®µææˆæ·»åŠ æŒ‰é’®
        const addSegmentedCommissionBtn = document.getElementById('add-segmented-commission-btn');
        if (addSegmentedCommissionBtn) {
            addSegmentedCommissionBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('segmented-commission-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="segmented_commission_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="segmented_commission_items[${index}][area_scale]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td>
                        <select name="segmented_commission_items[${index}][area_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="segmented_commission_items[${index}][amount_range]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="segmented_commission_items[${index}][commission_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="segmented_commission_items[${index}][adjustment_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00"></td>
                    <td><input type="number" name="segmented_commission_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                    }
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('segmented-commission-container');
                    });
                }
                updateRowNumbers('segmented-commission-container');
            });

        // ç»‘å®šè·³ç‚¹ææˆæ·»åŠ æŒ‰é’®
        const addJumpPointCommissionBtn = document.getElementById('add-jump-point-commission-btn');
        if (addJumpPointCommissionBtn) {
            addJumpPointCommissionBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const container = document.getElementById('jump-point-commission-container');
                if (!container) return;
                const rows = container.querySelectorAll('tr');
                const index = rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; vertical-align: middle;"><strong>${index + 1}</strong></td>
                    <td>
                        <select name="jump_point_commission_items[${index}][service_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="jump_point_commission_items[${index}][area_scale]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td>
                        <select name="jump_point_commission_items[${index}][area_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                        </select>
                    </td>
                    <td><input type="number" name="jump_point_commission_items[${index}][jump_point_amount]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="jump_point_commission_items[${index}][commission_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td><input type="number" name="jump_point_commission_items[${index}][adjustment_rate]" class="form-control form-control-sm" step="0.01" placeholder="0.00"></td>
                    <td><input type="number" name="jump_point_commission_items[${index}][service_fee]" class="form-control form-control-sm" step="0.01" placeholder="0.00" required></td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-row-btn"><i class="bi bi-trash"></i> åˆ é™¤</button>
                    </td>
                `;
                container.appendChild(row);
                    // å¡«å……æœåŠ¡ç±»å‹é€‰é¡¹
                    const serviceTypeSelect = row.querySelector('select[name*="[service_type]"]');
                    if (serviceTypeSelect && typeof serviceTypeOptions !== 'undefined') {
                        serviceTypeOptions.forEach(function(opt) {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            serviceTypeSelect.appendChild(option);
                        });
                    }
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        row.remove();
                        updateRowNumbers('jump-point-commission-container');
                    });
                }
                updateRowNumbers('jump-point-commission-container');
            });
            });

            
        (function() {
            const ourUnits = {{ our_units|safe|default:"[]" }};
            const select = document.getElementById('our_signing_party');
            if (select && Array.isArray(ourUnits)) {
                ourUnits.forEach(function(unit) {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    select.appendChild(option);
                
    

    // ========== æœåŠ¡ä¿¡æ¯ç®¡ç†ï¼ˆä½¿ç”¨Bootstrap Gridå¸ƒå±€ï¼‰ ==========
    let serviceContentIndex = 0;
    
    // æœåŠ¡ä¿¡æ¯æ•°æ®ï¼ˆä»åç«¯ä¼ å…¥ï¼‰
    const serviceTypesData = [
        {% for st in service_types %}
        { id: {{ st.id }}, name: "{{ st.name|escapejs }}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const designStagesData = [
        {% for ds in design_stages %}
        { id: {{ ds.id }}, name: "{{ ds.name|escapejs }}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const businessTypesData = [
        {% for bt in business_types %}
        { id: {{ bt.id }}, name: "{{ bt.name|escapejs }}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const serviceProfessionsData = [
        {% for sp in service_professions %}
        { id: {{ sp.id }}, name: "{{ sp.name|escapejs }}", service_type_id: {{ sp.service_type_id|default:"null" }} }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // æ·»åŠ æœåŠ¡ä¿¡æ¯è¡Œï¼ˆä½¿ç”¨Bootstrap Gridå¸ƒå±€ï¼‰
    function addServiceContentRow(serviceData = null) {
        const container = document.getElementById("service-contents-container");
        if (!container) {
            console.error("service-contents-container æœªæ‰¾åˆ°");
            return;
        }
        
        const index = serviceContentIndex++;
        const service = serviceData || {};
        
        // åˆ›å»ºæœåŠ¡ä¿¡æ¯è¡Œï¼ˆä½¿ç”¨Bootstrap Gridå¸ƒå±€ï¼‰
        const rowDiv = document.createElement("div");
        rowDiv.className = "service-content-row mb-3 p-3 border rounded";
        rowDiv.setAttribute("data-service-index", index);
        rowDiv.style.backgroundColor = "#f9fafb";
        
        rowDiv.innerHTML = `
            <div class="row mb-2">
                <div class="col-md-12 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" style="font-size: 14px; font-weight: 600; color: #374151;">æœåŠ¡ä¿¡æ¯ #${index + 1}</h6>
                    <button type="button" class="btn btn-sm btn-danger remove-service-content-btn">
                        <i class="bi bi-trash"></i> åˆ é™¤
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">æœåŠ¡ç±»å‹</label>
                        <select name="service_contents[${index}][service_type]" class="form-select form-select-sm">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">å›¾çº¸é˜¶æ®µ</label>
                        <select name="service_contents[${index}][design_stage]" class="form-select form-select-sm">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">å»ºç­‘é¢ç§¯ï¼ˆã¡ï¼‰</label>
                        <input type="number" name="service_contents[${index}][building_area]" class="form-control form-control-sm" step="0.01" placeholder="0.00" value="${service.building_area || 0}">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">é¡¹ç›®ä¸šæ€</label>
                        <select name="service_contents[${index}][business_type]" class="form-select form-select-sm">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">æœåŠ¡ä¸“ä¸š</label>
                        <select name="service_contents[${index}][service_professions]" class="form-select form-select-sm" multiple style="min-height: 80px;">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                        </select>
                        <small class="form-text text-muted">å¯å¤šé€‰ï¼ŒæŒ‰ä½Ctrl/Cmdé”®é€‰æ‹©å¤šä¸ª</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">æœåŠ¡å†…å®¹æè¿°</label>
                        <textarea name="service_contents[${index}][description]" class="form-control form-control-sm" rows="3" placeholder="è¯·è¾“å…¥æœåŠ¡å†…å®¹æè¿°">${(service.description || "").replace(/"/g, "&quot;").replace(/'/g, "&#39;")}</textarea>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(rowDiv);
        
        // å¡«å……ä¸‹æ‹‰é€‰é¡¹
        const serviceTypeSelect = rowDiv.querySelector(`select[name="service_contents[${index}][service_type]"]`);
        if (serviceTypeSelect) {
            serviceTypesData.forEach(function(st) {
                const option = document.createElement("option");
                option.value = st.id;
                option.textContent = st.name;
                if (service.service_type_id == st.id) option.selected = true;
                serviceTypeSelect.appendChild(option);
            });
        }
        
        const designStageSelect = rowDiv.querySelector(`select[name="service_contents[${index}][design_stage]"]`);
        if (designStageSelect) {
            designStagesData.forEach(function(ds) {
                const option = document.createElement("option");
                option.value = ds.id;
                option.textContent = ds.name;
                if (service.design_stage_id == ds.id) option.selected = true;
                designStageSelect.appendChild(option);
            });
        }
        
        const businessTypeSelect = rowDiv.querySelector(`select[name="service_contents[${index}][business_type]"]`);
        if (businessTypeSelect) {
            businessTypesData.forEach(function(bt) {
                const option = document.createElement("option");
                option.value = bt.id;
                option.textContent = bt.name;
                if (service.business_type_id == bt.id) option.selected = true;
                businessTypeSelect.appendChild(option);
            });
        }
        
        const serviceProfessionSelect = rowDiv.querySelector(`select[name="service_contents[${index}][service_professions]"]`);
        if (serviceProfessionSelect) {
            serviceProfessionsData.forEach(function(sp) {
                const option = document.createElement("option");
                option.value = sp.id;
                option.textContent = sp.name;
                if (service.service_profession_ids && service.service_profession_ids.includes(sp.id)) option.selected = true;
                serviceProfessionSelect.appendChild(option);
            });
        }
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®
        // ç»‘å®šåˆ é™¤æŒ‰é’®
        const removeBtn = rowDiv.querySelector(".remove-service-content-btn");
        if (removeBtn) {
            removeBtn.addEventListener("click", function() {
                // æ£€æŸ¥æœ€å°‘è¡Œæ•°é™åˆ¶
                const currentRows = document.querySelectorAll(".service-content-row");
                if (currentRows.length <= 1) {
                    alert("è‡³å°‘éœ€è¦ä¿ç•™ 1 è¡ŒæœåŠ¡ä¿¡æ¯");
                    return;
                }
                rowDiv.remove();
                updateServiceContentRowNumbers();
            });
        }
        
        updateServiceContentRowNumbers();
    }
    
    // æ›´æ–°æœåŠ¡ä¿¡æ¯è¡Œåºå·
    function updateServiceContentRowNumbers() {
        const rows = document.querySelectorAll(".service-content-row");
        rows.forEach(function(row, idx) {
            const title = row.querySelector("h6");
            if (title) {
                title.textContent = `æœåŠ¡ä¿¡æ¯ #${idx + 1}`;
            }
        });
    }
    
    
    // åŠ è½½ç°æœ‰æ•°æ®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰æˆ–æ·»åŠ é»˜è®¤è¡Œï¼ˆåˆ›å»ºæ¨¡å¼ï¼‰
    {% if form.instance and form.instance.pk %}
        // ç¼–è¾‘æ¨¡å¼ï¼šåŠ è½½ç°æœ‰æœåŠ¡ä¿¡æ¯æ•°æ®
        const existingServiceContents = [
            {% for service in form.instance.service_contents.all %}
            {
                service_type_id: {{ service.service_type_id|default:"null" }},
                design_stage_id: {{ service.design_stage_id|default:"null" }},
                business_type_id: {{ service.business_type_id|default:"null" }},
                building_area: {{ service.building_area|default:"0" }},
                description: "{{ service.description|escapejs }}",
                service_profession_ids: [{% for sp in service.service_professions.all %}{{ sp.id }}{% if not forloop.last %}, {% endif %}{% endfor %}]
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        // æ¸…ç©ºå®¹å™¨ï¼ˆå¦‚æœæœ‰é»˜è®¤è¡Œï¼‰
        const serviceContainer = document.getElementById("service-contents-container");
        if (serviceContainer) {
            serviceContainer.innerHTML = "";
        }
        
        // æ·»åŠ ç°æœ‰æ•°æ®è¡Œ
        existingServiceContents.forEach(function(serviceData) {
            addServiceContentRow(serviceData);
        });
    {% else %}
        // åˆ›å»ºæ¨¡å¼ï¼šæ·»åŠ ä¸€è¡Œé»˜è®¤ç©ºè¡Œ
        addServiceContentRow();
    {% endif %}
    // ç»‘å®šæ·»åŠ æœåŠ¡ä¿¡æ¯æŒ‰é’®
    const addServiceContentBtn = document.getElementById("add-service-content-btn");
    if (addServiceContentBtn) {
        addServiceContentBtn.addEventListener("click", function(e) {
            e.preventDefault();
            e.stopPropagation();
            addServiceContentRow();
        });
    }


    });
            }
        })();

</script>
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/dynamic-table.js' %}"></script>
<script>
    // ========== ç­¾çº¦ä¸»ä½“è¡¨æ ¼ç®¡ç†ï¼ˆä½¿ç”¨DynamicTableManagerï¼‰ ==========
    (function() {
        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPartiesTable);
        } else {
            initPartiesTable();
        }

        function initPartiesTable() {
            // æ£€æŸ¥DynamicTableManageræ˜¯å¦å·²åŠ è½½
            if (typeof DynamicTableManager === 'undefined') {
                console.error('DynamicTableManager æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ dynamic-table.js æ–‡ä»¶');
                return;
            }

            // å•ä½ç±»å‹é€‰é¡¹
            const partyTypeOptions = [
                { value: 'party_a', label: 'ç”²æ–¹' },
                { value: 'party_b', label: 'ä¹™æ–¹' },
                { value: 'party_c', label: 'ä¸™æ–¹' },
                { value: 'other', label: 'å…¶ä»–' }
            ];

            // è¡Œæ¨¡æ¿å‡½æ•°
            function partyRowTemplate(index, data) {
                const party = data || {};
                return `
                    <td style="text-align: center;">
                        <strong>${index + 1}</strong>
                    </td>
                    <td>
                        <select name="parties[${index}][party_type]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            ${partyTypeOptions.map(opt => 
                                `<option value="${opt.value}" ${party.party_type === opt.value ? 'selected' : ''}>${opt.label}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="text" name="parties[${index}][party_name]" class="form-control form-control-sm" 
                               value="${party.party_name || ''}" placeholder="è¯·è¾“å…¥å•ä½åç§°" required>
                    </td>
                    <td>
                        <input type="text" name="parties[${index}][credit_code]" class="form-control form-control-sm" 
                               value="${party.credit_code || ''}" placeholder="è¯·è¾“å…¥ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ">
                    </td>
                    <td>
                        <input type="text" name="parties[${index}][legal_representative]" class="form-control form-control-sm" 
                               value="${party.legal_representative || ''}" placeholder="è¯·è¾“å…¥æ³•å®šä»£è¡¨äºº">
                    </td>
                    <td>
                        <input type="text" name="parties[${index}][project_manager]" class="form-control form-control-sm" 
                               value="${party.project_manager || ''}" placeholder="è¯·è¾“å…¥é¡¹ç›®è´Ÿè´£äºº">
                    </td>
                    <td>
                        <input type="text" name="parties[${index}][contact_phone]" class="form-control form-control-sm" 
                               value="${party.contact_phone || ''}" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯">
                    </td>
                    <td>
                        <input type="email" name="parties[${index}][contact_email]" class="form-control form-control-sm" 
                               value="${party.contact_email || ''}" placeholder="è¯·è¾“å…¥è”ç³»é‚®ç®±">
                    </td>
                    <td>
                        <input type="text" name="parties[${index}][address]" class="form-control form-control-sm" 
                               value="${party.address || ''}" placeholder="è¯·è¾“å…¥åŠå…¬åœ°å€">
                    </td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-party-btn">
                            <i class="bi bi-trash"></i> åˆ é™¤
                        </button>
                    </td>
                `;
            }

            // åˆå§‹åŒ–DynamicTableManager
            const partiesTableManager = new DynamicTableManager({
                containerId: 'parties-container',
                rowClass: 'party-row',
                addButtonId: 'add-party-btn',
                removeButtonClass: 'remove-party-btn',
                minRows: 1,
                rowTemplate: partyRowTemplate,
                autoUpdateNumbers: true,
                numberCellSelector: 'td:first-child',
                onAdd: function(row, index) {
                    // æ·»åŠ è¡Œåçš„å›è°ƒï¼ˆå¦‚æœéœ€è¦ï¼‰
                    console.log('æ·»åŠ äº†ç­¾çº¦ä¸»ä½“è¡Œï¼Œç´¢å¼•:', index);
                },
                onRemove: function(row, index) {
                    // åˆ é™¤è¡Œå‰çš„å›è°ƒï¼ˆå¦‚æœéœ€è¦ï¼‰
                    console.log('åˆ é™¤äº†ç­¾çº¦ä¸»ä½“è¡Œï¼Œç´¢å¼•:', index);
                    return true; // è¿”å›trueå…è®¸åˆ é™¤
                }
            });

            // åŠ è½½ç°æœ‰æ•°æ®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
            {% if form.instance and form.instance.pk %}
                const existingParties = [
                    {% for party in form.instance.parties.all %}
                    {
                        party_type: '{{ party.party_type|escapejs }}',
                        party_name: '{{ party.party_name|escapejs }}',
                        credit_code: '{{ party.credit_code|escapejs }}',
                        legal_representative: '{{ party.legal_representative|escapejs }}',
                        project_manager: '{{ party.project_manager|escapejs }}',
                        contact_phone: '{{ party.contact_phone|escapejs }}',
                        contact_email: '{{ party.contact_email|escapejs }}',
                        address: '{{ party.address|escapejs }}'
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ];

                // æ¸…ç©ºå®¹å™¨ï¼ˆå¦‚æœæœ‰é»˜è®¤è¡Œï¼‰
                const container = document.getElementById('parties-container');
                if (container) {
                    container.innerHTML = '';
                }

                // æ·»åŠ ç°æœ‰æ•°æ®è¡Œ
                existingParties.forEach(function(partyData) {
                    partiesTableManager.addRow(partyData);
                });
            {% else %}
                // åˆ›å»ºæ¨¡å¼ï¼šæ·»åŠ ä¸€è¡Œé»˜è®¤ç©ºè¡Œ
                partiesTableManager.addRow();
            {% endif %}
        }
    })();
</script>
<script>

    // ========== å›æ¬¾ä¿¡æ¯è¡¨æ ¼ç®¡ç†ï¼ˆä½¿ç”¨DynamicTableManagerï¼‰ ==========
    (function() {
        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPaymentInfoTable);
        } else {
            initPaymentInfoTable();
        }

        function initPaymentInfoTable() {
            // æ£€æŸ¥DynamicTableManageræ˜¯å¦å·²åŠ è½½
            if (typeof DynamicTableManager === 'undefined') {
                console.error('DynamicTableManager æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ dynamic-table.js æ–‡ä»¶');
                return;
            }

            // è§¦å‘èŠ‚ç‚¹é€‰é¡¹ï¼ˆç»“ç®—èŠ‚ç‚¹ç±»å‹ + å”®åèŠ‚ç‚¹ç±»å‹ï¼‰
            const triggerNodeOptions = [
                {% for node in settlement_node_types %}
                { value: '{{ node.code|escapejs }}', label: '{{ node.name|escapejs }}', type: 'settlement' }{% if not forloop.last %},{% endif %}
                {% endfor %}
                {% if settlement_node_types and after_sales_node_types %},{% endif %}
                {% for node in after_sales_node_types %}
                { value: '{{ node.code|escapejs }}', label: '{{ node.name|escapejs }}', type: 'after_sales' }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            // ä»˜æ¬¾æ–¹å¼é€‰é¡¹ï¼ˆå¸¸è§çš„ä»˜æ¬¾æ–¹å¼ï¼‰
            const paymentMethodOptions = [
                { value: 'bank_transfer', label: 'é“¶è¡Œè½¬è´¦' },
                { value: 'cash', label: 'ç°é‡‘' },
                { value: 'check', label: 'æ”¯ç¥¨' },
                { value: 'acceptance', label: 'æ‰¿å…‘æ±‡ç¥¨' },
                { value: 'other', label: 'å…¶ä»–' }
            ];

            // è¡Œæ¨¡æ¿å‡½æ•°
            function paymentInfoRowTemplate(index, data) {
                const payment = data || {};
                return `
                    <td style="text-align: center;">
                        <strong>${index + 1}</strong>
                    </td>
                    <td>
                        <input type="text" name="payment_plans[${index}][phase_name]" class="form-control form-control-sm" 
                               value="${payment.phase_name || ''}" placeholder="è¯·è¾“å…¥æ¬¾é¡¹åç§°">
                    </td>
                    <td>
                        <select name="payment_plans[${index}][trigger_condition]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            ${triggerNodeOptions.map(opt => 
                                `<option value="${opt.value}" ${payment.trigger_condition === opt.value ? 'selected' : ''}>${opt.label}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <select name="payment_plans[${index}][payment_method]" class="form-select form-select-sm" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            ${paymentMethodOptions.map(opt => 
                                `<option value="${opt.value}" ${payment.payment_method === opt.value ? 'selected' : ''}>${opt.label}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="number" name="payment_plans[${index}][planned_amount]" class="form-control form-control-sm" 
                               step="0.01" value="${payment.planned_amount || ''}" placeholder="0.00">
                    </td>
                    <td>
                        <input type="text" name="payment_plans[${index}][condition_detail]" class="form-control form-control-sm" 
                               value="${payment.condition_detail || ''}" placeholder="è¯·è¾“å…¥ä»˜æ¬¾æ¡ä»¶">
                    </td>
                    <td style="text-align: center;">
                        <button type="button" class="btn btn-sm btn-danger remove-payment-info-btn">
                            <i class="bi bi-trash"></i> åˆ é™¤
                        </button>
                    </td>
                `;
            }

            // åˆå§‹åŒ–DynamicTableManager
            const paymentInfoTableManager = new DynamicTableManager({
                containerId: 'payment-info-container',
                rowClass: 'payment-info-row',
                addButtonId: 'add-payment-info-btn',
                removeButtonClass: 'remove-payment-info-btn',
                minRows: 1,
                rowTemplate: paymentInfoRowTemplate,
                autoUpdateNumbers: true,
                numberCellSelector: 'td:first-child',
                onAdd: function(row, index) {
                    // æ·»åŠ è¡Œåçš„å›è°ƒï¼ˆå¦‚æœéœ€è¦ï¼‰
                    console.log('æ·»åŠ äº†å›æ¬¾ä¿¡æ¯è¡Œï¼Œç´¢å¼•:', index);
                },
                onRemove: function(row, index) {
                    // åˆ é™¤è¡Œå‰çš„å›è°ƒï¼ˆå¦‚æœéœ€è¦ï¼‰
                    console.log('åˆ é™¤äº†å›æ¬¾ä¿¡æ¯è¡Œï¼Œç´¢å¼•:', index);
                    return true; // è¿”å›trueå…è®¸åˆ é™¤
                }
            });

            // åŠ è½½ç°æœ‰æ•°æ®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
            {% if form.instance and form.instance.pk %}
                const existingPaymentPlans = [
                    {% for plan in form.instance.payment_plans.all %}
                    {
                        phase_name: '{{ plan.phase_name|escapejs }}',
                        trigger_condition: '{{ plan.trigger_condition|escapejs }}',
                        payment_method: '{{ plan.payment_method|default:""|escapejs }}',
                        planned_amount: '{{ plan.planned_amount|default:"" }}',
                        condition_detail: '{{ plan.condition_detail|escapejs }}'
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ];

                // æ¸…ç©ºå®¹å™¨ï¼ˆå¦‚æœæœ‰é»˜è®¤è¡Œï¼‰
                const container = document.getElementById('payment-info-container');
                if (container) {
                    container.innerHTML = '';
                }

                // æ·»åŠ ç°æœ‰æ•°æ®è¡Œ
                existingPaymentPlans.forEach(function(planData) {
                    paymentInfoTableManager.addRow(planData);
                });
            {% else %}
                // åˆ›å»ºæ¨¡å¼ï¼šæ·»åŠ ä¸€è¡Œé»˜è®¤ç©ºè¡Œ
                paymentInfoTableManager.addRow();
            {% endif %}
        }
    })();
</script>
{% endblock %}
