{% extends "customer_management/base.html" %}

{% block title %}{{ page_title }} - 维海科技信息化管理平台{% endblock %}

{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
    .form-card {
        background: var(--vh-card-bg);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--vh-border);
    }
    .form-section {
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-lg);
        border-bottom: 2px solid var(--vh-primary);
    }
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .form-section h5 {
        font-size: 18px;
        font-weight: 600;
        color: #dc3545;
        margin-bottom: var(--spacing-md);
        padding-bottom: var(--spacing-sm);
        border-bottom: 2px solid var(--vh-primary);
    }
    .form-label {
        font-weight: 500;
        color: var(--vh-text);
        margin-bottom: var(--spacing-xs);
    }
    .form-label.required-field::after {
        content: " *";
        color: var(--vh-error);
    }
    .mode-params {
        display: none;
        padding: var(--spacing-md);
        background-color: #f8f9fa;
        border-radius: var(--radius-sm);
        margin-top: var(--spacing-sm);
    }
    .mode-params.active {
        display: block;
    }
    .calculation-result {
        padding: var(--spacing-md);
        background-color: #e7f3ff;
        border-left: 4px solid #007bff;
        border-radius: var(--radius-sm);
        margin-top: var(--spacing-md);
    }
    .calculation-steps {
        margin-top: var(--spacing-sm);
        font-size: 14px;
        color: #666;
    }
    .calculation-steps ul {
        margin: 0;
        padding-left: 20px;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'business_pages:opportunity_management' %}">商机管理</a></li>
<li class="breadcrumb-item"><a href="{% url 'business_pages:opportunity_bidding_quotation' %}">投标报价</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ page_title }}</li>
{% endblock %}

{% block content %}
<div class="workspace-content">
    
    <div class="center-hero mb-4">
        <div style="position: relative; z-index: 1;">
            <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 8px 0;">{{ page_title }}</h1>
            <p style="font-size: 14px; opacity: 0.9; margin: 0;">{{ description }}</p>
        </div>
    </div>

    <form method="post" class="form-card" id="biddingQuotationForm" novalidate>
        {% csrf_token %}
        
        {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="form-section">
            <h5>基本信息</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">关联商机</label>
                        <input type="text" class="form-control" 
                               value="{{ bidding_quotation.opportunity.name }} ({{ bidding_quotation.opportunity.opportunity_number|default:'未编号' }})" 
                               readonly>
                        <small class="form-text text-muted">关联商机不可修改</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">投标编号</label>
                        <input type="text" name="bidding_number" class="form-control" 
                               maxlength="100" 
                               value="{{ bidding_quotation.bidding_number|default:'' }}"
                               placeholder="留空则系统自动生成">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label required-field">投标日期</label>
                        <input type="date" name="bidding_date" class="form-control" 
                               value="{{ bidding_quotation.bidding_date|date:'Y-m-d' }}" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label required-field">提交截止日期</label>
                        <input type="date" name="submission_deadline" class="form-control" 
                               value="{{ bidding_quotation.submission_deadline|date:'Y-m-d' }}" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">状态</label>
                        <select name="status" class="form-select">
                            {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if bidding_quotation.status == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h5>招标要求</h5>
            <div class="form-group mb-3">
                <label class="form-label">招标要求</label>
                <textarea name="tender_requirements" class="form-control" rows="5" 
                          placeholder="根据招标文件填写的要求...">{{ bidding_quotation.tender_requirements|default:'' }}</textarea>
            </div>
        </div>
        
        <div class="form-section">
            <h5>技术标信息</h5>
            <div class="row">
                <div class="col-12">
                    <div class="form-group mb-3">
                        <label class="form-label">技术方案</label>
                        <textarea name="technical_solution" class="form-control" rows="5" 
                                  placeholder="描述技术方案...">{% if bidding_quotation.technical_proposal.technical_solution %}{{ bidding_quotation.technical_proposal.technical_solution }}{% endif %}</textarea>
                    </div>
                </div>
                <div class="col-12">
                    <div class="form-group mb-3">
                        <label class="form-label">技术能力</label>
                        <textarea name="technical_capability" class="form-control" rows="4" 
                                  placeholder="描述技术能力...">{% if bidding_quotation.technical_proposal.technical_capability %}{{ bidding_quotation.technical_proposal.technical_capability }}{% endif %}</textarea>
                    </div>
                </div>
                <div class="col-12">
                    <div class="form-group mb-3">
                        <label class="form-label">技术团队</label>
                        <textarea name="technical_team" class="form-control" rows="4" 
                                  placeholder="描述技术团队...">{% if bidding_quotation.technical_proposal.technical_team %}{{ bidding_quotation.technical_proposal.technical_team }}{% endif %}</textarea>
                    </div>
                </div>
                <div class="col-12">
                    <div class="form-group mb-3">
                        <label class="form-label">实施计划</label>
                        <textarea name="implementation_plan" class="form-control" rows="4" 
                                  placeholder="描述实施计划...">{% if bidding_quotation.technical_proposal.implementation_plan %}{{ bidding_quotation.technical_proposal.implementation_plan }}{% endif %}</textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h5>商务标信息</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">报价模式</label>
                        <select name="quotation_mode" id="quotation_mode" class="form-select">
                            {% for value, label in quotation_mode_choices %}
                            <option value="{{ value }}" 
                                    {% if bidding_quotation.commercial_proposal.quotation_mode == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">节省金额（万元）</label>
                        <input type="number" name="saved_amount" id="saved_amount" class="form-control" 
                               step="0.01" min="0"
                               value="{% if bidding_quotation.commercial_proposal.saved_amount %}{{ bidding_quotation.commercial_proposal.saved_amount }}{% endif %}"
                               placeholder="请输入节省金额">
                    </div>
                </div>
            </div>
            
            <div id="mode_params_rate" class="mode-params">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="form-label">费率（%）</label>
                            <input type="number" name="rate" id="rate_rate" class="form-control" 
                                   step="0.01" min="0" max="100"
                                   value="{% if bidding_quotation.commercial_proposal.mode_params.rate %}{{ bidding_quotation.commercial_proposal.mode_params.rate|floatformat:2|mul:100 }}{% endif %}"
                                   placeholder="例如：20">
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="mode_params_base_fee_rate" class="mode-params">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="form-label">基本费（万元）</label>
                            <input type="number" name="base_fee" id="base_fee_base_fee_rate" class="form-control" 
                                   step="0.01" min="0"
                                   value="{% if bidding_quotation.commercial_proposal.mode_params.base_fee %}{{ bidding_quotation.commercial_proposal.mode_params.base_fee }}{% endif %}"
                                   placeholder="请输入基本费">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="form-label">费率（%）</label>
                            <input type="number" name="rate" id="rate_base_fee_rate" class="form-control" 
                                   step="0.01" min="0" max="100"
                                   value="{% if bidding_quotation.commercial_proposal.mode_params.rate %}{{ bidding_quotation.commercial_proposal.mode_params.rate|floatformat:2|mul:100 }}{% endif %}"
                                   placeholder="例如：15">
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="mode_params_fixed" class="mode-params">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="form-label">固定金额（万元）</label>
                            <input type="number" name="fixed_amount" id="fixed_amount_fixed" class="form-control" 
                                   step="0.01" min="0"
                                   value="{% if bidding_quotation.commercial_proposal.mode_params.fixed_amount %}{{ bidding_quotation.commercial_proposal.mode_params.fixed_amount }}{% endif %}"
                                   placeholder="请输入固定金额">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">封顶费（万元，可选）</label>
                        <input type="number" name="cap_fee" id="cap_fee" class="form-control" 
                               step="0.01" min="0"
                               value="{% if bidding_quotation.commercial_proposal.cap_fee %}{{ bidding_quotation.commercial_proposal.cap_fee }}{% endif %}"
                               placeholder="留空表示不设置封顶费">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">服务费（万元）</label>
                        <input type="number" name="service_fee" id="service_fee" class="form-control" 
                               step="0.01" min="0" readonly
                               value="{% if bidding_quotation.commercial_proposal.service_fee %}{{ bidding_quotation.commercial_proposal.service_fee }}{% endif %}"
                               placeholder="自动计算">
                        <small class="form-text text-muted">根据报价模式和参数自动计算</small>
                    </div>
                </div>
            </div>
            
            <div id="calculation_result" class="calculation-result" style="display: none;">
                <strong>计算结果：</strong>
                <div id="service_fee_display" style="font-size: 20px; color: #dc3545; margin-top: 8px;"></div>
                <div id="calculation_steps" class="calculation-steps"></div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <button type="button" id="calculate_btn" class="btn btn-outline-primary">
                        <i class="bi bi-calculator"></i> 计算服务费
                    </button>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <div class="form-group mb-3">
                        <label class="form-label">付款方式</label>
                        <textarea name="payment_method" class="form-control" rows="3" 
                                  placeholder="描述付款方式...">{% if bidding_quotation.commercial_proposal.payment_method %}{{ bidding_quotation.commercial_proposal.payment_method }}{% endif %}</textarea>
                    </div>
                </div>
                <div class="col-12">
                    <div class="form-group mb-3">
                        <label class="form-label">服务承诺</label>
                        <textarea name="service_commitment" class="form-control" rows="3" 
                                  placeholder="描述服务承诺...">{% if bidding_quotation.commercial_proposal.service_commitment %}{{ bidding_quotation.commercial_proposal.service_commitment }}{% endif %}</textarea>
                    </div>
                </div>
            </div>
        </div>
        
        {% if completed_projects %}
        <div class="form-section">
            <h5>类似业绩</h5>
            <div class="form-group mb-3">
                <label class="form-label">选择类似业绩项目</label>
                <select name="similar_projects" class="form-select" multiple size="5">
                    {% for project in completed_projects %}
                    <option value="{{ project.id }}" 
                            {% if project in bidding_quotation.similar_projects.all %}selected{% endif %}>
                        {{ project.name }} - {{ project.client.name|default:'-' }} ({{ project.end_date|date:'Y-m-d'|default:'-' }})
                    </option>
                    {% endfor %}
                </select>
                <small class="form-text text-muted">按住Ctrl键可多选</small>
            </div>
        </div>
        {% endif %}
        
        <div class="form-section">
            <h5>备注说明</h5>
            <div class="form-group mb-3">
                <label class="form-label">备注说明</label>
                <textarea name="notes" class="form-control" rows="3" 
                          placeholder="其他需要说明的信息...">{{ bidding_quotation.notes|default:'' }}</textarea>
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-4">
            <a href="{% url 'business_pages:bidding_quotation_detail' bidding_quotation.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回详情
            </a>
            <div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> 保存修改
                </button>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('biddingQuotationForm');
    const quotationModeSelect = document.getElementById('quotation_mode');
    const savedAmountInput = document.getElementById('saved_amount');
    const calculateBtn = document.getElementById('calculate_btn');
    const serviceFeeInput = document.getElementById('service_fee');
    const calculationResult = document.getElementById('calculation_result');
    
    // 显示/隐藏模式参数配置
    function updateModeParams() {
        const mode = quotationModeSelect.value;
        // 隐藏所有模式参数
        document.querySelectorAll('.mode-params').forEach(el => {
            el.classList.remove('active');
        });
        // 显示当前模式的参数
        const modeParamsEl = document.getElementById('mode_params_' + mode);
        if (modeParamsEl) {
            modeParamsEl.classList.add('active');
        }
    }
    
    // 初始化
    updateModeParams();
    quotationModeSelect.addEventListener('change', updateModeParams);
    
    // 计算服务费
    calculateBtn.addEventListener('click', function() {
        const mode = quotationModeSelect.value;
        const savedAmountWan = parseFloat(savedAmountInput.value) || 0;
        const capFeeWan = parseFloat(document.getElementById('cap_fee').value) || null;
        
        if (!savedAmountWan) {
            alert('请输入节省金额');
            return;
        }
        
        // 构建模式参数（注意：API使用元，需要转换）
        let modeParams = {};
        if (mode === 'rate') {
            const rate = parseFloat(document.getElementById('rate_rate').value) || 0;
            modeParams.rate = rate / 100;
        } else if (mode === 'base_fee_rate') {
            const baseFeeWan = parseFloat(document.getElementById('base_fee_base_fee_rate').value) || 0;
            modeParams.base_fee = baseFeeWan * 10000; // 转换为元
            const rate = parseFloat(document.getElementById('rate_base_fee_rate').value) || 0;
            modeParams.rate = rate / 100;
        } else if (mode === 'fixed') {
            const fixedAmountWan = parseFloat(document.getElementById('fixed_amount_fixed').value) || 0;
            modeParams.fixed_amount = fixedAmountWan * 10000; // 转换为元
        }
        
        // 调用后端API计算（API使用元为单位）
        fetch('/api/customer/quotations/calculate-by-mode/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                mode: mode,
                saved_amount: savedAmountWan * 10000, // 转换为元
                mode_params: modeParams,
                cap_fee: capFeeWan ? capFeeWan * 10000 : null // 转换为元
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.service_fee !== undefined) {
                // API返回的是元，需要转换为万元显示
                const serviceFeeWan = data.service_fee / 10000;
                serviceFeeInput.value = serviceFeeWan.toFixed(2);
                document.getElementById('service_fee_display').textContent = 
                    '服务费：' + serviceFeeWan.toFixed(2) + ' 万元';
                
                // 显示计算步骤
                if (data.calculation_steps && data.calculation_steps.length > 0) {
                    const stepsHtml = '<ul>' + data.calculation_steps.map(step => '<li>' + step + '</li>').join('') + '</ul>';
                    document.getElementById('calculation_steps').innerHTML = stepsHtml;
                }
                
                calculationResult.style.display = 'block';
            } else {
                alert('计算失败：' + (data.error || '未知错误'));
            }
        })
        .catch(error => {
            alert('计算失败，请检查输入参数');
        });
    });
    
    // 表单验证
    form.addEventListener('submit', function(e) {
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %}
