{% extends "customer_management/_base.html" %}
{% load static %}

{% block cm_title %}人员关系管理{% endblock %}
{% block cm_subtitle %}<span class="pm-subtitle">查看和管理所有联系人</span>{% endblock %}

{% block cm_actions %}
{% if can_create %}
<a href="{% url 'business_pages:contact_create' %}" class="list-btn list-btn-primary">
  新增联系人
</a>
{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/list_layout.css' %}">
{% endblock %}

{% block cm_content %}
  {% include "customer_management/_partials/_contact_filters.html" %}
  
  {% if page_obj %}
  <div class="list-page-action-bar mb-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <span class="text-muted small">已选 <strong id="selectedCount">0</strong> 个</span>
      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-outline-secondary" id="batchEditBtn" disabled>编辑</button>
        <button type="button" class="btn btn-outline-secondary" id="batchExportBtn" disabled>导出</button>
        <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" disabled>
          <span class="visually-hidden">更多操作</span>
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" id="batchDeleteBtn">删除</a></li>
        </ul>
      </div>
    </div>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-secondary btn-sm">导入</button>
    </div>
  </div>
  
  {% include "customer_management/_partials/_contact_table.html" %}
  {% else %}
  <div class="list-empty">
    <div class="list-empty-icon">▢</div>
    <div class="list-empty-text">暂无联系人数据</div>
  </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
<script>
// 全选/取消全选
document.getElementById('selectAll')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateSelectedCount();
});

// 行复选框变化
document.querySelectorAll('.row-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        updateSelectedCount();
        updateSelectAllState();
    });
});

// 更新选中数量
function updateSelectedCount() {
    const selected = document.querySelectorAll('.row-checkbox:checked').length;
    const countEl = document.getElementById('selectedCount');
    if (countEl) {
        countEl.textContent = selected;
    }
    
    // 启用/禁用批量操作按钮
    const batchButtons = document.querySelectorAll('#batchEditBtn, #batchExportBtn, .dropdown-toggle');
    batchButtons.forEach(btn => {
        btn.disabled = selected === 0;
    });
}

// 更新全选状态
function updateSelectAllState() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const selectAll = document.getElementById('selectAll');
    if (checkboxes.length > 0 && selectAll) {
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        const someChecked = Array.from(checkboxes).some(cb => cb.checked);
        selectAll.checked = allChecked;
        selectAll.indeterminate = someChecked && !allChecked;
    }
}

// 初始化
updateSelectedCount();
</script>
{% endblock %}
