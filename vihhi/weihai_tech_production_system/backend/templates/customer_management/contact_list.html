{% extends "shared/list_page_base.html" %}
{% load static %}

{% block pm_title %}äººå‘˜å…³ç³»ç®¡ç†{% endblock pm_title %}
{% block pm_subtitle %}æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰è”ç³»äºº{% endblock pm_subtitle %}

{% block pm_actions %}
{% if can_create %}
<a href="{% url 'business_pages:contact_create' %}" class="list-btn list-btn-primary">æ–°å¢è”ç³»äºº</a>
{% endif %}
{% endblock pm_actions %}

{% block list_table_rows %}
{% for contact in page_obj %}
      <tr>
        <td>
          <input type="checkbox" name="contact_ids" value="{{ contact.id }}" class="form-check-input row-checkbox">
        </td>
        <td>
          <a href="{% url 'business_pages:customer_detail' contact.client.id %}">
            {{ contact.client.name }}
          </a>
        </td>
        <td>
          <a href="{% url 'business_pages:contact_detail' contact.id %}">
            {{ contact.name }}
          </a>
        </td>
        <td>
          {% if contact.role %}
          <span class="badge bg-secondary">{{ contact.get_role_display }}</span>
          {% else %}
          <span class="text-muted">æœªè®¾ç½®</span>
          {% endif %}
        </td>
        <td>
          <span class="badge bg-secondary">{{ contact.get_relationship_level_display }}</span>
        </td>
        <td>{{ contact.position|default:"æœªå¡«å†™" }}</td>
        <td>{{ contact.phone|default:"æœªå¡«å†™" }}</td>
        <td class="text-muted">{{ contact.email|default:"æœªå¡«å†™" }}</td>
        <td class="text-muted">{{ contact.created_time|date:"Y-m-d" }}</td>
        <td>
          <div class="list-page-table-actions">
            <a href="{% url 'business_pages:contact_detail' contact.id %}" class="action-view" title="æŸ¥çœ‹">
              <i class="bi bi-eye"></i>
            </a>
            {% if can_create %}
            <span class="action-separator">|</span>
            <a href="{% url 'business_pages:contact_edit' contact.id %}" class="action-edit" title="ç¼–è¾‘">
              <i class="bi bi-pencil"></i>
            </a>
            {% endif %}
          </div>
        </td>
        {% if column_settings_btn|default:False %}<td></td>{% endif %}
      </tr>
      {% empty %}
      <tr>
        <td colspan="{% if column_settings_btn|default:False %}11{% else %}10{% endif %}" class="list-empty">
          <div class="list-empty-icon">ğŸ“‹</div>
          <div class="list-empty-text">æš‚æ— è”ç³»äººæ•°æ®</div>
          {% block list_empty_hint %}
          <p class="text-muted" style="font-size: 0.9rem; margin-top: 8px;">è¯·åˆ›å»ºç¬¬ä¸€ä¸ªè”ç³»äººå¼€å§‹ä½¿ç”¨</p>
          {% endblock list_empty_hint %}
        </td>
      </tr>
      {% endfor %}
{% endblock list_table_rows %}

{% block list_table_checkbox_header %}
<th style="width: 50px;">
  <input type="checkbox" id="selectAll" class="form-check-input" title="å…¨é€‰">
</th>
{% endblock list_table_checkbox_header %}

{% block list_table_headers %}
<th>å®¢æˆ·åç§°</th>
<th>è”ç³»äººå§“å</th>
<th>äººå‘˜è§’è‰²</th>
<th>å…³ç³»ç­‰çº§</th>
<th>èŒåŠ¡</th>
<th>ç”µè¯</th>
<th>é‚®ç®±</th>
<th>åˆ›å»ºæ—¶é—´</th>
<th>æ“ä½œ</th>
{% endblock list_table_headers %}



{% block module_extra_js %}
<script>
// å…¨é€‰/å–æ¶ˆå…¨é€‰
document.getElementById('selectAll')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateSelectedCount();
});

// è¡Œå¤é€‰æ¡†å˜åŒ–
document.querySelectorAll('.row-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        updateSelectedCount();
        updateSelectAllState();
    });
});

// æ›´æ–°é€‰ä¸­æ•°é‡
function updateSelectedCount() {
    const selected = document.querySelectorAll('.row-checkbox:checked').length;
    const countEl = document.getElementById('selectedCount');
    if (countEl) {
        countEl.textContent = selected;
    }

    // å¯ç”¨/ç¦ç”¨æ‰¹é‡æ“ä½œæŒ‰é’®
    const batchButtons = document.querySelectorAll('#batchEditBtn, #batchExportBtn, .dropdown-toggle');
    batchButtons.forEach(btn => {
        btn.disabled = selected === 0;
    });
}

// æ›´æ–°å…¨é€‰çŠ¶æ€
function updateSelectAllState() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const selectAll = document.getElementById('selectAll');
    if (checkboxes.length > 0 && selectAll) {
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        const someChecked = Array.from(checkboxes).some(cb => cb.checked);
        selectAll.checked = allChecked;
        selectAll.indeterminate = someChecked && !allChecked;
    }
}

// åˆå§‹åŒ–
updateSelectedCount();
</script>
{% endblock module_extra_js %}
