{% extends "customer_management/_base.html" %}

{% block title %}{{ page_title }} - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'contract_pages:contract_management_list' %}">åˆåŒç®¡ç†</a></li>
    <li class="breadcrumb-item"><a href="{% url 'contract_pages:contract_negotiation_list' %}">åˆåŒæ´½è°ˆè®°å½•</a></li>
    <li class="breadcrumb-item active" aria-current="page">æ´½è°ˆè¯¦æƒ…</li>
{% endblock %}

{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
    .detail-card {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
    }
    .detail-section {
        margin-bottom: 32px;
    }
    .detail-section h5 {
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--vh-primary);
        font-weight: 600;
        color: #1f2937;
    }
    .detail-row {
        display: flex;
        padding: 12px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .detail-row:last-child {
        border-bottom: none;
    }
    .detail-label {
        font-weight: 500;
        color: #6b7280;
        width: 150px;
        flex-shrink: 0;
    }
    .detail-value {
        color: #1f2937;
        flex: 1;
    }
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    .status-badge.ongoing {
        background: #dbeafe;
        color: #1e40af;
    }
    .status-badge.completed {
        background: #d1fae5;
        color: #065f46;
    }
    .status-badge.suspended {
        background: #fef3c7;
        color: #92400e;
    }
    .status-badge.cancelled {
        background: #fee2e2;
        color: #991b1b;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <div class="center-hero mb-4">
        <div style="position: relative; z-index: 1;">
            <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 8px 0;">{{ page_title }}</h1>
            <p style="font-size: 14px; opacity: 0.9; margin: 0;">æŸ¥çœ‹åˆåŒæ´½è°ˆè®°å½•çš„è¯¦ç»†ä¿¡æ¯</p>
        </div>
    </div>

    <div class="text-end mb-4">
        <a href="{% url 'contract_pages:contract_negotiation_list' %}" class="btn btn-secondary">è¿”å›åˆ—è¡¨</a>
        {% if can_edit %}
        <a href="#" class="btn btn-primary">ç¼–è¾‘</a>
        {% endif %}
    </div>

    <div class="detail-card">
        <div class="detail-section">
            <h5>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h5>
            <div class="detail-row">
                <div class="detail-label">æ´½è°ˆç¼–å·</div>
                <div class="detail-value"><strong>{{ negotiation.negotiation_number|default:"æœªç¼–å·" }}</strong></div>
            </div>
            <div class="detail-row">
                <div class="detail-label">æ´½è°ˆä¸»é¢˜</div>
                <div class="detail-value">{{ negotiation.title }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">æ´½è°ˆç±»å‹</div>
                <div class="detail-value">{{ negotiation.get_negotiation_type_display }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">æ´½è°ˆçŠ¶æ€</div>
                <div class="detail-value">
                    <span class="status-badge {{ negotiation.status }}">{{ negotiation.get_status_display }}</span>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">æ´½è°ˆå†…å®¹</div>
                <div class="detail-value">{{ negotiation.content|linebreaks }}</div>
            </div>
        </div>
    </div>

    <div class="detail-card">
        <div class="detail-section">
            <h5>ğŸ”— å…³è”ä¿¡æ¯</h5>
            <div class="detail-row">
                <div class="detail-label">å…³è”åˆåŒ</div>
                <div class="detail-value">
                    {% if negotiation.contract %}
                        <a href="{% url 'contract_pages:contract_detail' negotiation.contract.id %}">{{ negotiation.contract.contract_number|default:"æœªç¼–å·" }}</a>
                    {% else %}
                        æœªå…³è”
                    {% endif %}
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">å®¢æˆ·</div>
                <div class="detail-value">
                    {% if negotiation.client %}
                        <a href="{% url 'business_pages:customer_detail' negotiation.client.id %}">{{ negotiation.client.name }}</a>
                    {% else %}
                        æœªæŒ‡å®š
                    {% endif %}
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">å…³è”é¡¹ç›®</div>
                <div class="detail-value">
                    {% if negotiation.project %}
                        {{ negotiation.project.project_number|default:negotiation.project.name }}
                    {% else %}
                        æœªå…³è”
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="detail-card">
        <div class="detail-section">
            <h5>ğŸ‘¥ å‚ä¸äººå‘˜</h5>
            <div class="detail-row">
                <div class="detail-label">æˆ‘æ–¹å‚ä¸äººå‘˜</div>
                <div class="detail-value">
                    {% for participant in negotiation.participants.all %}
                        {{ participant.username }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                        æ— 
                    {% endfor %}
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">å®¢æˆ·å‚ä¸äººå‘˜</div>
                <div class="detail-value">{{ negotiation.client_participants|default:"æœªå¡«å†™" }}</div>
            </div>
        </div>
    </div>

    <div class="detail-card">
        <div class="detail-section">
            <h5>ğŸ“… æ—¶é—´ä¿¡æ¯</h5>
            <div class="detail-row">
                <div class="detail-label">æ´½è°ˆæ—¥æœŸ</div>
                <div class="detail-value">{{ negotiation.negotiation_date|date:"Y-m-d" }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">å¼€å§‹æ—¶é—´</div>
                <div class="detail-value">{{ negotiation.negotiation_start_time|default:"æœªå¡«å†™" }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">ç»“æŸæ—¶é—´</div>
                <div class="detail-value">{{ negotiation.negotiation_end_time|default:"æœªå¡«å†™" }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">ä¸‹æ¬¡æ´½è°ˆæ—¥æœŸ</div>
                <div class="detail-value">{{ negotiation.next_negotiation_date|date:"Y-m-d"|default:"æœªè®¾ç½®" }}</div>
            </div>
        </div>
    </div>

    {% if negotiation.result_summary or negotiation.agreed_items or negotiation.pending_items %}
    <div class="detail-card">
        <div class="detail-section">
            <h5>âœ… æ´½è°ˆç»“æœ</h5>
            {% if negotiation.result_summary %}
            <div class="detail-row">
                <div class="detail-label">ç»“æœæ‘˜è¦</div>
                <div class="detail-value">{{ negotiation.result_summary|linebreaks }}</div>
            </div>
            {% endif %}
            {% if negotiation.agreed_items %}
            <div class="detail-row">
                <div class="detail-label">å·²è¾¾æˆäº‹é¡¹</div>
                <div class="detail-value">{{ negotiation.agreed_items|linebreaks }}</div>
            </div>
            {% endif %}
            {% if negotiation.pending_items %}
            <div class="detail-row">
                <div class="detail-label">å¾…è§£å†³äº‹é¡¹</div>
                <div class="detail-value">{{ negotiation.pending_items|linebreaks }}</div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if negotiation.attachments or negotiation.notes %}
    <div class="detail-card">
        <div class="detail-section">
            <h5>ğŸ“ å…¶ä»–ä¿¡æ¯</h5>
            {% if negotiation.attachments %}
            <div class="detail-row">
                <div class="detail-label">é™„ä»¶è¯´æ˜</div>
                <div class="detail-value">{{ negotiation.attachments|linebreaks }}</div>
            </div>
            {% endif %}
            {% if negotiation.notes %}
            <div class="detail-row">
                <div class="detail-label">å¤‡æ³¨</div>
                <div class="detail-value">{{ negotiation.notes|linebreaks }}</div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="detail-card">
        <div class="detail-section">
            <h5>ğŸ“ å®¡è®¡ä¿¡æ¯</h5>
            <div class="detail-row">
                <div class="detail-label">åˆ›å»ºäºº</div>
                <div class="detail-value">{{ negotiation.created_by.username|default:"æœªçŸ¥" }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">åˆ›å»ºæ—¶é—´</div>
                <div class="detail-value">{{ negotiation.created_time|date:"Y-m-d H:i:s" }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">æ›´æ–°æ—¶é—´</div>
                <div class="detail-value">{{ negotiation.updated_time|date:"Y-m-d H:i:s" }}</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
