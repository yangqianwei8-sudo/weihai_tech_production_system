{% extends "customer_management/base.html" %}

{% block title %}{{ page_title }} - 维海科技信息化管理平台{% endblock %}

{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<link rel="stylesheet" href="{% static 'css/qixinbao-autofill.css' %}">
<style>
    .duplicate-check-status {
        margin-top: 4px;
        font-size: 0.875rem;
        min-height: 18px;
        display: block;
    }
    .duplicate-check-status.checking {
        color: #6c757d;
    }
    .duplicate-check-status.error {
        color: #dc3545;
    }
    .duplicate-check-status.success {
        color: #28a745;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'business_pages:customer_list' %}">客户列表</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ page_title }}</li>
{% endblock %}

{% block content %}
<div class="workspace-content">
    <div class="container-fluid py-4">
        <div class="info-card info-card-compact">
            <div class="info-card-header">
                <h5 class="info-card-title">{{ page_title }}</h5>
            </div>
            <div class="info-card-body">
                <form method="post" id="customerForm">
                    {% csrf_token %}
                    
                    <!-- 基本信息 -->
                    <div class="info-section">
                        <h6 class="info-section-title">基本信息</h6>
                        <div class="info-grid info-grid-2">
                            <div class="info-item" style="position: relative;">
                                <label class="info-label info-label-required">{{ form.name.label }}</label>
                                {{ form.name }}
                                <div id="companyDropdown" class="autocomplete-dropdown" style="display: none;"></div>
                                <div class="duplicate-check-status" id="nameDuplicateStatus"></div>
                                <small class="text-muted">输入企业名称（至少2个字符）后自动搜索启信宝，选择匹配的企业将自动填充信息</small>
                                {% if form.name.errors %}
                                <div class="text-danger">{{ form.name.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.unified_credit_code.label }}</label>
                                {{ form.unified_credit_code }}
                                <div class="duplicate-check-status" id="creditCodeDuplicateStatus"></div>
                                {% if form.unified_credit_code.errors %}
                                <div class="text-danger">{{ form.unified_credit_code.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.legal_representative.label }}</label>
                                {{ form.legal_representative }}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.established_date.label }}</label>
                                {{ form.established_date }}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.registered_capital.label }}</label>
                                {{ form.registered_capital }}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.company_phone.label }}</label>
                                {{ form.company_phone }}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.company_email.label }}</label>
                                {{ form.company_email }}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.company_address.label }}</label>
                                {{ form.company_address }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 被执行信息 -->
                    <div class="info-section mt-4" id="executionSection" {% if not client %}style="display: none;"{% endif %}>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="info-section-title mb-0">
                                被执行信息
                                <span id="executionCountBadge">
                                {% if client %}
                                    {% if execution_count > 0 %}
                                    <span class="badge bg-danger ms-2">{{ execution_count }} 条记录</span>
                                    {% if total_execution_amount %}
                                    <span class="badge bg-warning ms-2">执行总金额: ¥{{ total_execution_amount|floatformat:2 }}</span>
                                    {% endif %}
                                    {% else %}
                                    <span class="badge bg-success ms-2">无记录</span>
                                    {% endif %}
                                {% endif %}
                                </span>
                            </h6>
                            {% if client %}
                            <button type="button" class="btn btn-sm btn-outline-primary" id="syncExecutionBtn" data-client-id="{{ client.id }}">
                                <i class="bi bi-arrow-clockwise"></i> 同步数据
                            </button>
                            {% endif %}
                        </div>
                        
                        <div id="executionTableContainer">
                        {% if client and execution_records %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>案号</th>
                                        <th>执行状态</th>
                                        <th>执行法院</th>
                                        <th>立案日期</th>
                                        <th>执行金额</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in execution_records %}
                                    <tr>
                                        <td>{{ record.case_number|default:"未填写" }}</td>
                                        <td>{{ record.get_execution_status_display|default:"未填写" }}</td>
                                        <td>{{ record.execution_court|default:"未填写" }}</td>
                                        <td>{{ record.filing_date|date:"Y-m-d"|default:"未填写" }}</td>
                                        <td>¥{{ record.execution_amount|floatformat:2|default:"0.00" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>暂无被执行记录
                        </div>
                        {% endif %}
                        </div>
                    </div>
                    
                    <!-- 分类信息 -->
                    <div class="info-section">
                        <h6 class="info-section-title">分类信息</h6>
                        <div class="info-grid info-grid-2">
                            <div class="info-item">
                                <label class="info-label">{{ form.grade.label }}</label>
                                {{ form.grade }}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.client_type.label }}</label>
                                {{ form.client_type }}
                            </div>
                            <div class="info-item" style="grid-column: span 2;">
                                <label class="info-label">{{ form.region.label }}</label>
                                <input type="hidden" name="region" id="regionField" value="{% if client %}{{ client.region|default:'' }}{% elif form.region.value %}{{ form.region.value }}{% else %}{% endif %}">
                                <div class="row g-2 mb-2">
                                    <div class="col-md-4">
                                        <select id="provinceSelect" class="form-select">
                                            <option value="">选择省份</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select id="citySelect" class="form-select">
                                            <option value="">选择城市</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select id="districtSelect" class="form-select">
                                            <option value="">选择区县</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <input type="text" id="addressDetailInput" class="form-control" 
                                               placeholder="街道、楼栋、门牌等详细地址" 
                                               value="">
                                        <small class="text-muted">完整地址会在保存前自动组合</small>
                                    </div>
                                </div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.source.label }}</label>
                                {{ form.source }}
                            </div>
                            <div class="info-item">
                                <label class="info-label">{{ form.responsible_user.label }}</label>
                                {{ form.responsible_user }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 提交按钮 -->
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">保存</button>
                        <a href="{% if client %}{% url 'business_pages:customer_detail' client.id %}{% else %}{% url 'business_pages:customer_list' %}{% endif %}" class="btn btn-secondary">取消</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/amap-district-selector.js' %}"></script>
<script src="{% static 'js/qixinbao-autofill.js' %}"></script>
<script>
// 获取Cookie的工具函数（用于被执行信息同步功能）
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 启信宝自动填充功能初始化
document.addEventListener('DOMContentLoaded', function() {
    // 高德地图行政区划选择器（使用可复用组件，与商机创建表单保持一致）
    const districtSelector = new AmapDistrictSelector({
        provinceSelectId: 'provinceSelect',
        citySelectId: 'citySelect',
        districtSelectId: 'districtSelect',
        addressFieldId: 'regionField',
        detailInputId: 'addressDetailInput',
        apiBaseUrl: '/api/customer/districts/',
        autoUpdateAddress: true,
        enableLogging: false  // 设置为true可启用调试日志
    });
    districtSelector.init();
    
    // 检查是否加载了QixinbaoAutofill类
    if (typeof QixinbaoAutofill === 'undefined') {
        return;
    }
    
    // 初始化启信宝自动填充组件
    const qixinbaoAutofill = new QixinbaoAutofill({
        // 输入框选择器
        nameInputSelector: '[name="name"]',
        creditCodeInputSelector: '[name="unified_credit_code"]',
        
        // 下拉框ID
        dropdownId: 'companyDropdown',
        
        // API端点
        searchApiUrl: '/api/customer/search-company/',
        detailApiUrl: '/api/customer/get-company-detail/',
        executionApiUrl: '/api/customer/get-execution-records/',
        
        // 其他字段选择器
        fieldSelectors: {
            legalRepresentative: '[name="legal_representative"]',
            establishedDate: '[name="established_date"]',
            registeredCapital: '[name="registered_capital"]',
            companyPhone: '[name="company_phone"]',
            companyEmail: '[name="company_email"]',
            companyAddress: '[name="company_address"]'
        },
        
        // 被执行信息相关元素ID
        executionSectionId: 'executionSection',
        executionTableContainerId: 'executionTableContainer',
        executionCountBadgeId: 'executionCountBadge',
        
        // 功能开关
        autoFillDetails: true,
        autoQueryExecution: true,
        showSuccessAlert: true,
        
        // 调试模式（开发时可以开启）
        debug: true
    });
    
    // 初始化组件
    if (qixinbaoAutofill.init()) {
            } else {
    }
    
    // 保存实例到全局，以便调试使用
    window.qixinbaoAutofill = qixinbaoAutofill;
    
    // 被执行信息同步（页面特定功能，保留在此）
    const syncBtn = document.getElementById('syncExecutionBtn');
    if (syncBtn) {
        syncBtn.addEventListener('click', async function() {
            const clientId = this.getAttribute('data-client-id');
            if (!clientId) {
                alert('客户ID不存在');
                return;
            }
            
            // 禁用按钮，显示加载状态
            const originalText = this.innerHTML;
            this.disabled = true;
            // TODO: 使用DOMPurify清理HTML
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> 同步中...';
            
            try {
                // 获取CSRF token
                const csrftoken = getCookie('csrftoken');
                
                if (!csrftoken) {
                    throw new Error('无法获取CSRF token，请刷新页面后重试');
                }
                
                // 调用API
                const response = await fetch('/api/customer/sync-execution-records/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        client_id: parseInt(clientId)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 显示成功消息
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
                    let message = `<strong>同步成功！</strong> 同步了 ${data.synced_count} 条记录，当前共有 ${data.total_count} 条记录。`;
                    if (data.total_amount && parseFloat(data.total_amount) > 0) {
                        message += ` 执行总金额: ¥${parseFloat(data.total_amount).toFixed(2)}`;
                    }
                    // TODO: 使用DOMPurify清理HTML
            alertDiv.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    this.parentElement.appendChild(alertDiv);
                    
                    // 延迟刷新页面，让用户看到成功消息
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.message || '未知错误');
                }
            } catch (error) {
                alert('同步失败：' + error.message);
                // 恢复按钮
                this.disabled = false;
                this.innerHTML = originalText;
            }
        });
    }
});
</script>

<!-- 客户表单功能JS（包含重复检查） -->
<script src="{% static 'js/customer_form.js' %}"></script>
{% endblock %}

