{% extends "customer_management/base.html" %}

{% block title %}{{ page_title }} - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
    .resource-section {
        margin-bottom: 2rem;
    }
    .resource-card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f8f9fa;
    }
    .resource-card h6 {
        margin-bottom: 0.5rem;
        color: #495057;
    }
    .resource-item {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background-color: white;
        border-radius: 0.25rem;
        border-left: 3px solid #007bff;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'business_pages:opportunity_management' %}">å•†æœºç®¡ç†</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ page_title }}</li>
{% endblock %}

{% block content %}
<div class="workspace-content">
    <div class="list-page-container">
        <div class="list-page-header">
            <h1 class="list-page-title">
                {{ page_title }}
            </h1>
            <div class="list-page-actions">
                <a href="{% url 'business_pages:bidding_quotation_create' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> åˆ›å»ºæŠ•æ ‡æŠ¥ä»·
                </a>
            </div>
        </div>
        
        <form method="get" class="list-page-filters">
            <div class="list-page-filter-row">
                <div class="list-page-filter-item">
                    <label>æœç´¢:</label>
                    <input type="text" name="search" class="form-control form-control-sm" 
                           placeholder="æœç´¢æŠ•æ ‡ç¼–å·ã€å•†æœºåç§°ã€å®¢æˆ·..." value="{{ search }}">
                </div>
                <div class="list-page-filter-item">
                    <label>å…³è”å•†æœº:</label>
                    <select name="opportunity_id" class="form-select form-select-sm">
                        <option value="">å…¨éƒ¨å•†æœº</option>
                        {% for opp in opportunities %}
                        <option value="{{ opp.id }}" {% if opportunity_id == opp.id|stringformat:"s" %}selected{% endif %}>
                            {{ opp.name }} ({{ opp.opportunity_number|default:'æœªç¼–å·' }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="list-page-filter-item">
                    <label>çŠ¶æ€:</label>
                    <select name="status" class="form-select form-select-sm">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="list-page-filter-actions">
                    <button type="submit" class="btn btn-sm btn-primary">
                        <i class="bi bi-search"></i> æœç´¢
                    </button>
                    <a href="{% url 'business_pages:opportunity_bidding_quotation' %}" class="btn btn-sm btn-outline-secondary">é‡ç½®</a>
                </div>
            </div>
        </form>
        
        {% if page_obj %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>æŠ•æ ‡ç¼–å·</th>
                        <th>å…³è”å•†æœº</th>
                        <th>å…³è”å®¢æˆ·</th>
                        <th>æŠ•æ ‡æ—¥æœŸ</th>
                        <th>æäº¤æˆªæ­¢æ—¥æœŸ</th>
                        <th>çŠ¶æ€</th>
                        <th>åˆ›å»ºäºº</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bidding in page_obj %}
                    <tr>
                        <td>
                            <strong>{{ bidding.bidding_number|default:'æœªç¼–å·' }}</strong>
                        </td>
                        <td>
                            <a href="{% url 'business_pages:opportunity_detail' bidding.opportunity.id %}">
                                {{ bidding.opportunity.name }}
                            </a>
                            <br><small class="text-muted">{{ bidding.opportunity.opportunity_number|default:'æœªç¼–å·' }}</small>
                        </td>
                        <td>{{ bidding.opportunity.client.name|default:'-' }}</td>
                        <td>{{ bidding.bidding_date|date:'Y-m-d' }}</td>
                        <td>
                            {{ bidding.submission_deadline|date:'Y-m-d' }}
                            {% if bidding.submission_deadline < today %}
                            <span class="badge bg-danger">å·²è¿‡æœŸ</span>
                            {% elif bidding.submission_deadline == today %}
                            <span class="badge bg-warning">ä»Šæ—¥æˆªæ­¢</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if bidding.status == 'draft' %}
                            <span class="badge bg-secondary">{{ bidding.get_status_display }}</span>
                            {% elif bidding.status == 'preparing' %}
                            <span class="badge bg-info">{{ bidding.get_status_display }}</span>
                            {% elif bidding.status == 'submitted' %}
                            <span class="badge bg-primary">{{ bidding.get_status_display }}</span>
                            {% elif bidding.status == 'won' %}
                            <span class="badge bg-success">{{ bidding.get_status_display }}</span>
                            {% elif bidding.status == 'lost' %}
                            <span class="badge bg-danger">{{ bidding.get_status_display }}</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ bidding.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td>{{ bidding.created_by.get_full_name|default:bidding.created_by.username }}</td>
                        <td>{{ bidding.created_time|date:'Y-m-d H:i' }}</td>
                        <td>
                            <a href="{% url 'business_pages:bidding_quotation_detail' bidding.id %}" 
                               class="btn btn-sm btn-outline-primary" title="æŸ¥çœ‹è¯¦æƒ…">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="{% url 'business_pages:bidding_quotation_edit' bidding.id %}" 
                               class="btn btn-sm btn-outline-success" title="ç¼–è¾‘">
                                <i class="bi bi-pencil"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center text-muted">æš‚æ— æŠ•æ ‡æŠ¥ä»·æ•°æ®</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if page_obj.has_other_pages %}
        <nav aria-label="åˆ†é¡µå¯¼èˆª">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if search %}&search={{ search }}{% endif %}{% if opportunity_id %}&opportunity_id={{ opportunity_id }}{% endif %}">é¦–é¡µ</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if opportunity_id %}&opportunity_id={{ opportunity_id }}{% endif %}">ä¸Šä¸€é¡µ</a>
                </li>
                {% endif %}
                <li class="page-item active">
                    <span class="page-link">ç¬¬ {{ page_obj.number }} é¡µï¼Œå…± {{ page_obj.paginator.num_pages }} é¡µ</span>
                </li>
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if opportunity_id %}&opportunity_id={{ opportunity_id }}{% endif %}">ä¸‹ä¸€é¡µ</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if opportunity_id %}&opportunity_id={{ opportunity_id }}{% endif %}">æœ«é¡µ</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> æš‚æ— æŠ•æ ‡æŠ¥ä»·æ•°æ®
        </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="biddingResourcesModal" tabindex="-1" aria-labelledby="biddingResourcesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="biddingResourcesModalLabel">æŠ•æ ‡èµ„æºä¿¡æ¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="resource-section">
                    <h6 class="mb-3">ğŸ“‹ æŠ€æœ¯æ ‡ä¿¡æ¯</h6>
                    <div class="resource-card">
                        <h6>æŠ€æœ¯æ–¹æ¡ˆ</h6>
                        {% if technical_solutions %}
                        {% for solution in technical_solutions %}
                        <div class="resource-item">
                            <strong>{{ solution.name }}</strong> - {{ solution.get_domain_display }}
                            <br><small class="text-muted">{{ solution.optimized_solution|truncatewords:20 }}</small>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-muted">æš‚æ— æŠ€æœ¯æ–¹æ¡ˆ</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="resource-section">
                    <h6 class="mb-3">ğŸ’° å•†åŠ¡æ ‡ä¿¡æ¯</h6>
                    <div class="resource-card">
                        <p class="text-muted">å•†åŠ¡æ ‡ä¿¡æ¯åŒ…æ‹¬æŠ¥ä»·ã€ä»˜æ¬¾æ–¹å¼ã€æœåŠ¡æ‰¿è¯ºç­‰ï¼Œå¯åœ¨åˆ›å»ºæŠ•æ ‡æŠ¥ä»·æ—¶å¡«å†™ã€‚</p>
                    </div>
                </div>
                
                <div class="resource-section">
                    <h6 class="mb-3">ğŸ† ç±»ä¼¼ä¸šç»©</h6>
                    <div class="resource-card">
                        {% if completed_projects %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>é¡¹ç›®åç§°</th>
                                        <th>å®¢æˆ·</th>
                                        <th>é¡¹ç›®ç±»å‹</th>
                                        <th>å®Œæˆæ—¶é—´</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for project in completed_projects %}
                                    <tr>
                                        <td>{{ project.name }}</td>
                                        <td>{{ project.client.name|default:'-' }}</td>
                                        <td>{{ project.project_type|default:'-' }}</td>
                                        <td>{{ project.end_date|date:'Y-m-d'|default:'-' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">æš‚æ— å·²å®Œæˆé¡¹ç›®</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="resource-section">
                    <h6 class="mb-3">ğŸ‘¤ äººå‘˜è¯ä¹¦</h6>
                    <div class="resource-card">
                        {% if employee_certificates %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>å‘˜å·¥å§“å</th>
                                        <th>è¯ä¹¦ç±»å‹</th>
                                        <th>è¯ä¹¦åç§°</th>
                                        <th>åˆ°æœŸæ—¥æœŸ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cert in employee_certificates %}
                                    <tr>
                                        <td>{{ cert.employee.name }}</td>
                                        <td>{{ cert.get_category_display }}</td>
                                        <td>{{ cert.file_name }}</td>
                                        <td>{{ cert.expiry_date|date:'Y-m-d'|default:'é•¿æœŸæœ‰æ•ˆ' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">æš‚æ— äººå‘˜è¯ä¹¦ä¿¡æ¯</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="resource-section">
                    <h6 class="mb-3">ğŸ¢ å…¬å¸è¯ä»¶</h6>
                    <div class="resource-card">
                        <p class="text-muted">å…¬å¸è¯ä»¶åŒ…æ‹¬è¥ä¸šæ‰§ç…§ã€èµ„è´¨è¯ä¹¦ç­‰ï¼Œå¯åœ¨åˆ›å»ºæŠ•æ ‡æŠ¥ä»·æ—¶ä¸Šä¼ ã€‚</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary"data-click="handle_onclick_0">åˆ›å»ºæŠ•æ ‡æŠ¥ä»·</button>
            </div>
        </div>
    </div>
</div>

<script>
function showBiddingResources(opportunityId, opportunityName) {
    document.getElementById('biddingResourcesModalLabel').textContent = 'æŠ•æ ‡èµ„æºä¿¡æ¯ - ' + opportunityName;
    var modal = new bootstrap.Modal(document.getElementById('biddingResourcesModal'));
    modal.show();
}

    // äº‹ä»¶å¤„ç†å™¨: handle_onclick_0
    document.addEventListener('DOMContentLoaded', function() {
        const element = document.querySelector('.btn');
        if (element) {
            element.addEventListener('click', function(e) {
                createBiddingQuotation()
            });
        }
    });

</script>
{% endblock %}
