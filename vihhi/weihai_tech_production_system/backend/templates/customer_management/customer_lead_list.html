{% extends "shared/list_page_base.html" %}
{% load static %}

{% block pm_title %}{{ page_title|default:"å®¢æˆ·çº¿ç´¢" }}{% endblock pm_title %}
{% block pm_subtitle %}æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰å®¢æˆ·çº¿ç´¢{% endblock pm_subtitle %}

{% block pm_actions %}
{% if can_create %}
<a href="{% url 'business_pages:customer_lead_create' %}" class="list-btn list-btn-primary">æ–°å¢å®¢æˆ·çº¿ç´¢</a>
{% endif %}
{% endblock pm_actions %}

{% block list_filters_content %}
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">æœç´¢</label>
    <div class="input-group">
      <select name="search_field" class="form-select form-select-sm" style="max-width: 120px;">
        <option value="all" {% if not request.GET.search_field or request.GET.search_field == 'all' %}selected{% endif %}>å…¨éƒ¨å­—æ®µ</option>
        <option value="company_name" {% if request.GET.search_field == 'company_name' %}selected{% endif %}>å…¬å¸åç§°</option>
        <option value="contact_name" {% if request.GET.search_field == 'contact_name' %}selected{% endif %}>è”ç³»äºº</option>
        <option value="contact_phone" {% if request.GET.search_field == 'contact_phone' %}selected{% endif %}>è”ç³»ç”µè¯</option>
      </select>
      <input type="text" name="search" class="form-control form-control-sm" value="{{ search }}" placeholder="è¯·è¾“å…¥å…³é”®è¯">
    </div>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">è·Ÿè¿›çŠ¶æ€</label>
    <select name="follow_status" class="form-select form-select-sm">
      <option value="">å…¨éƒ¨</option>
      {% for value, label in follow_status_choices %}
      <option value="{{ value }}" {% if follow_status == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">æ¸ é“</label>
    <select name="channel" class="form-select form-select-sm">
      <option value="">å…¨éƒ¨</option>
      {% for value, label in channel_choices %}
      <option value="{{ value }}" {% if channel == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">è´Ÿè´£äºº</label>
    <select name="responsible_user" class="form-select form-select-sm">
      <option value="">å…¨éƒ¨</option>
      {% for user in responsible_users %}
      <option value="{{ user.id }}" {% if responsible_user_id == user.id|stringformat:"s" %}selected{% endif %}>
        {{ user.get_full_name|default:user.username }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">çº¿ç´¢æ¥æº</label>
    <select name="lead_source" class="form-select form-select-sm">
      <option value="">å…¨éƒ¨</option>
      {% for value, label in channel_choices %}
      <option value="{{ value }}" {% if lead_source == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">åˆ›å»ºæ—¶é—´</label>
    <select name="created_time" class="form-select form-select-sm">
      <option value="">å…¨éƒ¨</option>
      <option value="today" {% if created_time == 'today' %}selected{% endif %}>ä»Šå¤©</option>
      <option value="week" {% if created_time == 'week' %}selected{% endif %}>æœ€è¿‘7å¤©</option>
      <option value="month" {% if created_time == 'month' %}selected{% endif %}>æœ€è¿‘30å¤©</option>
    </select>
  </div>
{% endblock list_filters_content %}

{% block list_table_checkbox_header %}
<th style="width: 50px;">
  <input type="checkbox" id="selectAll" class="form-check-input" title="å…¨é€‰">
</th>
{% endblock list_table_checkbox_header %}

{% block list_table_headers %}
<th>è”ç³»äºº</th>
<th>å…¬å¸åç§°</th>
<th>çº¿ç´¢æ¥æº</th>
<th>åœ°åŒº</th>
<th>è´Ÿè´£äºº</th>
<th>è·Ÿè¿›çŠ¶æ€</th>
<th>æœ€æ–°è·Ÿè¿›è®°å½•</th>
<th>å®é™…è·Ÿè¿›æ—¶é—´</th>
<th>æœªè·Ÿè¿›å¤©æ•°</th>
<th>æ“ä½œ</th>
{% endblock list_table_headers %}

{% block list_table_rows %}
{% for lead in page_obj %}
<tr>
  <td>
    <input type="checkbox" class="form-check-input row-checkbox" name="lead_ids" value="{{ lead.id }}" id="lead_{{ lead.id }}">
  </td>
  <td>{{ lead.contact_name|default:"â€”" }}</td>
  <td>{{ lead.company_name }}</td>
  <td>
    <span class="badge bg-secondary">{{ lead.get_lead_source_display }}</span>
  </td>
  <td>{{ lead.get_region_display|default:"â€”" }}</td>
  <td>
    {% if lead.responsible_user %}
    {{ lead.responsible_user.get_full_name|default:lead.responsible_user.username }}
    {% else %}
    <span class="text-muted">æœªåˆ†é…</span>
    {% endif %}
  </td>
  <td>
    <span class="badge bg-secondary">{{ lead.get_follow_status_display }}</span>
  </td>
  <td>{{ lead.latest_followup_note|truncatewords:10|default:"æš‚æ— è·Ÿè¿›è®°å½•" }}</td>
  <td class="text-muted">{{ lead.actual_followup_time|date:"Y-m-d H:i"|default:"â€”" }}</td>
  <td>
    {% if lead.days_not_followed > 0 %}
    <span class="badge {% if lead.days_not_followed > 300 %}bg-danger{% elif lead.days_not_followed > 100 %}bg-warning{% else %}bg-success{% endif %}">
      {{ lead.days_not_followed }}å¤©
    </span>
    {% else %}
    <span class="text-muted">â€”</span>
    {% endif %}
  </td>
  <td>
    <div class="list-page-table-actions">
      <a href="{% url 'business_pages:customer_lead_detail' lead.id %}" class="action-view" title="æŸ¥çœ‹">
        <i class="bi bi-eye"></i>
      </a>
      {% if not lead.responsible_user %}
      <span class="action-separator">|</span>
      <a href="{% url 'business_pages:customer_lead_claim' lead.id %}" class="action-edit" title="è®¤é¢†çº¿ç´¢">
        <i class="bi bi-person-check"></i>
      </a>
      {% endif %}
      {% if can_create %}
      <span class="action-separator">|</span>
      <a href="{% url 'business_pages:customer_lead_followup_create' lead.id %}" class="action-edit" title="æ·»åŠ è·Ÿè¿›">
        <i class="bi bi-plus-circle"></i>
      </a>
      {% if lead.responsible_user %}
      <span class="action-separator">|</span>
      <a href="#" class="action-edit" title="åˆ†é…è´Ÿè´£äºº" onclick="alert('åˆ†é…è´Ÿè´£äººåŠŸèƒ½å¾…å®ç°'); return false;">
        <i class="bi bi-person-gear"></i>
      </a>
      {% endif %}
      {% if not lead.converted_client %}
      <span class="action-separator">|</span>
      <a href="#" class="action-edit" title="è½¬åŒ–ä¸ºå®¢æˆ·" onclick="alert('è½¬åŒ–ä¸ºå®¢æˆ·åŠŸèƒ½å¾…å®ç°'); return false;">
        <i class="bi bi-arrow-right-circle"></i>
      </a>
      {% endif %}
      <span class="action-separator">|</span>
      <a href="{% url 'business_pages:customer_lead_delete' lead.id %}" class="action-delete" title="åˆ é™¤" onclick="return confirm('ç¡®å®šè¦åˆ é™¤æ­¤å®¢æˆ·çº¿ç´¢å—ï¼Ÿ');">
        <i class="bi bi-trash"></i>
      </a>
      {% endif %}
    </div>
  </td>
  {% if column_settings_btn|default:False %}<td></td>{% endif %}
</tr>
{% empty %}
<tr>
  <td colspan="{% if column_settings_btn|default:False %}12{% else %}11{% endif %}" class="list-empty">
    <div class="list-empty-icon">ğŸ“‹</div>
    <div class="list-empty-text">æš‚æ— å®¢æˆ·çº¿ç´¢æ•°æ®</div>
    {% block list_empty_hint %}
    <p class="text-muted" style="font-size: 0.9rem; margin-top: 8px;">è¯·åˆ›å»ºç¬¬ä¸€ä¸ªå®¢æˆ·çº¿ç´¢å¼€å§‹ä½¿ç”¨</p>
    {% endblock list_empty_hint %}
  </td>
</tr>
{% endfor %}
{% endblock list_table_rows %}

{% block module_extra_js %}
<script>
// å…¨é€‰/å–æ¶ˆå…¨é€‰
document.getElementById('selectAll')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateSelectedCount();
});

// è¡Œå¤é€‰æ¡†å˜åŒ–
document.querySelectorAll('.row-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        updateSelectedCount();
        updateSelectAllState();
    });
});

// æ›´æ–°é€‰ä¸­æ•°é‡
function updateSelectedCount() {
    const selected = document.querySelectorAll('.row-checkbox:checked').length;
    const countEl = document.getElementById('selectedCount');
    if (countEl) {
        countEl.textContent = selected;
    }
}

// æ›´æ–°å…¨é€‰çŠ¶æ€
function updateSelectAllState() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const selectAll = document.getElementById('selectAll');
    if (checkboxes.length > 0 && selectAll) {
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        const someChecked = Array.from(checkboxes).some(cb => cb.checked);
        selectAll.checked = allChecked;
        selectAll.indeterminate = someChecked && !allChecked;
    }
}

// åˆå§‹åŒ–
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        updateSelectedCount();
        updateSelectAllState();
    });
} else {
    updateSelectedCount();
    updateSelectAllState();
}
</script>
{% endblock module_extra_js %}
