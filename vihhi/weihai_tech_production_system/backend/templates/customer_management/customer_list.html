{% extends "shared/list_page_base.html" %}
{% load static %}

{% block list_page_title %}
<div class="d-flex justify-content-between align-items-center w-100">
  <span>å®¢æˆ·åˆ—è¡¨</span>
  {% if can_create %}
  <a href="{% url 'business_pages:customer_create' %}" class="list-btn list-btn-primary">åˆ›å»ºå®¢æˆ·</a>
  {% endif %}
</div>
{% endblock %}

{% block list_page_subtitle_content %}æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰å®¢æˆ·ä¿¡æ¯{% endblock %}

{% block list_stats_content %}
  {# ç»Ÿè®¡å¡ç‰‡ - ç›´æ¥æ”¾åœ¨ list-page-stats ä¸­ï¼ŒCSSä¼šè‡ªåŠ¨ä¸€è¡Œæ’åˆ— #}
  {% if summary_cards %}
    {% for card in summary_cards %}
    <div class="list-stat-card">
      <div class="list-stat-label">{{ card.label }}</div>
      <div class="list-stat-value">{{ card.value|default:0 }}</div>
      {% if card.hint %}
      <div class="list-stat-hint">{{ card.hint }}</div>
      {% endif %}
    </div>
    {% endfor %}
  {% else %}
    <div class="list-stat-card">
      <div class="list-stat-label">å®¢æˆ·æ€»æ•°</div>
      <div class="list-stat-value">{{ page_obj.paginator.count|default:0 }}</div>
    </div>
  {% endif %}
{% endblock list_stats_content %}

{% block list_filters_content %}
  {# ç­›é€‰å™¨ - ä½¿ç”¨æ ‡å‡†Bootstrapæ …æ ¼ç³»ç»Ÿ #}
  <div class="row g-3">
    {# æœç´¢å­—æ®µ #}
    <div class="col-md-3">
      <label class="form-label">æœç´¢</label>
      <div class="input-group">
        <select name="search_field" class="form-select form-select-sm" style="max-width: 120px;">
          <option value="name" {% if search_field == 'name' %}selected{% endif %}>å®¢æˆ·åç§°</option>
          <option value="phone" {% if search_field == 'phone' %}selected{% endif %}>ç”µè¯</option>
          <option value="wechat" {% if search_field == 'wechat' %}selected{% endif %}>å¾®ä¿¡</option>
          <option value="address" {% if search_field == 'address' %}selected{% endif %}>åœ°å€</option>
          <option value="unified_credit_code" {% if search_field == 'unified_credit_code' %}selected{% endif %}>ç»Ÿä¸€ä¿¡ç”¨ä»£ç </option>
        </select>
        <input type="text" name="search" class="form-control form-control-sm" value="{{ search }}" placeholder="è¯·è¾“å…¥å…³é”®è¯">
      </div>
    </div>

    {# å®¢æˆ·ç­‰çº§ #}
    <div class="col-md-2">
      <label class="form-label">å®¢æˆ·ç­‰çº§</label>
      <select name="client_level" class="form-select form-select-sm">
        <option value="">å…¨éƒ¨</option>
        {% for value, label in client_level_choices %}
        <option value="{{ value }}" {% if client_level == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    {# å®¢æˆ·ç±»å‹ #}
    <div class="col-md-2">
      <label class="form-label">å®¢æˆ·ç±»å‹</label>
      <select name="client_type" class="form-select form-select-sm">
        <option value="">å…¨éƒ¨</option>
        {% for id, name in client_type_choices %}
        <option value="{{ id }}" {% if client_type == id|stringformat:"s" %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </div>

    {# ä¿¡ç”¨ç­‰çº§ #}
    <div class="col-md-2">
      <label class="form-label">ä¿¡ç”¨ç­‰çº§</label>
      <select name="credit_level" class="form-select form-select-sm">
        <option value="">å…¨éƒ¨</option>
        {% for value, label in credit_level_choices %}
        <option value="{{ value }}" {% if credit_level == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    {# è´Ÿè´£äºº #}
    <div class="col-md-2">
      <label class="form-label">è´Ÿè´£äºº</label>
      <select name="responsible_user" class="form-select form-select-sm">
        <option value="">å…¨éƒ¨</option>
        {% for user in users %}
        <option value="{{ user.id }}" {% if responsible_user_id == user.id|stringformat:"s" %}selected{% endif %}>
          {{ user.get_full_name|default:user.username }}
        </option>
        {% endfor %}
      </select>
    </div>

    {# æ˜¯å¦æ´»è·ƒ #}
    <div class="col-md-2">
      <label class="form-label">çŠ¶æ€</label>
      <select name="is_active" class="form-select form-select-sm">
        <option value="">å…¨éƒ¨</option>
        <option value="1" {% if is_active == '1' %}selected{% endif %}>æ´»è·ƒ</option>
        <option value="0" {% if is_active == '0' %}selected{% endif %}>éæ´»è·ƒ</option>
      </select>
    </div>

    {# æ¥æº #}
    <div class="col-md-2">
      <label class="form-label">æ¥æº</label>
      <select name="source" class="form-select form-select-sm">
        <option value="">å…¨éƒ¨</option>
        {% for value, label in source_choices %}
        <option value="{{ value }}" {% if source == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    {# è¡Œä¸š #}
    <div class="col-md-2">
      <label class="form-label">è¡Œä¸š</label>
      <input type="text" name="industry" class="form-control form-control-sm" value="{{ industry }}" placeholder="è¯·è¾“å…¥è¡Œä¸š">
    </div>

    {# åœ°åŒº #}
    <div class="col-md-2">
      <label class="form-label">åœ°åŒº</label>
      <input type="text" name="region" class="form-control form-control-sm" value="{{ region }}" placeholder="è¯·è¾“å…¥åœ°åŒº">
    </div>

    {# å®¡æ‰¹çŠ¶æ€ #}
    <div class="col-md-2">
      <label class="form-label">å®¡æ‰¹çŠ¶æ€</label>
      <select name="approval_status" class="form-select form-select-sm">
        {% for value, label in approval_status_choices %}
        <option value="{{ value }}" {% if approval_status == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    {# æ—¥æœŸèŒƒå›´ #}
    <div class="col-md-2">
      <label class="form-label">åˆ›å»ºæ—¶é—´</label>
      <select name="date_range" class="form-select form-select-sm" id="date_range">
        <option value="">å…¨éƒ¨</option>
        <option value="today" {% if date_range == 'today' %}selected{% endif %}>ä»Šå¤©</option>
        <option value="yesterday" {% if date_range == 'yesterday' %}selected{% endif %}>æ˜¨å¤©</option>
        <option value="this_week" {% if date_range == 'this_week' %}selected{% endif %}>æœ¬å‘¨</option>
        <option value="last_week" {% if date_range == 'last_week' %}selected{% endif %}>ä¸Šå‘¨</option>
        <option value="this_month" {% if date_range == 'this_month' %}selected{% endif %}>æœ¬æœˆ</option>
        <option value="last_month" {% if date_range == 'last_month' %}selected{% endif %}>ä¸Šæœˆ</option>
        <option value="custom" {% if date_range == 'custom' %}selected{% endif %}>è‡ªå®šä¹‰</option>
      </select>
    </div>

    {# è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´ #}
    <div class="col-md-3" id="custom_date_range" style="display: {% if date_range == 'custom' %}block{% else %}none{% endif %};">
      <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
      <input type="date" name="created_time_start" class="form-control form-control-sm" value="{{ created_time_start }}">
    </div>
    <div class="col-md-3" id="custom_date_range_end" style="display: {% if date_range == 'custom' %}block{% else %}none{% endif %};">
      <label class="form-label">ç»“æŸæ—¥æœŸ</label>
      <input type="date" name="created_time_end" class="form-control form-control-sm" value="{{ created_time_end }}">
    </div>
  </div>
{% endblock list_filters_content %}

{% block list_table_section %}
  {# æ“ä½œæ  #}
  <div class="list-action-bar mb-2">
    <div class="d-flex justify-content-between align-items-center">
      <div class="text-muted small">
        å…± <strong>{{ page_obj.paginator.count|default:0 }}</strong> æ¡è®°å½•
      </div>
    </div>
  </div>

  {# è¡¨æ ¼ #}
  {{ block.super }}
{% endblock %}

{% block list_table_checkbox_header %}
  <th style="width: 50px;">
    <input type="checkbox" id="selectAll" class="form-check-input" title="å…¨é€‰">
  </th>
{% endblock list_table_checkbox_header %}

{% block list_table_headers %}
<th>å®¢æˆ·åç§°</th>
<th>ç»Ÿä¸€ä¿¡ç”¨ä»£ç </th>
<th>å®¢æˆ·ç­‰çº§</th>
<th>å®¢æˆ·ç±»å‹</th>
<th>ä¿¡ç”¨ç­‰çº§</th>
<th>è´Ÿè´£äºº</th>
<th>åˆ›å»ºæ—¶é—´</th>
<th>æ“ä½œ</th>
{% endblock list_table_headers %}

{% block list_table_rows %}
{% for client in page_obj %}
<tr>
  <td>
    <input type="checkbox" class="form-check-input row-checkbox" name="item_ids" value="{{ client.id }}" id="item_{{ client.id }}">
  </td>
  <td>
    <a href="{% url 'business_pages:customer_detail' client.id %}">
      {{ client.name }}
    </a>
  </td>
  <td><code>{{ client.unified_credit_code|default:"æœªå¡«å†™" }}</code></td>
  <td>
    <span class="badge bg-secondary">{{ client.get_client_level_display }}</span>
  </td>
  <td>{{ client.get_client_type_display|default:"æœªå¡«å†™" }}</td>
  <td>
    <span class="badge bg-secondary">{{ client.get_credit_level_display }}</span>
  </td>
  <td>
    {% if client.responsible_user %}
    {{ client.responsible_user.get_full_name|default:client.responsible_user.username }}
    {% else %}
    <span class="text-muted">å…¬æµ·</span>
    {% endif %}
  </td>
  <td>{{ client.created_time|date:"Y-m-d" }}</td>
  <td>
    <div class="list-page-table-actions">
      <a href="{% url 'business_pages:customer_detail' client.id %}" class="action-view" title="æŸ¥çœ‹">
        <i class="bi bi-eye"></i>
      </a>
      {% if client.can_edit %}
      <span class="action-separator">|</span>
      <a href="{% url 'business_pages:customer_edit' client.id %}" class="action-edit" title="ç¼–è¾‘">
        <i class="bi bi-pencil"></i>
      </a>
      {% endif %}
    </div>
  </td>
</tr>
{% empty %}
<tr>
  <td colspan="9" class="list-empty-state">
    <div class="list-empty-state-icon">ğŸ“‹</div>
    <div class="list-empty-state-text">æš‚æ— å®¢æˆ·æ•°æ®</div>
    <div class="list-empty-state-hint">è¯·åˆ›å»ºç¬¬ä¸€ä¸ªå®¢æˆ·å¼€å§‹ä½¿ç”¨</div>
  </td>
</tr>
{% endfor %}
{% endblock %}

{% block module_extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨è”åŠ¨
  const dateRangeSelect = document.getElementById('date_range');
  const customDateRange = document.getElementById('custom_date_range');
  const customDateRangeEnd = document.getElementById('custom_date_range_end');
  
  if (dateRangeSelect) {
    dateRangeSelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        customDateRange.style.display = 'block';
        customDateRangeEnd.style.display = 'block';
      } else {
        customDateRange.style.display = 'none';
        customDateRangeEnd.style.display = 'none';
      }
    });
  }
});
</script>
{% endblock %}
