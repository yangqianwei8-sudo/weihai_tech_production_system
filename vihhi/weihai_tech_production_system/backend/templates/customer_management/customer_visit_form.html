{% extends "customer_management/base.html" %}

{% block title %}{{ page_title }} - 维海科技信息化管理平台{% endblock %}

{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'business_pages:customer_visit' %}">创建联系人拜访</a></li>
<li class="breadcrumb-item active">客户拜访</li>
{% endblock %}

{% block content %}
<div class="workspace-content">
    <div class="container-fluid py-4">
        <div class="info-card info-card-compact">
            <div class="info-card-header">
                <h5 class="info-card-title">{{ page_title }}</h5>
            </div>
            <div class="info-card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="info-section">
                        <div class="info-grid info-grid-2">
                            <div class="info-item">
                                <label class="info-label info-label-required">{{ form.client.label }}</label>
                                {{ form.client }}
                            </div>
                            <div class="info-item">
                                <label class="info-label info-label-required">{{ form.visit_type.label }}</label>
                                {{ form.visit_type }}
                            </div>
                            <div class="info-item">
                                <label class="info-label info-label-required">{{ form.followup_method.label }}</label>
                                {{ form.followup_method }}
                            </div>
                            <div class="info-item">
                                <label class="info-label info-label-required">{{ form.visit_date.label }}</label>
                                {{ form.visit_date }}
                            </div>
                            <div class="info-item" style="grid-column: 1 / -1;">
                                <label class="info-label">{{ form.related_contacts.label }}</label>
                                {{ form.related_contacts }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 隐藏字段用于存储位置信息 -->
                    <input type="hidden" name="latitude" id="hiddenLatitude" value="">
                    <input type="hidden" name="longitude" id="hiddenLongitude" value="">
                    <input type="hidden" name="location_address" id="hiddenLocationAddress" value="">
                    
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">保存</button>
                        <a href="{% url 'business_pages:customer_visit' %}" class="btn btn-secondary">取消</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 页面底部：当前地理位置显示 -->
    <div class="container-fluid py-3" style="border-top: 1px solid #e0e0e0; background-color: #f8f9fa;">
        <div class="info-card info-card-compact" style="margin-bottom: 0;">
            <div class="info-card-header">
                <h6 class="info-card-title mb-0">
                    <i class="bi bi-geo-alt-fill text-primary"></i> 当前地理位置
                </h6>
            </div>
            <div class="info-card-body py-2">
                <div id="locationDisplay" class="d-flex align-items-center gap-3 flex-wrap">
                    <div class="text-muted">
                        <i class="bi bi-hourglass-split"></i> 正在获取位置信息...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 检测是否为移动设备
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
               (window.innerWidth <= 768);
    }
    
    // 自动定位功能
    const hiddenLatitude = document.getElementById('hiddenLatitude');
    const hiddenLongitude = document.getElementById('hiddenLongitude');
    const hiddenLocationAddress = document.getElementById('hiddenLocationAddress');
    const locationDisplay = document.getElementById('locationDisplay');
    const visitForm = document.querySelector('form');
    
    // 定位状态
    let isLocating = false;
    let locationObtained = false;
    
    // 更新位置显示
    function updateLocationDisplay(latitude, longitude, address) {
        if (!locationDisplay) return;
        
        if (latitude && longitude) {
            const lat = parseFloat(latitude).toFixed(7);
            const lon = parseFloat(longitude).toFixed(7);
            
            let displayHtml = `
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-check-circle-fill text-success"></i>
                    <span class="fw-bold text-success">定位成功</span>
                </div>
            `;
            
            if (address) {
                displayHtml += `
                    <div class="w-100 mt-2">
                        <div class="text-muted small">地址：</div>
                        <div class="fw-semibold">${address}</div>
                    </div>
                `;
            }
            
            displayHtml += `
                <div class="w-100 mt-2">
                    <div class="text-muted small">坐标：</div>
                    <div class="font-monospace small">纬度 ${lat}，经度 ${lon}</div>
                </div>
            `;
            
            locationDisplay.innerHTML = displayHtml;
        } else {
            // TODO: 使用DOMPurify清理HTML
            locationDisplay.innerHTML = `
                <div class="text-muted">
                    <i class="bi bi-exclamation-circle"></i> 未获取到位置信息
                </div>
            `;
        }
    }
    
    // 更新位置显示状态（简化版，主要用于底部显示）
    function updateLocationStatus(message, isSuccess = true) {
        if (locationDisplay && !locationObtained) {
            const icon = isSuccess ? 'bi-hourglass-split' : 'bi-exclamation-circle';
            const color = isSuccess ? 'text-info' : 'text-danger';
            // TODO: 使用DOMPurify清理HTML
            locationDisplay.innerHTML = `
                <div class="${color}">
                    <i class="bi ${icon}"></i> ${message}
                </div>
            `;
        }
    }
    
    // 调用高德地图API获取地址
    async function getAddressFromCoordinates(latitude, longitude) {
        try {
            updateLocationStatus('正在解析地址...', true);
            const response = await fetch(`/api/customer/regeocode/?latitude=${latitude}&longitude=${longitude}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (data.success && data.formatted_address) {
                // 保存地址到隐藏字段
                hiddenLocationAddress.value = data.formatted_address;
                // 更新底部显示
                updateLocationDisplay(latitude, longitude, data.formatted_address);
                return true;
            } else {
                // 即使地址解析失败，也更新坐标显示
                updateLocationDisplay(latitude, longitude, null);
                return false;
            }
        } catch (error) {
            // 即使地址解析失败，也更新坐标显示
            updateLocationDisplay(latitude, longitude, null);
            return false;
        }
    }
    
    // GPS定位
    function getLocation(showStatus = true) {
        if (!navigator.geolocation) {
            if (showStatus) {
                updateLocationStatus('浏览器不支持GPS定位，尝试IP定位...', false);
            }
            // GPS不支持时自动尝试IP定位
            setTimeout(() => getIPLocation(), 1000);
            return;
        }
        
        if (isLocating) {
            return; // 正在定位中，避免重复请求
        }
        
        isLocating = true;
        if (showStatus) {
            updateLocationStatus('正在获取GPS位置...', true);
        }
        
        navigator.geolocation.getCurrentPosition(
            async function(position) {
                const lat = position.coords.latitude.toFixed(7);
                const lon = position.coords.longitude.toFixed(7);
                
                // 保存到隐藏字段
                hiddenLatitude.value = lat;
                hiddenLongitude.value = lon;
                locationObtained = true;
                
                // 调用API获取地址
                await getAddressFromCoordinates(lat, lon);
                
                isLocating = false;
            },
            function(error) {
                let errorMessage = 'GPS定位失败';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = '定位权限被拒绝，尝试IP定位...';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = '位置信息不可用，尝试IP定位...';
                        break;
                    case error.TIMEOUT:
                        errorMessage = '定位超时，尝试IP定位...';
                        break;
                    default:
                        errorMessage = '定位失败，尝试IP定位...';
                        break;
                }
                if (showStatus) {
                    updateLocationStatus(errorMessage, false);
                }
                isLocating = false;
                // GPS定位失败，自动尝试IP定位
                setTimeout(() => getIPLocation(), 1000);
            },
            {
                enableHighAccuracy: false,  // 降低精度要求，加快定位速度
                timeout: 30000,  // 增加超时时间到30秒
                maximumAge: 60000  // 允许使用1分钟内的缓存位置
            }
        );
    }
    
    // IP定位（备选方案）
    async function getIPLocation() {
        updateLocationStatus('正在通过IP获取位置...', true);
        
        try {
            const response = await fetch('/api/customer/ip-location/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (data.success && data.center_latitude && data.center_longitude) {
                const lat = data.center_latitude.toFixed(7);
                const lon = data.center_longitude.toFixed(7);
                
                // 保存到隐藏字段
                hiddenLatitude.value = lat;
                hiddenLongitude.value = lon;
                locationObtained = true;
                
                // 调用API获取详细地址
                await getAddressFromCoordinates(lat, lon);
                
                updateLocationStatus(`IP定位成功（${data.city || '城市级别'}）`, true);
            } else {
                updateLocationStatus('IP定位失败：' + (data.message || '无法获取位置信息'), false);
            }
        } catch (error) {
            updateLocationStatus('IP定位失败，请检查网络连接', false);
        }
    }
    
    // 检查是否已有位置信息（从隐藏字段）
    if (hiddenLatitude.value && hiddenLongitude.value) {
        locationObtained = true;
        updateLocationDisplay(hiddenLatitude.value, hiddenLongitude.value, hiddenLocationAddress.value);
    }
    
    // 表单提交时自动获取位置（如果还没有）
    if (visitForm) {
        visitForm.addEventListener('submit', async function(e) {
            // 如果是移动设备且还没有位置信息，尝试自动获取
            if (isMobileDevice() && !locationObtained && !hiddenLatitude.value && !hiddenLongitude.value) {
                e.preventDefault(); // 阻止提交
                
                updateLocationStatus('正在自动获取位置信息...', true);
                
                // 尝试GPS定位
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: false,
                                timeout: 15000,
                                maximumAge: 60000
                            });
                        });
                        
                        const lat = position.coords.latitude.toFixed(7);
                        const lon = position.coords.longitude.toFixed(7);
                        
                        hiddenLatitude.value = lat;
                        hiddenLongitude.value = lon;
                        locationObtained = true;
                        
                        // 快速获取地址（不等待完成）
                        getAddressFromCoordinates(lat, lon).then(() => {
                            // 地址获取完成后提交表单
                            visitForm.submit();
                        }).catch(() => {
                            // 即使地址获取失败也提交表单
                            visitForm.submit();
                        });
                        
                        return;
                    } catch (error) {
                    }
                }
                
                // GPS定位失败，尝试IP定位
                try {
                    await getIPLocation();
                    if (hiddenLatitude.value && hiddenLongitude.value) {
                        locationObtained = true;
                        visitForm.submit();
                        return;
                    }
                } catch (error) {
                }
                
                // 定位失败，询问用户是否继续提交
                updateLocationStatus('自动定位失败，是否继续提交？', false);
                if (confirm('无法自动获取位置信息，是否继续提交？（可以稍后手动添加位置信息）')) {
                    visitForm.submit();
                }
            }
        });
    }
    
    // 页面加载时自动尝试定位（所有设备）
    if (!hiddenLatitude.value && !hiddenLongitude.value) {
        // 延迟1秒后自动定位，给页面加载时间
        setTimeout(() => {
            if (navigator.geolocation) {
                updateLocationStatus('正在自动获取位置...', true);
                getLocation(true);
            } else {
                // 不支持GPS，尝试IP定位
                getIPLocation();
            }
        }, 1000);
    } else {
        // 已有位置信息，直接显示
        updateLocationDisplay(hiddenLatitude.value, hiddenLongitude.value, hiddenLocationAddress.value);
    }
</script>
{% endblock %}

