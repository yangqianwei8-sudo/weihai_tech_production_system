{% extends "customer_management/_base.html" %}

{% block title %}{{ page_title }} - ç»´æµ·ç§‘æŠ€ä¿¡æ¯åŒ–ç®¡ç†å¹³å°{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'contract_pages:contract_management_list' %}">åˆåŒç®¡ç†</a></li>
    <li class="breadcrumb-item active" aria-current="page">åˆåŒè¯¦æƒ…</li>
{% endblock %}

{% block extra_css %}
<style>
    .contract-detail-nav {
        background: #fff;
        border-radius: 12px;
        padding: 0;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
    }
    .contract-detail-nav-tabs {
        display: flex;
        gap: 0;
    }
    .contract-detail-nav-item {
        flex: 1;
    }
    .contract-detail-nav-link {
        display: block;
        padding: 16px 24px;
        text-align: center;
        color: #6b7280;
        text-decoration: none;
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease;
        font-weight: 500;
        font-size: 14px;
    }
    .contract-detail-nav-link:hover {
        color: #1f2937;
        background: #f9fafb;
    }
    .contract-detail-nav-link.active {
        color: #1f2937;
        border-bottom-color: #1f2937;
        background: #f9fafb;
    }
    .payment-plan-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .file-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    .status-badge.draft {
        background: #f3f4f6;
        color: #6b7280;
    }
    .status-badge.pending_review {
        background: #dbeafe;
        color: #1e40af;
    }
    .status-badge.reviewing {
        background: #fef3c7;
        color: #92400e;
    }
    .status-badge.signed {
        background: #d1fae5;
        color: #065f46;
    }
    .status-badge.effective {
        background: #dbeafe;
        color: #1e40af;
    }
    .status-badge.executing {
        background: #e0e7ff;
        color: #3730a3;
    }
    .status-badge.completed {
        background: #d1fae5;
        color: #065f46;
    }
    .status-badge.terminated {
        background: #fee2e2;
        color: #991b1b;
    }
    .status-badge.cancelled {
        background: #f3f4f6;
        color: #6b7280;
    }
    /* è¿›åº¦æ ‡ç­¾æ ·å¼ */
    .contract-progress {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
    }
    .progress-steps {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
    }
    .progress-step {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 1;
    }
    .progress-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 20px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: #e5e7eb;
        z-index: 0;
    }
    .progress-step.completed:not(:last-child)::after {
        background: #10b981;
    }
    .progress-step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        background: #f3f4f6;
        color: #6b7280;
        border: 2px solid #e5e7eb;
        position: relative;
        z-index: 1;
        margin-bottom: 8px;
    }
    .progress-step.active .progress-step-circle {
        background: #142F5B;
        color: #fff;
        border-color: #142F5B;
    }
    .progress-step.completed .progress-step-circle {
        background: #10b981;
        color: #fff;
        border-color: #10b981;
    }
    .progress-step-label {
        font-size: 13px;
        color: #6b7280;
        text-align: center;
        font-weight: 500;
    }
    .progress-step.active .progress-step-label {
        color: #142F5B;
        font-weight: 600;
    }
    .progress-step.completed .progress-step-label {
        color: #10b981;
    }
    .progress-section-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 16px;
    }
</style>
{% endblock %}

{% block content %}

<div class="container-fluid py-4">
    
    <div class="center-hero mb-4">
        <div style="position: relative; z-index: 1;">
            <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 8px 0;">{{ page_title }}</h1>
            <p style="font-size: 14px; opacity: 0.9; margin: 0;">åˆåŒè¯¦ç»†ä¿¡æ¯ä¸å…³è”æ•°æ®</p>
        </div>
    </div>

    <div class="text-end mb-4">
        
        <div class="btn-group me-2" role="group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                çŠ¶æ€æµè½¬
            </button>
            <ul class="dropdown-menu">
                {% if valid_transitions %}
                    {% for transition in valid_transitions %}
                        {% if transition.code != 'party_b_signed' and transition.code != 'signed' %}
                        <li>
                            <button class="dropdown-item" type="button"data-click="handle_onclick_0"{{ transition.code }}', '{{ transition.label }}')">
                                â†’ {{ transition.label }}
                            </button>
                        </li>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <li><span class="dropdown-item text-muted">å½“å‰çŠ¶æ€æ— å¯ç”¨æµè½¬</span></li>
                {% endif %}
            </ul>
        </div>
        {% if can_edit %}
        <a href="{% url 'contract_pages:contract_edit' contract.id %}" class="btn btn-primary me-2">ç¼–è¾‘åˆåŒ</a>
        {% endif %}
        {% if can_manage %}
        {% if contract.status in 'pending_review,reviewing' %}
        <button type="button" class="btn btn-success me-2"data-click="handle_onclick_1"signed', 'å·²ç­¾è®¢')">
            <i class="bi bi-pen"></i> ç­¾ç½²åˆåŒ
        </button>
        {% endif %}
        <a href="{% url 'admin:customer_management_businesspaymentplan_add' %}?contract={{ contract.id }}" class="btn btn-outline-primary me-2" target="_blank">æ·»åŠ å›æ¬¾è®¡åˆ’</a>
        <a href="{% url 'contract_pages:contract_file_upload' contract.id %}" class="btn btn-outline-primary me-2">ä¸Šä¼ æ–‡ä»¶</a>
        <a href="{% url 'contract_pages:contract_change_create' contract.id %}" class="btn btn-outline-warning me-2">åˆ›å»ºå˜æ›´</a>
        {% if approval_instance %}
        <a href="{% url 'workflow_engine:approval_detail' approval_instance.id %}" class="btn btn-info me-2">æŸ¥çœ‹å®¡æ‰¹è¯¦æƒ…</a>
        {% elif can_submit_approval %}
        <a href="{% url 'contract_pages:contract_submit_approval' contract.id %}" class="btn btn-info me-2">æäº¤å®¡æ‰¹</a>
        {% endif %}
        {% if contract.status == 'draft' %}
        <form method="post" action="{% url 'contract_pages:contract_delete' contract.id %}" style="display: inline;" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤åˆåŒ {{ contract.contract_number }} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼');">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger me-2">åˆ é™¤åˆåŒ</button>
        </form>
        {% endif %}
        {% endif %}
        <a href="{% url 'contract_pages:contract_management_list' %}" class="btn btn-outline-secondary">è¿”å›åˆ—è¡¨</a>
    </div>
    
    {% if approval_instance %}
    <div class="info-card {% if approval_instance.status == 'approved' %}info-card-success{% elif approval_instance.status == 'rejected' %}info-card-danger{% elif approval_instance.status == 'pending' %}info-card-warning{% else %}info-card-info{% endif %}" style="margin-bottom: 24px;">
        <div class="info-card-header">
            <div>
                <h5 class="info-card-title">å®¡æ‰¹çŠ¶æ€</h5>
                <p class="text-muted mb-0" style="font-size: 13px; margin-top: 4px;">å®¡æ‰¹ç¼–å·ï¼š{{ approval_instance.instance_number }}</p>
            </div>
            <div>
                {% if approval_instance.status == 'approved' %}
                <span class="badge bg-success">âœ“ å·²é€šè¿‡</span>
                {% elif approval_instance.status == 'rejected' %}
                <span class="badge bg-danger">âœ— å·²é©³å›</span>
                {% elif approval_instance.status == 'pending' %}
                <span class="badge bg-warning">â³ å®¡æ‰¹ä¸­</span>
                {% elif approval_instance.status == 'withdrawn' %}
                <span class="badge bg-secondary">â†© å·²æ’¤å›</span>
                {% else %}
                <span class="badge bg-secondary">{{ approval_instance.get_status_display }}</span>
                {% endif %}
            </div>
        </div>
        <div class="info-card-body">
            <div class="info-grid info-grid-3">
                <div class="info-item">
                    <span class="info-label">ç”³è¯·äºº</span>
                    <span class="info-value">{{ approval_instance.applicant.username }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ç”³è¯·æ—¶é—´</span>
                    <span class="info-value">{{ approval_instance.apply_time|date:"Y-m-d H:i" }}</span>
                </div>
                {% if approval_instance.current_node %}
                <div class="info-item">
                    <span class="info-label">å½“å‰èŠ‚ç‚¹</span>
                    <span class="info-value">{{ approval_instance.current_node.name }}</span>
                </div>
                {% endif %}
            </div>
            
            {% if approval_instance.apply_comment %}
            <div class="info-section mt-3">
                <div class="info-item">
                    <span class="info-label">ç”³è¯·è¯´æ˜</span>
                    <span class="info-value">{{ approval_instance.apply_comment }}</span>
                </div>
            </div>
            {% endif %}
            
            {% if approval_records %}
            <div class="info-section mt-3">
                <h6 class="info-section-title">å®¡æ‰¹è®°å½•</h6>
                <div class="info-list">
                    {% for record in approval_records %}
                    <div class="info-item info-item-highlight" style="border-left-color: {% if record.result == 'approved' %}#10b981{% elif record.result == 'rejected' %}#ef4444{% elif record.result == 'transferred' %}#3b82f6{% else %}#6b7280{% endif %};">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ record.node.name }}</strong>
                                <span class="text-muted ms-2">{{ record.approver.username }}</span>
                            </div>
                            <div>
                                {% if record.result == 'approved' %}
                                <span class="badge bg-success">é€šè¿‡</span>
                                {% elif record.result == 'rejected' %}
                                <span class="badge bg-danger">é©³å›</span>
                                {% elif record.result == 'transferred' %}
                                <span class="badge bg-info">è½¬äº¤</span>
                                {% elif record.result == 'withdrawn' %}
                                <span class="badge bg-secondary">æ’¤å›</span>
                                {% else %}
                                <span class="badge bg-warning">å¾…å®¡æ‰¹</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if record.comment %}
                        <p class="mb-0 mt-1" style="font-size: 13px; color: #6b7280;">{{ record.comment }}</p>
                        {% endif %}
                        <p class="mb-0 mt-1" style="font-size: 12px; color: #9ca3af;">{{ record.approval_time|date:"Y-m-d H:i" }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <div class="modal fade" id="statusTransitionModal" tabindex="-1" aria-labelledby="statusTransitionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'contract_pages:contract_status_transition' contract.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="target_status" id="target_status_input">
                    <div class="modal-header">
                        <h5 class="modal-title" id="statusTransitionModalLabel">åˆåŒçŠ¶æ€æµè½¬</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">å½“å‰çŠ¶æ€</label>
                            <input type="text" class="form-control" value="{{ contract.get_status_display }}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç›®æ ‡çŠ¶æ€</label>
                            <input type="text" class="form-control" id="target_status_display" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å¤‡æ³¨è¯´æ˜ <span class="text-muted">(å¯é€‰)</span></label>
                            <textarea name="comment" class="form-control" rows="3" placeholder="è¯·è¾“å…¥çŠ¶æ€æµè½¬çš„å¤‡æ³¨è¯´æ˜"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ç¡®è®¤æµè½¬</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
    function showStatusTransitionModal(statusCode, statusLabel) {
        document.getElementById('target_status_input').value = statusCode;
        document.getElementById('target_status_display').value = statusLabel;
        const modal = new bootstrap.Modal(document.getElementById('statusTransitionModal'));
        modal.show();
    }
    
    function showSignModal(statusCode, statusLabel) {
        document.getElementById('sign_target_status_input').value = statusCode;
        document.getElementById('sign_target_status_display').value = statusLabel;
        const modal = new bootstrap.Modal(document.getElementById('signModal'));
        modal.show();
    }
    
    // äº‹ä»¶å¤„ç†å™¨: handle_onclick_0
    document.addEventListener('DOMContentLoaded', function() {
        const element = document.querySelector('.dropdown-item');
        if (element) {
            element.addEventListener('click', function(e) {
                showStatusTransitionModal(
            });
        }
    });

    // äº‹ä»¶å¤„ç†å™¨: handle_onclick_1
    document.addEventListener('DOMContentLoaded', function() {
        const element = document.querySelector('.btn');
        if (element) {
            element.addEventListener('click', function(e) {
                showStatusTransitionModal(
            });
        }
    });

</script>

    <div class="modal fade" id="signModal" tabindex="-1" aria-labelledby="signModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'contract_pages:contract_status_transition' contract.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="target_status" id="sign_target_status_input">
                    <div class="modal-header">
                        <h5 class="modal-title" id="signModalLabel">åˆåŒç­¾ç« </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">å½“å‰çŠ¶æ€</label>
                            <input type="text" class="form-control" value="{{ contract.get_status_display }}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç­¾ç« æ“ä½œ</label>
                            <input type="text" class="form-control" id="sign_target_status_display" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç­¾ç« è¯´æ˜ <span class="text-muted">(å¯é€‰)</span></label>
                            <textarea class="form-control" name="comment" rows="3" placeholder="è¯·è¾“å…¥ç­¾ç« è¯´æ˜ï¼Œä¾‹å¦‚ï¼šå·²å®Œæˆæˆ‘æ–¹ç­¾ç« ï¼Œç­‰å¾…å¯¹æ–¹ç­¾ç« "></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>æç¤ºï¼š</strong>ç­¾ç« æ“ä½œå°†è®°å½•ç­¾ç« äººå’Œç­¾ç« æ—¶é—´ï¼Œè¯·ç¡®è®¤åå†æäº¤ã€‚
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-success">ç¡®è®¤ç­¾ç« </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="info-card">
        <h5>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h5>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">åˆåŒç¼–å·</span>
                <span class="info-value">{{ contract.contract_number }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">åˆåŒåç§°</span>
                <span class="info-value">{{ contract.contract_name|default:contract.contract_number }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">åˆåŒç±»å‹</span>
                <span class="info-value">{{ contract.get_contract_type_display }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">åˆåŒçŠ¶æ€</span>
                <span class="info-value"><span class="status-badge {{ contract.status }}">{{ contract.get_status_display }}</span></span>
            </div>
            <div class="info-item">
                <span class="info-label">å®¢æˆ·</span>
                <span class="info-value">{{ contract.client.name|default:"æœªæŒ‡å®š" }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å…³è”é¡¹ç›®</span>
                <span class="info-value">{{ contract.project.project_number|default:"æœªå…³è”" }} {{ contract.project.name|default:"" }}</span>
            </div>
            {% if contract.parent_contract %}
            <div class="info-item">
                <span class="info-label">ä¸»åˆåŒ</span>
                <span class="info-value"><a href="{% url 'contract_pages:contract_detail' contract.parent_contract.id %}">{{ contract.parent_contract.contract_number }}</a></span>
            </div>
            {% endif %}
        </div>
        {% if contract.description %}
        <div class="mt-3">
            <span class="info-label">åˆåŒæè¿°</span>
            <p class="mt-2" style="color: #374151; font-size: 14px;">{{ contract.description }}</p>
        </div>
        {% endif %}
    </div>

    <div class="info-card" style="border: 2px solid #059669; background-color: #f0fdf4;">
        <h5>ğŸ¯ å•†æœºä¿¡æ¯</h5>
        {% if contract.opportunity %}
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">å…³è”å•†æœº</span>
                <span class="info-value"><a href="{% url 'opportunity_pages:opportunity_detail' contract.opportunity.id %}">{{ contract.opportunity.opportunity_number|default:contract.opportunity.name }}</a> - {{ contract.opportunity.name }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å•†æœºç¼–å·</span>
                <span class="info-value">{{ contract.opportunity.opportunity_number|default:"æœªç¼–å·" }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å•†æœºåç§°</span>
                <span class="info-value">{{ contract.opportunity.name }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å•†æœºçŠ¶æ€</span>
                <span class="info-value">
                    <span class="status-badge {% if contract.opportunity.status == 'won' %}completed{% elif contract.opportunity.status == 'lost' %}terminated{% elif contract.opportunity.status == 'cancelled' %}cancelled{% else %}pending_review{% endif %}">
                        {{ contract.opportunity.get_status_display }}
                    </span>
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">è´Ÿè´£å•†åŠ¡</span>
                <span class="info-value">{{ contract.opportunity.business_manager.get_full_name|default:contract.opportunity.business_manager.username }}</span>
            </div>
            {% if contract.opportunity.project_name %}
            <div class="info-item">
                <span class="info-label">é¡¹ç›®åç§°</span>
                <span class="info-value">{{ contract.opportunity.project_name }}</span>
            </div>
            {% endif %}
            {% if contract.opportunity.project_address %}
            <div class="info-item">
                <span class="info-label">é¡¹ç›®åœ°å€</span>
                <span class="info-value">{{ contract.opportunity.project_address }}</span>
            </div>
            {% endif %}
            {% if contract.opportunity.estimated_amount %}
            <div class="info-item">
                <span class="info-label">é¢„è®¡é‡‘é¢</span>
                <span class="info-value">Â¥{{ contract.opportunity.estimated_amount|floatformat:2 }} ä¸‡å…ƒ</span>
            </div>
            {% endif %}
            {% if contract.opportunity.success_probability %}
            <div class="info-item">
                <span class="info-label">æˆåŠŸæ¦‚ç‡</span>
                <span class="info-value">{{ contract.opportunity.success_probability }}%</span>
            </div>
            {% endif %}
            {% if contract.opportunity.weighted_amount %}
            <div class="info-item">
                <span class="info-label">åŠ æƒé‡‘é¢</span>
                <span class="info-value" style="color: #059669;">Â¥{{ contract.opportunity.weighted_amount|floatformat:2 }} ä¸‡å…ƒ</span>
            </div>
            {% endif %}
            {% if contract.opportunity.expected_sign_date %}
            <div class="info-item">
                <span class="info-label">é¢„è®¡ç­¾çº¦æ—¶é—´</span>
                <span class="info-value">{{ contract.opportunity.expected_sign_date|date:"Y-m-d" }}</span>
            </div>
            {% endif %}
            {% if contract.opportunity.actual_sign_date %}
            <div class="info-item">
                <span class="info-label">å®é™…ç­¾çº¦æ—¥æœŸ</span>
                <span class="info-value">{{ contract.opportunity.actual_sign_date|date:"Y-m-d" }}</span>
            </div>
            {% endif %}
            {% if contract.opportunity.urgency %}
            <div class="info-item">
                <span class="info-label">ç´§æ€¥ç¨‹åº¦</span>
                <span class="info-value">
                    {% if contract.opportunity.urgency == 'very_urgent' %}
                        <span style="color: #dc2626; font-weight: 600;">ç‰¹æ€¥</span>
                    {% elif contract.opportunity.urgency == 'urgent' %}
                        <span style="color: #f59e0b; font-weight: 600;">ç´§æ€¥</span>
                    {% else %}
                        æ™®é€š
                    {% endif %}
                </span>
            </div>
            {% endif %}
        </div>
        {% if contract.opportunity.description %}
        <div class="mt-3">
            <span class="info-label">å•†æœºæè¿°</span>
            <p class="mt-2" style="color: #374151; font-size: 14px;">{{ contract.opportunity.description|linebreaks }}</p>
        </div>
        {% endif %}
        <div class="mt-3">
            <a href="{% url 'opportunity_pages:opportunity_detail' contract.opportunity.id %}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-eye"></i> æŸ¥çœ‹å•†æœºè¯¦æƒ…
            </a>
        </div>
        {% else %}
        <div class="empty-state">
            <p style="color: #6b7280; margin: 20px 0;">æœªå…³è”å•†æœº</p>
        </div>
        {% endif %}
    </div>

    {% if contract.contract_amount %}
    <div class="info-card">
        <h5>ğŸ’° é‡‘é¢ä¿¡æ¯</h5>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">åˆåŒé‡‘é¢ï¼ˆå«ç¨ï¼‰</span>
                <span class="info-value" style="font-size: 18px; color: #059669; font-weight: 700;">Â¥{{ contract.contract_amount|floatformat:2 }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">åˆåŒé‡‘é¢ï¼ˆä¸å«ç¨ï¼‰</span>
                <span class="info-value">Â¥{{ contract.contract_amount_excl_tax|default:"0.00"|floatformat:2 }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç¨é¢</span>
                <span class="info-value">Â¥{{ contract.contract_amount_tax|default:"0.00"|floatformat:2 }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç¨ç‡</span>
                <span class="info-value">{{ contract.tax_rate|default:"0.00"|floatformat:2 }}%</span>
            </div>
            <div class="info-item">
                <span class="info-label">å·²ç»“ç®—é‡‘é¢</span>
                <span class="info-value">Â¥{{ contract.settlement_amount|default:"0.00"|floatformat:2 }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">å·²å›æ¬¾é‡‘é¢</span>
                <span class="info-value" style="color: #059669;">Â¥{{ contract.payment_amount|default:"0.00"|floatformat:2 }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">æœªå›æ¬¾é‡‘é¢</span>
                <span class="info-value" style="color: #dc2626;">Â¥{{ contract.unpaid_amount|default:"0.00"|floatformat:2 }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="info-card">
        <h5>ğŸ“… æ—¶é—´ä¿¡æ¯</h5>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">åˆåŒç­¾è®¢æ—¥æœŸ</span>
                <span class="info-value">{{ contract.contract_date|default:"æœªè®¾ç½®"|date:"Y-m-d" }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">åˆåŒç”Ÿæ•ˆæ—¥æœŸ</span>
                <span class="info-value">{{ contract.effective_date|default:"æœªè®¾ç½®"|date:"Y-m-d" }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">åˆåŒå¼€å§‹æ—¥æœŸ</span>
                <span class="info-value">{{ contract.start_date|default:"æœªè®¾ç½®"|date:"Y-m-d" }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">åˆåŒç»“æŸæ—¥æœŸ</span>
                <span class="info-value">{{ contract.end_date|default:"æœªè®¾ç½®"|date:"Y-m-d" }}</span>
            </div>
            {% if contract.contract_period %}
            <div class="info-item">
                <span class="info-label">åˆåŒæœŸé™</span>
                <span class="info-value">{{ contract.contract_period }} å¤©</span>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="info-card">
        <h5>ğŸ‘¥ ç­¾çº¦ä¸»ä½“</h5>
        {% if contract.parties.exists %}
            {% for party in contract.parties.all %}
            <div class="card mb-3">
                <div class="card-header">
                    <strong>{{ party.get_party_type_display }}</strong>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item">
                                <span class="info-label">ä¸»ä½“åç§°</span>
                                <span class="info-value">{{ party.party_name|default:"æœªè®¾ç½®" }}</span>
                            </div>
                        </div>
                        {% if party.credit_code %}
                        <div class="col-md-6">
                            <div class="info-item">
                                <span class="info-label">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </span>
                                <span class="info-value">{{ party.credit_code }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% if party.legal_representative %}
                        <div class="col-md-6">
                            <div class="info-item">
                                <span class="info-label">æ³•å®šä»£è¡¨äºº</span>
                                <span class="info-value">{{ party.legal_representative }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% if party.party_contact %}
                        <div class="col-md-6">
                            <div class="info-item">
                                <span class="info-label">ç­¾çº¦ä¸»ä½“ä»£è¡¨</span>
                                <span class="info-value">{{ party.party_contact }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% if party.contact_phone %}
                        <div class="col-md-6">
                            <div class="info-item">
                                <span class="info-label">è”ç³»ç”µè¯</span>
                                <span class="info-value">{{ party.contact_phone }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% if party.contact_email %}
                        <div class="col-md-6">
                            <div class="info-item">
                                <span class="info-label">è”ç³»é‚®ç®±</span>
                                <span class="info-value">{{ party.contact_email }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% if party.address %}
                        <div class="col-md-12">
                            <div class="info-item">
                                <span class="info-label">åŠå…¬åœ°å€</span>
                                <span class="info-value">{{ party.address }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">ç”²æ–¹åç§°</span>
                    <span class="info-value">{{ contract.party_a_name|default:"æœªè®¾ç½®" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ç”²æ–¹è”ç³»äºº</span>
                    <span class="info-value">{{ contract.party_a_contact|default:"æœªè®¾ç½®" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ä¹™æ–¹åç§°</span>
                    <span class="info-value">{{ contract.party_b_name|default:"å››å·ç»´æµ·ç§‘æŠ€æœ‰é™å…¬å¸" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ä¹™æ–¹è”ç³»äºº</span>
                    <span class="info-value">{{ contract.party_b_contact|default:"æœªè®¾ç½®" }}</span>
                </div>
            </div>
        {% endif %}
    </div>

    <div class="info-card">
        <h5>ğŸ’³ å›æ¬¾è®¡åˆ’ ({{ payment_plans.count }})</h5>
        {% if payment_plans %}
        <div style="margin-bottom: 12px;">
            {% for plan in payment_plans %}
            <a href="{% url 'settlement_pages:payment_record_create' 'business' plan.id %}" class="btn btn-sm btn-outline-primary me-2" style="margin-bottom: 4px;">ä¸º"{{ plan.phase_name }}"æ·»åŠ å›æ¬¾è®°å½•</a>
            {% endfor %}
        </div>
        {% endif %}
        {% if payment_plans %}
        {% for plan in payment_plans %}
        <div class="payment-plan-item">
            <div>
                <strong>{{ plan.phase_name }}</strong>
                <p class="mb-0 mt-1" style="font-size: 13px; color: #6b7280;">{{ plan.phase_description|default:"æ— æè¿°" }}</p>
                <p class="mb-0 mt-1" style="font-size: 12px; color: #9ca3af;">è®¡åˆ’æ—¥æœŸï¼š{{ plan.planned_date|date:"Y-m-d" }} | çŠ¶æ€ï¼š<span class="status-badge {{ plan.status }}">{{ plan.get_status_display }}</span></p>
                {% comment %}æ˜¾ç¤ºè¯¥å›æ¬¾è®¡åˆ’çš„å›æ¬¾è®°å½•ç»Ÿè®¡{% endcomment %}
                {% with plan_records=payment_records|default_if_none:"" %}
                {% if plan_records %}
                    {% for record in plan_records %}
                        {% if record.payment_plan_id == plan.id %}
                            <p class="mb-0 mt-1" style="font-size: 12px; color: #059669;">âœ“ å·²å›æ¬¾ï¼šÂ¥{{ record.payment_amount|floatformat:2 }} ({{ record.payment_date|date:"Y-m-d" }})</p>
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {% endwith %}
            </div>
            <div class="text-end">
                <div style="font-size: 18px; font-weight: 700; color: #059669;">Â¥{{ plan.planned_amount|floatformat:2 }}</div>
                {% if plan.actual_amount %}
                <div style="font-size: 14px; color: #6b7280;">å®é™…ï¼šÂ¥{{ plan.actual_amount|floatformat:2 }}</div>
                {% endif %}
                <div style="margin-top: 8px;">
                    <a href="{% url 'settlement_pages:payment_record_create' 'business' plan.id %}" class="btn btn-sm btn-primary me-1">æ·»åŠ å›æ¬¾</a>
                    <a href="{% url 'admin:customer_management_businesspaymentplan_change' plan.id %}" class="btn btn-sm btn-outline-secondary" target="_blank">ç¼–è¾‘</a>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <p>æš‚æ— å›æ¬¾è®¡åˆ’</p>
            <a href="{% url 'admin:customer_management_businesspaymentplan_add' %}?contract={{ contract.id }}" class="btn btn-primary" target="_blank">æ·»åŠ å›æ¬¾è®¡åˆ’</a>
        </div>
        {% endif %}
    </div>

    <div class="info-card">
        <h5>ğŸ’° å›æ¬¾è®°å½• ({{ payment_records|length }})</h5>
        {% if payment_plans %}
        <div style="margin-bottom: 12px;">
            {% for plan in payment_plans %}
            <a href="{% url 'settlement_pages:payment_record_create' 'business' plan.id %}" class="btn btn-sm btn-outline-primary me-2" style="margin-bottom: 4px;">ä¸º"{{ plan.phase_name }}"æ·»åŠ å›æ¬¾è®°å½•</a>
            {% endfor %}
        </div>
        {% endif %}
        {% if payment_records %}
        {% for record in payment_records %}
        <div class="payment-plan-item">
            <div>
                <strong>{{ record.payment_number }}</strong>
                <p class="mb-0 mt-1" style="font-size: 13px; color: #6b7280;">å›æ¬¾æ—¥æœŸï¼š{{ record.payment_date|date:"Y-m-d" }} | å›æ¬¾æ–¹å¼ï¼š{{ record.get_payment_method_display }} | çŠ¶æ€ï¼š<span class="status-badge {{ record.status }}">{{ record.get_status_display }}</span></p>
                {% if record.invoice_number %}
                <p class="mb-0 mt-1" style="font-size: 12px; color: #9ca3af;">å‘ç¥¨å·ç ï¼š{{ record.invoice_number }}</p>
                {% endif %}
                {% if record.bank_account %}
                <p class="mb-0 mt-1" style="font-size: 12px; color: #9ca3af;">æ”¶æ¬¾è´¦æˆ·ï¼š{{ record.bank_account }}</p>
                {% endif %}
                {% if record.notes %}
                <p class="mb-0 mt-1" style="font-size: 12px; color: #9ca3af;">å¤‡æ³¨ï¼š{{ record.notes }}</p>
                {% endif %}
                {% if record.confirmed_by %}
                <p class="mb-0 mt-1" style="font-size: 12px; color: #9ca3af;">ç¡®è®¤äººï¼š{{ record.confirmed_by.get_full_name|default:record.confirmed_by.username }} | ç¡®è®¤æ—¶é—´ï¼š{{ record.confirmed_time|date:"Y-m-d H:i" }}</p>
                {% endif %}
            </div>
            <div class="text-end">
                <div style="font-size: 18px; font-weight: 700; color: #059669;">Â¥{{ record.payment_amount|floatformat:2 }}</div>
                {% if record.receipt_voucher %}
                <a href="{{ record.receipt_voucher.url }}" class="btn btn-sm btn-outline-primary mt-2" target="_blank">æŸ¥çœ‹å‡­è¯</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <p>æš‚æ— å›æ¬¾è®°å½•</p>
            {% if payment_plans %}
            <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">è¯·å…ˆåˆ›å»ºå›æ¬¾è®¡åˆ’ï¼Œç„¶åæ·»åŠ å›æ¬¾è®°å½•</p>
            {% else %}
            <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">è¯·å…ˆåˆ›å»ºå›æ¬¾è®¡åˆ’</p>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="info-card">
        <h5>ğŸ“ åˆåŒæ–‡ä»¶ ({{ files.count }})</h5>
        {% if files %}
        {% for file in files %}
        <div class="file-item">
            <div>
                <strong>{{ file.file_name }}</strong>
                <p class="mb-0 mt-1" style="font-size: 13px; color: #6b7280;">{{ file.get_file_type_display }} | ç‰ˆæœ¬ï¼š{{ file.version }} | ä¸Šä¼ æ—¶é—´ï¼š{{ file.uploaded_time|date:"Y-m-d H:i" }}</p>
                {% if file.description %}
                <p class="mb-0 mt-1" style="font-size: 12px; color: #9ca3af;">{{ file.description }}</p>
                {% endif %}
            </div>
            <div>
                <a href="{% url 'contract_pages:contract_file_download' file.id %}" class="btn btn-sm btn-primary">ä¸‹è½½</a>
                {% if can_manage %}
                <form method="post" action="{% url 'contract_pages:contract_file_delete' file.id %}" style="display: inline;" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ {{ file.file_name }} å—ï¼Ÿ');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">åˆ é™¤</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <p>æš‚æ— åˆåŒæ–‡ä»¶</p>
            <a href="{% url 'contract_pages:contract_file_upload' contract.id %}" class="btn btn-primary">ä¸Šä¼ æ–‡ä»¶</a>
        </div>
        {% endif %}
    </div>

    {% if approvals %}
    <div class="info-card">
        <h5>âœ… å®¡æ ¸è®°å½• ({{ approvals.count }})</h5>
        {% for approval in approvals %}
        <div class="payment-plan-item">
            <div>
                <strong>{{ approval.approver.get_full_name|default:approval.approver.username }}</strong>
                <p class="mb-0 mt-1" style="font-size: 13px; color: #6b7280;">å®¡æ ¸å±‚çº§ï¼š{{ approval.approval_level }}çº§ | å®¡æ ¸æ—¶é—´ï¼š{{ approval.approval_time|date:"Y-m-d H:i"|default:"å¾…å®¡æ ¸" }}</p>
                {% if approval.comment %}
                <p class="mb-0 mt-1" style="font-size: 12px; color: #9ca3af;">å®¡æ ¸æ„è§ï¼š{{ approval.comment }}</p>
                {% endif %}
            </div>
            <div>
                <span class="status-badge {{ approval.result }}">{{ approval.get_result_display }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if changes %}
    <div class="info-card">
        <h5>ğŸ“ å˜æ›´è®°å½• ({{ changes.count }})</h5>
        {% for change in changes %}
        <div class="payment-plan-item">
            <div>
                <strong>{{ change.get_change_type_display }}</strong>
                <p class="mb-0 mt-1" style="font-size: 13px; color: #6b7280;">å˜æ›´æ—¥æœŸï¼š{{ change.change_date|date:"Y-m-d" }} | åˆ›å»ºäººï¼š{{ change.created_by.get_full_name|default:change.created_by.username }}</p>
                <p class="mb-0 mt-1" style="font-size: 12px; color: #374151;">å˜æ›´åŸå› ï¼š{{ change.change_reason }}</p>
                {% if change.change_amount %}
                <p class="mb-0 mt-1" style="font-size: 14px; font-weight: 600; color: #dc2626;">å˜æ›´é‡‘é¢ï¼šÂ¥{{ change.change_amount|floatformat:2 }}</p>
                {% endif %}
                {% if change.notes %}
                <p class="mb-0 mt-1" style="font-size: 12px; color: #9ca3af;">å¤‡æ³¨ï¼š{{ change.notes }}</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if status_logs %}
    <div class="info-card">
        <h5>ğŸ”„ çŠ¶æ€æµè½¬å†å² ({{ status_logs|length }})</h5>
        {% for log in status_logs %}
        <div class="payment-plan-item">
            <div>
                <strong>{{ log.from_status_label }} â†’ {{ log.to_status_label }}</strong>
                <p class="mb-0 mt-1" style="font-size: 13px; color: #6b7280;">
                    æ“ä½œäººï¼š{{ log.actor.get_full_name|default:log.actor.username|default:"ç³»ç»Ÿ" }} | 
                    æ“ä½œæ—¶é—´ï¼š{{ log.created_time|date:"Y-m-d H:i:s" }}
                </p>
                {% if log.comment %}
                <p class="mb-0 mt-1" style="font-size: 12px; color: #9ca3af;">å¤‡æ³¨ï¼š{{ log.comment }}</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if sub_contracts %}
    <div class="info-card">
        <h5>ğŸ“„ å­åˆåŒ/è¡¥å……åè®® ({{ sub_contracts.count }})</h5>
        {% for sub in sub_contracts %}
        <div class="payment-plan-item">
            <div>
                <strong><a href="{% url 'contract_pages:contract_detail' sub.id %}">{{ sub.contract_number }}</a></strong>
                <p class="mb-0 mt-1" style="font-size: 13px; color: #6b7280;">{{ sub.contract_name|default:sub.contract_number }} | {{ sub.get_contract_type_display }} | <span class="status-badge {{ sub.status }}">{{ sub.get_status_display }}</span></p>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if contract.notes %}
    <div class="info-card">
        <h5>ğŸ“ å¤‡æ³¨ä¿¡æ¯</h5>
        <p style="color: #374151; font-size: 14px; line-height: 1.6;">{{ contract.notes|linebreaks }}</p>
    </div>
    {% endif %}

    <div class="info-card">
        <h5>ğŸ” å®¡è®¡ä¿¡æ¯</h5>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">åˆ›å»ºäºº</span>
                <span class="info-value">{{ contract.created_by.get_full_name|default:contract.created_by.username|default:"æœªè®¾ç½®" }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">åˆ›å»ºæ—¶é—´</span>
                <span class="info-value">{{ contract.created_time|date:"Y-m-d H:i:s" }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ›´æ–°æ—¶é—´</span>
                <span class="info-value">{{ contract.updated_time|date:"Y-m-d H:i:s" }}</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}
