{% extends "shared/list_page_base.html" %}
{% load static %}





{% block list_table_rows %}
{% for project in projects %}
      <tr>
        <td><code>{{ project.project_number|default:"-" }}</code></td>
        <td>
          <a href="{% url 'production_pages:project_detail' project.id %}">
            {{ project.name }}
          </a>
        </td>
        <td>{{ project.client_company_name|default:"-" }}</td>
        <td>{% if project.service_type %}{{ project.service_type.name }}{% else %}-{% endif %}</td>
        <td>{% if project.project_manager %}{{ project.project_manager.get_full_name|default:project.project_manager.username }}{% else %}-{% endif %}</td>
        <td>
          {% if project.status == 'draft' %}
            <span class="list-badge list-badge-draft">草稿</span>
          {% elif project.status == 'in_progress' %}
            <span class="list-badge list-badge-in_progress">进行中</span>
          {% elif project.status == 'completed' %}
            <span class="list-badge list-badge-completed">已完成</span>
          {% elif project.status == 'archived' %}
            <span class="list-badge list-badge-archived">已归档</span>
          {% else %}
            <span class="list-badge">{{ project.get_status_display }}</span>
          {% endif %}
        </td>
        <td>{{ project.created_time|date:"Y-m-d" }}</td>
        <td>
          <div class="list-actions">
            <a href="{% url 'production_pages:project_detail' project.id %}" class="list-btn" title="查看">查看</a>
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="8" class="list-empty">
          <div class="list-empty-icon">▢</div>
          <div class="list-empty-text">暂无项目数据</div>
          <div class="list-empty-hint">请创建第一个项目开始使用</div>
        </td>
      </tr>
      {% endfor %}
{% endblock list_table_rows %}
{% block list_table_headers %}
<th>项目编号</th>
<th>项目名称</th>
<th>客户名称</th>
<th>服务类型</th>
<th>项目负责人</th>
<th>状态</th>
<th>创建时间</th>
<th>操作</th>
{% endblock list_table_headers %}
{% block list_page_title %}项目总览 - 维海科技信息化管理平台{% endblock list_page_title %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">项目总览</li>
{% endblock breadcrumb_items %}



{% block extra_js %}

<form style="display:none">{% csrf_token %}</form>
<script>
// quick keyword & status filter
try { console.debug('[query] script loaded'); } catch(e){}
const keywordInput = document.getElementById('keywordQuick');
const statusSelect = document.getElementById('statusQuick');
const table = document.getElementById('resultTable');
const tbody = table.querySelector('tbody');
const rows = Array.from(tbody.querySelectorAll('tr'));
let statusFilter = statusSelect?.value || '';
let sortState = { idx: -1, dir: 1 };

function textOf(row){
    return (row.querySelector('.pn')?.textContent || '') + ' ' +
           (row.querySelector('.pname')?.textContent || '') + ' ' +
           (row.querySelector('.client')?.textContent || '') + ' ' +
           (row.querySelector('.pm')?.textContent || '');
}

function applyFilters(){
    const kw = (keywordInput?.value || '').trim().toLowerCase();
    try { console.debug('[query] kw=', kw, 'status=', statusFilter); } catch(e){}
    let visible = 0;
    rows.forEach(row=>{
        const hitKw = kw ? textOf(row).toLowerCase().includes(kw) : true;
        const hitStatus = !statusFilter || row.dataset.status === statusFilter;
        const show = hitKw && hitStatus;
        row.hidden = !show;
        if(show) visible++;
    });
    document.getElementById('resultTotal').textContent = visible;
    paginate();
}
keywordInput?.addEventListener('input', applyFilters);
statusSelect?.addEventListener('change', () => {
    statusFilter = statusSelect.value || '';
    applyFilters();
});
statusSelect?.addEventListener('input', () => {
    statusFilter = statusSelect.value || '';
    applyFilters();
});

// sorting
document.querySelectorAll('#resultTable thead th.sortable').forEach((th,idx)=>{
    th.style.cursor='pointer';
    th.addEventListener('click', ()=>{
        const type = th.dataset.sort || 'string';
        if(sortState.idx === idx){ sortState.dir *= -1; } else { sortState = { idx: idx, dir: 1 }; }
        const visibleRows = rows.filter(r=>!r.hidden);
        visibleRows.sort((a,b)=>{
            const getVal = (row) => {
                if(type==='date'){
                    return Date.parse(row.querySelector('.ctime')?.dataset.timestamp || '') || 0;
                }
                if(type==='status'){
                    return row.dataset.status || '';
                }
                return (row.cells[idx]?.textContent || '').trim();
            };
            const va = getVal(a), vb = getVal(b);
            if(va===vb) return 0;
            return va > vb ? sortState.dir : -sortState.dir;
        });
        visibleRows.forEach(r=>tbody.appendChild(r));
    });
});

// simple client-side pagination
const pager = document.getElementById('pager');
const pageSizeSel = document.getElementById('pageSize');
let pageSize = parseInt(pageSizeSel?.value || '20',10);
let currentPage = 1;

function paginate(){
    pageSize = parseInt(pageSizeSel?.value || '20',10);
    const visible = rows.filter(r=>!r.hidden);
    const total = visible.length;
    const pages = Math.max(1, Math.ceil(total / pageSize));
    currentPage = Math.min(currentPage, pages);
    visible.forEach((r,i)=>{ r.style.display = (i >= (currentPage-1)*pageSize && i < currentPage*pageSize) ? '' : 'none'; });
    // render pager
    pager.innerHTML = '';
    const addItem = (p, label, active=false) => {
        const li = document.createElement('li'); li.className = 'page-item' + (active?' active':'');
        const a = document.createElement('a'); a.className='page-link'; a.href='#'; a.textContent=label;
        a.addEventListener('click', (e)=>{ e.preventDefault(); currentPage = p; paginate(); });
        li.appendChild(a); pager.appendChild(li);
    };
    addItem(Math.max(1, currentPage-1), '«');
    for(let p=1;p<=pages;p++){ addItem(p, String(p), p===currentPage); }
    addItem(Math.min(pages, currentPage+1), '»');
}
pageSizeSel?.addEventListener('change', ()=>{ currentPage=1; paginate(); });

// init
applyFilters();
</script>
{% endblock extra_js %}
