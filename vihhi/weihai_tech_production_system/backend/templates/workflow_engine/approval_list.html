{% extends "shared/list_page_base.html" %}
{% load static %}

{% block list_page_title %}æˆ‘çš„å®¡æ‰¹{% endblock %}

{% block list_page_extra_css %}
<style>
    .approval-status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .badge-pending {
        background: #fff3cd;
        color: #856404;
    }
    .badge-approved {
        background: #d4edda;
        color: #155724;
    }
    .badge-rejected {
        background: #f8d7da;
        color: #721c24;
    }
    .badge-withdrawn {
        background: #e2e3e5;
        color: #383d41;
    }
</style>
{% endblock %}

{% block list_page_tabs %}
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link {% if not tab or tab == 'pending' %}active{% endif %}" href="?tab=pending">
            å¾…æˆ‘å®¡æ‰¹ 
            {% if pending_approvals %}
            <span class="badge bg-danger">{{ pending_approvals|length }}</span>
            {% endif %}
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if tab == 'historical' %}active{% endif %}" href="?tab=historical">
            å†å²å®¡æ‰¹
            {% if historical_approvals %}
            <span class="badge bg-secondary">{{ historical_approvals|length }}</span>
            {% endif %}
        </a>
    </li>
</ul>
{% endblock %}

{% block list_page_actions %}
<a href="{% url 'workflow_engine:export_approvals' %}" class="btn btn-outline-primary btn-sm">
    <i class="bi bi-download"></i> å¯¼å‡ºæ•°æ®
</a>
{% endblock %}

{% block list_page_table_checkbox_header %}
{% if not tab or tab == 'pending' %}
<th style="width: 50px;">
    <input type="checkbox" id="selectAll" class="form-check-input" title="å…¨é€‰">
</th>
{% else %}
<th style="width: 50px;"></th>
{% endif %}
{% endblock %}

{% block list_page_table_headers %}
<th style="width: 12%;">å®¡æ‰¹ç¼–å·</th>
<th style="width: 15%;">æµç¨‹åç§°</th>
<th style="width: 10%;">ç”³è¯·äºº</th>
<th style="width: 10%;">ç”³è¯·æ—¶é—´</th>
<th style="width: 8%;">çŠ¶æ€</th>
<th style="width: 12%;">å½“å‰èŠ‚ç‚¹</th>
<th style="width: 15%;">å…³è”å¯¹è±¡</th>
<th style="width: 18%;">æ“ä½œ</th>
{% endblock %}

{% block list_page_table_checkbox_cell %}
{% if not tab or tab == 'pending' %}
<td>
    <input type="checkbox" class="form-check-input row-checkbox" name="instance_ids" value="{{ item.id }}" id="instance_{{ item.id }}">
</td>
{% else %}
<td></td>
{% endif %}
{% endblock %}

{% block list_page_table_row_content %}
{# æ³¨æ„ï¼šæ­¤å—åœ¨ list_page_base.html çš„å¾ªç¯å†…éƒ¨ï¼Œitem å˜é‡å·²å¯ç”¨ #}
{% if not tab or tab == 'pending' %}
    {# å¾…æˆ‘å®¡æ‰¹åˆ—è¡¨ #}
    <td><code>{{ item.instance_number }}</code></td>
    <td>
        <strong>{{ item.workflow.name }}</strong>
        {% if item.workflow.category %}
        <br><small class="text-muted">{{ item.workflow.category }}</small>
        {% endif %}
    </td>
    <td>{{ item.applicant.get_full_name|default:item.applicant.username }}</td>
    <td>{{ item.apply_time|date:"Y-m-d H:i"|default:"-" }}</td>
    <td>
        <span class="approval-status-badge badge-pending">å¾…å®¡æ‰¹</span>
    </td>
    <td>
        {% if item.current_node %}
        <span class="badge bg-info">{{ item.current_node.name }}</span>
        {% else %}
        <span class="text-muted">-</span>
        {% endif %}
    </td>
    <td>
        {% if item.content_object %}
            {% if item.content_type.model == 'outgoingdocument' %}
            <div><strong>{{ item.content_object.document_number }}</strong></div>
            <small class="text-muted">{{ item.content_object.title|truncatewords:5 }}</small>
            {% else %}
            {{ item.content_object }}
            {% endif %}
        {% else %}
        <span class="text-muted">-</span>
        {% endif %}
    </td>
    <td>
        <div class="list-page-table-actions">
            <a href="#" class="action-edit" data-bs-toggle="modal" data-bs-target="#approvalModal{{ item.id }}" onclick="loadApprovalModal({{ item.id }}); return false;" title="ç«‹å³å®¡æ‰¹">
                <i class="bi bi-check-circle"></i>
            </a>
            <span class="action-separator">|</span>
            <a href="{% url 'workflow_engine:approval_detail' item.id %}" class="action-view" title="æŸ¥çœ‹è¯¦æƒ…">
                <i class="bi bi-eye"></i>
            </a>
        </div>
    </td>
{% elif tab == 'historical' %}
    {# å†å²å®¡æ‰¹åˆ—è¡¨ #}
    <td><code>{{ item.instance_number }}</code></td>
    <td>
        <strong>{{ item.workflow.name }}</strong>
        {% if item.workflow.category %}
        <br><small class="text-muted">{{ item.workflow.category }}</small>
        {% endif %}
    </td>
    <td>{{ item.applicant.get_full_name|default:item.applicant.username }}</td>
    <td>{{ item.apply_time|date:"Y-m-d H:i"|default:"-" }}</td>
    <td>
        {% if item.status == 'approved' %}
            <span class="approval-status-badge badge-approved">å·²é€šè¿‡</span>
        {% elif item.status == 'rejected' %}
            <span class="approval-status-badge badge-rejected">å·²é©³å›</span>
        {% elif item.status == 'withdrawn' %}
            <span class="approval-status-badge badge-withdrawn">å·²æ’¤å›</span>
        {% else %}
            <span class="badge bg-secondary">{{ item.get_status_display }}</span>
        {% endif %}
    </td>
    <td>
        {% if item.current_node %}
        <span class="badge bg-info">{{ item.current_node.name }}</span>
        {% else %}
        <span class="text-muted">-</span>
        {% endif %}
    </td>
    <td>
        {% if item.content_object %}
            {% if item.content_type.model == 'outgoingdocument' %}
            <div><strong>{{ item.content_object.document_number }}</strong></div>
            <small class="text-muted">{{ item.content_object.title|truncatewords:5 }}</small>
            {% else %}
            {{ item.content_object }}
            {% endif %}
        {% else %}
        <span class="text-muted">-</span>
        {% endif %}
    </td>
    <td>
        <div class="list-page-table-actions">
            <a href="{% url 'workflow_engine:approval_detail' item.id %}" class="action-view" title="æŸ¥çœ‹è¯¦æƒ…">
                <i class="bi bi-eye"></i>
            </a>
        </div>
    </td>
{% endif %}
{% endblock %}

{% block empty_table_message %}
{% if not tab or tab == 'pending' %}
<i class="bi bi-inbox" style="font-size: 2rem;"></i>
<p class="mt-2">æš‚æ— å¾…å®¡æ‰¹äº‹é¡¹</p>
<p class="text-muted" style="font-size: 0.9rem;">
    ğŸ’¡ æç¤ºï¼šå¦‚æœæ‚¨åˆšåˆšå®Œæˆäº†å®¡æ‰¹ï¼Œå®¡æ‰¹äº‹é¡¹å¯èƒ½å·²è¿›å…¥ä¸‹ä¸€èŠ‚ç‚¹æˆ–å·²å®Œæˆã€‚<br>
    æ‚¨å¯ä»¥åœ¨"å†å²å®¡æ‰¹"æ ‡ç­¾ä¸­æŸ¥çœ‹æ‰€æœ‰å·²å®¡æ‰¹çš„è®°å½•ã€‚
</p>
{% elif tab == 'historical' %}
<i class="bi bi-inbox" style="font-size: 2rem;"></i>
<p class="mt-2">æš‚æ— å†å²å®¡æ‰¹è®°å½•</p>
<p class="text-muted" style="font-size: 0.9rem;">
    æ‚¨å®¡æ‰¹è¿‡çš„è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
</p>
{% else %}
æš‚æ— æ•°æ®
{% endif %}
{% endblock %}

{% block empty_colspan %}9{% endblock %}

{% block list_page_batch_actions %}
{% if not tab or tab == 'pending' %}
{% if pending_approvals %}
<form id="batchApproveForm" method="post" action="{% url 'workflow_engine:batch_approve' %}">
    {% csrf_token %}
    {% include "shared/batch_actions_bar.html" %}
</form>
{% endif %}
{% endif %}
{% endblock %}

{% block list_page_batch_actions_custom_buttons %}
{% if not tab or tab == 'pending' %}
<button type="button" class="btn btn-sm btn-success" id="batchApproveBtn">
    <i class="bi bi-check-circle"></i> æ‰¹é‡é€šè¿‡
</button>
<button type="button" class="btn btn-sm btn-danger" id="batchRejectBtn">
    <i class="bi bi-x-circle"></i> æ‰¹é‡é©³å›
</button>
{% endif %}
{% endblock %}

{% block list_page_custom_js %}
// æ‰¹é‡å®¡æ‰¹åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const batchApproveBtn = document.getElementById('batchApproveBtn');
    const batchRejectBtn = document.getElementById('batchRejectBtn');
    const batchApproveForm = document.getElementById('batchApproveForm');
    
    if (batchApproveBtn && batchApproveForm) {
        batchApproveBtn.addEventListener('click', function() {
            batchApprove('approve');
        });
    }
    
    if (batchRejectBtn && batchApproveForm) {
        batchRejectBtn.addEventListener('click', function() {
            batchApprove('reject');
        });
    }
    
    function batchApprove(action) {
        const form = document.getElementById('batchApproveForm');
        const checked = document.querySelectorAll('.row-checkbox:checked');
        
        if (checked.length === 0) {
            showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå®¡æ‰¹å®ä¾‹');
            return;
        }
        
        if (!confirm(`ç¡®å®šè¦${action === 'approve' ? 'æ‰¹é‡é€šè¿‡' : 'æ‰¹é‡é©³å›'} ${checked.length} ä¸ªå®¡æ‰¹å—ï¼Ÿ`)) {
            return;
        }
        
        // æ·»åŠ æ“ä½œç±»å‹å’Œå®¡æ‰¹æ„è§
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = action;
        form.appendChild(actionInput);
        
        const commentInput = document.createElement('input');
        commentInput.type = 'hidden';
        commentInput.name = 'comment';
        commentInput.value = 'æ‰¹é‡å®¡æ‰¹';
        form.appendChild(commentInput);
        
        form.submit();
    }
});

// åŠ è½½å®¡æ‰¹æ¨¡æ€æ¡†æ•°æ®
function loadApprovalModal(instanceId) {
    // æ¨¡æ€æ¡†å†…å®¹ä¼šåœ¨æ¨¡æ¿ä¸­åŠ¨æ€ç”Ÿæˆï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„é€»è¾‘
    const modal = document.getElementById('approvalModal' + instanceId);
    if (modal) {
        // å¯ä»¥åœ¨è¿™é‡ŒåŠ è½½é¢å¤–çš„æ•°æ®
    }
}
{% endblock %}

{% block modals %}
{{ block.super }}
<!-- å®¡æ‰¹æ¨¡æ€æ¡† -->
{% if not tab or tab == 'pending' %}
{% for instance in page_obj.object_list %}
<div class="modal fade" id="approvalModal{{ instance.id }}" tabindex="-1" aria-labelledby="approvalModalLabel{{ instance.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="approvalModalLabel{{ instance.id }}">
                    <i class="bi bi-check-circle"></i> å®¡æ‰¹æ“ä½œ - {{ instance.workflow.name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'workflow_engine:approval_action' instance.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- å®¡æ‰¹ä¿¡æ¯ -->
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">å®¡æ‰¹ä¿¡æ¯</h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <small class="text-muted">å®¡æ‰¹ç¼–å·ï¼š</small>
                                <div><code>{{ instance.instance_number }}</code></div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">ç”³è¯·äººï¼š</small>
                                <div>{{ instance.applicant.username }}{% if instance.applicant.get_full_name %} ({{ instance.applicant.get_full_name }}){% endif %}</div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">å½“å‰èŠ‚ç‚¹ï¼š</small>
                                <div>{{ instance.current_node.name|default:"-" }}</div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">ç”³è¯·æ—¶é—´ï¼š</small>
                                <div>{{ instance.apply_time|date:"Y-m-d H:i" }}</div>
                            </div>
                        </div>
                    </div>
                    
                    {% if instance.content_object %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">å…³è”å†…å®¹</h6>
                        {% if instance.content_type.model == 'outgoingdocument' %}
                        <div>
                            <small class="text-muted">å‘æ–‡ç¼–å·ï¼š</small>
                            <div class="fw-bold text-primary">{{ instance.content_object.document_number }}</div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">æ ‡é¢˜ï¼š</small>
                            <div>{{ instance.content_object.title }}</div>
                        </div>
                        {% else %}
                        <div>{{ instance.content_object }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if instance.apply_comment %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">ç”³è¯·è¯´æ˜</h6>
                        <div class="p-2 bg-light rounded">{{ instance.apply_comment }}</div>
                    </div>
                    {% endif %}
                    
                    <hr>
                    
                    <!-- å®¡æ‰¹æ“ä½œ -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">å®¡æ‰¹æ„è§ <span class="text-muted">(å¯é€‰)</span></label>
                        <textarea name="comment" class="form-control" rows="4" placeholder="è¯·è¾“å…¥å®¡æ‰¹æ„è§..."></textarea>
                    </div>
                    
                    <input type="hidden" name="redirect_to" value="{% url 'workflow_engine:approval_list' %}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    {% if instance.workflow.allow_reject %}
                    <button type="submit" name="action" value="reject" class="btn btn-danger">
                        <i class="bi bi-x-circle"></i> é©³å›
                    </button>
                    {% endif %}
                    <button type="submit" name="action" value="approve" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> é€šè¿‡
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endif %}
{% endblock %}