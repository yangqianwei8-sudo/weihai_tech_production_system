{% extends "shared/list_page_base.html" %}
{% load static %}

{% block list_page_title %}å®¡æ‰¹å¼•æ“ ----æˆ‘çš„å®¡æ‰¹åˆ—è¡¨{% endblock %}

{% block module_styles %}
  {{ block.super }}
  <style>
    /* å®¡æ‰¹çŠ¶æ€å¾½ç« æ ·å¼ - ä½¿ç”¨ scoped æ ·å¼é¿å…è¦†ç›–é€šç”¨æ ·å¼ */
    .approval-status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .badge-pending {
        background: #fff3cd;
        color: #856404;
    }
    .badge-approved {
        background: #d4edda;
        color: #155724;
    }
    .badge-rejected {
        background: #f8d7da;
        color: #721c24;
    }
    .badge-withdrawn {
        background: #e2e3e5;
        color: #383d41;
    }
    
    /* æ ‡ç­¾é¡µæ ·å¼ */
    .approval-tabs {
        margin-bottom: 16px;
    }
  </style>
{% endblock module_styles %}

{% block list_stats_content %}
  {# ç»Ÿè®¡å¡ç‰‡ - ç›´æ¥æ”¾åœ¨ list-page-stats ä¸­ï¼ŒCSSä¼šè‡ªåŠ¨ä¸€è¡Œæ’åˆ— #}
  <div class="list-stat-card">
    <div class="list-stat-label">å¾…æˆ‘å®¡æ‰¹</div>
    <div class="list-stat-value">{{ pending_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">å†å²å®¡æ‰¹</div>
    <div class="list-stat-value">{{ historical_count|default:0 }}</div>
  </div>
{% endblock list_stats_content %}

{% block list_action_bar_content %}
<div class="list-page-actions-bar">
    <div class="approval-tabs">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link {% if not tab or tab == 'pending' %}active{% endif %}" href="?tab=pending">
                    å¾…æˆ‘å®¡æ‰¹ 
                    {% if pending_count %}
                    <span class="badge bg-danger">{{ pending_count }}</span>
                    {% endif %}
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if tab == 'historical' %}active{% endif %}" href="?tab=historical">
                    å†å²å®¡æ‰¹
                    {% if historical_count %}
                    <span class="badge bg-secondary">{{ historical_count }}</span>
                    {% endif %}
                </a>
            </li>
        </ul>
    </div>
    <div class="list-page-action-buttons">
        <a href="#" class="btn btn-outline-primary btn-sm" onclick="alert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­'); return false;">
            <i class="bi bi-download"></i> å¯¼å‡ºæ•°æ®
        </a>
    </div>
</div>
{% endblock list_action_bar_content %}

{% block list_toolbar_content %}
{% if not tab or tab == 'pending' %}
{% if pending_count > 0 %}
<form id="batchApproveForm" method="post" action="{% url 'workflow_engine:approval_list' %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="action" id="batchAction" value="">
    <div class="list-page-batch-actions">
        <div class="list-page-batch-actions-info">
            <span id="selectedCount">0</span> é¡¹å·²é€‰æ‹©
        </div>
        <div class="list-page-batch-actions-buttons">
            <button type="button" class="btn btn-sm btn-success" id="batchApproveBtn">
                <i class="bi bi-check-circle"></i> æ‰¹é‡é€šè¿‡
            </button>
            <button type="button" class="btn btn-sm btn-danger" id="batchRejectBtn">
                <i class="bi bi-x-circle"></i> æ‰¹é‡é©³å›
            </button>
        </div>
    </div>
</form>
{% endif %}
{% endif %}
{% endblock list_toolbar_content %}

{% block list_filters_content %}
  {# ç­›é€‰å™¨å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ  #}
{% endblock list_filters_content %}

{% block list_table_headers %}
{% if not tab or tab == 'pending' %}
<th style="width: 50px;">
    <input type="checkbox" id="selectAll" class="form-check-input" title="å…¨é€‰">
</th>
{% endif %}
<th style="width: 12%;">å®¡æ‰¹ç¼–å·</th>
<th style="width: 15%;">æµç¨‹åç§°</th>
<th style="width: 10%;">ç”³è¯·äºº</th>
<th style="width: 10%;">ç”³è¯·æ—¶é—´</th>
<th style="width: 8%;">çŠ¶æ€</th>
<th style="width: 12%;">å½“å‰èŠ‚ç‚¹</th>
<th style="width: 15%;">å…³è”å¯¹è±¡</th>
<th style="width: 18%;">æ“ä½œ</th>
{% endblock list_table_headers %}

{% block list_table_rows %}
{% if page_obj %}
    {% for item in page_obj %}
    <tr>
        {% if not tab or tab == 'pending' %}
        <td>
            <input type="checkbox" class="form-check-input row-checkbox" name="instance_ids" value="{{ item.id }}" id="instance_{{ item.id }}">
        </td>
        {% endif %}
        
        {% if not tab or tab == 'pending' %}
            {# å¾…æˆ‘å®¡æ‰¹åˆ—è¡¨ #}
            <td><code>{{ item.instance_number }}</code></td>
            <td>
                <strong>{{ item.workflow.name }}</strong>
                {% if item.workflow.category %}
                <br><small class="text-muted">{{ item.workflow.category }}</small>
                {% endif %}
            </td>
            <td>{{ item.applicant.get_full_name|default:item.applicant.username }}</td>
            <td>{{ item.apply_time|date:"Y-m-d H:i"|default:"-" }}</td>
            <td>
                <span class="approval-status-badge badge-pending">å¾…å®¡æ‰¹</span>
            </td>
            <td>
                {% if item.current_node %}
                <span class="badge bg-info">{{ item.current_node.name }}</span>
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td>
                {% if item.content_object %}
                    {% if item.content_type.model == 'outgoingdocument' %}
                    <div><strong>{{ item.content_object.document_number }}</strong></div>
                    <small class="text-muted">{{ item.content_object.title|truncatewords:5 }}</small>
                    {% else %}
                    {{ item.content_object }}
                    {% endif %}
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td>
                <div class="list-page-table-actions">
                    <a href="#" class="action-edit" data-bs-toggle="modal" data-bs-target="#approvalModal{{ item.id }}" onclick="loadApprovalModal({{ item.id }}); return false;" title="ç«‹å³å®¡æ‰¹">
                        <i class="bi bi-check-circle"></i>
                    </a>
                    <span class="action-separator">|</span>
                    <a href="{% url 'workflow_engine:approval_detail' item.id %}" class="action-view" title="æŸ¥çœ‹è¯¦æƒ…">
                        <i class="bi bi-eye"></i>
                    </a>
                </div>
            </td>
        {% elif tab == 'historical' %}
            {# å†å²å®¡æ‰¹åˆ—è¡¨ #}
            <td><code>{{ item.instance_number }}</code></td>
            <td>
                <strong>{{ item.workflow.name }}</strong>
                {% if item.workflow.category %}
                <br><small class="text-muted">{{ item.workflow.category }}</small>
                {% endif %}
            </td>
            <td>{{ item.applicant.get_full_name|default:item.applicant.username }}</td>
            <td>{{ item.apply_time|date:"Y-m-d H:i"|default:"-" }}</td>
            <td>
                {% if item.status == 'approved' %}
                    <span class="approval-status-badge badge-approved">å·²é€šè¿‡</span>
                {% elif item.status == 'rejected' %}
                    <span class="approval-status-badge badge-rejected">å·²é©³å›</span>
                {% elif item.status == 'withdrawn' %}
                    <span class="approval-status-badge badge-withdrawn">å·²æ’¤å›</span>
                {% else %}
                    <span class="badge bg-secondary">{{ item.get_status_display }}</span>
                {% endif %}
            </td>
            <td>
                {% if item.current_node %}
                <span class="badge bg-info">{{ item.current_node.name }}</span>
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td>
                {% if item.content_object %}
                    {% if item.content_type.model == 'outgoingdocument' %}
                    <div><strong>{{ item.content_object.document_number }}</strong></div>
                    <small class="text-muted">{{ item.content_object.title|truncatewords:5 }}</small>
                    {% else %}
                    {{ item.content_object }}
                    {% endif %}
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td>
                <div class="list-page-table-actions">
                    <a href="{% url 'workflow_engine:approval_detail' item.id %}" class="action-view" title="æŸ¥çœ‹è¯¦æƒ…">
                        <i class="bi bi-eye"></i>
                    </a>
                </div>
            </td>
        {% endif %}
    </tr>
    {% empty %}
    <tr>
        <td colspan="{% if not tab or tab == 'pending' %}9{% else %}8{% endif %}" class="list-empty">
            <div class="list-empty-icon">ğŸ“‹</div>
            <div class="list-empty-text">
                {% if not tab or tab == 'pending' %}
                æš‚æ— å¾…å®¡æ‰¹äº‹é¡¹
                {% elif tab == 'historical' %}
                æš‚æ— å†å²å®¡æ‰¹è®°å½•
                {% else %}
                æš‚æ— æ•°æ®
                {% endif %}
            </div>
            {% block list_empty_hint %}
            {% if not tab or tab == 'pending' %}
            <p class="text-muted" style="font-size: 0.9rem; margin-top: 8px;">
                ğŸ’¡ æç¤ºï¼šå¦‚æœæ‚¨åˆšåˆšå®Œæˆäº†å®¡æ‰¹ï¼Œå®¡æ‰¹äº‹é¡¹å¯èƒ½å·²è¿›å…¥ä¸‹ä¸€èŠ‚ç‚¹æˆ–å·²å®Œæˆã€‚<br>
                æ‚¨å¯ä»¥åœ¨"å†å²å®¡æ‰¹"æ ‡ç­¾ä¸­æŸ¥çœ‹æ‰€æœ‰å·²å®¡æ‰¹çš„è®°å½•ã€‚
            </p>
            {% elif tab == 'historical' %}
            <p class="text-muted" style="font-size: 0.9rem; margin-top: 8px;">
                æ‚¨å®¡æ‰¹è¿‡çš„è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
            </p>
            {% endif %}
            {% endblock list_empty_hint %}
        </td>
    </tr>
    {% endfor %}
{% else %}
    <tr>
        <td colspan="{% if not tab or tab == 'pending' %}9{% else %}8{% endif %}" class="list-empty">
            <div class="list-empty-icon">ğŸ“‹</div>
            <div class="list-empty-text">æš‚æ— æ•°æ®</div>
        </td>
    </tr>
{% endif %}
{% endblock list_table_rows %}

{% block list_pagination_content %}
{{ block.super }}

{# å®¡æ‰¹æ¨¡æ€æ¡† - æ”¾åœ¨åˆ†é¡µä¹‹åï¼Œpm_content å—å†… #}
{% if not tab or tab == 'pending' %}
{% for instance in page_obj %}
<div class="modal fade" id="approvalModal{{ instance.id }}" tabindex="-1" aria-labelledby="approvalModalLabel{{ instance.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="approvalModalLabel{{ instance.id }}">
                    <i class="bi bi-check-circle"></i> å®¡æ‰¹æ“ä½œ - {{ instance.workflow.name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'workflow_engine:approval_action' instance.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- å®¡æ‰¹ä¿¡æ¯ -->
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">å®¡æ‰¹ä¿¡æ¯</h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <small class="text-muted">å®¡æ‰¹ç¼–å·ï¼š</small>
                                <div><code>{{ instance.instance_number }}</code></div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">ç”³è¯·äººï¼š</small>
                                <div>{{ instance.applicant.username }}{% if instance.applicant.get_full_name %} ({{ instance.applicant.get_full_name }}){% endif %}</div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">å½“å‰èŠ‚ç‚¹ï¼š</small>
                                <div>{{ instance.current_node.name|default:"-" }}</div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">ç”³è¯·æ—¶é—´ï¼š</small>
                                <div>{{ instance.apply_time|date:"Y-m-d H:i" }}</div>
                            </div>
                        </div>
                    </div>
                    
                    {% if instance.content_object %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">å…³è”å†…å®¹</h6>
                        {% if instance.content_type.model == 'outgoingdocument' %}
                        <div>
                            <small class="text-muted">å‘æ–‡ç¼–å·ï¼š</small>
                            <div class="fw-bold text-primary">{{ instance.content_object.document_number }}</div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">æ ‡é¢˜ï¼š</small>
                            <div>{{ instance.content_object.title }}</div>
                        </div>
                        {% else %}
                        <div>{{ instance.content_object }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if instance.apply_comment %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">ç”³è¯·è¯´æ˜</h6>
                        <div class="p-2 bg-light rounded">{{ instance.apply_comment }}</div>
                    </div>
                    {% endif %}
                    
                    <hr>
                    
                    <!-- å®¡æ‰¹æ“ä½œ -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">å®¡æ‰¹æ„è§ <span class="text-muted">(å¯é€‰)</span></label>
                        <textarea name="comment" class="form-control" rows="4" placeholder="è¯·è¾“å…¥å®¡æ‰¹æ„è§..."></textarea>
                    </div>
                    
                    <input type="hidden" name="redirect_to" value="{% url 'workflow_engine:approval_list' %}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    {% if instance.workflow.allow_reject %}
                    <button type="submit" name="action" value="reject" class="btn btn-danger">
                        <i class="bi bi-x-circle"></i> é©³å›
                    </button>
                    {% endif %}
                    <button type="submit" name="action" value="approve" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> é€šè¿‡
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endif %}
{% endblock list_pagination_content %}

{% block module_extra_js %}
{{ block.super }}
<script>
// æ‰¹é‡å®¡æ‰¹åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const batchApproveBtn = document.getElementById('batchApproveBtn');
    const batchRejectBtn = document.getElementById('batchRejectBtn');
    const batchApproveForm = document.getElementById('batchApproveForm');
    const selectAllCheckbox = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const selectedCountSpan = document.getElementById('selectedCount');
    
    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            rowCheckboxes.forEach(function(checkbox) {
                checkbox.checked = this.checked;
            }, this);
            updateBatchActions();
        });
    }
    
    // å•ä¸ªå¤é€‰æ¡†å˜åŒ–
    rowCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            updateBatchActions();
            // æ›´æ–°å…¨é€‰çŠ¶æ€
            if (selectAllCheckbox) {
                const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
            }
        });
    });
    
    // æ›´æ–°æ‰¹é‡æ“ä½œæ æ˜¾ç¤º
    function updateBatchActions() {
        const checked = document.querySelectorAll('.row-checkbox:checked');
        if (checked.length > 0 && batchApproveForm) {
            batchApproveForm.style.display = 'block';
            if (selectedCountSpan) {
                selectedCountSpan.textContent = checked.length;
            }
        } else if (batchApproveForm) {
            batchApproveForm.style.display = 'none';
        }
    }
    
    // æ‰¹é‡é€šè¿‡
    if (batchApproveBtn && batchApproveForm) {
        batchApproveBtn.addEventListener('click', function() {
            batchApprove('approve');
        });
    }
    
    // æ‰¹é‡é©³å›
    if (batchRejectBtn && batchApproveForm) {
        batchRejectBtn.addEventListener('click', function() {
            batchApprove('reject');
        });
    }
    
    function batchApprove(action) {
        const checked = document.querySelectorAll('.row-checkbox:checked');
        
        if (checked.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå®¡æ‰¹å®ä¾‹');
            return;
        }
        
        if (!confirm(`ç¡®å®šè¦${action === 'approve' ? 'æ‰¹é‡é€šè¿‡' : 'æ‰¹é‡é©³å›'} ${checked.length} ä¸ªå®¡æ‰¹å—ï¼Ÿ`)) {
            return;
        }
        
        // è®¾ç½®æ“ä½œç±»å‹
        const actionInput = document.getElementById('batchAction');
        if (actionInput) {
            actionInput.value = action;
        }
        
        // æ¸…é™¤ä¹‹å‰æ·»åŠ çš„éšè—inputï¼ˆå¦‚æœæœ‰ï¼‰
        const existingInputs = batchApproveForm.querySelectorAll('input[name="instance_ids"][type="hidden"]');
        existingInputs.forEach(function(input) {
            input.remove();
        });
        
        // æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„å¤é€‰æ¡†å€¼ï¼Œåˆ›å»ºéšè—inputæ·»åŠ åˆ°è¡¨å•ä¸­
        checked.forEach(function(checkbox) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'instance_ids';
            hiddenInput.value = checkbox.value;
            batchApproveForm.appendChild(hiddenInput);
        });
        
        // æäº¤è¡¨å•
        batchApproveForm.submit();
    }
});

// åŠ è½½å®¡æ‰¹æ¨¡æ€æ¡†æ•°æ®
function loadApprovalModal(instanceId) {
    // æ¨¡æ€æ¡†å†…å®¹ä¼šåœ¨æ¨¡æ¿ä¸­åŠ¨æ€ç”Ÿæˆï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„é€»è¾‘
    const modal = document.getElementById('approvalModal' + instanceId);
    if (modal) {
        // å¯ä»¥åœ¨è¿™é‡ŒåŠ è½½é¢å¤–çš„æ•°æ®
    }
}
</script>
{% endblock module_extra_js %}
