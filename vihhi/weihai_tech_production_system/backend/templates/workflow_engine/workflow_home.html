{% extends "shared/module_home_base.html" %}
{% load static %}

{% block module_styles %}
  {{ block.super }}
{% endblock module_styles %}

{% block module_home_core_cards %}
  <!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
  {% if core_cards %}
  <div class="module-home-core-cards">
    {% for card in core_cards %}
    <a href="{{ card.url|default:'#' }}" class="module-home-core-card">
      <div class="module-home-core-card-icon">{{ card.icon|default:'ğŸ“Š' }}</div>
      <div class="module-home-core-card-label">{{ card.label }}</div>
      <div class="module-home-core-card-value">{{ card.value }}</div>
      {% if card.subvalue %}
      <div class="module-home-core-card-subvalue">{{ card.subvalue }}</div>
      {% endif %}
    </a>
    {% endfor %}
  </div>
  {% endif %}
{% endblock module_home_core_cards %}

{% block module_home_stats_row %}
  <!-- çŠ¶æ€åˆ†å¸ƒç»Ÿè®¡ -->
  {% if workflow_status_dist or approval_status_dist %}
  <div class="module-home-stats-row">
    {% if workflow_status_dist %}
    <div class="module-home-stats-card">
      <div class="module-home-stats-card-title">æµç¨‹çŠ¶æ€åˆ†å¸ƒ</div>
      <div class="module-home-chart-container">
        <canvas id="workflowStatusChart"></canvas>
      </div>
    </div>
    {% endif %}
    
    {% if approval_status_dist %}
    <div class="module-home-stats-card">
      <div class="module-home-stats-card-title">å®¡æ‰¹çŠ¶æ€åˆ†å¸ƒ</div>
      <div class="module-home-chart-container">
        <canvas id="approvalStatusChart"></canvas>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}
{% endblock module_home_stats_row %}

{% block module_home_warning_todo_row %}
  <!-- å¾…åŠäº‹é¡¹ -->
  <div class="module-home-stats-row">
    {% if todo_items %}
    <div class="module-home-todo-card">
      <div class="module-home-card-title">
        å¾…æˆ‘å®¡æ‰¹
        {% if pending_approval_count %}
        <span style="font-size: 12px; font-weight: 400; color: #666;">({{ pending_approval_count }})</span>
        {% endif %}
      </div>
      <ul class="module-home-todo-list">
        {% for item in todo_items %}
        <li class="module-home-todo-item">
          <a href="{{ item.url|default:'#' }}" class="module-home-item-link">
            <div class="module-home-item-title">{{ item.title }}</div>
            <div class="module-home-item-meta">
              {{ item.instance_number|default:'' }} Â· {{ item.time|date:"Y-m-d H:i" }}
            </div>
          </a>
        </li>
        {% endfor %}
      </ul>
      {% if pending_approval_count > 5 %}
      <div style="text-align: center; margin-top: 12px;">
        <a href="{% url 'workflow_engine:approval_list' %}?status=pending" style="font-size: 12px; color: #666;">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
      </div>
      {% endif %}
    </div>
    {% else %}
    <div class="module-home-todo-card">
      <div class="module-home-card-title">å¾…æˆ‘å®¡æ‰¹</div>
      <div class="module-home-empty">æš‚æ— å¾…å®¡æ‰¹äº‹é¡¹</div>
    </div>
    {% endif %}
    
    {% if my_pending_items %}
    <div class="module-home-todo-card">
      <div class="module-home-card-title">
        æˆ‘çš„ç”³è¯·
        {% if my_pending_count %}
        <span style="font-size: 12px; font-weight: 400; color: #666;">(å¾…å®¡æ‰¹ {{ my_pending_count }})</span>
        {% endif %}
      </div>
      <ul class="module-home-todo-list">
        {% for item in my_pending_items %}
        <li class="module-home-todo-item">
          <a href="{{ item.url|default:'#' }}" class="module-home-item-link">
            <div class="module-home-item-title">{{ item.title }}</div>
            <div class="module-home-item-meta">
              {{ item.instance_number|default:'' }} Â· {{ item.status|default:'' }} Â· {{ item.time|date:"Y-m-d H:i" }}
            </div>
          </a>
        </li>
        {% endfor %}
      </ul>
      {% if my_pending_count > 5 %}
      <div style="text-align: center; margin-top: 12px;">
        <a href="{% url 'workflow_engine:approval_list' %}?status=my" style="font-size: 12px; color: #666;">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
      </div>
      {% endif %}
    </div>
    {% else %}
    <div class="module-home-todo-card">
      <div class="module-home-card-title">æˆ‘çš„ç”³è¯·</div>
      <div class="module-home-empty">æš‚æ— ç”³è¯·è®°å½•</div>
    </div>
    {% endif %}
  </div>
{% endblock module_home_warning_todo_row %}

{% block module_home_work_activities_row %}
  <!-- æœ€è¿‘æ´»åŠ¨ -->
  {% if recent_activities.recent_approvals %}
  <div class="module-home-stats-row">
    <div class="module-home-activities-card">
      <div class="module-home-card-title">æœ€è¿‘å®¡æ‰¹æ´»åŠ¨</div>
      <ul class="module-home-activity-list">
        {% for activity in recent_activities.recent_approvals %}
        <li class="module-home-activity-item">
          <a href="{{ activity.url|default:'#' }}" class="module-home-item-link">
            <div class="module-home-activity-title">{{ activity.title }}</div>
            <div class="module-home-activity-meta">
              {{ activity.approver }} Â· {{ activity.result }} Â· {{ activity.time|date:"Y-m-d H:i" }}
            </div>
          </a>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}
{% endblock module_home_work_activities_row %}

{% block module_home_scripts %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
    // æµç¨‹çŠ¶æ€åˆ†å¸ƒå›¾è¡¨
    {% if workflow_status_dist %}
    (function() {
      const ctx = document.getElementById('workflowStatusChart');
      if (ctx) {
        const data = JSON.parse('{{ workflow_status_dist|escapejs }}');
        const labels = Object.values(data).map(item => item.label);
        const counts = Object.values(data).map(item => item.count);
        
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: counts,
              backgroundColor: [
                '#4CAF50', // æ¿€æ´»
                '#FF9800', // è‰ç¨¿
                '#F44336', // åœç”¨
                '#9E9E9E'  // å…¶ä»–
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
    })();
    {% endif %}
    
    // å®¡æ‰¹çŠ¶æ€åˆ†å¸ƒå›¾è¡¨
    {% if approval_status_dist %}
    (function() {
      const ctx = document.getElementById('approvalStatusChart');
      if (ctx) {
        const data = JSON.parse('{{ approval_status_dist|escapejs }}');
        const labels = Object.values(data).map(item => item.label);
        const counts = Object.values(data).map(item => item.count);
        
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: counts,
              backgroundColor: [
                '#FF9800', // å¾…å®¡æ‰¹
                '#4CAF50', // å·²é€šè¿‡
                '#F44336', // å·²é©³å›
                '#9E9E9E'  // å·²å–æ¶ˆ
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
    })();
    {% endif %}
  </script>
{% endblock module_home_scripts %}
