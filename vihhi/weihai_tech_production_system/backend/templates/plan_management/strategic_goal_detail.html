{% extends "shared/detail_base.html" %}
{% load static %}

{% block detail_title %}目标详情{% endblock %}
{% block detail_subtitle %}{{ goal.name }}{% endblock %}

{% block detail_header_actions %}
<a href="{% url 'plan_pages:strategic_goal_list' %}" class="btn btn-secondary">
  <i class="fas fa-arrow-left"></i>
  返回列表
</a>
{% endblock %}

{% block detail_basic_info %}
  {# 目标编号 #}
  <div class="col-5-fields detail-field-wrapper">
    <div class="detail-field">
      <label class="detail-field-label">目标编号</label>
      <div class="detail-field-value">
        <code>{{ goal.goal_number }}</code>
      </div>
    </div>
  </div>

  {# 目标名称 #}
  <div class="col-5-fields detail-field-wrapper">
    <div class="detail-field">
      <label class="detail-field-label">目标名称</label>
      <div class="detail-field-value">
        <strong>{{ goal.name }}</strong>
      </div>
    </div>
  </div>

  {# 目标状态 #}
  <div class="col-5-fields detail-field-wrapper">
    <div class="detail-field">
      <label class="detail-field-label">目标状态</label>
      <div class="detail-field-value">
        <span class="badge badge-status badge-{{ goal.status }}">
          {{ goal.get_status_display|default:goal.status }}
        </span>
      </div>
    </div>
  </div>

  {# 目标层级 #}
  <div class="col-5-fields detail-field-wrapper">
    <div class="detail-field">
      <label class="detail-field-label">目标层级</label>
      <div class="detail-field-value">
        {{ goal.get_level_display|default:goal.level }}
      </div>
    </div>
  </div>

  {# 目标类型 #}
  <div class="col-5-fields detail-field-wrapper">
    <div class="detail-field">
      <label class="detail-field-label">目标类型</label>
      <div class="detail-field-value">
        {{ goal.get_goal_type_display|default:goal.goal_type }}
      </div>
    </div>
  </div>

  {# 目标周期 #}
  <div class="col-5-fields detail-field-wrapper">
    <div class="detail-field">
      <label class="detail-field-label">目标周期</label>
      <div class="detail-field-value">
        {{ goal.get_goal_period_display|default:goal.goal_period }}
      </div>
    </div>
  </div>

  {# 负责人 #}
  <div class="col-5-fields detail-field-wrapper">
    <div class="detail-field">
      <label class="detail-field-label">负责人</label>
      <div class="detail-field-value">
        {% if goal.responsible_person %}
          {{ goal.responsible_person.get_full_name|default:goal.responsible_person.username }}
        {% else %}
          -
        {% endif %}
      </div>
    </div>
  </div>

  {# 负责部门 #}
  <div class="col-5-fields detail-field-wrapper">
    <div class="detail-field">
      <label class="detail-field-label">负责部门</label>
      <div class="detail-field-value">
        {{ goal.responsible_department.name|default:"-" }}
      </div>
    </div>
  </div>

  {# 创建时间 #}
  <div class="col-5-fields detail-field-wrapper">
    <div class="detail-field">
      <label class="detail-field-label">创建时间</label>
      <div class="detail-field-value">
        {{ goal.created_time|date:"Y-m-d H:i:s"|default:"-" }}
      </div>
    </div>
  </div>

  {# 更新时间 #}
  <div class="col-5-fields detail-field-wrapper">
    <div class="detail-field">
      <label class="detail-field-label">更新时间</label>
      <div class="detail-field-value">
        {{ goal.updated_time|date:"Y-m-d H:i:s"|default:"-" }}
      </div>
    </div>
  </div>
{% endblock detail_basic_info %}

{% block detail_text_fields_content %}
  {# 目标描述 #}
  {% if goal.description %}
  <div class="col-12-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">目标描述</label>
      <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.5;">
        {{ goal.description }}
      </div>
    </div>
  </div>
  {% endif %}

  {# 目标背景 #}
  {% if goal.background %}
  <div class="col-12-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">目标背景</label>
      <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.5;">
        {{ goal.background }}
      </div>
    </div>
  </div>
  {% endif %}

  {# 目标意义 #}
  {% if goal.significance %}
  <div class="col-12-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">目标意义</label>
      <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.5;">
        {{ goal.significance }}
      </div>
    </div>
  </div>
  {% endif %}

  {# 权重说明 #}
  {% if goal.weight_description %}
  <div class="col-12-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">权重说明</label>
      <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.5;">
        {{ goal.weight_description }}
      </div>
    </div>
  </div>
  {% endif %}

  {# 备注 #}
  {% if goal.notes %}
  <div class="col-12-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">备注</label>
      <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.5;">
        {{ goal.notes }}
      </div>
    </div>
  </div>
  {% endif %}
{% endblock detail_text_fields_content %}

{% block detail_number_fields_content %}
  {# 目标值 #}
  <div class="col-5-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">目标值</label>
      <div class="detail-field-value">
        <strong>{{ goal.target_value }}</strong>{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}
      </div>
    </div>
  </div>

  {# 当前值 #}
  <div class="col-5-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">当前值</label>
      <div class="detail-field-value">
        <strong>{{ goal.current_value }}</strong>{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}
      </div>
    </div>
  </div>

  {# 完成率 #}
  <div class="col-5-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">完成率</label>
      <div class="detail-field-value">
        <strong>{{ goal.completion_rate }}%</strong>
      </div>
    </div>
  </div>

  {# 目标权重 #}
  {% if goal.weight %}
  <div class="col-5-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">目标权重</label>
      <div class="detail-field-value">
        {{ goal.weight }}
      </div>
    </div>
  </div>
  {% endif %}

  {# 指标名称 #}
  {% if goal.indicator_name %}
  <div class="col-5-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">指标名称</label>
      <div class="detail-field-value">
        {{ goal.indicator_name }}
      </div>
    </div>
  </div>
  {% endif %}

  {# 指标类型 #}
  {% if goal.indicator_type %}
  <div class="col-5-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">指标类型</label>
      <div class="detail-field-value">
        {{ goal.get_indicator_type_display|default:goal.indicator_type }}
      </div>
    </div>
  </div>
  {% endif %}
{% endblock detail_number_fields_content %}

{% block detail_datetime_fields_content %}
  {# 开始日期 #}
  <div class="col-5-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">开始日期</label>
      <div class="detail-field-value">
        {{ goal.start_date|date:"Y-m-d"|default:"-" }}
      </div>
    </div>
  </div>

  {# 结束日期 #}
  <div class="col-5-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">结束日期</label>
      <div class="detail-field-value">
        {{ goal.end_date|date:"Y-m-d"|default:"-" }}
      </div>
    </div>
  </div>

  {# 发布时间 #}
  {% if goal.published_at %}
  <div class="col-5-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">发布时间</label>
      <div class="detail-field-value">
        {{ goal.published_at|date:"Y-m-d H:i" }}
      </div>
    </div>
  </div>
  {% endif %}

  {# 接收时间 #}
  {% if goal.accepted_at %}
  <div class="col-5-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">接收时间</label>
      <div class="detail-field-value">
        {{ goal.accepted_at|date:"Y-m-d H:i" }}
      </div>
    </div>
  </div>
  {% endif %}

  {# 完成时间 #}
  {% if goal.completed_at %}
  <div class="col-5-fields detail-field-wrapper mb-3">
    <div class="detail-field">
      <label class="detail-field-label">完成时间</label>
      <div class="detail-field-value">
        {{ goal.completed_at|date:"Y-m-d H:i" }}
      </div>
    </div>
  </div>
  {% endif %}
{% endblock detail_datetime_fields_content %}

{% block detail_edit_url %}{% url 'plan_pages:strategic_goal_edit' goal.id %}{% endblock %}
{% block detail_delete_url %}{% url 'plan_pages:strategic_goal_delete' goal.id %}{% endblock %}

{% block detail_other_actions %}
  {# 跟踪按钮 #}
  <a href="{% url 'plan_pages:strategic_goal_track' goal.id %}" class="btn btn-info">
    <i class="fas fa-chart-line"></i>
    跟踪
  </a>

  {# 分解按钮 #}
  <a href="{% url 'plan_pages:strategic_goal_decompose' goal.id %}" class="btn btn-info">
    <i class="fas fa-sitemap"></i>
    分解
  </a>

  {# 发布目标 #}
  {% if can_publish %}
  <form method="post" action="{% url 'plan_pages:strategic_goal_detail' goal.id %}" style="display: inline;">
    {% csrf_token %}
    <button type="submit" name="publish_goal" class="btn btn-success">
      <i class="fas fa-paper-plane"></i>
      发布目标
    </button>
  </form>
  {% endif %}

  {# 接收目标 #}
  {% if can_accept %}
  <form method="post" action="{% url 'plan_pages:strategic_goal_detail' goal.id %}" style="display: inline;">
    {% csrf_token %}
    <button type="submit" name="accept_goal" class="btn btn-success">
      <i class="fas fa-check"></i>
      接收目标
    </button>
  </form>
  {% endif %}

  {# 开始执行 #}
  {% if can_start_execution %}
  <form method="post" action="{% url 'plan_pages:strategic_goal_detail' goal.id %}" style="display: inline;">
    {% csrf_token %}
    <button type="submit" name="start_execution" class="btn btn-success">
      <i class="fas fa-play"></i>
      开始执行
    </button>
  </form>
  {% endif %}
{% endblock detail_other_actions %}

{% block detail_modification_history_content %}
  {% if progress_records %}
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>记录时间</th>
          <th>当前值</th>
          <th>完成率</th>
          <th>记录人</th>
          <th>备注</th>
        </tr>
      </thead>
      <tbody>
        {% for record in progress_records %}
        <tr>
          <td>{{ record.recorded_time|date:"Y-m-d H:i" }}</td>
          <td><strong>{{ record.current_value }}</strong>{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}</td>
          <td><strong>{{ record.completion_rate }}%</strong></td>
          <td>
            {% if record.recorded_by %}
              {{ record.recorded_by.get_full_name|default:record.recorded_by.username }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ record.notes|default:"-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="text-muted">暂无进度记录</div>
  {% endif %}
{% endblock detail_modification_history_content %}

{% block detail_status_history_content %}
  {% if status_logs %}
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>变更时间</th>
          <th>状态变更</th>
          <th>变更人</th>
          <th>变更原因</th>
        </tr>
      </thead>
      <tbody>
        {% for log in status_logs %}
        <tr>
          <td>{{ log.changed_time|date:"Y-m-d H:i" }}</td>
          <td>
            <span class="badge badge-status badge-{{ log.old_status }}">
              {{ log.get_old_status_display|default:log.old_status }}
            </span>
            →
            <span class="badge badge-status badge-{{ log.new_status }}">
              {{ log.get_new_status_display|default:log.new_status }}
            </span>
          </td>
          <td>
            {% if log.changed_by %}
              {{ log.changed_by.get_full_name|default:log.changed_by.username }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ log.change_reason|default:"-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="text-muted">暂无状态变更记录</div>
  {% endif %}
{% endblock detail_status_history_content %}

{% block detail_related_records_content %}
  {# 子目标列表 #}
  {% if child_goals %}
  <div class="mb-4">
    <h6 class="mb-3">子目标列表 ({{ child_goals|length }})</h6>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>目标名称</th>
            <th>目标编号</th>
            <th>目标类型</th>
            <th>目标值</th>
            <th>当前值</th>
            <th>完成率</th>
            <th>负责人</th>
            <th>状态</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for child_goal in child_goals %}
          <tr>
            <td>
              <strong>
                <a href="{% url 'plan_pages:strategic_goal_detail' child_goal.id %}">
                  {{ child_goal.name }}
                </a>
              </strong>
            </td>
            <td><code>{{ child_goal.goal_number }}</code></td>
            <td>{{ child_goal.get_goal_type_display }}</td>
            <td>{{ child_goal.target_value }}{% if child_goal.indicator_unit %} {{ child_goal.indicator_unit }}{% endif %}</td>
            <td>{{ child_goal.current_value }}{% if child_goal.indicator_unit %} {{ child_goal.indicator_unit }}{% endif %}</td>
            <td>
              <div class="progress" style="height: 20px;">
                <div class="progress-bar" role="progressbar" 
                     style="width: {{ child_goal.completion_rate }}%;" 
                     aria-valuenow="{{ child_goal.completion_rate }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                  {{ child_goal.completion_rate }}%
                </div>
              </div>
            </td>
            <td>{{ child_goal.responsible_person.get_full_name|default:child_goal.responsible_person.username }}</td>
            <td>
              <span class="badge badge-status badge-{{ child_goal.status }}">
                {{ child_goal.get_status_display }}
              </span>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <a href="{% url 'plan_pages:strategic_goal_detail' child_goal.id %}" class="btn btn-sm btn-secondary">
                  <i class="fas fa-eye"></i>
                </a>
                {% if child_goal.status in 'draft,published' %}
                <a href="{% url 'plan_pages:strategic_goal_edit' child_goal.id %}" class="btn btn-sm btn-secondary">
                  <i class="fas fa-edit"></i>
                </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {# 调整申请 #}
  {% if adjustments %}
  <div class="mb-4">
    <h6 class="mb-3">调整申请 ({{ adjustments|length }})</h6>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>申请时间</th>
            <th>调整内容</th>
            <th>状态</th>
            <th>申请人</th>
            <th>审批人</th>
          </tr>
        </thead>
        <tbody>
          {% for adjustment in adjustments %}
          <tr>
            <td>{{ adjustment.created_time|date:"Y-m-d H:i" }}</td>
            <td>{{ adjustment.adjustment_content|truncatechars:50 }}</td>
            <td>
              <span class="badge badge-{{ adjustment.status }}">
                {{ adjustment.get_status_display }}
              </span>
            </td>
            <td>
              {% if adjustment.created_by %}
                {{ adjustment.created_by.get_full_name|default:adjustment.created_by.username }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if adjustment.approved_by %}
                {{ adjustment.approved_by.get_full_name|default:adjustment.approved_by.username }}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
{% endblock detail_related_records_content %}

{% block detail_related_links_content %}
  {# 父目标 #}
  {% if goal.parent_goal %}
  <div class="mb-2">
    <a href="{% url 'plan_pages:strategic_goal_detail' goal.parent_goal.id %}" class="btn btn-sm btn-outline-primary">
      <i class="fas fa-level-up-alt"></i>
      查看父目标：{{ goal.parent_goal.name }}
    </a>
  </div>
  {% endif %}

  {# 关联计划 #}
  {% if related_plans_count > 0 %}
  <div class="mb-2">
    <a href="{% url 'plan_pages:plan_list' %}?related_goal={{ goal.id }}" class="btn btn-sm btn-outline-primary">
      <i class="fas fa-list"></i>
      查看关联计划 ({{ related_plans_count }})
    </a>
  </div>
  {% endif %}
{% endblock detail_related_links_content %}

{% block detail_statistics_content %}
  {# 完成率进度条 #}
  {% if goal.completion_rate is not None %}
  <div class="mb-4">
    <h5 class="detail-subsection-title">完成进度</h5>
    <div class="row mb-3">
      <div class="col-md-6">
        <div class="detail-field">
          <label class="detail-field-label">完成率</label>
          <div class="detail-field-value">
            <strong style="font-size: 16px;">{{ goal.completion_rate }}%</strong>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="detail-field">
          <label class="detail-field-label">进度</label>
          <div class="detail-field-value">
            {{ goal.current_value }}{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %} / {{ goal.target_value }}{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="progress" style="height: 30px;">
      <div class="progress-bar progress-bar-striped progress-bar-animated" 
           role="progressbar" 
           style="width: {{ goal.completion_rate }}%;" 
           aria-valuenow="{{ goal.completion_rate }}" 
           aria-valuemin="0" 
           aria-valuemax="100">
        {{ goal.completion_rate }}%
      </div>
    </div>
  </div>
  {% endif %}

  {# 统计信息卡片 #}
  <div class="row">
    <div class="col-md-3 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">{{ child_goals|length|default:0 }}</h5>
          <p class="card-text text-muted">子目标数</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">{{ related_plans_count|default:0 }}</h5>
          <p class="card-text text-muted">关联计划</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">{{ progress_records|length|default:0 }}</h5>
          <p class="card-text text-muted">进度记录</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title">{{ status_logs|length|default:0 }}</h5>
          <p class="card-text text-muted">状态变更</p>
        </div>
      </div>
    </div>
  </div>
{% endblock detail_statistics_content %}

{% block module_extra_css %}
{{ block.super }}
<style>
  .badge-status {
    padding: 5px 12px;
    border-radius: 0;
    font-size: 16px;
    font-weight: 500;
  }
  
  .badge-draft {
    background: #FFF3E0;
    color: #F57C00;
    border: 1px solid #FFE0B2;
  }
  
  .badge-published {
    background: #E3F2FD;
    color: #1976D2;
    border: 1px solid #BBDEFB;
  }
  
  .badge-accepted {
    background: #E8F5E9;
    color: #388E3C;
    border: 1px solid #C8E6C9;
  }
  
  .badge-in_progress {
    background: #E3F2FD;
    color: #1976D2;
    border: 1px solid #BBDEFB;
  }
  
  .badge-completed {
    background: #E8F5E9;
    color: #2E7D32;
    border: 1px solid #C8E6C9;
  }
  
  .badge-cancelled {
    background: #FFEBEE;
    color: #C62828;
    border: 1px solid #FFCDD2;
  }
</style>
{% endblock module_extra_css %}
