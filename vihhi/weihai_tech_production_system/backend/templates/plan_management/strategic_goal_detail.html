{% extends "shared/module_base.html" %}
{% load static %}

{% block module_title %}ç›®æ ‡è¯¦æƒ… - {{ goal.name }}{% endblock %}
{% block pm_title %}ç›®æ ‡è¯¦æƒ… - {{ goal.name }}{% endblock %}
{% block pm_subtitle %}<span class="pm-subtitle">{{ goal.goal_number }} - {{ goal.get_status_display }}</span>{% endblock %}

{% block pm_actions %}
  <a href="{% url 'plan_pages:strategic_goal_list' %}" class="list-btn">
    <i class="bi bi-arrow-left"></i> è¿”å›åˆ—è¡¨
  </a>
  {% if can_edit %}
  <a href="{% url 'plan_pages:strategic_goal_edit' goal.id %}" class="list-btn list-btn-primary">
    <i class="bi bi-pencil"></i> ç¼–è¾‘
  </a>
  {% endif %}
  <a href="{% url 'plan_pages:strategic_goal_track' goal.id %}" class="list-btn list-btn-outline">
    <i class="bi bi-graph-up"></i> è·Ÿè¸ª
  </a>
  <a href="{% url 'plan_pages:strategic_goal_decompose' goal.id %}" class="list-btn list-btn-outline">
    <i class="bi bi-diagram-3"></i> åˆ†è§£
  </a>
  {% if can_delete %}
  <a href="{% url 'plan_pages:strategic_goal_delete' goal.id %}" class="list-btn list-btn-outline" onclick="return confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')">
    <i class="bi bi-trash"></i> åˆ é™¤
  </a>
  {% endif %}
{% endblock %}

{% block module_styles %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/components/list_layout.css' %}">
  <link rel="stylesheet" href="{% static 'css/components/list_page_base_v2.css' %}">
{% endblock module_styles %}

{% block module_extra_css %}
<style>
  /* ç›®æ ‡åŸºæœ¬ä¿¡æ¯å¡ç‰‡ */
  .goal-info-header {
    background: #FFFFFF;
    border: 1px solid #E0E0E0;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .goal-info-header h3 {
    font-size: 1.3rem;
    font-weight: 600;
    color: #1A1A1A;
    margin-bottom: 12px;
  }

  .goal-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }

  .goal-info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .goal-info-label {
    font-size: 0.85rem;
    color: #666666;
  }

  .goal-info-value {
    font-size: 1rem;
    font-weight: 600;
    color: #1A1A1A;
  }

  .status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
    display: inline-block;
  }

  .status-draft { background: #FFF3E0; color: #F57C00; }
  .status-published { background: #E3F2FD; color: #1976D2; }
  .status-accepted { background: #E8F5E9; color: #388E3C; }
  .status-in_progress { background: #E3F2FD; color: #1976D2; }
  .status-completed { background: #E8F5E9; color: #388E3C; }
  .status-cancelled { background: #FFEBEE; color: #C62828; }

  /* è¿›åº¦æ¡ */
  .progress-bar-container {
    width: 100%;
    height: 24px;
    background: #F0F0F0;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #2ecc71 0%, #3498db 100%);
    border-radius: 12px;
    transition: width 0.3s ease;
  }

  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.85rem;
    font-weight: 600;
    color: #1A1A1A;
    z-index: 1;
  }
</style>
{% endblock module_extra_css %}

{% block pm_content %}
  <!-- ç›®æ ‡åŸºæœ¬ä¿¡æ¯ -->
  <div class="goal-info-header">
    <h3>{{ goal.name }}</h3>
    <div class="goal-info-grid">
      <div class="goal-info-item">
        <span class="goal-info-label">ç›®æ ‡ç¼–å·</span>
        <span class="goal-info-value"><code>{{ goal.goal_number }}</code></span>
      </div>
      <div class="goal-info-item">
        <span class="goal-info-label">ç›®æ ‡ç±»å‹</span>
        <span class="goal-info-value">{{ goal.get_goal_type_display }}</span>
      </div>
      <div class="goal-info-item">
        <span class="goal-info-label">ç›®æ ‡å‘¨æœŸ</span>
        <span class="goal-info-value">{{ goal.get_goal_period_display }}</span>
      </div>
      <div class="goal-info-item">
        <span class="goal-info-label">ç›®æ ‡çŠ¶æ€</span>
        <span class="goal-info-value">
          <span class="status-badge status-{{ goal.status }}">{{ goal.get_status_display }}</span>
        </span>
      </div>
      <div class="goal-info-item">
        <span class="goal-info-label">ç›®æ ‡å€¼</span>
        <span class="goal-info-value">{{ goal.target_value }}{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}</span>
      </div>
      <div class="goal-info-item">
        <span class="goal-info-label">å½“å‰å€¼</span>
        <span class="goal-info-value">{{ goal.current_value }}{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}</span>
      </div>
      <div class="goal-info-item">
        <span class="goal-info-label">å®Œæˆè¿›åº¦</span>
        <span class="goal-info-value">
          <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: {{ goal.completion_rate }}%"></div>
            <span class="progress-text">{{ goal.completion_rate }}%</span>
          </div>
        </span>
      </div>
      <div class="goal-info-item">
        <span class="goal-info-label">è´Ÿè´£äºº</span>
        <span class="goal-info-value">{{ goal.responsible_person.get_full_name|default:goal.responsible_person.username }}</span>
      </div>
    </div>
  </div>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  {% block list_stats_section %}
  <div class="list-stats-section">
    <div class="row g-3">
      <div class="col-md-3">
        <div class="list-stat-card">
          <div class="list-stat-label">å­ç›®æ ‡æ•°</div>
          <div class="list-stat-value">{{ child_goals.count }}</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="list-stat-card">
          <div class="list-stat-label">å…³è”è®¡åˆ’</div>
          <div class="list-stat-value">{{ related_plans_count }}</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="list-stat-card">
          <div class="list-stat-label">è¿›åº¦è®°å½•</div>
          <div class="list-stat-value">{{ progress_records|length }}</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="list-stat-card">
          <div class="list-stat-label">å®Œæˆç‡</div>
          <div class="list-stat-value">{{ goal.completion_rate|floatformat:0 }}%</div>
        </div>
      </div>
    </div>
  </div>
  {% endblock list_stats_section %}

  <!-- ç­›é€‰åŒºåŸŸ -->
  {% block list_filters_section %}
  <div class="list-filters-section">
    <form method="get">
      <div class="row">
        <div class="col-md-3">
          <label class="form-label">ç›®æ ‡çŠ¶æ€</label>
          <select name="status" class="form-select">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>åˆ¶å®šä¸­</option>
            <option value="published" {% if request.GET.status == 'published' %}selected{% endif %}>å·²å‘å¸ƒ</option>
            <option value="accepted" {% if request.GET.status == 'accepted' %}selected{% endif %}>å·²æ¥æ”¶</option>
            <option value="in_progress" {% if request.GET.status == 'in_progress' %}selected{% endif %}>æ‰§è¡Œä¸­</option>
            <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>å·²å®Œæˆ</option>
            <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>å·²å–æ¶ˆ</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">è´Ÿè´£äºº</label>
          <input type="text" name="responsible" class="form-control" value="{{ request.GET.responsible }}" placeholder="è¯·è¾“å…¥è´Ÿè´£äºº">
        </div>
        <div class="col-md-auto d-flex align-items-end">
          <button type="submit" class="list-btn list-btn-primary">æŸ¥è¯¢</button>
          <a href="{{ request.path }}" class="list-btn list-btn-outline ms-2">é‡ç½®</a>
        </div>
      </div>
    </form>
  </div>
  {% endblock list_filters_section %}

  <!-- å­ç›®æ ‡åˆ—è¡¨è¡¨æ ¼ -->
  <div class="list-table-section">
    <div class="list-table-wrapper">
      <table class="list-table">
        <thead>
          <tr>
            {% block list_table_headers %}
            <th>ç›®æ ‡åç§°</th>
            <th>ç›®æ ‡ç¼–å·</th>
            <th>ç›®æ ‡ç±»å‹</th>
            <th>ç›®æ ‡å€¼</th>
            <th>å½“å‰å€¼</th>
            <th>å®Œæˆç‡</th>
            <th>è´Ÿè´£äºº</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
            {% endblock list_table_headers %}
          </tr>
        </thead>
        <tbody>
          {% block list_table_rows %}
          {% for child_goal in child_goals %}
          <tr>
            <td>
              <strong>
                <a href="{% url 'plan_pages:strategic_goal_detail' child_goal.id %}" style="color: #1A1A1A; text-decoration: none;">
                  {{ child_goal.name }}
                </a>
              </strong>
            </td>
            <td><code>{{ child_goal.goal_number }}</code></td>
            <td>{{ child_goal.get_goal_type_display }}</td>
            <td>{{ child_goal.target_value }}{% if child_goal.indicator_unit %} {{ child_goal.indicator_unit }}{% endif %}</td>
            <td>{{ child_goal.current_value }}{% if child_goal.indicator_unit %} {{ child_goal.indicator_unit }}{% endif %}</td>
            <td>
              <div class="progress-bar-container" style="width: 100px; height: 20px;">
                <div class="progress-bar-fill" style="width: {{ child_goal.completion_rate }}%"></div>
                <span class="progress-text" style="font-size: 0.75rem;">{{ child_goal.completion_rate }}%</span>
              </div>
            </td>
            <td>{{ child_goal.responsible_person.get_full_name|default:child_goal.responsible_person.username }}</td>
            <td>
              <span class="status-badge status-{{ child_goal.status }}">{{ child_goal.get_status_display }}</span>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <a href="{% url 'plan_pages:strategic_goal_detail' child_goal.id %}" class="btn btn-outline-primary" title="æŸ¥çœ‹">
                  <i class="bi bi-eye"></i>
                </a>
                {% if child_goal.status in 'draft,published' %}
                <a href="{% url 'plan_pages:strategic_goal_edit' child_goal.id %}" class="btn btn-outline-secondary" title="ç¼–è¾‘">
                  <i class="bi bi-pencil"></i>
                </a>
                {% endif %}
                <a href="{% url 'plan_pages:strategic_goal_decompose' child_goal.id %}" class="btn btn-outline-info" title="åˆ†è§£">
                  <i class="bi bi-diagram-3"></i>
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="list-empty-state">
              <div class="list-empty-state-icon">ğŸ“‹</div>
              <div class="list-empty-state-text">æš‚æ— å­ç›®æ ‡</div>
              <div class="list-empty-state-hint">
                <a href="{% url 'plan_pages:strategic_goal_decompose' goal.id %}" class="list-btn list-btn-primary mt-2">
                  <i class="bi bi-plus-circle"></i> åˆ›å»ºå­ç›®æ ‡
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
          {% endblock list_table_rows %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- å¦‚æœæ²¡æœ‰ä»»ä½•å­ç›®æ ‡ï¼Œæ˜¾ç¤ºåˆ›å»ºæç¤º -->
  {% if not child_goals.exists %}
  <div class="alert alert-info mt-4">
    <h5><i class="bi bi-info-circle"></i> æç¤º</h5>
    <p>å½“å‰ç›®æ ‡è¿˜æ²¡æœ‰å­ç›®æ ‡ï¼Œæ‚¨å¯ä»¥ï¼š</p>
    <ul>
      <li><a href="{% url 'plan_pages:strategic_goal_decompose' goal.id %}">åˆ›å»ºå­ç›®æ ‡</a> - å°†ç›®æ ‡åˆ†è§£ä¸ºæ›´å°çš„å­ç›®æ ‡</li>
      <li><a href="{% url 'plan_pages:strategic_goal_track' goal.id %}">è·Ÿè¸ªè¿›åº¦</a> - è®°å½•ç›®æ ‡çš„æ‰§è¡Œè¿›åº¦</li>
    </ul>
  </div>
  {% endif %}
{% endblock pm_content %}
