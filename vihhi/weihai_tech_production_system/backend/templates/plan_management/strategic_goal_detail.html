{% extends "shared/detail_base.html" %}
{% load static %}

{% block detail_title %}目标详情{% endblock %}
{% block detail_subtitle %}{{ goal.name }}{% endblock %}

{% block detail_header_actions %}
<a href="{% url 'plan_pages:strategic_goal_list' %}" class="btn btn-secondary">
  <i class="fas fa-arrow-left"></i>
  返回列表
</a>
{% endblock %}

{# 基本信息卡片由基础模板自动提供，包含：所属部门、负责人、目标编号 #}

{% block detail_detail_info_card %}
<div class="detail-card-wrapper detail-card-wrapper-detail-info">
  <div class="detail-card detail-card-detail-info">
    <div class="detail-card-header">
      <h3 class="detail-card-title">
        <i class="fas fa-list-alt"></i>
        详细信息
      </h3>
    </div>
    <div class="detail-card-body">
      {% block detail_detail_info_rows %}
  {# 第一排：目标名称、目标状态、目标层级（使用标准栅格：col-md-4，一行3个字段） #}
  <div class="row mb-3">
    {% block detail_detail_info_row1 %}
    {# 目标名称 #}
    <div class="col-md-4 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">目标名称</label>
        <div class="detail-field-value">
          <strong>{{ goal.name }}</strong>
        </div>
      </div>
    </div>
    {# 目标状态 #}
    <div class="col-md-4 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">目标状态</label>
        <div class="detail-field-value">
          <span class="badge badge-status badge-{{ goal.status }}">
            {{ goal.get_status_display|default:goal.status }}
          </span>
        </div>
      </div>
    </div>
    {# 目标层级 #}
    <div class="col-md-4 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">目标层级</label>
        <div class="detail-field-value">
          {{ goal.get_level_display|default:goal.level }}
        </div>
      </div>
    </div>
    {% endblock detail_detail_info_row1 %}
  </div>

  {# 第二排：目标类型、目标周期（使用标准栅格：col-md-6，一行2个字段） #}
  <div class="row mb-3">
    {% block detail_detail_info_row2 %}
    {# 目标类型 #}
    <div class="col-md-6 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">目标类型</label>
        <div class="detail-field-value">
          {{ goal.get_goal_type_display|default:goal.goal_type }}
        </div>
      </div>
    </div>
    {# 目标周期 #}
    <div class="col-md-6 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">目标周期</label>
        <div class="detail-field-value">
          {{ goal.get_goal_period_display|default:goal.goal_period }}
        </div>
      </div>
    </div>
    {% endblock detail_detail_info_row2 %}
  </div>

  {# 第三排：目标值、当前值、完成率（使用标准栅格：col-md-4，一行3个字段） #}
  <div class="row mb-3">
    {% block detail_detail_info_row3 %}
    {# 目标值 #}
    <div class="col-md-4 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">目标值</label>
        <div class="detail-field-value">
          <strong>{{ goal.target_value }}</strong>{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}
        </div>
      </div>
    </div>
    {# 当前值 #}
    <div class="col-md-4 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">当前值</label>
        <div class="detail-field-value">
          <strong>{{ goal.current_value }}</strong>{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}
        </div>
      </div>
    </div>
    {# 完成率 #}
    <div class="col-md-4 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">完成率</label>
        <div class="detail-field-value">
          <strong>{{ goal.completion_rate }}%</strong>
        </div>
      </div>
    </div>
    {% endblock detail_detail_info_row3 %}
  </div>

  {# 第四排：目标权重、指标名称、指标类型（使用标准栅格：col-md-4，一行3个字段） #}
  <div class="row mb-3">
    {% block detail_detail_info_row4 %}
    {% if goal.weight %}
    {# 目标权重 #}
    <div class="col-md-4 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">目标权重</label>
        <div class="detail-field-value">
          {{ goal.weight }}
        </div>
      </div>
    </div>
    {% endif %}
    {% if goal.indicator_name %}
    {# 指标名称 #}
    <div class="col-md-4 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">指标名称</label>
        <div class="detail-field-value">
          {{ goal.indicator_name }}
        </div>
      </div>
    </div>
    {% endif %}
    {% if goal.indicator_type %}
    {# 指标类型 #}
    <div class="col-md-4 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">指标类型</label>
        <div class="detail-field-value">
          {{ goal.get_indicator_type_display|default:goal.indicator_type }}
        </div>
      </div>
    </div>
    {% endif %}
    {% endblock detail_detail_info_row4 %}
  </div>

  {# 第五排：开始日期、结束日期（使用标准栅格：col-md-6，一行2个字段） #}
  <div class="row mb-3">
    {% block detail_detail_info_row5 %}
    {# 开始日期 #}
    <div class="col-md-6 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">开始日期</label>
        <div class="detail-field-value">
          {{ goal.start_date|date:"Y-m-d"|default:"-" }}
        </div>
      </div>
    </div>
    {# 结束日期 #}
    <div class="col-md-6 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">结束日期</label>
        <div class="detail-field-value">
          {{ goal.end_date|date:"Y-m-d"|default:"-" }}
        </div>
      </div>
    </div>
    {% endblock detail_detail_info_row5 %}
  </div>

  {# 第六排：发布时间、接收时间、完成时间（使用标准栅格：col-md-4，一行3个字段） #}
  {% if goal.published_at or goal.accepted_at or goal.completed_at %}
  <div class="row mb-3">
    {% block detail_detail_info_row6 %}
    {% if goal.published_at %}
    {# 发布时间 #}
    <div class="col-md-4 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">发布时间</label>
        <div class="detail-field-value">
          {{ goal.published_at|date:"Y-m-d H:i" }}
        </div>
      </div>
    </div>
    {% endif %}
    {% if goal.accepted_at %}
    {# 接收时间 #}
    <div class="col-md-4 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">接收时间</label>
        <div class="detail-field-value">
          {{ goal.accepted_at|date:"Y-m-d H:i" }}
        </div>
      </div>
    </div>
    {% endif %}
    {% if goal.completed_at %}
    {# 完成时间 #}
    <div class="col-md-4 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">完成时间</label>
        <div class="detail-field-value">
          {{ goal.completed_at|date:"Y-m-d H:i" }}
        </div>
      </div>
    </div>
    {% endif %}
    {% endblock detail_detail_info_row6 %}
  </div>
  {% endif %}

  {# 多行文本字段：目标描述（使用标准栅格：col-md-12，一行1个字段） #}
  {% if goal.description %}
  <div class="row mb-3">
    {% block detail_detail_info_description %}
    <div class="col-md-12 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">目标描述</label>
        <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.6;">
          {{ goal.description }}
        </div>
      </div>
    </div>
    {% endblock detail_detail_info_description %}
  </div>
  {% endif %}

  {# 多行文本字段：目标背景（使用标准栅格：col-md-12，一行1个字段） #}
  {% if goal.background %}
  <div class="row mb-3">
    {% block detail_detail_info_background %}
    <div class="col-md-12 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">目标背景</label>
        <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.6;">
          {{ goal.background }}
        </div>
      </div>
    </div>
    {% endblock detail_detail_info_background %}
  </div>
  {% endif %}

  {# 多行文本字段：目标意义（使用标准栅格：col-md-12，一行1个字段） #}
  {% if goal.significance %}
  <div class="row mb-3">
    {% block detail_detail_info_significance %}
    <div class="col-md-12 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">目标意义</label>
        <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.6;">
          {{ goal.significance }}
        </div>
      </div>
    </div>
    {% endblock detail_detail_info_significance %}
  </div>
  {% endif %}

  {# 多行文本字段：权重说明（使用标准栅格：col-md-12，一行1个字段） #}
  {% if goal.weight_description %}
  <div class="row mb-3">
    {% block detail_detail_info_weight_description %}
    <div class="col-md-12 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">权重说明</label>
        <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.6;">
          {{ goal.weight_description }}
        </div>
      </div>
    </div>
    {% endblock detail_detail_info_weight_description %}
  </div>
  {% endif %}

  {# 多行文本字段：备注（使用标准栅格：col-md-12，一行1个字段） #}
  {% if goal.notes %}
  <div class="row mb-3">
    {% block detail_detail_info_notes %}
    <div class="col-md-12 detail-field-wrapper">
      <div class="detail-field">
        <label class="detail-field-label">备注</label>
        <div class="detail-field-value" style="white-space: pre-wrap; line-height: 1.6;">
          {{ goal.notes }}
        </div>
      </div>
    </div>
    {% endblock detail_detail_info_notes %}
  </div>
  {% endif %}
      {% endblock detail_detail_info_rows %}
    </div>
  </div>
</div>
{% endblock detail_detail_info_card %}

{% block detail_edit_url %}{% url 'plan_pages:strategic_goal_edit' goal.id %}{% endblock %}
{% block detail_delete_url %}{% url 'plan_pages:strategic_goal_delete' goal.id %}{% endblock %}

{% block detail_other_actions %}
  {# 跟踪按钮 #}
  <a href="{% url 'plan_pages:strategic_goal_track' goal.id %}" class="btn btn-info">
    <i class="fas fa-chart-line"></i>
    跟踪
  </a>

  {# 分解按钮 #}
  <a href="{% url 'plan_pages:strategic_goal_decompose' goal.id %}" class="btn btn-info">
    <i class="fas fa-sitemap"></i>
    分解
  </a>

  {# 发布目标 #}
  {% if can_publish %}
  <form method="post" action="{% url 'plan_pages:strategic_goal_detail' goal.id %}" style="display: inline;">
    {% csrf_token %}
    <button type="submit" name="publish_goal" class="btn btn-success">
      <i class="fas fa-paper-plane"></i>
      发布目标
    </button>
  </form>
  {% endif %}

  {# 接收目标 #}
  {% if can_accept %}
  <form method="post" action="{% url 'plan_pages:strategic_goal_detail' goal.id %}" style="display: inline;">
    {% csrf_token %}
    <button type="submit" name="accept_goal" class="btn btn-success">
      <i class="fas fa-check"></i>
      接收目标
    </button>
  </form>
  {% endif %}

  {# 开始执行 #}
  {% if can_start_execution %}
  <form method="post" action="{% url 'plan_pages:strategic_goal_detail' goal.id %}" style="display: inline;">
    {% csrf_token %}
    <button type="submit" name="start_execution" class="btn btn-success">
      <i class="fas fa-play"></i>
      开始执行
    </button>
  </form>
  {% endif %}
{% endblock detail_other_actions %}

{% block detail_modification_history_content %}
  {% if progress_records %}
    {% for record in progress_records %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ record.recorded_time|date:"Y-m-d H:i" }}</td>
      <td>
        {% if record.recorded_by %}
          {{ record.recorded_by.get_full_name|default:record.recorded_by.username }}
        {% else %}
          -
        {% endif %}
      </td>
      <td>进度值</td>
      <td>-</td>
      <td><strong>{{ record.current_value }}</strong>{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %} (完成率: {{ record.completion_rate }}%)</td>
      <td>{{ record.notes|default:"-" }}</td>
    </tr>
    {% endfor %}
  {% endif %}
{% endblock detail_modification_history_content %}

{% block detail_status_history_content %}
  {% if status_logs %}
    {% for log in status_logs %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>
        <span class="badge badge-status badge-{{ log.old_status }}">
          {{ log.get_old_status_display|default:log.old_status }}
        </span>
        →
        <span class="badge badge-status badge-{{ log.new_status }}">
          {{ log.get_new_status_display|default:log.new_status }}
        </span>
      </td>
      <td>
        {% if log.changed_by %}
          {{ log.changed_by.get_full_name|default:log.changed_by.username }}
        {% else %}
          -
        {% endif %}
      </td>
      <td>{{ log.changed_time|date:"Y-m-d H:i" }}</td>
      <td>{{ log.get_change_evidence|default:"-" }}</td>
      <td>{{ log.notes|default:"-" }}</td>
    </tr>
    {% endfor %}
  {% endif %}
{% endblock detail_status_history_content %}

{% block detail_related_info_content %}
  {# 关联计划 #}
  {% if related_plans %}
    {% for plan in related_plans %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>关联计划</td>
      <td>
        <a href="{% url 'plan_pages:plan_detail' plan.id %}" class="text-decoration-none">
          {{ plan.plan_number }} - {{ plan.name }}
        </a>
      </td>
      <td>{{ plan.created_time|date:"Y-m-d H:i" }}</td>
      <td>{{ plan.get_status_display|default:plan.status }}</td>
      <td>-</td>
    </tr>
    {% endfor %}
  {% endif %}
  
  {# 子目标 #}
  {% if child_goals %}
    {% for child_goal in child_goals %}
    <tr>
      <td>{% if related_plans %}{{ related_plans|length|add:forloop.counter }}{% else %}{{ forloop.counter }}{% endif %}</td>
      <td>子目标</td>
      <td>
        <a href="{% url 'plan_pages:strategic_goal_detail' child_goal.id %}" class="text-decoration-none">
          {{ child_goal.goal_number }} - {{ child_goal.name }}
        </a>
      </td>
      <td>{{ child_goal.created_time|date:"Y-m-d H:i" }}</td>
      <td>{{ child_goal.get_status_display|default:child_goal.status }}</td>
      <td>-</td>
    </tr>
    {% endfor %}
  {% endif %}
  
  {# 如果没有关联信息，显示空状态 #}
  {% if not related_plans and not child_goals %}
  <tr>
    <td colspan="6" class="text-center text-muted">暂无关联信息</td>
  </tr>
  {% endif %}
{% endblock detail_related_info_content %}

{% block detail_audit_info_content %}
  {% if audit_logs %}
    {% for log in audit_logs %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ log.created_time|date:"Y-m-d H:i:s" }}</td>
      <td>
        {% if log.actor %}
          {{ log.actor.get_full_name|default:log.actor.username }}
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if log.meta.event %}
          {{ log.meta.event }}
        {% elif log.action %}
          {{ log.action }}
        {% else %}
          操作
        {% endif %}
      </td>
      <td>
        {% if log.changes %}
          {% for field, change in log.changes.items %}
            {% if change.from %}
              {{ field }}: {{ change.from }}
            {% endif %}
            {% if not forloop.last %}<br>{% endif %}
          {% endfor %}
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if log.changes %}
          {% for field, change in log.changes.items %}
            {% if change.to %}
              {{ field }}: {{ change.to }}
            {% endif %}
            {% if not forloop.last %}<br>{% endif %}
          {% endfor %}
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if log.meta.event %}
          {% if log.meta.ip %}{{ log.meta.ip }}{% endif %}
        {% else %}
          -
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  {% else %}
  <tr>
    <td colspan="7" class="text-center text-muted">暂无审计信息</td>
  </tr>
  {% endif %}
{% endblock detail_audit_info_content %}

{% block detail_related_records_content %}
  {# 子目标列表 #}
  {% if child_goals %}
  <div class="mb-4">
    <h6 class="mb-3">子目标列表 ({{ child_goals|length }})</h6>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>目标名称</th>
            <th>目标编号</th>
            <th>目标类型</th>
            <th>目标值</th>
            <th>当前值</th>
            <th>完成率</th>
            <th>负责人</th>
            <th>状态</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for child_goal in child_goals %}
          <tr>
            <td>
              <strong>
                <a href="{% url 'plan_pages:strategic_goal_detail' child_goal.id %}">
                  {{ child_goal.name }}
                </a>
              </strong>
            </td>
            <td><code>{{ child_goal.goal_number }}</code></td>
            <td>{{ child_goal.get_goal_type_display }}</td>
            <td>{{ child_goal.target_value }}{% if child_goal.indicator_unit %} {{ child_goal.indicator_unit }}{% endif %}</td>
            <td>{{ child_goal.current_value }}{% if child_goal.indicator_unit %} {{ child_goal.indicator_unit }}{% endif %}</td>
            <td>
              <div class="progress" style="height: 20px;">
                <div class="progress-bar" role="progressbar" 
                     style="width: {{ child_goal.completion_rate }}%;" 
                     aria-valuenow="{{ child_goal.completion_rate }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                  {{ child_goal.completion_rate }}%
                </div>
              </div>
            </td>
            <td>{{ child_goal.responsible_person.get_full_name|default:child_goal.responsible_person.username }}</td>
            <td>
              <span class="badge badge-status badge-{{ child_goal.status }}">
                {{ child_goal.get_status_display }}
              </span>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <a href="{% url 'plan_pages:strategic_goal_detail' child_goal.id %}" class="btn btn-sm btn-secondary">
                  <i class="fas fa-eye"></i>
                </a>
                {% if child_goal.status in 'draft,published' %}
                <a href="{% url 'plan_pages:strategic_goal_edit' child_goal.id %}" class="btn btn-sm btn-secondary">
                  <i class="fas fa-edit"></i>
                </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {# 调整申请 #}
  {% if adjustments %}
  <div class="mb-4">
    <h6 class="mb-3">调整申请 ({{ adjustments|length }})</h6>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>申请时间</th>
            <th>调整内容</th>
            <th>状态</th>
            <th>申请人</th>
            <th>审批人</th>
          </tr>
        </thead>
        <tbody>
          {% for adjustment in adjustments %}
          <tr>
            <td>{{ adjustment.created_time|date:"Y-m-d H:i" }}</td>
            <td>{{ adjustment.adjustment_content|truncatechars:50 }}</td>
            <td>
              <span class="badge badge-{{ adjustment.status }}">
                {{ adjustment.get_status_display }}
              </span>
            </td>
            <td>
              {% if adjustment.created_by %}
                {{ adjustment.created_by.get_full_name|default:adjustment.created_by.username }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if adjustment.approved_by %}
                {{ adjustment.approved_by.get_full_name|default:adjustment.approved_by.username }}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
{% endblock detail_related_records_content %}

{% block detail_related_links_content %}
  {# 父目标 #}
  {% if goal.parent_goal %}
  <div class="mb-2">
    <a href="{% url 'plan_pages:strategic_goal_detail' goal.parent_goal.id %}" class="btn btn-sm btn-outline-primary">
      <i class="fas fa-level-up-alt"></i>
      查看父目标：{{ goal.parent_goal.name }}
    </a>
  </div>
  {% endif %}

  {# 关联计划 #}
  {% if related_plans_count > 0 %}
  <div class="mb-2">
    <a href="{% url 'plan_pages:plan_list' %}?related_goal={{ goal.id }}" class="btn btn-sm btn-outline-primary">
      <i class="fas fa-list"></i>
      查看关联计划 ({{ related_plans_count }})
    </a>
  </div>
  {% endif %}
{% endblock detail_related_links_content %}

{% block detail_data_info_content %}
  {# 完成进度 #}
  {% if goal.completion_rate is not None %}
  <div class="mb-4">
    <h5 class="detail-subsection-title">完成进度</h5>
    <div class="row mb-3">
      <div class="col-md-6">
        <div class="detail-field">
          <label class="detail-field-label">完成率</label>
          <div class="detail-field-value">
            <strong style="font-size: 16px;">{{ goal.completion_rate }}%</strong>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="detail-field">
          <label class="detail-field-label">进度</label>
          <div class="detail-field-value">
            {{ goal.current_value }}{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %} / {{ goal.target_value }}{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="progress" style="height: 30px;">
      <div class="progress-bar progress-bar-striped progress-bar-animated" 
           role="progressbar" 
           style="width: {{ goal.completion_rate }}%;" 
           aria-valuenow="{{ goal.completion_rate }}" 
           aria-valuemin="0" 
           aria-valuemax="100">
        {{ goal.completion_rate }}%
      </div>
    </div>
  </div>
  {% endif %}
{% endblock detail_data_info_content %}

{% block detail_statistics_rows_content %}
  <tr>
    <th>子目标数</th>
    <td>{{ child_goals|length|default:0 }}</td>
  </tr>
  <tr>
    <th>关联计划</th>
    <td>{{ related_plans_count|default:0 }}</td>
  </tr>
  <tr>
    <th>进度记录</th>
    <td>{{ progress_records|length|default:0 }}</td>
  </tr>
  <tr>
    <th>状态变更</th>
    <td>{{ status_logs|length|default:0 }}</td>
  </tr>
{% endblock detail_statistics_rows_content %}

{% block module_extra_css %}
{{ block.super }}
<style>
  .badge-status {
    padding: 5px 12px;
    border-radius: 0;
    font-size: 16px;
    font-weight: 500;
  }
  
  .badge-draft {
    background: #FFF3E0;
    color: #F57C00;
    border: 1px solid #FFE0B2;
  }
  
  .badge-published {
    background: #E3F2FD;
    color: #1976D2;
    border: 1px solid #BBDEFB;
  }
  
  .badge-accepted {
    background: #E8F5E9;
    color: #388E3C;
    border: 1px solid #C8E6C9;
  }
  
  .badge-in_progress {
    background: #E3F2FD;
    color: #1976D2;
    border: 1px solid #BBDEFB;
  }
  
  .badge-completed {
    background: #E8F5E9;
    color: #2E7D32;
    border: 1px solid #C8E6C9;
  }
  
  .badge-cancelled {
    background: #FFEBEE;
    color: #C62828;
    border: 1px solid #FFCDD2;
  }
</style>
{% endblock module_extra_css %}
