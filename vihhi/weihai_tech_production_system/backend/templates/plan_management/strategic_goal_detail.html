{% extends "plan_management/_base.html" %}
{% load static %}

{% block pm_title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
    .info-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
        margin-bottom: 20px;
    }
    .info-card h5 {
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--vh-primary);
        font-weight: 600;
        color: #1f2937;
        font-size: 16px;
    }
    .info-row {
        display: flex;
        padding: 12px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .info-row:last-child {
        border-bottom: none;
    }
    .info-label {
        width: 150px;
        font-weight: 500;
        color: #6b7280;
        flex-shrink: 0;
    }
    .info-value {
        flex: 1;
        color: #1f2937;
    }
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
    }
    .status-draft { background: #e9ecef; color: #495057; }
    .status-published { background: #cfe2ff; color: #084298; }
    .status-in_progress { background: #fff3cd; color: #856404; }
    .status-completed { background: #d1e7dd; color: #0f5132; }
    .status-cancelled { background: #f8d7da; color: #842029; }
    .progress-bar-container {
        width: 200px;
        height: 24px;
        background: #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s;
    }
    .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 12px;
        font-weight: 600;
        color: #000;
        z-index: 1;
    }
</style>
{% endblock %}

{% block pm_content %}
<div class="container-fluid py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                {{ goal.name }}
            </h2>
            <p class="text-muted mb-0 mt-1">{{ goal.goal_number }}</p>
        </div>
        <div class="btn-group">
            <a href="{% url 'plan_pages:strategic_goal_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>è¿”å›åˆ—è¡¨
            </a>
            {% if can_edit %}
            <a href="{% url 'plan_pages:strategic_goal_edit' goal.id %}" class="btn btn-primary">
                <i class="bi bi-pencil me-1"></i>ç¼–è¾‘
            </a>
            {% endif %}
            <a href="{% url 'plan_pages:strategic_goal_track' goal.id %}" class="btn btn-info">
                <i class="bi bi-graph-up me-1"></i>è·Ÿè¸ª
            </a>
            <a href="{% url 'plan_pages:strategic_goal_decompose' goal.id %}" class="btn btn-success">
                <i class="bi bi-diagram-3 me-1"></i>åˆ†è§£
            </a>
            {% if can_delete %}
            <a href="{% url 'plan_pages:strategic_goal_delete' goal.id %}" class="btn btn-danger">
                <i class="bi bi-trash me-1"></i>åˆ é™¤
            </a>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        
        <div class="col-md-8">
            
            <div class="info-card">
                <h5>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h5>
                <div class="info-row">
                    <div class="info-label">ç›®æ ‡ç¼–å·</div>
                    <div class="info-value"><code>{{ goal.goal_number }}</code></div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç›®æ ‡åç§°</div>
                    <div class="info-value"><strong>{{ goal.name }}</strong></div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç›®æ ‡ç±»å‹</div>
                    <div class="info-value">{{ goal.get_goal_type_display }}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç›®æ ‡å‘¨æœŸ</div>
                    <div class="info-value">{{ goal.get_goal_period_display }}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç›®æ ‡çŠ¶æ€</div>
                    <div class="info-value">
                        <span class="status-badge status-{{ goal.status }}">
                            {{ goal.get_status_display }}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h5>ğŸ“Š ç›®æ ‡æŒ‡æ ‡</h5>
                <div class="info-row">
                    <div class="info-label">æŒ‡æ ‡åç§°</div>
                    <div class="info-value">{{ goal.indicator_name }}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">æŒ‡æ ‡ç±»å‹</div>
                    <div class="info-value">{{ goal.get_indicator_type_display }}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">æŒ‡æ ‡å•ä½</div>
                    <div class="info-value">{{ goal.indicator_unit|default:"-" }}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç›®æ ‡å€¼</div>
                    <div class="info-value">
                        <strong>{{ goal.target_value }}</strong>
                        {% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">å½“å‰å€¼</div>
                    <div class="info-value">
                        <strong>{{ goal.current_value }}</strong>
                        {% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-label">å®Œæˆç‡</div>
                    <div class="info-value">
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: {{ goal.completion_rate }}%"></div>
                            <span class="progress-text">{{ goal.completion_rate }}%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h5>ğŸ“ ç›®æ ‡æè¿°</h5>
                <div class="info-row">
                    <div class="info-label">ç›®æ ‡æè¿°</div>
                    <div class="info-value">{{ goal.description|linebreaks }}</div>
                </div>
                {% if goal.background %}
                <div class="info-row">
                    <div class="info-label">ç›®æ ‡èƒŒæ™¯</div>
                    <div class="info-value">{{ goal.background|linebreaks }}</div>
                </div>
                {% endif %}
                {% if goal.significance %}
                <div class="info-row">
                    <div class="info-label">ç›®æ ‡æ„ä¹‰</div>
                    <div class="info-value">{{ goal.significance|linebreaks }}</div>
                </div>
                {% endif %}
            </div>
            
            <div class="info-card">
                <h5>ğŸ“… æ—¶é—´ä¿¡æ¯</h5>
                <div class="info-row">
                    <div class="info-label">å¼€å§‹æ—¥æœŸ</div>
                    <div class="info-value">{{ goal.start_date }}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç»“æŸæ—¥æœŸ</div>
                    <div class="info-value">{{ goal.end_date }}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç›®æ ‡å‘¨æœŸ</div>
                    <div class="info-value">{{ goal.duration_days }} å¤©</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            
            <div class="info-card">
                <h5>ğŸ‘¤ è´£ä»»äººä¿¡æ¯</h5>
                <div class="info-row">
                    <div class="info-label">è´Ÿè´£äºº</div>
                    <div class="info-value">
                        <strong>{{ goal.responsible_person.get_full_name|default:goal.responsible_person.username }}</strong>
                    </div>
                </div>
                {% if goal.responsible_department %}
                <div class="info-row">
                    <div class="info-label">è´Ÿè´£éƒ¨é—¨</div>
                    <div class="info-value">{{ goal.responsible_department.name }}</div>
                </div>
                {% endif %}
                {% if goal.participants.exists %}
                <div class="info-row">
                    <div class="info-label">å‚ä¸äººå‘˜</div>
                    <div class="info-value">
                        {% for participant in goal.participants.all %}
                        <span class="badge bg-secondary me-1">{{ participant.get_full_name|default:participant.username }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="info-card">
                <h5>ğŸ”— å…³è”ä¿¡æ¯</h5>
                {% if goal.parent_goal %}
                <div class="info-row">
                    <div class="info-label">ä¸Šçº§ç›®æ ‡</div>
                    <div class="info-value">
                        <a href="{% url 'plan_pages:strategic_goal_detail' goal.parent_goal.id %}">
                            {{ goal.parent_goal.name }}
                        </a>
                    </div>
                </div>
                {% endif %}
                {% if goal.child_goals.exists %}
                <div class="info-row">
                    <div class="info-label">ä¸‹çº§ç›®æ ‡</div>
                    <div class="info-value">
                        <span class="badge bg-info">{{ goal.child_goals.count }} ä¸ª</span>
                        <a href="{% url 'plan_pages:strategic_goal_decompose' goal.id %}" class="ms-2 small">æŸ¥çœ‹è¯¦æƒ…</a>
                    </div>
                </div>
                {% endif %}
                {% if goal.related_projects.exists %}
                <div class="info-row">
                    <div class="info-label">å…³è”é¡¹ç›®</div>
                    <div class="info-value">
                        {% for project in goal.related_projects.all %}
                        <span class="badge bg-primary me-1">{{ project.name }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% if related_plans_count > 0 %}
                <div class="info-row">
                    <div class="info-label">å…³è”è®¡åˆ’</div>
                    <div class="info-value">
                        <span class="badge bg-warning">{{ related_plans_count }} ä¸ª</span>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="info-card">
                <h5>âš–ï¸ æƒé‡ä¿¡æ¯</h5>
                <div class="info-row">
                    <div class="info-label">ç›®æ ‡æƒé‡</div>
                    <div class="info-value">
                        <strong>{{ goal.weight }}%</strong>
                    </div>
                </div>
                {% if goal.weight_description %}
                <div class="info-row">
                    <div class="info-label">æƒé‡è¯´æ˜</div>
                    <div class="info-value">{{ goal.weight_description|linebreaks }}</div>
                </div>
                {% endif %}
            </div>
            
            <div class="info-card">
                <h5>â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</h5>
                <div class="info-row">
                    <div class="info-label">åˆ›å»ºäºº</div>
                    <div class="info-value">{{ goal.created_by.get_full_name|default:goal.created_by.username }}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">åˆ›å»ºæ—¶é—´</div>
                    <div class="info-value">{{ goal.created_time|date:"Y-m-d H:i" }}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">æ›´æ–°æ—¶é—´</div>
                    <div class="info-value">{{ goal.updated_time|date:"Y-m-d H:i" }}</div>
                </div>
            </div>
        </div>
    </div>
    
    {% if progress_records %}
    <div class="info-card mt-4">
        <h5>ğŸ“ˆ æœ€è¿‘è¿›åº¦è®°å½•</h5>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>è®°å½•æ—¶é—´</th>
                        <th>å½“å‰å€¼</th>
                        <th>å®Œæˆç‡</th>
                        <th>è¿›åº¦è¯´æ˜</th>
                        <th>è®°å½•äºº</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in progress_records %}
                    <tr>
                        <td>{{ record.recorded_time|date:"Y-m-d H:i" }}</td>
                        <td>{{ record.current_value }}{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}</td>
                        <td>{{ record.completion_rate }}%</td>
                        <td>{{ record.progress_description|truncatewords:20 }}</td>
                        <td>{{ record.recorded_by.get_full_name|default:record.recorded_by.username }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
