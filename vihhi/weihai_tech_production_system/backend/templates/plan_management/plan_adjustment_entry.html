{% extends "shared/list_page_base.html" %}
{% load static %}

{% block page_title %}è®¡åˆ’è°ƒæ•´åˆ—è¡¨{% endblock page_title %}
{% block page_subtitle %}é€‰æ‹©è¦ç”³è¯·è°ƒæ•´çš„è®¡åˆ’{% endblock page_subtitle %}

{% block list_stats_content %}
  <div class="row g-3">
    <div class="col-md-4">
      <div class="list-stat-card">
        <div class="list-stat-label">å¯è°ƒæ•´è®¡åˆ’æ€»æ•°</div>
        <div class="list-stat-value">{{ total_count|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="list-stat-card">
        <div class="list-stat-label">å¯ç”³è¯·è°ƒæ•´</div>
        <div class="list-stat-value">{{ can_apply_count|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="list-stat-card">
        <div class="list-stat-label">å¾…å®¡æ‰¹ä¸­</div>
        <div class="list-stat-value">{{ pending_count|default:0 }}</div>
      </div>
    </div>
  </div>
{% endblock list_stats_content %}

{% block list_filters_content %}
  <div class="col-md-3">
    <label class="form-label">æœç´¢</label>
    <input type="text" name="search" class="form-control" value="{{ search }}" placeholder="è®¡åˆ’ç¼–å·ã€åç§°ã€è´Ÿè´£äºº">
  </div>
  <div class="col-md-2">
    <label class="form-label">çŠ¶æ€</label>
    <select name="status" class="form-select">
      <option value="">å…¨éƒ¨çŠ¶æ€</option>
      {% for value, label in STATUS_CHOICES %}
      <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">è®¡åˆ’å±‚çº§</label>
    <select name="level" class="form-select">
      <option value="">å…¨éƒ¨å±‚çº§</option>
      {% for value, label in LEVEL_CHOICES %}
      <option value="{{ value }}" {% if level_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">è®¡åˆ’å‘¨æœŸ</label>
    <select name="plan_period" class="form-select">
      <option value="">å…¨éƒ¨å‘¨æœŸ</option>
      {% for value, label in PLAN_PERIOD_CHOICES %}
      <option value="{{ value }}" {% if plan_period_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">è´Ÿè´£äºº</label>
    <select name="responsible" class="form-select">
      <option value="">å…¨éƒ¨è´Ÿè´£äºº</option>
      {% for u in all_responsible_persons %}
      <option value="{{ u.id }}" {% if responsible_filter|stringformat:"s" == u.id|stringformat:"s" %}selected{% endif %}>
        {{ u.get_full_name|default:u.username }}
      </option>
      {% endfor %}
    </select>
  </div>
{% endblock list_filters_content %}

{% block list_table_headers %}
  <th>è®¡åˆ’ç¼–å·</th>
  <th>è®¡åˆ’åç§°</th>
  <th>è®¡åˆ’å±‚çº§</th>
  <th>è®¡åˆ’å‘¨æœŸ</th>
  <th>è´Ÿè´£äºº</th>
  <th>æ—¶é—´èŒƒå›´</th>
  <th>è¿›åº¦</th>
  <th>çŠ¶æ€</th>
  <th>æ“ä½œ</th>
{% endblock list_table_headers %}

{% block list_table_rows %}
  {% for item in page_obj %}
  {% with plan=item.plan can_apply=item.can_apply has_pending_adjustment=item.has_pending_adjustment %}
  <tr>
    <td><code>{{ plan.plan_number }}</code></td>
    <td>
      <a href="{% url 'plan_pages:plan_detail' plan.id %}" class="text-dark text-decoration-none fw-medium">
        {{ plan.name }}
      </a>
    </td>
    <td>{{ plan.get_level_display }}</td>
    <td>{{ plan.get_plan_period_display }}</td>
    <td>
      {{ plan.responsible_person.get_full_name|default:plan.responsible_person.username }}
      {% if plan.responsible_department %}
      <div style="font-size: 12px; color: #999999;">{{ plan.responsible_department.name }}</div>
      {% endif %}
    </td>
    <td>
      {% if plan.start_time and plan.end_time %}
      <div style="font-size: 12px; color: #666666;">
        {{ plan.start_time|date:"Y-m-d" }} ~ {{ plan.end_time|date:"Y-m-d" }}
      </div>
      {% else %}
      <span style="color: #999999;">-</span>
      {% endif %}
    </td>
    <td>
      <div class="list-progress">
        <div class="list-progress-fill" style="width: {{ plan.completion_rate }}%"></div>
        <span class="list-progress-text">{{ plan.completion_rate }}%</span>
      </div>
    </td>
    <td>
      <span class="list-badge list-badge-{{ plan.status }}">{{ plan.get_status_display }}</span>
    </td>
    <td>
      <div class="btn-group btn-group-sm">
        {% if can_apply %}
          {% if has_pending_adjustment %}
            <span class="btn btn-sm btn-secondary" style="opacity: 0.7; cursor: not-allowed;" title="å·²æœ‰å¾…å®¡æ‰¹çš„è°ƒæ•´ç”³è¯·">å®¡æ‰¹ä¸­</span>
          {% else %}
            <a href="{% url 'plan_pages:plan_adjustment_create' plan.id %}" class="btn btn-sm btn-primary" title="ç”³è¯·è°ƒæ•´">ç”³è¯·è°ƒæ•´</a>
          {% endif %}
        {% else %}
          <span class="btn btn-sm" style="opacity: 0.5; cursor: not-allowed;" title="æ‚¨æ²¡æœ‰æƒé™ç”³è¯·è°ƒæ•´è¯¥è®¡åˆ’">æ— æƒé™</span>
        {% endif %}
        <a href="{% url 'plan_pages:plan_detail' plan.id %}" class="btn btn-sm btn-secondary" title="æŸ¥çœ‹è¯¦æƒ…">æŸ¥çœ‹</a>
      </div>
    </td>
  </tr>
  {% endwith %}
  {% empty %}
  <tr>
    <td colspan="9" class="list-empty-state">
      <div class="list-empty-state-icon">ğŸ“</div>
      <div class="list-empty-state-text">æš‚æ— å¯ä»¥ç”³è¯·è°ƒæ•´çš„è®¡åˆ’</div>
      <div class="list-empty-state-hint">è¯·å…ˆåˆ›å»ºå¹¶å‘å¸ƒè®¡åˆ’</div>
    </td>
  </tr>
  {% endfor %}
{% endblock list_table_rows %}
