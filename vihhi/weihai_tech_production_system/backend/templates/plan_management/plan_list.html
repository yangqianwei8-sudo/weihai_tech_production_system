{% extends "shared/list_page_base.html" %}
{% load static %}

{% block pm_title %}è®¡åˆ’åˆ—è¡¨{% endblock pm_title %}
{% block pm_subtitle %}æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰è®¡åˆ’{% endblock pm_subtitle %}


{% block list_stats_content %}
  {# ç»Ÿè®¡å¡ç‰‡ - ç›´æ¥æ”¾åœ¨ list-page-stats ä¸­ï¼ŒCSSä¼šè‡ªåŠ¨ä¸€è¡Œæ’åˆ— #}
  <div class="list-stat-card">
    <div class="list-stat-label">è®¡åˆ’æ€»æ•°</div>
    <div class="list-stat-value">{{ total_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">è‰ç¨¿</div>
    <div class="list-stat-value">{{ draft_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">æ‰§è¡Œä¸­</div>
    <div class="list-stat-value">{{ in_progress_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">å·²å®Œæˆ</div>
    <div class="list-stat-value">{{ completed_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">å·²å–æ¶ˆ</div>
    <div class="list-stat-value">{{ cancelled_count|default:0 }}</div>
  </div>
{% endblock list_stats_content %}

{% block list_filters_content %}
  {# ç­›é€‰å™¨åŒºåŸŸ #}
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">æœç´¢</label>
    <input type="text" name="search" class="form-control" value="{{ search }}" placeholder="è®¡åˆ’ç¼–å·ã€åç§°ã€è´Ÿè´£äºº">
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">çŠ¶æ€</label>
    <select name="status" class="form-select">
      <option value="">å…¨éƒ¨çŠ¶æ€</option>
      {% for value, label in status_options %}
      <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">è®¡åˆ’ç±»å‹</label>
    <select name="plan_type" class="form-select">
      <option value="">å…¨éƒ¨ç±»å‹</option>
      <option value="personal" {% if plan_type_filter == 'personal' %}selected{% endif %}>ä¸ªäººè®¡åˆ’</option>
      <option value="department" {% if plan_type_filter == 'department' %}selected{% endif %}>éƒ¨é—¨è®¡åˆ’</option>
      <option value="company" {% if plan_type_filter == 'company' %}selected{% endif %}>å…¬å¸è®¡åˆ’</option>
      <option value="project" {% if plan_type_filter == 'project' %}selected{% endif %}>é¡¹ç›®è®¡åˆ’</option>
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">è®¡åˆ’å‘¨æœŸ</label>
    <select name="plan_period" class="form-select">
      <option value="">å…¨éƒ¨å‘¨æœŸ</option>
      <option value="daily" {% if plan_period_filter == 'daily' %}selected{% endif %}>æ—¥è®¡åˆ’</option>
      <option value="weekly" {% if plan_period_filter == 'weekly' %}selected{% endif %}>å‘¨è®¡åˆ’</option>
      <option value="monthly" {% if plan_period_filter == 'monthly' %}selected{% endif %}>æœˆè®¡åˆ’</option>
      <option value="quarterly" {% if plan_period_filter == 'quarterly' %}selected{% endif %}>å­£åº¦è®¡åˆ’</option>
      <option value="yearly" {% if plan_period_filter == 'yearly' %}selected{% endif %}>å¹´è®¡åˆ’</option>
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">è´Ÿè´£äºº</label>
    <select name="responsible_person" class="form-select">
      <option value="">å…¨éƒ¨è´Ÿè´£äºº</option>
      {% for u in responsible_options %}
      <option value="{{ u.id }}" {% if responsible_filter|stringformat:"s" == u.id|stringformat:"s" %}selected{% endif %}>
        {{ u.get_full_name|default:u.username }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">å…³è”ç›®æ ‡</label>
    <select name="related_goal" class="form-select">
      <option value="">å…¨éƒ¨ç›®æ ‡</option>
      {% for goal in all_goals %}
      <option value="{{ goal.id }}" {% if related_goal_filter|stringformat:"s" == goal.id|stringformat:"s" %}selected{% endif %}>
        {{ goal.name|truncatewords:5 }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">å¼€å§‹æ—¥æœŸ</label>
    <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">ç»“æŸæ—¥æœŸ</label>
    <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
  </div>
{% endblock list_filters_content %}

{% block list_table_checkbox_header %}
  <th style="width: 50px;">
    <input type="checkbox" id="selectAll" class="form-check-input" title="å…¨é€‰">
  </th>
{% endblock list_table_checkbox_header %}

{% block list_table_headers %}
  <th>è®¡åˆ’ç¼–å·</th>
  <th>è®¡åˆ’åç§°</th>
  <th>è®¡åˆ’ç±»å‹</th>
  <th>è®¡åˆ’å‘¨æœŸ</th>
  <th>å…³è”ç›®æ ‡</th>
  <th>è´Ÿè´£äºº</th>
  <th>æ—¶é—´èŒƒå›´</th>
  <th>è¿›åº¦</th>
  <th>çŠ¶æ€</th>
  <th>æ“ä½œ</th>
{% endblock list_table_headers %}

{% block list_table_rows %}
  {% if page_obj %}
    {% for plan in page_obj %}
    <tr>
      <td>
        <input type="checkbox" class="form-check-input row-checkbox" name="item_ids" value="{{ plan.id }}" id="item_{{ plan.id }}">
      </td>
      <td><code>{{ plan.plan_number }}</code></td>
      <td>
        <a href="{% url 'plan_pages:plan_detail' plan.id %}" class="text-dark text-decoration-none fw-medium">
          {{ plan.name }}
        </a>
      </td>
      <td>{{ plan.get_level_display }}</td>
      <td>{{ plan.get_plan_period_display }}</td>
      <td>
        {% if plan.related_goal %}
        <a href="{% url 'plan_pages:strategic_goal_detail' plan.related_goal.id %}" class="text-muted text-decoration-none">
          {{ plan.related_goal.name|truncatewords:5 }}
        </a>
        {% else %}
        <span class="text-muted">-</span>
        {% endif %}
      </td>
      <td>{{ plan.responsible_person.get_full_name|default:plan.responsible_person.username }}</td>
      <td>
        <small class="text-muted">
          {{ plan.start_time|date:"Y-m-d" }}<br>
          è‡³ {{ plan.end_time|date:"Y-m-d" }}
        </small>
      </td>
      <td>
        <div class="d-flex align-items-center gap-2">
          <div class="flex-grow-1" style="height: 8px; background: #F0F0F0;">
            <div style="height: 100%; background: #333333; width: {{ plan.progress }}%;"></div>
          </div>
          <small class="text-muted">{{ plan.progress }}%</small>
        </div>
      </td>
      <td>
        <span class="badge">{{ plan.get_status_display|default:plan.status }}</span>
      </td>
      <td>
        <div class="list-page-table-actions">
          <a href="{% url 'plan_pages:plan_detail' plan.id %}" class="action-view" title="æŸ¥çœ‹">
            <i class="bi bi-eye"></i>
          </a>
          {% if plan.can_edit %}
          <span class="action-separator">|</span>
          <a href="{% url 'plan_pages:plan_edit' plan.id %}" class="action-edit" title="ç¼–è¾‘">
            <i class="bi bi-pencil"></i>
          </a>
          {% endif %}
          {% if plan.can_delete %}
          <span class="action-separator">|</span>
          <a href="{% url 'plan_pages:plan_delete' plan.id %}" class="action-delete" title="åˆ é™¤" onclick="return confirm('ç¡®å®šè¦åˆ é™¤æ­¤è®¡åˆ’å—ï¼Ÿ');">
            <i class="bi bi-trash"></i>
          </a>
          {% endif %}
        </div>
      </td>
    </tr>
    {% endfor %}
  {% else %}
    <tr>
      <td colspan="11" class="list-empty">
        <div class="list-empty-icon">ğŸ“‹</div>
        <div class="list-empty-text">æš‚æ— è®¡åˆ’æ•°æ®</div>
      </td>
    </tr>
  {% endif %}
{% endblock list_table_rows %}

{% block list_empty_hint %}
  <div class="list-empty-hint">è¯·åˆ›å»ºç¬¬ä¸€ä¸ªè®¡åˆ’å¼€å§‹ä½¿ç”¨</div>
{% endblock list_empty_hint %}

{% block extra_js %}
  {{ block.super }}
  
  <!-- é…ç½®åˆ—è¡¨ç­›é€‰åŠŸèƒ½ -->
  <script>
  window.listFiltersConfig = {
    selectFieldNames: ['status', 'plan_type', 'plan_period', 'responsible_person', 'related_goal'],
    dateStartFieldName: 'date_from',
    dateEndFieldName: 'date_to'
  };
  </script>
  <!-- å¼•å…¥åˆ—è¡¨ç­›é€‰åŠŸèƒ½æ¨¡å— -->
  <script src="{% static 'js/list-filters.js' %}"></script>
  
  <!-- è®¡åˆ’åˆ—è¡¨ä¸“ç”¨å¤é€‰æ¡†åˆå§‹åŒ– - ç¡®ä¿å¤é€‰æ¡†åŠŸèƒ½å®Œå…¨æ­£å¸¸ -->
  <script>
  (function() {
    'use strict';
    
    // åˆå§‹åŒ–å¤é€‰æ¡†åŠŸèƒ½
    function initPlanListCheckboxes() {
      const selectAll = document.getElementById('selectAll');
      const rowCheckboxes = document.querySelectorAll('.row-checkbox');
      
      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (!selectAll) {
        console.warn('[è®¡åˆ’åˆ—è¡¨] æœªæ‰¾åˆ°å…¨é€‰å¤é€‰æ¡†');
        return;
      }
      
      if (rowCheckboxes.length === 0) {
        console.warn('[è®¡åˆ’åˆ—è¡¨] æœªæ‰¾åˆ°è¡Œå¤é€‰æ¡†');
        return;
      }
      
      console.log('[è®¡åˆ’åˆ—è¡¨] æ‰¾åˆ°', rowCheckboxes.length, 'ä¸ªè¡Œå¤é€‰æ¡†ï¼Œå¼€å§‹åˆå§‹åŒ–');
      
      // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œå…ˆç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
      if (selectAll.dataset.planListInitialized === 'true') {
        console.log('[è®¡åˆ’åˆ—è¡¨] å¤é€‰æ¡†å·²åˆå§‹åŒ–ï¼Œè·³è¿‡');
        return;
      }
      
      // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
      selectAll.dataset.planListInitialized = 'true';
      
      // æ›´æ–°å…¨é€‰çŠ¶æ€çš„å‡½æ•°
      function updateSelectAllState() {
        const allChecked = rowCheckboxes.length > 0 && Array.from(rowCheckboxes).every(function(cb) {
          return cb.checked;
        });
        const someChecked = Array.from(rowCheckboxes).some(function(cb) {
          return cb.checked;
        });
        
        selectAll.checked = allChecked;
        selectAll.indeterminate = someChecked && !allChecked;
        
        console.log('[è®¡åˆ’åˆ—è¡¨] å…¨é€‰çŠ¶æ€æ›´æ–°:', {
          allChecked: allChecked,
          someChecked: someChecked,
          checkedCount: Array.from(rowCheckboxes).filter(function(cb) { return cb.checked; }).length
        });
      }
      
      // æ›´æ–°é€‰ä¸­æ•°é‡çš„å‡½æ•°
      function updateSelectedCount() {
        const checked = document.querySelectorAll('.row-checkbox:checked');
        const count = checked.length;
        console.log('[è®¡åˆ’åˆ—è¡¨] å½“å‰é€‰ä¸­æ•°é‡:', count);
        
        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
        const event = new CustomEvent('checkboxSelectionChanged', {
          detail: { 
            count: count, 
            selectedIds: Array.from(checked).map(function(cb) {
              return cb.value;
            })
          }
        });
        document.dispatchEvent(event);
      }
      
      // ç»‘å®šå…¨é€‰å¤é€‰æ¡†äº‹ä»¶ - ä½¿ç”¨ change äº‹ä»¶
      selectAll.addEventListener('change', function(e) {
        e.stopPropagation();
        const checked = this.checked;
        console.log('[è®¡åˆ’åˆ—è¡¨] å…¨é€‰å¤é€‰æ¡†çŠ¶æ€æ”¹å˜:', checked);
        
        // æ›´æ–°æ‰€æœ‰è¡Œå¤é€‰æ¡†
        rowCheckboxes.forEach(function(cb) {
          cb.checked = checked;
        });
        
        updateSelectedCount();
      });
      
      // ä¹Ÿç»‘å®š click äº‹ä»¶ä½œä¸ºå¤‡ç”¨
      selectAll.addEventListener('click', function(e) {
        e.stopPropagation();
        // ä½¿ç”¨ setTimeout ç¡®ä¿è·å–åˆ°æ­£ç¡®çš„çŠ¶æ€
        setTimeout(function() {
          const checked = selectAll.checked;
          console.log('[è®¡åˆ’åˆ—è¡¨] å…¨é€‰å¤é€‰æ¡†ç‚¹å‡»åçŠ¶æ€:', checked);
          rowCheckboxes.forEach(function(cb) {
            cb.checked = checked;
          });
          updateSelectedCount();
        }, 0);
      });
      
      // ç»‘å®šæ¯ä¸ªè¡Œå¤é€‰æ¡†çš„äº‹ä»¶
      rowCheckboxes.forEach(function(cb, index) {
        // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
        if (cb.dataset.planListInitialized === 'true') {
          return;
        }
        cb.dataset.planListInitialized = 'true';
        
        // ä½¿ç”¨ change äº‹ä»¶
        cb.addEventListener('change', function(e) {
          e.stopPropagation();
          console.log('[è®¡åˆ’åˆ—è¡¨] è¡Œå¤é€‰æ¡†', index, 'çŠ¶æ€æ”¹å˜:', this.checked);
          updateSelectAllState();
          updateSelectedCount();
        });
        
        // ä¹Ÿç»‘å®š click äº‹ä»¶ä½œä¸ºå¤‡ç”¨
        cb.addEventListener('click', function(e) {
          e.stopPropagation();
          setTimeout(function() {
            updateSelectAllState();
            updateSelectedCount();
          }, 0);
        });
      });
      
      // å¯¼å‡ºå…¨å±€å‡½æ•°
      window.getSelectedIds = function() {
        const checked = document.querySelectorAll('.row-checkbox:checked');
        return Array.from(checked).map(function(cb) {
          return cb.value;
        });
      };
      
      window.clearSelection = function() {
        selectAll.checked = false;
        selectAll.indeterminate = false;
        rowCheckboxes.forEach(function(cb) {
          cb.checked = false;
        });
        updateSelectedCount();
      };
      
      window.updateSelectedCount = updateSelectedCount;
      window.updateSelectAllState = updateSelectAllState;
      
      // åˆå§‹åŒ–çŠ¶æ€
      updateSelectAllState();
      updateSelectedCount();
      
      console.log('[è®¡åˆ’åˆ—è¡¨] å¤é€‰æ¡†åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
    }
    
    // å¤šæ¬¡å°è¯•åˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
    function tryInit() {
      try {
        initPlanListCheckboxes();
      } catch (e) {
        console.error('[è®¡åˆ’åˆ—è¡¨] å¤é€‰æ¡†åˆå§‹åŒ–å¤±è´¥:', e);
      }
    }
    
    // ç«‹å³å°è¯•
    tryInit();
    
    // DOMContentLoadedæ—¶æ‰§è¡Œ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', tryInit);
    }
    
    // å»¶è¿Ÿæ‰§è¡Œ
    setTimeout(tryInit, 100);
    setTimeout(tryInit, 500);
    setTimeout(tryInit, 1000);
  })();
  </script>
{% endblock extra_js %}
