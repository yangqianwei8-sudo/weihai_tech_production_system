{% extends "plan_management/_base.html" %}
{% load static %}

{% block pm_title %}è®¡åˆ’è¯¦æƒ…{% endblock %}
{% block pm_subtitle %}<span class="pm-subtitle">{{ plan.name }}</span>{% endblock %}

{% block pm_actions %}
<a href="{% url 'plan_pages:plan_list' %}" class="list-btn">è¿”å›åˆ—è¡¨</a>
{% if can_edit %}
<a href="{% url 'plan_pages:plan_edit' plan.id %}" class="list-btn list-btn-primary">ç¼–è¾‘</a>
{% endif %}
{% if can_delete %}
<a href="{% url 'plan_pages:plan_delete' plan.id %}" class="list-btn">åˆ é™¤</a>
{% endif %}
{% if can_submit_approval %}
<a href="{% url 'plan_pages:plan_request_start' plan.id %}" class="list-btn">æäº¤å¯åŠ¨</a>
{% endif %}
{% if can_request_adjustment %}
<a href="{% url 'plan_pages:plan_adjustment_create' plan.id %}" class="list-btn" style="margin-right: 8px;">ç”³è¯·è°ƒæ•´</a>
{% endif %}
{% if can_request_cancel %}
<a href="{% url 'plan_pages:plan_request_cancel' plan.id %}" class="list-btn">ç”³è¯·å–æ¶ˆ</a>
{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/list_layout.css' %}">
<style>
  .detail-card {
    background: #FFFFFF;
    border: 1px solid #E0E0E0;
    border-radius: 0;
    padding: 24px;
    margin-bottom: 16px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .detail-card-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--vh-primary); /* ä¸»é¢˜æ·±è“è‰² */
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #E0E0E0;
  }
  
  .detail-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }
  
  .detail-info-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  
  .detail-info-label {
    font-size: 12px;
    color: #666666;
    font-weight: 400;
  }
  
  .detail-info-value {
    font-size: 14px;
    color: var(--vh-primary); /* ä¸»é¢˜æ·±è“è‰² */
    font-weight: 500;
  }
  
  .detail-info-value strong {
    font-weight: 600;
    color: var(--vh-primary); /* ä¸»é¢˜æ·±è“è‰² */
  }
  
  .detail-full-width {
    grid-column: 1 / -1;
  }
  
  .list-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid;
  }
  
  .list-badge-draft { 
    background: #F5F5F5; 
    color: #666666; 
    border-color: #E0E0E0; 
  }
  .list-badge-in_progress { 
    background: #E8E8E8; 
    color: var(--vh-primary); /* ä¸»é¢˜æ·±è“è‰² */ 
    border-color: #CCCCCC; 
  }
  .list-badge-completed { 
    background: #E8E8E8; 
    color: var(--vh-primary); /* ä¸»é¢˜æ·±è“è‰² */ 
    border-color: #CCCCCC; 
  }
  .list-badge-cancelled { 
    background: #F5F5F5; 
    color: #999999; 
    border-color: #E0E0E0; 
  }
  
  .progress-bar-container {
    width: 100%;
    height: 24px;
    background: #E0E0E0;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    margin-top: 8px;
  }
  
  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #6c757d, #adb5bd);
    transition: width 0.3s;
  }
  
  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    font-weight: 600;
    color: var(--vh-primary); /* ä¸»é¢˜æ·±è“è‰² */
    z-index: 1;
  }
  
  .text-content {
    font-size: var(--font-size-base);
    font-family: inherit;
    color: var(--vh-primary); /* ä¸»é¢˜æ·±è“è‰² - ä¸ç³»ç»Ÿä¸»é¢˜ä¿æŒä¸€è‡´ */
    white-space: pre-wrap;
    line-height: 1.6;
  }
</style>
{% endblock %}

{% block pm_content %}
<div class="detail-card">
  <div class="detail-card-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>
  <div class="detail-info-grid">
    <div class="detail-info-item">
      <div class="detail-info-label">è®¡åˆ’ç¼–å·</div>
      <div class="detail-info-value"><code>{{ plan.plan_number }}</code></div>
    </div>
    
    <div class="detail-info-item">
      <div class="detail-info-label">è®¡åˆ’åç§°</div>
      <div class="detail-info-value"><strong>{{ plan.name }}</strong></div>
    </div>
    
    <div class="detail-info-item">
      <div class="detail-info-label">è®¡åˆ’çŠ¶æ€</div>
      <div class="detail-info-value">
        <span class="list-badge list-badge-{{ plan.status }}">
          {{ plan.get_status_display|default:plan.status }}
        </span>
      </div>
    </div>
    
    <div class="detail-info-item">
      <div class="detail-info-label">è®¡åˆ’ç±»å‹</div>
      <div class="detail-info-value">{{ plan.get_plan_type_display|default:plan.plan_type }}</div>
    </div>
    
    <div class="detail-info-item">
      <div class="detail-info-label">è®¡åˆ’å‘¨æœŸ</div>
      <div class="detail-info-value">{{ plan.get_plan_period_display|default:plan.plan_period }}</div>
    </div>
    
    <div class="detail-info-item">
      <div class="detail-info-label">ä¼˜å…ˆçº§</div>
      <div class="detail-info-value">{{ plan.get_priority_display|default:plan.priority|default:"-" }}</div>
    </div>
    
    {% if progress_percent is not None %}
    <div class="detail-info-item detail-full-width">
      <div class="detail-info-label">æ—¶é—´è¿›åº¦</div>
      <div class="detail-info-value">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span><strong>{{ progress_percent }}%</strong></span>
          <span style="font-size: 14px; color: #666666;">
            {{ plan.start_time|date:"Y-m-d" }} â†’ {{ plan.end_time|date:"Y-m-d" }}
          </span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: {{ progress_percent }}%"></div>
          <span class="progress-text">{{ progress_percent }}%</span>
        </div>
      </div>
    </div>
    {% endif %}
    
    <div class="detail-info-item">
      <div class="detail-info-label">å¼€å§‹æ—¶é—´</div>
      <div class="detail-info-value">{{ plan.start_time|date:"Y-m-d H:i"|default:"-" }}</div>
    </div>
    
    <div class="detail-info-item">
      <div class="detail-info-label">ç»“æŸæ—¶é—´</div>
      <div class="detail-info-value">{{ plan.end_time|date:"Y-m-d H:i"|default:"-" }}</div>
    </div>
    
    <div class="detail-info-item">
      <div class="detail-info-label">è´Ÿè´£äºº</div>
      <div class="detail-info-value">{% if plan.responsible_person %}{{ plan.responsible_person.get_full_name|default:plan.responsible_person.username }}{% else %}-{% endif %}</div>
    </div>
    
    <div class="detail-info-item">
      <div class="detail-info-label">è´Ÿè´£éƒ¨é—¨</div>
      <div class="detail-info-value">{{ plan.responsible_department.name|default:"-" }}</div>
    </div>
    
    <div class="detail-info-item">
      <div class="detail-info-label">å…³è”ç›®æ ‡</div>
      <div class="detail-info-value">
        {% if plan.related_goal %}
          <a href="{% url 'plan_pages:strategic_goal_detail' plan.related_goal.id %}">{{ plan.related_goal.name }}</a>
        {% else %}
          -
        {% endif %}
      </div>
    </div>
    
    {% if plan.related_project %}
    <div class="detail-info-item">
      <div class="detail-info-label">å…³è”é¡¹ç›®</div>
      <div class="detail-info-value">{{ plan.related_project.name|default:"-" }}</div>
    </div>
    {% endif %}
    
    {% if plan.budget %}
    <div class="detail-info-item">
      <div class="detail-info-label">é¢„ç®—</div>
      <div class="detail-info-value">{{ plan.budget|default:"-" }}</div>
    </div>
    {% endif %}
  </div>
</div>

{% if plan.content %}
<div class="detail-card">
  <div class="detail-card-title">ğŸ“ è®¡åˆ’å†…å®¹</div>
  <div class="text-content">{{ plan.content }}</div>
</div>
{% endif %}

{% if plan.plan_objective %}
<div class="detail-card">
  <div class="detail-card-title">ğŸ¯ è®¡åˆ’ç›®æ ‡</div>
  <div class="text-content">{{ plan.plan_objective }}</div>
</div>
{% endif %}

{% if plan.description %}
<div class="detail-card">
  <div class="detail-card-title">ğŸ“„ è®¡åˆ’æè¿°</div>
  <div class="text-content">{{ plan.description }}</div>
</div>
{% endif %}

{% if plan.acceptance_criteria %}
<div class="detail-card">
  <div class="detail-card-title">âœ… éªŒæ”¶æ ‡å‡†</div>
  <div class="text-content">{{ plan.acceptance_criteria }}</div>
</div>
{% endif %}

{% if child_plans %}
<div class="detail-card">
  <div class="detail-card-title">ğŸ“Š ä¸‹çº§è®¡åˆ’ ({{ child_plans|length }})</div>
  <div class="detail-info-grid">
    {% for child in child_plans %}
    <div class="detail-info-item">
      <div class="detail-info-label">
        <a href="{% url 'plan_pages:plan_detail' child.id %}">{{ child.plan_number }}</a>
      </div>
      <div class="detail-info-value">
        {{ child.name }}
        <span class="list-badge list-badge-{{ child.status }}" style="margin-left: 8px;">
          {{ child.get_status_display }}
        </span>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% if pending_decisions %}
<div class="detail-card">
  <div class="detail-card-title">â³ å¾…å®¡æ‰¹å†³ç­–</div>
  <div class="detail-info-grid">
    {% for decision in pending_decisions %}
    <div class="detail-info-item detail-full-width">
      <div class="detail-info-label">
        {{ decision.get_request_type_display }}
        {% if decision.requested_by %}({{ decision.requested_by.get_full_name|default:decision.requested_by.username }}){% endif %}
      </div>
      <div class="detail-info-value">
        <span style="font-size: 14px; color: #666666;">{{ decision.requested_at|date:"Y-m-d H:i" }}</span>
        {% if can_approve %}
        <div style="margin-top: 8px;">
          <a href="{% url 'plan_pages:decision_approve' decision.id %}" class="list-btn list-btn-primary" style="margin-right: 8px;">æ‰¹å‡†</a>
          <a href="{% url 'plan_pages:decision_reject' decision.id %}" class="list-btn">æ‹’ç»</a>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% if progress_records %}
<div class="detail-card">
  <div class="detail-card-title">ğŸ“ˆ è¿›åº¦è®°å½• (æœ€è¿‘10æ¡)</div>
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="border-bottom: 1px solid #E0E0E0;">
          <th style="padding: 8px; text-align: left; font-size: 12px; color: #666666;">è®°å½•æ—¶é—´</th>
          <th style="padding: 8px; text-align: left; font-size: 12px; color: #666666;">è¿›åº¦</th>
          <th style="padding: 8px; text-align: left; font-size: 12px; color: #666666;">è®°å½•äºº</th>
        </tr>
      </thead>
      <tbody>
        {% for record in progress_records %}
        <tr style="border-bottom: 1px solid #F5F5F5;">
          <td style="padding: 8px; font-size: 14px;">{{ record.recorded_time|date:"Y-m-d H:i" }}</td>
          <td style="padding: 8px; font-size: 14px;"><strong>{{ record.progress }}%</strong></td>
          <td style="padding: 8px; font-size: 14px;">{% if record.recorded_by %}{{ record.recorded_by.get_full_name|default:record.recorded_by.username }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% if status_logs %}
<div class="detail-card">
  <div class="detail-card-title">ğŸ“‹ çŠ¶æ€å˜æ›´è®°å½• (æœ€è¿‘10æ¡)</div>
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="border-bottom: 1px solid #E0E0E0;">
          <th style="padding: 8px; text-align: left; font-size: 12px; color: #666666;">å˜æ›´æ—¶é—´</th>
          <th style="padding: 8px; text-align: left; font-size: 12px; color: #666666;">çŠ¶æ€å˜æ›´</th>
          <th style="padding: 8px; text-align: left; font-size: 12px; color: #666666;">å˜æ›´äºº</th>
        </tr>
      </thead>
      <tbody>
        {% for log in status_logs %}
        <tr style="border-bottom: 1px solid #F5F5F5;">
          <td style="padding: 8px; font-size: 14px;">{{ log.changed_time|date:"Y-m-d H:i" }}</td>
          <td style="padding: 8px; font-size: 14px;">
            <span class="list-badge list-badge-{{ log.old_status }}">{{ log.get_old_status_display }}</span>
            â†’ 
            <span class="list-badge list-badge-{{ log.new_status }}">{{ log.get_new_status_display }}</span>
          </td>
          <td style="padding: 8px; font-size: 14px;">{% if log.changed_by %}{{ log.changed_by.get_full_name|default:log.changed_by.username }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% if issues %}
<div class="detail-card">
  <div class="detail-card-title">âš ï¸ é—®é¢˜åˆ—è¡¨ ({{ issues|length }})</div>
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="border-bottom: 1px solid #E0E0E0;">
          <th style="padding: 8px; text-align: left; font-size: 12px; color: #666666;">é—®é¢˜æ ‡é¢˜</th>
          <th style="padding: 8px; text-align: left; font-size: 12px; color: #666666;">ä¸¥é‡ç¨‹åº¦</th>
          <th style="padding: 8px; text-align: left; font-size: 12px; color: #666666;">çŠ¶æ€</th>
          <th style="padding: 8px; text-align: left; font-size: 12px; color: #666666;">è´Ÿè´£äºº</th>
        </tr>
      </thead>
      <tbody>
        {% for issue in issues %}
        <tr style="border-bottom: 1px solid #F5F5F5;">
          <td style="padding: 8px; font-size: 14px;">{{ issue.title }}</td>
          <td style="padding: 8px; font-size: 14px;">{{ issue.get_severity_display|default:issue.severity }}</td>
          <td style="padding: 8px; font-size: 14px;">{{ issue.get_status_display|default:issue.status }}</td>
          <td style="padding: 8px; font-size: 14px;">{% if issue.assigned_to %}{{ issue.assigned_to.get_full_name|default:issue.assigned_to.username }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% endblock %}
