{% extends "plan_management/base.html" %}
{% load static %}

{% block title %}{{ page_title }} - 维海科技信息化管理平台{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
    .plan-tree {
        margin-left: 0;
        padding-left: 0;
    }
    .plan-tree-item {
        list-style: none;
        margin: 12px 0;
        padding-left: 30px;
        position: relative;
    }
    .plan-tree-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 20px;
        width: 20px;
        height: 2px;
        background: #dee2e6;
    }
    .plan-tree-item::after {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 2px;
        height: 20px;
        background: #dee2e6;
    }
    .plan-card {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .plan-card.level-0 { border-left: 4px solid #142F5B; }
    .plan-card.level-1 { border-left: 4px solid #0d6efd; }
    .plan-card.level-2 { border-left: 4px solid #198754; }
    .plan-card.level-3 { border-left: 4px solid #ffc107; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                {{ plan.name }}
            </h2>
            <p class="text-muted mb-0 mt-1">计划分解：将计划分解为子计划和任务</p>
        </div>
        <div>
            <a href="{% url 'plan_pages:plan_detail' plan.id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>返回详情
            </a>
        </div>
    </div>
    
    <div class="row">
        <!-- 左侧：计划树 -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">计划分解树</h5>
                </div>
                <div class="card-body">
                    <ul class="plan-tree">
                        {% for plan_item, level in plan_tree %}
                        <li class="plan-tree-item">
                            <div class="plan-card level-{{ level }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-2">
                                            <a href="{% url 'plan_pages:plan_detail' plan_item.id %}" class="text-decoration-none">
                                                {{ plan_item.name }}
                                            </a>
                                        </h6>
                                        <div class="small text-muted mb-2">
                                            <span class="me-3"><code>{{ plan_item.plan_number }}</code></span>
                                            <span class="me-3">{{ plan_item.get_plan_type_display }}</span>
                                            <span class="badge bg-{% if plan_item.status == 'completed' %}success{% elif plan_item.status == 'in_progress' %}warning{% elif plan_item.status == 'cancelled' %}danger{% else %}secondary{% endif %}">
                                                {{ plan_item.get_status_display }}
                                            </span>
                                        </div>
                                        <div class="small">
                                            <span class="me-3">
                                                <strong>时间：</strong>{{ plan_item.start_time|date:"Y-m-d" }} ~ {{ plan_item.end_time|date:"Y-m-d" }}
                                            </span>
                                            <span>
                                                <strong>进度：</strong>{{ plan_item.progress }}%
                                            </span>
                                        </div>
                                        <div class="small mt-2">
                                            <strong>负责人：</strong>{{ plan_item.responsible_person.get_full_name|default:plan_item.responsible_person.username }}
                                            {% if plan_item.responsible_department %}
                                            <span class="ms-3">
                                                <strong>部门：</strong>{{ plan_item.responsible_department.name }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'plan_pages:plan_detail' plan_item.id %}" class="btn btn-outline-primary" title="查看">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{% url 'plan_pages:plan_execution_track' plan_item.id %}" class="btn btn-outline-info" title="跟踪">
                                            <i class="bi bi-graph-up"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 右侧：创建子计划 -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">创建子计划</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'plan_pages:plan_create' %}">
                        {% csrf_token %}
                        <input type="hidden" name="parent_plan_id" value="{{ plan.id }}">
                        
                        <div class="mb-3">
                            <label class="form-label required">计划名称</label>
                            <input type="text" name="name" class="form-control" required placeholder="请输入子计划名称">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">计划类型</label>
                            <select name="plan_type" class="form-select" required>
                                <option value="personal">个人计划</option>
                                <option value="department">部门计划</option>
                                <option value="company">公司计划</option>
                                <option value="project">项目计划</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">计划周期</label>
                            <select name="plan_period" class="form-select" required>
                                <option value="daily">日计划</option>
                                <option value="weekly">周计划</option>
                                <option value="monthly">月计划</option>
                                <option value="quarterly">季度计划</option>
                                <option value="yearly">年计划</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">负责人</label>
                            <select name="responsible_person" class="form-select" required>
                                <option value="">请选择负责人</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">负责部门</label>
                            <select name="responsible_department" class="form-select">
                                <option value="">请选择部门</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">关联战略目标</label>
                            <select name="related_goal" class="form-select" required>
                                <option value="">请选择战略目标</option>
                                <option value="{{ plan.related_goal.id }}" selected>{{ plan.related_goal.name }}</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">开始时间</label>
                            <input type="datetime-local" name="start_time" class="form-control" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">结束时间</label>
                            <input type="datetime-local" name="end_time" class="form-control" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">计划内容</label>
                            <textarea name="content" class="form-control" rows="4" required placeholder="请输入计划内容"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label required">计划目标</label>
                            <textarea name="plan_objective" class="form-control" rows="3" required placeholder="请输入计划目标"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-plus-circle me-1"></i>创建子计划
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- 统计信息 -->
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">分解统计</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>子计划数量：</strong>{{ plan.get_child_plans_count }}
                    </div>
                    <div class="mb-2">
                        <strong>总层级数：</strong>{{ plan_tree|length }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
