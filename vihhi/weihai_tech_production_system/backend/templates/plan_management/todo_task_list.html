{% extends "shared/list_page_base.html" %}
{% load static %}

{% block pm_title %}å¾…åŠäº‹é¡¹åˆ—è¡¨{% endblock pm_title %}
{% block pm_subtitle %}æŸ¥çœ‹å¹¶é—­ç¯æˆ‘çš„è®¡åˆ’å¾…åŠï¼ˆTodoTaskï¼‰{% endblock pm_subtitle %}

{% block list_page_actions %}{% endblock list_page_actions %}

{% block list_stats_content %}
  <div class="list-stat-card">
    <div class="list-stat-label">æ€»æ•°</div>
    <div class="list-stat-value">{{ total_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">å¾…å¤„ç†</div>
    <div class="list-stat-value">{{ pending_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">å·²é€¾æœŸ</div>
    <div class="list-stat-value">{{ overdue_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">å·²å®Œæˆ</div>
    <div class="list-stat-value">{{ completed_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">å·²å–æ¶ˆ</div>
    <div class="list-stat-value">{{ cancelled_count|default:0 }}</div>
  </div>
{% endblock list_stats_content %}

{% block list_filters_content %}
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">æœç´¢</label>
    <input type="text" name="search" class="form-control" value="{{ search }}" placeholder="æ ‡é¢˜ / æè¿°">
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">çŠ¶æ€</label>
    <select name="status" class="form-select">
      <option value="">å…¨éƒ¨çŠ¶æ€</option>
      {% for value, label in status_options %}
      <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">ç±»å‹</label>
    <select name="task_type" class="form-select">
      <option value="">å…¨éƒ¨ç±»å‹</option>
      {% for value, label in task_type_options %}
      <option value="{{ value }}" {% if task_type_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">æˆªæ­¢å¼€å§‹</label>
    <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">æˆªæ­¢ç»“æŸ</label>
    <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
  </div>
{% endblock list_filters_content %}

{% block list_table_headers %}
  <th>æ ‡é¢˜</th>
  <th>ç±»å‹</th>
  <th>æˆªæ­¢æ—¶é—´</th>
  <th>çŠ¶æ€</th>
  <th>æ ¸éªŒ</th>
  <th>é€¾æœŸ</th>
  <th>å…³è”</th>
  <th>åˆ›å»ºæ—¶é—´</th>
  <th>æ“ä½œ</th>
{% endblock list_table_headers %}

{% block list_table_rows %}
  {% if page_obj %}
    {% for todo in page_obj %}
    <tr>
      <td>
        <div class="fw-medium text-dark">{{ todo.title }}</div>
        {% if todo.description %}
          <div class="text-muted small">{{ todo.description|truncatechars:60 }}</div>
        {% endif %}
        {% if todo.auto_generated %}
          <span class="badge bg-light text-dark mt-1">ç³»ç»Ÿç”Ÿæˆ</span>
        {% endif %}
      </td>
      <td>{{ todo.get_task_type_display }}</td>
      <td>
        <small class="text-muted">
          {{ todo.deadline|date:"Y-m-d H:i" }}
        </small>
      </td>
      <td>
        {% if todo.status == 'overdue' %}
          <span class="badge bg-danger">{{ todo.get_status_display }}</span>
        {% elif todo.status == 'pending' %}
          <span class="badge bg-warning text-dark">{{ todo.get_status_display }}</span>
        {% elif todo.status == 'completed' %}
          <span class="badge bg-success">{{ todo.get_status_display }}</span>
        {% elif todo.status == 'cancelled' %}
          <span class="badge bg-secondary">{{ todo.get_status_display }}</span>
        {% else %}
          <span class="badge bg-light text-dark">{{ todo.get_status_display|default:todo.status }}</span>
        {% endif %}
      </td>
      <td>
        {% if todo.status == 'completed' %}
          {% if todo.verification_status == 'verified' %}
            <span class="badge bg-success">å·²æ ¸éªŒ</span>
          {% elif todo.verification_status == 'suspected' %}
            <span class="badge bg-danger">ç–‘ä¼¼</span>
            {% if todo.verification_reason %}
              <div class="text-muted small mt-1">{{ todo.verification_reason|truncatechars:30 }}</div>
            {% endif %}
          {% else %}
            <span class="badge bg-warning text-dark">å¾…æ ¸éªŒ</span>
            {% if todo.verification_reason %}
              <div class="text-muted small mt-1">{{ todo.verification_reason|truncatechars:30 }}</div>
            {% endif %}
          {% endif %}
        {% else %}
          <span class="text-muted">-</span>
        {% endif %}
      </td>
      <td>
        {% if todo.is_overdue %}
          <span class="text-danger">å·²é€¾æœŸ {{ todo.overdue_days }} å¤©</span>
        {% else %}
          <span class="text-muted">-</span>
        {% endif %}
      </td>
      <td>
        {% if todo.related_object_type and todo.related_object_id %}
          <code>{{ todo.related_object_type }}:{{ todo.related_object_id }}</code>
        {% else %}
          <span class="text-muted">-</span>
        {% endif %}
      </td>
      <td><small class="text-muted">{{ todo.created_at|date:"Y-m-d H:i" }}</small></td>
      <td>
        {% if todo.status == 'pending' or todo.status == 'overdue' %}
          <div class="d-flex gap-2">
            <form method="post" action="{% url 'plan_pages:todo_task_complete' todo.id %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button type="submit" class="btn btn-sm btn-success">å®Œæˆ</button>
            </form>
            {% if todo.auto_generated and not can_manage_todo_cancel %}
              <button type="button" class="btn btn-sm btn-outline-secondary" disabled title="ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆå¾…åŠå–æ¶ˆéœ€ç®¡ç†å‘˜æƒé™">
                å–æ¶ˆ(éœ€ç®¡ç†å‘˜)
              </button>
            {% else %}
              <form method="post" action="{% url 'plan_pages:todo_task_cancel' todo.id %}">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <input type="hidden" name="cancel_reason" value="">
                <button type="submit" class="btn btn-sm btn-outline-secondary">å–æ¶ˆ</button>
              </form>
            {% endif %}
          </div>
        {% else %}
          {% if todo.status == 'completed' %}
            <small class="text-muted">
              å®Œæˆï¼š{{ todo.completed_at|date:"Y-m-d H:i" }}{% if todo.completed_by %}<br>äººï¼š{{ todo.completed_by.get_full_name|default:todo.completed_by.username }}{% endif %}
            </small>
          {% elif todo.status == 'cancelled' %}
            <small class="text-muted">
              å–æ¶ˆï¼š{{ todo.cancelled_at|date:"Y-m-d H:i" }}{% if todo.cancelled_by %}<br>äººï¼š{{ todo.cancelled_by.get_full_name|default:todo.cancelled_by.username }}{% endif %}
              {% if todo.cancel_reason %}<br>å› ï¼š{{ todo.cancel_reason|truncatechars:30 }}{% endif %}
            </small>
          {% else %}
            <span class="text-muted">-</span>
          {% endif %}
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  {% else %}
    <tr>
      <td colspan="9" class="list-empty">
        <div class="list-empty-icon">ğŸ“</div>
        <div class="list-empty-text">æš‚æ— å¾…åŠäº‹é¡¹</div>
      </td>
    </tr>
  {% endif %}
{% endblock list_table_rows %}

{% block extra_js %}
  {{ block.super }}
  <script>
  window.listFiltersConfig = {
    selectFieldNames: ['status', 'task_type'],
    dateStartFieldName: 'date_from',
    dateEndFieldName: 'date_to'
  };
  </script>
  <script src="{% static 'js/list-filters.js' %}"></script>

  <script>
  // æ–¹æ¡ˆBï¼šå–æ¶ˆå¿…é¡»å¡«å†™åŸå› ï¼ˆå‰ç«¯å¼ºåˆ¶ + åç«¯æ ¡éªŒï¼‰
  document.addEventListener('submit', function(e) {
    const form = e.target;
    if (!form || form.tagName !== 'FORM') return;
    if (!form.action || form.action.indexOf('/todos/') === -1 || form.action.indexOf('/cancel/') === -1) return;
    const input = form.querySelector('input[name="cancel_reason"]');
    if (!input) return;
    const reason = prompt('è¯·è¾“å…¥å–æ¶ˆåŸå› ï¼ˆè‡³å°‘4ä¸ªå­—ï¼Œç”¨äºå®¡è®¡ä¸å·¡æ£€ï¼‰ï¼š', input.value || '');
    if (!reason || reason.trim().length < 4) {
      e.preventDefault();
      alert('å–æ¶ˆåŸå› ä¸èƒ½ä¸ºç©ºï¼Œä¸”è‡³å°‘4ä¸ªå­—');
      return;
    }
    input.value = reason.trim();
  }, true);
  </script>
{% endblock extra_js %}

