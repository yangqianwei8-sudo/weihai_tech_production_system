{% extends "plan_management/_base.html" %}
{% load static %}

{% block pm_title %}计划审批列表{% endblock %}
{% block pm_subtitle %}<span class="pm-subtitle">待裁决的计划请求</span>{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/list_layout.css' %}">
{% endblock %}

{% block pm_content %}
  {% include "plan_management/_partials/_approval_stats.html" %}
  {% include "plan_management/_partials/_approval_table.html" %}
{% endblock %}

{% block extra_js %}
<script>
function getCSRFToken() {
    const el = document.querySelector('meta[name="csrf-token"]');
    return el ? el.getAttribute('content') : '';
}

async function decidePlanDecision(decisionId, approve) {
    const actionText = approve ? '通过' : '驳回';
    if (!confirm(`确认${actionText}该请求？`)) return;

    const url = `/api/plan/plan-decisions/${decisionId}/decide/`;

    let resp, data;
    try {
        resp = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            credentials: 'include',
            body: JSON.stringify({ approve: approve }),
        });
        data = await resp.json().catch(() => ({}));
    } catch (e) {
        alert('网络错误，请稍后重试');
        return;
    }

    if (!resp.ok) {
        alert((data && data.message) ? data.message : `请求失败（${resp.status}）`);
        return;
    }

    window.location.reload();
}
</script>
{% endblock %}
