{% extends "shared/list_page_base.html" %}
{% load static %}

{% block page_title %}è®¡åˆ’å®¡æ‰¹åˆ—è¡¨{% endblock page_title %}
{% block page_subtitle %}å¾…è£å†³çš„è®¡åˆ’è¯·æ±‚{% endblock page_subtitle %}

{% block module_styles %}
  {{ block.super }}
  <style>
    .status-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    .status-pending_approval { background: #cfe2ff; color: #084298; }
    .status-approving { background: #fff3cd; color: #856404; }
    .status-approved { background: #d1e7dd; color: #0f5132; }
  </style>
{% endblock %}

{% block list_stats_content %}
  {# ç»Ÿè®¡å¡ç‰‡ - ç›´æ¥æ”¾åœ¨ list-page-stats ä¸­ï¼ŒCSSä¼šè‡ªåŠ¨ä¸€è¡Œæ’åˆ— #}
  <div class="list-stat-card">
    <div class="list-stat-label">å¾…è£å†³æ€»æ•°</div>
    <div class="list-stat-value">{{ total_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">å¯åŠ¨è¯·æ±‚</div>
    <div class="list-stat-value">{{ pending_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">å–æ¶ˆè¯·æ±‚</div>
    <div class="list-stat-value">{{ cancel_count|default:0 }}</div>
  </div>
{% endblock list_stats_content %}

{% block list_filters_content %}
  {# ç­›é€‰å™¨ - ä½¿ç”¨æ ‡å‡†Bootstrapæ …æ ¼ç³»ç»Ÿ #}
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label">æœç´¢</label>
      <input type="text" name="search" class="form-control form-control-sm" value="{{ search }}" placeholder="è®¡åˆ’ç¼–å·ã€åç§°ã€è¯·æ±‚äºº">
    </div>
    <div class="col-md-2">
      <label class="form-label">è¯·æ±‚ç±»å‹</label>
      <select name="request_type" class="form-select form-select-sm">
        <option value="">å…¨éƒ¨ç±»å‹</option>
        {% for value, label in request_type_choices %}
        <option value="{{ value }}" {% if request_type_filter == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">è®¡åˆ’çŠ¶æ€</label>
      <select name="status" class="form-select form-select-sm">
        <option value="">å…¨éƒ¨çŠ¶æ€</option>
        {% for value, label in status_options %}
        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">è¯·æ±‚äºº</label>
      <select name="requested_by" class="form-select form-select-sm">
        <option value="">å…¨éƒ¨è¯·æ±‚äºº</option>
        {% for user in all_users %}
        <option value="{{ user.id }}" {% if requested_by_filter|stringformat:"s" == user.id|stringformat:"s" %}selected{% endif %}>
          {{ user.get_full_name|default:user.username }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">è¯·æ±‚æ—¶é—´</label>
      <div class="row g-2">
        <div class="col-6">
          <input type="date" name="date_from" class="form-control form-control-sm" value="{{ date_from|default:'' }}" placeholder="å¼€å§‹">
        </div>
        <div class="col-6">
          <input type="date" name="date_to" class="form-control form-control-sm" value="{{ date_to|default:'' }}" placeholder="ç»“æŸ">
        </div>
      </div>
    </div>
  </div>
{% endblock list_filters_content %}

{% block list_table_checkbox_header %}
  <th style="width: 50px;">
    <input type="checkbox" id="selectAll" class="form-check-input" title="å…¨é€‰">
  </th>
{% endblock list_table_checkbox_header %}

{% block list_table_headers %}
  <th>è®¡åˆ’ç¼–å·</th>
  <th>è®¡åˆ’åç§°</th>
  <th>è¯·æ±‚ç±»å‹</th>
  <th>è¯·æ±‚äºº</th>
  <th>è¯·æ±‚æ—¶é—´</th>
  <th>è®¡åˆ’çŠ¶æ€</th>
  <th>æ“ä½œ</th>
{% endblock list_table_headers %}

{% block list_table_rows %}
  {% for d in page_obj %}
  <tr>
    <td><code>{{ d.plan.plan_number }}</code></td>
    <td>
      <a href="{% url 'plan_pages:plan_detail' d.plan.id %}" class="text-dark text-decoration-none fw-medium">
        {{ d.plan.name|default:"(æœªå‘½åè®¡åˆ’)" }}
      </a>
    </td>
    <td>
      <span class="list-badge {% if d.request_type == 'start' %}list-badge-primary{% else %}list-badge-warning{% endif %}">
        {{ d.get_request_type_display }}
      </span>
    </td>
    <td>{{ d.requested_by.get_full_name|default:d.requested_by.username|default:"-" }}</td>
    <td>
      <div style="font-size: 12px; color: #333333; font-weight: 500;">{{ d.requested_at|date:"Y-m-d" }}</div>
      <div style="font-size: 12px; color: #999999;">{{ d.requested_at|date:"H:i" }}</div>
    </td>
    <td>
      <span class="status-badge status-{{ d.plan.status }}">
        {{ d.plan.get_status_display }}
      </span>
    </td>
    <td>
      <div class="list-page-table-actions">
        <a href="{% url 'plan_pages:plan_detail' d.plan.id %}" class="action-view" title="æŸ¥çœ‹">
          <i class="bi bi-eye"></i>
        </a>
        {% if can_approve %}
        <span class="action-separator">|</span>
        <button class="action-edit" title="é€šè¿‡" onclick="decidePlanDecision({{ d.id }}, true); return false;" style="background: none; border: none; padding: 0; cursor: pointer;">
          <i class="bi bi-check-circle"></i>
        </button>
        <span class="action-separator">|</span>
        <button class="action-delete" title="é©³å›" onclick="decidePlanDecision({{ d.id }}, false); return false;" style="background: none; border: none; padding: 0; cursor: pointer;">
          <i class="bi bi-x-circle"></i>
        </button>
        {% endif %}
      </div>
    </td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="8" class="list-empty-state">
      <div class="list-empty-state-icon">ğŸ“‹</div>
      <div class="list-empty-state-text">å½“å‰æ²¡æœ‰å¾…è£å†³çš„è¯·æ±‚</div>
      <div class="list-empty-state-hint">æ‰€æœ‰å®¡æ‰¹è¯·æ±‚å·²å¤„ç†å®Œæˆ</div>
    </td>
  </tr>
  {% endfor %}
{% endblock list_table_rows %}

{% block extra_js %}
<script>
function getCSRFToken() {
    const el = document.querySelector('meta[name="csrf-token"]');
    return el ? el.getAttribute('content') : '';
}

async function decidePlanDecision(decisionId, approve) {
    const actionText = approve ? 'é€šè¿‡' : 'é©³å›';
    if (!confirm(`ç¡®è®¤${actionText}è¯¥è¯·æ±‚ï¼Ÿ`)) return;

    const url = `/api/plan/plan-decisions/${decisionId}/decide/`;

    let resp, data;
    try {
        resp = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            credentials: 'include',
            body: JSON.stringify({ approve: approve }),
        });
        data = await resp.json().catch(() => ({}));
    } catch (e) {
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        return;
    }

    if (!resp.ok) {
        // 409 / 400 ç­‰éƒ½åœ¨è¿™é‡Œæç¤º
        alert((data && data.message) ? data.message : `è¯·æ±‚å¤±è´¥ï¼ˆ${resp.status}ï¼‰`);
        return;
    }

    // æˆåŠŸååˆ·æ–°åˆ—è¡¨ï¼Œå¾…è£å†³è¡Œåº”è¯¥æ¶ˆå¤±
    window.location.reload();
}
</script>
{% endblock %}
