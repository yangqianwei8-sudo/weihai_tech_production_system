{% extends "plan_management/base.html" %}
{% load static %}

{% block title %}{{ page_title }} - 维海科技信息化管理平台{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
    .status-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    .status-pending_approval { background: #cfe2ff; color: #084298; }
    .status-approving { background: #fff3cd; color: #856404; }
    .status-approved { background: #d1e7dd; color: #0f5132; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 页面标题 -->
    <div class="list-page-header mb-4">
        <h2 class="mb-0">
            {{ page_title }}
        </h2>
        <p class="text-muted mb-0 mt-1">{{ description }}</p>
    </div>
    
    <!-- 统计信息 -->
    <div class="alert alert-info mb-3">
        <i class="bi bi-info-circle"></i> 
        待裁决请求：启动请求 <span class="badge bg-primary">{{ pending_count }}</span>，取消请求 <span class="badge bg-warning">{{ cancel_count }}</span>
    </div>
    
    <!-- 计划决策列表 -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>计划编号</th>
                            <th>计划名称</th>
                            <th>请求类型</th>
                            <th>请求人</th>
                            <th>请求时间</th>
                            <th>计划状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in pending_decisions %}
                        <tr>
                            <td><code>{{ d.plan.plan_number }}</code></td>
                            <td>
                                <a href="{% url 'plan_pages:plan_detail' d.plan.id %}" class="text-decoration-none">
                                    {{ d.plan.name|default:"(未命名计划)" }}
                                </a>
                            </td>
                            <td>
                                <span class="badge {% if d.request_type == 'start' %}bg-primary{% else %}bg-warning{% endif %}">
                                    {{ d.get_request_type_display }}
                                </span>
                            </td>
                            <td>{{ d.requested_by.get_full_name|default:d.requested_by.username|default:"-" }}</td>
                            <td>{{ d.requested_at|date:"Y-m-d H:i" }}</td>
                            <td>
                                <span class="status-badge status-{{ d.plan.status }}">
                                    {{ d.plan.get_status_display }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'plan_pages:plan_detail' d.plan.id %}" class="btn btn-outline-primary" title="查看">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% if can_approve %}
                                    <button class="btn btn-outline-success" title="通过"
                                            onclick="decidePlanDecision({{ d.id }}, true)">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" title="驳回"
                                            onclick="decidePlanDecision({{ d.id }}, false)">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                <i class="bi bi-inbox" style="font-size: 48px; opacity: 0.3;"></i>
                                <p class="mt-3 mb-0">当前没有待裁决的请求</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function getCSRFToken() {
    const el = document.querySelector('meta[name="csrf-token"]');
    return el ? el.getAttribute('content') : '';
}

async function decidePlanDecision(decisionId, approve) {
    const actionText = approve ? '通过' : '驳回';
    if (!confirm(`确认${actionText}该请求？`)) return;

    const url = `/api/plan/plan-decisions/${decisionId}/decide/`;

    let resp, data;
    try {
        resp = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            credentials: 'include',
            body: JSON.stringify({ approve: approve }),
        });
        data = await resp.json().catch(() => ({}));
    } catch (e) {
        alert('网络错误，请稍后重试');
        return;
    }

    if (!resp.ok) {
        // 409 / 400 等都在这里提示
        alert((data && data.message) ? data.message : `请求失败（${resp.status}）`);
        return;
    }

    // 成功后刷新列表，待裁决行应该消失
    window.location.reload();
}
</script>
{% endblock %}