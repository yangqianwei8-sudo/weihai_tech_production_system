{% extends "shared/list_page_base.html" %}
{% load static %}

{% block module_styles %}
  {{ block.super }}
  <style>
    .track-form-card {
      background: #FFFFFF;
      border: 1px solid #E0E0E0;
      border-radius: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 16px;
    }

    .track-form-header {
      padding: 12px 16px;
      border-bottom: 1px solid #E0E0E0;
      background: #F5F5F5;
    }

    .track-form-title {
      font-size: 14px;
      font-weight: 600;
      color: #1A1A1A;
      margin: 0;
    }

    .track-form-body {
      padding: 16px;
    }

    .track-form-group {
      margin-bottom: 16px;
    }

    .track-form-group:last-child {
      margin-bottom: 0;
    }

    .track-form-label {
      font-size: 12px;
      color: var(--vh-primary);
      margin-bottom: 6px;
      display: block;
    }

    .track-form-label.required::after {
      content: ' *';
      color: #999999;
    }

    .track-form-input {
      color: var(--vh-primary);
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #E0E0E0;
      border-radius: 0;
      font-size: 14px;
      background: #FFFFFF;
    }

    .track-form-input:focus {
      outline: none;
      border-color: #999999;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
    }

    .track-form-input[readonly] {
      background: #F5F5F5;
      color: var(--vh-primary);
    }

    .track-form-submit {
      padding: 10px 20px;
      background: #1A1A1A;
      color: #FFFFFF;
      border: 1px solid #1A1A1A;
      border-radius: 0;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .track-form-submit:hover {
      background: #333333;
      border-color: #333333;
    }

    .track-action-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }

    .track-action-card {
      background: #FFFFFF;
      border: 1px solid #E0E0E0;
      border-radius: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .track-action-header {
      padding: 12px 16px;
      border-bottom: 1px solid #E0E0E0;
      background: #F5F5F5;
    }

    .track-action-title {
      font-size: 14px;
      font-weight: 600;
      color: #1A1A1A;
      margin: 0;
    }

    .track-action-body {
      padding: 16px;
    }

    .track-action-text {
      font-size: 12px;
      color: var(--vh-primary);
      margin-bottom: 12px;
    }

    .track-action-select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #E0E0E0;
      border-radius: 0;
      font-size: 12px;
      margin-bottom: 12px;
      background: #FFFFFF;
      color: #333333;
    }

    .track-action-select:focus {
      outline: none;
      border-color: #999999;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
    }

    .track-action-btn {
      width: 100%;
      padding: 8px;
      background: #1A1A1A;
      color: #FFFFFF;
      border: 1px solid #1A1A1A;
      border-radius: 0;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .track-action-btn:hover {
      background: #333333;
      border-color: #333333;
    }

    .track-extra-section {
      margin-top: 24px;
    }

    .track-extra-section-title {
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #E0E0E0;
    }

    @media (max-width: 1200px) {
      .track-action-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
{% endblock %}

{% block list_stats_content %}
  <div class="row g-3">
    <div class="col-md-3">
      <div class="list-stat-card">
        <div class="list-stat-label">ç›®æ ‡å€¼</div>
        <div class="list-stat-value">{{ goal.target_value }}{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="list-stat-card">
        <div class="list-stat-label">å½“å‰å€¼</div>
        <div class="list-stat-value">{{ goal.current_value }}{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="list-stat-card">
        <div class="list-stat-label">å®Œæˆç‡</div>
        <div class="list-stat-value">{{ goal.completion_rate }}%</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="list-stat-card">
        <div class="list-stat-label">è¿›åº¦è®°å½•</div>
        <div class="list-stat-value">{{ progress_records|length }}</div>
      </div>
    </div>
  </div>
{% endblock %}

{% block pm_content %}
    {% block list_stats_section %}
    <div class="list-stats-section">
      {% block list_stats_content %}{% endblock list_stats_content %}
    </div>
    {% endblock list_stats_section %}

    {# è¿›åº¦æ›´æ–°è¡¨å•å’Œæ“ä½œè¡¨å• #}
    {% if can_update_progress %}
    <div class="track-form-card">
      <div class="track-form-header">
        <h3 class="track-form-title">æ›´æ–°è¿›åº¦</h3>
      </div>
      <div class="track-form-body">
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="update_progress" value="1">

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="track-form-group" style="margin-bottom: 0;">
              <label class="track-form-label required">å½“å‰å€¼</label>
              {{ progress_form.current_value }}
              {% if progress_form.current_value.errors %}
              <div style="font-size: 12px; color: #999999; margin-top: 4px;">{{ progress_form.current_value.errors }}</div>
              {% endif %}
            </div>
            <div class="track-form-group" style="margin-bottom: 0;">
              <label class="track-form-label">é¢„è®¡å®Œæˆç‡</label>
              <input type="text" class="track-form-input" id="predictedRate" readonly placeholder="è‡ªåŠ¨è®¡ç®—">
            </div>
          </div>

          <div class="track-form-group">
            <label class="track-form-label required">è¿›åº¦è¯´æ˜</label>
            {{ progress_form.progress_description }}
            {% if progress_form.progress_description.errors %}
            <div style="font-size: 12px; color: #999999; margin-top: 4px;">{{ progress_form.progress_description.errors }}</div>
            {% endif %}
          </div>

          <div class="track-form-group">
            <label class="track-form-label">å¤‡æ³¨</label>
            {{ progress_form.notes }}
          </div>

          <button type="submit" class="track-form-submit">æ›´æ–°è¿›åº¦</button>
        </form>
      </div>
    </div>
    {% endif %}

    {# çŠ¶æ€è½¬æ¢å’Œå®Œæˆç¡®è®¤ #}
    {% if valid_transitions or can_complete %}
    <div class="track-action-grid">
      {% if valid_transitions %}
      <div class="track-action-card">
        <div class="track-action-header">
          <h6 class="track-action-title">çŠ¶æ€è½¬æ¢</h6>
        </div>
        <div class="track-action-body">
          <div class="track-action-text">
            å½“å‰ï¼š<span class="list-badge list-badge-{{ goal.status }}">{{ goal.get_status_display }}</span>
          </div>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="transition_status" value="1">
            <select name="new_status" class="track-action-select">
              {% for status in valid_transitions %}
              <option value="{{ status }}">
                {% if status == 'published' %}å·²å‘å¸ƒ
                {% elif status == 'in_progress' %}æ‰§è¡Œä¸­
                {% elif status == 'completed' %}å·²å®Œæˆ
                {% elif status == 'cancelled' %}å·²å–æ¶ˆ
                {% else %}{{ status }}
                {% endif %}
              </option>
              {% endfor %}
            </select>
            <button type="submit" class="track-action-btn">è½¬æ¢çŠ¶æ€</button>
          </form>
        </div>
      </div>
      {% endif %}

      {% if can_complete %}
      <div class="track-action-card">
        <div class="track-action-header">
          <h6 class="track-action-title">å®Œæˆç¡®è®¤</h6>
        </div>
        <div class="track-action-body">
          <div class="track-action-text">ç¡®è®¤ç›®æ ‡å·²å®Œæˆï¼Ÿå®Œæˆåå°†æ— æ³•ç»§ç»­æ›´æ–°è¿›åº¦ã€‚</div>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="complete_goal" value="1">
            <button type="submit" class="track-action-btn">ç¡®è®¤å®Œæˆ</button>
          </form>
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <div class="list-table-section">
      <div class="list-table-wrapper">
        <table class="list-table">
          <thead>
            <tr>{% block list_table_headers %}{% endblock list_table_headers %}</tr>
          </thead>
          <tbody>
            {% block list_table_rows %}
            <tr>
              <td colspan="100%" class="list-empty-state">æš‚æ— æ•°æ®</td>
            </tr>
            {% endblock list_table_rows %}
          </tbody>
        </table>
      </div>
    </div>

    {# çŠ¶æ€æ—¥å¿—è¡¨æ ¼ #}
    <div class="track-extra-section">
      <div class="track-extra-section-title">çŠ¶æ€æ—¥å¿—ï¼ˆå…± {{ status_logs|length }} æ¡è®°å½•ï¼‰</div>
      <div class="list-table-section">
        <div class="list-table-wrapper">
          <table class="list-table">
            <thead>
              <tr>
                <th>å˜æ›´æ—¶é—´</th>
                <th>çŠ¶æ€å˜æ›´</th>
                <th>å˜æ›´äºº</th>
                <th>å˜æ›´åŸå› </th>
              </tr>
            </thead>
            <tbody>
              {% for log in status_logs %}
              <tr>
                <td>
                  <div style="font-size: 12px; color: #333333; font-weight: 500;">{{ log.changed_time|date:"Y-m-d" }}</div>
                  <div style="font-size: 12px; color: #999999;">{{ log.changed_time|date:"H:i" }}</div>
                </td>
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="list-badge">{{ log.old_status }}</span>
                    <span style="color: #999999;">â†’</span>
                    <span class="list-badge">{{ log.new_status }}</span>
                  </div>
                </td>
                <td>
                  {% if log.changed_by %}
                  {{ log.changed_by.get_full_name|default:log.changed_by.username }}
                  {% else %}
                  <span style="color: #999999;">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if log.change_reason %}
                  <div style="font-size: 12px; color: #333333;">{{ log.change_reason|truncatewords:15 }}</div>
                  {% else %}
                  <span style="color: #999999;">-</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="list-empty-state">
                  <div class="list-empty-state-icon">â–¢</div>
                  <div class="list-empty-state-text">æš‚æ— çŠ¶æ€æ—¥å¿—</div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {# è°ƒæ•´ç”³è¯·è¡¨æ ¼ #}
    <div class="track-extra-section">
      <div class="track-extra-section-title">è°ƒæ•´ç”³è¯·ï¼ˆå…± {{ adjustments|length }} æ¡è®°å½•ï¼‰</div>
      <div class="list-table-section">
        <div class="list-table-wrapper">
          <table class="list-table">
            <thead>
              <tr>
                <th>ç”³è¯·æ—¶é—´</th>
                <th>çŠ¶æ€</th>
                <th>è°ƒæ•´åŸå› </th>
                <th>å®¡æ‰¹äºº</th>
              </tr>
            </thead>
            <tbody>
              {% for adjustment in adjustments %}
              <tr>
                <td>
                  <div style="font-size: 12px; color: #333333; font-weight: 500;">{{ adjustment.created_time|date:"Y-m-d" }}</div>
                  <div style="font-size: 12px; color: #999999;">{{ adjustment.created_time|date:"H:i" }}</div>
                </td>
                <td>
                  <span class="list-badge list-badge-{{ adjustment.status }}">{{ adjustment.get_status_display }}</span>
                </td>
                <td>
                  <div style="font-size: 12px; color: #333333; max-width: 300px;">{{ adjustment.adjustment_reason|truncatewords:15 }}</div>
                </td>
                <td>
                  {% if adjustment.approved_by %}
                  {{ adjustment.approved_by.get_full_name|default:adjustment.approved_by.username }}
                  {% else %}
                  <span style="color: #999999;">-</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="list-empty-state">
                  <div class="list-empty-state-icon">â–¢</div>
                  <div class="list-empty-state-text">æš‚æ— è°ƒæ•´ç”³è¯·</div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
{% endblock %}

{% block list_table_headers %}
  <th>è®°å½•æ—¶é—´</th>
  <th>è®°å½•äºº</th>
  <th>å½“å‰å€¼</th>
  <th>å®Œæˆç‡</th>
  <th>è¿›åº¦è¯´æ˜</th>
  <th>å¤‡æ³¨</th>
{% endblock %}

{% block list_table_rows %}
  {% for record in progress_records %}
  <tr>
    <td>
      <div style="font-size: 12px; color: #333333; font-weight: 500;">{{ record.recorded_time|date:"Y-m-d" }}</div>
      <div style="font-size: 12px; color: #999999;">{{ record.recorded_time|date:"H:i" }}</div>
    </td>
    <td>{{ record.recorded_by.get_full_name|default:record.recorded_by.username }}</td>
    <td>
      <span class="list-badge">{{ record.current_value }}{% if goal.indicator_unit %} {{ goal.indicator_unit }}{% endif %}</span>
    </td>
    <td>
      <div class="list-progress">
        <div class="list-progress-fill" style="width: {{ record.completion_rate }}%"></div>
        <span class="list-progress-text">{{ record.completion_rate }}%</span>
      </div>
    </td>
    <td>
      <div style="font-size: 12px; color: #333333; max-width: 300px;">{{ record.progress_description|truncatewords:15 }}</div>
    </td>
    <td>
      {% if record.notes %}
      <div style="font-size: 12px; color: #999999;">{{ record.notes|truncatewords:10 }}</div>
      {% else %}
      <span style="color: #999999;">-</span>
      {% endif %}
    </td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="6" class="list-empty-state">
      <div class="list-empty-state-icon">ğŸ“‹</div>
      <div class="list-empty-state-text">æš‚æ— è¿›åº¦è®°å½•</div>
      <div class="list-empty-state-hint">æ›´æ–°è¿›åº¦åå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
    </td>
  </tr>
  {% endfor %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const currentValueInput = document.querySelector('#id_current_value');
  const predictedRateInput = document.getElementById('predictedRate');
  const targetValue = {{ goal.target_value }};

  if (currentValueInput && predictedRateInput) {
    const initialValue = parseFloat(currentValueInput.value) || 0;
    if (targetValue > 0 && initialValue > 0) {
      const rate = (initialValue / targetValue) * 100;
      predictedRateInput.value = Math.min(rate, 100).toFixed(2) + '%';
    }

    currentValueInput.addEventListener('input', function() {
      const currentValue = parseFloat(this.value) || 0;
      if (targetValue > 0) {
        const rate = (currentValue / targetValue) * 100;
        predictedRateInput.value = Math.min(rate, 100).toFixed(2) + '%';
      } else {
        predictedRateInput.value = '0.00%';
      }
    });
  }
});
</script>
{% endblock %}
