{% extends "plan_management/_base.html" %}
{% load static %}

{% block pm_title %}统计报表{% endblock %}
{% block pm_subtitle %}<span class="pm-subtitle">统计计划、目标、问题等数据情况</span>{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/list_layout.css' %}">
<style>
  .analysis-filters {
    background: #FFFFFF;
    border: 1px solid #E0E0E0;
    border-radius: 0;
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .analysis-filters-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    align-items: end;
  }
  
  .analysis-filter-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  .analysis-filter-label {
    font-size: 12px;
    color: #666666;
    font-weight: 400;
  }
  
  .analysis-filter-input {
    border: 1px solid #E0E0E0;
    border-radius: 0;
    padding: 6px 10px;
    font-size: 13px;
    color: #333333;
    background: #FFFFFF;
    width: 100%;
  }
  
  .analysis-filter-input:focus {
    outline: none;
    border-color: #999999;
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
  }
  
  .analysis-filter-actions {
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }
  
  .analysis-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .analysis-stat-card {
    background: #FFFFFF;
    border: 1px solid #E0E0E0;
    border-radius: 0;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.2s ease;
  }
  
  .analysis-stat-card:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  }
  
  .analysis-stat-value {
    font-size: 32px;
    font-weight: 600;
    color: #1A1A1A;
    line-height: 1.2;
    margin-bottom: 8px;
  }
  
  .analysis-stat-label {
    font-size: 12px;
    color: #666666;
    font-weight: 400;
  }
  
  .analysis-charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
  }
  
  .analysis-chart-card {
    background: #FFFFFF;
    border: 1px solid #E0E0E0;
    border-radius: 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }
  
  .analysis-chart-header {
    padding: 16px 20px;
    border-bottom: 1px solid #E0E0E0;
    background: #F5F5F5;
  }
  
  .analysis-chart-title {
    font-size: 14px;
    font-weight: 600;
    color: #1A1A1A;
    margin: 0;
  }
  
  .analysis-chart-body {
    padding: 20px;
  }
  
  .analysis-chart-container {
    position: relative;
    height: 300px;
  }
  
  .analysis-trend-chart-container {
    position: relative;
    height: 400px;
  }
  
  @media (max-width: 768px) {
    .analysis-filters-form {
      grid-template-columns: 1fr;
    }
    .analysis-charts {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block pm_content %}
<div class="analysis-filters">
  <form method="get" class="analysis-filters-form">
    <div class="analysis-filter-group">
      <label class="analysis-filter-label">开始时间</label>
      <input type="date" name="date_from" class="analysis-filter-input" value="{{ date_from }}">
    </div>
    <div class="analysis-filter-group">
      <label class="analysis-filter-label">结束时间</label>
      <input type="date" name="date_to" class="analysis-filter-input" value="{{ date_to }}">
    </div>
    <div class="analysis-filter-group analysis-filter-actions">
      <button type="submit" class="list-btn list-btn-primary">筛选</button>
      <a href="{% url 'plan_pages:plan_statistics' %}" class="list-btn">重置</a>
    </div>
  </form>
</div>

<div class="analysis-stats">
  <div class="analysis-stat-card">
    <div class="analysis-stat-value">{{ plan_total }}</div>
    <div class="analysis-stat-label">计划总数</div>
  </div>
  <div class="analysis-stat-card">
    <div class="analysis-stat-value">{{ goal_total }}</div>
    <div class="analysis-stat-label">目标总数</div>
  </div>
  <div class="analysis-stat-card">
    <div class="analysis-stat-value">{{ issue_total }}</div>
    <div class="analysis-stat-label">问题总数</div>
  </div>
  <div class="analysis-stat-card">
    <div class="analysis-stat-value">{{ progress_record_count }}</div>
    <div class="analysis-stat-label">进度记录数</div>
  </div>
</div>

<div class="analysis-charts">
  <div class="analysis-chart-card">
    <div class="analysis-chart-header">
      <h5 class="analysis-chart-title">计划状态分布</h5>
    </div>
    <div class="analysis-chart-body">
      <div class="analysis-chart-container">
        <canvas id="planStatusChart"></canvas>
      </div>
    </div>
  </div>
  
  <div class="analysis-chart-card">
    <div class="analysis-chart-header">
      <h5 class="analysis-chart-title">目标状态分布</h5>
    </div>
    <div class="analysis-chart-body">
      <div class="analysis-chart-container">
        <canvas id="goalStatusChart"></canvas>
      </div>
    </div>
  </div>
  
  <div class="analysis-chart-card">
    <div class="analysis-chart-header">
      <h5 class="analysis-chart-title">问题状态分布</h5>
    </div>
    <div class="analysis-chart-body">
      <div class="analysis-chart-container">
        <canvas id="issueStatusChart"></canvas>
      </div>
    </div>
  </div>
  
  <div class="analysis-chart-card">
    <div class="analysis-chart-header">
      <h5 class="analysis-chart-title">问题严重程度分布</h5>
    </div>
    <div class="analysis-chart-body">
      <div class="analysis-chart-container">
        <canvas id="issueSeverityChart"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="analysis-chart-card" style="grid-column: 1 / -1;">
  <div class="analysis-chart-header">
    <h5 class="analysis-chart-title">最近30天进度更新趋势</h5>
  </div>
  <div class="analysis-chart-body">
    <div class="analysis-trend-chart-container">
      <canvas id="trendChart"></canvas>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const planStatusMap = {
    'draft': '草稿',
    'in_progress': '执行中',
    'completed': '已完成',
    'cancelled': '已取消'
};

const goalStatusMap = {
    'draft': '制定中',
    'published': '已发布',
    'in_progress': '执行中',
    'completed': '已完成',
    'cancelled': '已取消'
};

const issueStatusMap = {
    'open': '待处理',
    'in_progress': '处理中',
    'resolved': '已解决',
    'closed': '已关闭'
};

const issueSeverityMap = {
    'critical': '严重',
    'high': '高',
    'medium': '中',
    'low': '低'
};

const planStatusCtx = document.getElementById('planStatusChart').getContext('2d');
const planStatusLabels = [
    {% for stat in plan_by_status %}
    planStatusMap['{{ stat.status }}'] || '{{ stat.status }}',
    {% endfor %}
];
const planStatusData = [
    {% for stat in plan_by_status %}
    {{ stat.count }},
    {% endfor %}
];
new Chart(planStatusCtx, {
    type: 'doughnut',
    data: {
        labels: planStatusLabels,
        datasets: [{
            data: planStatusData,
            backgroundColor: ['#E0E0E0', '#999999', '#666666', '#333333']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

const goalStatusCtx = document.getElementById('goalStatusChart').getContext('2d');
const goalStatusLabels = [
    {% for stat in goal_by_status %}
    goalStatusMap['{{ stat.status }}'] || '{{ stat.status }}',
    {% endfor %}
];
const goalStatusData = [
    {% for stat in goal_by_status %}
    {{ stat.count }},
    {% endfor %}
];
new Chart(goalStatusCtx, {
    type: 'doughnut',
    data: {
        labels: goalStatusLabels,
        datasets: [{
            data: goalStatusData,
            backgroundColor: ['#E0E0E0', '#CCCCCC', '#999999', '#666666', '#333333']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

const issueStatusCtx = document.getElementById('issueStatusChart').getContext('2d');
const issueStatusLabels = [
    {% for stat in issue_by_status %}
    issueStatusMap['{{ stat.status }}'] || '{{ stat.status }}',
    {% endfor %}
];
const issueStatusData = [
    {% for stat in issue_by_status %}
    {{ stat.count }},
    {% endfor %}
];
new Chart(issueStatusCtx, {
    type: 'bar',
    data: {
        labels: issueStatusLabels,
        datasets: [{
            label: '问题数量',
            data: issueStatusData,
            backgroundColor: '#666666'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

const issueSeverityCtx = document.getElementById('issueSeverityChart').getContext('2d');
const issueSeverityLabels = [
    {% for stat in issue_by_severity %}
    issueSeverityMap['{{ stat.severity }}'] || '{{ stat.severity }}',
    {% endfor %}
];
const issueSeverityData = [
    {% for stat in issue_by_severity %}
    {{ stat.count }},
    {% endfor %}
];
new Chart(issueSeverityCtx, {
    type: 'bar',
    data: {
        labels: issueSeverityLabels,
        datasets: [{
            label: '问题数量',
            data: issueSeverityData,
            backgroundColor: '#999999'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

const trendCtx = document.getElementById('trendChart').getContext('2d');
const trendLabels = [
    {% for item in trend_data %}
    '{{ item.date|slice:":5" }}',
    {% endfor %}
];
const trendData = [
    {% for item in trend_data %}
    {{ item.count }},
    {% endfor %}
];
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: trendLabels,
        datasets: [{
            label: '进度更新次数',
            data: trendData,
            borderColor: '#666666',
            backgroundColor: 'rgba(102, 102, 102, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            },
            x: {
                ticks: {
                    maxRotation: 45,
                    minRotation: 45
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        }
    }
});
</script>
{% endblock %}
