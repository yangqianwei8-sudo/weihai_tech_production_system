{% extends "shared/list_page_base.html" %}
{% load static %}

{% block module_title %}计划管理{% endblock %}
{% block page_title %}
  {% block pm_title %}统计报表{% endblock pm_title %}
{% endblock page_title %}

{% block page_subtitle %}
  {% block pm_subtitle %}<span class="pm-subtitle">统计计划、目标、问题等数据情况</span>{% endblock pm_subtitle %}
{% endblock page_subtitle %}

{% block title %}统计报表 - 维海科技信息化管理平台{% endblock %}


{% block module_styles %}
  {{ block.super }}
  <style>
    .analysis-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .analysis-stat-card {
      background: #FFFFFF;
      border: 1px solid #E0E0E0;
      border-radius: 0;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.2s ease;
    }

    .analysis-stat-card:hover {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .analysis-stat-value {
      font-size: 32px;
      font-weight: 600;
      color: #1A1A1A;
      line-height: 1.2;
      margin-bottom: 8px;
    }

    .analysis-stat-label {
      font-size: 12px;
      color: #666666;
      font-weight: 400;
    }

    .analysis-charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .analysis-chart-card {
      background: #FFFFFF;
      border: 1px solid #E0E0E0;
      border-radius: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .analysis-chart-header {
      padding: 16px 20px;
      border-bottom: 1px solid #E0E0E0;
      background: #F5F5F5;
    }

    .analysis-chart-title {
      font-size: 14px;
      font-weight: 600;
      color: #1A1A1A;
      margin: 0;
    }

    .analysis-chart-body {
      padding: 20px;
    }

    .analysis-chart-container {
      position: relative;
      height: 300px;
    }

    .analysis-trend-chart-container {
      position: relative;
      height: 400px;
    }

    .analysis-empty {
      background: #FFFFFF;
      border: 1px solid #E0E0E0;
      border-radius: 0;
      padding: 60px 20px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .analysis-empty-icon {
      font-size: 48px;
      color: #CCCCCC;
      margin-bottom: 16px;
      display: block;
    }

    .analysis-empty-title {
      font-size: 16px;
      font-weight: 600;
      color: #666666;
      margin-bottom: 8px;
    }

    .analysis-empty-text {
      font-size: 14px;
      color: #999999;
    }

    @media (max-width: 768px) {
      .analysis-charts {
        grid-template-columns: 1fr;
      }
    }
  </style>
{% endblock %}

{% block list_stats_content %}
<div class="analysis-stats">
  <div class="analysis-stat-card">
    <div class="analysis-stat-value">{{ plan_total }}</div>
    <div class="analysis-stat-label">计划总数</div>
  </div>
  <div class="analysis-stat-card">
    <div class="analysis-stat-value">{{ goal_total }}</div>
    <div class="analysis-stat-label">目标总数</div>
  </div>
  <div class="analysis-stat-card">
    <div class="analysis-stat-value">{{ issue_total }}</div>
    <div class="analysis-stat-label">问题总数</div>
  </div>
</div>
{% endblock %}

{% block list_filters_content %}
  <div class="col-md-3">
    <label class="form-label">开始时间</label>
    <input type="date" name="date_from" class="list-filter-input" value="{{ date_from }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">结束时间</label>
    <input type="date" name="date_to" class="list-filter-input" value="{{ date_to }}">
  </div>
{% endblock %}

{% block pm_content %}
  {{ block.super }}
  
  <div class="analysis-charts">
    <div class="analysis-chart-card">
      <div class="analysis-chart-header">
        <h5 class="analysis-chart-title">计划状态分布</h5>
      </div>
      <div class="analysis-chart-body">
        <div class="analysis-chart-container">
          <canvas id="planStatusChart"></canvas>
        </div>
      </div>
    </div>

    <div class="analysis-chart-card">
      <div class="analysis-chart-header">
        <h5 class="analysis-chart-title">计划类型分布</h5>
      </div>
      <div class="analysis-chart-body">
        <div class="analysis-chart-container">
          <canvas id="planTypeChart"></canvas>
        </div>
      </div>
    </div>

    <div class="analysis-chart-card">
      <div class="analysis-chart-header">
        <h5 class="analysis-chart-title">目标状态分布</h5>
      </div>
      <div class="analysis-chart-body">
        <div class="analysis-chart-container">
          <canvas id="goalStatusChart"></canvas>
        </div>
      </div>
    </div>

    <div class="analysis-chart-card">
      <div class="analysis-chart-header">
        <h5 class="analysis-chart-title">目标类型分布</h5>
      </div>
      <div class="analysis-chart-body">
        <div class="analysis-chart-container">
          <canvas id="goalTypeChart"></canvas>
        </div>
      </div>
    </div>

    <div class="analysis-chart-card">
      <div class="analysis-chart-header">
        <h5 class="analysis-chart-title">问题状态分布</h5>
      </div>
      <div class="analysis-chart-body">
        <div class="analysis-chart-container">
          <canvas id="issueStatusChart"></canvas>
        </div>
      </div>
    </div>

    <div class="analysis-chart-card">
      <div class="analysis-chart-header">
        <h5 class="analysis-chart-title">问题严重程度分布</h5>
      </div>
      <div class="analysis-chart-body">
        <div class="analysis-chart-container">
          <canvas id="issueSeverityChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  {% if trend_data %}
  <div class="analysis-chart-card">
    <div class="analysis-chart-header">
      <h5 class="analysis-chart-title">趋势分析</h5>
    </div>
    <div class="analysis-chart-body">
      <div class="analysis-trend-chart-container">
        <canvas id="trendChart"></canvas>
      </div>
    </div>
  </div>
  {% endif %}
{% endblock %}

{% block list_table_headers %}{% endblock %}
{% block list_table_rows %}{% endblock %}

{% block module_scripts %}
  <script src="{% static 'js/lib/chart.umd.min.js' %}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      try {
        const planStatusMap = {
          'draft': '草稿',
          'in_progress': '执行中',
          'completed': '已完成',
          'cancelled': '已取消'
        };

        const goalStatusMap = {
          'draft': '制定中',
          'published': '已发布',
          'in_progress': '执行中',
          'completed': '已完成',
          'cancelled': '已取消'
        };

        const issueStatusMap = {
          'open': '待处理',
          'in_progress': '处理中',
          'resolved': '已解决',
          'closed': '已关闭'
        };

        const issueSeverityMap = {
          'low': '低',
          'medium': '中',
          'high': '高',
          'critical': '严重'
        };

        // 计划状态分布
        const planStatusCtx = document.getElementById("planStatusChart").getContext("2d");
        const planStatusLabels = [
          {% for stat in plan_by_status %}
          planStatusMap['{{ stat.status }}'] || '{{ stat.status }}',
          {% endfor %}
        ];
        const planStatusData = [
          {% for stat in plan_by_status %}
          {{ stat.count }},
          {% endfor %}
        ];
        new Chart(planStatusCtx, {
          type: "doughnut",
          data: {
            labels: planStatusLabels,
            datasets: [{
              data: planStatusData,
              backgroundColor: ['#4A90E2', '#50C878', '#FF6B6B', '#FFD93D']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom"
              }
            }
          }
        });

        // 计划类型分布
        const planTypeCtx = document.getElementById("planTypeChart").getContext("2d");
        const planTypeLabels = [
          {% for stat in plan_by_type %}
          '{{ stat.level|default:"未知" }}' === 'personal' ? '个人计划' : '{{ stat.level|default:"未知" }}' === 'company' ? '公司计划' : '{{ stat.level }}',
          {% endfor %}
        ];
        const planTypeData = [
          {% for stat in plan_by_type %}
          {{ stat.count }},
          {% endfor %}
        ];
        new Chart(planTypeCtx, {
          type: "pie",
          data: {
            labels: planTypeLabels,
            datasets: [{
              data: planTypeData,
              backgroundColor: ['#4A90E2', '#50C878', '#FF6B6B', '#FFD93D']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom"
              }
            }
          }
        });

        // 目标状态分布
        const goalStatusCtx = document.getElementById("goalStatusChart").getContext("2d");
        const goalStatusLabels = [
          {% for stat in goal_by_status %}
          goalStatusMap['{{ stat.status }}'] || '{{ stat.status }}',
          {% endfor %}
        ];
        const goalStatusData = [
          {% for stat in goal_by_status %}
          {{ stat.count }},
          {% endfor %}
        ];
        new Chart(goalStatusCtx, {
          type: "doughnut",
          data: {
            labels: goalStatusLabels,
            datasets: [{
              data: goalStatusData,
              backgroundColor: ['#4A90E2', '#50C878', '#FF6B6B', '#FFD93D', '#9B59B6']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom"
              }
            }
          }
        });

        // 目标类型分布
        const goalTypeCtx = document.getElementById("goalTypeChart").getContext("2d");
        const goalTypeLabels = [
          {% for stat in goal_by_type %}
          '{{ stat.goal_type }}',
          {% endfor %}
        ];
        const goalTypeData = [
          {% for stat in goal_by_type %}
          {{ stat.count }},
          {% endfor %}
        ];
        new Chart(goalTypeCtx, {
          type: "pie",
          data: {
            labels: goalTypeLabels,
            datasets: [{
              data: goalTypeData,
              backgroundColor: ['#4A90E2', '#50C878', '#FF6B6B', '#FFD93D', '#9B59B6', '#F39C12']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom"
              }
            }
          }
        });

        // 问题状态分布
        const issueStatusCtx = document.getElementById("issueStatusChart").getContext("2d");
        const issueStatusLabels = [
          {% for stat in issue_by_status %}
          issueStatusMap['{{ stat.status }}'] || '{{ stat.status }}',
          {% endfor %}
        ];
        const issueStatusData = [
          {% for stat in issue_by_status %}
          {{ stat.count }},
          {% endfor %}
        ];
        new Chart(issueStatusCtx, {
          type: "bar",
          data: {
            labels: issueStatusLabels,
            datasets: [{
              label: '问题数量',
              data: issueStatusData,
              backgroundColor: '#999999'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });

        // 问题严重程度分布
        const issueSeverityCtx = document.getElementById("issueSeverityChart").getContext("2d");
        const issueSeverityLabels = [
          {% for stat in issue_by_severity %}
          issueSeverityMap['{{ stat.severity }}'] || '{{ stat.severity }}',
          {% endfor %}
        ];
        const issueSeverityData = [
          {% for stat in issue_by_severity %}
          {{ stat.count }},
          {% endfor %}
        ];
        new Chart(issueSeverityCtx, {
          type: "bar",
          data: {
            labels: issueSeverityLabels,
            datasets: [{
              label: '问题数量',
              data: issueSeverityData,
              backgroundColor: '#999999'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });

        {% if trend_data %}
        // 趋势分析图表
        const trendCtx = document.getElementById("trendChart").getContext("2d");
        const trendLabels = [
          {% for item in trend_data %}
          '{{ item.date }}',
          {% endfor %}
        ];
        new Chart(trendCtx, {
          type: "line",
          data: {
            labels: trendLabels,
            datasets: [
              {
                label: '计划数量',
                data: [
                  {% for item in trend_data %}
                  {{ item.count }},
                  {% endfor %}
                ],
                borderColor: '#666666',
                backgroundColor: 'rgba(102, 102, 102, 0.1)',
                tension: 0.4
              },
              {
                label: '目标数量',
                data: [
                  {% for item in trend_data %}
                  {{ item.count }},
                  {% endfor %}
                ],
                borderColor: '#999999',
                backgroundColor: 'rgba(153, 153, 153, 0.1)',
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            },
            plugins: {
              legend: {
                position: "bottom"
              }
            }
          }
        });
        {% endif %}
      } catch (error) {
        console.error("图表初始化错误:", error);
      }
    });
  </script>
{% endblock %}
