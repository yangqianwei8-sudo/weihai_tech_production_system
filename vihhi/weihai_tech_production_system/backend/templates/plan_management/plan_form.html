{% extends "shared/create_form_base.html" %}
{% load static %}

{% block module_styles %}
{{ block.super }}
<style>
  /* 表单页面移动端优化 */
  @media (max-width: 768px) {
    .form-row {
      flex-direction: column;
    }

    .form-row .col-md-6,
    .form-row .col-md-4,
    .form-row .col-md-3 {
      flex: 0 0 100%;
      max-width: 100%;
      margin-bottom: 16px;
    }

    .form-label {
      font-size: 14px;
      margin-bottom: 6px;
    }

    .form-control,
    .form-select,
    .form-check-input {
      font-size: 16px; /* 防止iOS自动缩放 */
      padding: 10px 12px;
      min-height: 44px; /* 触摸友好尺寸 */
    }

    textarea.form-control {
      min-height: 100px;
    }

    .btn {
      min-height: 44px;
      padding: 10px 20px;
      font-size: 16px;
      margin-bottom: 12px;
    }

    .btn-group {
      flex-direction: column;
      width: 100%;
    }

    .btn-group .btn {
      width: 100%;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .form-actions {
      flex-direction: column;
      gap: 12px;
    }

    .form-actions .btn {
      width: 100%;
    }
  }

  @media (max-width: 576px) {
    .form-control,
    .form-select {
      font-size: 16px;
      padding: 12px;
    }

    .btn {
      padding: 12px 24px;
      font-size: 16px;
    }

    .card {
      padding: 16px;
      margin-bottom: 16px;
    }

    .card-header {
      padding: 12px;
      font-size: 16px;
    }

    .card-body {
      padding: 16px;
    }
  }

  /* 移动端触摸优化 */
  @media (hover: none) and (pointer: coarse) {
    .btn:hover {
      opacity: 0.9;
    }

    input[type="checkbox"],
    input[type="radio"] {
      width: 20px;
      height: 20px;
      min-width: 20px;
    }
  }
</style>
{% endblock %}

{% block form_title %}{{ page_title|default:"创建计划" }}{% endblock %}
{% block form_subtitle %}{{ form_page_subtitle_text|default:"请填写计划基本信息" }}{% endblock %}

{# 覆盖基本信息卡片，添加第二排：计划开始时间、计划结束时间 #}
{% block form_basic_info_card %}
  <div class="form-card form-card-basic-info">
    <div class="form-card-header">
      <h3 class="form-card-title">
        <i class="fas fa-info-circle"></i>
        基本信息
      </h3>
    </div>
    <div class="form-card-body">
      {# 第一排：所属部门、负责人、计划编号、计划级别、计划周期 #}
      <div class="row mb-3 form-row-5">
        {# 固定字段1：所属部门（默认，不可修改） #}
        {% if form.responsible_department %}
        <div class="col-5-fields form-field-wrapper">
          <label for="{{ form.responsible_department.id_for_label }}" class="form-label">
            {% if form.responsible_department.label %}
              {% if "默认" in form.responsible_department.label or "不可修改" in form.responsible_department.label %}
                {{ form.responsible_department.label }}
              {% else %}
                {{ form.responsible_department.label }}（默认，不可修改）
              {% endif %}
            {% else %}
              所属部门（默认，不可修改）
            {% endif %}
            {% if form.responsible_department.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          {{ form.responsible_department }}
          {% if form.responsible_department.errors %}
          <div class="text-danger small">{{ form.responsible_department.errors }}</div>
          {% endif %}
          {% if form.responsible_department.help_text %}
          <div class="form-text">{{ form.responsible_department.help_text }}</div>
          {% endif %}
        </div>
        {% endif %}

        {# 固定字段2：负责人（默认，不可修改） #}
        {% if form.responsible_person %}
        <div class="col-5-fields form-field-wrapper">
          <label for="{{ form.responsible_person.id_for_label }}" class="form-label">
            {% if form.responsible_person.label %}
              {% if "默认" in form.responsible_person.label or "不可修改" in form.responsible_person.label %}
                {{ form.responsible_person.label }}
              {% else %}
                {{ form.responsible_person.label }}（默认，不可修改）
              {% endif %}
            {% else %}
              负责人（默认，不可修改）
            {% endif %}
            {% if form.responsible_person.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          {{ form.responsible_person }}
          {% if form.responsible_person.errors %}
          <div class="text-danger small">{{ form.responsible_person.errors }}</div>
          {% endif %}
          {% if form.responsible_person.help_text %}
          <div class="form-text">{{ form.responsible_person.help_text }}</div>
          {% endif %}
        </div>
        {% endif %}

        {# 固定字段3：计划编号 #}
        {% if form.plan_number %}
        <div class="col-5-fields form-field-wrapper">
          <label for="{{ form.plan_number.id_for_label }}" class="form-label">
            {{ form.plan_number.label }}
            {% if form.plan_number.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          {{ form.plan_number }}
          {% if form.plan_number.errors %}
          <div class="text-danger small">{{ form.plan_number.errors }}</div>
          {% endif %}
          {% if form.plan_number.help_text %}
          <div class="form-text">{{ form.plan_number.help_text }}</div>
          {% endif %}
        </div>
        {% endif %}
        
        {# 第一排额外字段：计划级别、计划周期 #}
        {% block form_first_row_extra_fields %}
          {# 计划级别 #}
          {% if form.level %}
          <div class="col-5-fields form-field-wrapper">
            <label for="{{ form.level.id_for_label }}" class="form-label">
              {{ form.level.label }}
              {% if form.level.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.level }}
            {% if form.level.errors %}
            <div class="text-danger small">{{ form.level.errors }}</div>
            {% endif %}
            {% if form.level.help_text %}
            <div class="form-text">{{ form.level.help_text }}</div>
            {% endif %}
          </div>
          {% endif %}

          {# 计划周期 #}
          {% if form.plan_period %}
          <div class="col-5-fields form-field-wrapper">
            <label for="{{ form.plan_period.id_for_label }}" class="form-label">
              {{ form.plan_period.label }}
              {% if form.plan_period.field.required %}<span class="text-danger">*</span>{% endif %}
            </label>
            {{ form.plan_period }}
            {% if form.plan_period.errors %}
            <div class="text-danger small">{{ form.plan_period.errors }}</div>
            {% endif %}
            {% if form.plan_period.help_text %}
            <div class="form-text">{{ form.plan_period.help_text }}</div>
            {% endif %}
          </div>
          {% endif %}
        {% endblock %}
      </div>

      {# 第二排：计划开始时间、计划结束时间 #}
      <div class="row mb-3 form-row-5">
        {% if form.start_time %}
        <div class="col-5-fields form-field-wrapper">
          <label for="{{ form.start_time.id_for_label }}" class="form-label">
            {{ form.start_time.label }}
            {% if form.start_time.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          {{ form.start_time }}
          {% if form.start_time.errors %}
          <div class="text-danger small">{{ form.start_time.errors }}</div>
          {% endif %}
          {% if form.start_time.help_text %}
          <div class="form-text">{{ form.start_time.help_text }}</div>
          {% endif %}
        </div>
        {% endif %}

        {% if form.end_time %}
        <div class="col-5-fields form-field-wrapper">
          <label for="{{ form.end_time.id_for_label }}" class="form-label">
            {{ form.end_time.label }}
            {% if form.end_time.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          {{ form.end_time }}
          {% if form.end_time.errors %}
          <div class="text-danger small">{{ form.end_time.errors }}</div>
          {% endif %}
          {% if form.end_time.help_text %}
          <div class="form-text">{{ form.end_time.help_text }}</div>
          {% endif %}
        </div>
        {% endif %}
        {# 空占位符，凑满5个字段 #}
        <div class="col-5-fields form-field-wrapper"></div>
        <div class="col-5-fields form-field-wrapper"></div>
        <div class="col-5-fields form-field-wrapper"></div>
      </div>
    </div>
  </div>
{% endblock form_basic_info_card %}

{# 其他表单字段 #}
{% block form_fields %}
  {# 详细信息区域第二排：计划名称、关联战略目标、父计划、关联项目 #}
  <div class="row mb-3 form-row-5">
    {% if form.name %}
    <div class="col-5-fields form-field-wrapper">
      <label for="{{ form.name.id_for_label }}" class="form-label">
        {{ form.name.label }}
        {% if form.name.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.name }}
      {% if form.name.errors %}
      <div class="text-danger small">{{ form.name.errors }}</div>
      {% endif %}
      {% if form.name.help_text %}
      <div class="form-text">{{ form.name.help_text }}</div>
      {% endif %}
    </div>
    {% endif %}
    {% if form.related_goal %}
    <div class="col-5-fields form-field-wrapper">
      <label for="{{ form.related_goal.id_for_label }}" class="form-label">
        {{ form.related_goal.label }}
        {% if form.related_goal.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.related_goal }}
      {% if form.related_goal.errors %}
      <div class="text-danger small">{{ form.related_goal.errors }}</div>
      {% endif %}
      {% if form.related_goal.help_text %}
      <div class="form-text">{{ form.related_goal.help_text }}</div>
      {% endif %}
    </div>
    {% endif %}

    {% if form.parent_plan %}
    <div class="col-5-fields form-field-wrapper">
      <label for="{{ form.parent_plan.id_for_label }}" class="form-label">
        {{ form.parent_plan.label }}
        {% if form.parent_plan.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.parent_plan }}
      {% if form.parent_plan.errors %}
      <div class="text-danger small">{{ form.parent_plan.errors }}</div>
      {% endif %}
      {% if form.parent_plan.help_text %}
      <div class="form-text">{{ form.parent_plan.help_text }}</div>
      {% endif %}
    </div>
    {% endif %}

    {% if form.related_project %}
    <div class="col-5-fields form-field-wrapper">
      <label for="{{ form.related_project.id_for_label }}" class="form-label">
        {{ form.related_project.label }}
        {% if form.related_project.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.related_project }}
      {% if form.related_project.errors %}
      <div class="text-danger small">{{ form.related_project.errors }}</div>
      {% endif %}
      {% if form.related_project.help_text %}
      <div class="form-text">{{ form.related_project.help_text }}</div>
      {% endif %}
    </div>
    {% endif %}
    {# 空占位符，凑满5个字段 #}
    <div class="col-5-fields form-field-wrapper"></div>
  </div>

  {# 第四排：计划内容、计划目标 #}
  <div class="row mb-3 form-row-5">
    {% if form.content %}
    <div class="col-5-fields form-field-wrapper">
      <label for="{{ form.content.id_for_label }}" class="form-label">
        {{ form.content.label }}
        {% if form.content.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.content }}
      {% if form.content.errors %}
      <div class="text-danger small">{{ form.content.errors }}</div>
      {% endif %}
      {% if form.content.help_text %}
      <div class="form-text">{{ form.content.help_text }}</div>
      {% endif %}
    </div>
    {% endif %}

    {% if form.plan_objective %}
    <div class="col-5-fields form-field-wrapper">
      <label for="{{ form.plan_objective.id_for_label }}" class="form-label">
        {{ form.plan_objective.label }}
        {% if form.plan_objective.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.plan_objective }}
      {% if form.plan_objective.errors %}
      <div class="text-danger small">{{ form.plan_objective.errors }}</div>
      {% endif %}
      {% if form.plan_objective.help_text %}
      <div class="form-text">{{ form.plan_objective.help_text }}</div>
      {% endif %}
    </div>
    {% endif %}
    {# 空占位符，凑满5个字段 #}
    <div class="col-5-fields form-field-wrapper"></div>
    <div class="col-5-fields form-field-wrapper"></div>
    <div class="col-5-fields form-field-wrapper"></div>
  </div>

  {# 第五排：协作计划、协作人员 #}
  <div class="row mb-3 form-row-5">
    {% if form.collaboration_plan %}
    <div class="col-5-fields form-field-wrapper">
      <label for="{{ form.collaboration_plan.id_for_label }}" class="form-label">
        {{ form.collaboration_plan.label }}
        {% if form.collaboration_plan.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.collaboration_plan }}
      {% if form.collaboration_plan.errors %}
      <div class="text-danger small">{{ form.collaboration_plan.errors }}</div>
      {% endif %}
      {% if form.collaboration_plan.help_text %}
      <div class="form-text">{{ form.collaboration_plan.help_text }}</div>
      {% endif %}
    </div>
    {% endif %}

    {% if form.participants %}
    <div class="col-5-fields form-field-wrapper">
      <label for="{{ form.participants.id_for_label }}" class="form-label">
        {{ form.participants.label }}
        {% if form.participants.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.participants }}
      {% if form.participants.errors %}
      <div class="text-danger small">{{ form.participants.errors }}</div>
      {% endif %}
      {% if form.participants.help_text %}
      <div class="form-text">{{ form.participants.help_text }}</div>
      {% endif %}
    </div>
    {% endif %}
    {# 空占位符，凑满5个字段 #}
    <div class="col-5-fields form-field-wrapper"></div>
    <div class="col-5-fields form-field-wrapper"></div>
    <div class="col-5-fields form-field-wrapper"></div>
  </div>

{% endblock %}

{# 暂存草稿按钮 #}
{% block form_draft_actions %}
  <button type="submit" name="action" value="draft" class="btn btn-draft">暂存草稿</button>
{% endblock %}

{# 表单操作按钮 #}
{% block form_actions %}
  <button type="submit" class="btn btn-primary">{{ submit_text|default:"创建" }}</button>
  {% if cancel_url %}
    <a href="{{ cancel_url }}" class="btn btn-secondary">取消</a>
  {% elif cancel_url_name %}
    <a href="{% url cancel_url_name %}" class="btn btn-secondary">取消</a>
  {% else %}
    <a href="{% url 'plan_pages:plan_list' %}" class="btn btn-secondary">取消</a>
  {% endif %}
{% endblock %}

{# 额外的 JavaScript #}
{% block module_extra_js %}
  {{ block.super }}
  {% if form_js_file %}
  <script src="{% static form_js_file %}"></script>
  {% endif %}
{% endblock %}
