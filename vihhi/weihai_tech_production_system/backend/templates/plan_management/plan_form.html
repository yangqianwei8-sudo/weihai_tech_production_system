{% extends "shared/create_form_base.html" %}
{% load static %}

{% block module_styles %}
{{ block.super }}
<style>
  /* 计划卡片样式 */
  .plan-item-card {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6 !important;
  }
  
  .plan-item-card h5 {
    color: #495057;
    font-size: 1.1rem;
    font-weight: 600;
  }
  
  .plan-item-card .form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
  }
  
  /* 表单页面移动端优化 */
  @media (max-width: 768px) {
    .form-row {
      flex-direction: column;
    }

    .form-row .col-md-6,
    .form-row .col-md-4,
    .form-row .col-md-3 {
      flex: 0 0 100%;
      max-width: 100%;
      margin-bottom: 16px;
    }

    .form-label {
      font-size: 14px;
      margin-bottom: 6px;
    }

    .form-control,
    .form-select,
    .form-check-input {
      font-size: 16px;
      padding: 10px 12px;
      min-height: 44px;
    }

    textarea.form-control {
      min-height: 100px;
    }

    .btn {
      min-height: 44px;
      padding: 10px 20px;
      font-size: 16px;
      margin-bottom: 12px;
    }

    .btn-group {
      flex-direction: column;
      width: 100%;
    }

    .btn-group .btn {
      width: 100%;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .form-actions {
      flex-direction: column;
      gap: 12px;
    }

    .form-actions .btn {
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block form_title %}{{ page_title|default:"创建计划" }}{% endblock %}
{% block form_subtitle %}{{ form_page_subtitle_text|default:"请填写计划基本信息" }}{% endblock %}

{% block form_actions %}
<button type="button" class="btn btn-primary" id="headerSubmitButton">创建</button>
<button type="button" class="btn btn-secondary" id="draftButton">暂存草稿</button>
{% if list_url %}
  <a href="{{ list_url }}" class="btn btn-secondary">取消</a>
{% elif list_url_name %}
  <a href="{% url list_url_name %}" class="btn btn-secondary">取消</a>
{% elif cancel_url_name %}
  <a href="{% url cancel_url_name %}" class="btn btn-secondary">取消</a>
{% else %}
  <a href="{% url 'plan_pages:plan_list' %}" class="btn btn-secondary">取消</a>
{% endif %}
{% endblock form_actions %}

{# 使用基模板的 form_first_row_fields 块，自动处理所属部门、负责人、计划编号 #}
{% block form_second_row_fields %}
{% endblock form_second_row_fields %}

{# 详细信息卡片：其他字段 #}
{% block form_fields %}
{# 创建模式：所有字段都在FormSet中，基本信息区域只保留所属部门、负责人、表单编号 #}
{# 编辑模式：显示计划的其他字段 #}
{% if plan or form.instance.pk %}
  {# 编辑模式：显示计划的其他字段 #}
  {% if form.name %}
  <div class="row mb-3">
    <div class="col-12 form-field-wrapper">
      <label for="{{ form.name.id_for_label }}" class="form-label">
        {{ form.name.label }}
        {% if form.name.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.name }}
      {% if form.name.errors %}
      <div class="text-danger small">{{ form.name.errors }}</div>
      {% endif %}
    </div>
  </div>
  {% endif %}
  
  {# 计划层级和计划周期 #}
  <div class="row mb-3">
    {% if form.level %}
    <div class="col-md-6 form-field-wrapper">
      <label for="{{ form.level.id_for_label }}" class="form-label">
        {{ form.level.label }}
        {% if form.level.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.level }}
      {% if form.level.errors %}
      <div class="text-danger small">{{ form.level.errors }}</div>
      {% endif %}
    </div>
    {% endif %}
    {% if form.plan_period %}
    <div class="col-md-6 form-field-wrapper">
      <label for="{{ form.plan_period.id_for_label }}" class="form-label">
        {{ form.plan_period.label }}
        {% if form.plan_period.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.plan_period }}
      {% if form.plan_period.errors %}
      <div class="text-danger small">{{ form.plan_period.errors }}</div>
      {% endif %}
      {% if form.plan_period.help_text %}
      <div class="form-text">{{ form.plan_period.help_text }}</div>
      {% endif %}
    </div>
    {% endif %}
  </div>
  
  {# 关联信息 #}
  <div class="row mb-3">
    {% if form.related_goal %}
    <div class="col-md-4 form-field-wrapper">
      <label for="{{ form.related_goal.id_for_label }}" class="form-label">
        {{ form.related_goal.label }}
        {% if form.related_goal.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.related_goal }}
      {% if form.related_goal.errors %}
      <div class="text-danger small">{{ form.related_goal.errors }}</div>
      {% endif %}
    </div>
    {% endif %}
    {% if form.related_project %}
    <div class="col-md-4 form-field-wrapper">
      <label for="{{ form.related_project.id_for_label }}" class="form-label">
        {{ form.related_project.label }}
      </label>
      {{ form.related_project }}
      {% if form.related_project.errors %}
      <div class="text-danger small">{{ form.related_project.errors }}</div>
      {% endif %}
    </div>
    {% endif %}
  </div>
  
  {# 计划内容 #}
  {% if form.content %}
  <div class="row mb-3">
    <div class="col-12 form-field-wrapper">
      <label for="{{ form.content.id_for_label }}" class="form-label">
        {{ form.content.label }}
        {% if form.content.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.content }}
      {% if form.content.errors %}
      <div class="text-danger small">{{ form.content.errors }}</div>
      {% endif %}
    </div>
  </div>
  {% endif %}
  
  {# 计划目标 #}
  {% if form.plan_objective %}
  <div class="row mb-3">
    <div class="col-12 form-field-wrapper">
      <label for="{{ form.plan_objective.id_for_label }}" class="form-label">
        {{ form.plan_objective.label }}
        {% if form.plan_objective.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.plan_objective }}
      {% if form.plan_objective.errors %}
      <div class="text-danger small">{{ form.plan_objective.errors }}</div>
      {% endif %}
    </div>
  </div>
  {% endif %}
  
  {# 验收标准 #}
  {% if form.acceptance_criteria %}
  <div class="row mb-3">
    <div class="col-12 form-field-wrapper">
      <label for="{{ form.acceptance_criteria.id_for_label }}" class="form-label">
        {{ form.acceptance_criteria.label }}
        {% if form.acceptance_criteria.field.required %}<span class="text-danger">*</span>{% endif %}
      </label>
      {{ form.acceptance_criteria }}
      {% if form.acceptance_criteria.errors %}
      <div class="text-danger small">{{ form.acceptance_criteria.errors }}</div>
      {% endif %}
    </div>
  </div>
  {% endif %}
  
  {# 协作计划 #}
  {% if form.collaboration_plan %}
  <div class="row mb-3">
    <div class="col-12 form-field-wrapper">
      <label for="{{ form.collaboration_plan.id_for_label }}" class="form-label">
        {{ form.collaboration_plan.label }}
      </label>
      {{ form.collaboration_plan }}
      {% if form.collaboration_plan.errors %}
      <div class="text-danger small">{{ form.collaboration_plan.errors }}</div>
      {% endif %}
    </div>
  </div>
  {% endif %}
  
  {# 协作人员 #}
  {% if form.participants %}
  <div class="row mb-3">
    <div class="col-12 form-field-wrapper">
      <label for="{{ form.participants.id_for_label }}" class="form-label">
        {{ form.participants.label }}
      </label>
      {{ form.participants }}
      {% if form.participants.errors %}
      <div class="text-danger small">{{ form.participants.errors }}</div>
      {% endif %}
    </div>
  </div>
  {% endif %}
{% endif %}

{# 计划列表 FormSet - 使用普通字段形式（仅创建模式显示） #}
{% if formset and not plan %}
<div class="mt-4 pt-4 border-top">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">计划列表</h5>
    <button type="button" class="btn btn-sm btn-primary" onclick="addPlanItem()">
      <i class="fas fa-plus"></i> 增加计划
    </button>
  </div>
  <div id="planItemsContainer">
  {% if formset %}
  {{ formset.management_form }}
  {% if formset.non_form_errors %}
  <div class="alert alert-danger">
    {{ formset.non_form_errors }}
  </div>
  {% endif %}
  {% for planitem_form in formset %}
  <div class="plan-item-card mb-4 p-3 border rounded" data-form-index="{{ forloop.counter0 }}">
    {{ planitem_form.id }}
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">计划 {{ forloop.counter }}</h5>
      <button type="button" class="btn btn-sm btn-dark" onclick="removePlanItem(this)" title="删除">
        <i class="fas fa-trash"></i> 删除
      </button>
    </div>
    {# 第一行：计划级别、计划周期、开始时间、结束时间、父计划 #}
    <div class="row mb-3 form-row-5">
      {# 计划级别 #}
      {% if form.level %}
      <div class="col-5-fields form-field-wrapper">
        <label for="id_level" class="form-label">
          {{ form.level.label }}
          {% if form.level.field.required %}<span class="text-danger">*</span>{% endif %}
        </label>
        {{ form.level }}
        {% if form.level.errors %}
        <div class="text-danger small">{{ form.level.errors }}</div>
        {% endif %}
      </div>
      {% endif %}

      {# 计划周期 #}
      {% if form.plan_period %}
      <div class="col-5-fields form-field-wrapper">
        <label for="id_plan_period" class="form-label">
          {{ form.plan_period.label }}
          {% if form.plan_period.field.required %}<span class="text-danger">*</span>{% endif %}
        </label>
        {{ form.plan_period }}
        {% if form.plan_period.errors %}
        <div class="text-danger small">{{ form.plan_period.errors }}</div>
        {% endif %}
        {% if form.plan_period.help_text %}
        <div class="form-text">{{ form.plan_period.help_text }}</div>
        {% endif %}
      </div>
      {% endif %}

      {# 开始时间 #}
      <div class="col-5-fields form-field-wrapper">
        <label for="{{ planitem_form.start_time.id_for_label }}" class="form-label">
          开始时间 <span class="text-danger">*</span>
        </label>
        {{ planitem_form.start_time }}
        {% if planitem_form.start_time.errors %}
        <div class="text-danger small">{{ planitem_form.start_time.errors }}</div>
        {% endif %}
      </div>

      {# 结束时间 #}
      <div class="col-5-fields form-field-wrapper">
        <label for="{{ planitem_form.end_time.id_for_label }}" class="form-label">
          结束时间（系统自动计算） <span class="text-danger">*</span>
        </label>
        {{ planitem_form.end_time }}
        {% if planitem_form.end_time.errors %}
        <div class="text-danger small">{{ planitem_form.end_time.errors }}</div>
        {% endif %}
        <div class="form-text text-muted small">根据开始时间和计划周期自动计算</div>
      </div>

      {# 父计划 #}
      <div class="col-5-fields form-field-wrapper">
        <label for="id_parent_plan" class="form-label">父计划</label>
        {% if 'parent_plan' in form.fields %}
          {{ form.parent_plan }}
          {% if form.parent_plan.errors %}
          <div class="text-danger small">{{ form.parent_plan.errors }}</div>
          {% endif %}
        {% else %}
          <select name="parent_plan" class="form-select" id="id_parent_plan">
            <option value="">-------</option>
          </select>
        {% endif %}
        <div class="form-text text-muted small">用于计划分解，选择上级计划（仅显示公司级别计划）</div>
      </div>
    </div>

    {# 第二行：计划名称、关联战略目标、关联项目 #}
    <div class="row mb-3 form-row-5">
      <div class="col-5-fields form-field-wrapper">
        <label for="{{ planitem_form.name.id_for_label }}" class="form-label">
          计划名称 <span class="text-danger">*</span>
        </label>
        {{ planitem_form.name }}
        {% if planitem_form.name.errors %}
        <div class="text-danger small">{{ planitem_form.name.errors }}</div>
        {% endif %}
        {% if planitem_form.non_field_errors %}
        <div class="text-danger small">{{ planitem_form.non_field_errors }}</div>
        {% endif %}
      </div>
      <div class="col-5-fields form-field-wrapper">
        <label for="{{ planitem_form.related_goal.id_for_label }}" class="form-label">
          关联战略目标 <span class="text-danger">*</span>
        </label>
        {{ planitem_form.related_goal }}
        {% if planitem_form.related_goal.errors %}
        <div class="text-danger small">{{ planitem_form.related_goal.errors }}</div>
        {% endif %}
      </div>
      <div class="col-5-fields form-field-wrapper">
        <label for="{{ planitem_form.related_project.id_for_label }}" class="form-label">关联项目</label>
        {{ planitem_form.related_project }}
        {% if planitem_form.related_project.errors %}
        <div class="text-danger small">{{ planitem_form.related_project.errors }}</div>
        {% endif %}
      </div>
      <div class="col-5-fields form-field-wrapper"></div>
      <div class="col-5-fields form-field-wrapper"></div>
    </div>
    
    {# 计划内容：多行文本字段，占据整行 #}
    <div class="row mb-3">
      <div class="col-12 form-field-wrapper">
        <label for="{{ planitem_form.content.id_for_label }}" class="form-label">
          计划内容 <span class="text-danger">*</span>
        </label>
        {{ planitem_form.content }}
        {% if planitem_form.content.errors %}
        <div class="text-danger small">{{ planitem_form.content.errors }}</div>
        {% endif %}
      </div>
    </div>
    
    {# 计划目标：多行文本字段，占据整行 #}
    <div class="row mb-3">
      <div class="col-12 form-field-wrapper">
        <label for="{{ planitem_form.plan_objective.id_for_label }}" class="form-label">
          计划目标 <span class="text-danger">*</span>
        </label>
        {{ planitem_form.plan_objective }}
        {% if planitem_form.plan_objective.errors %}
        <div class="text-danger small">{{ planitem_form.plan_objective.errors }}</div>
        {% endif %}
      </div>
    </div>
    
    {# 验收标准：多行文本字段，占据整行 #}
    <div class="row mb-3">
      <div class="col-12 form-field-wrapper">
        <label for="{{ planitem_form.acceptance_criteria.id_for_label }}" class="form-label">
          验收标准 <span class="text-danger">*</span>
        </label>
        {{ planitem_form.acceptance_criteria }}
        {% if planitem_form.acceptance_criteria.errors %}
        <div class="text-danger small">{{ planitem_form.acceptance_criteria.errors }}</div>
        {% endif %}
      </div>
    </div>
    
    {# 协作计划：多行文本字段，占据整行 #}
    <div class="row mb-3">
      <div class="col-12 form-field-wrapper">
        <label for="{{ planitem_form.collaboration_plan.id_for_label }}" class="form-label">协作计划</label>
        {{ planitem_form.collaboration_plan }}
        {% if planitem_form.collaboration_plan.errors %}
        <div class="text-danger small">{{ planitem_form.collaboration_plan.errors }}</div>
        {% endif %}
      </div>
    </div>
    
    {# 协作人员：多选字段，占据整行 #}
    <div class="row mb-3">
      <div class="col-12 form-field-wrapper">
        <label for="{{ planitem_form.participants.id_for_label }}" class="form-label">协作人员</label>
        {{ planitem_form.participants }}
        {% if planitem_form.participants.errors %}
        <div class="text-danger small">{{ planitem_form.participants.errors }}</div>
        {% endif %}
      </div>
    </div>
    {# DELETE字段：隐藏的复选框，用于标记要删除的计划项 #}
    <div style="display: none;">
      {{ planitem_form.DELETE }}
    </div>
  </div>
  {% endfor %}
  {% else %}
  <div class="alert alert-info">
    <i class="fas fa-info-circle"></i>
    计划列表功能未启用
  </div>
  {% endif %}
  </div>
</div>
{% endif %}
{% endblock form_fields %}

{# 周计划重复创建错误提示模态框 #}
{% if weekly_plan_error %}
<div class="modal fade" id="weeklyPlanErrorModal" tabindex="-1" aria-labelledby="weeklyPlanErrorModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="weeklyPlanErrorModalLabel">
          <i class="fas fa-exclamation-triangle"></i> 周计划创建失败
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">{{ weekly_plan_error }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">我知道了</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

{# 额外的 JavaScript #}
{% block module_extra_js %}
  {{ block.super }}
  {% if form_js_file %}
  <script src="{% static form_js_file %}"></script>
  {% endif %}
  
  {# 表单提交前验证 #}
  <script>
  (function() {
    'use strict';
    
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('createForm');
      if (!form) return;
      
      form.addEventListener('submit', function(e) {
        const formsetCards = document.querySelectorAll('#planItemsContainer .plan-item-card');
        const errors = [];
        let hasValidPlan = false;
        let visibleIndex = 0;
        
        formsetCards.forEach(function(card) {
          const deleteCheckbox = card.querySelector('input[type="checkbox"][name*="DELETE"]');
          if (deleteCheckbox && deleteCheckbox.checked) {
            return;
          }
          
          const name = card.querySelector('input[name*="name"]');
          const relatedGoal = card.querySelector('select[name*="related_goal"]');
          const content = card.querySelector('textarea[name*="content"]');
          const planObjective = card.querySelector('textarea[name*="plan_objective"]');
          const startTime = card.querySelector('input[name*="start_time"]');
          const endTime = card.querySelector('input[name*="end_time"]');
          
          const hasData = (name && name.value.trim()) || 
                         (relatedGoal && relatedGoal.value) || 
                         (content && content.value.trim()) || 
                         (planObjective && planObjective.value.trim()) ||
                         (startTime && startTime.value) || 
                         (endTime && endTime.value);
          
          if (hasData) {
            hasValidPlan = true;
            const rowNum = visibleIndex + 1;
            
            if (!name || !name.value.trim()) {
              errors.push(`第 ${rowNum} 行：计划名称不能为空`);
            }
            if (!relatedGoal || !relatedGoal.value) {
              errors.push(`第 ${rowNum} 行：关联战略目标不能为空`);
            }
            if (!content || !content.value.trim()) {
              errors.push(`第 ${rowNum} 行：计划内容不能为空`);
            }
            if (!planObjective || !planObjective.value.trim()) {
              errors.push(`第 ${rowNum} 行：计划目标不能为空`);
            }
            if (!startTime || !startTime.value) {
              errors.push(`第 ${rowNum} 行：开始时间不能为空`);
            }
            if (!endTime || !endTime.value) {
              errors.push(`第 ${rowNum} 行：结束时间不能为空`);
            }
            
            if (startTime && startTime.value && endTime && endTime.value) {
              const startDate = new Date(startTime.value);
              const endDate = new Date(endTime.value);
              if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                errors.push(`第 ${rowNum} 行：日期格式无效`);
              } else if (endDate <= startDate) {
                errors.push(`第 ${rowNum} 行：结束时间必须晚于开始时间`);
              }
            }
            
            visibleIndex++;
          }
        });
        
        if (!hasValidPlan && formsetCards.length > 0) {
          errors.push('请至少填写一个完整的计划信息');
        }
        
        if (errors.length > 0) {
          e.preventDefault();
          alert('❌ 表单验证失败\n\n' + errors.join('\n') + '\n\n请填写完整后重新提交。');
          return false;
        }
      });
    });
  })();
  </script>
  
  {# 计划列表 Formset 动态添加/删除功能 #}
  {% if formset %}
  <script>
  (function() {
    'use strict';
    
    let planItemFormCount = {{ formset.total_form_count }};
    const planItemFormPrefix = 'planitems';
    
    /**
     * 统一的日期计算函数：根据开始日期和计划周期计算结束日期
     */
    function calculateEndDateByPeriod(startDateObj, planPeriod) {
      let endDate = new Date(startDateObj);
      switch(planPeriod) {
        case 'yearly':
          endDate.setFullYear(endDate.getFullYear() + 1);
          endDate.setDate(endDate.getDate() - 1);
          break;
        case 'quarterly':
          endDate.setMonth(endDate.getMonth() + 3);
          endDate.setDate(endDate.getDate() - 1);
          break;
        case 'monthly':
          endDate.setMonth(endDate.getMonth() + 1);
          endDate.setDate(endDate.getDate() - 1);
          break;
        case 'weekly':
          endDate.setDate(endDate.getDate() + 6);
          break;
        case 'daily':
          endDate.setDate(endDate.getDate() + 1);
          break;
        default:
          return startDateObj;
      }
      return endDate;
    }
    
    /**
     * 格式化日期为 YYYY-MM-DD 字符串
     */
    function formatDateString(dateObj) {
      const year = dateObj.getFullYear();
      const month = String(dateObj.getMonth() + 1).padStart(2, '0');
      const day = String(dateObj.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    /**
     * 计算并设置结束时间
     */
    function calculateEndTime(startInput, endInput, planPeriod) {
      const startDate = startInput.value.trim();
      if (!startDate || !planPeriod) return;
      
      const startDateObj = new Date(startDate);
      if (isNaN(startDateObj.getTime())) return;
      
      const endDate = calculateEndDateByPeriod(startDateObj, planPeriod);
      endInput.value = formatDateString(endDate);
    }
    
    function updatePlanItemFormIndexes() {
      const container = document.getElementById('planItemsContainer');
      if (!container) return;
      
      const cards = container.querySelectorAll('.plan-item-card');
      let visibleIndex = 0;
      
      cards.forEach((card) => {
        const deleteCheckbox = card.querySelector('input[type="checkbox"][name*="DELETE"]');
        if (deleteCheckbox && deleteCheckbox.checked) {
          return; // 跳过已标记删除的项
        }
        
        card.dataset.formIndex = visibleIndex;
        const title = card.querySelector('h5');
        if (title) {
          title.textContent = '计划 ' + (visibleIndex + 1);
        }
        
        card.querySelectorAll('input, select, textarea').forEach(field => {
          if (field.name && field.name.includes(planItemFormPrefix)) {
            const nameParts = field.name.split('-');
            if (nameParts.length >= 3 && nameParts[0] === planItemFormPrefix) {
              const fieldName = nameParts.slice(2).join('-');
              field.name = `${planItemFormPrefix}-${visibleIndex}-${fieldName}`;
              if (field.id) {
                const idParts = field.id.split('-');
                if (idParts.length >= 3 && idParts[0] === 'id' && idParts[1] === planItemFormPrefix) {
                  field.id = `id_${planItemFormPrefix}-${visibleIndex}-${fieldName}`;
                }
              }
            }
          }
        });
        
        visibleIndex++;
      });
      
      const totalFormsInput = document.querySelector(`input[name="${planItemFormPrefix}-TOTAL_FORMS"]`);
      if (totalFormsInput) {
        totalFormsInput.value = visibleIndex;
      }
    }
    
    function addPlanItem() {
      const container = document.getElementById('planItemsContainer');
      if (!container) return;
      
      const newCard = document.createElement('div');
      newCard.className = 'plan-item-card mb-4 p-3 border rounded';
      newCard.dataset.formIndex = planItemFormCount;
      
      // 获取现有选项
      const existingGoalSelect = container.querySelector('select[name*="related_goal"]');
      let goalOptions = '<option value="">---------</option>';
      if (existingGoalSelect) {
        existingGoalSelect.querySelectorAll('option').forEach(option => {
          goalOptions += `<option value="${option.value}">${option.text}</option>`;
        });
      }
      
      const existingParticipantsSelect = container.querySelector('select[name*="participants"]');
      let participantsOptions = '';
      if (existingParticipantsSelect) {
        existingParticipantsSelect.querySelectorAll('option').forEach(option => {
          let displayText = option.text;
          if (displayText.includes(' - ')) {
            displayText = displayText.split(' - ')[1] || displayText.split(' - ')[0];
          }
          participantsOptions += `<option value="${option.value}">${displayText}</option>`;
        });
      }
      
      // 获取基本信息区域的全局字段选项（所有计划项共享）
      const levelSelect = document.getElementById('id_level');
      let levelOptions = '<option value="">---------</option>';
      if (levelSelect) {
        levelSelect.querySelectorAll('option').forEach(option => {
          levelOptions += `<option value="${option.value}" ${option.selected ? 'selected' : ''}>${option.text}</option>`;
        });
      }
      
      const planPeriodSelect = document.getElementById('id_plan_period');
      let planPeriodOptions = '<option value="">---------</option>';
      if (planPeriodSelect) {
        planPeriodSelect.querySelectorAll('option').forEach(option => {
          planPeriodOptions += `<option value="${option.value}" ${option.selected ? 'selected' : ''}>${option.text}</option>`;
        });
      }
      
      const parentPlanSelect = document.getElementById('id_parent_plan');
      let parentPlanOptions = '<option value="">-------</option>';
      if (parentPlanSelect) {
        parentPlanSelect.querySelectorAll('option').forEach(option => {
          parentPlanOptions += `<option value="${option.value}" ${option.selected ? 'selected' : ''}>${option.text}</option>`;
        });
      }
      
      newCard.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">计划 ${planItemFormCount + 1}</h5>
          <button type="button" class="btn btn-sm btn-dark" onclick="removePlanItem(this)" title="删除">
            <i class="fas fa-trash"></i> 删除
          </button>
        </div>
        <div class="row mb-3 form-row-5">
          <div class="col-5-fields form-field-wrapper">
            <label class="form-label">计划级别 <span class="text-danger">*</span></label>
            <select name="level" class="form-select" id="id_level" required>
              ${levelOptions}
            </select>
            <div class="form-text text-muted small">从基本信息区域继承</div>
          </div>
          <div class="col-5-fields form-field-wrapper">
            <label class="form-label">计划周期 <span class="text-danger">*</span></label>
            <select name="plan_period" class="form-select" id="id_plan_period" required>
              ${planPeriodOptions}
            </select>
            <div class="form-text text-muted small">从基本信息区域继承，所有计划项共享</div>
          </div>
          <div class="col-5-fields form-field-wrapper">
            <label class="form-label">开始时间 <span class="text-danger">*</span></label>
            <input type="date" name="${planItemFormPrefix}-${planItemFormCount}-start_time" 
                   class="form-control" 
                   id="id_${planItemFormPrefix}-${planItemFormCount}-start_time">
          </div>
          <div class="col-5-fields form-field-wrapper">
            <label class="form-label">结束时间（系统自动计算） <span class="text-danger">*</span></label>
            <input type="date" name="${planItemFormPrefix}-${planItemFormCount}-end_time" 
                   class="form-control" 
                   id="id_${planItemFormPrefix}-${planItemFormCount}-end_time"
                   readonly
                   style="background-color: #e9ecef; cursor: not-allowed;">
            <div class="form-text text-muted small">根据开始时间和计划周期自动计算</div>
          </div>
          <div class="col-5-fields form-field-wrapper">
            <label class="form-label">父计划</label>
            <select name="parent_plan" class="form-select" id="id_parent_plan">
              ${parentPlanOptions}
            </select>
            <div class="form-text text-muted small">从基本信息区域继承，用于计划分解</div>
          </div>
        </div>
        <div class="row mb-3 form-row-5">
          <div class="col-5-fields form-field-wrapper">
            <label class="form-label">计划名称</label>
            <input type="text" name="${planItemFormPrefix}-${planItemFormCount}-name" 
                   class="form-control" 
                   placeholder="请输入计划名称" maxlength="200" 
                   id="id_${planItemFormPrefix}-${planItemFormCount}-name">
          </div>
          <div class="col-5-fields form-field-wrapper">
            <label class="form-label">关联战略目标 <span class="text-danger">*</span></label>
            <select name="${planItemFormPrefix}-${planItemFormCount}-related_goal" 
                    class="form-select" 
                    id="id_${planItemFormPrefix}-${planItemFormCount}-related_goal">
              ${goalOptions}
            </select>
          </div>
          <div class="col-5-fields form-field-wrapper">
            <label class="form-label">关联项目</label>
            <input type="text" name="${planItemFormPrefix}-${planItemFormCount}-related_project" 
                   class="form-control" 
                   placeholder="请输入关联项目" maxlength="200" 
                   id="id_${planItemFormPrefix}-${planItemFormCount}-related_project">
          </div>
          <div class="col-5-fields form-field-wrapper"></div>
          <div class="col-5-fields form-field-wrapper"></div>
        </div>
        <div class="row mb-3">
          <div class="col-12 form-field-wrapper">
            <label class="form-label">计划内容 <span class="text-danger">*</span></label>
            <textarea name="${planItemFormPrefix}-${planItemFormCount}-content" 
                      class="form-control" 
                      rows="2" placeholder="请输入计划内容" maxlength="5000" 
                      id="id_${planItemFormPrefix}-${planItemFormCount}-content"></textarea>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-12 form-field-wrapper">
            <label class="form-label">计划目标 <span class="text-danger">*</span></label>
            <textarea name="${planItemFormPrefix}-${planItemFormCount}-plan_objective" 
                      class="form-control" 
                      rows="2" placeholder="请输入计划目标" maxlength="1000" 
                      id="id_${planItemFormPrefix}-${planItemFormCount}-plan_objective"></textarea>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-12 form-field-wrapper">
            <label class="form-label">验收标准 <span class="text-danger">*</span></label>
            <textarea name="${planItemFormPrefix}-${planItemFormCount}-acceptance_criteria" 
                      class="form-control" 
                      rows="2" placeholder="请输入验收标准" maxlength="1000" 
                      required
                      id="id_${planItemFormPrefix}-${planItemFormCount}-acceptance_criteria"></textarea>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-12 form-field-wrapper">
            <label class="form-label">协作计划</label>
            <textarea name="${planItemFormPrefix}-${planItemFormCount}-collaboration_plan" 
                      class="form-control" 
                      rows="2" placeholder="请输入协作计划" maxlength="2000" 
                      id="id_${planItemFormPrefix}-${planItemFormCount}-collaboration_plan"></textarea>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-12 form-field-wrapper">
            <label class="form-label">协作人员</label>
            <select name="${planItemFormPrefix}-${planItemFormCount}-participants" 
                    class="form-select" 
                    multiple 
                    size="3"
                    id="id_${planItemFormPrefix}-${planItemFormCount}-participants">
              ${participantsOptions}
            </select>
          </div>
        </div>
        <input type="checkbox" name="${planItemFormPrefix}-${planItemFormCount}-DELETE" 
               id="id_${planItemFormPrefix}-${planItemFormCount}-DELETE" 
               style="display: none;">
      `;
      
      container.appendChild(newCard);
      planItemFormCount++;
      updatePlanItemFormIndexes();
      
      // 绑定日期计算事件
      setTimeout(function() {
        const newStartTimeInput = newCard.querySelector('input[name*="start_time"]');
        const newEndTimeInput = newCard.querySelector('input[name*="end_time"]');
        // 使用基本信息区域的全局计划周期选择器（所有计划项共享同一个计划周期）
        const planPeriodSelect = document.getElementById('id_plan_period');
        
        if (newStartTimeInput && newEndTimeInput) {
          function calculateEndTimeForPlanItem() {
            const planPeriod = planPeriodSelect ? planPeriodSelect.value : '';
            if (planPeriod) {
              calculateEndTime(newStartTimeInput, newEndTimeInput, planPeriod);
            }
          }
          
          // 绑定开始时间变化事件
          newStartTimeInput.addEventListener('change', calculateEndTimeForPlanItem);
          newStartTimeInput.addEventListener('input', calculateEndTimeForPlanItem);
          
          // 如果已有开始时间和计划周期，立即计算结束时间
          if (newStartTimeInput.value.trim() && planPeriodSelect && planPeriodSelect.value) {
            calculateEndTimeForPlanItem();
          }
        }
      }, 100);
    }
    
    function removePlanItem(btn) {
      const card = btn.closest('.plan-item-card');
      if (!card) return;
      
      const deleteCheckbox = card.querySelector('input[type="checkbox"][name*="DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = true;
        card.style.display = 'none';
        card.style.opacity = '0.5';
      } else {
        card.remove();
      }
      updatePlanItemFormIndexes();
    }
    
    function initEndTimeCalculationForExistingItems() {
      const container = document.getElementById('planItemsContainer');
      const planPeriodSelect = document.getElementById('id_plan_period');
      if (!container) return;
      
      // 为全局计划周期选择器绑定事件（只绑定一次）
      if (planPeriodSelect && !planPeriodSelect.dataset.endTimeCalculated) {
        planPeriodSelect.dataset.endTimeCalculated = 'true';
        planPeriodSelect.addEventListener('change', function() {
          const allCards = container.querySelectorAll('.plan-item-card');
          allCards.forEach(function(card) {
            const deleteCheckbox = card.querySelector('input[type="checkbox"][name*="DELETE"]');
            if (deleteCheckbox && deleteCheckbox.checked) return;
            
            const startInput = card.querySelector('input[name*="start_time"]');
            const endInput = card.querySelector('input[name*="end_time"]');
            if (startInput && endInput && startInput.value.trim()) {
              calculateEndTime(startInput, endInput, planPeriodSelect.value);
            }
          });
        });
      }
      
      // 为每个计划项的开始时间输入框绑定事件
      const planItemCards = container.querySelectorAll('.plan-item-card');
      planItemCards.forEach(function(card) {
        const deleteCheckbox = card.querySelector('input[type="checkbox"][name*="DELETE"]');
        if (deleteCheckbox && deleteCheckbox.checked) return;
        
        const startTimeInput = card.querySelector('input[name*="start_time"]');
        const endTimeInput = card.querySelector('input[name*="end_time"]');
        
        if (startTimeInput && endTimeInput && !startTimeInput.dataset.endTimeCalculated) {
          function calculateEndTimeForPlanItem() {
            if (planPeriodSelect && planPeriodSelect.value) {
              calculateEndTime(startTimeInput, endTimeInput, planPeriodSelect.value);
            }
          }
          
          startTimeInput.dataset.endTimeCalculated = 'true';
          startTimeInput.addEventListener('change', calculateEndTimeForPlanItem);
          startTimeInput.addEventListener('input', calculateEndTimeForPlanItem);
          
          // 如果已有开始时间和计划周期，立即计算结束时间
          if (startTimeInput.value.trim() && planPeriodSelect && planPeriodSelect.value) {
            calculateEndTimeForPlanItem();
          }
        }
      });
    }
    
    // 暴露全局函数
    window.addPlanItem = addPlanItem;
    window.removePlanItem = removePlanItem;
    
    document.addEventListener('DOMContentLoaded', function() {
      updatePlanItemFormIndexes();
      initEndTimeCalculationForExistingItems();
    });
  })();
  </script>
  {% endif %}
  
  {# 显示周计划重复创建错误模态框 #}
  {% if weekly_plan_error %}
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const modalElement = document.getElementById('weeklyPlanErrorModal');
    if (modalElement) {
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    }
  });
  </script>
  {% endif %}
{% endblock %}
