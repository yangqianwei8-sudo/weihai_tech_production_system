{% extends "shared/list_page_base.html" %}
{% load static %}

{% block page_title %}ç›®æ ‡è°ƒæ•´åˆ—è¡¨{% endblock page_title %}
{% block page_subtitle %}æŸ¥çœ‹å’Œç®¡ç†ç›®æ ‡è°ƒæ•´ç”³è¯·{% endblock page_subtitle %}

{% block module_styles %}
  {{ block.super }}
  <style>
    .list-badge-pending { background: #FFF3CD; color: #856404; border-color: #FFE69C; }
    .list-badge-approved { background: #D1E7DD; color: #0F5132; border-color: #A3CFBB; }
    .list-badge-rejected { background: #F8D7DA; color: #842029; border-color: #F1AEB5; }
    .list-badge-none { background: #E9ECEF; color: #6C757D; border-color: #DEE2E6; }
  </style>
{% endblock %}

{% block list_stats_content %}
  <div class="row g-3">
    <div class="col-md-3">
      <div class="list-stat-card">
        <div class="list-stat-label">å¯è°ƒæ•´ç›®æ ‡æ€»æ•°</div>
        <div class="list-stat-value">{{ total_count|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="list-stat-card">
        <div class="list-stat-label">å¾…å®¡æ‰¹</div>
        <div class="list-stat-value">{{ pending_count|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="list-stat-card">
        <div class="list-stat-label">å·²æ‰¹å‡†</div>
        <div class="list-stat-value">{{ approved_count|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="list-stat-card">
        <div class="list-stat-label">å·²æ‹’ç»</div>
        <div class="list-stat-value">{{ rejected_count|default:0 }}</div>
      </div>
    </div>
  </div>
{% endblock list_stats_content %}

{% block list_filters_content %}
  <div class="col-md-3">
    <label class="form-label">æœç´¢</label>
    <input type="text" name="search" class="form-control" value="{{ search }}" placeholder="ç›®æ ‡ç¼–å·ã€åç§°ã€è´Ÿè´£äºº">
  </div>
  <div class="col-md-3">
    <label class="form-label">ç›®æ ‡</label>
    <select name="goal" class="form-select">
      <option value="">å…¨éƒ¨ç›®æ ‡</option>
      {% for goal in all_goals %}
      <option value="{{ goal.id }}" {% if goal_filter|stringformat:"s" == goal.id|stringformat:"s" %}selected{% endif %}>
        {{ goal.goal_number }} - {{ goal.name|truncatewords:5 }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">è°ƒæ•´ç”³è¯·çŠ¶æ€</label>
    <select name="adjustment_status" class="form-select">
      <option value="">å…¨éƒ¨</option>
      <option value="pending" {% if adjustment_status_filter == 'pending' %}selected{% endif %}>å¾…å®¡æ‰¹</option>
      <option value="approved" {% if adjustment_status_filter == 'approved' %}selected{% endif %}>å·²æ‰¹å‡†</option>
      <option value="rejected" {% if adjustment_status_filter == 'rejected' %}selected{% endif %}>å·²æ‹’ç»</option>
      <option value="none" {% if adjustment_status_filter == 'none' %}selected{% endif %}>æ— è°ƒæ•´ç”³è¯·</option>
    </select>
  </div>
{% endblock list_filters_content %}

{% block list_table_headers %}
  <th>ç›®æ ‡ç¼–å·</th>
  <th>ç›®æ ‡åç§°</th>
  <th>ç›®æ ‡çŠ¶æ€</th>
  <th>è°ƒæ•´ç”³è¯·çŠ¶æ€</th>
  <th>ç”³è¯·äºº</th>
  <th>ç”³è¯·æ—¶é—´</th>
  <th>æ“ä½œ</th>
{% endblock list_table_headers %}

{% block list_table_rows %}
  {% for item in page_obj %}
  {% with goal=item.goal latest_adjustment=item.latest_adjustment %}
  <tr>
    <td>
      <code>{{ goal.goal_number }}</code>
    </td>
    <td>
      <a href="{% url 'plan_pages:strategic_goal_detail' goal.id %}" class="text-dark text-decoration-none fw-medium">
        {{ goal.name }}
      </a>
    </td>
    <td>
      <span class="list-badge list-badge-{{ goal.status }}">
        {{ goal.get_status_display }}
      </span>
    </td>
    <td>
      {% if latest_adjustment %}
        <span class="list-badge list-badge-{{ latest_adjustment.status }}">
          {{ latest_adjustment.get_status_display }}
        </span>
      {% else %}
        <span class="list-badge list-badge-none">æ— è°ƒæ•´ç”³è¯·</span>
      {% endif %}
    </td>
    <td>
      {% if latest_adjustment and latest_adjustment.created_by %}
        {{ latest_adjustment.created_by.get_full_name|default:latest_adjustment.created_by.username }}
      {% else %}
        <span style="color: #999999;">-</span>
      {% endif %}
    </td>
    <td>
      {% if latest_adjustment %}
        {{ latest_adjustment.created_time|date:"Y-m-d H:i" }}
      {% else %}
        <span style="color: #999999;">-</span>
      {% endif %}
    </td>
    <td>
      <div class="btn-group btn-group-sm">
        <a href="{% url 'plan_pages:strategic_goal_detail' goal.id %}" class="btn btn-sm btn-secondary">æŸ¥çœ‹ç›®æ ‡</a>
        {% if goal.status in 'published,in_progress' %}
          {% if not latest_adjustment or latest_adjustment.status != 'pending' %}
            <a href="{% url 'plan_pages:goal_adjustment_create' goal.id %}" class="btn btn-sm btn-primary">ç”³è¯·è°ƒæ•´</a>
          {% endif %}
        {% endif %}
        {% if can_approve and latest_adjustment and latest_adjustment.status == 'pending' %}
          <a href="{% url 'plan_pages:goal_adjustment_approve' latest_adjustment.id %}" class="btn btn-sm btn-success">å®¡æ‰¹</a>
          <a href="{% url 'plan_pages:goal_adjustment_reject' latest_adjustment.id %}" class="btn btn-sm btn-danger">æ‹’ç»</a>
        {% endif %}
      </div>
    </td>
  </tr>
  {% endwith %}
  {% empty %}
  <tr>
    <td colspan="7" class="list-empty-state">
      <div class="list-empty-state-icon">ğŸ“‹</div>
      <div class="list-empty-state-text">æš‚æ— ç¬¦åˆæ¡ä»¶çš„ç›®æ ‡</div>
      <div class="list-empty-state-hint">è¯·è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–åˆ›å»ºç›®æ ‡</div>
    </td>
  </tr>
  {% endfor %}
{% endblock list_table_rows %}
