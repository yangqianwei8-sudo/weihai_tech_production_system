{% extends "shared/list_page_base.html" %}
{% load static %}

{% block module_title %}计划管理{% endblock %}
{% block page_title %}
  {% block pm_title %}目标达成分析{% endblock pm_title %}
{% endblock page_title %}

{% block page_subtitle %}
  {% block pm_subtitle %}<span class="pm-subtitle">分析战略目标的达成情况和统计数据</span>{% endblock pm_subtitle %}
{% endblock page_subtitle %}

{% block title %}目标达成分析 - 维海科技信息化管理平台{% endblock %}


{% block module_styles %}
  {{ block.super }}
  <style>
    .analysis-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .analysis-stat-card {
      background: #FFFFFF;
      border: 1px solid #E0E0E0;
      border-radius: 0;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.2s ease;
    }

    .analysis-stat-card:hover {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .analysis-stat-value {
      font-size: 32px;
      font-weight: 600;
      color: #1A1A1A;
      line-height: 1.2;
      margin-bottom: 8px;
    }

    .analysis-stat-label {
      font-size: 12px;
      color: #666666;
      font-weight: 400;
    }

    .analysis-charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .analysis-chart-card {
      background: #FFFFFF;
      border: 1px solid #E0E0E0;
      border-radius: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .analysis-chart-header {
      padding: 16px 20px;
      border-bottom: 1px solid #E0E0E0;
      background: #F5F5F5;
    }

    .analysis-chart-title {
      font-size: 14px;
      font-weight: 600;
      color: #1A1A1A;
      margin: 0;
    }

    .analysis-chart-body {
      padding: 20px;
    }

    .analysis-chart-container {
      position: relative;
      height: 300px;
    }

    .analysis-table-card {
      background: #FFFFFF;
      border: 1px solid #E0E0E0;
      border-radius: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }

    .analysis-table-header {
      padding: 16px 20px;
      border-bottom: 1px solid #E0E0E0;
      background: #F5F5F5;
    }

    .analysis-table-title {
      font-size: 14px;
      font-weight: 600;
      color: #1A1A1A;
      margin: 0;
    }

    .analysis-empty {
      background: #FFFFFF;
      border: 1px solid #E0E0E0;
      border-radius: 0;
      padding: 60px 20px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .analysis-empty-icon {
      font-size: 48px;
      color: #CCCCCC;
      margin-bottom: 16px;
      display: block;
    }

    .analysis-empty-title {
      font-size: 16px;
      font-weight: 600;
      color: #666666;
      margin-bottom: 8px;
    }

    .analysis-empty-text {
      font-size: 14px;
      color: #999999;
    }

    @media (max-width: 768px) {
      .analysis-charts {
        grid-template-columns: 1fr;
      }
    }
  </style>
{% endblock %}

{% block list_stats_content %}
{% endblock %}

{% block list_filters_content %}
  <div class="col-md-3">
    <label class="form-label">开始时间</label>
    <input type="date" name="date_from" class="list-filter-input" value="{{ date_from }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">结束时间</label>
    <input type="date" name="date_to" class="list-filter-input" value="{{ date_to }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">目标类型</label>
    <select name="goal_type" class="list-filter-input">
      <option value="">全部类型</option>
      <option value="financial" {% if goal_type == 'financial' %}selected{% endif %}>财务目标</option>
      <option value="market" {% if goal_type == 'market' %}selected{% endif %}>市场目标</option>
      <option value="operation" {% if goal_type == 'operation' %}selected{% endif %}>运营目标</option>
      <option value="innovation" {% if goal_type == 'innovation' %}selected{% endif %}>创新目标</option>
      <option value="talent" {% if goal_type == 'talent' %}selected{% endif %}>人才目标</option>
      <option value="other" {% if goal_type == 'other' %}selected{% endif %}>其他</option>
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">目标周期</label>
    <select name="goal_period" class="list-filter-input">
      <option value="">全部周期</option>
      <option value="annual" {% if goal_period == 'annual' %}selected{% endif %}>年度目标</option>
      <option value="half_year" {% if goal_period == 'half_year' %}selected{% endif %}>半年目标</option>
      <option value="quarterly" {% if goal_period == 'quarterly' %}selected{% endif %}>季度目标</option>
    </select>
  </div>
{% endblock %}

{% block pm_content %}
  {{ block.super }}
  
  {% if total_count > 0 %}
  <div class="analysis-charts">
    <div class="analysis-chart-card">
      <div class="analysis-chart-header">
        <h5 class="analysis-chart-title">状态分布</h5>
      </div>
      <div class="analysis-chart-body">
        <div class="analysis-chart-container">
          <canvas id="statusChart"></canvas>
        </div>
      </div>
    </div>

    <div class="analysis-chart-card">
      <div class="analysis-chart-header">
        <h5 class="analysis-chart-title">完成率分布</h5>
      </div>
      <div class="analysis-chart-body">
        <div class="analysis-chart-container">
          <canvas id="completionChart"></canvas>
        </div>
      </div>
    </div>

    <div class="analysis-chart-card">
      <div class="analysis-chart-header">
        <h5 class="analysis-chart-title">类型分布</h5>
      </div>
      <div class="analysis-chart-body">
        <div class="analysis-chart-container">
          <canvas id="typeChart"></canvas>
        </div>
      </div>
    </div>

    <div class="analysis-chart-card">
      <div class="analysis-chart-header">
        <h5 class="analysis-chart-title">周期分布</h5>
      </div>
      <div class="analysis-chart-body">
        <div class="analysis-chart-container">
          <canvas id="periodChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  {% if high_completion_goals %}
  <div class="analysis-table-card">
    <div class="analysis-table-header">
      <h5 class="analysis-table-title">高完成率目标（≥80%）</h5>
    </div>
    <div class="list-table-container">
      <table class="list-table">
        <thead>
          <tr>
            <th>目标名称</th>
            <th>目标类型</th>
            <th>完成率</th>
            <th>负责人</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for goal in high_completion_goals %}
          <tr>
            <td>
              <a href="{% url 'plan_pages:strategic_goal_detail' goal.id %}">
                {{ goal.name }}
              </a>
            </td>
            <td>
              <span class="list-badge">{{ goal.get_goal_type_display }}</span>
            </td>
            <td>
              <div class="list-progress">
                <div class="list-progress-fill" style="width: {{ goal.completion_rate }}%"></div>
                <span class="list-progress-text">{{ goal.completion_rate }}%</span>
              </div>
            </td>
            <td>
              <div style="font-size: 12px; color: #333333;">{{ goal.responsible_person.get_full_name|default:goal.responsible_person.username }}</div>
            </td>
            <td>
              <a href="{% url 'plan_pages:strategic_goal_detail' goal.id %}" class="list-btn" title="查看详情">查看</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if low_completion_goals %}
  <div class="analysis-table-card">
    <div class="analysis-table-header">
      <h5 class="analysis-table-title">低完成率目标（<50%）</h5>
    </div>
    <div class="list-table-container">
      <table class="list-table">
        <thead>
          <tr>
            <th>目标名称</th>
            <th>目标类型</th>
            <th>完成率</th>
            <th>负责人</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for goal in low_completion_goals %}
          <tr>
            <td>
              <a href="{% url 'plan_pages:strategic_goal_detail' goal.id %}">
                {{ goal.name }}
              </a>
            </td>
            <td>
              <span class="list-badge">{{ goal.get_goal_type_display }}</span>
            </td>
            <td>
              <div class="list-progress">
                <div class="list-progress-fill" style="width: {{ goal.completion_rate }}%"></div>
                <span class="list-progress-text">{{ goal.completion_rate }}%</span>
              </div>
            </td>
            <td>
              <div style="font-size: 12px; color: #333333;">{{ goal.responsible_person.get_full_name|default:goal.responsible_person.username }}</div>
            </td>
            <td>
              <a href="{% url 'plan_pages:strategic_goal_detail' goal.id %}" class="list-btn" title="查看详情">查看</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
  {% else %}
  <div class="analysis-empty">
    <span class="analysis-empty-icon">▢</span>
    <div class="analysis-empty-title">暂无数据</div>
    <div class="analysis-empty-text">请调整筛选条件后重试</div>
  </div>
  {% endif %}
{% endblock %}

{% block list_table_headers %}{% endblock %}
{% block list_table_rows %}{% endblock %}

{% block module_scripts %}
  <script src="{% static 'js/lib/chart.umd.min.js' %}"></script>
  <script>
    {% if total_count > 0 %}
    document.addEventListener("DOMContentLoaded", function() {
      try {
        const statusMap = {
          'draft': '制定中',
          'published': '已发布',
          'accepted': '已接收',
          'in_progress': '执行中',
          'completed': '已完成',
          'cancelled': '已取消'
        };

        const typeMap = {
          'financial': '财务目标',
          'market': '市场目标',
          'operation': '运营目标',
          'innovation': '创新目标',
          'talent': '人才目标',
          'other': '其他'
        };

        const periodMap = {
          'annual': '年度目标',
          'half_year': '半年目标',
          'quarterly': '季度目标'
        };

        // 状态分布图表
        const statusCtx = document.getElementById("statusChart").getContext("2d");
        const statusLabels = [
          {% for stat in status_stats %}
          statusMap['{{ stat.status }}'] || '{{ stat.status }}',
          {% endfor %}
        ];
        const statusData = [
          {% for stat in status_stats %}
          {{ stat.count }},
          {% endfor %}
        ];
        new Chart(statusCtx, {
          type: "doughnut",
          data: {
            labels: statusLabels,
            datasets: [{
              data: statusData,
              backgroundColor: ['#4A90E2', '#50C878', '#FF6B6B', '#FFD93D', '#9B59B6', '#F39C12']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom"
              }
            }
          }
        });

        // 完成率分布图表
        const completionCtx = document.getElementById("completionChart").getContext("2d");
        new Chart(completionCtx, {
          type: "bar",
          data: {
            labels: ["0-25%", "25-50%", "50-75%", "75-100%", "100%"],
            datasets: [{
              label: "目标数量",
              data: [
                {{ completion_distribution.completion_0_25 }},
                {{ completion_distribution.completion_25_50 }},
                {{ completion_distribution.completion_50_75 }},
                {{ completion_distribution.completion_75_100 }},
                {{ completion_distribution.completion_100 }}
              ],
              backgroundColor: '#666666'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });

        // 类型分布图表
        const typeCtx = document.getElementById("typeChart").getContext("2d");
        const typeLabels = [
          {% for stat in type_stats %}
          typeMap['{{ stat.goal_type }}'] || '{{ stat.goal_type }}',
          {% endfor %}
        ];
        const typeData = [
          {% for stat in type_stats %}
          {{ stat.count }},
          {% endfor %}
        ];
        new Chart(typeCtx, {
          type: "pie",
          data: {
            labels: typeLabels,
            datasets: [{
              data: typeData,
              backgroundColor: ['#4A90E2', '#50C878', '#FF6B6B', '#FFD93D', '#9B59B6', '#F39C12']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom"
              }
            }
          }
        });

        // 周期分布图表
        const periodCtx = document.getElementById("periodChart").getContext("2d");
        const periodLabels = [
          {% for stat in period_stats %}
          periodMap['{{ stat.goal_period }}'] || '{{ stat.goal_period }}',
          {% endfor %}
        ];
        const periodData = [
          {% for stat in period_stats %}
          {{ stat.count }},
          {% endfor %}
        ];
        new Chart(periodCtx, {
          type: "bar",
          data: {
            labels: periodLabels,
            datasets: [{
              label: "目标数量",
              data: periodData,
              backgroundColor: '#999999'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      } catch (error) {
        console.error("图表初始化错误:", error);
      }
    });
    {% endif %}
  </script>
{% endblock %}
