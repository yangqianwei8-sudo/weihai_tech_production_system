{% extends "shared/list_page_base.html" %}
{% load static %}

{% block pm_title %}ç›®æ ‡åˆ—è¡¨{% endblock pm_title %}
{% block pm_subtitle %}æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰æˆ˜ç•¥ç›®æ ‡{% endblock pm_subtitle %}


{% block list_stats_content %}
  {# ç»Ÿè®¡å¡ç‰‡ - ç›´æ¥æ”¾åœ¨ list-page-stats ä¸­ï¼ŒCSSä¼šè‡ªåŠ¨ä¸€è¡Œæ’åˆ— #}
  <div class="list-stat-card">
    <div class="list-stat-label">ç›®æ ‡æ€»æ•°</div>
    <div class="list-stat-value">{{ total_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">åˆ¶å®šä¸­</div>
    <div class="list-stat-value">{{ draft_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">å·²å‘å¸ƒ</div>
    <div class="list-stat-value">{{ published_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">æ‰§è¡Œä¸­</div>
    <div class="list-stat-value">{{ in_progress_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">å·²å®Œæˆ</div>
    <div class="list-stat-value">{{ completed_count|default:0 }}</div>
  </div>
  <div class="list-stat-card">
    <div class="list-stat-label">å·²å–æ¶ˆ</div>
    <div class="list-stat-value">{{ cancelled_count|default:0 }}</div>
  </div>
{% endblock list_stats_content %}

{% block list_filters_content %}
  {# ç­›é€‰å™¨åŒºåŸŸ #}
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">æœç´¢</label>
    <input type="text" name="search" class="form-control" value="{{ search }}" placeholder="ç›®æ ‡ç¼–å·ã€åç§°ã€è´Ÿè´£äºº">
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">çŠ¶æ€</label>
    <select name="status" class="form-select">
      <option value="">å…¨éƒ¨çŠ¶æ€</option>
      {% for value, label in status_options %}
      <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">ç›®æ ‡å±‚çº§</label>
    <select name="level" class="form-select">
      <option value="">å…¨éƒ¨å±‚çº§</option>
      {% for value, label in level_choices %}
      <option value="{{ value }}" {% if level_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">ç›®æ ‡ç±»å‹</label>
    <select name="goal_type" class="form-select">
      <option value="">å…¨éƒ¨ç±»å‹</option>
      {% for value, label in goal_type_choices %}
      <option value="{{ value }}" {% if goal_type_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">ç›®æ ‡å‘¨æœŸ</label>
    <select name="goal_period" class="form-select">
      <option value="">å…¨éƒ¨å‘¨æœŸ</option>
      {% for value, label in goal_period_choices %}
      <option value="{{ value }}" {% if goal_period_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">è´Ÿè´£äºº</label>
    <select name="responsible" class="form-select">
      <option value="">å…¨éƒ¨è´Ÿè´£äºº</option>
      {% for u in all_users %}
      <option value="{{ u.id }}" {% if responsible_filter|stringformat:"s" == u.id|stringformat:"s" %}selected{% endif %}>
        {{ u.get_full_name|default:u.username }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">å¼€å§‹æ—¥æœŸ</label>
    <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
  </div>
  <div class="list-page-filter-item">
    <label class="list-page-filter-label">ç»“æŸæ—¥æœŸ</label>
    <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
  </div>
{% endblock list_filters_content %}

{% block list_table_checkbox_header %}
  <th style="width: 50px;">
    <input type="checkbox" id="selectAll" class="form-check-input" title="å…¨é€‰">
  </th>
{% endblock list_table_checkbox_header %}

{% block list_table_headers %}
  <th>ç›®æ ‡ç¼–å·</th>
  <th>ç›®æ ‡åç§°</th>
  <th>ç›®æ ‡å±‚çº§</th>
  <th>ç›®æ ‡ç±»å‹</th>
  <th>ç›®æ ‡å‘¨æœŸ</th>
  <th>å…³è”ç›®æ ‡</th>
  <th>è´Ÿè´£äºº</th>
  <th>æ—¶é—´èŒƒå›´</th>
  <th>è¿›åº¦</th>
  <th>çŠ¶æ€</th>
  <th>æ“ä½œ</th>
{% endblock list_table_headers %}

{% block list_table_rows %}
  {% if page_obj %}
    {% for goal in page_obj %}
    <tr>
      <td>
        <input type="checkbox" class="form-check-input row-checkbox" name="item_ids" value="{{ goal.id }}" id="item_{{ goal.id }}">
      </td>
      <td><code>{{ goal.goal_number }}</code></td>
      <td>
        <a href="{% url 'plan_pages:strategic_goal_detail' goal.id %}" class="text-dark text-decoration-none fw-medium">
          {{ goal.name }}
        </a>
      </td>
      <td>
        <span class="badge">{{ goal.get_level_display }}</span>
      </td>
      <td>{{ goal.get_goal_type_display }}</td>
      <td>{{ goal.get_goal_period_display }}</td>
      <td>
        {% if goal.parent_goal %}
        <a href="{% url 'plan_pages:strategic_goal_detail' goal.parent_goal.id %}" class="text-muted text-decoration-none">
          {{ goal.parent_goal.name|truncatewords:5 }}
        </a>
        {% else %}
        <span class="text-muted">-</span>
        {% endif %}
      </td>
      <td>{{ goal.responsible_person.get_full_name|default:goal.responsible_person.username }}</td>
      <td>
        <small class="text-muted">
          {{ goal.start_date|date:"Y-m-d" }}<br>
          è‡³ {{ goal.end_date|date:"Y-m-d" }}
        </small>
      </td>
      <td>
        <div class="d-flex align-items-center gap-2">
          <div class="flex-grow-1" style="height: 8px; background: #F0F0F0;">
            <div style="height: 100%; background: #333333; width: {{ goal.completion_rate }}%;"></div>
          </div>
          <small class="text-muted">{{ goal.completion_rate }}%</small>
        </div>
      </td>
      <td>
        <span class="badge">{{ goal.get_status_display }}</span>
      </td>
      <td>
        <div class="list-page-table-actions">
          <a href="{% url 'plan_pages:strategic_goal_detail' goal.id %}" class="action-view" title="æŸ¥çœ‹">
            <i class="bi bi-eye"></i>
          </a>
          {% if goal.status in 'draft,published' %}
          <span class="action-separator">|</span>
          <a href="{% url 'plan_pages:strategic_goal_edit' goal.id %}" class="action-edit" title="ç¼–è¾‘">
            <i class="bi bi-pencil"></i>
          </a>
          {% endif %}
        </div>
      </td>
    </tr>
    {% endfor %}
  {% else %}
    <tr>
      <td colspan="12" class="list-empty">
        <div class="list-empty-icon">ğŸ¯</div>
        <div class="list-empty-text">æš‚æ— ç›®æ ‡æ•°æ®</div>
      </td>
    </tr>
  {% endif %}
{% endblock list_table_rows %}

{% block list_empty_hint %}
  <div class="list-empty-hint">è¯·åˆ›å»ºç¬¬ä¸€ä¸ªç›®æ ‡å¼€å§‹ä½¿ç”¨</div>
{% endblock list_empty_hint %}

{% block extra_js %}
  <!-- é…ç½®åˆ—è¡¨ç­›é€‰åŠŸèƒ½ -->
  <script>
  window.listFiltersConfig = {
    selectFieldNames: ['status', 'level', 'goal_type', 'goal_period', 'responsible'],
    dateStartFieldName: 'date_from',
    dateEndFieldName: 'date_to'
  };
  </script>
  <!-- å¼•å…¥åˆ—è¡¨ç­›é€‰åŠŸèƒ½æ¨¡å— -->
  <script src="{% static 'js/list-filters.js' %}"></script>
  
  <!-- å¤é€‰æ¡†åŠŸèƒ½è°ƒè¯• -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('å¤é€‰æ¡†åŠŸèƒ½è°ƒè¯•ï¼š');
    const selectAll = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    console.log('å…¨é€‰å¤é€‰æ¡†:', selectAll);
    console.log('è¡Œå¤é€‰æ¡†æ•°é‡:', rowCheckboxes.length);
    console.log('list-checkbox.js æ˜¯å¦åŠ è½½:', typeof window.getSelectedIds === 'function');
    
    // å¦‚æœJavaScriptæ²¡æœ‰åŠ è½½ï¼Œæ‰‹åŠ¨åˆå§‹åŒ–
    if (selectAll && rowCheckboxes.length > 0 && typeof window.getSelectedIds !== 'function') {
      console.warn('list-checkbox.js æœªåŠ è½½ï¼Œæ‰‹åŠ¨åˆå§‹åŒ–å¤é€‰æ¡†åŠŸèƒ½');
      selectAll.addEventListener('change', function() {
        rowCheckboxes.forEach(function(cb) {
          cb.checked = this.checked;
        }, this);
      });
      rowCheckboxes.forEach(function(cb) {
        cb.addEventListener('change', function() {
          const allChecked = Array.from(rowCheckboxes).every(function(c) {
            return c.checked;
          });
          selectAll.checked = allChecked;
        });
      });
    }
  });
  </script>
{% endblock extra_js %}
