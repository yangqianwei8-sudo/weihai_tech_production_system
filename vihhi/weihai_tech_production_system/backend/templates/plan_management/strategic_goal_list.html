{% extends "shared/list_page_base.html" %}
{% load static %}

{% block page_title %}ç›®æ ‡åˆ—è¡¨{% endblock page_title %}
{% block page_subtitle %}æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰æˆ˜ç•¥ç›®æ ‡{% endblock page_subtitle %}


{% block list_stats_content %}
  <div class="row g-3">
    <div class="col-md-2">
      <div class="list-stat-card">
        <div class="list-stat-label">ç›®æ ‡æ€»æ•°</div>
        <div class="list-stat-value">{{ total_count|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="list-stat-card">
        <div class="list-stat-label">åˆ¶å®šä¸­</div>
        <div class="list-stat-value">{{ draft_count|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="list-stat-card">
        <div class="list-stat-label">å·²å‘å¸ƒ</div>
        <div class="list-stat-value">{{ published_count|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="list-stat-card">
        <div class="list-stat-label">æ‰§è¡Œä¸­</div>
        <div class="list-stat-value">{{ in_progress_count|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="list-stat-card">
        <div class="list-stat-label">å·²å®Œæˆ</div>
        <div class="list-stat-value">{{ completed_count|default:0 }}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="list-stat-card">
        <div class="list-stat-label">å·²å–æ¶ˆ</div>
        <div class="list-stat-value">{{ cancelled_count|default:0 }}</div>
      </div>
    </div>
  </div>
{% endblock list_stats_content %}
{% block list_filters_content %}
  
  <div class="col-md-3">
    <label class="form-label">æœç´¢</label>
    <input type="text" name="search" class="form-control" value="{{ search }}" placeholder="ç›®æ ‡ç¼–å·ã€åç§°ã€è´Ÿè´£äºº">
  </div>
  <div class="col-md-2">
    <label class="form-label">çŠ¶æ€</label>
    <select name="status" class="form-select">
      <option value="">å…¨éƒ¨çŠ¶æ€</option>
      {% for value, label in status_options %}
      <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">ç›®æ ‡å±‚çº§</label>
    <select name="level" class="form-select">
      <option value="">å…¨éƒ¨å±‚çº§</option>
      {% for value, label in level_choices %}
      <option value="{{ value }}" {% if level_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">ç›®æ ‡ç±»å‹</label>
    <select name="goal_type" class="form-select">
      <option value="">å…¨éƒ¨ç±»å‹</option>
      {% for value, label in goal_type_choices %}
      <option value="{{ value }}" {% if goal_type_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">ç›®æ ‡å‘¨æœŸ</label>
    <select name="goal_period" class="form-select">
      <option value="">å…¨éƒ¨å‘¨æœŸ</option>
      {% for value, label in goal_period_choices %}
      <option value="{{ value }}" {% if goal_period_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">è´Ÿè´£äºº</label>
    <select name="responsible" class="form-select">
      <option value="">å…¨éƒ¨è´Ÿè´£äºº</option>
      {% for u in all_users %}
      <option value="{{ u.id }}" {% if responsible_filter|stringformat:"s" == u.id|stringformat:"s" %}selected{% endif %}>
        {{ u.get_full_name|default:u.username }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
    <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
  </div>
  <div class="col-md-2">
    <label class="form-label">ç»“æŸæ—¥æœŸ</label>
    <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
  </div>
{% endblock list_filters_content %}
{% block list_table_headers %}
  <th>ç›®æ ‡ç¼–å·</th>
  <th>ç›®æ ‡åç§°</th>
  <th>ç›®æ ‡å±‚çº§</th>
  <th>ç›®æ ‡ç±»å‹</th>
  <th>ç›®æ ‡å‘¨æœŸ</th>
  <th>å…³è”ç›®æ ‡</th>
  <th>è´Ÿè´£äºº</th>
  <th>æ—¶é—´èŒƒå›´</th>
  <th>è¿›åº¦</th>
  <th>çŠ¶æ€</th>
  <th>æ“ä½œ</th>
{% endblock list_table_headers %}

{% block list_table_rows %}
  {% for goal in page_obj %}
  <tr>
    <td><code>{{ goal.goal_number }}</code></td>
    <td>
      <a href="{% url 'plan_pages:strategic_goal_detail' goal.id %}" class="text-dark text-decoration-none fw-medium">
        {{ goal.name }}
      </a>
    </td>
    <td>
      <span class="badge">{{ goal.get_level_display }}</span>
    </td>
    <td>{{ goal.get_goal_type_display }}</td>
    <td>{{ goal.get_goal_period_display }}</td>
    <td>
      {% if goal.parent_goal %}
      <a href="{% url 'plan_pages:strategic_goal_detail' goal.parent_goal.id %}" class="text-muted text-decoration-none">
        {{ goal.parent_goal.name|truncatewords:5 }}
      </a>
      {% else %}
      <span class="text-muted">-</span>
      {% endif %}
    </td>
    <td>{{ goal.responsible_person.get_full_name|default:goal.responsible_person.username }}</td>
    <td>
      <small class="text-muted">
        {{ goal.start_date|date:"Y-m-d" }}<br>
        è‡³ {{ goal.end_date|date:"Y-m-d" }}
      </small>
    </td>
    <td>
      <div class="d-flex align-items-center gap-2">
        <div class="flex-grow-1" style="height: 8px; background: #F0F0F0;">
          <div style="height: 100%; background: #333333; width: {{ goal.completion_rate }}%;"></div>
        </div>
        <small class="text-muted">{{ goal.completion_rate }}%</small>
      </div>
    </td>
    <td>
      <span class="badge">{{ goal.get_status_display }}</span>
    </td>
    <td>
      <div class="btn-group btn-group-sm">
        <a href="{% url 'plan_pages:strategic_goal_detail' goal.id %}" class="btn btn-sm">æŸ¥çœ‹</a>
        {% if goal.status in 'draft,published' %}
        <a href="{% url 'plan_pages:strategic_goal_edit' goal.id %}" class="btn btn-sm">ç¼–è¾‘</a>
        {% endif %}
      </div>
    </td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="11" class="list-empty-state">
      <div class="list-empty-state-icon">ğŸ¯</div>
      <div class="list-empty-state-text">æš‚æ— ç›®æ ‡æ•°æ®</div>
      <div class="list-empty-state-hint">è¯·åˆ›å»ºç¬¬ä¸€ä¸ªç›®æ ‡å¼€å§‹ä½¿ç”¨</div>
    </td>
  </tr>
  {% endfor %}
{% endblock list_table_rows %}



{% block extra_js %}
  <!-- é…ç½®åˆ—è¡¨ç­›é€‰åŠŸèƒ½ -->
  <script>
  window.listFiltersConfig = {
    selectFieldNames: ['status', 'level', 'goal_type', 'goal_period', 'responsible'],
    dateStartFieldName: 'date_from',
    dateEndFieldName: 'date_to'
  };
  </script>
  <!-- å¼•å…¥åˆ—è¡¨ç­›é€‰åŠŸèƒ½æ¨¡å— -->
  <script src="{% static 'js/list-filters.js' %}"></script>
{% endblock extra_js %}
