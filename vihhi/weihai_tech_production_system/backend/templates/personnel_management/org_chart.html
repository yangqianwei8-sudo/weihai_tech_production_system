{% extends "personnel_management/base.html" %}
{% load static %}

{% block title %}{{ page_title }} - 维海科技信息化管理平台{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'personnel_pages:organization_management' %}">组织架构</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ page_title }}</li>
{% endblock %}

{% block extra_css %}
<style>
    .org-chart-container {
        background: #fff;
        border-radius: 18px;
        padding: 24px;
        box-shadow: 0 12px 32px rgba(20, 47, 91, 0.08);
        border: 1px solid rgba(20, 47, 91, 0.08);
        min-height: 600px;
    }
    .org-stats {
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
        padding: 20px;
        background: linear-gradient(135deg, rgba(20,47,91,0.05), rgba(31,62,124,0.03));
        border-radius: 12px;
    }
    .org-stat-item {
        flex: 1;
        text-align: center;
    }
    .org-stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #142F5B;
        margin-bottom: 4px;
    }
    .org-stat-label {
        font-size: 14px;
        color: #6b7280;
    }
    .org-tree {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .org-node {
        padding: 16px 20px;
        background: #fff;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin: 10px;
        min-width: 200px;
        text-align: center;
        transition: all 0.3s ease;
    }
    .org-node:hover {
        border-color: #142F5B;
        box-shadow: 0 6px 16px rgba(20,47,91,0.15);
        transform: translateY(-2px);
    }
    .org-node-name {
        font-size: 16px;
        font-weight: 600;
        color: #142F5B;
        margin-bottom: 8px;
    }
    .org-node-code {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 6px;
    }
    .org-node-info {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #e5e7eb;
    }
    .org-chart-placeholder {
        text-align: center;
        padding: 100px 20px;
        color: #6b7280;
    }
</style>
{% endblock %}

{% block personnel_content %}
<!-- 统计信息 -->
<div class="org-stats">
    <div class="org-stat-item">
        <div class="org-stat-value">{{ total_departments }}</div>
        <div class="org-stat-label">部门总数</div>
    </div>
    <div class="org-stat-item">
        <div class="org-stat-value">{{ total_employees }}</div>
        <div class="org-stat-label">员工总数</div>
    </div>
</div>

<!-- 组织架构图 -->
<div class="org-chart-container">
    <div id="orgChart" class="org-tree">
        <div class="org-chart-placeholder">
            <i class="bi bi-diagram-3" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
            <p>组织架构图加载中...</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const departmentTree = {{ department_tree|safe|default:"[]" }};
    const container = document.getElementById('orgChart');
    
    if (!departmentTree || departmentTree.length === 0) {
        container.innerHTML = '<div class="org-chart-placeholder"><i class="bi bi-info-circle" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i><p>暂无组织架构数据</p></div>';
        return;
    }
    
    // 简单的树形结构渲染
    function renderTree(nodes, parentElement, level = 0) {
        if (!nodes || nodes.length === 0) return;
        
        const levelContainer = document.createElement('div');
        levelContainer.style.display = 'flex';
        levelContainer.style.justifyContent = 'center';
        levelContainer.style.flexWrap = 'wrap';
        levelContainer.style.marginBottom = level > 0 ? '20px' : '0';
        
        nodes.forEach((node, index) => {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'org-node';
            nodeDiv.innerHTML = `
                <div class="org-node-name">${node.name}</div>
                <div class="org-node-code">${node.code}</div>
                <div class="org-node-info">
                    <div>负责人: ${node.leader}</div>
                    <div>员工数: ${node.employee_count} 人</div>
                </div>
            `;
            
            levelContainer.appendChild(nodeDiv);
            
            // 递归渲染子节点
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.style.width = '100%';
                childrenContainer.style.marginTop = '20px';
                renderTree(node.children, childrenContainer, level + 1);
                levelContainer.appendChild(childrenContainer);
            }
        });
        
        parentElement.appendChild(levelContainer);
    }
    
    container.innerHTML = '';
    renderTree(departmentTree, container);
});
</script>
{% endblock %}
