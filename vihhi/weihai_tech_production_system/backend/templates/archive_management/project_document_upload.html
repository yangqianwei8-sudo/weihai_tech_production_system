{% extends "shared/module_base.html" %}
{% load static %}

{% block title %}ä¸Šä¼ é¡¹ç›®æ–‡æ¡£ - æ¡£æ¡ˆç®¡ç†{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<style>
    .form-group {
        margin-bottom: 20px;
    }
    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: block;
    }
    .required-field::after {
        content: " *";
        color: #ef4444;
    }
    .form-section {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
    }
    .form-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid #f3f4f6;
    }
    .form-section-header h5 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
    }
    .form-card {
        background: #ffffff;
        border-radius: 8px;
        padding: 0;
    }
    .form-page-title {
        margin-bottom: 24px;
    }
    .form-page-title h1 {
        font-size: 24px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
    }
    .form-page-title p {
        color: #6b7280;
        margin: 0;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'archive_management:project_document_list' %}">é¡¹ç›®æ–‡æ¡£</a></li>
<li class="breadcrumb-item active" aria-current="page">ä¸Šä¼ æ–‡æ¡£</li>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <div class="form-page-title">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>ğŸ“¤ ä¸Šä¼ é¡¹ç›®æ–‡æ¡£</h1>
                <p>ä¸Šä¼ é¡¹ç›®ç›¸å…³æ–‡æ¡£ï¼Œæ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼</p>
            </div>
            <div>
                <a href="{% url 'archive_management:project_document_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> è¿”å›åˆ—è¡¨
                </a>
            </div>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="uploadForm" class="form-card">
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {{ form.non_field_errors }}
        </div>
        {% endif %}

        {% if form.errors %}
        <div class="alert alert-danger">
            <h6><i class="bi bi-exclamation-triangle"></i> è¡¨å•éªŒè¯å¤±è´¥</h6>
            <ul class="mb-0">
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                    <li>{{ field }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="form-section">
            <div class="form-section-header">
                <h5>åŸºç¡€ä¿¡æ¯</h5>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.document_name.id_for_label }}" class="form-label required-field">
                            {{ form.document_name.label }}
                        </label>
                        {{ form.document_name }}
                        {% if form.document_name.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.document_name.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">è¯·è¾“å…¥æ–‡æ¡£åç§°</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.document_type.id_for_label }}" class="form-label">
                            {{ form.document_type.label }}
                        </label>
                        {{ form.document_type }}
                        {% if form.document_type.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.document_type.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">é€‰æ‹©æ–‡æ¡£ç±»å‹</small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.project.id_for_label }}" class="form-label required-field">
                            {{ form.project.label }}
                        </label>
                        {{ form.project }}
                        {% if form.project.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.project.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">é€‰æ‹©æ‰€å±é¡¹ç›®</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.category.id_for_label }}" class="form-label">
                            {{ form.category.label }}
                        </label>
                        {{ form.category }}
                        {% if form.category.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.category.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">é€‰æ‹©æ–‡æ¡£åˆ†ç±»</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="form-section-header">
                <h5>æ–‡ä»¶ä¿¡æ¯</h5>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label for="{{ form.file.id_for_label }}" class="form-label required-field">
                            {{ form.file.label }}
                        </label>
                        {{ form.file }}
                        {% if form.file.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.file.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">
                            æ”¯æŒæ ¼å¼ï¼šPDFã€Word (.doc, .docx)ã€Excel (.xls, .xlsx)ã€PPT (.ppt, .pptx)ã€TXTã€å›¾ç‰‡ (JPG, PNG)ã€CAD (.dwg)ã€å‹ç¼©åŒ… (ZIP, RAR)
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="form-section-header">
                <h5>é™„åŠ ä¿¡æ¯</h5>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            {{ form.description.label }}
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.description.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">å¯é€‰çš„æ–‡æ¡£æè¿°ä¿¡æ¯</small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.tags.id_for_label }}" class="form-label">
                            {{ form.tags.label }}
                        </label>
                        {{ form.tags }}
                        {% if form.tags.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.tags.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">å¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="{{ form.security_level.id_for_label }}" class="form-label">
                            {{ form.security_level.label }}
                        </label>
                        {{ form.security_level }}
                        {% if form.security_level.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.security_level.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">é€‰æ‹©æ–‡æ¡£å¯†çº§</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="{{ form.version.id_for_label }}" class="form-label">
                            {{ form.version.label }}
                        </label>
                        {{ form.version }}
                        {% if form.version.errors %}
                        <div class="text-danger" style="font-size: 12px; margin-top: 4px;">{{ form.version.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">å¦‚ï¼šv1.0</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mb-4">
            <a href="{% url 'archive_management:project_document_list' %}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> å–æ¶ˆ
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-upload"></i> ä¸Šä¼ æ–‡æ¡£
            </button>
        </div>
    </form>

    {% if projects %}
    <div class="form-section">
        <div class="form-section-header">
            <h5>å¿«é€Ÿé€‰æ‹©é¡¹ç›®</h5>
            <span class="badge bg-secondary">å…± {{ projects|length }} ä¸ªé¡¹ç›®</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th>é¡¹ç›®ç¼–å·</th>
                        <th>é¡¹ç›®åç§°</th>
                        <th>å®¢æˆ·åç§°</th>
                        <th>é¡¹ç›®çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr>
                        <td><code>{{ project.project_number|default:"-" }}</code></td>
                        <td>{{ project.project_name|default:"-" }}</td>
                        <td>{{ project.client.client_name|default:"-" }}</td>
                        <td>
                            <span class="badge bg-{% if project.status == 'in_progress' %}primary{% elif project.status == 'settled' %}success{% else %}info{% endif %}">
                                {{ project.get_status_display|default:"-" }}
                            </span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="selectProject({{ project.id }}, '{{ project.project_name }}')">
                                <i class="bi bi-check-circle"></i> é€‰æ‹©
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="form-section">
        <div class="form-section-header">
            <h5>ä¸Šä¼ è¯´æ˜</h5>
        </div>
        <div class="alert alert-info mb-3">
            <h6><i class="bi bi-info-circle"></i> æ”¯æŒçš„æ–‡ä»¶æ ¼å¼</h6>
            <ul class="mb-0">
                <li><strong>æ–‡æ¡£ç±»</strong>ï¼šPDFã€Word (.doc, .docx)ã€Excel (.xls, .xlsx)ã€PPT (.ppt, .pptx)ã€TXT</li>
                <li><strong>å›¾ç‰‡ç±»</strong>ï¼šJPGã€JPEGã€PNGã€GIF</li>
                <li><strong>è®¾è®¡ç±»</strong>ï¼šCAD (.dwg)ã€å…¶ä»–è®¾è®¡æ–‡ä»¶</li>
                <li><strong>å‹ç¼©ç±»</strong>ï¼šZIPã€RAR</li>
            </ul>
        </div>
        <div class="alert alert-warning mb-0">
            <h6><i class="bi bi-exclamation-triangle"></i> æ³¨æ„äº‹é¡¹</h6>
            <ul class="mb-0">
                <li>æ–‡æ¡£åç§°å’Œæ–‡ä»¶ä¸ºå¿…å¡«é¡¹</li>
                <li>å»ºè®®æ–‡ä»¶å¤§å°ä¸è¶…è¿‡100MB</li>
                <li>æ–‡æ¡£ç¼–å·å°†è‡ªåŠ¨ç”Ÿæˆ</li>
                <li>ä¸Šä¼ åæ–‡æ¡£çŠ¶æ€ä¸º"å¾…å½’æ¡£"ï¼Œéœ€è¦å½’æ¡£åæ‰èƒ½æ­£å¼ä½¿ç”¨</li>
            </ul>
        </div>
    </div>
</div>

<script>
function selectProject(projectId, projectName) {
    // è®¾ç½®é¡¹ç›®é€‰æ‹©æ¡†çš„å€¼
    const projectSelect = document.getElementById('{{ form.project.id_for_label }}');
    if (projectSelect) {
        projectSelect.value = projectId;
        projectSelect.dispatchEvent(new Event('change'));
    }

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.innerHTML = `
        <i class="bi bi-check-circle"></i> å·²é€‰æ‹©é¡¹ç›®ï¼š${projectName}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.form-card').insertBefore(alertDiv, document.querySelector('.form-card').firstChild);

    // æ»šåŠ¨åˆ°è¡¨å•
    document.querySelector('form').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// æ–‡ä»¶é€‰æ‹©é¢„è§ˆ
document.getElementById('{{ form.file.id_for_label }}').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        if (file.size > 100 * 1024 * 1024) {
            alert(`æ–‡ä»¶å¤§å° ${fileSize}MB è¶…è¿‡100MBé™åˆ¶ï¼Œè¯·é€‰æ‹©è¾ƒå°çš„æ–‡ä»¶`);
            e.target.value = '';
            return;
        }

        // è‡ªåŠ¨å¡«å……æ–‡æ¡£åç§°ï¼ˆå¦‚æœæ²¡æœ‰å¡«å†™ï¼‰
        const docNameInput = document.getElementById('{{ form.document_name.id_for_label }}');
        if (!docNameInput.value) {
            const fileName = file.name.replace(/\.[^/.]+$/, '');
            docNameInput.value = fileName;
        }
    }
});

// è¡¨å•æäº¤éªŒè¯
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const docName = document.getElementById('{{ form.document_name.id_for_label }}').value;
    const fileInput = document.getElementById('{{ form.file.id_for_label }}');
    const projectSelect = document.getElementById('{{ form.project.id_for_label }}');

    if (!docName.trim()) {
        e.preventDefault();
        alert('è¯·å¡«å†™æ–‡æ¡£åç§°');
        return false;
    }

    if (!fileInput.files || fileInput.files.length === 0) {
        e.preventDefault();
        alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
        return false;
    }

    if (!projectSelect.value) {
        e.preventDefault();
        alert('è¯·é€‰æ‹©æ‰€å±é¡¹ç›®');
        return false;
    }

    if (!confirm('ç¡®å®šè¦ä¸Šä¼ æ–‡æ¡£å—ï¼Ÿ')) {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}
