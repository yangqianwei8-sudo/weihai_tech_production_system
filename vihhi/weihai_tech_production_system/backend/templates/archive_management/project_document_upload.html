{% extends "archive_management/base.html" %}
{% load static %}

{% block title %}ä¸Šä¼ é¡¹ç›®æ–‡æ¡£ - æ¡£æ¡ˆç®¡ç†{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'archive_management:project_document_list' %}">é¡¹ç›®æ–‡æ¡£</a></li>
<li class="breadcrumb-item active">ä¸Šä¼ æ–‡æ¡£</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">ğŸ“¤ ä¸Šä¼ é¡¹ç›®æ–‡æ¡£</h2>
            <p class="text-muted mb-0">ä¸Šä¼ é¡¹ç›®ç›¸å…³æ–‡æ¡£ï¼Œæ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼</p>
        </div>
        <div>
            <a href="{% url 'archive_management:project_document_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> è¿”å›åˆ—è¡¨
            </a>
        </div>
    </div>

    <!-- è¡¨å•å¡ç‰‡ -->
    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">æ–‡æ¡£ä¿¡æ¯</h5>
        </div>
        <div class="info-card-body">
            {% if form.errors %}
            <div class="alert alert-danger">
                <h6><i class="bi bi-exclamation-triangle"></i> è¡¨å•éªŒè¯å¤±è´¥</h6>
                <ul class="mb-0">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <li>{{ field }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                
                <div class="row g-3">
                    <!-- æ–‡æ¡£åç§° -->
                    <div class="col-md-6">
                        <label for="{{ form.document_name.id_for_label }}" class="form-label">
                            {{ form.document_name.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.document_name }}
                        {% if form.document_name.errors %}
                        <div class="text-danger small">{{ form.document_name.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- æ–‡æ¡£ç±»å‹ -->
                    <div class="col-md-6">
                        <label for="{{ form.document_type.id_for_label }}" class="form-label">
                            {{ form.document_type.label }}
                        </label>
                        {{ form.document_type }}
                        {% if form.document_type.errors %}
                        <div class="text-danger small">{{ form.document_type.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- æ‰€å±é¡¹ç›® -->
                    <div class="col-md-6">
                        <label for="{{ form.project.id_for_label }}" class="form-label">
                            {{ form.project.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.project }}
                        {% if form.project.errors %}
                        <div class="text-danger small">{{ form.project.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- æ–‡æ¡£åˆ†ç±» -->
                    <div class="col-md-6">
                        <label for="{{ form.category.id_for_label }}" class="form-label">
                            {{ form.category.label }}
                        </label>
                        {{ form.category }}
                        {% if form.category.errors %}
                        <div class="text-danger small">{{ form.category.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- æ–‡æ¡£æ–‡ä»¶ -->
                    <div class="col-md-12">
                        <label for="{{ form.file.id_for_label }}" class="form-label">
                            {{ form.file.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.file }}
                        <small class="form-text text-muted">
                            æ”¯æŒæ ¼å¼ï¼šPDFã€Wordã€Excelã€PPTã€å›¾ç‰‡ã€CADã€å‹ç¼©åŒ…ç­‰
                        </small>
                        {% if form.file.errors %}
                        <div class="text-danger small">{{ form.file.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- æ–‡æ¡£æè¿° -->
                    <div class="col-md-12">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            {{ form.description.label }}
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger small">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- æ ‡ç­¾ -->
                    <div class="col-md-6">
                        <label for="{{ form.tags.id_for_label }}" class="form-label">
                            {{ form.tags.label }}
                        </label>
                        {{ form.tags }}
                        <small class="form-text text-muted">å¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”</small>
                        {% if form.tags.errors %}
                        <div class="text-danger small">{{ form.tags.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- å¯†çº§ -->
                    <div class="col-md-3">
                        <label for="{{ form.security_level.id_for_label }}" class="form-label">
                            {{ form.security_level.label }}
                        </label>
                        {{ form.security_level }}
                        {% if form.security_level.errors %}
                        <div class="text-danger small">{{ form.security_level.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- ç‰ˆæœ¬ -->
                    <div class="col-md-3">
                        <label for="{{ form.version.id_for_label }}" class="form-label">
                            {{ form.version.label }}
                        </label>
                        {{ form.version }}
                        {% if form.version.errors %}
                        <div class="text-danger small">{{ form.version.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'archive_management:project_document_list' %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> å–æ¶ˆ
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-upload"></i> ä¸Šä¼ æ–‡æ¡£
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- å¿«é€Ÿé€‰æ‹©é¡¹ç›® -->
    {% if projects %}
    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">å¿«é€Ÿé€‰æ‹©é¡¹ç›®</h5>
            <div class="info-card-actions">
                <span class="badge bg-secondary">å…± {{ projects|length }} ä¸ªé¡¹ç›®</span>
            </div>
        </div>
        <div class="info-card-body">
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>é¡¹ç›®ç¼–å·</th>
                            <th>é¡¹ç›®åç§°</th>
                            <th>å®¢æˆ·åç§°</th>
                            <th>é¡¹ç›®çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}
                        <tr>
                            <td><code>{{ project.project_number|default:"-" }}</code></td>
                            <td>{{ project.project_name|default:"-" }}</td>
                            <td>{{ project.client.client_name|default:"-" }}</td>
                            <td>
                                <span class="badge bg-{% if project.status == 'in_progress' %}primary{% elif project.status == 'settled' %}success{% else %}info{% endif %}">
                                    {{ project.get_status_display|default:"-" }}
                                </span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        onclick="selectProject({{ project.id }}, '{{ project.project_name }}')">
                                    <i class="bi bi-check-circle"></i> é€‰æ‹©
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ä¸Šä¼ è¯´æ˜ -->
    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">ä¸Šä¼ è¯´æ˜</h5>
        </div>
        <div class="info-card-body">
            <div class="alert alert-info">
                <h6><i class="bi bi-info-circle"></i> æ”¯æŒçš„æ–‡ä»¶æ ¼å¼</h6>
                <ul class="mb-0">
                    <li><strong>æ–‡æ¡£ç±»</strong>ï¼šPDFã€Word (.doc, .docx)ã€Excel (.xls, .xlsx)ã€PPT (.ppt, .pptx)ã€TXT</li>
                    <li><strong>å›¾ç‰‡ç±»</strong>ï¼šJPGã€JPEGã€PNGã€GIF</li>
                    <li><strong>è®¾è®¡ç±»</strong>ï¼šCAD (.dwg)ã€å…¶ä»–è®¾è®¡æ–‡ä»¶</li>
                    <li><strong>å‹ç¼©ç±»</strong>ï¼šZIPã€RAR</li>
                </ul>
            </div>
            <div class="alert alert-warning">
                <h6><i class="bi bi-exclamation-triangle"></i> æ³¨æ„äº‹é¡¹</h6>
                <ul class="mb-0">
                    <li>æ–‡æ¡£åç§°å’Œæ–‡ä»¶ä¸ºå¿…å¡«é¡¹</li>
                    <li>å»ºè®®æ–‡ä»¶å¤§å°ä¸è¶…è¿‡100MB</li>
                    <li>æ–‡æ¡£ç¼–å·å°†è‡ªåŠ¨ç”Ÿæˆ</li>
                    <li>ä¸Šä¼ åæ–‡æ¡£çŠ¶æ€ä¸º"å¾…å½’æ¡£"ï¼Œéœ€è¦å½’æ¡£åæ‰èƒ½æ­£å¼ä½¿ç”¨</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
function selectProject(projectId, projectName) {
    // è®¾ç½®é¡¹ç›®é€‰æ‹©æ¡†çš„å€¼
    const projectSelect = document.getElementById('{{ form.project.id_for_label }}');
    if (projectSelect) {
        projectSelect.value = projectId;
        projectSelect.dispatchEvent(new Event('change'));
    }
    
    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.innerHTML = `
        <i class="bi bi-check-circle"></i> å·²é€‰æ‹©é¡¹ç›®ï¼š${projectName}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.info-card-body').insertBefore(alertDiv, document.querySelector('form'));
    
    // æ»šåŠ¨åˆ°è¡¨å•
    document.querySelector('form').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// æ–‡ä»¶é€‰æ‹©é¢„è§ˆ
document.getElementById('{{ form.file.id_for_label }}').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        if (file.size > 100 * 1024 * 1024) {
            alert(`æ–‡ä»¶å¤§å° ${fileSize}MB è¶…è¿‡100MBé™åˆ¶ï¼Œè¯·é€‰æ‹©è¾ƒå°çš„æ–‡ä»¶`);
            e.target.value = '';
            return;
        }
        
        // è‡ªåŠ¨å¡«å……æ–‡æ¡£åç§°ï¼ˆå¦‚æœæ²¡æœ‰å¡«å†™ï¼‰
        const docNameInput = document.getElementById('{{ form.document_name.id_for_label }}');
        if (!docNameInput.value) {
            const fileName = file.name.replace(/\.[^/.]+$/, '');
            docNameInput.value = fileName;
        }
    }
});

// è¡¨å•æäº¤éªŒè¯
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const docName = document.getElementById('{{ form.document_name.id_for_label }}').value;
    const fileInput = document.getElementById('{{ form.file.id_for_label }}');
    const projectSelect = document.getElementById('{{ form.project.id_for_label }}');
    
    if (!docName.trim()) {
        e.preventDefault();
        alert('è¯·å¡«å†™æ–‡æ¡£åç§°');
        return false;
    }
    
    if (!fileInput.files || fileInput.files.length === 0) {
        e.preventDefault();
        alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
        return false;
    }
    
    if (!projectSelect.value) {
        e.preventDefault();
        alert('è¯·é€‰æ‹©æ‰€å±é¡¹ç›®');
        return false;
    }
    
    if (!confirm('ç¡®å®šè¦ä¸Šä¼ æ–‡æ¡£å—ï¼Ÿ')) {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}
