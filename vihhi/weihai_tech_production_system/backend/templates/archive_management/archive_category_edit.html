{% extends "archive_management/base.html" %}
{% load static %}

{% block title %}编辑档案分类 - 档案管理{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'archive_management:archive_category_list' %}">档案分类</a></li>
<li class="breadcrumb-item active">编辑分类</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">✏️ 编辑档案分类</h2>
            <p class="text-muted mb-0">编辑档案分类信息</p>
        </div>
        <div>
            <a href="{% url 'archive_management:archive_category_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> 返回列表
            </a>
        </div>
    </div>

    <!-- 分类基本信息 -->
    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">分类基本信息</h5>
            <div class="info-card-actions">
                <span class="badge bg-{% if category.is_active %}success{% else %}secondary{% endif %}">
                    {% if category.is_active %}启用{% else %}停用{% endif %}
                </span>
            </div>
        </div>
        <div class="info-card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">分类代码</span>
                        <span class="info-value"><code>{{ category.code }}</code></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">分类类型</span>
                        <span class="info-value">{{ category.get_category_type_display }}</span>
                    </div>
                </div>
                {% if category.parent %}
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">上级分类</span>
                        <span class="info-value">{{ category.parent.name }}</span>
                    </div>
                </div>
                {% endif %}
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">档案数量</span>
                        <span class="info-value">{{ category.archive_count|default:0 }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 表单卡片 -->
    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">编辑分类信息</h5>
        </div>
        <div class="info-card-body">
            {% if form.errors %}
            <div class="alert alert-danger">
                <h6><i class="bi bi-exclamation-triangle"></i> 表单验证失败</h6>
                <ul class="mb-0">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <li>{{ field }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <form method="post" id="editForm">
                {% csrf_token %}
                
                <div class="row g-3">
                    <!-- 分类名称 -->
                    <div class="col-md-6">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            {{ form.name.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="text-danger small">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- 分类代码（只读） -->
                    <div class="col-md-6">
                        <label class="form-label">分类代码</label>
                        <input type="text" class="form-control" value="{{ category.code }}" readonly>
                        <small class="form-text text-muted">分类代码创建后无法修改</small>
                    </div>

                    <!-- 分类类型（只读） -->
                    <div class="col-md-6">
                        <label class="form-label">分类类型</label>
                        <input type="text" class="form-control" value="{{ category.get_category_type_display }}" readonly>
                        <small class="form-text text-muted">分类类型创建后无法修改</small>
                    </div>

                    <!-- 上级分类 -->
                    <div class="col-md-6">
                        <label for="{{ form.parent.id_for_label }}" class="form-label">
                            {{ form.parent.label }}
                        </label>
                        {{ form.parent }}
                        <small class="form-text text-muted">不能选择自己或自己的子分类</small>
                        {% if form.parent.errors %}
                        <div class="text-danger small">{{ form.parent.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- 分类描述 -->
                    <div class="col-md-12">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            {{ form.description.label }}
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger small">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- 排序 -->
                    <div class="col-md-3">
                        <label for="{{ form.order.id_for_label }}" class="form-label">
                            {{ form.order.label }}
                        </label>
                        {{ form.order }}
                        {% if form.order.errors %}
                        <div class="text-danger small">{{ form.order.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- 图标 -->
                    <div class="col-md-3">
                        <label for="{{ form.icon.id_for_label }}" class="form-label">
                            {{ form.icon.label }}
                        </label>
                        {{ form.icon }}
                        {% if form.icon.errors %}
                        <div class="text-danger small">{{ form.icon.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- 保管期限 -->
                    <div class="col-md-3">
                        <label for="{{ form.storage_period.id_for_label }}" class="form-label">
                            {{ form.storage_period.label }}
                        </label>
                        {{ form.storage_period }}
                        <small class="form-text text-muted">年</small>
                        {% if form.storage_period.errors %}
                        <div class="text-danger small">{{ form.storage_period.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- 密级 -->
                    <div class="col-md-3">
                        <label for="{{ form.security_level.id_for_label }}" class="form-label">
                            {{ form.security_level.label }}
                        </label>
                        {{ form.security_level }}
                        {% if form.security_level.errors %}
                        <div class="text-danger small">{{ form.security_level.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- 是否启用 -->
                    <div class="col-md-12">
                        <div class="form-check">
                            {{ form.is_active }}
                            <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                {{ form.is_active.label }}
                            </label>
                        </div>
                        {% if form.is_active.errors %}
                        <div class="text-danger small">{{ form.is_active.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- 提交按钮 -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'archive_management:archive_category_list' %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> 取消
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> 保存修改
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// 表单提交验证
document.getElementById('editForm').addEventListener('submit', function(e) {
    const name = document.getElementById('{{ form.name.id_for_label }}').value;
    
    if (!name.trim()) {
        e.preventDefault();
        alert('请填写分类名称');
        return false;
    }
    
    if (!confirm('确定要保存修改吗？')) {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}
