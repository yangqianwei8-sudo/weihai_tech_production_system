{% extends "archive_management/base.html" %}
{% load static %}

{% block title %}æ¡£æ¡ˆå€Ÿé˜…è¯¦æƒ… - æ¡£æ¡ˆç®¡ç†{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'archive_management:archive_borrow_list' %}">æ¡£æ¡ˆå€Ÿé˜…</a></li>
<li class="breadcrumb-item active" aria-current="page">è¯¦æƒ…</li>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">ğŸ“– æ¡£æ¡ˆå€Ÿé˜…è¯¦æƒ…</h2>
            <p class="text-muted mb-0">å€Ÿé˜…å•å·ï¼š<code>{{ borrow.borrow_number }}</code></p>
        </div>
        <div>
            <a href="{% url 'archive_management:archive_borrow_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> è¿”å›åˆ—è¡¨
            </a>
        </div>
    </div>

    {% if is_overdue %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> <strong>é€¾æœŸè­¦å‘Š</strong>ï¼šè¯¥å€Ÿé˜…å·²é€¾æœŸ {{ overdue_days }} å¤©ï¼Œè¯·å°½å¿«å½’è¿˜ï¼
    </div>
    {% endif %}

    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">å€Ÿé˜…åŸºæœ¬ä¿¡æ¯</h5>
            <div class="info-card-actions">
                <span class="badge bg-{% if borrow.status == 'returned' %}success{% elif borrow.status == 'out' %}primary{% elif borrow.status == 'approved' %}info{% elif borrow.status == 'pending' %}warning{% elif borrow.status == 'rejected' %}danger{% elif borrow.status == 'overdue' %}danger{% else %}secondary{% endif %}">
                    {{ borrow.get_status_display }}
                </span>
            </div>
        </div>
        <div class="info-card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å€Ÿé˜…å•å·</span>
                        <span class="info-value"><code>{{ borrow.borrow_number }}</code></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å€Ÿé˜…çŠ¶æ€</span>
                        <span class="info-value">
                            <span class="badge bg-{% if borrow.status == 'returned' %}success{% elif borrow.status == 'out' %}primary{% elif borrow.status == 'approved' %}info{% elif borrow.status == 'pending' %}warning{% elif borrow.status == 'rejected' %}danger{% elif borrow.status == 'overdue' %}danger{% else %}secondary{% endif %}">
                                {{ borrow.get_status_display }}
                            </span>
                        </span>
                    </div>
                </div>
                {% if borrow.project_document %}
                <div class="col-md-12">
                    <div class="info-item">
                        <span class="info-label">å€Ÿé˜…æ¡£æ¡ˆï¼ˆé¡¹ç›®æ–‡æ¡£ï¼‰</span>
                        <span class="info-value">
                            <strong>{{ borrow.project_document.document_name }}</strong>
                            <small class="text-muted">ï¼ˆ{{ borrow.project_document.document_number }}ï¼‰</small>
                        </span>
                    </div>
                </div>
                {% elif borrow.administrative_archive %}
                <div class="col-md-12">
                    <div class="info-item">
                        <span class="info-label">å€Ÿé˜…æ¡£æ¡ˆï¼ˆè¡Œæ”¿æ¡£æ¡ˆï¼‰</span>
                        <span class="info-value">
                            <strong>{{ borrow.administrative_archive.archive_name }}</strong>
                            <small class="text-muted">ï¼ˆ{{ borrow.administrative_archive.archive_number }}ï¼‰</small>
                        </span>
                    </div>
                </div>
                {% endif %}
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å€Ÿé˜…äºº</span>
                        <span class="info-value">{{ borrow.borrower.username }}</span>
                    </div>
                </div>
                {% if borrow.borrower_department %}
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å€Ÿé˜…éƒ¨é—¨</span>
                        <span class="info-value">{{ borrow.borrower_department.name }}</span>
                    </div>
                </div>
                {% endif %}
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å€Ÿé˜…æ—¥æœŸ</span>
                        <span class="info-value">{{ borrow.borrow_date|date:"Y-m-d" }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å½’è¿˜æ—¥æœŸ</span>
                        <span class="info-value {% if is_overdue %}text-danger{% endif %}">
                            {{ borrow.return_date|date:"Y-m-d" }}
                            {% if is_overdue %}<i class="bi bi-exclamation-triangle"></i> å·²é€¾æœŸ{% endif %}
                        </span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å€Ÿé˜…æ–¹å¼</span>
                        <span class="info-value">{{ borrow.get_borrow_method_display }}</span>
                    </div>
                </div>
                {% if borrow.borrow_purpose %}
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å€Ÿé˜…ç”¨é€”</span>
                        <span class="info-value">{{ borrow.borrow_purpose }}</span>
                    </div>
                </div>
                {% endif %}
                <div class="col-md-12">
                    <div class="info-item">
                        <span class="info-label">å€Ÿé˜…äº‹ç”±</span>
                        <span class="info-value">{{ borrow.borrow_reason|linebreaks }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if borrow.approver %}
    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">å®¡æ‰¹ä¿¡æ¯</h5>
        </div>
        <div class="info-card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å®¡æ‰¹äºº</span>
                        <span class="info-value">{{ borrow.approver.username }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å®¡æ‰¹æ—¶é—´</span>
                        <span class="info-value">{{ borrow.approved_time|date:"Y-m-d H:i" }}</span>
                    </div>
                </div>
                {% if borrow.approval_opinion %}
                <div class="col-md-12">
                    <div class="info-item">
                        <span class="info-label">å®¡æ‰¹æ„è§</span>
                        <span class="info-value">{{ borrow.approval_opinion|linebreaks }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if borrow.out_time %}
    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">å‡ºåº“ä¿¡æ¯</h5>
        </div>
        <div class="info-card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å‡ºåº“äºº</span>
                        <span class="info-value">{{ borrow.out_by.username|default:"-" }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å‡ºåº“æ—¶é—´</span>
                        <span class="info-value">{{ borrow.out_time|date:"Y-m-d H:i" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if borrow.returned_time %}
    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">å½’è¿˜ä¿¡æ¯</h5>
        </div>
        <div class="info-card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å½’è¿˜äºº</span>
                        <span class="info-value">{{ borrow.returned_by.username|default:"-" }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å½’è¿˜æ—¶é—´</span>
                        <span class="info-value">{{ borrow.returned_time|date:"Y-m-d H:i" }}</span>
                    </div>
                </div>
                {% if borrow.return_status %}
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">å½’è¿˜çŠ¶æ€</span>
                        <span class="info-value">{{ borrow.return_status }}</span>
                    </div>
                </div>
                {% endif %}
                {% if borrow.return_notes %}
                <div class="col-md-12">
                    <div class="info-item">
                        <span class="info-label">å½’è¿˜å¤‡æ³¨</span>
                        <span class="info-value">{{ borrow.return_notes|linebreaks }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="info-card mb-4">
        <div class="info-card-header">
            <h5 class="info-card-title">æ“ä½œè®°å½•</h5>
        </div>
        <div class="info-card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">åˆ›å»ºæ—¶é—´</span>
                        <span class="info-value">{{ borrow.created_time|date:"Y-m-d H:i" }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">æ›´æ–°æ—¶é—´</span>
                        <span class="info-value">{{ borrow.updated_time|date:"Y-m-d H:i" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if borrow.status == 'approved' and not borrow.out_time %}
    <div class="d-flex justify-content-end gap-2 mb-4">
        <a href="{% url 'archive_management:archive_borrow_return' borrow.pk %}" class="btn btn-primary">
            <i class="bi bi-box-arrow-in-right"></i> åŠç†å‡ºåº“
        </a>
    </div>
    {% elif borrow.status == 'out' %}
    <div class="d-flex justify-content-end gap-2 mb-4">
        <a href="{% url 'archive_management:archive_borrow_return' borrow.pk %}" class="btn btn-success">
            <i class="bi bi-arrow-counterclockwise"></i> åŠç†å½’è¿˜
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
