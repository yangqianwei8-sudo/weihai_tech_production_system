<!DOCTYPE html>
<html lang="zh-CN">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>维海科技信息化管理平台 · 我的工作台</title>
    <link rel="stylesheet" href="{% static 'css/common.css' %}">
    <!-- SortableJS for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --nav-expanded-width: 260px;
            --nav-collapsed-width: 80px;
            --nav-width: var(--nav-expanded-width);
            /* Legacy mapping for home page compatibility */
            --brand-primary: var(--vh-primary);
            --brand-primary-600: var(--vh-primary-dark);
            --brand-accent: var(--vh-accent);
            --brand-surface: var(--vh-surface);
            --brand-deep: var(--vh-primary);
            --primary: var(--vh-primary);
            --primary-light: var(--vh-primary-light);
            --accent: var(--vh-accent);
            --bg: var(--vh-bg);
            --card-bg: var(--vh-card-bg);
            --text: var(--vh-text);
            --muted: var(--vh-text-muted);
            --border: var(--vh-border);
            --shadow: var(--shadow-md);
            /* 固定顶部区域高度 */
            --top-bar-height: 56px; /* 统一顶部导航高度 */
        }

        /* 基础样式已在common.css中定义，这里只保留home页特有的样式 */
        
        body {
            margin: 0;
            padding: 0;
        }

        .app-shell {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            margin: 0;
            padding: 0;
            overflow: visible;
        }

        .menu-button {
            border: 1px solid var(--border);
            background: #fff;
            border-radius: 999px;
            padding: 8px 14px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: box-shadow 0.2s ease, border 0.2s ease;
        }

        .menu-button:hover {
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
            border-color: var(--primary-light);
        }

        .top-menu {
            position: relative;
        }

        .menu-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            left: 0;
            width: 460px;
            max-height: 520px;
            overflow-y: auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 28px 60px rgba(15, 23, 42, 0.18);
            border: 1px solid var(--border);
            padding: 18px 22px;
            display: none;
            z-index: 30;
        }

        .menu-dropdown.active {
            display: block;
        }

        .menu-section + .menu-section {
            border-top: 1px solid var(--border);
            margin-top: 16px;
            padding-top: 16px;
        }

        .menu-section-title {
            font-size: 12px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .menu-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .menu-link,
        .menu-item-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 10px;
            font-size: 14px;
            color: var(--text);
            transition: background 0.2s ease;
        }

        .menu-link:hover,
        .menu-item-label:hover {
            background: rgba(15, 23, 42, 0.05);
        }

        .menu-child-list {
            margin-left: 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .menu-child-link {
            font-size: 13px;
            color: var(--muted);
            padding: 4px 8px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .menu-child-link:hover {
            background: rgba(226, 232, 240, 0.6);
            color: var(--primary);
        }

        .menu-grandchild-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 4px 0 0 24px;
        }

        .menu-grandchild-link {
            font-size: 12px;
            color: var(--muted);
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(248, 250, 252, 0.9);
            border: 1px solid rgba(226, 232, 240, 0.9);
        }

        /* 主区域 */
        .main-area {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow: visible;
        }

        /* 欢迎信息栏样式 */
        .brand-logo-img { display:none; } /* replaced by inline svg */
        .brand-logo-svg {
            width: 36px;
            height: 36px;
            display: inline-block;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,.08);
            background: transparent;
        }
        .brand-logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-primary-600));
            box-shadow: 0 4px 12px rgba(26,115,232,.25);
        }
        .brand-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--brand-deep);
            letter-spacing: .3px;
        }
        .brand-title-block{
            line-height: 1.1;
            display: flex;
            flex-direction: column;
        }
        .brand-title-block .brand-cn{
            font-size: 16px;
            font-weight: 700;
            color: var(--brand-deep);
        }
        .brand-title-block .brand-en{
            margin-top: 2px;
            font-size: 11px;
            font-weight: 700;
            color: var(--brand-primary-600);
            letter-spacing: 0.08em;
        }

        .env-badge {
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(214,40,40,0.12);
            color: var(--accent);
            font-size: 12px;
            border: 1px solid rgba(214,40,40,0.3);
        }

        .subsystem-tag {
            font-size: 13px;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .search-box {
            flex: 1;
            position: relative;
            max-width: 420px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 42px;
            border-radius: 30px;
            border: 1px solid var(--border);
            background: #f9fafb;
            font-size: 14px;
            transition: border 0.2s ease, background 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-light);
            background: #fff;
        }

        .search-box .hint {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: var(--muted);
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 6px;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* .btn-primary 样式已在common.css中定义 */
        a, button, .sidenav-link, .notify-item, .task-card { outline: none; }
        a:focus-visible, button:focus-visible, .sidenav-link:focus-visible, .notify-item:focus-visible, .task-card:focus-visible{
            box-shadow: 0 0 0 3px rgba(26,115,232,.35);
            border-radius: 10px;
        }

        .icon-button {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            cursor: pointer;
            position: relative;
        }

        .icon-button .dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #ef4444;
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .user-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            position: relative;
            cursor: pointer;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary-light), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-menu {
            position: absolute;
            top: 48px;
            right: 0;
            background: #fff;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            width: 160px;
            padding: 8px 0;
            display: none;
            z-index: 20;
        }

        .user-menu.active {
            display: block;
        }

        .user-menu a {
            display: block;
            padding: 10px 16px;
            font-size: 13px;
            color: var(--text);
        }

        .user-menu a:hover {
            background: #f3f4f6;
        }

        .workspace {
            flex: 1;
            padding: 8px 28px 28px;
            display: grid;
            grid-template-columns: 240px 1fr 320px;
            gap: 24px; /* 更紧凑的三列间距 */
            margin-top: 0; /* 欢迎横幅已整合到顶部栏 */
            align-items: start; /* 确保左中右三个区域顶部对齐 */
        }
        /* 确保首个卡片紧贴顶栏 */
        .workspace-main > .card:first-child { margin-top: 0; }

        .workspace-nav {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-top: 0;
        }
        
        /* 左侧导航栏中的待办事项卡片样式 */
        .workspace-nav .info-card {
            width: 100%;
            margin: 0;
        }
        
        .workspace-nav .info-grid-2 {
            grid-template-columns: 1fr;
            gap: var(--spacing-sm);
        }

        .sidenav {
            background: linear-gradient(180deg, #FFFFFF, #F9FAFD);
            border-radius: 18px;
            box-shadow: var(--shadow);
            padding: 18px 16px;
            position: sticky;
            top: 88px;
            height: fit-content;
        }

        .sidenav-section + .sidenav-section {
            border-top: 1px solid var(--border);
            margin-top: 12px;
            padding-top: 12px;
        }

        .sidenav-title {
            font-size: 12px;
            color: red;
            letter-spacing: .5px;
            margin-bottom: 8px;
        }

        .sidenav-links {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        /* 二级子菜单（侧边栏自动隐藏-悬停展开） */
        .sidenav-item{ display:flex; flex-direction:column; }
        .sidenav-item .submenu{
            display: none;
            flex-direction: column;
            gap: 6px;
            margin-left: 10px;
            padding-left: 10px;
            border-left: 1px dashed var(--border);
        }
        .sidenav-item:hover .submenu{ display: flex; }

        .sidenav-link {
            padding: 8px 10px;
            border-radius: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text);
            transition: background .2s ease, color .2s ease;
        }
        .sidenav-link:hover { background: rgba(31,42,87,.08); color: var(--brand-primary); }
        /* 选中态：左侧导览条 + 主色文字（使用 data-active 标记或通过后续模板条件） */
        .sidenav-link[data-active="true"]{
            position: relative;
            background: rgba(31,42,87,.10);
            color: var(--brand-primary);
        }
        .sidenav-link[data-active="true"]::before{
            content:"";
            position: absolute;
            left: -16px;
            top: 6px;
            bottom: 6px;
            width: 4px;
            border-radius: 3px;
            background: linear-gradient(180deg,var(--brand-primary-600), var(--brand-primary));
        }

        .workspace-main {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding-top: 0;
            margin-top: 0; /* 移除顶部空白 */
            align-self: start; /* 确保顶部对齐 */
        }
        
        /* 确保信息卡片之间有足够间距，防止重叠 */
        .workspace-main > .info-card {
            margin-bottom: 0; /* gap 已处理间距 */
        }
        
        .workspace-main > .info-card + .info-card {
            margin-top: 0; /* gap 已处理间距 */
        }
        
        /* 信息网格布局优化，防止内容重叠 */
        .info-grid .info-item {
            min-width: 0; /* 防止内容溢出 */
            overflow: hidden; /* 防止内容溢出 */
        }
        
        .info-grid .info-item > div {
            min-width: 0; /* 防止内容溢出 */
            overflow: hidden; /* 防止内容溢出 */
        }
        
        /* 信息项文本溢出处理 */
        .info-item .info-label,
        .info-item .info-value {
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .workspace-side {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-top: 0;
            align-self: start; /* 确保顶部对齐 */
        }
        .main-area { padding-top: 0; margin-top: 0; }

        /* .card 基础样式已在common.css中定义 */
        .card {
            padding: 20px 24px; /* home页特定的内边距 */
        }
        .card:hover{ box-shadow: var(--shadow-lg); }

        .notify-block + .notify-block {
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--vh-border-light);
        }

        .notify-item {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            padding: var(--spacing-md);
            border-bottom: 2px solid var(--vh-primary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-xs);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: var(--vh-card-bg);
        }
        
        .notify-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: transparent;
            border-radius: 3px 0 0 3px;
            transition: background 0.3s ease;
        }
        
        .notify-item:hover {
            background: var(--vh-surface);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(15, 30, 58, 0.08);
        }
        
        .notify-item:hover::before {
            background: var(--vh-primary);
        }

        .notify-item--unread {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
            border-left: 3px solid var(--vh-info);
            padding-left: calc(var(--spacing-md) - 3px);
            animation: notifyPulse 2s ease-in-out infinite;
        }
        
        @keyframes notifyPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4);
            }
            50% {
                box-shadow: 0 0 0 4px rgba(37, 99, 235, 0);
            }
        }

        .notify-item--unread .notify-item-title a,
        .notify-item--unread .notify-item-title {
            color: var(--vh-primary);
            font-weight: 700;
        }
        
        .notify-item--unread::before {
            background: var(--vh-info);
        }

        .notify-item-title a {
            color: inherit;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .notify-item-title a:hover {
            color: var(--vh-primary);
            text-decoration: underline;
        }

        .notify-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .notify-item-title {
            font-size: var(--font-size-base);
            font-weight: 600;
            line-height: 1.5;
            color: var(--vh-text);
        }

        .notify-item-subtitle {
            font-size: var(--font-size-sm);
            color: var(--vh-text-muted);
            line-height: 1.4;
        }

        .notify-item-detail {
            font-size: var(--font-size-sm);
            color: var(--vh-accent);
            font-weight: 500;
        }
        
        .notify-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--vh-primary);
        }
        
        .notify-header span {
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--vh-text);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .notify-header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        /* 颜色语义统一 - 已在common.css中定义 */

        /* .card-header 基础样式已在common.css中定义 */
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .card-header h3 {
            font-size: var(--font-size-lg);
            font-weight: 600;
        }

        /* .muted 样式已在common.css中定义 */
        .muted {
            font-size: var(--font-size-sm);
        }

         .welcome-panel {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .welcome-text h1 {
            font-size: 26px;
            margin-bottom: 6px;
        }

        .highlight-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: #dbeafe;
            color: #1d4ed8;
            font-size: 11px;
            margin-bottom: 8px;
        }
        .welcome-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .welcome-actions a {
            transition: all var(--transition-base);
        }
        .welcome-actions a:hover {
            background: var(--vh-primary);
            color: #fff;
            border-color: var(--vh-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(31, 42, 87, 0.2);
        }
        .welcome-actions a.logout:hover {
            background: #ef4444;
            border-color: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .overview-wrapper {
            background: #f8fafc;
            border-radius: 18px;
            padding: 18px;
            border: 1px solid var(--border);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
        }

        .overview-metrics {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .metric {
            background: #f8fafc;
            border-radius: 14px;
            padding: 16px;
        }

        .metric-title {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
        }

        .kanban {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 18px;
        }

        .kanban-column {
            background: #f9fafb;
            border-radius: 16px;
            padding: 18px;
            border: 1px solid var(--border);
            min-height: 260px;
            position: relative;
        }

        .kanban-column h4 {
            font-size: 14px;
            margin-bottom: 12px;
        }

        .task-card {
            background: #fff;
            border-radius: 12px;
            padding: 14px;
            border: 1px solid #e2e8f0;
            margin-bottom: 12px;
            transition: transform .15s ease, box-shadow .15s ease;
        }
        .task-card:hover{ transform: translateY(-1px); box-shadow: 0 6px 18px rgba(16,24,40,0.08); }
        /* 空状态占位 - 优化样式 */
        .empty-state {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--vh-text-muted);
            font-size: var(--font-size-sm);
            padding: var(--spacing-lg);
        }
        .empty-state .chip{
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px dashed var(--vh-border);
            border-radius: var(--radius-md);
            background: var(--vh-surface);
            transition: all var(--transition-base);
        }
        .empty-state .chip:hover {
            border-color: var(--vh-primary-light);
            background: rgba(31, 42, 87, 0.04);
        }
        .empty-state .chip i{
            width: 20px; 
            height: 20px; 
            display: inline-block;
            border-radius: var(--radius-sm); 
            background: linear-gradient(135deg, rgba(31, 42, 87, 0.1), rgba(31, 42, 87, 0.05));
        }

        .task-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--muted);
        }

        .project-cards {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
            width: 100%;
        }

        .project-card {
            background: #f9fafb;
            border-radius: 16px;
            padding: 18px;
            border: 1px solid transparent;
            transition: border 0.2s ease;
            min-width: 0; /* 防止内容溢出 */
            overflow: hidden; /* 防止内容溢出 */
        }

        .project-card:hover {
            border-color: var(--primary-light);
        }

        .activity-list li {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .activity-list li:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: #e0f2fe;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .data-cards {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
        }

        .data-card {
            background: #f8fafc;
            border-radius: 16px;
            padding: 18px;
            border: 1px solid var(--border);
        }

        .status-bar {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 2px solid var(--vh-border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-sm);
            color: var(--vh-text-muted);
            box-shadow: 0 -2px 8px rgba(15, 30, 58, 0.05);
            position: relative;
        }
        
        .status-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--vh-primary), transparent);
        }
        
        .status-bar a {
            color: var(--vh-text-muted);
            text-decoration: none;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: all var(--transition-base);
            font-size: var(--font-size-sm);
        }
        
        .status-bar a:hover {
            color: var(--vh-primary);
            background: var(--vh-surface);
        }
        
        .back-to-top {
            position: fixed;
            bottom: 100px;
            right: 32px;
            width: 48px;
            height: 48px;
            background: var(--vh-primary);
            color: #fff;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(31, 42, 87, 0.3);
            cursor: pointer;
            transition: all var(--transition-base);
            z-index: 1000;
            font-size: var(--font-size-lg);
        }
        
        .back-to-top:hover {
            background: var(--vh-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(31, 42, 87, 0.4);
        }
        
        .back-to-top.show {
            display: flex;
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* 欢迎卡片样式 - 使用主题色，自适应宽屏 */
        .welcome-card {
            background: linear-gradient(135deg, var(--vh-primary) 0%, var(--vh-primary-dark) 100%);
            border-radius: 0;
            padding: var(--spacing-xl) var(--spacing-2xl);
            margin: 0 0 var(--spacing-md) 0;
            width: 100%;
            max-width: 100%;
            box-shadow: var(--shadow-lg);
            color: #ffffff;
            position: sticky;
            top: 0;
            z-index: 100;
            overflow: hidden;
            animation: fadeInDown 0.5s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-sizing: border-box;
        }
        
        .welcome-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.08) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        .welcome-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.4;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.2;
            }
        }
        
        .welcome-card-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-lg);
        }
        
        .welcome-card-left {
            flex: 1;
            min-width: 280px;
            text-align: left;
        }
        
        .welcome-greeting {
            font-size: calc(var(--font-size-2xl) * 0.7);
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            line-height: 1.4;
            text-align: left;
        }
        
        .welcome-date-info {
            font-size: var(--font-size-sm);
            color: rgba(255, 255, 255, 0.85);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            text-align: left;
        }
        
        .welcome-card-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .welcome-action-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: var(--radius-md);
            color: #ffffff;
            font-size: var(--font-size-sm);
            font-weight: 500;
            text-decoration: none;
            transition: all var(--transition-base);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .welcome-action-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            color: #ffffff;
            text-decoration: none;
        }
        
        .welcome-action-btn:active {
            transform: translateY(0);
        }
        
        .welcome-action-btn.logout {
            background: rgba(214, 40, 40, 0.2);
            border-color: rgba(214, 40, 40, 0.4);
        }
        
        .welcome-action-btn.logout:hover {
            background: rgba(214, 40, 40, 0.3);
            border-color: rgba(214, 40, 40, 0.6);
        }
        
        @media (max-width: 768px) {
            .welcome-card {
                margin: 0 0 var(--spacing-sm) 0;
                padding: var(--spacing-lg) var(--spacing-lg);
                border-radius: 0;
                width: 100%;
            }
            
            .welcome-greeting {
                font-size: calc(var(--font-size-xl) * 0.7);
            }
            
            .welcome-card-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .welcome-card-right {
                width: 100%;
                justify-content: flex-start;
            }
            
            .welcome-action-btn {
                flex: 1;
                justify-content: center;
            }
        }
        
        /* 顶部功能模块导航栏样式 - 已移至左侧导航 */
        .top-modules-nav {
            display: none !important;
        }
        
        .top-modules-nav .module-link {
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-md);
            border: 1px solid var(--vh-border);
            background: #ffffff;
            color: var(--vh-text);
            font-size: var(--font-size-sm);
            text-decoration: none;
            transition: all var(--transition-base);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-weight: 500;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .top-modules-nav .module-link:hover {
            background: var(--vh-primary-soft);
            border-color: var(--vh-primary);
            color: var(--vh-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(31, 42, 87, 0.15);
        }
        
        .top-modules-nav .module-link[data-active="true"] {
            background: var(--vh-primary-soft);
            border-color: var(--vh-primary);
            color: var(--vh-primary);
            font-weight: 600;
        }
        
        .top-modules-nav .module-link.has-submenu::after {
            content: '▾';
            margin-left: 2px;
            font-size: 10px;
            opacity: 0.6;
        }
        
        .top-modules-nav .module-link:hover.has-submenu .submenu-dropdown {
            display: block;
        }
        
        .submenu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: #fff;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--vh-border);
            padding: var(--spacing-xs);
            min-width: 180px;
            z-index: 1000;
        }
        
        .submenu-dropdown a {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            color: var(--vh-text);
            text-decoration: none;
            font-size: var(--font-size-sm);
            transition: all var(--transition-base);
        }
        
        .submenu-dropdown a:hover {
            background: var(--vh-surface);
        }
        
        .submenu-dropdown a[data-active="true"] {
            background: var(--vh-primary-soft);
            color: var(--vh-primary);
            font-weight: 600;
        }
        
        .module-item-wrapper {
            position: relative;
        }
        
        .module-item-wrapper:hover .submenu-dropdown {
            display: block;
        }
        
        /* 顶部导航栏滚动条美化 */
        .top-modules-nav::-webkit-scrollbar {
            height: 4px;
        }
        
        .top-modules-nav::-webkit-scrollbar-track {
            background: var(--vh-border-light);
        }
        
        .top-modules-nav::-webkit-scrollbar-thumb {
            background: var(--vh-border);
            border-radius: var(--radius-full);
        }
        
        .top-modules-nav::-webkit-scrollbar-thumb:hover {
            background: var(--vh-primary-muted);
        }
        
        @media (max-width: 768px) {
            :root {
                --top-bar-height: 56px; /* 统一顶部导航高度 */
            }
            
            .top-modules-nav {
                padding: var(--spacing-sm) var(--spacing-md);
                gap: var(--spacing-xs);
                overflow-x: auto;
                margin: 0 var(--spacing-md) var(--spacing-sm);
            }
            
            .top-modules-nav .module-link {
                padding: var(--spacing-xs) var(--spacing-md);
                font-size: var(--font-size-xs);
            }
            
            .top-modules-nav {
                overflow-x: auto;
                padding: var(--spacing-xs) var(--spacing-sm);
                gap: 4px;
                -webkit-overflow-scrolling: touch;
            }
            
            .top-modules-nav .module-link {
                font-size: 11px;
                padding: 4px 8px;
            }
            
            .submenu-dropdown {
                min-width: 140px;
            }
        }
        
        .sidenav-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-notice .notice-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .settings-notice .notice-text {
            flex: 1;
            line-height: 1.5;
        }
        
        .settings-close-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--vh-text-secondary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: all var(--transition-base);
        }
        
        .settings-close-btn:hover {
            background: var(--vh-surface);
            color: var(--vh-text);
        }
        
        .settings-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .settings-content h5 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--vh-text);
        }
        
        .available-actions-list,
        .current-actions-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            padding: var(--spacing-sm);
            background: var(--vh-surface);
            border-radius: var(--radius-sm);
            border: 1px solid var(--vh-border-light);
        }
        
        .action-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: #fff;
            border: 1px solid var(--vh-border);
            border-radius: var(--radius-sm);
            cursor: move;
            transition: all var(--transition-base);
        }
        
        .action-item:hover {
            box-shadow: var(--shadow-sm);
            transform: translateX(2px);
        }
        
        .action-item.dragging {
            opacity: 0.5;
        }
        
        .action-item .action-icon {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .action-item .action-text {
            flex: 1;
            font-size: var(--font-size-sm);
            color: var(--vh-text);
        }
        
        .action-item .action-remove {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--vh-error);
            padding: 4px;
            border-radius: var(--radius-sm);
            opacity: 0.6;
            transition: all var(--transition-base);
        }
        
        .action-item .action-remove:hover {
            opacity: 1;
            background: var(--vh-error-soft);
        }
        
        .action-item .action-add {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--vh-success);
            padding: 4px;
            border-radius: var(--radius-sm);
            opacity: 0.6;
            transition: all var(--transition-base);
        }
        
        .action-item .action-add:hover {
            opacity: 1;
            background: var(--vh-success-soft);
        }
        
        .settings-footer {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--vh-border-light);
        }
        
        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--vh-border);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: all var(--transition-base);
        }
        
        .btn-primary {
            background: var(--vh-primary);
            color: #fff;
            border-color: var(--vh-primary-dark);
        }
        
        .btn-primary:hover {
            background: var(--vh-primary-dark);
        }
        
        .btn-secondary {
            background: #fff;
            color: var(--vh-text);
        }
        
        .btn-secondary:hover {
            background: var(--vh-surface);
        }
        
        @media (max-width: 768px) {
            .settings-content {
                grid-template-columns: 1fr;
            }
        }
        
        

        /* 响应式 */
        @media (max-width: 1200px) {
            .workspace { grid-template-columns: 1fr; }
            .workspace-side { order: -1; }
            .project-cards {
                grid-template-columns: 1fr;
            }
        }

        .tab-group-block {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: var(--brand-surface);
            border-radius: 16px;
            padding: 10px 16px;
            border: 1px solid rgba(229, 231, 235, 0.9);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .tab-group-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--brand-deep);
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .tab-group-title::before {
            content: "";
            width: 3px;
            height: 14px;
            background: var(--brand-primary);
            border-radius: 2px;
        }

        .tab-group-buttons {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
        }

        @media (max-width: 992px) {
            :root {
                --top-bar-height: 56px; /* 统一顶部导航高度 */
            }
            
            .menu-dropdown {
                width: calc(100vw - 40px);
                left: 50%;
                transform: translateX(-50%);
            }
            .workspace {
                padding: 20px;
                grid-template-columns: 1fr;
            }
            .workspace-side {
                order: -1;
            }
            .kanban {
                grid-template-columns: 1fr;
            }
            .data-cards {
                grid-template-columns: 1fr;
            }
            .top-modules-nav {
                overflow-x: auto;
                padding: var(--spacing-xs) var(--spacing-md);
            }
            .top-modules-nav .module-link {
                font-size: 12px;
                padding: 6px 10px;
            }
        }
        
            font-size: var(--font-size-sm);
            position: relative;
        }
        
        .sidenav-sub-link::before {
            content: '';
            position: absolute;
            left: calc(var(--spacing-md) + 8px);
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: var(--vh-text-muted);
        }
        
        .sidenav-sub-link[data-active="true"]::before {
            background-color: var(--vh-primary);
        }
        
        /* 工作台优化样式 */
        .info-card-slide-up {
            animation: infoCardSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) backwards;
        }
        
        @keyframes infoCardSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 任务卡片悬停效果优化 */
        .task-card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        .task-card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(15, 30, 58, 0.12);
            border-color: var(--vh-primary-light);
        }
        
        /* 项目卡片悬停效果优化 */
        .project-card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .project-card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(15, 30, 58, 0.12);
            border-color: var(--vh-primary-light);
        }
        
        /* 看板列优化 */
        .kanban-column {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            border: 1px solid var(--vh-border);
            min-height: 320px;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .kanban-column:hover {
            box-shadow: 0 4px 12px rgba(15, 30, 58, 0.08);
            transform: translateY(-2px);
        }
        
        .kanban-column h4 {
            font-size: var(--font-size-base);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--vh-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .kanban-column h4::before {
            content: '';
            width: 4px;
            height: 16px;
            border-radius: 2px;
            background: currentColor;
        }
        
        /* 任务卡片样式优化 */
        .task-card {
            background: #fff;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            border: 1px solid var(--vh-border-light);
            margin-bottom: var(--spacing-sm);
            transition: all 0.2s ease;
        }
        
        .task-title a {
            transition: color 0.2s ease;
        }
        
        .task-title a:hover {
            color: var(--vh-primary);
        }
        
        /* 项目卡片样式优化 */
        .project-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            border: 1px solid var(--vh-border-light);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            min-width: 0; /* 防止内容溢出 */
            width: 100%; /* 确保卡片占满网格 */
        }
        
        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--vh-primary), var(--vh-primary-light));
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .project-card:hover::before {
            transform: scaleY(1);
        }
        
        /* 进度条优化 */
        .progress {
            height: 8px;
            border-radius: var(--radius-full);
            background: var(--vh-border-light);
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--vh-primary), var(--vh-primary-light));
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(31, 42, 87, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: progressShine 2s infinite;
        }
        
        @keyframes progressShine {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        /* 响应式优化 */
        @media (max-width: 1200px) {
            .workspace {
                grid-template-columns: 200px 1fr 280px;
                margin-top: 0;
            }
            .workspace-side {
                order: -1;
            }
            .info-grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .workspace {
                grid-template-columns: 1fr;
                padding: 0 var(--spacing-md) var(--spacing-md);
                margin-top: 0;
            }
            .workspace-nav {
                display: none;
            }
            .info-grid-4,
            .info-grid-responsive {
                grid-template-columns: 1fr;
            }
            .kanban {
                grid-template-columns: 1fr;
            }
            .project-cards {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .project-card {
                padding: 14px;
            }
            .info-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-sm);
            }
        }
        
        /* 徽章样式优化 */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 8px;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
            line-height: 1;
        }
        
        .badge-pill {
            border-radius: var(--radius-full);
        }
        
        .badge-danger {
            background: var(--vh-error);
            color: #fff;
            animation: badgePulse 2s ease-in-out infinite;
        }
        
        @keyframes badgePulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        /* 按钮链接样式优化 */
        .btn-link {
            background: transparent;
            border: none;
            color: var(--vh-primary);
            padding: 4px 8px;
            font-size: var(--font-size-sm);
            text-decoration: underline;
            transition: all var(--transition-base);
        }
        
        .btn-link:hover {
            color: var(--vh-primary-dark);
            background: rgba(31, 42, 87, 0.05);
            text-decoration: none;
        }
        
        /* 常用功能入口悬停效果增强 */
        .info-item-hover-highlight {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .info-item-hover-highlight:hover {
            background: linear-gradient(135deg, var(--vh-surface) 0%, rgba(31, 42, 87, 0.04) 100%);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(15, 30, 58, 0.1);
        }
        
        /* 数据卡片数字动画 */
        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .info-value {
            animation: countUp 0.6s ease-out;
        }
        
        /* 加载状态优化 */
        .info-card-slide-up {
            animation-delay: calc(var(--index, 0) * 0.1s);
        }
        
        /* 页面加载完成后的样式 */
        body.page-loaded .info-card-slide-up {
            animation-play-state: running;
        }
        
        /* 按钮加载状态 */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* 通知项删除动画 */
        .notify-item.removing {
            animation: slideOutLeft 0.3s ease forwards;
        }
        
        @keyframes slideOutLeft {
            to {
                opacity: 0;
                transform: translateX(-20px);
                max-height: 0;
                margin-bottom: 0;
                padding-top: 0;
                padding-bottom: 0;
            }
        }
        
        /* 数据卡片加载占位 */
        .info-card.loading {
            position: relative;
            overflow: hidden;
        }
        
        .info-card.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.6),
                transparent
            );
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* 焦点可见性优化 */
        .info-item[onclick]:focus-visible,
        .task-card-hover:focus-visible {
            outline: 2px solid var(--vh-primary);
            outline-offset: 2px;
        }
        
        /* 打印样式优化 */
        @media print {
            .top-modules-nav,
            .workspace-nav,
            .workspace-side,
            .status-bar,
            .back-to-top {
                display: none !important;
            }
            
            .workspace {
                grid-template-columns: 1fr;
                margin-top: 0;
            }
            
            .info-card {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
        
        /* 卡片设置按钮 */
        .card-settings-btn {
            transition: all var(--transition-base);
        }
        
        .info-card-header:hover .card-settings-btn {
            opacity: 1 !important;
        }
        
        .card-settings-btn:hover {
            background: var(--vh-surface);
            transform: rotate(90deg);
        }
        
        .card-settings-btn:active {
            transform: rotate(90deg) scale(0.95);
        }
        
        /* 刷新按钮动画 */
        #refreshDataBtn.refreshing span {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* 卡片隐藏状态 */
        .info-card[data-hidden="true"] {
            display: none;
        }
        
        /* 拖拽占位符 */
        .card-drag-placeholder {
            background: var(--vh-border-light);
            border: 2px dashed var(--vh-primary);
            border-radius: var(--radius-md);
            min-height: 100px;
            margin-bottom: var(--spacing-lg);
        }
        
        /* 拖拽中的卡片 */
        .info-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        /* 卡片设置菜单 */
        .card-settings-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--vh-border);
            padding: var(--spacing-xs);
            min-width: 160px;
            z-index: 1000;
            display: none;
        }
        
        .card-settings-menu.show {
            display: block;
            animation: fadeInDown 0.2s ease;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card-settings-menu-item {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-size-sm);
            color: var(--vh-text);
            transition: background var(--transition-base);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .card-settings-menu-item:hover {
            background: var(--vh-surface);
        }
        
        .card-settings-menu-item.danger {
            color: var(--vh-error);
        }
        
        .card-settings-menu-item.danger:hover {
            background: var(--vh-error-soft);
        }
        
        .card-settings-menu-divider {
            height: 1px;
            background: var(--vh-border);
            margin: var(--spacing-xs) 0;
        }
        
        /* 卡片大小样式 */
        .info-card.card-size-small {
            flex: 0 1 300px;
        }
        
        .info-card.card-size-medium {
            flex: 1 1 400px;
        }
        
        .info-card.card-size-large {
            flex: 1 1 100%;
        }
        
        @media (max-width: 1200px) {
            .info-card.card-size-large {
                flex: 1 1 100%;
            }
        }
        
        /* 卡片拖拽样式 */
        .card-chosen {
            opacity: 0.8;
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }
        
        .card-dragging {
            opacity: 0.5;
        }
        
        /* 卡片头部可拖拽提示 */
        .info-card-header {
            cursor: move;
            user-select: none;
        }
        
        .info-card-header:hover {
            background: linear-gradient(135deg, rgba(31, 42, 87, 0.05) 0%, rgba(31, 42, 87, 0.02) 100%);
        }
        
        /* 拖拽时的视觉反馈 */
        .info-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        
        /* 滚动条样式优化 */
        .info-card-body::-webkit-scrollbar,
        .kanban-column::-webkit-scrollbar {
            width: 6px;
        }
        
        .info-card-body::-webkit-scrollbar-track,
        .kanban-column::-webkit-scrollbar-track {
            background: var(--vh-border-light);
            border-radius: var(--radius-full);
        }
        
        .info-card-body::-webkit-scrollbar-thumb,
        .kanban-column::-webkit-scrollbar-thumb {
            background: var(--vh-border);
            border-radius: var(--radius-full);
        }
        
        .info-card-body::-webkit-scrollbar-thumb:hover,
        .kanban-column::-webkit-scrollbar-thumb:hover {
            background: var(--vh-primary-muted);
        }
        
        /* 公告项样式 */
        .announcement-item {
            border-left: 3px solid transparent;
            background: var(--vh-card-bg);
        }
        
        .announcement-item:hover {
            background: var(--vh-surface);
            border-left-color: var(--vh-primary);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(15, 30, 58, 0.08);
        }
        
        /* 通知项行样式修复 */
        .notify-item-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
        }
    </style>
</head>
<body>
<div class="app-shell">
    <div class="main-area">
        <!-- 欢迎卡片 -->
        <div class="welcome-card">
            <div class="welcome-card-content">
                <div class="welcome-card-left">
                    <div class="welcome-greeting">
                        <span>
                            {% now "G" as hour %}
                            {% if hour|floatformat:0|add:'0' < 12 %}早上好{% elif hour|floatformat:0|add:'0' < 18 %}下午好{% else %}晚上好{% endif %}，{{ user.get_full_name|default:user.username }}
                        </span>
                    </div>
                    <div class="welcome-date-info">
                        <span>今天是 {% now "Y年n月j日" %} {% now "l" %}</span>
                        <span style="margin: 0 8px; opacity: 0.5;">|</span>
                        <span>祝您工作顺利！</span>
                    </div>
                </div>
                <div class="welcome-card-right">
                    <a href="{% url 'system_pages:account_settings' %}" class="welcome-action-btn">
                        <span>⚙️</span>
                        <span>账号设置</span>
                    </a>
                                        {% if is_superuser %}
                    <button id="django-service-control-btn" class="welcome-action-btn" style="cursor: pointer; border: none; background: transparent; padding: 0; margin: 0;" title="Django服务控制">
                        <span>🔄</span>
                        <span>服务控制</span>
                    </button>
                    {% endif %}
<a href="{% url 'logout' %}" class="welcome-action-btn logout">
                        <span>🚪</span>
                        <span>退出登录</span>
                    </a>
                </div>
            </div>
        </div>

        <main class="workspace">
            <aside class="workspace-nav">
                <nav class="sidenav">
                    <div class="sidenav-section">
                        <div class="sidenav-title">功能模块</div>
                        <div class="sidenav-links">
                            {% for menu_item in centers_navigation %}
                            {% if menu_item.children %}
                            <div class="sidenav-item">
                                <a class="sidenav-link" href="{{ menu_item.url }}"{% if request.path == menu_item.url or request.path|slice:":20" == menu_item.url|slice:":20" %} data-active="true"{% endif %}>
                                    <span>{{ menu_item.label }}</span>
                                </a>
                                <div class="submenu">
                                    {% for child in menu_item.children %}
                                    <a class="sidenav-link sidenav-sub-link" href="{{ child.url }}"{% if request.path == child.url %} data-active="true"{% endif %}>
                                        <span>{{ child.label }}</span>
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                            {% else %}
                            <a class="sidenav-link" href="{{ menu_item.url }}"{% if request.path == menu_item.url %} data-active="true"{% endif %}>
                                <span>{{ menu_item.label }}</span>
                            </a>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </nav>
                            <!-- 管理后台入口 -->
                            <a class="sidenav-link" href="{% url 'admin:index' %}" style="border-top: 1px solid var(--vh-border); margin-top: var(--spacing-sm); padding-top: var(--spacing-sm);">
                                <span>⚙️ 管理后台</span>
                            </a>
                <!-- 待办事项 - 优化样式 -->
                <div class="info-card info-card-slide-up" data-card-id="todo-items" style="margin-top: var(--spacing-md);">
                    <div class="info-card-header">
                        <h5 class="info-card-title">待办事项</h5>
                        <div class="info-card-actions">
                            <a href="{% url 'production_pages:project_task_dashboard' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看全部 →</a>
                        </div>
                    </div>
                    <div class="info-card-body">
                        <div class="info-grid info-grid-2">
                            <!-- 待处理任务 -->
                            <div class="info-item" style="padding: var(--spacing-md); background: var(--vh-surface); border-radius: var(--radius-md); border-left: 4px solid var(--vh-primary);">
                                <span class="info-label">待处理任务</span>
                                <div class="info-value" style="font-size: var(--font-size-2xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">{{ pending_counts.personal }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">今日 {{ pending_counts.due_today }} · 逾期 <span style="color: var(--vh-error); font-weight: 600;">{{ pending_counts.overdue }}</span></div>
                            </div>
                            
                            <!-- 待我审批 -->
                            {% if approval_stats.my_pending > 0 %}
                            <div class="info-item" style="padding: var(--spacing-md); background: var(--vh-error-soft); border-radius: var(--radius-md); border-left: 4px solid var(--vh-error);">
                                <span class="info-label">✍️ 待我审批</span>
                                <div class="info-value" style="font-size: var(--font-size-2xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-error);">{{ approval_stats.my_pending }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">我提交的 {{ approval_stats.my_submitted }}</div>
                            </div>
                            {% else %}
                            <div class="info-item" style="padding: var(--spacing-md); background: var(--vh-surface); border-radius: var(--radius-md); border-left: 4px solid var(--vh-success);">
                                <span class="info-label">✍️ 待我审批</span>
                                <div class="info-value" style="font-size: var(--font-size-2xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">0</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">暂无待审批事项</div>
                            </div>
                            {% endif %}
                            
                            <!-- 待接收事项 -->
                            {% if delivery_stats.pending > 0 %}
                            <div class="info-item" style="padding: var(--spacing-md); background: var(--vh-warning-soft); border-radius: var(--radius-md); border-left: 4px solid var(--vh-warning);">
                                <span class="info-label">待接收事项</span>
                                <div class="info-value" style="font-size: var(--font-size-2xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-warning);">{{ delivery_stats.pending }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">项目接收 · 交付接收</div>
                            </div>
                            {% else %}
                            <div class="info-item" style="padding: var(--spacing-md); background: var(--vh-surface); border-radius: var(--radius-md); border-left: 4px solid var(--vh-success);">
                                <span class="info-label">待接收事项</span>
                                <div class="info-value" style="font-size: var(--font-size-2xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">0</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">暂无待接收事项</div>
                            </div>
                            {% endif %}
                            
                            <!-- 待回复事项（预留，可根据实际业务扩展） -->
                            <div class="info-item" style="padding: var(--spacing-md); background: var(--vh-surface); border-radius: var(--radius-md); border-left: 4px solid var(--vh-info);">
                                <span class="info-label">💬 待回复事项</span>
                                <div class="info-value" style="font-size: var(--font-size-2xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">0</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">意见回复 · 客户反馈</div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
            <section class="workspace-main" id="workspaceMain">
                <!-- 统计卡片区域 - 使用统一样式优化 -->
                <div class="info-card info-card-elevated info-card-slide-up" data-card-id="data-overview">
                    <div class="info-card-header">
                        <h5 class="info-card-title">数据概览</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <span class="muted" id="lastRefreshTime" style="font-size: var(--font-size-xs);">刚刚更新</span>
                            <button class="btn btn-sm btn-outline-secondary" id="refreshDataBtn" style="padding: 4px 10px; font-size: var(--font-size-xs);" title="刷新数据">
                                <span style="display: inline-block; transition: transform 0.3s ease;">🔄</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="data-overview" style="padding: 4px 10px; font-size: var(--font-size-xs);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                    </div>
                    </div>
                                <div class="info-card-body">
                        <div class="info-grid info-grid-4 info-grid-responsive">
                            {% for card in stats_cards %}
                            <div class="info-item" style="cursor: pointer; padding: var(--spacing-md);" onclick="{% if card.url and card.url != '#' %}location.href='{{ card.url }}'{% endif %}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                        <span class="info-label">{{ card.label }}</span>
                                        <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: {% if card.variant == 'danger' %}#E23D3D{% elif card.variant == 'warning' %}#D97706{% elif card.variant == 'success' %}#16A34A{% elif card.variant == 'info' %}#2563EB{% else %}var(--vh-text){% endif %};">
                                                {{ card.value }}
                                            </div>
                                        {% if card.trend %}
                                        <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">{{ card.trend }}</div>
                                        {% endif %}
                                        </div>
                                    </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- 我的任务看板 - 优化视觉效果 -->
                <div class="info-card info-card-slide-up" data-card-id="task-board">
                    <div class="info-card-header">
                        <h5 class="info-card-title">我的任务看板</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'production_pages:project_task_dashboard' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看全部 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="task-board" style="padding: 4px 10px; font-size: var(--font-size-xs);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                    </div>
                    </div>
                    <div class="info-card-body">
                    <div class="kanban">
                            <div class="kanban-column" style="border-left: 4px solid var(--vh-error);">
                                <h4 style="color: var(--vh-error);">待处理</h4>
                            {% if task_board.pending %}
                                {% for task in task_board.pending %}
                                    <div class="task-card task-card-hover">
                                        <div class="task-title"><a href="{{ task.url }}" target="_blank" style="color: var(--vh-text); text-decoration: none; font-weight: 600;">{{ task.title }}</a></div>
                                    <div class="task-meta">
                                            <span style="font-size: var(--font-size-sm); color: var(--vh-text-muted);">{{ task.project_number }} {{ task.project_name }}</span>
                                        {% if task.due_time %}
                                            <span class="text-warning" style="font-size: var(--font-size-xs); font-weight: 600;">{{ task.due_time|date:"m-d H:i" }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state">
                                    <span class="chip"><i></i> 暂无待处理任务</span>
                                </div>
                            {% endif %}
                        </div>
                            <div class="kanban-column" style="border-left: 4px solid var(--vh-info);">
                                <h4 style="color: var(--vh-info);">进行中</h4>
                            {% if task_board.in_progress %}
                                {% for task in task_board.in_progress %}
                                    <div class="task-card task-card-hover">
                                        <div class="task-title"><a href="{{ task.url }}" target="_blank" style="color: var(--vh-text); text-decoration: none; font-weight: 600;">{{ task.title }}</a></div>
                                    <div class="task-meta">
                                            <span style="font-size: var(--font-size-sm); color: var(--vh-text-muted);">{{ task.project_number }} {{ task.project_name }}</span>
                                        {% if task.due_time %}
                                            <span style="font-size: var(--font-size-xs); color: var(--vh-text-muted);">{{ task.due_time|date:"m-d H:i" }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state">
                                    <span class="chip"><i></i> 暂无进行中任务</span>
                                </div>
                            {% endif %}
                        </div>
                            <div class="kanban-column" style="border-left: 4px solid var(--vh-success);">
                                <h4 style="color: var(--vh-success);">已完成</h4>
                            {% if task_board.completed %}
                                {% for task in task_board.completed %}
                                    <div class="task-card task-card-hover">
                                        <div class="task-title"><a href="{{ task.url }}" target="_blank" style="color: var(--vh-text); text-decoration: none; font-weight: 600;">{{ task.title }}</a></div>
                                    <div class="task-meta">
                                            <span style="font-size: var(--font-size-sm); color: var(--vh-text-muted);">{{ task.project_number }} {{ task.project_name }}</span>
                                        {% if task.completed_time %}
                                            <span style="font-size: var(--font-size-xs); color: var(--vh-success);">完成于 {{ task.completed_time|date:"m-d H:i" }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state">
                                    <span class="chip"><i></i> 近期暂无已完成记录</span>
                                </div>
                            {% endif %}
                        </div>
                        </div>
                        <!-- 任务分布图 -->
                        {% if task_status_distribution.data and task_status_distribution.labels %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm);">任务状态分布</div>
                            <canvas id="taskStatusChart" style="max-height: 150px;"></canvas>
                        </div>
                        {% endif %}
            </div>
        </div>
        
                <!-- 我参与的项目 - 优化卡片样式 -->
                <div class="info-card info-card-slide-up" data-card-id="my-projects">
                    <div class="info-card-header">
                        <h5 class="info-card-title">🏗️ 我参与的项目</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'production_pages:project_list' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看更多 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="my-projects" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                    </div>
                    </div>
                    <div class="info-card-body">
                    {% if project_cards %}
                    <div class="project-cards">
                        {% for project in project_cards %}
                            <div class="project-card project-card-hover" onclick="location.href='{% url 'production_pages:project_detail' project.id %}'" style="cursor: pointer;">
                            <div class="d-flex justify-content-between align-items-start" style="gap: var(--spacing-md);">
                                <div class="flex-grow-1" style="min-width: 0; overflow: hidden;">
                                        <div style="font-size: var(--font-size-md); font-weight: 600; color: var(--vh-text); margin-bottom: var(--spacing-xs); word-break: break-word; overflow-wrap: break-word;">{{ project.number }} {{ project.name }}</div>
                                        <div class="muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-sm); word-break: break-word; overflow-wrap: break-word;">项目负责人：{{ project.manager }} · 商务经理：{{ project.business_manager }}</div>
                                    <div class="mt-2">
                                            <div class="progress" style="height: 8px; border-radius: var(--radius-full); background: var(--vh-border-light); overflow: hidden;">
                                                <div class="progress-bar" role="progressbar" style="width: {{ project.progress }}%; background: linear-gradient(90deg, var(--vh-primary), var(--vh-primary-light)); transition: width 0.3s ease;" aria-valuenow="{{ project.progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end" style="flex-shrink: 0; min-width: 80px;">
                                        <div class="text-primary" style="font-size: var(--font-size-xl); font-weight: 700; white-space: nowrap;">{{ project.progress }}%</div>
                                        <div class="muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs); white-space: nowrap;">{{ project.status_display }}</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                            <p style="font-size: var(--font-size-base);">暂无参与的项目</p>
                        {% if 'production_pages:project_create' %}
                        <a href="{% url 'production_pages:project_create' %}" class="btn btn-sm btn-primary mt-2">创建项目</a>
                        {% endif %}
                    </div>
                    {% endif %}
                    <!-- 项目进度分布图 -->
                    {% if project_status_distribution.data and project_status_distribution.labels %}
                    <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                        <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm);">项目状态分布</div>
                        <canvas id="projectStatusChart" style="max-height: 150px;"></canvas>
                    </div>
                    {% endif %}
                    </div>
                </div>
                
                <!-- 客户线索快速统计 - 使用统一样式 -->
                {% if customer_stats.leads.total > 0 or customer_stats.leads.my_leads > 0 %}
                <div class="info-card info-card-slide-up" data-card-id="customer-leads">
                    <div class="info-card-header">
                        <h5 class="info-card-title">📞 客户线索</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'business_pages:customer_list' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看全部 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="customer-leads" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                    </div>
                    </div>
                                <div class="info-card-body">
                        <div class="info-grid info-grid-4 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">线索总数</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs);">{{ customer_stats.leads.total }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">本周新增 {{ customer_stats.leads.week_new }}</div>
                                </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">我的线索</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">{{ customer_stats.leads.my_leads }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">未处理 {{ customer_stats.leads.unhandled }}</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">已转化</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">{{ customer_stats.leads.converted }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">转化率 {{ customer_stats.leads.conversion_rate }}%</div>
                        </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">今日新增</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">{{ customer_stats.leads.today_new }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">流失 {{ customer_stats.leads.lost }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- 商机快速统计 - 使用统一样式 -->
                {% if customer_stats.opportunities.total > 0 %}
                <div class="info-card info-card-slide-up" data-card-id="opportunities">
                    <div class="info-card-header">
                        <h5 class="info-card-title">商机管理</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'business_pages:opportunity_management' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看全部 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="opportunities" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                                <div class="info-card-body">
                        <div class="info-grid info-grid-4 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">商机总数</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs);">{{ customer_stats.opportunities.total }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">进行中 {{ customer_stats.opportunities.active }}</div>
                                </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">赢单数</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">{{ customer_stats.opportunities.won }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">输单 {{ customer_stats.opportunities.lost }}</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">商机总额</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">¥{{ customer_stats.opportunities.total_amount|floatformat:0|default:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">万元</div>
                        </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">赢单金额</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">¥{{ customer_stats.opportunities.won_amount|floatformat:0|default:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">万元</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- 产值统计卡片 - 员工角色 -->
                {% if user_role_level == 'employee' and output_value_stats.this_month > 0 %}
                <div class="info-card info-card-slide-up" data-card-id="output-value">
                    <div class="info-card-header">
                        <h5 class="info-card-title">我的产值统计</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'settlement_pages:output_value_record_list' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看详情 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="output-value" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                                <div class="info-card-body">
                        <div class="info-grid info-grid-4 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">本月产值</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">¥{{ output_value_stats.this_month|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">
                                    {% if output_value_stats.month_over_month > 0 %}
                                    <span style="color: var(--vh-success);">↑{{ output_value_stats.month_over_month|floatformat:1 }}%</span>
                                    {% elif output_value_stats.month_over_month < 0 %}
                                    <span style="color: var(--vh-error);">↓{{ output_value_stats.month_over_month_abs|floatformat:1 }}%</span>
                                    {% else %}
                                    环比持平
                                    {% endif %}
                                </div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">累计产值</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-text);">¥{{ output_value_stats.total|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">已确认 ¥{{ output_value_stats.confirmed|floatformat:0 }}</div>
                        </div>
                            {% if output_value_stats.rank %}
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">产值排名</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">第{{ output_value_stats.rank }}名</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">部门排名</div>
                            </div>
                            {% endif %}
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">待确认产值</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-warning);">¥{{ output_value_stats.pending|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">待确认</div>
                            </div>
                        </div>
                        <!-- 产值趋势图 -->
                        {% if output_value_stats.trend_data and output_value_stats.trend_labels %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm);">近6个月产值趋势</div>
                            <canvas id="outputValueTrendChart" style="max-height: 200px;"></canvas>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- 考勤统计卡片 - 员工角色 -->
                {% if user_role_level == 'employee' and attendance_stats.has_data %}
                <div class="info-card info-card-slide-up" data-card-id="attendance">
                    <div class="info-card-header">
                        <h5 class="info-card-title">⏰ 我的考勤统计</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'personnel_pages:attendance_management' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看详情 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="attendance" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                                <div class="info-card-body">
                        <div class="info-grid info-grid-4 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">本月出勤</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">{{ attendance_stats.attendance_days }}天</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">出勤率 {{ attendance_stats.attendance_rate }}%</div>
                                </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">本月请假</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">{{ attendance_stats.leave_days }}天</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">已批准</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">本月加班</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-warning);">{{ attendance_stats.overtime_days }}天</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">加班记录</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">迟到次数</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); {% if attendance_stats.late_count > 0 %}color: var(--vh-error);{% else %}color: var(--vh-success);{% endif %}">{{ attendance_stats.late_count }}次</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">本月统计</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- 我的业务统计卡片 - 员工角色 -->
                {% if user_role_level == 'employee' %}
                <div class="info-card info-card-slide-up" data-card-id="my-business">
                    <div class="info-card-header">
                        <h5 class="info-card-title">我的业务统计</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="my-business" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                    </div>
                    </div>
                                <div class="info-card-body">
                        <div class="info-grid info-grid-3 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">我的客户</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">{{ customer_stats.leads.my_leads }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">活跃客户 {{ customer_stats.clients.active }}</div>
                                </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">我的商机</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">{{ customer_stats.opportunities.total }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">进行中 {{ customer_stats.opportunities.active }}</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">跟进记录</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-text);">{{ customer_stats.leads.week_new }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">本周新增</div>
                        </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- 我的计划统计卡片 - 员工角色 -->
                {% if user_role_level == 'employee' and plan_stats %}
                <div class="info-card info-card-slide-up" data-card-id="my-plans">
                    <div class="info-card-header">
                        <h5 class="info-card-title">我的计划统计</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'production_pages:project_list' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看详情 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="my-plans" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                                <div class="info-card-body">
                        <div class="info-grid info-grid-3 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">进行中计划</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">{{ plan_stats.in_progress }}个</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">待完成</div>
                                </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">已完成计划</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">{{ plan_stats.completed }}个</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">已完成</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">计划完成率</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">{{ plan_stats.completion_rate }}%</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">总计 {{ plan_stats.total }}个</div>
                        </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- 部门风险预警卡片 - 部门经理角色 -->
                {% if user_role_level == 'department_manager' and department_stats and department_stats.overdue_projects > 0 %}
                <div class="info-card info-card-slide-up" data-card-id="department-risks" style="border-left: 4px solid var(--vh-error);">
                    <div class="info-card-header">
                        <h5 class="info-card-title">部门风险预警</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'production_pages:project_list' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看详情 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="department-risks" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                                <div class="info-card-body">
                        <div class="info-grid info-grid-1">
                            <div class="info-item" style="padding: var(--spacing-md); background: var(--vh-error-soft); border-radius: var(--radius-md);">
                                <span class="info-label">延期项目</span>
                                <div class="info-value" style="font-size: var(--font-size-2xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-error);">{{ department_stats.overdue_projects }}个</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">需要关注的项目</div>
                                </div>
                            </div>
                        </div>
                </div>
                {% endif %}
                
                <!-- 部门人员排名卡片 - 部门经理角色 -->
                {% if user_role_level == 'department_manager' and department_stats and department_stats.member_ranks %}
                <div class="info-card info-card-slide-up" data-card-id="department-ranks">
                    <div class="info-card-header">
                        <h5 class="info-card-title">🏆 部门人员产值排名</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="department-ranks" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                                <div class="info-card-body">
                        <div class="info-grid info-grid-1">
                            {% for rank_item in department_stats.member_ranks %}
                            <div class="info-item" style="padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                    <span style="font-size: var(--font-size-lg); font-weight: 700; color: {% if forloop.counter == 1 %}var(--vh-warning){% elif forloop.counter == 2 %}var(--vh-info){% elif forloop.counter == 3 %}var(--vh-success){% else %}var(--vh-text-muted){% endif %};">#{{ forloop.counter }}</span>
                                    <span style="font-size: var(--font-size-base); color: var(--vh-text);">{{ rank_item.name }}</span>
                                </div>
                                <span style="font-size: var(--font-size-base); font-weight: 600; color: var(--vh-primary);">¥{{ rank_item.value|floatformat:0 }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- 部门统计卡片 - 部门经理角色 -->
                {% if user_role_level == 'department_manager' and department_stats %}
                <div class="info-card info-card-slide-up" data-card-id="department-stats">
                    <div class="info-card-header">
                        <h5 class="info-card-title">部门人员统计</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'personnel_pages:personnel_home' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看详情 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="department-stats" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                                <div class="info-card-body">
                        <div class="info-grid info-grid-4 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">部门总人数</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">{{ department_stats.total_members }}人</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">在岗 {{ department_stats.active_members }}人</div>
                                </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">本月部门产值</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">¥{{ department_stats.this_month_output|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">人均 ¥{{ department_stats.avg_output_value|floatformat:0 }}</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">任务完成率</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">{{ department_stats.task_completion_rate }}%</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">项目完成率 {{ department_stats.project_completion_rate }}%</div>
                        </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">部门效率</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-text);">良好</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">人均产值 ¥{{ department_stats.avg_output_value|floatformat:0 }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 部门工作量分布卡片 - 部门经理角色 -->
                {% if department_stats.workload_by_profession or department_stats.workload_by_member %}
                <div class="info-card info-card-slide-up" data-card-id="department-workload">
                    <div class="info-card-header">
                        <h5 class="info-card-title">部门工作量分布</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="department-workload" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        {% if department_stats.workload_by_profession %}
                        <div style="margin-bottom: var(--spacing-md);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm); font-weight: 600;">各专业工作量</div>
                            <div class="info-grid info-grid-1">
                                {% for item in department_stats.workload_by_profession %}
                                <div class="info-item" style="padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: var(--font-size-base); color: var(--vh-text);">{{ item.name }}</span>
                                    <span style="font-size: var(--font-size-base); font-weight: 600; color: var(--vh-primary);">{{ item.value }}个项目</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if department_stats.workload_by_member %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm); font-weight: 600;">各人员工作量</div>
                            <div class="info-grid info-grid-1">
                                {% for item in department_stats.workload_by_member %}
                                <div class="info-item" style="padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: var(--font-size-base); color: var(--vh-text);">{{ item.name }}</span>
                                    <span style="font-size: var(--font-size-base); font-weight: 600; color: var(--vh-info);">{{ item.value }}个任务</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endif %}
                
                <!-- 公司统计卡片 - 高管角色 -->
                {% if user_role_level == 'general_manager' and company_stats %}
                <div class="info-card info-card-slide-up" data-card-id="company-key-metrics">
                    <div class="info-card-header">
                        <h5 class="info-card-title">关键指标</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="company-key-metrics" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                                <div class="info-card-body">
                        <div class="info-grid info-grid-4 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">总产值</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">¥{{ company_stats.this_month_output|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">人均 ¥{{ company_stats.avg_output_value|floatformat:0 }}</div>
                                </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">总销售</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">¥{{ company_stats.total_sales|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">商机总额</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">总回款</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">¥{{ company_stats.total_collection|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">合同总额</div>
                        </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">总利润</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">¥{{ company_stats.total_profit|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">利润率 {{ company_stats.profit_rate }}%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="info-card info-card-slide-up" data-card-id="company-efficiency">
                    <div class="info-card-header">
                        <h5 class="info-card-title">公司效率统计</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="company-efficiency" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                                <div class="info-card-body">
                        <div class="info-grid info-grid-4 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">公司总人数</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-text);">{{ company_stats.total_members }}人</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">在岗员工</div>
                                </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">人均产值</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">¥{{ company_stats.avg_output_value|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">本月平均</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">任务完成率</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">{{ company_stats.task_completion_rate }}%</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">项目完成率 {{ company_stats.project_completion_rate }}%</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">整体效率</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">优秀</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">运营良好</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 公司收入统计卡片 - 高管角色 -->
                {% if user_role_level == 'general_manager' and company_stats %}
                <div class="info-card info-card-slide-up" data-card-id="company-revenue">
                    <div class="info-card-header">
                        <h5 class="info-card-title">公司收入统计</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="company-revenue" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        <div class="info-grid info-grid-3 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">营业收入</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">¥{{ company_stats.total_revenue|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">合同总额</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">服务费收入</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">¥{{ company_stats.service_fee_revenue|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">产值收入</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">其他收入</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">¥{{ company_stats.other_revenue|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">其他来源</div>
                            </div>
                        </div>
                        {% if company_stats.revenue_trend_data and company_stats.revenue_trend_labels %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm);">近6个月收入趋势</div>
                            <canvas id="revenueTrendChart" style="max-height: 200px;"></canvas>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- 公司成本统计卡片 - 高管角色 -->
                <div class="info-card info-card-slide-up" data-card-id="company-cost">
                    <div class="info-card-header">
                        <h5 class="info-card-title">💸 公司成本统计</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="company-cost" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        <div class="info-grid info-grid-3 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">人力成本</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-warning);">¥{{ company_stats.human_cost|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">人员费用</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">项目成本</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">¥{{ company_stats.project_cost|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">项目支出</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">其他成本</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-text);">¥{{ company_stats.other_cost|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">其他支出</div>
                            </div>
                        </div>
                        <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--vh-surface); border-radius: var(--radius-md);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="info-label">总成本</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; color: var(--vh-error);">¥{{ company_stats.total_cost|floatformat:0 }}</div>
                            </div>
                        </div>
                        {% if company_stats.cost_trend_data and company_stats.revenue_trend_labels %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm);">近6个月成本趋势</div>
                            <canvas id="costTrendChart" style="max-height: 200px;"></canvas>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- 公司利润分析卡片 - 高管角色 -->
                <div class="info-card info-card-slide-up" data-card-id="company-profit">
                    <div class="info-card-header">
                        <h5 class="info-card-title">公司利润分析</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="company-profit" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        <div class="info-grid info-grid-2 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">利润总额</span>
                                <div class="info-value" style="font-size: var(--font-size-2xl); font-weight: 700; margin-top: var(--spacing-xs); {% if company_stats.total_profit > 0 %}color: var(--vh-success);{% else %}color: var(--vh-error);{% endif %}">¥{{ company_stats.total_profit|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">收入 - 成本</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">利润率</span>
                                <div class="info-value" style="font-size: var(--font-size-2xl); font-weight: 700; margin-top: var(--spacing-xs); {% if company_stats.profit_rate > 0 %}color: var(--vh-success);{% else %}color: var(--vh-error);{% endif %}">{{ company_stats.profit_rate }}%</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">利润占比</div>
                            </div>
                        </div>
                        {% if company_stats.profit_trend_data and company_stats.revenue_trend_labels %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm);">近6个月利润趋势</div>
                            <canvas id="profitTrendChart" style="max-height: 200px;"></canvas>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- 客户分析卡片 - 高管角色 -->
                {% if user_role_level == 'general_manager' and company_stats and company_stats.customer_analysis %}
                <div class="info-card info-card-slide-up" data-card-id="customer-analysis">
                    <div class="info-card-header">
                        <h5 class="info-card-title">客户分析</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'business_pages:customer_list' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看详情 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="customer-analysis" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        <div class="info-grid info-grid-4 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">客户总数</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">{{ company_stats.customer_analysis.total }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">活跃 {{ company_stats.customer_analysis.active }}</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">VIP客户</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-warning);">{{ company_stats.customer_analysis.vip }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">重要客户 {{ company_stats.customer_analysis.important }}</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">一般客户</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">{{ company_stats.customer_analysis.general }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">潜在客户 {{ company_stats.customer_analysis.potential }}</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">客户价值</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">良好</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">VIP占比 {{ company_stats.customer_analysis.vip_percentage }}%</div>
                            </div>
                        </div>
                        {% if company_stats.customer_analysis.trend_data and company_stats.customer_analysis.trend_labels %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm);">近6个月客户增长趋势</div>
                            <canvas id="customerTrendChart" style="max-height: 200px;"></canvas>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- 商机分析卡片 - 高管角色 -->
                {% if company_stats.opportunity_analysis %}
                <div class="info-card info-card-slide-up" data-card-id="opportunity-analysis">
                    <div class="info-card-header">
                        <h5 class="info-card-title">商机分析</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'business_pages:opportunity_management' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看详情 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="opportunity-analysis" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        <div class="info-grid info-grid-2 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">商机总数</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">{{ company_stats.opportunity_analysis.total }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">转化率 {{ company_stats.opportunity_analysis.conversion_rate }}%</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">赢单数</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">{{ company_stats.opportunity_analysis.won }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">输单 {{ company_stats.opportunity_analysis.lost }}</div>
                            </div>
                        </div>
                        <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--vh-surface); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm); font-weight: 600;">销售漏斗</div>
                            <div class="info-grid info-grid-1" style="gap: var(--spacing-xs);">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-xs) var(--spacing-sm);">
                                    <span style="font-size: var(--font-size-sm);">潜在客户</span>
                                    <span style="font-size: var(--font-size-sm); font-weight: 600; color: var(--vh-text);">{{ company_stats.opportunity_analysis.potential }}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-xs) var(--spacing-sm);">
                                    <span style="font-size: var(--font-size-sm);">初步接触</span>
                                    <span style="font-size: var(--font-size-sm); font-weight: 600; color: var(--vh-info);">{{ company_stats.opportunity_analysis.initial_contact }}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-xs) var(--spacing-sm);">
                                    <span style="font-size: var(--font-size-sm);">需求确认</span>
                                    <span style="font-size: var(--font-size-sm); font-weight: 600; color: var(--vh-info);">{{ company_stats.opportunity_analysis.requirement_confirmed }}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-xs) var(--spacing-sm);">
                                    <span style="font-size: var(--font-size-sm);">方案报价</span>
                                    <span style="font-size: var(--font-size-sm); font-weight: 600; color: var(--vh-warning);">{{ company_stats.opportunity_analysis.quotation }}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-xs) var(--spacing-sm);">
                                    <span style="font-size: var(--font-size-sm);">商务谈判</span>
                                    <span style="font-size: var(--font-size-sm); font-weight: 600; color: var(--vh-warning);">{{ company_stats.opportunity_analysis.negotiation }}</span>
                                </div>
                            </div>
                        </div>
                        {% if company_stats.opportunity_analysis.trend_data and company_stats.opportunity_analysis.trend_labels %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm);">近6个月商机趋势</div>
                            <canvas id="opportunityTrendChart" style="max-height: 200px;"></canvas>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endif %}
                
                <!-- 人员分析卡片 - 高管角色 -->
                {% if user_role_level == 'general_manager' and company_stats and company_stats.personnel_analysis %}
                <div class="info-card info-card-slide-up" data-card-id="personnel-analysis">
                    <div class="info-card-header">
                        <h5 class="info-card-title">人员分析</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'personnel_pages:personnel_home' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看详情 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="personnel-analysis" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        {% if company_stats.personnel_analysis.dept_distribution %}
                        <div style="margin-bottom: var(--spacing-md);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm); font-weight: 600;">各部门人数分布</div>
                            <div class="info-grid info-grid-1">
                                {% for dept in company_stats.personnel_analysis.dept_distribution %}
                                <div class="info-item" style="padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span style="font-size: var(--font-size-base); color: var(--vh-text);">{{ dept.name }}</span>
                                        <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: 2px;">人均产值 ¥{{ dept.avg_output|floatformat:0 }}</div>
                                    </div>
                                    <span style="font-size: var(--font-size-base); font-weight: 600; color: var(--vh-primary);">{{ dept.count }}人</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if company_stats.personnel_analysis.efficiency_trend_data and company_stats.personnel_analysis.efficiency_trend_labels %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm);">近6个月人员效率趋势</div>
                            <canvas id="personnelEfficiencyChart" style="max-height: 200px;"></canvas>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- 产值分析卡片 - 高管角色 -->
                {% if company_stats.output_value_analysis %}
                <div class="info-card info-card-slide-up" data-card-id="output-value-analysis">
                    <div class="info-card-header">
                        <h5 class="info-card-title">产值分析</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="output-value-analysis" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        {% if company_stats.output_value_analysis.stage_distribution %}
                        <div style="margin-bottom: var(--spacing-md);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm); font-weight: 600;">各阶段产值分布</div>
                            <div class="info-grid info-grid-1">
                                {% for stage in company_stats.output_value_analysis.stage_distribution %}
                                <div class="info-item" style="padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: var(--font-size-base); color: var(--vh-text);">{{ stage.name }}</span>
                                    <span style="font-size: var(--font-size-base); font-weight: 600; color: var(--vh-primary);">¥{{ stage.value|floatformat:0 }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if company_stats.output_value_analysis.dept_distribution %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm); font-weight: 600;">各部门产值分布</div>
                            <div class="info-grid info-grid-1">
                                {% for dept in company_stats.output_value_analysis.dept_distribution %}
                                <div class="info-item" style="padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: var(--font-size-base); color: var(--vh-text);">{{ dept.name }}</span>
                                    <span style="font-size: var(--font-size-base); font-weight: 600; color: var(--vh-success);">¥{{ dept.value|floatformat:0 }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if company_stats.output_value_analysis.trend_data and company_stats.output_value_analysis.trend_labels %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm);">产值趋势预测</div>
                            <canvas id="outputValueAnalysisChart" style="max-height: 200px;"></canvas>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endif %}
                
                <!-- 项目分析卡片 - 高管角色 -->
                {% if user_role_level == 'general_manager' and company_stats and company_stats.project_analysis %}
                <div class="info-card info-card-slide-up" data-card-id="project-analysis">
                    <div class="info-card-header">
                        <h5 class="info-card-title">项目分析</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'production_pages:project_list' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看详情 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="project-analysis" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        <div class="info-grid info-grid-3 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">项目质量</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">{{ company_stats.project_analysis.quality_rate }}%</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">完成率</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">平均项目成本</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">¥{{ company_stats.project_analysis.avg_project_cost|floatformat:0 }}</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">单项目成本</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">项目效率</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); {% if company_stats.project_analysis.efficiency_score >= 80 %}color: var(--vh-success);{% elif company_stats.project_analysis.efficiency_score >= 60 %}color: var(--vh-warning);{% else %}color: var(--vh-error);{% endif %}">{{ company_stats.project_analysis.efficiency_score }}分</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">延期率 {{ company_stats.project_analysis.overdue_rate }}%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 计划分析卡片 - 高管角色 -->
                {% if company_stats.plan_analysis %}
                <div class="info-card info-card-slide-up" data-card-id="plan-analysis">
                    <div class="info-card-header">
                        <h5 class="info-card-title">计划分析</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="plan-analysis" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        <div class="info-grid info-grid-3 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">计划总数</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-primary);">{{ company_stats.plan_analysis.total_plans }}个</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">已完成 {{ company_stats.plan_analysis.completed_plans }}个</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">计划完成率</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-success);">{{ company_stats.plan_analysis.completion_rate }}%</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">完成情况</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">目标达成率</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-info);">{{ company_stats.plan_analysis.target_achievement_rate }}%</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">目标完成度</div>
                            </div>
                        </div>
                        {% if company_stats.plan_analysis.trend_data and company_stats.plan_analysis.trend_labels %}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--vh-border-light);">
                            <div style="font-size: var(--font-size-sm); color: var(--vh-text-muted); margin-bottom: var(--spacing-sm);">近6个月计划完成趋势</div>
                            <canvas id="planTrendChart" style="max-height: 200px;"></canvas>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endif %}
                
                <!-- 战略目标概览卡片 - 高管角色 -->
                {% if user_role_level == 'general_manager' and company_stats and company_stats.strategic_goals %}
                <div class="info-card info-card-slide-up" data-card-id="strategic-goals">
                    <div class="info-card-header">
                        <h5 class="info-card-title">战略目标概览</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="strategic-goals" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: linear-gradient(135deg, var(--vh-primary-light), var(--vh-primary)); border-radius: var(--radius-md);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: var(--font-size-base); font-weight: 600; color: #fff;">整体目标达成率</span>
                                <div style="font-size: var(--font-size-2xl); font-weight: 700; color: #fff;">{{ company_stats.strategic_goals.overall_achievement_rate }}%</div>
                            </div>
                        </div>
                        <div class="info-grid info-grid-2 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">财务目标</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); {% if company_stats.strategic_goals.financial.achievement_rate >= 80 %}color: var(--vh-success);{% elif company_stats.strategic_goals.financial.achievement_rate >= 60 %}color: var(--vh-warning);{% else %}color: var(--vh-error);{% endif %}">{{ company_stats.strategic_goals.financial.achievement_rate }}%</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">产值目标完成度</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">市场目标</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); {% if company_stats.strategic_goals.market.achievement_rate >= 80 %}color: var(--vh-success);{% elif company_stats.strategic_goals.market.achievement_rate >= 60 %}color: var(--vh-warning);{% else %}color: var(--vh-error);{% endif %}">{{ company_stats.strategic_goals.market.achievement_rate }}%</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">客户增长目标</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">运营目标</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); {% if company_stats.strategic_goals.operation.achievement_rate >= 80 %}color: var(--vh-success);{% elif company_stats.strategic_goals.operation.achievement_rate >= 60 %}color: var(--vh-warning);{% else %}color: var(--vh-error);{% endif %}">{{ company_stats.strategic_goals.operation.achievement_rate }}%</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">项目完成率</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">创新目标</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); {% if company_stats.strategic_goals.innovation.achievement_rate >= 80 %}color: var(--vh-success);{% elif company_stats.strategic_goals.innovation.achievement_rate >= 60 %}color: var(--vh-warning);{% else %}color: var(--vh-error);{% endif %}">{{ company_stats.strategic_goals.innovation.achievement_rate }}%</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">任务完成率</div>
                            </div>
                            <div class="info-item" style="padding: var(--spacing-md);">
                                <span class="info-label">人才目标</span>
                                <div class="info-value" style="font-size: var(--font-size-xl); font-weight: 700; margin-top: var(--spacing-xs); {% if company_stats.strategic_goals.talent.achievement_rate >= 80 %}color: var(--vh-success);{% elif company_stats.strategic_goals.talent.achievement_rate >= 60 %}color: var(--vh-warning);{% else %}color: var(--vh-error);{% endif %}">{{ company_stats.strategic_goals.talent.achievement_rate }}%</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">人员效率目标</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- 公司风险预警卡片 - 高管角色 -->
                {% if user_role_level == 'general_manager' and company_stats and company_stats.overdue_projects > 0 %}
                <div class="info-card info-card-slide-up" data-card-id="company-risks" style="border-left: 4px solid var(--vh-error);">
                    <div class="info-card-header">
                        <h5 class="info-card-title">公司风险预警中心</h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <a href="{% url 'production_pages:project_list' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">查看详情 →</a>
                            <button class="btn btn-sm btn-outline-secondary card-settings-btn" data-card-id="company-risks" style="padding: 4px 10px; font-size: var(--font-size-xs); opacity: 0; transition: opacity var(--transition-base);" title="卡片设置">
                                <span>⚙️</span>
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        <div class="info-grid info-grid-2 info-grid-responsive">
                            <div class="info-item" style="padding: var(--spacing-md); background: var(--vh-error-soft); border-radius: var(--radius-md);">
                                <span class="info-label">延期项目</span>
                                <div class="info-value" style="font-size: var(--font-size-2xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-error);">{{ company_stats.overdue_projects }}个</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">需要关注的项目</div>
                            </div>
                            {% if company_stats.overdue_collection > 0 %}
                            <div class="info-item" style="padding: var(--spacing-md); background: var(--vh-warning-soft); border-radius: var(--radius-md);">
                                <span class="info-label">逾期回款</span>
                                <div class="info-value" style="font-size: var(--font-size-2xl); font-weight: 700; margin-top: var(--spacing-xs); color: var(--vh-warning);">{{ company_stats.overdue_collection }}个</div>
                                <div class="text-muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">需要跟进的回款</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endif %}

                
            </section>

            <section class="workspace-side">
                <!-- 通知中心 - 优化样式 -->
                <div class="info-card info-card-slide-up">
                    <div class="info-card-header">
                        <h5 class="info-card-title"><span style="letter-spacing: 0.3em;">🔔 通知中心</span></h5>
                        <div class="info-card-actions" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <!-- 通知筛选 -->
                            <select id="notificationFilter" class="notification-filter" style="padding: 4px 8px; border-radius: var(--radius-sm); border: 1px solid var(--vh-border); font-size: var(--font-size-xs); background: #fff; cursor: pointer;">
                                <option value="all">全部</option>
                                <option value="system">系统通知</option>
                                <option value="task">任务通知</option>
                                <option value="approval">审批通知</option>
                                <option value="business">业务通知</option>
                            </select>
                            <!-- 通知搜索 -->
                            <input type="text" id="notificationSearch" placeholder="搜索通知..." class="notification-search" style="padding: 4px 8px; border-radius: var(--radius-sm); border: 1px solid var(--vh-border); font-size: var(--font-size-xs); width: 120px;">
                            <a href="#" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">管理</a>
                    </div>
                    </div>
                    <div class="info-card-body">
                    {% if notification_center %}
                        {% for block in notification_center %}
                            {% if block.title != '任务提醒' %}
                            <div class="notify-block" data-block-title="{{ block.title }}" data-notification-type="{% if '系统' in block.title %}system{% elif '任务' in block.title %}task{% elif '审批' in block.title %}approval{% elif '质量' in block.title or '团队' in block.title %}business{% else %}all{% endif %}">
                                <div class="notify-header">
                                    <span>{{ block.title }}</span>
                                    {% if block.unread_count %}
                                        <div class="notify-header-actions">
                                            <span class="badge badge-pill badge-danger">{{ block.unread_count }}</span>
                                            <button class="btn btn-sm btn-outline-primary notify-mark-all" style="padding: 4px 12px; font-size: var(--font-size-xs); white-space: nowrap;" data-endpoint="/project/api/notifications/mark-all-read/" data-block-title="{{ block.title }}">全部标记已读</button>
                                        </div>
                                    {% endif %}
                                </div>
                                {% if block.items %}
                                    {% for item in block.items %}
                                        <div class="notify-item{% if item.is_unread %} notify-item--unread{% endif %}" data-notification-id="{{ item.id }}" data-notification-title="{{ item.title|lower }}" data-notification-detail="{{ item.detail|lower|default:'' }}">
                                            <div class="notify-item-row">
                                                <div class="notify-item-title">
                                                    {% if item.url %}
                                                        <a href="{{ item.url }}" target="_blank">{{ item.title }}</a>
                                                    {% else %}
                                                        {{ item.title }}
                                                    {% endif %}
                                                </div>
                                                <div style="display: flex; gap: var(--spacing-xs); align-items: center;">
                                                {% if item.is_unread %}
                                                        <button class="btn btn-sm btn-primary notify-mark-read" style="padding: 4px 12px; font-size: var(--font-size-xs); flex-shrink: 0; white-space: nowrap;" data-endpoint="/project/api/notifications/{{ item.id }}/mark-read/" data-notification-id="{{ item.id }}">已读</button>
                                                {% endif %}
                                                    <button class="btn btn-sm btn-outline-secondary notify-delete" style="padding: 4px 8px; font-size: var(--font-size-xs); opacity: 0.6; transition: opacity var(--transition-base);" data-notification-id="{{ item.id }}" title="删除通知" onclick="deleteNotification({{ item.id }}); return false;">✕</button>
                                                </div>
                                            </div>
                                            {% if item.subtitle %}<div class="notify-item-subtitle">{{ item.subtitle }}</div>{% endif %}
                                            {% if item.detail %}<div class="notify-item-detail">{{ item.detail }}</div>{% endif %}
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="muted" style="font-size:12px;">暂无提醒</div>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="muted" style="font-size: var(--font-size-sm); padding: var(--spacing-md); text-align: center;">当前没有新的提醒。</div>
                    {% endif %}
                    </div>
                </div>
                
                <!-- 系统公告 - 优化样式 -->
                <div class="info-card info-card-slide-up">
                    <div class="info-card-header">
                        <h5 class="info-card-title">📢 系统公告</h5>
                        <div class="info-card-actions">
                            <a href="{% url 'admin_pages:announcement_management' %}" class="muted" style="font-size: var(--font-size-sm); text-decoration: none;">更多 →</a>
                    </div>
                    </div>
                    <div class="info-card-body">
                        {% if announcements %}
                        <div class="info-list">
                        {% for announce in announcements %}
                            <div class="info-item announcement-item" style="padding: var(--spacing-md); border-radius: var(--radius-md); transition: all var(--transition-base); {% if announce.id %}cursor: pointer;{% endif %}" {% if announce.id %}onclick="window.open('{% url 'admin_pages:announcement_detail' announce.id %}', '_blank')"{% endif %}>
                                <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
                                    <div style="font-weight: 600; font-size: var(--font-size-base); color: var(--vh-text); flex: 1;">{{ announce.title }}</div>
                                    {% if announce.is_top %}
                                    <span class="badge" style="background: var(--vh-error); color: #fff; font-size: var(--font-size-xs); padding: 2px 6px; border-radius: var(--radius-sm); flex-shrink: 0;">置顶</span>
                                    {% endif %}
                                </div>
                                <div class="muted" style="font-size: var(--font-size-sm); line-height: 1.5;">
                                    {% if announce.content %}
                                        {{ announce.content|truncatewords:20 }}
                                    {% else %}
                                        {{ announce.title }}
                                    {% endif %}
                                    {% if announce.publish_date %}
                                     · {{ announce.publish_date|date:"Y-m-d" }}
                                    {% elif announce.date %}
                                     · {{ announce.date }}
                                    {% endif %}
                                </div>
                        </div>
                        {% endfor %}
                        </div>
                        {% else %}
                        <div class="muted" style="font-size: var(--font-size-sm); padding: var(--spacing-md); text-align: center;">暂无系统公告</div>
                        {% endif %}
                    </div>
                </div>
            </section>
        </main>

        <footer class="status-bar">
            <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                <span>在线用户：<strong style="color: var(--vh-success);">18</strong></span>
                <span>·</span>
                <span>系统运行时间：<strong style="color: var(--vh-primary);">168</strong> 小时</span>
                <span>·</span>
                <span>数据同步：<strong style="color: var(--vh-info);">5</strong> 分钟前</span>
            </div>
            <div style="display: flex; gap: var(--spacing-md);">
                <a href="#" id="backToTopLink" onclick="scrollToTop(); return false;">回到顶部</a>
                <a href="#" onclick="location.reload();return false;">刷新页面</a>
                <a href="#">反馈建议</a>
                <a href="{% url 'admin_pages:announcement_management' %}">系统公告</a>
        </div>
        </footer>
        
        <!-- 回到顶部按钮 -->
        <div class="back-to-top" id="backToTop" onclick="scrollToTop()">
            ↑
        </div>
    </div>
</div>

{% csrf_token %}

<script>
    // 用户菜单切换（如果元素存在）
    const userToggle = document.getElementById('userMenuToggle');
    const userMenu = document.getElementById('userMenu');
    if (userToggle && userMenu) {
        document.addEventListener('click', function (e) {
            if (userToggle.contains(e.target)) {
                userMenu.classList.toggle('active');
            } else if (!userMenu.contains(e.target)) {
                userMenu.classList.remove('active');
            }
        });
    }

    // 获取CSRF token的函数
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function getCsrfToken() {
        // 首先尝试从隐藏input获取
        const input = document.querySelector('[name=csrfmiddlewaretoken]');
        if (input && input.value) {
            return input.value;
        }
        // 然后尝试从cookie获取
        return getCookie('csrftoken') || '';
    }
    
    const csrftoken = getCsrfToken();

    function postJson(url, payload = {}) {
        const token = getCsrfToken();
        return fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': token,
                'Accept': 'application/json',
            },
            body: Object.keys(payload).length ? JSON.stringify(payload) : null,
            credentials: 'same-origin', // 确保发送cookies和session
        }).then(response => {
            if (!response.ok) {
                // 尝试获取错误详情
                return response.json().then(err => {
                    throw new Error(err.detail || err.message || `请求失败: ${response.status}`);
                }).catch(() => {
                    throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                });
            }
            return response.json();
        });
    }

    // 标记通知已读
    document.querySelectorAll('.notify-mark-read').forEach(button => {
        button.addEventListener('click', function (e) {
            e.stopPropagation();
            const endpoint = this.dataset.endpoint;
            const container = this.closest('.notify-item');
            const originalText = this.textContent;
            
            // 添加加载状态
            this.disabled = true;
            this.textContent = '处理中...';
            this.style.opacity = '0.6';
            
            postJson(endpoint)
                .then(() => {
                    // 添加淡出动画
                    if (container) {
                        container.style.transition = 'all 0.3s ease';
                        container.style.opacity = '0';
                        container.style.transform = 'translateX(-20px)';
                        setTimeout(() => {
                            container.classList.remove('notify-item--unread');
                            container.style.opacity = '1';
                            container.style.transform = 'translateX(0)';
                    this.remove();
                        }, 300);
                    } else {
                        this.remove();
                    }
                })
                .catch(err => {
                    console.error('标记已读失败:', err);
                    this.disabled = false;
                    this.textContent = originalText;
                    this.style.opacity = '1';
                    alert('操作失败，请稍后重试');
                });
        });
    });

    // 通知筛选功能
    const notificationFilter = document.getElementById('notificationFilter');
    const notificationSearch = document.getElementById('notificationSearch');
    
    function filterNotifications() {
        const filterValue = notificationFilter ? notificationFilter.value : 'all';
        const searchValue = notificationSearch ? notificationSearch.value.toLowerCase() : '';
        
        document.querySelectorAll('.notify-block').forEach(block => {
            const blockType = block.dataset.notificationType || 'all';
            let shouldShow = true;
            
            // 类型筛选
            if (filterValue !== 'all' && blockType !== filterValue) {
                shouldShow = false;
            }
            
            // 搜索筛选
            if (shouldShow && searchValue) {
                const items = block.querySelectorAll('.notify-item');
                let hasMatch = false;
                items.forEach(item => {
                    const title = item.dataset.notificationTitle || '';
                    const detail = item.dataset.notificationDetail || '';
                    if (title.includes(searchValue) || detail.includes(searchValue)) {
                        item.style.display = '';
                        hasMatch = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
                shouldShow = hasMatch;
            } else if (shouldShow && searchValue) {
                // 如果有搜索但block不匹配，隐藏block内的所有item
                block.querySelectorAll('.notify-item').forEach(item => {
                    const title = item.dataset.notificationTitle || '';
                    const detail = item.dataset.notificationDetail || '';
                    if (!title.includes(searchValue) && !detail.includes(searchValue)) {
                        item.style.display = 'none';
                    }
                });
            } else if (!searchValue) {
                // 没有搜索时，显示所有item
                block.querySelectorAll('.notify-item').forEach(item => {
                    item.style.display = '';
                });
            }
            
            block.style.display = shouldShow ? '' : 'none';
        });
    }
    
    if (notificationFilter) {
        notificationFilter.addEventListener('change', filterNotifications);
    }
    if (notificationSearch) {
        notificationSearch.addEventListener('input', filterNotifications);
    }
    
    // 删除通知功能
    function deleteNotification(notificationId) {
        if (!confirm('确定要删除这条通知吗？')) {
            return;
        }
        
        const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
        if (item) {
            // 添加删除动画
            item.style.transition = 'all 0.3s ease';
            item.style.opacity = '0';
            item.style.transform = 'translateX(20px)';
            setTimeout(() => {
                item.remove();
                // 检查是否还有通知
                const remainingItems = document.querySelectorAll('.notify-item');
                if (remainingItems.length === 0) {
                    const body = document.querySelector('.info-card-body');
                    if (body) {
                        body.innerHTML = '<div class="muted" style="font-size: var(--font-size-sm); padding: var(--spacing-md); text-align: center;">当前没有新的提醒。</div>';
                    }
                }
            }, 300);
        }
    }
    
    // 全部标记已读
    document.querySelectorAll('.notify-mark-all').forEach(button => {
        button.addEventListener('click', function (e) {
            e.stopPropagation();
            const endpoint = this.dataset.endpoint;
            const block = this.closest('.notify-block');
            const originalText = this.textContent;
            
            // 添加加载状态
            this.disabled = true;
            this.textContent = '处理中...';
            this.style.opacity = '0.6';
            
            postJson(endpoint)
                .then(() => {
                    // 批量移除未读状态
                    const unreadItems = block?.querySelectorAll('.notify-item--unread');
                    if (unreadItems && unreadItems.length > 0) {
                        unreadItems.forEach((item, index) => {
                            setTimeout(() => {
                                item.style.transition = 'all 0.3s ease';
                                item.style.opacity = '0';
                                item.style.transform = 'translateX(-20px)';
                                setTimeout(() => {
                        item.classList.remove('notify-item--unread');
                                    item.style.opacity = '1';
                                    item.style.transform = 'translateX(0)';
                        item.querySelector('.notify-mark-read')?.remove();
                                }, 300);
                            }, index * 50);
                    });
                    }
                    setTimeout(() => {
                    this.remove();
                    }, unreadItems ? unreadItems.length * 50 + 300 : 300);
                })
                .catch(err => {
                    console.error('批量标记已读失败:', err);
                    this.disabled = false;
                    this.textContent = originalText;
                    this.style.opacity = '1';
                    alert('操作失败，请稍后重试');
                });
        });
    });

    // 左侧菜单：根据当前路径为同一模块下的子路由添加前缀高亮
    (function prefixActivateSidenav() {
        try {
            const currentPath = location.pathname;
            document.querySelectorAll('.sidenav-link').forEach(link => {
                try {
                    const linkUrl = new URL(link.href, location.origin);
                    const linkPath = linkUrl.pathname;
                    if (currentPath === linkPath || currentPath.startsWith(linkPath + '/')) {
                        link.setAttribute('data-active', 'true');
                    }
                } catch (_) {}
            });
        } catch (_) {}
    })();
    
    // ==================== 快捷键导航功能 ====================
    let quickNavModal = null;
    let selectedIndex = -1; // 键盘导航选中索引，在全局作用域定义以便多个函数共享
    
    function showQuickNav() {
        // 创建快速导航模态框
        if (quickNavModal) {
            quickNavModal.style.display = 'flex';
            document.getElementById('quickNavSearch')?.focus();
            return;
        }
        
        const modal = document.createElement('div');
        modal.id = 'quickNavModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: flex-start; justify-content: center; padding-top: 100px;';
        modal.onclick = function(e) {
            if (e.target === modal) {
                hideQuickNav();
            }
        };
        
        const content = document.createElement('div');
        content.style.cssText = 'background: #fff; border-radius: var(--radius-lg); box-shadow: var(--shadow-xl); width: 600px; max-width: 90vw; max-height: 70vh; overflow: hidden; display: flex; flex-direction: column;';
        
        const header = document.createElement('div');
        header.style.cssText = 'padding: var(--spacing-md); border-bottom: 2px solid var(--vh-primary); display: flex; align-items: center; gap: var(--spacing-sm);';
        header.innerHTML = `
            <span style="font-size: 1.2rem;">🔍</span>
            <input type="text" id="quickNavSearch" placeholder="搜索功能模块..." style="flex: 1; padding: var(--spacing-sm); border: 1px solid var(--vh-border); border-radius: var(--radius-md); font-size: var(--font-size-base);" autofocus>
            <button onclick="hideQuickNav()" style="padding: var(--spacing-xs); background: transparent; border: none; cursor: pointer; font-size: 1.2rem;">✕</button>
        `;
        
        const body = document.createElement('div');
        body.id = 'quickNavResults';
        body.style.cssText = 'padding: var(--spacing-md); max-height: 400px; overflow-y: auto;';
        body.innerHTML = '<div class="muted" style="text-align: center; padding: var(--spacing-lg);">输入关键词搜索功能模块</div>';
        
        content.appendChild(header);
        content.appendChild(body);
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        quickNavModal = modal;
        
        // 搜索功能和键盘导航
        const searchInput = document.getElementById('quickNavSearch');
        
        if (searchInput) {
            // 防抖函数，优化搜索性能
            let searchTimeout = null;
            
            // 搜索输入事件（添加防抖）
            searchInput.addEventListener('input', function() {
                const keyword = this.value.trim();
                
                // 清除之前的定时器
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // 设置新的定时器，300ms后执行搜索
                searchTimeout = setTimeout(() => {
                    const keyword = this.value.toLowerCase().trim();
                    const results = [];
                
                // 搜索功能模块菜单项
                const menuItems = document.querySelectorAll('.sidenav-link');
                menuItems.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const url = item.href;
                    if (text.includes(keyword) && url && url !== '#' && !url.includes('javascript:')) {
                        const icon = item.querySelector('span')?.textContent || '📌';
                        results.push({
                            text: item.textContent.trim(),
                            url: url,
                            icon: icon,
                            type: '功能模块'
                        });
                    }
                });
                
                // 显示结果
                if (keyword && results.length > 0) {
                    // 按类型分组显示
                    const grouped = {};
                    results.forEach(item => {
                        if (!grouped[item.type]) {
                            grouped[item.type] = [];
                        }
                        grouped[item.type].push(item);
                    });
                    
                    let html = '';
                    Object.keys(grouped).forEach(type => {
                        html += `<div style="margin-bottom: var(--spacing-md);"><div style="font-size: var(--font-size-xs); color: var(--vh-text-muted); margin-bottom: var(--spacing-xs); padding-left: var(--spacing-sm);">${type}</div>`;
                        html += grouped[type].map((item, index) => `
                            <div class="quick-nav-item" style="padding: var(--spacing-sm); border-radius: var(--radius-md); cursor: pointer; transition: background var(--transition-base);" 
                                 onclick="location.href='${item.url}'; hideQuickNav();"
                                 onmouseover="this.style.background='var(--vh-surface)'"
                                 onmouseout="this.style.background=''">
                                <span>${item.text}</span>
                            </div>
                        `).join('');
                        html += '</div>';
                    });
                    body.innerHTML = html;
                    // 重置选中索引
                    selectedIndex = -1;
                } else if (keyword) {
                    body.innerHTML = '<div class="muted" style="text-align: center; padding: var(--spacing-lg);">未找到匹配的功能模块</div>';
                    selectedIndex = -1;
                } else {
                    body.innerHTML = '<div class="muted" style="text-align: center; padding: var(--spacing-lg);">输入关键词搜索功能模块</div>';
                    selectedIndex = -1;
                }
                }, 300); // 防抖延迟300ms
            });
            
            // 键盘导航事件
            searchInput.addEventListener('keydown', function(e) {
                const items = body.querySelectorAll('.quick-nav-item');
                
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const itemToClick = selectedIndex >= 0 ? items[selectedIndex] : items[0];
                    if (itemToClick) {
                        itemToClick.click();
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    items.forEach((item, idx) => {
                        item.style.background = idx === selectedIndex ? 'var(--vh-surface)' : '';
                    });
                    // 滚动到选中项
                    if (items[selectedIndex]) {
                        items[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    items.forEach((item, idx) => {
                        item.style.background = idx === selectedIndex ? 'var(--vh-surface)' : '';
                    });
                    // 滚动到选中项
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        items[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }
                } else if (e.key === 'Escape') {
                    hideQuickNav();
                }
            });
        }
    }
    
    function hideQuickNav() {
        if (quickNavModal) {
            quickNavModal.style.display = 'none';
            // 重置搜索输入和选中索引
            const searchInput = document.getElementById('quickNavSearch');
            if (searchInput) {
                searchInput.value = '';
            }
            selectedIndex = -1;
        }
    }
    
    // 快捷键绑定：Ctrl/Cmd + K
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            showQuickNav();
        }
        if (e.key === 'Escape' && quickNavModal && quickNavModal.style.display === 'flex') {
            hideQuickNav();
        }
    });
    
    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 加载卡片设置（包括大小和隐藏状态）
        loadCardSettings();
        
        // 初始化刷新时间显示
        updateRefreshTime();
        
        // 回到顶部按钮显示/隐藏
        const backToTop = document.getElementById('backToTop');
        const backToTopLink = document.getElementById('backToTopLink');
        
        function toggleBackToTop() {
            if (window.pageYOffset > 300) {
                backToTop?.classList.add('show');
            } else {
                backToTop?.classList.remove('show');
            }
        }
        
        window.addEventListener('scroll', toggleBackToTop);
        toggleBackToTop(); // 初始检查
        
        // 添加快捷键提示（放在顶部栏右侧）
        const topBarActions = document.querySelector('.top-bar-actions');
        if (topBarActions) {
            const hint = document.createElement('div');
            hint.style.cssText = 'font-size: var(--font-size-xs); color: var(--vh-text-muted); opacity: 0.7; margin-right: var(--spacing-sm); white-space: nowrap;';
            hint.innerHTML = '💡 按 <kbd style="padding: 2px 6px; background: var(--vh-surface); border-radius: 3px; border: 1px solid var(--vh-border);">Ctrl+K</kbd> 快速搜索';
            topBarActions.insertBefore(hint, topBarActions.firstChild);
        }
    });
    
    // 回到顶部函数
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
    
    // 数据卡片点击统计（可选）
    document.querySelectorAll('.info-item[onclick]').forEach(item => {
        item.addEventListener('click', function() {
            // 可以在这里添加点击统计逻辑
            // 数据卡片点击事件已处理
        });
    });
    
    // 任务卡片点击优化
    document.querySelectorAll('.task-card-hover').forEach(card => {
        card.addEventListener('click', function(e) {
            const link = this.querySelector('a');
            if (link && !e.target.closest('button')) {
                // 添加点击反馈
                this.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
            }
        });
    });
    
    // 键盘快捷键支持
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + K: 聚焦搜索框（如果有）
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            const searchBox = document.querySelector('.search-box input');
            if (searchBox) {
                searchBox.focus();
            }
        }
        
        // Esc: 关闭所有下拉菜单
        if (e.key === 'Escape') {
            document.querySelectorAll('.user-menu.active, .menu-dropdown.active').forEach(menu => {
                menu.classList.remove('active');
            });
        }
        
        // Ctrl/Cmd + /: 显示快捷键帮助（可选）
        if ((e.ctrlKey || e.metaKey) && e.key === '/') {
            e.preventDefault();
            // 可以在这里添加快捷键帮助提示
            // 快捷键帮助：Ctrl+K: 搜索, Esc: 关闭菜单, ↑: 回到顶部
        }
    });
    
    // 数据卡片加载动画
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const cardObserver = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.animationPlayState = 'running';
                cardObserver.unobserve(entry.target);
            }
        });
    }, observerOptions);
    
    // 观察所有卡片
    document.querySelectorAll('.info-card-slide-up').forEach(card => {
        card.style.animationPlayState = 'paused';
        cardObserver.observe(card);
    });
    
    // 页面加载完成后的优化
    window.addEventListener('load', function() {
        // 添加页面加载完成的类
        document.body.classList.add('page-loaded');
        
        // 预加载关键资源（如果有）
        const criticalLinks = document.querySelectorAll('.info-item[onclick]');
        criticalLinks.forEach(link => {
            link.addEventListener('mouseenter', function() {
                const href = this.href || this.getAttribute('onclick')?.match(/location\.href='([^']+)'/)?.[1];
                if (href && href !== '#' && !href.startsWith('javascript:')) {
                    // 预加载链接（可选）
                    const linkElement = document.createElement('link');
                    linkElement.rel = 'prefetch';
                    linkElement.href = href;
                    document.head.appendChild(linkElement);
                }
            }, { once: true });
        });
    });
    
    // 数据刷新功能
    let lastRefreshTime = new Date();
    const refreshInterval = 5 * 60 * 1000; // 5分钟
    
    function updateRefreshTime() {
        const now = new Date();
        const diff = Math.floor((now - lastRefreshTime) / 1000);
        const refreshTimeEl = document.getElementById('lastRefreshTime');
        if (refreshTimeEl) {
            if (diff < 60) {
                refreshTimeEl.textContent = '刚刚更新';
            } else if (diff < 3600) {
                refreshTimeEl.textContent = `${Math.floor(diff / 60)} 分钟前更新`;
            } else {
                refreshTimeEl.textContent = `${Math.floor(diff / 3600)} 小时前更新`;
            }
        }
    }
    
    function refreshData() {
        const refreshBtn = document.getElementById('refreshDataBtn');
        if (refreshBtn) {
            refreshBtn.classList.add('refreshing');
            refreshBtn.disabled = true;
        }
        
        // 更新刷新时间
        lastRefreshTime = new Date();
        updateRefreshTime();
        
        // 刷新页面数据（重新加载页面）
        setTimeout(() => {
            location.reload();
        }, 300);
    }
    
    // 刷新按钮点击事件
    const refreshBtn = document.getElementById('refreshDataBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', refreshData);
    }
    
    // 自动刷新（可选，默认关闭）
    let autoRefreshTimer = null;
    function startAutoRefresh(interval = refreshInterval) {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
        }
        autoRefreshTimer = setInterval(refreshData, interval);
    }
    
    // 停止自动刷新
    function stopAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
        }
    }
    
    // 定期更新刷新时间显示
    setInterval(updateRefreshTime, 60000); // 每分钟更新一次
    
    // 卡片设置功能
    document.querySelectorAll('.card-settings-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const cardId = this.dataset.cardId;
            const card = document.querySelector(`[data-card-id="${cardId}"]`);
            
            // 创建设置菜单
            const menu = document.createElement('div');
            menu.className = 'card-settings-menu';
            const currentSize = card.dataset.cardSize || 'medium';
            menu.innerHTML = `
                <div class="card-settings-menu-item" data-action="hide">
                    <span>👁️</span>
                    <span>隐藏卡片</span>
                </div>
                <div class="card-settings-menu-item" data-action="refresh">
                    <span>🔄</span>
                    <span>刷新数据</span>
                </div>
                <div class="card-settings-menu-divider"></div>
                <div class="card-settings-menu-item" data-action="size-small" ${currentSize === 'small' ? 'style="background: var(--vh-surface);"' : ''}>
                    <span>📏</span>
                    <span>小尺寸</span>
                    ${currentSize === 'small' ? '<span style="margin-left: auto;">✓</span>' : ''}
                </div>
                <div class="card-settings-menu-item" data-action="size-medium" ${currentSize === 'medium' ? 'style="background: var(--vh-surface);"' : ''}>
                    <span>📐</span>
                    <span>中尺寸</span>
                    ${currentSize === 'medium' ? '<span style="margin-left: auto;">✓</span>' : ''}
                </div>
                <div class="card-settings-menu-item" data-action="size-large" ${currentSize === 'large' ? 'style="background: var(--vh-surface);"' : ''}>
                    <span>📊</span>
                    <span>大尺寸</span>
                    ${currentSize === 'large' ? '<span style="margin-left: auto;">✓</span>' : ''}
                </div>
            `;
            
            // 定位菜单
            const rect = this.getBoundingClientRect();
            menu.style.position = 'fixed';
            menu.style.top = (rect.bottom + 5) + 'px';
            menu.style.right = (window.innerWidth - rect.right) + 'px';
            
            document.body.appendChild(menu);
            menu.classList.add('show');
            
            // 菜单项点击事件
            menu.querySelectorAll('.card-settings-menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const action = this.dataset.action;
                    if (action === 'hide') {
                        card.setAttribute('data-hidden', 'true');
                        saveCardSettings();
                    } else if (action === 'refresh') {
                        refreshData();
                    } else if (action && action.startsWith('size-')) {
                        // 卡片大小调整
                        const size = action.replace('size-', '');
                        card.dataset.cardSize = size;
                        card.className = card.className.replace(/\bcard-size-\w+\b/g, '');
                        card.classList.add(`card-size-${size}`);
                        saveCardSettings();
                    }
                    menu.remove();
                });
            });
            
            // 点击外部关闭菜单
            function closeMenu(e) {
                if (!menu.contains(e.target) && !btn.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            }
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 0);
        });
    });
    
    // 保存卡片设置到localStorage
    function saveCardSettings() {
        const cards = document.querySelectorAll('[data-card-id]');
        const settings = {};
        cards.forEach(card => {
            const cardId = card.dataset.cardId;
            settings[cardId] = {
                hidden: card.getAttribute('data-hidden') === 'true',
                size: card.dataset.cardSize || 'medium'
            };
        });
        localStorage.setItem('dashboardCardSettings', JSON.stringify(settings));
    }
    
    // 加载卡片设置
    function loadCardSettings() {
        const settings = localStorage.getItem('dashboardCardSettings');
        if (settings) {
            try {
                const parsed = JSON.parse(settings);
                Object.keys(parsed).forEach(cardId => {
                    const card = document.querySelector(`[data-card-id="${cardId}"]`);
                    if (card) {
                        if (parsed[cardId].hidden) {
                            card.setAttribute('data-hidden', 'true');
                        }
                        if (parsed[cardId].size) {
                            const size = parsed[cardId].size;
                            card.dataset.cardSize = size;
                            card.className = card.className.replace(/\bcard-size-\w+\b/g, '');
                            card.classList.add(`card-size-${size}`);
                        }
                    }
                });
            } catch (e) {
                console.error('加载卡片设置失败:', e);
            }
        }
    }
    
    // 保存卡片顺序
    function saveCardOrder() {
        const cards = document.querySelectorAll('#workspaceMain > [data-card-id]');
        const order = Array.from(cards).map(card => card.dataset.cardId);
        localStorage.setItem('dashboardCardOrder', JSON.stringify(order));
    }
    
    // 加载卡片顺序
    function loadCardOrder() {
        const order = localStorage.getItem('dashboardCardOrder');
        if (order) {
            try {
                const parsed = JSON.parse(order);
                const workspaceMain = document.getElementById('workspaceMain');
                if (workspaceMain) {
                    const cards = Array.from(workspaceMain.querySelectorAll('[data-card-id]'));
                    const cardMap = new Map(cards.map(card => [card.dataset.cardId, card]));
                    
                    parsed.forEach(cardId => {
                        const card = cardMap.get(cardId);
                        if (card) {
                            workspaceMain.appendChild(card);
                        }
                    });
                }
            } catch (e) {
                console.error('加载卡片顺序失败:', e);
            }
        }
    }
    
    // 页面加载时恢复设置和顺序
    document.addEventListener('DOMContentLoaded', function() {
        loadCardSettings();
        loadCardOrder();
        
        // 初始化拖拽排序（如果SortableJS可用）
        if (typeof Sortable !== 'undefined') {
            const workspaceMain = document.getElementById('workspaceMain');
            if (workspaceMain) {
                new Sortable(workspaceMain, {
                    animation: 200,
                    handle: '.info-card-header',
                    ghostClass: 'dragging',
                    chosenClass: 'card-chosen',
                    dragClass: 'card-dragging',
                    filter: '[data-card-id]', // 只允许拖拽有data-card-id的卡片
                    preventOnFilter: false,
                    onStart: function(evt) {
                        evt.item.classList.add('dragging');
                    },
                    onEnd: function(evt) {
                        evt.item.classList.remove('dragging');
                        // 保存卡片顺序
                        saveCardOrder();
                    }
                });
            }
        }
        
        // 初始化产值趋势图
        const trendChartCanvas = document.getElementById('outputValueTrendChart');
        if (trendChartCanvas && typeof Chart !== 'undefined') {
            try {
                const trendLabels = {{ output_value_stats.trend_labels|safe|default:"[]" }};
                const trendData = {{ output_value_stats.trend_data|safe|default:"[]" }};
                
                if (trendLabels && Array.isArray(trendLabels) && trendLabels.length > 0 && 
                    trendData && Array.isArray(trendData) && trendData.length > 0 && 
                    trendLabels.length === trendData.length) {
                    new Chart(trendChartCanvas, {
                        type: 'line',
                        data: {
                            labels: trendLabels,
                            datasets: [{
                                label: '产值（元）',
                                data: trendData,
                                borderColor: 'rgb(26, 115, 232)',
                                backgroundColor: 'rgba(26, 115, 232, 0.1)',
                                tension: 0.4,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return '产值: ¥' + context.parsed.y.toLocaleString();
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '¥' + (value / 1000).toFixed(0) + 'k';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('初始化产值趋势图失败:', e);
            }
        }
        
        // 初始化项目状态分布图
        const projectStatusChartCanvas = document.getElementById('projectStatusChart');
        if (projectStatusChartCanvas && typeof Chart !== 'undefined') {
            try {
                const projectLabels = {{ project_status_distribution.labels|safe|default:"[]" }};
                const projectData = {{ project_status_distribution.data|safe|default:"[]" }};
                const projectColors = {{ project_status_distribution.colors|safe|default:"[]" }};
                
                if (projectLabels && Array.isArray(projectLabels) && projectLabels.length > 0 && 
                    projectData && Array.isArray(projectData) && projectData.length > 0 &&
                    projectColors && Array.isArray(projectColors) && projectColors.length > 0 &&
                    projectLabels.length === projectData.length && projectLabels.length === projectColors.length) {
                    new Chart(projectStatusChartCanvas, {
                        type: 'doughnut',
                        data: {
                            labels: projectLabels,
                            datasets: [{
                                data: projectData,
                                backgroundColor: projectColors,
                                borderWidth: 2,
                                borderColor: '#fff',
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 10,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return label + ': ' + value + '个 (' + percentage + '%)';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('初始化项目状态分布图失败:', e);
            }
        }
        
        // 初始化任务状态分布图
        const taskStatusChartCanvas = document.getElementById('taskStatusChart');
        if (taskStatusChartCanvas && typeof Chart !== 'undefined') {
            try {
                const taskLabels = {{ task_status_distribution.labels|safe|default:"[]" }};
                const taskData = {{ task_status_distribution.data|safe|default:"[]" }};
                const taskColors = {{ task_status_distribution.colors|safe|default:"[]" }};
                
                if (taskLabels && Array.isArray(taskLabels) && taskLabels.length > 0 && 
                    taskData && Array.isArray(taskData) && taskData.length > 0 &&
                    taskColors && Array.isArray(taskColors) && taskColors.length > 0 &&
                    taskLabels.length === taskData.length && taskLabels.length === taskColors.length) {
                    new Chart(taskStatusChartCanvas, {
                        type: 'doughnut',
                        data: {
                            labels: taskLabels,
                            datasets: [{
                                data: taskData,
                                backgroundColor: taskColors,
                                borderWidth: 2,
                                borderColor: '#fff',
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 10,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return label + ': ' + value + '个 (' + percentage + '%)';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('初始化任务状态分布图失败:', e);
            }
        }
        
        // 初始化收入趋势图
        const revenueTrendChartCanvas = document.getElementById('revenueTrendChart');
        if (revenueTrendChartCanvas && typeof Chart !== 'undefined') {
            try {
                const revenueLabels = {{ company_stats.revenue_trend_labels|safe|default:"[]" }};
                const revenueData = {{ company_stats.revenue_trend_data|safe|default:"[]" }};
                
                if (revenueLabels && Array.isArray(revenueLabels) && revenueLabels.length > 0 && 
                    revenueData && Array.isArray(revenueData) && revenueData.length > 0 && 
                    revenueLabels.length === revenueData.length) {
                    new Chart(revenueTrendChartCanvas, {
                        type: 'line',
                        data: {
                            labels: revenueLabels,
                            datasets: [{
                                label: '收入（元）',
                                data: revenueData,
                                borderColor: 'rgb(34, 163, 83)',
                                backgroundColor: 'rgba(34, 163, 83, 0.1)',
                                tension: 0.4,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return '收入: ¥' + context.parsed.y.toLocaleString();
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '¥' + (value / 1000).toFixed(0) + 'k';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('初始化收入趋势图失败:', e);
            }
        }
        
        // 初始化成本趋势图
        const costTrendChartCanvas = document.getElementById('costTrendChart');
        if (costTrendChartCanvas && typeof Chart !== 'undefined') {
            try {
                const costLabels = {{ company_stats.revenue_trend_labels|safe|default:"[]" }};
                const costData = {{ company_stats.cost_trend_data|safe|default:"[]" }};
                
                if (costLabels && Array.isArray(costLabels) && costLabels.length > 0 && 
                    costData && Array.isArray(costData) && costData.length > 0 && 
                    costLabels.length === costData.length) {
                    new Chart(costTrendChartCanvas, {
                        type: 'line',
                        data: {
                            labels: costLabels,
                            datasets: [{
                                label: '成本（元）',
                                data: costData,
                                borderColor: 'rgb(217, 119, 6)',
                                backgroundColor: 'rgba(217, 119, 6, 0.1)',
                                tension: 0.4,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return '成本: ¥' + context.parsed.y.toLocaleString();
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '¥' + (value / 1000).toFixed(0) + 'k';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('初始化成本趋势图失败:', e);
            }
        }
        
        // 初始化利润趋势图
        const profitTrendChartCanvas = document.getElementById('profitTrendChart');
        if (profitTrendChartCanvas && typeof Chart !== 'undefined') {
            try {
                const profitLabels = {{ company_stats.revenue_trend_labels|safe|default:"[]" }};
                const profitData = {{ company_stats.profit_trend_data|safe|default:"[]" }};
                
                if (profitLabels && Array.isArray(profitLabels) && profitLabels.length > 0 && 
                    profitData && Array.isArray(profitData) && profitData.length > 0 && 
                    profitLabels.length === profitData.length) {
                    new Chart(profitTrendChartCanvas, {
                        type: 'line',
                        data: {
                            labels: profitLabels,
                            datasets: [{
                                label: '利润（元）',
                                data: profitData,
                                borderColor: 'rgb(16, 163, 74)',
                                backgroundColor: 'rgba(16, 163, 74, 0.1)',
                                tension: 0.4,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return '利润: ¥' + context.parsed.y.toLocaleString();
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            return '¥' + (value / 1000).toFixed(0) + 'k';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('初始化利润趋势图失败:', e);
            }
        }
        
        // 初始化客户趋势图
        const customerTrendChartCanvas = document.getElementById('customerTrendChart');
        if (customerTrendChartCanvas && typeof Chart !== 'undefined') {
            try {
                const customerLabels = {{ company_stats.customer_analysis.trend_labels|safe|default:"[]" }};
                const customerData = {{ company_stats.customer_analysis.trend_data|safe|default:"[]" }};
                
                if (customerLabels && Array.isArray(customerLabels) && customerLabels.length > 0 && 
                    customerData && Array.isArray(customerData) && customerData.length > 0 && 
                    customerLabels.length === customerData.length) {
                    new Chart(customerTrendChartCanvas, {
                        type: 'line',
                        data: {
                            labels: customerLabels,
                            datasets: [{
                                label: '新增客户数',
                                data: customerData,
                                borderColor: 'rgb(26, 115, 232)',
                                backgroundColor: 'rgba(26, 115, 232, 0.1)',
                                tension: 0.4,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return '新增客户: ' + context.parsed.y + '个';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('初始化客户趋势图失败:', e);
            }
        }
        
        // 初始化商机趋势图
        const opportunityTrendChartCanvas = document.getElementById('opportunityTrendChart');
        if (opportunityTrendChartCanvas && typeof Chart !== 'undefined') {
            try {
                const opportunityLabels = {{ company_stats.opportunity_analysis.trend_labels|safe|default:"[]" }};
                const opportunityData = {{ company_stats.opportunity_analysis.trend_data|safe|default:"[]" }};
                
                if (opportunityLabels && Array.isArray(opportunityLabels) && opportunityLabels.length > 0 && 
                    opportunityData && Array.isArray(opportunityData) && opportunityData.length > 0 && 
                    opportunityLabels.length === opportunityData.length) {
                    new Chart(opportunityTrendChartCanvas, {
                        type: 'line',
                        data: {
                            labels: opportunityLabels,
                            datasets: [{
                                label: '新增商机数',
                                data: opportunityData,
                                borderColor: 'rgb(214, 40, 40)',
                                backgroundColor: 'rgba(214, 40, 40, 0.1)',
                                tension: 0.4,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return '新增商机: ' + context.parsed.y + '个';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('初始化商机趋势图失败:', e);
            }
        }
        
        // 初始化人员效率趋势图
        const personnelEfficiencyChartCanvas = document.getElementById('personnelEfficiencyChart');
        if (personnelEfficiencyChartCanvas && typeof Chart !== 'undefined') {
            try {
                const efficiencyLabels = {{ company_stats.personnel_analysis.efficiency_trend_labels|safe|default:"[]" }};
                const efficiencyData = {{ company_stats.personnel_analysis.efficiency_trend_data|safe|default:"[]" }};
                
                if (efficiencyLabels && Array.isArray(efficiencyLabels) && efficiencyLabels.length > 0 && 
                    efficiencyData && Array.isArray(efficiencyData) && efficiencyData.length > 0 && 
                    efficiencyLabels.length === efficiencyData.length) {
                    new Chart(personnelEfficiencyChartCanvas, {
                        type: 'line',
                        data: {
                            labels: efficiencyLabels,
                            datasets: [{
                                label: '人均产值（元）',
                                data: efficiencyData,
                                borderColor: 'rgb(214, 40, 40)',
                                backgroundColor: 'rgba(214, 40, 40, 0.1)',
                                tension: 0.4,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return '人均产值: ¥' + context.parsed.y.toLocaleString();
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '¥' + (value / 1000).toFixed(0) + 'k';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('初始化人员效率趋势图失败:', e);
            }
        }
        
        // 初始化产值分析趋势图
        const outputValueAnalysisChartCanvas = document.getElementById('outputValueAnalysisChart');
        if (outputValueAnalysisChartCanvas && typeof Chart !== 'undefined') {
            try {
                const outputLabels = {{ company_stats.output_value_analysis.trend_labels|safe|default:"[]" }};
                const outputData = {{ company_stats.output_value_analysis.trend_data|safe|default:"[]" }};
                
                if (outputLabels && Array.isArray(outputLabels) && outputLabels.length > 0 && 
                    outputData && Array.isArray(outputData) && outputData.length > 0 && 
                    outputLabels.length === outputData.length) {
                    // 区分实际数据和预测数据
                    const actualData = outputData.slice(0, -1);
                    const predictedData = outputData.slice(-1);
                    const actualLabels = outputLabels.slice(0, -1);
                    const predictedLabel = outputLabels.slice(-1)[0];
                    
                    new Chart(outputValueAnalysisChartCanvas, {
                        type: 'line',
                        data: {
                            labels: outputLabels,
                            datasets: [
                                {
                                    label: '实际产值',
                                    data: [...actualData, null],
                                    borderColor: 'rgb(26, 115, 232)',
                                    backgroundColor: 'rgba(26, 115, 232, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                },
                                {
                                    label: '预测产值',
                                    data: [null, null, null, null, null, null, ...predictedData],
                                    borderColor: 'rgb(217, 119, 6)',
                                    backgroundColor: 'rgba(217, 119, 6, 0.1)',
                                    borderDash: [5, 5],
                                    tension: 0.4,
                                    fill: false,
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            if (context.datasetIndex === 1 && context.parsed.y !== null) {
                                                return '预测产值: ¥' + context.parsed.y.toLocaleString();
                                            } else if (context.parsed.y !== null) {
                                                return '产值: ¥' + context.parsed.y.toLocaleString();
                                            }
                                            return '';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '¥' + (value / 1000).toFixed(0) + 'k';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('初始化产值分析趋势图失败:', e);
            }
        }
        
        // 初始化计划趋势图
        const planTrendChartCanvas = document.getElementById('planTrendChart');
        if (planTrendChartCanvas && typeof Chart !== 'undefined') {
            try {
                const planLabels = {{ company_stats.plan_analysis.trend_labels|safe|default:"[]" }};
                const planData = {{ company_stats.plan_analysis.trend_data|safe|default:"[]" }};
                
                if (planLabels && Array.isArray(planLabels) && planLabels.length > 0 && 
                    planData && Array.isArray(planData) && planData.length > 0 && 
                    planLabels.length === planData.length) {
                    new Chart(planTrendChartCanvas, {
                        type: 'line',
                        data: {
                            labels: planLabels,
                            datasets: [{
                                label: '完成计划数',
                                data: planData,
                                borderColor: 'rgb(16, 163, 74)',
                                backgroundColor: 'rgba(16, 163, 74, 0.1)',
                                tension: 0.4,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return '完成计划: ' + context.parsed.y + '个';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('初始化计划趋势图失败:', e);
            }
        }
    });
    
    // 确保功能模块导航栏固定定位生效
    document.addEventListener('DOMContentLoaded', function() {
        const welcomeCard = document.querySelector('.welcome-card');
        const topModulesNav = document.querySelector('.top-modules-nav');
        
        function updateNavPosition() {
            if (welcomeCard && topModulesNav) {
                // 动态计算欢迎卡片的高度（包括margin）
                const welcomeCardRect = welcomeCard.getBoundingClientRect();
                const welcomeCardHeight = welcomeCardRect.height;
                const welcomeCardMarginBottom = parseInt(window.getComputedStyle(welcomeCard).marginBottom) || 0;
                const totalHeight = welcomeCardHeight + welcomeCardMarginBottom;
                
                // 设置导航栏的top值，使其紧贴在欢迎卡片下方
                topModulesNav.style.top = totalHeight + 'px';
                topModulesNav.style.position = 'sticky';
                topModulesNav.style.zIndex = '99';
            }
        }
        
        // 初始设置
        updateNavPosition();
        
        // 监听窗口大小变化
        window.addEventListener('resize', updateNavPosition, { passive: true });
        
        // 监听滚动事件，确保sticky生效
        window.addEventListener('scroll', function() {
            updateNavPosition();
        }, { passive: true });
    });
</script>

    <!-- Django服务控制模态框 -->
    {% if is_superuser %}
    <div id="service-control-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Django服务控制</h3>
                <button id="close-service-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div id="service-status" style="margin-bottom: 20px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span id="status-indicator" style="width: 12px; height: 12px; border-radius: 50%; background: #999;"></span>
                    <span id="status-text">检查中...</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="btn-check-status" style="flex: 1; padding: 10px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">检查状态</button>
                <button id="btn-restart-service" style="flex: 1; padding: 10px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">重启服务</button>
                <button id="btn-stop-service" style="flex: 1; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">停止服务</button>
                <button id="btn-start-service" style="flex: 1; padding: 10px; background: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">启动服务</button>
            </div>
            <div id="service-message" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
        </div>
    </div>

    <script>
    (function() {
        const modal = document.getElementById('service-control-modal');
        const btn = document.getElementById('django-service-control-btn');
        const closeBtn = document.getElementById('close-service-modal');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const messageDiv = document.getElementById('service-message');
        
        const btnCheckStatus = document.getElementById('btn-check-status');
        const btnRestart = document.getElementById('btn-restart-service');
        const btnStop = document.getElementById('btn-stop-service');
        const btnStart = document.getElementById('btn-start-service');
        
        if (!modal || !btn) return; // 如果不是超级用户，直接返回
        
        // 打开模态框
        btn.addEventListener('click', function() {
            modal.style.display = 'flex';
            checkServiceStatus();
        });
        
        // 关闭模态框
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        // 点击背景关闭
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // 检查服务状态
        function checkServiceStatus() {
            statusText.textContent = '检查中...';
            statusIndicator.style.background = '#999';
            
            fetch('/api/service/control/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: 'action=status'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.status === 'running') {
                        statusIndicator.style.background = '#28a745';
                        statusText.textContent = '服务运行中 (PID: ' + (data.pids.join(', ') || 'N/A') + ')';
                    } else {
                        statusIndicator.style.background = '#dc3545';
                        statusText.textContent = '服务已停止';
                    }
                } else {
                    statusIndicator.style.background = '#ffc107';
                    statusText.textContent = '检查失败: ' + (data.error || '未知错误');
                }
            })
            .catch(error => {
                statusIndicator.style.background = '#dc3545';
                statusText.textContent = '检查失败: ' + error.message;
            });
        }
        
        // 执行服务操作
        function performAction(action, actionName) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '执行中...';
            hideMessage();
            
            fetch('/api/service/control/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: 'action=' + action
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.textContent = originalText;
                
                if (data.success) {
                    showMessage(data.message || actionName + '成功', 'success');
                    setTimeout(checkServiceStatus, 2000);
                } else {
                    showMessage(data.error || actionName + '失败', 'error');
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.textContent = originalText;
                showMessage(actionName + '失败: ' + error.message, 'error');
            });
        }
        
        // 绑定按钮事件
        btnCheckStatus.addEventListener('click', checkServiceStatus);
        btnRestart.addEventListener('click', () => {
            if (confirm('确定要重启Django服务吗？这可能会影响正在使用的用户。')) {
                performAction('restart', '重启');
            }
        });
        btnStop.addEventListener('click', () => {
            if (confirm('确定要停止Django服务吗？这将导致网站无法访问。')) {
                performAction('stop', '停止');
            }
        });
        btnStart.addEventListener('click', () => {
            performAction('start', '启动');
        });
        
        // 显示消息
        function showMessage(message, type) {
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            messageDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
            messageDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            messageDiv.style.border = '1px solid ' + (type === 'success' ? '#c3e6cb' : '#f5c6cb');
        }
        
        function hideMessage() {
            messageDiv.style.display = 'none';
        }
        
        // 获取Cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    })();
    </script>
    {% endif %}

</body>
</html>
