<!-- ÂèçÈ¶àË°®ÂçïÂºπÁ™ó -->
{% load static %}
{% with form_obj=feedback_form|default:None %}
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">üí¨ Êèê‰∫§ÂèçÈ¶à</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            {% if form_obj %}
            <form id="feedbackForm" method="post" enctype="multipart/form-data" 
                  action="{% url 'system_pages:feedback_submit' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{{ form_obj.feedback_type.label }} <span class="text-danger">*</span></label>
                        {{ form_obj.feedback_type }}
                        {% if form_obj.feedback_type.errors %}
                            <div class="text-danger small mt-1">{{ form_obj.feedback_type.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{{ form_obj.title.label }} <span class="text-danger">*</span></label>
                        {{ form_obj.title }}
                        {% if form_obj.title.errors %}
                            <div class="text-danger small mt-1">{{ form_obj.title.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{{ form_obj.content.label }} <span class="text-danger">*</span></label>
                        {{ form_obj.content }}
                        {% if form_obj.content.errors %}
                            <div class="text-danger small mt-1">{{ form_obj.content.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form_obj.priority.label }}</label>
                            {{ form_obj.priority }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form_obj.related_module.label }}</label>
                            {{ form_obj.related_module }}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{{ form_obj.attachment.label }}</label>
                        {{ form_obj.attachment }}
                        <small class="form-text text-muted">ÊîØÊåÅ PDF„ÄÅWord„ÄÅExcel„ÄÅÂõæÁâáÁ≠âÊ†ºÂºèÔºåÊúÄÂ§ß 10MB</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary">Êèê‰∫§ÂèçÈ¶à</button>
                </div>
            </form>
            {% else %}
            <div class="modal-body">
                <p class="text-muted">Ê≠£Âú®Âä†ËΩΩË°®Âçï...</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if form_obj %}
<script>
// AJAXÊèê‰∫§Ë°®Âçï
(function() {
    const form = document.getElementById('feedbackForm');
    if (!form) return;
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Êèê‰∫§‰∏≠...';
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'ÂèçÈ¶àÂ∑≤Êèê‰∫§ÔºåÊàë‰ª¨‰ºöÂ∞ΩÂø´Â§ÑÁêÜÔºÅ');
                const modalElement = document.getElementById('feedbackModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                }
                form.reset();
            } else {
                let errorMsg = 'Êèê‰∫§Â§±Ë¥•Ôºö';
                if (data.errors) {
                    const errors = Object.values(data.errors).flat();
                    errorMsg += errors.join(', ');
                } else {
                    errorMsg += 'Êú™Áü•ÈîôËØØ';
                }
                alert(errorMsg);
            }
        })
        .catch(error => {
            alert('Êèê‰∫§Â§±Ë¥•Ôºö' + error.message);
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
    });
})();
</script>
{% endif %}
{% endwith %}
