{% extends "shared/list_page_base.html" %}
{% comment %}
供应商列表页面模板 (Supplier List Template)

功能说明：
- 展示供应商记录的列表页面
- 支持按评级、状态等多维度筛选
- 支持供应商的查看、编辑、删除操作
- 包含复选框功能，支持批量操作

主要功能：
1. 筛选功能：
   - 评级筛选：A、B、C、D
   - 状态筛选：全部、启用、停用
2. 表格展示：编码、名称、联系人、联系电话、评级、累计采购额、状态、操作
3. 复选框功能：支持全选和批量操作（继承自list_page_base.html）
4. 操作功能：查看详情、编辑、删除
{% endcomment %}
{% load static %}

{% block list_page_title %}供应商管理{% endblock %}

{% block list_page_actions %}
{% if can_create %}
<a href="{% url 'admin_pages:supplier_create' %}" class="btn btn-primary">
    <i class="bi bi-plus-circle"></i> 创建供应商
</a>
{% endif %}
{% endblock %}

{% block search_placeholder %}搜索供应商名称、联系人、电话...{% endblock %}

{% block reset_url %}{% url 'admin_pages:supplier_list' %}{% endblock %}

<!-- 表格复选框列 -->
{% block list_page_table_checkbox_header %}
<th style="width: 40px;">
    <input type="checkbox" id="selectAll" title="全选/取消全选">
</th>
{% endblock %}

{% block list_page_table_headers %}
<th style="width: 10%;">供应商编码</th>
<th style="width: 15%;">供应商名称</th>
<th style="width: 10%;">联系人</th>
<th style="width: 12%;">联系电话</th>
<th style="width: 8%;">评级</th>
<th style="width: 12%;">累计采购额</th>
<th style="width: 8%;">状态</th>
{% endblock %}

{% block list_page_table_checkbox_cell %}
<td>
    <input type="checkbox" class="row-checkbox" value="{{ item.id }}" title="选择此项">
</td>
{% endblock %}

{% block list_page_table_row_content %}
<td><code>{{ item.code }}</code></td>
<td>{{ item.name }}</td>
<td>{{ item.contact_person|default:"-" }}</td>
<td>{{ item.contact_phone|default:"-" }}</td>
<td>
    <span class="badge {% if item.rating == 'A' %}bg-success{% elif item.rating == 'B' %}bg-primary{% elif item.rating == 'C' %}bg-warning{% else %}bg-danger{% endif %}">
        {{ item.get_rating_display }}
    </span>
</td>
<td>¥{{ item.total_purchase_amount|floatformat:2 }}</td>
<td>
    {% if item.is_active %}
        <span class="badge bg-success">启用</span>
    {% else %}
        <span class="badge bg-secondary">停用</span>
    {% endif %}
</td>
<td>
    <div class="list-page-table-actions">
        <a href="{% url 'admin_pages:supplier_detail' supplier_id=item.id %}" class="action-view" title="查看">
            <i class="bi bi-eye"></i>
        </a>
        <span class="action-separator">|</span>
        <a href="{% url 'admin_pages:supplier_update' supplier_id=item.id %}" class="action-edit" title="编辑">
            <i class="bi bi-pencil"></i>
        </a>
        <span class="action-separator">|</span>
        <a href="{% url 'admin_pages:supplier_list' %}" class="action-delete" title="删除" onclick="return confirm('确定要删除供应商 {{ item.name }} 吗？此操作不可撤销。');" data-delete-url="{% url 'admin_pages:supplier_list' %}" data-item-id="{{ item.id }}">
            <i class="bi bi-trash"></i>
        </a>
    </div>
</td>
{% endblock %}

{% block empty_colspan %}9{% endblock %}

{% block empty_table_message %}暂无数据{% endblock %}

{% block empty_message %}暂无数据{% endblock %}

{% block empty_create_url %}{% url 'admin_pages:supplier_create' %}{% endblock %}

{% block list_page_batch_delete_js %}
// 批量删除功能
document.addEventListener('DOMContentLoaded', function() {
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', function() {
            const checked = document.querySelectorAll('.row-checkbox:checked');
            if (checked.length === 0) {
                showError('请先选择要删除的数据');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${checked.length} 个供应商吗？此操作不可撤销。`)) {
                return;
            }
            
            const ids = Array.from(checked).map(cb => cb.value);
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "admin_pages:supplier_list" %}';
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken.value;
                form.appendChild(csrfInput);
            }
            
            ids.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'delete_ids';
                input.value = id;
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
        });
    }
});
{% endblock %}

{% block list_page_batch_export_js %}
// 批量导出功能
document.addEventListener('DOMContentLoaded', function() {
    const batchExportBtn = document.getElementById('batchExportBtn');
    if (batchExportBtn) {
        batchExportBtn.addEventListener('click', function() {
            const checked = document.querySelectorAll('.row-checkbox:checked');
            if (checked.length === 0) {
                showError('请先选择要导出的数据');
                return;
            }
            
            const ids = Array.from(checked).map(cb => cb.value);
            const format = this.dataset.exportFormat || 'excel';
            const url = '{% url "admin_pages:supplier_list" %}?export=1&format=' + format + '&ids=' + ids.join(',');
            window.location.href = url;
        });
    }
});
{% endblock %}

{% block list_page_batch_dropdown_items %}
<li><a class="dropdown-item" href="#" id="batchStatusActiveBtn"><i class="bi bi-check-circle"></i> 批量设为启用</a></li>
<li><a class="dropdown-item" href="#" id="batchStatusInactiveBtn"><i class="bi bi-x-circle"></i> 批量设为停用</a></li>
<li><hr class="dropdown-divider"></li>
<li><a class="dropdown-item" href="#" id="batchPrintBtn"><i class="bi bi-printer"></i> 打印选中</a></li>
{% endblock %}

{% block list_page_custom_js %}
// 批量状态更新功能
function batchUpdateStatus(isActive) {
    const checked = document.querySelectorAll('.row-checkbox:checked');
    if (checked.length === 0) {
        showError('请先选择要操作的数据');
        return;
    }
    
    const statusLabel = isActive ? '启用' : '停用';
    if (!confirm(`确定要将选中的 ${checked.length} 个供应商状态更新为"${statusLabel}"吗？`)) {
        return;
    }
    
    const ids = Array.from(checked).map(cb => cb.value);
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "admin_pages:supplier_list" %}';
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken.value;
        form.appendChild(csrfInput);
    }
    
    const statusInput = document.createElement('input');
    statusInput.type = 'hidden';
    statusInput.name = 'batch_is_active';
    statusInput.value = isActive ? 'true' : 'false';
    form.appendChild(statusInput);
    
    ids.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'update_ids';
        input.value = id;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}

// 绑定批量状态更新按钮
document.addEventListener('DOMContentLoaded', function() {
    const batchStatusActiveBtn = document.getElementById('batchStatusActiveBtn');
    const batchStatusInactiveBtn = document.getElementById('batchStatusInactiveBtn');
    
    if (batchStatusActiveBtn) {
        batchStatusActiveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            batchUpdateStatus(true);
        });
    }
    
    if (batchStatusInactiveBtn) {
        batchStatusInactiveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            batchUpdateStatus(false);
        });
    }
});
{% endblock %}