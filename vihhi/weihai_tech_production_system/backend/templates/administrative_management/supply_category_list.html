{% extends "shared/list_page_base.html" %}
{% comment %}
用品分类列表页面模板 (Supply Category List Template)

功能说明：
- 展示用品分类记录的列表页面
- 支持按状态、父分类等多维度筛选
- 支持分类的查看、编辑、删除操作
- 包含复选框功能，支持批量操作

主要功能：
1. 筛选功能：
   - 状态筛选：全部、启用、停用
   - 父分类筛选：根据父分类筛选
2. 表格展示：分类编码、分类名称、父分类、排序顺序、状态、操作
3. 复选框功能：支持全选和批量操作（继承自list_page_base.html）
4. 操作功能：查看详情、编辑、删除
{% endcomment %}
{% load static %}

{% block list_page_title %}用品分类管理{% endblock %}

{% block list_page_actions %}
{% if can_create %}
<a href="{% url 'admin_pages:supply_category_create' %}" class="btn btn-primary">
    <i class="bi bi-plus-circle"></i> 创建分类
</a>
{% endif %}
{% endblock %}

{% block search_placeholder %}搜索分类名称、编码、描述...{% endblock %}

{% block reset_url %}{% url 'admin_pages:supply_category_list' %}{% endblock %}

<!-- 表格复选框列 -->
{% block list_page_table_checkbox_header %}
<th style="width: 40px;">
    <input type="checkbox" id="selectAll" title="全选/取消全选">
</th>
{% endblock %}

{% block list_page_table_headers %}
<th style="width: 10%;">分类编码</th>
<th style="width: 20%;">分类名称</th>
<th style="width: 15%;">父分类</th>
<th style="width: 8%;">排序顺序</th>
<th style="width: 20%;">描述</th>
<th style="width: 8%;">状态</th>
{% endblock %}

{% block list_page_table_checkbox_cell %}
<td>
    <input type="checkbox" class="row-checkbox" value="{{ item.id }}" title="选择此项">
</td>
{% endblock %}

{% block list_page_table_row_content %}
<td><code>{{ item.code }}</code></td>
<td>
    {% if item.parent %}
        <span class="text-muted">└─</span>
    {% endif %}
    {{ item.name }}
</td>
<td>
    {% if item.parent %}
        <a href="?parent_id={{ item.parent.id }}" class="text-decoration-none">
            {{ item.parent.name }}
        </a>
    {% else %}
        <span class="text-muted">-</span>
    {% endif %}
</td>
<td>{{ item.sort_order }}</td>
<td>
    {% if item.description %}
        {{ item.description|truncatewords:10 }}
    {% else %}
        <span class="text-muted">-</span>
    {% endif %}
</td>
<td>
    {% if item.is_active %}
        <span class="badge bg-success">启用</span>
    {% else %}
        <span class="badge bg-secondary">停用</span>
    {% endif %}
</td>
<td>
    <div class="list-page-table-actions">
        <a href="{% url 'admin_pages:supply_category_update' category_id=item.id %}" class="action-edit" title="编辑">
            <i class="bi bi-pencil"></i>
        </a>
        {% if not item.children.exists and not item.supplies.exists %}
        <span class="action-separator">|</span>
        <a href="{% url 'admin_pages:supply_category_delete' category_id=item.id %}" class="action-delete" title="删除" onclick="return confirm('确定要删除分类 {{ item.name }} 吗？此操作不可撤销。');">
            <i class="bi bi-trash"></i>
        </a>
        {% endif %}
    </div>
</td>
{% endblock %}

{% block empty_colspan %}8{% endblock %}

{% block empty_table_message %}暂无数据{% endblock %}

{% block empty_message %}暂无数据{% endblock %}

{% block empty_create_url %}{% url 'admin_pages:supply_category_create' %}{% endblock %}

{% block list_page_batch_delete_js %}
// 批量删除功能
document.addEventListener('DOMContentLoaded', function() {
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', function() {
            const checked = document.querySelectorAll('.row-checkbox:checked');
            if (checked.length === 0) {
                showError('请先选择要删除的数据');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${checked.length} 个分类吗？此操作不可撤销。`)) {
                return;
            }
            
            const ids = Array.from(checked).map(cb => cb.value);
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "admin_pages:supply_category_list" %}';
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken.value;
                form.appendChild(csrfInput);
            }
            
            ids.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'delete_ids';
                input.value = id;
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
        });
    }
});
{% endblock %}

{% block list_page_batch_export_js %}
// 批量导出功能
document.addEventListener('DOMContentLoaded', function() {
    const batchExportBtn = document.getElementById('batchExportBtn');
    if (batchExportBtn) {
        batchExportBtn.addEventListener('click', function() {
            const checked = document.querySelectorAll('.row-checkbox:checked');
            if (checked.length === 0) {
                showError('请先选择要导出的数据');
                return;
            }
            
            const ids = Array.from(checked).map(cb => cb.value);
            const format = this.dataset.exportFormat || 'excel';
            const url = '{% url "admin_pages:supply_category_list" %}?export=1&format=' + format + '&ids=' + ids.join(',');
            window.location.href = url;
        });
    }
});
{% endblock %}

{% block list_page_batch_dropdown_items %}
<li><a class="dropdown-item" href="#" id="batchStatusActiveBtn"><i class="bi bi-check-circle"></i> 批量设为启用</a></li>
<li><a class="dropdown-item" href="#" id="batchStatusInactiveBtn"><i class="bi bi-x-circle"></i> 批量设为停用</a></li>
<li><hr class="dropdown-divider"></li>
<li><a class="dropdown-item" href="#" id="batchPrintBtn"><i class="bi bi-printer"></i> 打印选中</a></li>
{% endblock %}

{% block list_page_custom_js %}
// 批量状态更新功能
function batchUpdateStatus(isActive) {
    const checked = document.querySelectorAll('.row-checkbox:checked');
    if (checked.length === 0) {
        showError('请先选择要操作的数据');
        return;
    }
    
    const statusLabel = isActive ? '启用' : '停用';
    if (!confirm(`确定要将选中的 ${checked.length} 个分类状态更新为"${statusLabel}"吗？`)) {
        return;
    }
    
    const ids = Array.from(checked).map(cb => cb.value);
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "admin_pages:supply_category_list" %}';
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken.value;
        form.appendChild(csrfInput);
    }
    
    const statusInput = document.createElement('input');
    statusInput.type = 'hidden';
    statusInput.name = 'batch_is_active';
    statusInput.value = isActive ? 'true' : 'false';
    form.appendChild(statusInput);
    
    ids.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'update_ids';
        input.value = id;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}

// 绑定批量状态更新按钮
document.addEventListener('DOMContentLoaded', function() {
    const batchStatusActiveBtn = document.getElementById('batchStatusActiveBtn');
    const batchStatusInactiveBtn = document.getElementById('batchStatusInactiveBtn');
    
    if (batchStatusActiveBtn) {
        batchStatusActiveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            batchUpdateStatus(true);
        });
    }
    
    if (batchStatusInactiveBtn) {
        batchStatusInactiveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            batchUpdateStatus(false);
        });
    }
});
{% endblock %}