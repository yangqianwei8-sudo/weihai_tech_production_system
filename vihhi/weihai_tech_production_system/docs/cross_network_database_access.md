# 跨网络数据库访问解决方案

## 问题描述

当 OA 系统运行的网络与机房数据库服务器不在同一个局域网时，无法直接通过内网 IP（如 `192.168.0.14`）访问数据库。

**网络架构**：
```
OA系统网络（公网/其他内网）
    ↓
    ↓ （无法直接访问）
    ↓
机房数据库服务器（192.168.0.14）
```

## 解决方案

### 方案 1：VPN 连接（推荐，最安全）

通过 VPN 将 OA 系统网络与机房网络连接起来。

#### 实施步骤：

1. **在机房部署 VPN 服务器**
   - 使用 OpenVPN、WireGuard、IPSec 等 VPN 方案
   - 或使用公司现有的 VPN 基础设施

2. **OA 系统服务器连接到 VPN**
   - 配置 VPN 客户端
   - 连接后获得机房内网 IP 地址

3. **配置数据库连接**
   - 连接 VPN 后，OA 系统可以通过内网 IP 访问数据库
   - 数据库连接字符串保持不变：
     ```
     DATABASE_URL=postgresql://weihai_user:password@192.168.0.14:5432/weihai_tech
     ```

4. **配置 pg_hba.conf**
   - 允许 VPN 网段的 IP 地址访问数据库

**优点**：
- ✅ 安全性高（加密传输）
- ✅ 网络隔离
- ✅ 可以访问整个机房网络资源

**缺点**：
- ⚠️ 需要部署和维护 VPN 服务器
- ⚠️ 需要配置 VPN 客户端

---

### 方案 2：端口映射/转发（适合有公网 IP 的情况）

如果数据库服务器或机房网关有公网 IP，可以通过端口映射将数据库端口暴露到公网。

#### 实施步骤：

1. **在路由器/防火墙上配置端口转发**
   ```
   公网IP:5432 → 192.168.0.14:5432
   ```

2. **配置数据库连接**
   ```
   DATABASE_URL=postgresql://weihai_user:password@公网IP:5432/weihai_tech
   ```

3. **配置 pg_hba.conf**
   - 允许 OA 系统服务器的公网 IP 访问
   - 或允许特定网段

4. **安全加固**
   - 使用强密码
   - 限制访问 IP（仅允许 OA 系统服务器 IP）
   - 考虑使用 SSL 加密连接

**优点**：
- ✅ 配置简单
- ✅ 不需要 VPN

**缺点**：
- ⚠️ 安全性较低（数据库端口暴露在公网）
- ⚠️ 需要公网 IP
- ⚠️ 需要配置防火墙规则

**安全建议**：
- 使用非标准端口（如 15432 而不是 5432）
- 配置 IP 白名单
- 启用 PostgreSQL SSL 连接
- 使用强密码

---

### 方案 3：SSH 隧道（临时方案，适合开发/测试）

通过 SSH 隧道将数据库连接转发到本地。

#### 实施步骤：

1. **建立 SSH 隧道**
   ```bash
   # 在 OA 系统服务器上执行
   ssh -L 5432:192.168.0.14:5432 username@跳板机IP -N
   
   # 或使用跳板机（如果数据库服务器无法直接访问）
   ssh -L 5432:192.168.0.14:5432 username@跳板机IP -N
   ```

2. **配置数据库连接**
   ```
   # 连接本地端口（通过 SSH 隧道转发）
   DATABASE_URL=postgresql://weihai_user:password@localhost:5432/weihai_tech
   ```

3. **保持 SSH 连接**
   - SSH 隧道需要保持连接
   - 可以使用 `autossh` 或 `systemd` 服务保持连接

**优点**：
- ✅ 不需要修改数据库服务器配置
- ✅ 加密传输
- ✅ 配置简单

**缺点**：
- ⚠️ 需要 SSH 访问权限
- ⚠️ 需要保持 SSH 连接
- ⚠️ 不适合生产环境长期使用

---

### 方案 4：数据库代理/中间件（适合复杂场景）

使用数据库代理服务（如 PgBouncer、HAProxy）作为中间层。

#### 架构：
```
OA系统 → 数据库代理（公网） → 数据库服务器（内网）
```

#### 实施步骤：

1. **部署数据库代理服务器**
   - 部署在可以同时访问 OA 系统和数据库服务器的位置
   - 或部署在公网，通过 VPN/专线连接数据库

2. **配置代理**
   - 配置 PgBouncer 或 HAProxy
   - 设置连接池和路由规则

3. **配置数据库连接**
   ```
   DATABASE_URL=postgresql://weihai_user:password@代理服务器IP:6432/weihai_tech
   ```

**优点**：
- ✅ 可以添加连接池、负载均衡
- ✅ 可以添加访问控制和监控
- ✅ 数据库服务器不直接暴露

**缺点**：
- ⚠️ 需要额外的服务器资源
- ⚠️ 配置相对复杂

---

### 方案 5：专线/内网互联（适合大型企业）

如果公司有多个办公地点，可以通过专线或内网互联将网络连接起来。

#### 实施步骤：

1. **联系网络服务商**
   - 申请专线连接
   - 或使用 MPLS VPN 等企业级网络方案

2. **配置路由**
   - 配置路由表，使 OA 系统网络可以访问机房网络

3. **配置数据库连接**
   - 连接后可以直接使用内网 IP

**优点**：
- ✅ 稳定可靠
- ✅ 带宽有保障
- ✅ 安全性高

**缺点**：
- ⚠️ 成本较高
- ⚠️ 需要网络服务商支持
- ⚠️ 实施周期较长

---

## 推荐方案对比

| 方案 | 安全性 | 成本 | 实施难度 | 适用场景 |
|------|--------|------|----------|----------|
| VPN 连接 | ⭐⭐⭐⭐⭐ | 中 | 中 | 生产环境（推荐） |
| 端口映射 | ⭐⭐ | 低 | 低 | 临时/测试环境 |
| SSH 隧道 | ⭐⭐⭐ | 低 | 低 | 开发/测试环境 |
| 数据库代理 | ⭐⭐⭐⭐ | 中 | 高 | 复杂架构 |
| 专线互联 | ⭐⭐⭐⭐⭐ | 高 | 高 | 大型企业 |

## 安全建议

无论使用哪种方案，都应该：

1. **使用强密码**
   ```sql
   ALTER USER weihai_user WITH PASSWORD '强密码（至少16位，包含大小写字母、数字、特殊字符）';
   ```

2. **限制访问 IP**
   - 在 `pg_hba.conf` 中只允许必要的 IP 地址
   - 不要使用 `0.0.0.0/0` 允许所有 IP

3. **启用 SSL 连接**
   - 配置 PostgreSQL SSL
   - 在连接字符串中添加 SSL 参数：
     ```
     DATABASE_URL=postgresql://user:pass@host:5432/db?sslmode=require
     ```

4. **定期更新和审计**
   - 定期更新数据库密码
   - 审计数据库访问日志
   - 监控异常连接

5. **网络隔离**
   - 数据库服务器只允许必要的端口开放
   - 使用防火墙规则限制访问

## 配置示例

### pg_hba.conf 配置（跨网络访问）

```conf
# 本地连接
local   all             all                                     peer

# 允许 VPN 网段访问（假设 VPN 网段是 10.8.0.0/24）
host    weihai_tech     weihai_user    10.8.0.0/24              md5

# 允许特定公网 IP 访问（OA 系统服务器 IP）
host    weihai_tech     weihai_user    123.45.67.89/32          md5

# 拒绝其他所有连接
host    all             all             0.0.0.0/0               reject
```

### 环境变量配置

```bash
# 方案 1：VPN 连接（使用内网 IP）
DATABASE_URL=postgresql://weihai_user:password@192.168.0.14:5432/weihai_tech

# 方案 2：端口映射（使用公网 IP）
DATABASE_URL=postgresql://weihai_user:password@公网IP:5432/weihai_tech

# 方案 3：SSH 隧道（使用 localhost）
DATABASE_URL=postgresql://weihai_user:password@localhost:5432/weihai_tech

# 方案 4：数据库代理
DATABASE_URL=postgresql://weihai_user:password@代理服务器IP:6432/weihai_tech
```

## 故障排查

### 问题 1：无法连接数据库

1. **检查网络连通性**
   ```bash
   # 从 OA 系统服务器 ping 数据库服务器
   ping 192.168.0.14
   
   # 检查端口是否开放
   telnet 192.168.0.14 5432
   # 或
   nc -zv 192.168.0.14 5432
   ```

2. **检查防火墙规则**
   - 确认数据库服务器防火墙允许 5432 端口
   - 确认路由器/网关端口转发配置正确

3. **检查 pg_hba.conf**
   - 确认允许 OA 系统服务器的 IP 地址

### 问题 2：连接超时

- 检查网络延迟
- 检查防火墙是否阻止连接
- 检查数据库服务器是否正常运行

### 问题 3：SSL 连接失败

- 检查 PostgreSQL SSL 配置
- 检查证书是否有效
- 尝试使用 `sslmode=prefer` 而不是 `require`

## 联系支持

如果遇到问题，请联系：
- **网络管理员**：配置 VPN、端口映射、专线等
- **系统管理员**：配置数据库服务器、防火墙等
- **IT 部门**：协助整体架构设计

