# 计划管理首页风险预警统计逻辑问题报告

## 一、问题概述

检查发现计划管理首页的风险预警统计逻辑存在**4个主要问题**，导致风险预警显示不完整或遗漏。

## 二、问题详情

### 【问题1】首页风险预警统计不完整

**位置**：`views_pages.py` 第763行

**当前逻辑**：
```python
risk_items = get_user_risk_items(request.user, limit=5)
```

**问题分析**：
- `get_user_risk_items` 函数只查询 `owner=user` 的风险（用户拥有的计划和目标）
- 不包含 `responsible_person=user` 的风险（用户负责的计划和目标）
- **owner** 和 **responsible_person** 是两个不同的概念：
  - `owner`：计划的创建者/拥有者
  - `responsible_person`：计划的负责人

**影响**：
- 如果用户负责的计划/目标逾期，但owner不是用户，则不会显示在首页风险预警中
- 导致风险预警遗漏，用户无法及时看到自己负责的逾期项

**示例场景**：
- 用户A创建了计划（owner=A），但指定用户B为负责人（responsible_person=B）
- 如果计划逾期，用户B在首页看不到风险预警（因为owner不是B）

### 【问题2】全部分类风险预警统计不完整

**位置**：`views_pages.py` 第1330行

**当前逻辑**：
```python
all_risk_items = list(risk_items)  # owner=user的风险
if not filter_responsible_person_id and not filter_department_id:
    if is_manager and subordinates.exists():
        all_risk_items.extend(get_subordinates_risk_items(...))  # 下属负责的风险
```

**问题分析**：
- 只包含 `owner=user` 的风险 + 下属负责的风险
- **缺少用户自己负责的风险**（如果用户不是owner）
- 全部分类应该显示用户相关的所有风险，包括：
  - 用户拥有的风险（owner=user）
  - 用户负责的风险（responsible_person=user）
  - 下属负责的风险

**影响**：
- 全部分类显示的风险不完整
- 用户负责但非拥有的风险被遗漏

### 【问题3】协作分类风险预警统计为空

**位置**：`views_pages.py` 第1662行

**当前逻辑**：
```python
my_collaboration_risk_items = []  # 空列表
```

**问题分析**：
- 协作分类的风险预警始终为空
- 没有计算协作相关的风险
- 注释说明："协作的项目通常不显示风险，因为负责人不同"
- 但这个逻辑可能不合理：如果用户参与协作的计划逾期，也应该显示风险

**影响**：
- 协作分类的风险预警不显示
- 用户无法看到协作项目的风险

### 【问题4】下属协作分类风险预警统计为空

**位置**：`views_pages.py` 第1707行

**当前逻辑**：
```python
subordinate_collaboration_risk_items = []  # 空列表
```

**问题分析**：
- 下属协作分类的风险预警始终为空
- 没有计算下属协作相关的风险

**影响**：
- 下属协作分类的风险预警不显示

## 三、函数逻辑对比

### get_user_risk_items（查询owner=user）
```python
# 查询逾期目标
overdue_goals = StrategicGoal.objects.filter(
    level='personal',
    owner=user,  # ← 只查询owner
    status__in=['published', 'accepted', 'in_progress'],
    end_date__lt=today
)

# 查询逾期计划
overdue_plans = Plan.objects.filter(
    level='personal',
    owner=user,  # ← 只查询owner
    status__in=['draft', 'published', 'accepted', 'in_progress'],
    end_time__lt=now
)
```

### get_responsible_risk_items（查询responsible_person=user）
```python
# 查询逾期目标
overdue_goals = StrategicGoal.objects.filter(
    responsible_person=responsible_user,  # ← 只查询负责人
    status__in=['published', 'accepted', 'in_progress'],
    end_date__lt=today
)

# 查询逾期计划
overdue_plans = Plan.objects.filter(
    responsible_person=responsible_user,  # ← 只查询负责人
    status__in=['draft', 'published', 'accepted', 'in_progress'],
    end_time__lt=now
)
```

**关键区别**：
- `get_user_risk_items`：查询 `owner=user`
- `get_responsible_risk_items`：查询 `responsible_person=user`
- 这两个函数查询的是不同的风险项！

## 四、修复建议

### 1. 修复首页风险预警统计

**修改位置**：`views_pages.py` 第763行

**修改方案**：
```python
# 合并 owner 和 responsible_person 的风险
owner_risk_items = get_user_risk_items(
    request.user,
    limit=10,  # 增加limit，因为要合并
    filter_department_id=filter_department_id,
    filter_responsible_person_id=filter_responsible_person_id,
    filter_start_date=filter_start_date,
    filter_end_date=filter_end_date
)

responsible_risk_items = get_responsible_risk_items(
    request.user,
    limit=10,
    filter_department_id=filter_department_id,
    filter_responsible_person_id=filter_responsible_person_id,
    filter_start_date=filter_start_date,
    filter_end_date=filter_end_date
)

# 合并并去重
all_risk_items = owner_risk_items + responsible_risk_items
seen_objects = set()
unique_risk_items = []
for item in all_risk_items:
    obj = item.get('object')
    if obj:
        obj_key = (item['type'], obj.id)
        if obj_key not in seen_objects:
            seen_objects.add(obj_key)
            unique_risk_items.append(item)

# 按逾期天数排序
unique_risk_items.sort(key=lambda x: x.get('days_overdue', 0), reverse=True)
risk_items = unique_risk_items[:5]  # 取前5条
```

### 2. 修复全部分类风险预警统计

**修改位置**：`views_pages.py` 第1330行

**修改方案**：
```python
# 全部分类的风险项：合并所有相关风险
owner_risk_items = list(risk_items)  # owner=user的风险

# 添加用户负责的风险
responsible_risk_items = get_responsible_risk_items(
    request.user,
    limit=10,
    filter_department_id=filter_department_id,
    filter_responsible_person_id=filter_responsible_person_id,
    filter_start_date=filter_start_date,
    filter_end_date=filter_end_date
)

all_risk_items = owner_risk_items + responsible_risk_items

# 如果筛选了负责人，只显示该负责人的风险，不再添加下属的风险
# 如果筛选了部门，只显示该部门的风险
# 如果没有筛选，才添加下属的风险
if not filter_responsible_person_id and not filter_department_id:
    if is_manager and subordinates.exists():
        all_risk_items.extend(get_subordinates_risk_items(
            subordinates,
            limit=10,
            filter_department_id=filter_department_id,
            filter_responsible_person_id=filter_responsible_person_id,
            filter_start_date=filter_start_date,
            filter_end_date=filter_end_date
        ))

# 排序并去重（基于对象ID）
seen_objects = set()
unique_risk_items = []
for item in all_risk_items:
    obj = item.get('object')
    if obj:
        obj_key = (item['type'], obj.id)
        if obj_key not in seen_objects:
            seen_objects.add(obj_key)
            unique_risk_items.append(item)

# 重新排序
unique_risk_items.sort(key=lambda x: x.get('days_overdue', 0), reverse=True)
```

### 3. 修复协作分类风险预警统计

**修改位置**：`views_pages.py` 第1662行

**修改方案**：
```python
# 我协作的风险项：查询用户参与但非负责人的逾期计划和目标
my_collaboration_risk_items = []

# 查询用户参与但非负责人的逾期计划
from django.utils import timezone
now = timezone.now()
today = now.date()

collaboration_overdue_plans = Plan.objects.filter(
    participants=request.user,
    responsible_person__ne=request.user,  # 不是负责人
    level='personal',
    status__in=['draft', 'published', 'accepted', 'in_progress'],
    end_time__lt=now
).distinct()

for plan in collaboration_overdue_plans:
    days_overdue = (today - plan.end_time.date()).days
    my_collaboration_risk_items.append(_build_risk_item('plan_risk', plan, days_overdue, plan.status))

# 查询用户参与但非负责人的逾期目标
collaboration_overdue_goals = StrategicGoal.objects.filter(
    participants=request.user,
    responsible_person__ne=request.user,  # 不是负责人
    level='personal',
    status__in=['published', 'accepted', 'in_progress'],
    end_date__lt=today
).distinct()

for goal in collaboration_overdue_goals:
    days_overdue = (today - goal.end_date).days
    my_collaboration_risk_items.append(_build_risk_item('goal_risk', goal, days_overdue, goal.status))

# 排序
my_collaboration_risk_items.sort(key=lambda x: x.get('days_overdue', 0), reverse=True)
```

### 4. 修复下属协作分类风险预警统计

**修改位置**：`views_pages.py` 第1707行

**修改方案**：
```python
# 下属协作的风险项：查询下属参与但非负责人的逾期计划和目标
subordinate_collaboration_risk_items = []

if subordinates.exists():
    # 查询下属参与但非负责人的逾期计划
    subordinate_collaboration_plans = Plan.objects.filter(
        participants__in=subordinates,
        responsible_person__in=subordinates,  # 负责人是下属
        level='personal',
        status__in=['draft', 'published', 'accepted', 'in_progress'],
        end_time__lt=now
    ).distinct()
    
    for plan in subordinate_collaboration_plans:
        days_overdue = (today - plan.end_time.date()).days
        subordinate_collaboration_risk_items.append(_build_risk_item('plan_risk', plan, days_overdue, plan.status))
    
    # 查询下属参与但非负责人的逾期目标
    subordinate_collaboration_goals = StrategicGoal.objects.filter(
        participants__in=subordinates,
        responsible_person__in=subordinates,  # 负责人是下属
        level='personal',
        status__in=['published', 'accepted', 'in_progress'],
        end_date__lt=today
    ).distinct()
    
    for goal in subordinate_collaboration_goals:
        days_overdue = (today - goal.end_date).days
        subordinate_collaboration_risk_items.append(_build_risk_item('goal_risk', goal, days_overdue, goal.status))
    
    # 排序
    subordinate_collaboration_risk_items.sort(key=lambda x: x.get('days_overdue', 0), reverse=True)
```

## 五、修复优先级

1. **高优先级**：问题1和问题2（首页和全部分类）
   - 影响用户看到完整的风险预警
   - 可能导致重要风险被遗漏

2. **中优先级**：问题3和问题4（协作分类）
   - 影响协作相关的风险显示
   - 可以根据业务需求决定是否修复

## 六、测试建议

修复后需要测试以下场景：

1. **场景1**：用户A创建计划，用户B为负责人
   - 计划逾期后，用户B应该在首页看到风险预警

2. **场景2**：用户A创建计划，用户A为负责人
   - 计划逾期后，用户A应该在首页看到风险预警

3. **场景3**：用户A参与协作计划，用户B为负责人
   - 计划逾期后，用户A在协作分类应该看到风险预警

4. **场景4**：下属参与协作计划
   - 计划逾期后，上级在下属协作分类应该看到风险预警

---

**报告生成时间**：2025-01-14
**检查范围**：计划管理首页风险预警统计逻辑
