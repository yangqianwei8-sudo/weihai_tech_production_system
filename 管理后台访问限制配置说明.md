# 管理后台访问限制配置说明

**配置时间**：2026-01-15  
**配置状态**：✅ 已完成

---

## 一、配置目标

限制Django管理后台的访问权限，**只允许admin用户访问**，其他所有用户均拒绝访问。

---

## 二、实施的访问控制机制

### 2.1 数据库层面控制

- **操作**：将所有非admin用户的 `is_staff` 字段设置为 `False`
- **执行命令**：`python manage.py restrict_admin_access`
- **结果**：只有admin用户的 `is_staff=True`

### 2.2 代码层面控制

在 `backend/config/admin.py` 中实现了三层访问控制：

#### 1. 重写 `has_perm` 方法
```python
def custom_has_perm(self, user, perm, obj=None):
    """自定义权限检查：只允许admin用户"""
    if not admin_only(user):
        return False
    return _original_has_perm(user, perm, obj)
```

#### 2. 重写 `has_module_permission` 方法
```python
def custom_has_module_permission(self, user, app_label):
    """自定义模块权限检查：只允许admin用户"""
    if not admin_only(user):
        return False
    return _original_has_module_permission(user, app_label)
```

#### 3. 在视图函数中添加检查
- `custom_index` 函数：检查admin用户
- `custom_app_index` 函数：检查admin用户

### 2.3 admin_only 检查函数

```python
def admin_only(user):
    """检查用户是否是admin用户"""
    if not user or not user.is_authenticated:
        return False
    return user.username == 'admin' or user.is_superuser
```

---

## 三、当前配置状态

### 3.1 用户状态

- ✅ **admin用户**：`is_staff=True`, `is_superuser=True`
- ✅ **其他用户**：所有非admin用户的 `is_staff=False`
- ✅ **总用户数**：14个
- ✅ **is_staff=True的用户数**：1个（仅admin）

### 3.2 访问控制验证

| 检查项 | 状态 | 说明 |
|--------|------|------|
| admin用户is_staff | ✅ | True |
| 非admin用户is_staff | ✅ | 全部为False |
| has_perm方法重写 | ✅ | 已实现 |
| has_module_permission方法重写 | ✅ | 已实现 |
| custom_index检查 | ✅ | 已添加 |
| custom_app_index检查 | ✅ | 已添加 |

---

## 四、管理命令

### 4.1 restrict_admin_access 命令

**功能**：限制管理后台访问权限，只允许admin用户

**使用方法**：
```bash
# 执行更新
python manage.py restrict_admin_access

# 预览模式（不实际修改）
python manage.py restrict_admin_access --dry-run
```

**功能说明**：
1. 确保admin用户的 `is_staff=True`
2. 将所有非admin用户的 `is_staff` 设置为 `False`
3. 显示更新结果和验证信息

---

## 五、访问控制流程

### 5.1 用户访问管理后台时的检查流程

```
用户访问 /admin/
    ↓
1. Django的@staff_member_required装饰器检查is_staff
    ↓
2. custom_index函数检查admin_only(user)
    ↓
3. has_module_permission检查admin_only(user)
    ↓
4. has_perm检查admin_only(user)
    ↓
允许访问 / 拒绝访问（返回403错误）
```

### 5.2 多层防护

即使某个层面的检查被绕过，其他层面的检查仍然有效：

1. **数据库层面**：`is_staff=False` 的用户无法通过 `@staff_member_required` 检查
2. **代码层面**：即使 `is_staff=True`，如果不是admin用户，`has_perm` 和 `has_module_permission` 会返回 `False`
3. **视图层面**：即使前两层都通过，`custom_index` 和 `custom_app_index` 仍会检查admin用户

---

## 六、测试验证

### 6.1 验证admin用户可以访问

1. 使用admin账号登录
2. 访问 `/admin/`
3. 应该可以正常访问管理后台

### 6.2 验证其他用户无法访问

1. 使用非admin账号登录（如tester1）
2. 访问 `/admin/`
3. 应该返回403错误："您没有权限访问管理后台。只有系统管理员可以访问。"

### 6.3 验证is_staff设置

```bash
python manage.py shell
>>> from backend.apps.system_management.models import User
>>> User.objects.filter(is_staff=True).values_list('username', flat=True)
# 应该只返回 ['admin']
```

---

## 七、维护说明

### 7.1 如果发现非admin用户可以访问

1. **检查用户状态**：
   ```bash
   python manage.py shell
   >>> User.objects.filter(is_staff=True).exclude(username='admin')
   ```

2. **修复用户状态**：
   ```bash
   python manage.py restrict_admin_access
   ```

3. **验证修复**：
   ```bash
   python manage.py restrict_admin_access --dry-run
   ```

### 7.2 如果需要临时允许其他用户访问

**不推荐**：这会违反安全策略。如果确实需要，可以：

1. 临时设置用户的 `is_staff=True`
2. 使用完毕后立即恢复
3. 或者创建新的admin用户（`is_superuser=True`）

### 7.3 定期检查

建议定期运行以下命令检查配置：

```bash
python manage.py restrict_admin_access --dry-run
```

---

## 八、相关文件

- **管理命令**：`backend/apps/system_management/management/commands/restrict_admin_access.py`
- **访问控制配置**：`backend/config/admin.py`
- **用户模型**：`backend/apps/system_management/models.py` (User)

---

## 九、安全建议

1. **定期审查**：定期检查是否有非admin用户的 `is_staff=True`
2. **监控日志**：监控管理后台的访问日志，发现异常访问
3. **强密码策略**：确保admin用户使用强密码
4. **双因素认证**：如果可能，为admin用户启用双因素认证
5. **最小权限原则**：即使admin用户，也应该遵循最小权限原则

---

**配置完成时间**：2026-01-15  
**配置人员**：系统管理员  
**下次审查时间**：建议每月审查一次
