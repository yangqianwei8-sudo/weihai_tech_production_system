# 签约主体表格添加功能实现方案

## 问题描述
目前签约主体表格的"添加签约主体"按钮没有功能，需要实现动态添加新行的功能。

## 解决方案
使用项目中已有的 `DynamicTableManager` 类来实现动态表格管理。

## 实现步骤

### 步骤1：引入 dynamic-table.js 文件
在模板的 `{% block extra_js %}` 块中引入 `dynamic-table.js` 文件。

**位置**：在 `contract_form.html` 模板中添加 `{% block extra_js %}` 块（如果还没有的话）

### 步骤2：创建行模板函数
创建一个函数，用于生成表格行的HTML模板。该函数需要：
- 接收 `index`（行索引）和 `data`（行数据）参数
- 返回包含所有字段的表格行HTML字符串
- 字段包括：
  - 序号
  - 单位类型（下拉选择框，必填）
  - 单位名称（输入框，必填）
  - 统一社会信用代码（输入框）
  - 法定代表人（输入框）
  - 项目负责人（输入框）
  - 联系电话（输入框）
  - 联系邮箱（输入框）
  - 办公地址（输入框）
  - 操作（删除按钮）

### 步骤3：初始化 DynamicTableManager
在页面加载完成后（DOMContentLoaded），初始化 `DynamicTableManager` 实例：
- `containerId`: 'parties-container'
- `rowClass`: 'party-row'
- `addButtonId`: 'add-party-btn'
- `removeButtonClass`: 'remove-party-btn'
- `minRows`: 1（至少保留1行）
- `rowTemplate`: 步骤2创建的函数
- `autoUpdateNumbers`: true（自动更新序号）

### 步骤4：处理现有数据加载（编辑模式）
如果是在编辑模式下，需要从后端获取现有的签约主体数据，然后使用 `addRow()` 方法添加现有行。

**数据来源**：
- 如果合同已存在，从 `contract.parties.all()` 获取数据
- 在模板中通过 Django 模板变量传递数据到 JavaScript

## 技术细节

### 字段映射
- `party_type`: 单位类型（party_a/party_b/party_c/other）
- `party_name`: 单位名称
- `credit_code`: 统一社会信用代码
- `legal_representative`: 法定代表人
- `project_manager`: 项目负责人
- `party_contact`: 联系人（表格中可能不需要，但模型中有）
- `contact_phone`: 联系电话
- `contact_email`: 联系邮箱
- `address`: 办公地址

### 表单字段命名
使用 Django 表单集的命名格式：`parties[${index}][field_name]`

例如：
- `parties[0][party_type]`
- `parties[0][party_name]`
- `parties[0][credit_code]`
等等

### 单位类型选项
```javascript
const partyTypeOptions = [
    { value: 'party_a', label: '甲方' },
    { value: 'party_b', label: '乙方' },
    { value: 'party_c', label: '丙方' },
    { value: 'other', label: '其他' }
];
```

## 代码位置

### 需要修改的文件
- `/home/devbox/project/vihhi/weihai_tech_production_system/backend/templates/customer_management/contract_form.html`

### 需要添加的代码位置
1. 在模板的 `{% block extra_js %}` 块中引入 `dynamic-table.js`
2. 在现有的 `<script>` 标签中（约540行开始）添加签约主体表格的初始化代码
3. 或者在 `{% block extra_js %}` 块中添加新的 `<script>` 标签

## 注意事项

1. **CSRF Token**: 确保表单提交时包含 CSRF token
2. **数据验证**: 单位类型和单位名称为必填字段，需要在提交前验证
3. **序号更新**: `DynamicTableManager` 会自动更新序号，但需要确保序号单元格的选择器正确
4. **删除功能**: `DynamicTableManager` 会自动处理删除按钮的事件绑定
5. **最少行数**: 建议设置 `minRows: 1`，确保至少有一行数据

## 测试要点

1. 点击"添加签约主体"按钮，应该能添加新行
2. 新行的所有字段都应该可以正常输入
3. 点击删除按钮，应该能删除对应行
4. 序号应该自动更新
5. 至少保留1行，不能全部删除
6. 在编辑模式下，应该能正确加载现有的签约主体数据

## 实现状态

✅ **已完成** - 所有步骤已实现：
1. ✅ 在模板中添加了 `{% block extra_js %}` 块
2. ✅ 引入了 `dynamic-table.js` 文件
3. ✅ 创建了 `partyRowTemplate` 行模板函数
4. ✅ 初始化了 `DynamicTableManager` 实例
5. ✅ 实现了现有数据的加载（编辑模式）
6. ✅ 实现了创建模式下的默认空行

## 代码位置

代码已添加到 `/home/devbox/project/vihhi/weihai_tech_production_system/backend/templates/customer_management/contract_form.html` 文件的末尾（在 `{% endblock %}` 之前）。

## 使用说明

1. **创建新合同时**：页面加载后会自动添加一行空行，用户可以点击"添加签约主体"按钮添加更多行。

2. **编辑现有合同时**：页面加载后会自动加载所有现有的签约主体数据。

3. **添加新行**：点击"添加签约主体"按钮即可添加新行。

4. **删除行**：点击每行的"删除"按钮即可删除该行（至少保留1行）。

5. **序号更新**：添加或删除行后，序号会自动更新。

