# 风险预警解除逻辑问题报告

## 一、问题概述

检查发现当前的风险预警逻辑**没有实现基于进度比较的判定**，导致解除风险预警的逻辑不正确。

## 二、当前风险预警判定逻辑

### 当前代码逻辑（`risk_query_service.py`）

**判定条件**：
1. ✅ 个人级别：`level='personal'`
2. ✅ 未完成状态：`status IN ['draft', 'published', 'accepted', 'in_progress']`
3. ❌ **只检查逾期**：`end_date < today` 或 `end_time < now`
4. ✅ 与用户相关：`owner=user` 或 `responsible_person=user` 或 `participants` 包含用户

**问题**：
- **没有检查进度比较**（实际进度/时间进度 < 1.0）
- 只要逾期就会一直显示在风险预警中，即使进度已经赶上

## 三、解除风险预警的条件（应该是什么）

根据用户要求，风险预警应该基于**进度比较**：

### 进入风险预警的条件（必须同时满足）：
1. ✅ 个人级别（`level='personal'`）
2. ✅ 未完成状态（`status NOT IN ['completed', 'cancelled']`）
3. ✅ **进度落后**（实际进度/时间进度 < 1.0）
4. ✅ 与用户相关（owner、responsible_person 或 participants）

### 解除风险预警的条件（满足任一即解除）：
1. ✅ **实际进度/时间进度 >= 1.0**（即使逾期，进度赶上后应解除）
2. ✅ 状态变为 `completed` 或 `cancelled`
3. ✅ 不再与用户相关（owner、responsible_person 或 participants 变更）

## 四、当前逻辑的问题

### 问题1：只检查逾期，不检查进度

**位置**：`risk_query_service.py` 所有查询函数

**当前逻辑**：
```python
# 只查询逾期项
overdue_goals = StrategicGoal.objects.filter(
    level='personal',
    status__in=['published', 'accepted', 'in_progress'],
    end_date__lt=today  # ← 只检查逾期
)
```

**问题分析**：
- 即使进度已经赶上（实际进度 >= 时间进度），只要逾期就会一直显示
- 例如：计划已逾期5天，但实际进度100%，时间进度50%，不应该显示风险

**影响**：
- 进度已经赶上的项仍然显示在风险预警中
- 用户无法准确了解哪些项真正需要关注

### 问题2：没有实现进度比较逻辑

**位置**：`risk_query_service.py` 整个文件

**缺失的功能**：
1. ❌ 没有从 `GoalProgressRecord` 获取目标的实际进度（最新记录的 `completion_rate`）
2. ❌ 没有从 `PlanProgressRecord` 获取计划的实际进度（最新记录的 `progress`，如果没有则使用 `plan.progress`）
3. ❌ 没有计算时间进度：
   - 目标：`(当前日期 - 开始日期) / (结束日期 - 开始日期) * 100`
   - 计划：`(当前时间 - 开始时间) / (结束时间 - 开始时间) * 100`
4. ❌ 没有比较 `实际进度/时间进度 < 1.0`

**影响**：
- 无法实现基于进度比较的风险预警判定
- 无法正确解除已赶上进度的风险预警

## 五、正确的解除风险预警逻辑

### 判定流程：

```
1. 查询所有未完成的个人计划和目标
   - level='personal'
   - status NOT IN ['completed', 'cancelled']
   - 与用户相关（owner、responsible_person 或 participants）

2. 对每个项计算：
   - 实际进度：从进度跟踪表获取最新记录
   - 时间进度：(当前时间 - 开始时间) / (结束时间 - 开始时间) * 100
   - 进度比例：实际进度 / 时间进度

3. 判断是否进入风险预警：
   - 如果 进度比例 < 1.0 → 进入风险预警
   - 如果 进度比例 >= 1.0 → 解除风险预警（不显示）

4. 特殊情况：
   - 如果时间进度 <= 0（还未开始）→ 不显示风险
   - 如果时间进度 > 100%（已过期）→ 按进度比例判断
   - 如果没有进度记录 → 实际进度 = 0，如果时间进度 > 0 则显示风险
```

### 解除风险预警的场景：

1. **进度赶上**：实际进度/时间进度 >= 1.0
   - 即使逾期，只要进度已经赶上，就不应该显示风险
   - 例如：计划已逾期，但进度100%，时间进度80%，进度比例 = 1.25，应解除风险

2. **状态变更**：状态变为 `completed` 或 `cancelled`
   - 已完成或已取消的项不应该显示风险

3. **时间进度异常**：
   - 如果时间进度 <= 0（还未开始），不应该显示风险
   - 如果结束时间还未到，但进度落后，应该显示风险

## 六、修复建议

### 1. 添加辅助函数

```python
def _get_goal_actual_progress(goal):
    """从 GoalProgressRecord 获取目标的实际进度"""
    latest_record = goal.progress_records.first()
    if latest_record:
        return float(latest_record.completion_rate)
    return 0.0

def _get_plan_actual_progress(plan):
    """从 PlanProgressRecord 获取计划的实际进度"""
    latest_record = plan.progress_records.first()
    if latest_record:
        return float(latest_record.progress)
    return float(plan.progress or 0)

def _calculate_time_progress_goal(goal, today):
    """计算目标的时间进度"""
    if not goal.start_date or not goal.end_date:
        return 0.0
    total_days = (goal.end_date - goal.start_date).days
    if total_days <= 0:
        return 0.0
    elapsed_days = (today - goal.start_date).days
    return min(100.0, (elapsed_days / total_days) * 100)

def _calculate_time_progress_plan(plan, now):
    """计算计划的时间进度"""
    if not plan.start_time or not plan.end_time:
        return 0.0
    total_seconds = (plan.end_time - plan.start_time).total_seconds()
    if total_seconds <= 0:
        return 0.0
    elapsed_seconds = (now - plan.start_time).total_seconds()
    return min(100.0, (elapsed_seconds / total_seconds) * 100)

def _is_progress_behind_goal(goal, today):
    """判断目标是否进度落后"""
    actual_progress = _get_goal_actual_progress(goal)
    time_progress = _calculate_time_progress_goal(goal, today)
    if time_progress <= 0:
        return False  # 还未开始，不显示风险
    progress_ratio = actual_progress / time_progress if time_progress > 0 else 0
    return progress_ratio < 1.0

def _is_progress_behind_plan(plan, now):
    """判断计划是否进度落后"""
    actual_progress = _get_plan_actual_progress(plan)
    time_progress = _calculate_time_progress_plan(plan, now)
    if time_progress <= 0:
        return False  # 还未开始，不显示风险
    progress_ratio = actual_progress / time_progress if time_progress > 0 else 0
    return progress_ratio < 1.0
```

### 2. 修改查询逻辑

**修改前**：
```python
overdue_goals = StrategicGoal.objects.filter(
    level='personal',
    status__in=['published', 'accepted', 'in_progress'],
    end_date__lt=today  # ← 只检查逾期
)
```

**修改后**：
```python
# 查询所有未完成的个人目标
all_goals = StrategicGoal.objects.filter(
    level='personal',
    status__in=['published', 'accepted', 'in_progress'],
    owner=user  # 或其他相关条件
).select_related('parent_goal', 'responsible_person').prefetch_related('progress_records')

# 过滤出进度落后的目标
risk_goals = []
for goal in all_goals:
    if _is_progress_behind_goal(goal, today):
        risk_goals.append(goal)
```

### 3. 修改 `_build_risk_item` 函数

支持进度落后的描述，而不仅仅是逾期描述。

## 七、总结

**当前问题**：
- ❌ 只检查逾期，不检查进度比较
- ❌ 没有实现基于进度比较的风险预警判定
- ❌ 没有正确的解除风险预警逻辑

**正确的逻辑**：
- ✅ 基于进度比较（实际进度/时间进度 < 1.0）判定风险
- ✅ 当实际进度/时间进度 >= 1.0 时，自动解除风险预警
- ✅ 即使逾期，只要进度已经赶上，就不应该显示风险

**建议**：
需要重写 `risk_query_service.py`，实现基于进度比较的风险预警判定和解除逻辑。
