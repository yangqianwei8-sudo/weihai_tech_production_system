# 筛选字段自动抓取机制说明

## 📋 概述

筛选字段设置模块（`filter-fields-settings.js`）**完全自动**从HTML DOM中抓取筛选字段，无需手动配置。

## 🔍 自动抓取机制

### 1. 抓取位置

**容器ID**：`#basicFilters`（可通过配置修改）

**选择器**：`.filter-row[data-filter-key]`

### 2. 抓取流程

```javascript
// 1. 查找容器
const container = document.getElementById('basicFilters');

// 2. 查找所有筛选字段行
const filterRows = container.querySelectorAll('.filter-row[data-filter-key]');

// 3. 遍历每个字段行，提取信息
filterRows.forEach(row => {
    // 提取字段key（从 data-filter-key 属性）
    const key = row.getAttribute('data-filter-key');
    
    // 提取字段label（从 .filter-label 元素）
    const labelElement = row.querySelector('.filter-label');
    const label = labelElement.textContent.replace(/[:：]/g, '').trim();
    
    // 创建字段对象
    fields.push({ key, label, enabled: false });
});
```

### 3. 字段信息提取

| 信息 | 来源 | 说明 |
|------|------|------|
| **字段Key** | `data-filter-key` 属性 | 字段的唯一标识符 |
| **字段Label** | `.filter-label` 元素的文本内容 | 自动移除冒号（:） |
| **启用状态** | `defaultEnabledFields` 配置或 localStorage | 默认全部启用 |

## 📝 HTML结构要求

### 基本结构

```html
<div id="basicFilters">
    <!-- 筛选字段行 -->
    <div class="filter-row" data-filter-key="字段key">
        <label class="filter-label">字段名称:</label>
        <div class="filter-buttons">
            <!-- 筛选内容 -->
        </div>
    </div>
</div>
```

### 必需元素

1. **容器**：`<div id="basicFilters">`
2. **字段行**：`<div class="filter-row" data-filter-key="xxx">`
3. **字段标签**：`<label class="filter-label">字段名称:</label>`

### 示例

```html
<div id="basicFilters">
    <!-- 客户分类筛选 -->
    <div class="filter-row" data-filter-key="client_level">
        <label class="filter-label">客户分类:</label>
        <div class="filter-buttons">
            <button type="button" class="filter-btn" data-filter="client_level" data-value="vip">VIP</button>
            <button type="button" class="filter-btn" data-filter="client_level" data-value="normal">普通</button>
        </div>
    </div>
    
    <!-- 地区筛选 -->
    <div class="filter-row" data-filter-key="region">
        <label class="filter-label">地区:</label>
        <select name="region">
            <option value="">全部</option>
            <option value="北京">北京</option>
        </select>
    </div>
    
    <!-- 负责人筛选 -->
    <div class="filter-row" data-filter-key="responsible_user">
        <label class="filter-label">负责人:</label>
        <select name="responsible_user">
            <option value="">全部</option>
            <option value="1">张三</option>
        </select>
    </div>
</div>
```

## ⚙️ 配置选项

### 容器ID配置

```javascript
window.filterFieldsSettingsConfig = {
    containerId: 'basicFilters',  // 筛选条件容器ID（默认：'basicFilters'）
    storageKey: 'customer_list_filter_fields',  // localStorage存储键
    defaultEnabledFields: ['client_level', 'region']  // 默认启用的字段
};
```

### 自动抓取时机

- **初始化时**：模块加载后自动执行 `initializeFilterFields()`
- **应用设置时**：每次应用设置都会重新抓取字段（支持动态添加的字段）

## 🔄 工作流程

### 初始化流程

```
1. 页面加载
   ↓
2. 模块初始化（init()）
   ↓
3. 自动抓取字段（initializeFilterFields()）
   ├─ 查找 #basicFilters 容器
   ├─ 查找所有 .filter-row[data-filter-key]
   ├─ 提取每个字段的 key 和 label
   └─ 验证和清理 key（安全处理）
   ↓
4. 从 localStorage 加载用户设置
   ↓
5. 合并字段和设置
   ↓
6. 应用设置到页面（显示/隐藏字段）
```

### 动态更新机制

**重要：筛选字段支持动态检测！**

当表单发生变化时（添加/删除筛选字段），`applySettings()` 方法会：

1. **重新从DOM抓取字段**：每次应用设置时都会重新查找所有 `.filter-row[data-filter-key]`
2. **自动检测新字段**：如果DOM中有新字段但字段列表中不存在，会自动添加到列表（默认启用）
3. **自动移除已删除字段**：如果字段从DOM中删除，会从字段列表中移除

**这意味着：**
- ✅ **表单字段变化会自动反映到筛选字段列表中**
- ✅ **无需手动刷新页面或重新初始化**
- ✅ **调用 `applySettings()` 即可检测到变化**

**使用场景：**
- 表单字段动态添加/删除
- AJAX加载筛选条件
- 条件显示/隐藏筛选字段

## ✨ 特性

### ✅ 已实现

1. **自动发现**：无需手动配置字段列表
2. **动态支持**：支持页面动态添加的字段
3. **安全验证**：自动验证和清理字段key
4. **智能提取**：自动从label提取字段名称

### 🎯 优势

- **零配置**：只需在HTML中添加 `data-filter-key` 属性
- **自动化**：字段自动被发现和管理
- **灵活性**：支持动态添加/删除字段
- **安全性**：自动验证和清理输入

## 📌 注意事项

1. **必须包含 `data-filter-key` 属性**：这是字段的唯一标识
2. **建议包含 `.filter-label` 元素**：用于显示友好的字段名称
3. **字段key格式**：只允许字母、数字、连字符、下划线（自动清理）
4. **容器ID**：确保容器ID与配置一致（默认：`basicFilters`）

## 🔄 表单变化时的行为

### ✅ 支持动态变化

**您的理解是正确的！** 如果表单发生变化，筛选字段也会随之变化。

**工作原理：**
- `applySettings()` 方法每次执行时都会重新从DOM抓取字段
- 自动检测新增字段并添加到列表（默认启用）
- 自动移除已删除的字段

**示例场景：**

```javascript
// 场景1：动态添加筛选字段
const container = document.getElementById('basicFilters');
const newField = document.createElement('div');
newField.className = 'filter-row';
newField.setAttribute('data-filter-key', 'new_field');
newField.innerHTML = '<label class="filter-label">新字段:</label>...';
container.appendChild(newField);

// 调用 applySettings() 后，新字段会自动被检测并添加到列表
instance.applySettings();

// 场景2：删除筛选字段
const fieldToRemove = container.querySelector('[data-filter-key="old_field"]');
fieldToRemove.remove();

// 调用 applySettings() 后，已删除的字段会从列表中移除
instance.applySettings();
```

**关键点：**
- ✅ **实时监听DOM变化**：使用 `MutationObserver` 自动检测字段变化
- ✅ 表单变化后**无需手动调用**，会自动同步
- ✅ 新字段会自动添加（默认启用）
- ✅ 已删除字段会自动移除
- ✅ 300ms防抖处理，避免频繁触发更新

**实时监听机制：**

模块启动时会自动创建 `MutationObserver`，监听以下变化：
- 筛选字段的添加/删除
- `data-filter-key` 属性的变化
- `class` 属性的变化（用于检测 `.filter-row`）

当检测到变化时，会自动：
1. 重新抓取所有筛选字段
2. 更新字段列表
3. 重新应用显示/隐藏设置

## 🔧 调试

如果字段没有被自动抓取，检查：

1. 容器是否存在：`document.getElementById('basicFilters')`
2. 字段行是否有 `data-filter-key` 属性
3. 控制台是否有警告信息
4. 字段key是否包含不安全字符（会被自动清理）

```javascript
// 调试代码
const container = document.getElementById('basicFilters');
const rows = container.querySelectorAll('.filter-row[data-filter-key]');
console.log('找到的筛选字段:', rows.length);
rows.forEach(row => {
    console.log('字段key:', row.getAttribute('data-filter-key'));
});
```

