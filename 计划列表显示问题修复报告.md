# 计划列表显示问题修复报告

## 问题描述

计划总数为 9 个，但实际表格中只显示了 6 个计划，有 3 个计划没有正确显示。

## 问题原因

### 根本原因

在 `plan_list` 视图函数中，查询使用了 `select_related('related_goal')` 来优化查询性能。但是：

1. **模型定义问题**：`Plan` 模型的 `related_goal` 字段定义为 `ForeignKey`，但没有设置 `null=True` 和 `blank=True`，理论上应该是必填字段。

2. **数据不一致**：数据库中实际存在一些计划的 `related_goal_id` 为 `NULL`（6个计划没有关联目标）。

3. **SQL JOIN 类型问题**：当 `ForeignKey` 字段不允许为空时，Django 的 `select_related()` 会使用 `INNER JOIN` 来关联表。`INNER JOIN` 会过滤掉 `related_goal_id` 为 `NULL` 的记录，导致这些计划无法被查询到。

### SQL 查询对比

**修复前（使用 INNER JOIN）**：
```sql
SELECT ... FROM "plan_plan" 
INNER JOIN "plan_strategic_goal" ON ("plan_plan"."related_goal_id" = "plan_strategic_goal"."id")
...
```
结果：只返回 6 个计划（有 `related_goal` 的计划）

**修复后（使用 LEFT OUTER JOIN）**：
```sql
SELECT ... FROM "plan_plan" 
LEFT OUTER JOIN "plan_strategic_goal" ON ("plan_plan"."related_goal_id" = "plan_strategic_goal"."id")
...
```
结果：返回所有 9 个计划（包括 `related_goal` 为 `NULL` 的计划）

## 解决方案

### 1. 修改模型定义

修改 `Plan` 模型的 `related_goal` 字段，允许为空：

```python
# 文件：vihhi/weihai_tech_production_system/backend/apps/plan_management/models.py

related_goal = models.ForeignKey(
    StrategicGoal,
    on_delete=models.PROTECT,
    related_name='related_plans',
    null=True,        # 新增：允许 NULL
    blank=True,       # 新增：允许表单中为空
    verbose_name='关联战略目标',
    help_text='选择关联的战略目标（可选）'  # 修改：从"必填"改为"可选"
)
```

### 2. 修改数据库约束

直接使用 SQL 修改数据库，允许 `related_goal_id` 为 `NULL`：

```sql
ALTER TABLE plan_plan 
ALTER COLUMN related_goal_id DROP NOT NULL;
```

### 3. 验证修复

修复后，查询会自动使用 `LEFT OUTER JOIN`，所有计划（包括 `related_goal` 为 `NULL` 的）都会被正确返回。

## 修复步骤总结

1. ✅ **修改模型定义**：在 `models.py` 中为 `related_goal` 字段添加 `null=True` 和 `blank=True`
2. ✅ **修改数据库约束**：使用 SQL 直接修改数据库，允许 `related_goal_id` 为 `NULL`
3. ✅ **验证修复**：运行调试脚本确认所有 9 个计划都能被查询到

## 测试结果

修复前：
- 数据库中的计划总数：9 个
- 查询返回的计划数：6 个
- 缺失的计划：3 个（`related_goal` 为 `NULL` 的计划）

修复后：
- 数据库中的计划总数：9 个
- 查询返回的计划数：9 个 ✅
- 所有计划都能正确显示

## 后续建议

1. **数据清理**：建议为所有计划补充关联的战略目标，确保数据完整性
2. **表单验证**：如果业务逻辑要求计划必须关联目标，可以在表单层面添加验证
3. **迁移文件**：如果需要，可以创建 Django 迁移文件来记录这次模型变更

## 相关文件

- 模型文件：`vihhi/weihai_tech_production_system/backend/apps/plan_management/models.py`
- 视图文件：`vihhi/weihai_tech_production_system/backend/apps/plan_management/views_pages.py`
- 调试脚本：`debug_plan_list.py`
- SQL 修复脚本：`fix_plan_related_goal.sql`

## 技术要点

### Django ORM 的 select_related 行为

- 当 `ForeignKey` 字段 **不允许为空**（`null=False`）时，`select_related()` 使用 `INNER JOIN`
- 当 `ForeignKey` 字段 **允许为空**（`null=True`）时，`select_related()` 使用 `LEFT OUTER JOIN`

### INNER JOIN vs LEFT OUTER JOIN

- **INNER JOIN**：只返回两个表中都有匹配的记录
- **LEFT OUTER JOIN**：返回左表（主表）的所有记录，即使右表中没有匹配的记录

在这个案例中，使用 `LEFT OUTER JOIN` 可以确保即使计划没有关联目标，也能被查询到。

---

**修复日期**：2026-01-15  
**修复人员**：AI Assistant  
**状态**：✅ 已修复并验证
