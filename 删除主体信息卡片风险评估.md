# 删除"主体信息"卡片风险评估报告

## 一、概述

本次评估针对删除合同创建/编辑页面中的"主体信息"卡片及其所有字段内容，评估对其他部分可能造成的风险和影响。

## 二、需要删除的字段清单

### 2.1 客户方信息字段
1. **客户公司** (`form.client`) - ⚠️ **模型字段，需保留**
2. **统一社会信用代码** (`client_credit_code`) - 只读字段，不在模型中
3. **法定代表人** (`client_legal_representative`) - 只读字段，不在模型中
4. **项目代表** (`client_project_representative`) - 下拉选择，不在模型中
5. **联系方式** (`client_contact`) - 只读字段，不在模型中

### 2.2 我方信息字段
6. **我方签约主体** (`our_signing_party`) - 下拉选择，不在模型中
7. **项目负责人** (`project_manager`) - ⚠️ **可能在其他地方使用**
8. **商务负责人** (`business_manager`) - ⚠️ **模型字段，需保留**

## 三、风险评估

### 3.1 高风险项 ⚠️⚠️⚠️

#### 3.1.1 `client` 字段（客户公司）
- **风险等级**：高
- **影响范围**：
  - `ContractForm` 中 `client` 是模型字段（`BusinessContract.client`）
  - 在表单的 `fields` 列表中（第39行）
  - 在 `__init__` 方法中有查询集设置和权限过滤逻辑（第145-164行）
  - 在视图 `contract_create` 中有客户列表传递（第5120-5124行）
- **处理建议**：
  - ✅ **不能删除**，这是核心业务字段
  - 需要将 `client` 字段移到其他位置（如"关联信息"部分）
  - 或者保留在表单中但不显示在"主体信息"卡片

#### 3.1.2 `business_manager` 字段（商务负责人）
- **风险等级**：高
- **影响范围**：
  - `BusinessContract` 模型中有 `business_manager` 字段（ForeignKey to User）
  - 在视图中有 `business_managers` 列表传递（第5131行）
  - 可能在其他地方被使用
- **处理建议**：
  - ✅ **不能删除**，这是模型字段
  - 需要确认是否在其他地方显示或使用
  - 如果不在其他地方使用，可以考虑删除模型字段（需要数据库迁移）

### 3.2 中风险项 ⚠️⚠️

#### 3.2.1 `project_manager` 字段（项目负责人）
- **风险等级**：中
- **影响范围**：
  - 在视图中有 `project_managers` 列表传递（第5128行）
  - 在模板中作为下拉选择框（第261-266行）
  - **注意**：`BusinessContract` 模型中没有 `project_manager` 字段
  - `Project` 模型中有 `project_manager` 字段（第309行）
- **处理建议**：
  - 检查是否在其他地方使用
  - 如果不在其他地方使用，可以安全删除
  - 如果使用，需要移到其他位置

#### 3.2.2 `our_signing_party` 字段（我方签约主体）
- **风险等级**：中
- **影响范围**：
  - 在 JavaScript 中被使用（第1251行）：`document.getElementById('our_signing_party')`
  - 在视图中有 `our_units` 数据传递（第5080-5092行，第5139行）
  - 用于填充下拉选项（第1254-1263行）
- **处理建议**：
  - 删除 HTML 中的字段后，需要删除 JavaScript 中的相关代码
  - 如果 `our_units` 不在其他地方使用，可以删除视图中的传递

### 3.3 低风险项 ⚠️

#### 3.3.1 只读字段（`client_credit_code`、`client_legal_representative`、`client_contact`）
- **风险等级**：低
- **影响范围**：
  - 这些字段不在模型中，只是显示字段
  - 没有找到 JavaScript 自动填充逻辑
  - 不在表单提交处理中
- **处理建议**：
  - ✅ **可以安全删除**

#### 3.3.2 `client_project_representative` 字段（项目代表）
- **风险等级**：低
- **影响范围**：
  - 不在模型中
  - 没有找到 JavaScript 处理逻辑
  - 不在表单提交处理中
- **处理建议**：
  - ✅ **可以安全删除**

## 四、依赖关系分析

### 4.1 视图层依赖（views_pages.py）

#### 4.1.1 `contract_create` 视图（第4935-5150行）
- **传递的数据**：
  - `clients` - 用于客户下拉选择，**需要保留**（因为 `client` 字段需要）
  - `project_managers` - 用于项目负责人选择，**需要评估**
  - `business_managers` - 用于商务负责人选择，**需要评估**
  - `our_units` - 用于我方签约主体选择，**可以删除**（如果删除该字段）

#### 4.1.2 `contract_edit` 视图
- 需要检查是否有类似的依赖

### 4.2 表单层依赖（forms.py）

#### 4.2.1 `ContractForm`（第32-281行）
- **模型字段**：
  - `client` - ✅ **必须保留**
  - `business_manager` - ⚠️ **需要确认是否在模型中**
- **非模型字段**：
  - 其他字段不在表单的 `fields` 列表中

### 4.3 JavaScript 依赖（contract_form.html）

#### 4.3.1 `our_signing_party` 相关代码（第1251-1263行）
```javascript
const select = document.getElementById('our_signing_party');
if (select && Array.isArray(ourUnits)) {
    ourUnits.forEach(function(unit) {
        const option = document.createElement('option');
        option.value = unit;
        option.textContent = unit;
        select.appendChild(option);
    });
}
```
- **风险**：删除字段后，这段代码会报错（`getElementById` 返回 null）
- **处理**：需要删除或注释掉这段代码

#### 4.3.2 客户信息自动填充
- **检查结果**：未找到自动填充 `client_credit_code`、`client_legal_representative`、`client_contact` 的 JavaScript 代码
- **风险**：低

## 五、数据完整性风险

### 5.1 数据库层面
- **风险**：低
- **原因**：
  - 除了 `client` 和 `business_manager`，其他字段都不在模型中
  - 删除这些字段不会影响数据库结构

### 5.2 业务逻辑层面
- **风险**：中
- **原因**：
  - `client` 字段是必填字段，删除显示位置可能影响用户体验
  - `business_manager` 和 `project_manager` 可能在其他业务逻辑中使用

## 六、建议的删除方案

### 6.1 可以安全删除的字段 ✅
1. `client_credit_code`（统一社会信用代码）
2. `client_legal_representative`（法定代表人）
3. `client_project_representative`（项目代表）
4. `client_contact`（联系方式）
5. `our_signing_party`（我方签约主体）- 需要同时删除 JavaScript 代码

### 6.2 需要特殊处理的字段 ⚠️

#### 6.2.1 `client`（客户公司）
- **处理方案**：
  - 选项1：移到"关联信息"部分（推荐）
  - 选项2：保留在表单中但不显示在"主体信息"卡片

#### 6.2.2 `business_manager`（商务负责人）
- **处理方案**：
  - 先检查是否在其他地方使用
  - 如果使用，移到其他位置
  - 如果不使用，考虑删除模型字段（需要数据库迁移）

#### 6.2.3 `project_manager`（项目负责人）
- **处理方案**：
  - 先检查是否在其他地方使用
  - 如果使用，移到其他位置
  - 如果不使用，可以安全删除

## 七、删除步骤建议

### 步骤1：检查依赖关系
1. ✅ 检查 `business_manager` 和 `project_manager` 在其他地方的使用情况
2. ✅ 确认 `our_units` 是否在其他地方使用

### 步骤2：处理核心字段
1. 将 `client` 字段移到"关联信息"部分
2. 决定 `business_manager` 和 `project_manager` 的处理方式

### 步骤3：删除HTML和JavaScript
1. 删除"主体信息"卡片的HTML结构
2. 删除 `our_signing_party` 相关的 JavaScript 代码
3. 删除视图中的 `our_units` 传递（如果不再需要）

### 步骤4：验证
1. 测试页面加载是否正常
2. 测试表单提交是否正常
3. 检查是否有 JavaScript 错误

## 八、总结

### 8.1 总体风险等级：**中**

### 8.2 主要风险点
1. `client` 字段是核心业务字段，必须保留但需要移到其他位置
2. `business_manager` 是模型字段，需要确认使用情况
3. `project_manager` 可能在其他地方使用，需要检查
4. `our_signing_party` 的 JavaScript 代码需要同步删除

### 8.3 建议
1. **先检查依赖**：确认 `business_manager` 和 `project_manager` 的使用情况
2. **分步删除**：先删除低风险字段，再处理高风险字段
3. **充分测试**：删除后进行全面测试，确保功能正常

---

**评估日期**：2025-01-20  
**评估人**：AI Assistant

