# 计划管理模块权限配置指南

## 一、快速开始

### 1.1 初始化权限和角色

按照以下步骤配置计划管理模块的权限和角色：

```bash
# 1. 创建/更新权限定义
python manage.py seed_permissions

# 2. 配置角色并分配权限
python manage.py setup_plan_management_roles

# 3. （可选）更新已存在的角色
python manage.py setup_plan_management_roles --update
```

### 1.2 预览模式

在正式执行前，可以先预览将要执行的操作：

```bash
# 预览角色配置（不会实际修改数据库）
python manage.py setup_plan_management_roles --dry-run
```

## 二、权限说明

### 2.1 计划管理模块权限列表

| 权限代码 | 权限名称 | 说明 |
|---------|---------|------|
| `plan_management.view` | 计划管理-查看 | 查看计划管理模块入口 |
| `plan_management.plan.view` | 计划管理-查看计划 | 查看计划列表和详情 |
| `plan_management.plan.create` | 计划管理-创建计划 | 创建新计划 |
| `plan_management.plan.manage` | 计划管理-管理计划 | 编辑和删除计划 |
| `plan_management.approve_plan` | 计划管理-审批计划 | 审批计划的启动/取消请求 |
| `plan_management.approve` | 计划管理-审批 | 审批计划（兼容别名） |
| `plan_management.goal.view` | 计划管理-查看目标 | 查看战略目标列表和详情 |
| `plan_management.goal.create` | 计划管理-创建目标 | 创建战略目标 |
| `plan_management.manage_goal` | 计划管理-管理目标 | 管理战略目标（创建、编辑、删除、分解） |

### 2.2 权限层级关系

```
plan_management.view (基础权限)
    ├── plan_management.plan.view (查看计划)
    ├── plan_management.plan.create (创建计划)
    ├── plan_management.plan.manage (管理计划)
    ├── plan_management.approve_plan (审批计划)
    ├── plan_management.goal.view (查看目标)
    ├── plan_management.goal.create (创建目标)
    └── plan_management.manage_goal (管理目标)
```

## 三、角色配置

### 3.1 预定义角色

系统提供了4个预定义角色：

#### 1. 计划管理员 (plan_manager)
- **权限范围**：所有计划管理权限
- **适用人员**：计划管理部门负责人、系统管理员
- **权限列表**：
  - `plan_management.view`
  - `plan_management.plan.view`
  - `plan_management.plan.create`
  - `plan_management.plan.manage`
  - `plan_management.approve_plan`
  - `plan_management.approve`
  - `plan_management.goal.view`
  - `plan_management.goal.create`
  - `plan_management.manage_goal`

#### 2. 项目经理 (project_manager)
- **权限范围**：创建和管理自己的计划，但不能审批
- **适用人员**：项目负责人、计划制定者
- **权限列表**：
  - `plan_management.view`
  - `plan_management.plan.view`
  - `plan_management.plan.create`
  - `plan_management.plan.manage`
  - `plan_management.goal.view`

#### 3. 计划审批人 (plan_approver)
- **权限范围**：审批计划的启动/取消请求，查看计划信息
- **适用人员**：部门经理、审批负责人
- **权限列表**：
  - `plan_management.view`
  - `plan_management.plan.view`
  - `plan_management.approve_plan`
  - `plan_management.approve`
  - `plan_management.goal.view`

#### 4. 计划查看者 (plan_viewer)
- **权限范围**：只能查看计划信息
- **适用人员**：普通员工、观察者
- **权限列表**：
  - `plan_management.view`
  - `plan_management.plan.view`
  - `plan_management.goal.view`

### 3.2 自定义角色

如果需要创建自定义角色，可以通过以下方式：

#### 方式1：通过管理命令（推荐）

修改 `setup_plan_management_roles.py` 文件，在 `ROLE_DEFINITIONS` 中添加新角色定义：

```python
{
    'code': 'custom_role_code',
    'name': '自定义角色名称',
    'description': '角色描述',
    'permissions': [
        'plan_management.view',
        'plan_management.plan.view',
        # ... 其他权限
    ]
}
```

然后运行：
```bash
python manage.py setup_plan_management_roles --update
```

#### 方式2：通过Django Admin界面

1. 访问：`/admin/system_management/role/`
2. 创建新角色
3. 在"业务权限"字段中选择相应的权限

#### 方式3：通过权限矩阵页面

1. 访问：`/system/permissions/matrix/`
2. 查看所有角色和权限
3. 为角色分配/取消权限

## 四、用户角色分配

### 4.1 通过Django Admin分配

1. 访问：`/admin/system_management/user/`
2. 选择要分配角色的用户
3. 在"角色"字段中选择角色
4. 保存

### 4.2 通过代码分配

```python
from backend.apps.system_management.models import User, Role

# 获取用户和角色
user = User.objects.get(username='username')
role = Role.objects.get(code='plan_manager')

# 分配角色
user.roles.add(role)
```

### 4.3 批量分配角色

可以创建管理命令批量分配角色：

```python
# management/commands/assign_plan_roles.py
from django.core.management.base import BaseCommand
from backend.apps.system_management.models import User, Role

class Command(BaseCommand):
    def handle(self, *args, **options):
        # 获取角色
        plan_manager_role = Role.objects.get(code='plan_manager')
        
        # 获取用户列表（例如：所有部门经理）
        users = User.objects.filter(department__name='计划管理部')
        
        # 批量分配角色
        for user in users:
            user.roles.add(plan_manager_role)
            self.stdout.write(f'已为 {user.username} 分配角色：计划管理员')
```

## 五、权限检查

### 5.1 在视图函数中检查权限

```python
from backend.apps.system_management.services import get_user_permission_codes
from backend.core.views import _permission_granted

def plan_create(request):
    permission_codes = get_user_permission_codes(request.user)
    
    # 检查创建权限
    if not _permission_granted('plan_management.plan.create', permission_codes):
        messages.error(request, '您没有权限创建计划')
        return redirect('plan_pages:plan_list')
    
    # ... 创建计划的逻辑
```

### 5.2 在模板中控制显示

```django
{% if can_create %}
    <a href="{% url 'plan_pages:plan_create' %}">创建计划</a>
{% endif %}

{% if can_approve %}
    <button onclick="approvePlan({{ plan.id }})">审批通过</button>
{% endif %}
```

### 5.3 检查用户权限（调试）

```python
from backend.apps.system_management.services import get_user_permission_codes

# 获取用户的所有权限
permission_codes = get_user_permission_codes(user)
print(f"用户权限: {permission_codes}")

# 检查特定权限
has_permission = 'plan_management.approve_plan' in permission_codes
print(f"是否有审批权限: {has_permission}")
```

## 六、常见问题

### Q1: 运行 seed_permissions 后，权限没有创建？

**A:** 检查以下几点：
1. 确认数据库连接正常
2. 检查 `PermissionItem` 表是否存在
3. 查看命令输出是否有错误信息
4. 检查权限代码是否已存在（已存在的权限会被更新而不是创建）

### Q2: 如何查看某个角色有哪些权限？

**A:** 可以通过以下方式：

```python
from backend.apps.system_management.models import Role

role = Role.objects.get(code='plan_manager')
permissions = role.custom_permissions.filter(is_active=True)
for perm in permissions:
    print(f"{perm.code} - {perm.name}")
```

或者访问权限矩阵页面：`/system/permissions/matrix/`

### Q3: 如何查看某个用户有哪些权限？

**A:** 使用权限服务函数：

```python
from backend.apps.system_management.services import get_user_permission_codes

permission_codes = get_user_permission_codes(user)
print(permission_codes)
```

### Q4: 用户有角色但没有权限？

**A:** 检查以下几点：
1. 角色是否激活（`is_active=True`）
2. 权限是否激活（`is_active=True`）
3. 角色是否分配了相应的权限
4. 用户是否真的被分配了该角色

### Q5: 如何临时给用户所有权限？

**A:** 有以下几种方式：

1. **设置为超级用户**（推荐用于测试）：
   ```python
   user.is_superuser = True
   user.save()
   ```

2. **分配系统管理员角色**：
   ```python
   admin_role = Role.objects.get(code='system_admin')
   user.roles.add(admin_role)
   ```

3. **直接分配所有计划管理权限**：
   ```python
   from backend.apps.permission_management.models import PermissionItem
   
   plan_permissions = PermissionItem.objects.filter(
       module='计划管理',
       is_active=True
   )
   # 创建一个临时角色并分配所有权限
   # 或者直接修改用户的权限（如果系统支持）
   ```

## 七、最佳实践

### 7.1 权限配置原则

1. **最小权限原则**：只给用户分配必要的权限
2. **角色分离**：审批权限和管理权限分开
3. **定期审查**：定期检查角色和权限分配是否合理
4. **权限审计**：记录权限变更日志

### 7.2 角色命名规范

- 使用有意义的角色代码（如 `plan_manager`）
- 角色名称清晰明了（如"计划管理员"）
- 添加角色描述说明用途

### 7.3 权限测试

在配置权限后，建议进行以下测试：

1. **功能测试**：使用不同角色的用户测试各项功能
2. **权限边界测试**：测试无权限用户访问受限功能
3. **审批流程测试**：测试审批权限是否正常工作

## 八、相关文件

- **权限定义**：`backend/apps/system_management/management/commands/seed_permissions.py`
- **角色配置**：`backend/apps/system_management/management/commands/setup_plan_management_roles.py`
- **权限模型**：`backend/apps/permission_management/models.py`
- **角色模型**：`backend/apps/system_management/models.py`
- **权限服务**：`backend/apps/system_management/services.py`
- **权限检查**：`backend/core/views.py`

## 九、下一步

配置完权限和角色后，可以：

1. **测试审批流程**：创建测试计划，测试审批功能
2. **分配用户角色**：为实际用户分配相应角色
3. **扩展功能**：根据需要添加新的权限和角色
4. **优化体验**：根据使用反馈优化权限配置

如有问题，请参考《计划管理模块权限与审批机制说明.md》文档。
